[{"categories":["kubernetes"],"content":"æºç åˆ†æ kubernetes hpa controller æ°´å¹³è‡ªåŠ¨æ‰©ç¼©å®¹çš„å®ç°åŸç† åŸºäº kubernetes v1.27.0 ç‰ˆæœ¬è¿›è¡Œ hpa æºç åˆ†æ. Kubernetes çš„ HorizontalPodAutoscaler (hpa) ç»„ä»¶å¯ä»¥æ ¹æ®ç›®æ ‡çš„èµ„æºä½¿ç”¨ç‡ (cpu, mem ç­‰ç­‰), åŠ¨æ€çš„èµ„æºå¯¹è±¡è¿›è¡Œçš„åˆç†æ‰©ç¼©å®¹. hpa é€šå¸¸æ˜¯å¯¹ deployment å’Œ replicaset èµ„æºè¿›è¡Œè‡ªåŠ¨ä¼¸ç¼©. æ¯”å¦‚, å½“ deployment å…³è”çš„ pods è´Ÿè½½è¶…è¿‡é˜ˆå€¼æ—¶, hpa å¯¹å…¶è¿›è¡ŒåŠ¨æ€æ‰©å®¹, ä½†æ‰©å®¹çš„å‰¯æœ¬æ•°ä¸èƒ½è¶…è¿‡ maxReplicas. åä¹‹, å¦‚æœ pods è´Ÿè½½å‡å°‘, åˆ™è¿›è¡ŒåŠ¨æ€ç¼©å®¹. ","date":"2023-04-18","objectID":"/posts/32dd44/:1:0","tags":["æºç ","hpa","è½¬è½½"],"title":"æºç åˆ†æ kubernetes hpa controller æ°´å¹³è‡ªåŠ¨æ‰©ç¼©å®¹çš„å®ç°åŸç†","uri":"/posts/32dd44/"},{"categories":["kubernetes"],"content":"hpa çš„é…ç½®ä¾‹å­ åˆ†æ hpa æºç ä¹‹å‰, éœ€è¦å…ˆç†è§£ hpa çš„é…ç½®é€‰é¡¹, ä¸ç„¶ä¸å¥½ç†è§£åé¢çš„ä»£ç åˆ†æ. ä¸‹é¢çš„ hpa çš„é…ç½®ä¸­å®šä¹‰äº†æœ€å¤§å’Œæœ€å°çš„å‰¯æœ¬æ•°, æ— è®ºæ€ä¹ˆè¶…è¿‡å®šä¹‰çš„èµ„æºè´Ÿè½½é˜ˆå€¼, ä¸ä¼šè¶…è¿‡ hpa ä¸­å®šä¹‰çš„æœ€å¤§çš„å‰¯æœ¬æ•° 10. ä¸€æ ·çš„é€»è¾‘, ä¸ç®¡ pods å†æ€ä¹ˆç©ºé—², å‰¯æœ¬æ•°ä¹Ÿä¸èƒ½ä½äº 5 ä¸ª. å°½é‡ç¡®ä¿ pods çš„å¹³å‡ cpu ä½¿ç”¨ç‡ä¸è¶…è¿‡ 70%, è¶…è¿‡ä½¿ç”¨ç‡æ—¶åˆ™éœ€è¦ç«‹å³æ‰§è¡Œæ‰©å®¹. è€Œè¿›è¡Œ scale ç¼©å®¹æ—¶, åˆ™éœ€è¦ç­‰å¾… 300s åå†åˆ¤æ–­æ˜¯å¦è¿›è¡Œ, è¯¥ç­‰å¾…æ“ä½œæ˜¯é¿å…ä¸šåŠ¡æŠ–åŠ¨å¼•å‘çš„é¢‘ç¹çš„ scale pods è‡ªåŠ¨ä¼¸ç¼©. å¦å¤– behavior çš„ policies ç”¨æ¥æ§åˆ¶åŠ¨æ€ä¼¸ç¼©çš„é€Ÿåº¦, é¿å…ä¸€æ¬¡æ€§æ“ä½œå¤ªå¤š pods å®ä¾‹é€ æˆæœåŠ¡æŠ–åŠ¨, é€šå¸¸ behavior é…ç½®çš„åŸåˆ™æ˜¯å¿«é€Ÿæ‰©å®¹, ä½é€Ÿç¼©å®¹å›æ”¶. kind: HorizontalPodAutoscaler apiVersion: autoscaling/v2 metadata: name: nginx-xiaorui-cc spec: scaleTargetRef: apiVersion: apps/v1 kind: Deployment name: nginx-xiaorui-cc minReplicas: 5 maxReplicas: 10 behavior: scaleDown: stabilizationWindowSeconds: 300 policies: - type: Percent value: 100 periodSeconds: 15 scaleUp: stabilizationWindowSeconds: 0 policies: - type: Percent value: 50 periodSeconds: 15 - type: Pods value: 1 periodSeconds: 15 metrics: - type: Resource resource: name: cpu target: type: Utilization averageUtilization: 70 ","date":"2023-04-18","objectID":"/posts/32dd44/:1:1","tags":["æºç ","hpa","è½¬è½½"],"title":"æºç åˆ†æ kubernetes hpa controller æ°´å¹³è‡ªåŠ¨æ‰©ç¼©å®¹çš„å®ç°åŸç†","uri":"/posts/32dd44/"},{"categories":["kubernetes"],"content":"å®ä¾‹åŒ– hpa æ§åˆ¶å™¨ å®ä¾‹åŒ– HorizontalController æ§åˆ¶å™¨, å†…éƒ¨ä½¿ç”¨ hpaInformer æ³¨å†Œè‡ªå®šä¹‰çš„ eventHandler äº‹ä»¶å¤„ç†æ–¹æ³•. å¦å¤– HorizontalController è¿˜å®šä¹‰äº†ä¸¤ä¸ª lister å®ä¾‹. hpaLister ä¸»è¦ç”¨æ¥åˆ¤æ–­ hpa æ˜¯å¦é‡æ–°å…¥é˜Ÿ, å¦‚æœå·²ç»ä¸å­˜åœ¨, åˆ™æ— éœ€é‡æ–°å…¥é˜Ÿ. podLister åœ¨è®¡ç®—é¢„æœŸå‰¯æœ¬æ•°æ—¶, éœ€è¦è€ƒè™‘åˆ°æœ‰äº› pod æœªå°±ç»ªæˆ–è€…æ­£è¢«æ¸…ç†æ‰. func NewHorizontalController( ... ) *HorizontalController { hpaController := \u0026HorizontalController{ queue: workqueue.NewNamedRateLimitingQueue(NewDefaultHPARateLimiter(resyncPeriod), \"horizontalpodautoscaler\"), ... } // ä¸º hpaInformer å¢åŠ  eventHandler äº‹ä»¶ hpaInformer.Informer().AddEventHandlerWithResyncPeriod( cache.ResourceEventHandlerFuncs{ AddFunc: hpaController.enqueueHPA, UpdateFunc: hpaController.updateHPA, DeleteFunc: hpaController.deleteHPA, }, resyncPeriod, ) // hpaLister hpaController.hpaLister = hpaInformer.Lister() hpaController.hpaListerSynced = hpaInformer.Informer().HasSynced // podLister hpaController.podLister = podInformer.Lister() hpaController.podListerSynced = podInformer.Informer().HasSynced // å®ä¾‹åŒ–å‰¯æœ¬è®¡ç®—å™¨ replicaCalc := NewReplicaCalculator( metricsClient, hpaController.podLister, tolerance, ... ) hpaController.replicaCalc = replicaCalc return hpaController } æ³¨å†Œçš„ ResourceEventHandler å½“ podInformer æœ‰äº‹ä»¶å˜æ›´, å¦‚æœæ˜¯è§¦å‘å¢åŠ  AddFunc å’Œæ›´æ–° UpdateFunc æ–¹æ³•, ç›´æ¥å¾€ workqueue é‡Œæ¨å…¥ namespace/name æ ¼å¼çš„ key å³å¯, è€Œå½“è§¦å‘åˆ é™¤ DeleteFunc æ“ä½œæ—¶, åˆ™éœ€è¦è°ƒç”¨ queue.Forget åˆ é™¤. func (a *HorizontalController) updateHPA(old, cur interface{}) { a.enqueueHPA(cur) } func (a *HorizontalController) enqueueHPA(obj interface{}) { key, err := controller.KeyFunc(obj) if err != nil { return } a.queue.AddRateLimited(key) ... } func (a *HorizontalController) deleteHPA(obj interface{}) { key, err := controller.KeyFunc(obj) if err != nil { return } // ä»é˜Ÿåˆ—ä¸­å‰”é™¤ a.queue.Forget(key) ... } é»˜è®¤å¯åŠ¨å‚æ•° éœ€è¦æ³¨æ„çš„æ˜¯, å¯åŠ¨çš„ worker åç¨‹æ•°é‡é»˜è®¤ä¸º 5 ä¸ª, queue å»¶è¿Ÿå…¥é˜Ÿæ—¶é—´ä¸º 15s. ä»£ç ä½ç½®: pkg/controller/podautoscaler/config/v1alpha1/defaults.go func RecommendedDefaultHPAControllerConfiguration(obj *kubectrlmgrconfigv1alpha1.HPAControllerConfiguration) { zero := metav1.Duration{} if obj.ConcurrentHorizontalPodAutoscalerSyncs == 0 { obj.ConcurrentHorizontalPodAutoscalerSyncs = 5 } if obj.HorizontalPodAutoscalerSyncPeriod == zero { obj.HorizontalPodAutoscalerSyncPeriod = metav1.Duration{Duration: 15 * time.Second} } ... } ","date":"2023-04-18","objectID":"/posts/32dd44/:1:2","tags":["æºç ","hpa","è½¬è½½"],"title":"æºç åˆ†æ kubernetes hpa controller æ°´å¹³è‡ªåŠ¨æ‰©ç¼©å®¹çš„å®ç°åŸç†","uri":"/posts/32dd44/"},{"categories":["kubernetes"],"content":"å¯åŠ¨ hpa æ§åˆ¶å™¨ è·Ÿå…¶ä»– k8s controller çš„å¯åŠ¨é€»è¾‘ä¸€æ ·, è°ƒç”¨ Run() æ–¹æ³•å¯åŠ¨ HorizontalController æ§åˆ¶å™¨, å†…éƒ¨å®Œæˆ hpa å’Œ pod çš„ informer åŒæ­¥å®Œæˆ, å¯åŠ¨å¤šä¸ª worker åç¨‹å¤„ç† scale é€»è¾‘, é»˜è®¤ä¸º 5 ä¸ª. æºç ä½ç½®: pkg/controller/podautoscaler/horizontal.go func (a *HorizontalController) Run(ctx context.Context, workers int) { klog.Infof(\"Starting HPA controller\") defer klog.Infof(\"Shutting down HPA controller\") // ç­‰å¾… informer æ•°æ®åŒæ­¥å®Œæˆ if !cache.WaitForNamedCacheSync(\"HPA\", ctx.Done(), a.hpaListerSynced, a.podListerSynced) { return } // å¯åŠ¨ worker for i := 0; i \u003c workers; i++ { go wait.UntilWithContext(ctx, a.worker, time.Second) } \u003c-ctx.Done() } processNextWorkItem ä» workqueue è·å–ç”± informer çš„æ’å…¥çš„ hpa å¯¹è±¡çš„ key. å…¶ key æ ¼å¼ä¸º namespace/name. è°ƒç”¨æ ¸å¿ƒå…¥å£å‡½æ•° reconcileKey å¤„ç† hpa é€»è¾‘. å½“ hpa èµ„æºå·²ä¸å­˜åœ¨æ—¶åˆ™éœ€è¦åˆ é™¤, åä¹‹éœ€è¦å†æ¬¡æ’å…¥åˆ° workqueue çš„ delayQueue é‡Œ, ç”¨æ¥å®ç°å»¶è¿Ÿå†å…¥é˜Ÿçš„é€»è¾‘, é»˜è®¤ 15s åå†æ¬¡å…¥é˜Ÿ. hpa æ§åˆ¶å™¨éœ€è¦ä¸åœçš„å‘¨æœŸæ€§å¯¹æ‰€æœ‰ hpa çš„èµ„æºæ£€æµ‹èµ„æºä½¿ç”¨ç‡, æ‰å¯æ ¹æ®é˜ˆå€¼æ¡ä»¶è¿›è¡ŒåŠ¨æ€æ‰©ç¼©å®¹. æ‰€ä»¥ hpa éœ€è¦ä¸€ä¸ªå®šæ—¶å™¨çš„é€»è¾‘, è¿™é‡Œçš„å®šæ—¶å™¨æ˜¯æ”¾åœ¨ workqueue å®ç°çš„. func (a *HorizontalController) worker(ctx context.Context) { for a.processNextWorkItem(ctx) { } } func (a *HorizontalController) processNextWorkItem(ctx context.Context) bool { // è·å–ç”± informer eventHandler å‘åˆ° queue é‡Œçš„ key, æ ¼å¼ä¸º `namespace/name` key, quit := a.queue.Get() if quit { return false } defer a.queue.Done(key) // hpa æ ¸å¿ƒæ–¹æ³•, ç”±è¯¥æ–¹æ³•æ¥å®ç°æ‰©ç¼©å®¹ deleted, err := a.reconcileKey(ctx, key.(string)) if err != nil { utilruntime.HandleError(err) } // å¦‚æœæ— å¼‚å¸¸ä¸”æ²¡æœ‰è¢«åˆ é™¤, åˆ™é‡æ–°å…¥é˜Ÿ, ç­‰å¾…ä¸€æ®µæ—¶é—´ååˆå¯æ¶ˆè´¹æ­¤ hpa. if !deleted { a.queue.AddRateLimited(key) } return true } å¦‚æœä» workqueue æ‹¿åˆ°çš„ hpa å¯¹è±¡å·²ç»è¢«æ¸…ç†æ‰, åˆ™è¿”å› deleted æ ‡è®°, è¡¨æ˜è¯¥å¯¹è±¡æ— éœ€å…¥é˜Ÿ. åä¹‹åˆ™è°ƒç”¨ reconcileAutoscaler ä¸»é€»è¾‘. func (a *HorizontalController) reconcileKey(ctx context.Context, key string) (deleted bool, err error) { namespace, name, err := cache.SplitMetaNamespaceKey(key) if err != nil { return true, err } hpa, err := a.hpaLister.HorizontalPodAutoscalers(namespace).Get(name) // å¦‚æœä» workqueue æ‹¿åˆ°çš„ hpa å·²ç»è¢«æ¸…ç†æ‰, åˆ™è¿”å› deleted æ ‡è®°, è¯¥å¯¹è±¡ä¸å†å…¥é˜Ÿ. if errors.IsNotFound(err) { ... return true, nil } if err != nil { return false, err } // è°ƒç”¨è¯¥æ–¹æ³•å¤„ç† scale é€»è¾‘ return false, a.reconcileAutoscaler(ctx, hpa, key) } ç®€å•çœ‹ä¸‹ workqueue çš„å®ä¾‹åŒ–ç±»å‹, ä»¥åŠ AddRateLimited() å»¶è¿Ÿæ’å…¥çš„å®ç°åŸç†. ç®€å•è¯´, å…¶å†…éƒ¨æŠŠå»¶è¿Ÿå…¥é˜Ÿå¯¹è±¡æ”¾åˆ° delay é˜Ÿåˆ—é‡Œ, æœ¬è´¨ delay queue æ•°æ®ç»“æ„ä¸ºå°é¡¶å †, ä½¿ç”¨åˆ°æœŸæ—¶é—´è¿›è¡Œ heap æ’åº. å¦å¤–å†…éƒ¨å¯åŠ¨ä¸€ä¸ªåç¨‹å»ç›‘å¬æ˜¯å¦åˆ°æœŸ, åˆ°æœŸåˆ™æ’å…¥å¯¹ queue é‡Œ. queue := workqueue.NewNamedRateLimitingQueue(NewDefaultHPARateLimiter(resyncPeriod), \"horizontalpodautoscaler\"), func (q *rateLimitingType) AddRateLimited(item interface{}) { q.DelayingInterface.AddAfter(item, q.rateLimiter.When(item)) } ","date":"2023-04-18","objectID":"/posts/32dd44/:1:3","tags":["æºç ","hpa","è½¬è½½"],"title":"æºç åˆ†æ kubernetes hpa controller æ°´å¹³è‡ªåŠ¨æ‰©ç¼©å®¹çš„å®ç°åŸç†","uri":"/posts/32dd44/"},{"categories":["kubernetes"],"content":"æ ¸å¿ƒæ–¹æ³• reconcileAutoscaler reconcileAutoscaler æ˜¯ hpa æ§åˆ¶å™¨çš„æ ¸å¿ƒå¤„ç†æ–¹æ³•. æµç¨‹æ˜¯è¿™æ ·, å…ˆå¯¹ä¸€äº›å‚æ•°åšäº†è°ƒæ•´ä¿®æ­£, è€Œåè°ƒç”¨ computeReplicasForMetrics è¿›è¡Œå¤æ‚çš„é¢„æœŸå‰¯æœ¬è®¡ç®—, å¦‚æœå‰¯æœ¬æ•°è·Ÿå½“å‰ä¸ä¸€è‡´, è¯´æ˜éœ€è¦ scale æ‰©ç¼©å®¹. æ¥ç€ä½¿ç”¨ k8s client å¯¹ hpa å…³è”å¯¹è±¡æ‰§è¡Œ scale å‰¯æœ¬è°ƒèŠ‚è¯·æ±‚, æœ€åæ›´æ–° hpa å¯¹è±¡çš„çŠ¶æ€. func (a *HorizontalController) reconcileAutoscaler(ctx context.Context, hpaShared *autoscalingv2.HorizontalPodAutoscaler, key string) error { hpa := hpaShared.DeepCopy() // å½“å‰ scale é‡Œå‰¯æœ¬æ•° currentReplicas := scale.Spec.Replicas // é¢„æœŸçš„å‰¯æœ¬æ•° desiredReplicas := int32(0) // è°ƒæ•´é¢„æœŸçš„æœ€å°å‰¯æœ¬æ•° var minReplicas int32 if hpa.Spec.MinReplicas != nil { minReplicas = *hpa.Spec.MinReplicas } else { minReplicas = 1 } rescale := true if scale.Spec.Replicas == 0 \u0026\u0026 minReplicas != 0 { // å‰¯æœ¬æ•°ä¸º0, ä¸å¯åŠ¨è‡ªåŠ¨æ‰©ç¼©å®¹ desiredReplicas = 0 rescale = false } else if currentReplicas \u003e hpa.Spec.MaxReplicas { // å¦‚æœå½“å‰å‰¯æœ¬æ•°å¤§äºæœ€å¤§æœŸæœ›å‰¯æœ¬æ•°, é‚£ä¹ˆè®¾ç½®æœŸæœ›å‰¯æœ¬æ•°ä¸ºæœ€å¤§å‰¯æœ¬æ•° desiredReplicas = hpa.Spec.MaxReplicas } else if currentReplicas \u003c minReplicas { // å¦‚æœå½“å‰å‰¯æœ¬æ•°å°äºæœ€å°æœŸæœ›å‰¯æœ¬æ•°, é‚£ä¹ˆè®¾ä¸ºæœ€å°å‰¯æœ¬æ•° desiredReplicas = minReplicas } else { var metricTimestamp time.Time // é€šè¿‡ metrics æŒ‡æ ‡æ•°æ®è®¡ç®—é¢„æœŸçš„çš„å‰¯æœ¬æ•° metricDesiredReplicas, metricName, metricStatuses, metricTimestamp, err = a.computeReplicasForMetrics(ctx, hpa, scale, hpa.Spec.Metrics) if err != nil { // æ›´æ–°çŠ¶æ€ a.updateStatusIfNeeded(ctx, hpaStatusOriginal, hpa) return fmt.Errorf(\"failed to compute desired number of replicas based on listed metrics for %s: %v\", reference, err) } // å¦‚æœæŒ‡æ ‡é¢„æœŸå‰¯æœ¬æ¯”é¢„æœŸå‰¯æœ¬å¤§, åˆ™ä½¿ç”¨æŒ‡æ ‡é¢„æœŸå‰¯æœ¬ if metricDesiredReplicas \u003e desiredReplicas { desiredReplicas = metricDesiredReplicas } // å¦‚æœé…ç½®ä¸­å­˜åœ¨ behavior ç­–ç•¥, é‚£ä¹ˆ if hpa.Spec.Behavior == nil { desiredReplicas = a.normalizeDesiredReplicas(hpa, key, currentReplicas, desiredReplicas, minReplicas) } else { desiredReplicas = a.normalizeDesiredReplicasWithBehaviors(hpa, key, currentReplicas, desiredReplicas, minReplicas) } // å¦‚æœé¢„æœŸå‰¯æœ¬è·Ÿå½“å‰å‰¯æœ¬æ•°ä¸ä¸€è‡´åˆ™è¿›è¡Œæ‰©ç¼©å®¹æ“ä½œ rescale = desiredReplicas != currentReplicas } if rescale { // é…ç½®å‰¯æœ¬æ•° scale.Spec.Replicas = desiredReplicas // è¿›è¡Œæ‰©ç¼©å®¹ _, err = a.scaleNamespacer.Scales(hpa.Namespace).Update(ctx, targetGR, scale, metav1.UpdateOptions{}) ... } else { desiredReplicas = currentReplicas } // é…ç½® hpa.status a.setStatus(hpa, currentReplicas, desiredReplicas, metricStatuses, rescale) // æ›´æ–°çŠ¶æ€ return a.updateStatusIfNeeded(ctx, hpaStatusOriginal, hpa) } ","date":"2023-04-18","objectID":"/posts/32dd44/:1:4","tags":["æºç ","hpa","è½¬è½½"],"title":"æºç åˆ†æ kubernetes hpa controller æ°´å¹³è‡ªåŠ¨æ‰©ç¼©å®¹çš„å®ç°åŸç†","uri":"/posts/32dd44/"},{"categories":["kubernetes"],"content":"è®¡ç®—é¢„æœŸçš„å‰¯æœ¬æ•° computeReplicasForMetrics ç”¨æ¥æ ¹æ® metris æŒ‡æ ‡è®¡ç®—æ–°å‰¯æœ¬æ•°çš„æ–¹æ³•. å…¶å†…éƒ¨é€»è¾‘æ˜¯è¿™æ ·, å…ˆéå† hpa.Spec.Metrics åˆ—è¡¨ä¾æ¬¡è°ƒç”¨ computeReplicasForMetric() è®¡ç®—å‡ºæœ€åé¢„æœŸå‰¯æœ¬æ•°. computeReplicasForMetric æ–¹æ³•é€šè¿‡ä¸åŒçš„æŒ‡æ ‡ç±»å‹è·å–éœ€è¦æ‰©ç¼©å‰¯æœ¬çš„æ•°é‡. func (a *HorizontalController) computeReplicasForMetrics(hpa *autoscalingv2.HorizontalPodAutoscaler, scale *autoscalingv1.Scale, metricSpecs []autoscalingv2.MetricSpec) (replicas int32, metric string, statuses []autoscalingv2.MetricStatus, timestamp time.Time, err error) { ... // éå† `hpa.Spec.Metrics` åˆ—è¡¨. for i, metricSpec := range metricSpecs { // é€šè¿‡ä¸åŒçš„æŒ‡æ ‡ç±»å‹è¿›ä¸€æ­¥è·å–éœ€è¦æ‰©ç¼©å‰¯æœ¬çš„æ•°é‡, æ¯æ¬¡è°ƒç”¨ä½¿ç”¨ä¸Šä¸€æ³¢é¢„æœŸçš„ replicas è¿›è¡Œä¼ å‚è°ƒç”¨ replicaCountProposal, metricNameProposal, timestampProposal, condition, err := a.computeReplicasForMetric(hpa, metricSpec, specReplicas, statusReplicas, selector, \u0026statuses[i]) ... // é‡æ–°èµ‹å€¼å‰¯æœ¬æ•° if err == nil \u0026\u0026 (replicas == 0 || replicaCountProposal \u003e replicas) { timestamp = timestampProposal replicas = replicaCountProposal metric = metricNameProposal } } ... return replicas, metric, statuses, timestamp, nil } æŒ‰ç…§ä¸åŒçš„æŒ‡æ ‡ç±»å‹è®¡ç®—é¢„æœŸå‡ºé¢„æœŸçš„å‰¯æœ¬æ•°. æ‹¿ä¸€ä¸ª hpa çš„ yaml ä¸¾ä¾‹è¯´æ˜ metrics æŒ‡æ ‡çš„ä½¿ç”¨. apiVersion: autoscaling/v2 kind: HorizontalPodAutoscaler metadata: name: php-apache spec: scaleTargetRef: apiVersion: apps/v1 kind: Deployment name: php-apache minReplicas: 1 maxReplicas: 10 metrics: - type: Object object: metric: name: requests-per-second describedObject: apiVersion: networking.k8s.io/v1 kind: Ingress name: main-route target: type: Value value: 10k - type: Pods pods: metric: name: packets-per-second target: type: AverageValue averageValue: 1k - type: Resource resource: name: cpu target: type: Utilization averageUtilization: 50 hpa å°è¯•ç¡®ä¿æ¯ä¸ª Pod çš„ CPU åˆ©ç”¨ç‡åœ¨ 50% ä»¥å†…, æ¯ç§’å¤„ç† 1000 ä¸ªæ•°æ®åŒ…è¯·æ±‚, è¿˜ç¡®ä¿ Ingress åçš„ Pod æ¯ç§’èƒ½å¤ŸæœåŠ¡çš„è¯·æ±‚æ€»æ•°è¾¾åˆ° 10000 ä¸ª. è¿™äº›æŒ‡æ ‡ä¸æ˜¯ and å¹¶ä¸”å…³ç³», è€Œæ˜¯ or æˆ–çš„å…³ç³», åªè¦è¶…è¿‡ä¸€ä¸ªæŒ‡æ ‡ä¹Ÿä¼šè§¦å‘æ‰©ç¼©å®¹æ“ä½œ. hpa ä¼šå°è¯•éå†æ‰€æœ‰çš„æŒ‡æ ‡æ¡ä»¶, è®¡ç®—å‡ºåˆç†çš„å‰¯æœ¬æ•°. hpa å¯ä»¥æ ¹æ®ä¸åŒçš„ metrics è¿›è¡Œ scale æ‰©ç¼©å®¹æ“ä½œ, å¸¸ç”¨çš„æ˜¯ resource æŒ‡æ ‡, è¿™é‡Œæ‹¿ resource ä¸ºä¾‹åˆ†æå…¶è®¡ç®—è¿‡ç¨‹. func (a *HorizontalController) computeReplicasForMetric(ctx context.Context, hpa *autoscalingv2.HorizontalPodAutoscaler, spec autoscalingv2.MetricSpec, specReplicas, statusReplicas int32, selector labels.Selector, status *autoscalingv2.MetricStatus) (replicaCountProposal int32, metricNameProposal string, timestampProposal time.Time, condition autoscalingv2.HorizontalPodAutoscalerCondition, err error) { switch spec.Type { case autoscalingv2.ObjectMetricSourceType: // æ ¹æ® k8s å†…ç½®å¯¹è±¡çš„æŒ‡æ ‡è¿›è¡Œè®¡ç®— case autoscalingv2.PodsMetricSourceType: // é€šè¿‡ pods çš„ metrics è¿›è¡Œè®¡ç®— case autoscalingv2.ResourceMetricSourceType: // æè¿° pod çš„ cpu, mem ç­‰èµ„æºæŒ‡æ ‡è¿›è¡Œè®¡ç®— replicaCountProposal, timestampProposal, metricNameProposal, condition, err = a.computeStatusForResourceMetric(ctx, specReplicas, spec, hpa, selector, status) if err != nil { return 0, \"\", time.Time{}, condition, fmt.Errorf(\"failed to get %s resource metric value: %v\", spec.Resource.Name, err) } case autoscalingv2.ContainerResourceMetricSourceType: // æ ¹æ®æ¯ä¸ª pod å†… container çš„ resource æŒ‡æ ‡è¿›è¡Œè®¡ç®—, æ¯”å¦‚å®¹å™¨å†…çš„ cpu, mem ç­‰. case autoscalingv2.ExternalMetricSourceType: // æ ¹æ®å¤–éƒ¨ external æŒ‡æ ‡è¿›è¡Œè®¡ç®— ... default: condition := a.getUnableComputeReplicaCountCondition(hpa, \"InvalidMetricSourceType\", err) return 0, \"\", time.Time{}, condition, err } return replicaCountProposal, metricNameProposal, timestampProposal, autoscalingv2.HorizontalPodAutoscalerCondition{}, nil } ä¾èµ–èµ„æºæŒ‡æ ‡è®¡ç®—å‰¯æœ¬æ•°çš„é€»è¾‘è°ƒç”¨é“¾ç•¥é•¿, æœ€åå…¶å®æ˜¯è°ƒç”¨ GetResourceReplicas() è®¡ç®—å‰¯æœ¬æ•°. func (c *ReplicaCalculator) GetResourceReplicas(ctx context.Context, currentReplicas int32, targetUtilization int32, resource v1.ResourceName, namespace string, selector labels.Selector, container string) (replicaCount int32, utilization int32, rawUtilization int64, timestamp time.Time, err error) { // è·å–ç¬¦åˆæ¡ä»¶ pods çš„ metrics æŒ‡æ ‡ metrics, timestamp, err := c.metricsClient.GetResourceMetric(ctx, resource, namespace, selector, container) if err != nil { return 0, 0, 0, time.Time{}, fmt.Errorf(\"unable to get metrics for resource %s: %v\", resource, err) } // è·å– pods å¯¹è±¡é›†åˆ podList, err := c.podLister.Pods(namespace).List(selector) if err != nil { return 0, 0, 0, time.Time{}, fmt.Errorf(\"unable to","date":"2023-04-18","objectID":"/posts/32dd44/:1:5","tags":["æºç ","hpa","è½¬è½½"],"title":"æºç åˆ†æ kubernetes hpa controller æ°´å¹³è‡ªåŠ¨æ‰©ç¼©å®¹çš„å®ç°åŸç†","uri":"/posts/32dd44/"},{"categories":["kubernetes"],"content":"å‘ apiserver è¯·æ±‚ Scales æ“ä½œ client-go é‡Œçš„ Scales() å®ç°äº†å¯¹ apiserver çš„è¯·æ±‚æ–¹æ³•. å…¶æœ¬è´¨ä¸Šæ˜¯å¯¹ deployment/replicaset/â€¦ çš„èµ„æºé…ç½®è¿›è¡Œæ›´æ–°, åé¢ä¾èµ–å„èµ„æºçš„ controller æ§åˆ¶å™¨æ¥å®ç°å…·ä½“çš„ scale æ“ä½œ. æ¯”å¦‚ hpa æ§åˆ¶å™¨å‘ apiserver å‘èµ· deployment å¯¹è±¡çš„ scale æ“ä½œ, æœ€åç”± deployment controller é€šè¿‡ informer æ„ŸçŸ¥ scale å˜æ›´, è€Œåè§¦å‘ å¯¹ replicaset æ“ä½œ, åé¢å†ç”± replicaset controller å®Œæˆæœ€åçš„ scale æ“ä½œ. ä»£ç ä½ç½®: vendor/k8s.io/client-go/scale/client.go func (c *scaleClient) Scales(namespace string) ScaleInterface { return \u0026namespacedScaleClient{ client: c, namespace: namespace, } } func (c *namespacedScaleClient) Update(ctx context.Context, resource schema.GroupResource, scale *autoscaling.Scale, opts metav1.UpdateOptions) (*autoscaling.Scale, error) { // è·å– path å’Œ gvr path, gvr, err := c.client.pathAndVersionFor(resource) // è·å– gvk desiredGVK, err := c.client.scaleKindResolver.ScaleForResource(gvr) if err != nil { return nil, fmt.Errorf(\"could not find proper group-version for scale subresource of %s: %v\", gvr.String(), err) } // æ›´æ¢ç‰ˆæœ¬ scaleUpdate, err := scaleConverter.ConvertToVersion(scale, desiredGVK.GroupVersion()) if err != nil { return nil, fmt.Errorf(\"could not convert scale update to external Scale: %v\", err) } // å‘ apiserver å‘èµ·è¯·æ±‚. // resource å¯ä»¥æ˜¯ deployments ç­‰èµ„æºç±»å‹ // name ä¸º hpa.Spec.ScaleTargetRef.Name, é€šå¸¸ä¸º hpa å…³è”å¯¹è±¡çš„ name // subresource å­è·¯å¾„ä¸º scale result := c.client.clientBase.Put(). AbsPath(path). NamespaceIfScoped(c.namespace, c.namespace != \"\"). Resource(gvr.Resource). Name(scale.Name). SubResource(\"scale\"). SpecificallyVersionedParams(\u0026opts, dynamicParameterCodec, versionV1). Body(scaleUpdateBytes). Do(ctx) if err := result.Error(); err != nil { return nil, err } return convertToScale(\u0026result) } ","date":"2023-04-18","objectID":"/posts/32dd44/:1:6","tags":["æºç ","hpa","è½¬è½½"],"title":"æºç åˆ†æ kubernetes hpa controller æ°´å¹³è‡ªåŠ¨æ‰©ç¼©å®¹çš„å®ç°åŸç†","uri":"/posts/32dd44/"},{"categories":["kubernetes"],"content":"apiserver å¯¹ scale è¯·æ±‚çš„å¤„ç† apiserver å¯åŠ¨æ—¶å¯¹ deployment, replicaset å’Œ statefulsets èµ„æºè¿›è¡Œ resource/scale è·¯ç”±å’Œ rest æ–¹æ³•æ³¨å†Œ. å¦å¤–, çœ‹ä»£ç çš„æ„æ€ k8s åº”è¯¥åªå®ç°äº†è¿™ä¸‰ä¸ªèµ„æºç±»å‹çš„ scale æ¥å£. ä»£ç ä½ç½®: pkg/registry/apps/rest/storage_apps.go func (p StorageProvider) v1Storage(apiResourceConfigSource serverstorage.APIResourceConfigSource, restOptionsGetter generic.RESTOptionsGetter) (map[string]rest.Storage, error) { storage := map[string]rest.Storage{} // deployments if resource := \"deployments\"; apiResourceConfigSource.ResourceEnabled(appsapiv1.SchemeGroupVersion.WithResource(resource)) { deploymentStorage, err := deploymentstore.NewStorage(restOptionsGetter) storage[resource] = deploymentStorage.Deployment storage[resource+\"/scale\"] = deploymentStorage.Scale } // statefulsets if resource := \"statefulsets\"; apiResourceConfigSource.ResourceEnabled(appsapiv1.SchemeGroupVersion.WithResource(resource)) { statefulSetStorage, err := statefulsetstore.NewStorage(restOptionsGetter) storage[resource] = statefulSetStorage.StatefulSet storage[resource+\"/scale\"] = statefulSetStorage.Scale } // replicasets if resource := \"replicasets\"; apiResourceConfigSource.ResourceEnabled(appsapiv1.SchemeGroupVersion.WithResource(resource)) { replicaSetStorage, err := replicasetstore.NewStorage(restOptionsGetter) storage[resource] = replicaSetStorage.ReplicaSet storage[resource+\"/status\"] = replicaSetStorage.Status storage[resource+\"/scale\"] = replicaSetStorage.Scale } ... return storage, nil } ä¸‹é¢æ˜¯ apiserver é‡Œ deployment scale çš„å…·ä½“å®ç°. ç®€å•è¯´å°±æ˜¯å¯¹ deployments å¯¹è±¡è°ƒæ•´å‰¯æœ¬æ•°, è®©å…¶é…å¥—çš„æ§åˆ¶å™¨å»åšå…·ä½“ scale è½åœ°æ“ä½œ. // ScaleREST implements a Scale for Deployment. type ScaleREST struct { store *genericregistry.Store } // Update alters scale subset of Deployment object. func (r *ScaleREST) Update(ctx context.Context, name string, objInfo rest.UpdatedObjectInfo, createValidation rest.ValidateObjectFunc, updateValidation rest.ValidateObjectUpdateFunc, forceAllowCreate bool, options *metav1.UpdateOptions) (runtime.Object, bool, error) { obj, _, err := r.store.Update( ctx, name, \u0026scaleUpdatedObjectInfo{name, objInfo}, toScaleCreateValidation(createValidation), toScaleUpdateValidation(updateValidation), false, options, ) ... deployment := obj.(*apps.Deployment) newScale, err := scaleFromDeployment(deployment) if err != nil { return nil, false, errors.NewBadRequest(fmt.Sprintf(\"%v\", err)) } return newScale, false, nil } å…³äº apiserver å°±ç‚¹åˆ°ä¸ºæ­¢, å®ƒçš„å®ç°åŸç†åœ¨å…¶ä»–ç« èŠ‚æœ‰åˆ†æ, è¿™é‡Œå°±ä¸å†å¤è¿°äº†. ","date":"2023-04-18","objectID":"/posts/32dd44/:1:7","tags":["æºç ","hpa","è½¬è½½"],"title":"æºç åˆ†æ kubernetes hpa controller æ°´å¹³è‡ªåŠ¨æ‰©ç¼©å®¹çš„å®ç°åŸç†","uri":"/posts/32dd44/"},{"categories":["kubernetes"],"content":"æ€»ç»“ hpa æ§åˆ¶å™¨ç›¸æ¯”å…¶ä»–æ§åˆ¶å™¨æ¥è¯´, å…¶å®ç°åŸç†è¿˜æ˜¯ç›¸å¯¹å¥½ç†è§£çš„. hpa æ§åˆ¶å™¨å¯åŠ¨æ—¶ç›‘å¬ hpaInformer, å½“æœ‰ hpa èµ„æºå¯¹è±¡å‘ç”Ÿå˜æ›´æ—¶, é€šè¿‡ hpa æ§åˆ¶å™¨æ³¨å†Œçš„ eventHandler æŠŠ hpa çš„å˜åŠ¨æ¨åˆ° workqueue é‡Œ. è€Œåå°±æ˜¯è®¡ç®—è¯¥ hpa çš„å‰¯æœ¬é¢„æœŸå€¼, éœ€è¦é€šè¿‡è®¾å®šçš„ metrics é˜ˆå€¼è¿›è¡Œä¸€ç³»åˆ—çš„è®¡ç®—. æ¯ä¸ª metrics éƒ½å¯¹åº”ä¸€å¥—è®¡ç®—æ–¹æ³•, æœ€åçš„é¢„æœŸå‰¯æœ¬æ•°å¾€å¾€æ˜¯ç»è¿‡è®¡ç®—åç´¯åŠ çš„. æœ€åé€šè¿‡è°ƒç”¨ client-go çš„ scales æ¥å£, å‘ apiserver è¯·æ±‚ä»¥å®ç°å¯¹ deployment/replicase çš„å‰¯æœ¬æ•°è°ƒæ•´. hpa è‚¯å®šä¸æ˜¯æ£€æµ‹ä¸€æ¬¡å°±å®Œäº‹äº†, å¾€å¾€éœ€è¦ä¸æ–­å‘¨æœŸæ€§å»æ£€æµ‹ hpa æ˜¯å¦æ»¡è¶³ scale æ¡ä»¶. è¿™ä¸ªå‘¨æœŸæ€§çš„è½®è¯¢æ“ä½œæ˜¯é€šè¿‡ workqueue delayInteface å®ç°çš„. hpa éš¾ç‚¹åœ¨äºå¦‚ä½•æ ¹æ® metrics æŒ‡æ ‡å’Œç›®æ ‡é˜ˆå€¼, è®¡ç®—å‡ºåˆç†çš„é¢„æœŸå‰¯æœ¬æ•°. ä¸‹é¢æ˜¯è®¡ç®—å‰¯æœ¬æ•°çš„è°ƒç”¨å…³ç³»å›¾. å‡ºå¤„: https://github.com/rfyiamcool/notes#kubernetes ","date":"2023-04-18","objectID":"/posts/32dd44/:1:8","tags":["æºç ","hpa","è½¬è½½"],"title":"æºç åˆ†æ kubernetes hpa controller æ°´å¹³è‡ªåŠ¨æ‰©ç¼©å®¹çš„å®ç°åŸç†","uri":"/posts/32dd44/"},{"categories":["kubernetes"],"content":" åŸºäº kubernetes v1.27.0 æºç åˆ†æ scheduler è°ƒåº¦å™¨ k8s scheduler çš„ä¸»è¦èŒè´£æ˜¯ä¸ºæ–°åˆ›å»ºçš„ pod å¯»æ‰¾ä¸€ä¸ªæœ€åˆé€‚çš„ node èŠ‚ç‚¹, ç„¶åè¿›è¡Œ bind node ç»‘å®š, åé¢ kubelet æ‰ä¼šç›‘å¬åˆ°å¹¶åˆ›å»ºçœŸæ­£çš„ pod. é‚£ä¹ˆé—®é¢˜æ¥äº†, å¦‚ä½•ä¸º pod å¯»æ‰¾æœ€åˆé€‚çš„ node ? è°ƒåº¦å™¨éœ€è¦ç»è¿‡ predicates é¢„é€‰å’Œ priority ä¼˜é€‰. é¢„é€‰å°±æ˜¯ä»é›†ç¾¤çš„æ‰€æœ‰èŠ‚ç‚¹ä¸­æ ¹æ®è°ƒåº¦ç®—æ³•ç­›é€‰å‡ºæ‰€æœ‰å¯ä»¥è¿è¡Œè¯¥ pod çš„èŠ‚ç‚¹é›†åˆ ä¼˜é€‰åˆ™æ˜¯æŒ‰ç…§ç®—æ³•å¯¹é¢„é€‰å‡ºæ¥çš„èŠ‚ç‚¹è¿›è¡Œæ‰“åˆ†ï¼Œæ‰¾åˆ°åˆ†å€¼æœ€é«˜çš„èŠ‚ç‚¹ä½œä¸ºè°ƒåº¦èŠ‚ç‚¹. é€‰å‡ºæœ€ä¼˜èŠ‚ç‚¹å, å¯¹ apiserver å‘èµ· pod èŠ‚ç‚¹ bind æ“ä½œ, å…¶å®å°±æ˜¯å¯¹ pod çš„ spec.NodeName èµ‹å€¼æœ€ä¼˜èŠ‚ç‚¹. æºç åŸºæœ¬è°ƒç”¨å…³ç³» ","date":"2023-04-18","objectID":"/posts/a3f5fa/:0:0","tags":["kubernetes","æºç ","è½¬è½½"],"title":"æºç åˆ†æ kubernetes scheduler æ ¸å¿ƒè°ƒåº¦å™¨çš„å®ç°åŸç†","uri":"/posts/a3f5fa/"},{"categories":["kubernetes"],"content":"k8s scheduler å¯åŠ¨å…¥å£ k8s scheduler åœ¨å¯åŠ¨æ—¶ä¼šè°ƒç”¨åœ¨ cobra æ³¨å†Œçš„ setup æ¥åˆå§‹åŒ– scheduler è°ƒåº¦å™¨å¯¹è±¡. ä»£ç ä½ç½®: cmd/kube-scheduler/app/server.go func Setup(ctx context.Context, opts *options.Options, outOfTreeRegistryOptions ...Option) (*schedulerserverconfig.CompletedConfig, *scheduler.Scheduler, error) { // è·å–é»˜è®¤é…ç½® if cfg, err := latest.Default(); err != nil { return nil, nil, err } else { opts.ComponentConfig = cfg } // éªŒè¯ scheduler çš„é…ç½®å‚æ•° if errs := opts.Validate(); len(errs) \u003e 0 { return nil, nil, utilerrors.NewAggregate(errs) } c, err := opts.Config() if err != nil { return nil, nil, err } // é…ç½®ä¸­å¡«å……å’Œè°ƒæ•´ cc := c.Complete() ... // æ„å»º scheduler å¯¹è±¡ sched, err := scheduler.New(cc.Client, cc.InformerFactory, cc.DynInformerFactory, recorderFactory, ctx.Done(), ... ) if err != nil { return nil, nil, err } ... return \u0026cc, sched, nil } å®ä¾‹åŒ– kubernetes scheduler å¯¹è±¡, åˆå§‹åŒ–æµç¨‹ç›´æ¥çœ‹ä¸‹é¢ä»£ç . ä»£ç ä½ç½®: pkg/scheduler/scheduler.go // New returns a Scheduler func New(client clientset.Interface, informerFactory informers.SharedInformerFactory, dynInformerFactory dynamicinformer.DynamicSharedInformerFactory, recorderFactory profile.RecorderFactory, stopCh \u003c-chan struct{}, opts ...Option) (*Scheduler, error) { // æ„å»º registry å¯¹è±¡, é»˜è®¤é›†æˆäº†ä¸€å †çš„æ’ä»¶ registry := frameworkplugins.NewInTreeRegistry() if err := registry.Merge(options.frameworkOutOfTreeRegistry); err != nil { return nil, err } // profiles ç”¨æ¥ä¿å­˜ä¸åŒè°ƒåº¦å™¨çš„ framework æ¡†æ¶, framework åˆ™ç”¨æ¥å­˜æ”¾ plugin. profiles, err := profile.NewMap(options.profiles, registry, recorderFactory, stopCh, frameworkruntime.WithComponentConfigVersion(options.componentConfigVersion), frameworkruntime.WithClientSet(client), frameworkruntime.WithKubeConfig(options.kubeConfig), frameworkruntime.WithInformerFactory(informerFactory), ... ... ) // å®ä¾‹åŒ–å¿«ç…§ snapshot := internalcache.NewEmptySnapshot() // å®ä¾‹åŒ– queue, è¯¥ queue ä¸º PriorityQueue. podQueue := internalqueue.NewSchedulingQueue( profiles[options.profiles[0].SchedulerName].QueueSortFunc(), informerFactory, ... ) // å®ä¾‹åŒ– cache ç¼“å­˜ schedulerCache := internalcache.New(durationToExpireAssumedPod, stopEverything) // å®ä¾‹åŒ– scheduler å¯¹è±¡ sched := \u0026Scheduler{ Cache: schedulerCache, client: client, nodeInfoSnapshot: snapshot, NextPod: internalqueue.MakeNextPodFunc(podQueue), StopEverything: stopEverything, SchedulingQueue: podQueue, } sched.applyDefaultHandlers() // åœ¨ informer é‡Œæ³¨å†Œè‡ªå®šä¹‰çš„äº‹ä»¶å¤„ç†æ–¹æ³• addAllEventHandlers(sched, informerFactory, dynInformerFactory, unionedGVKs(clusterEventMap)) return sched, nil } func (s *Scheduler) applyDefaultHandlers() { s.SchedulePod = s.schedulePod s.FailureHandler = s.handleSchedulingFailure } ","date":"2023-04-18","objectID":"/posts/a3f5fa/:1:0","tags":["kubernetes","æºç ","è½¬è½½"],"title":"æºç åˆ†æ kubernetes scheduler æ ¸å¿ƒè°ƒåº¦å™¨çš„å®ç°åŸç†","uri":"/posts/a3f5fa/"},{"categories":["kubernetes"],"content":"æ³¨å†Œåœ¨ scheduler informer çš„å›è°ƒæ–¹æ³• åœ¨ informer é‡Œæ³¨å†Œ pod å’Œ node èµ„æºçš„å›è°ƒæ–¹æ³•ï¼Œç›‘å¬ pod äº‹ä»¶å¯¹ queue å’Œ cache åšå›è°ƒå¤„ç†. ç›‘å¬ node äº‹ä»¶å¯¹ cache åšå¤„ç†. func addAllEventHandlers( sched *Scheduler, informerFactory informers.SharedInformerFactory, dynInformerFactory dynamicinformer.DynamicSharedInformerFactory, gvkMap map[framework.GVK]framework.ActionType, ) { // ç›‘å¬ pod äº‹ä»¶ï¼Œå¹¶æ³¨å†Œå¢åˆ æ”¹å›è°ƒæ–¹æ³•, å…¶æ“ä½œæ˜¯å¯¹ cache çš„å¢åˆ æ”¹ informerFactory.Core().V1().Pods().Informer().AddEventHandler( cache.FilteringResourceEventHandler{ FilterFunc: func(obj interface{}) bool { ... }, Handler: cache.ResourceEventHandlerFuncs{ AddFunc: sched.addPodToCache, UpdateFunc: sched.updatePodInCache, DeleteFunc: sched.deletePodFromCache, }, }, ) // ç›‘å¬ pod äº‹ä»¶ï¼Œå¹¶æ³¨å†Œå¢åˆ æ”¹æ–¹æ³•, å¯¹ queue æ’å…¥å¢åˆ æ”¹äº‹ä»¶. informerFactory.Core().V1().Pods().Informer().AddEventHandler( cache.FilteringResourceEventHandler{ FilterFunc: func(obj interface{}) bool { ... }, Handler: cache.ResourceEventHandlerFuncs{ AddFunc: sched.addPodToSchedulingQueue, UpdateFunc: sched.updatePodInSchedulingQueue, DeleteFunc: sched.deletePodFromSchedulingQueue, }, }, ) // ç›‘å¬ node äº‹ä»¶ï¼Œæ³¨å†Œå›è°ƒæ–¹æ³•ï¼Œè¯¥æ–¹æ³•åœ¨ cache é‡Œå¯¹ node çš„å¢åˆ æ”¹æŸ¥. informerFactory.Core().V1().Nodes().Informer().AddEventHandler( cache.ResourceEventHandlerFuncs{ AddFunc: sched.addNodeToCache, UpdateFunc: sched.updateNodeInCache, DeleteFunc: sched.deleteNodeFromCache, }, ) } ","date":"2023-04-18","objectID":"/posts/a3f5fa/:2:0","tags":["kubernetes","æºç ","è½¬è½½"],"title":"æºç åˆ†æ kubernetes scheduler æ ¸å¿ƒè°ƒåº¦å™¨çš„å®ç°åŸç†","uri":"/posts/a3f5fa/"},{"categories":["kubernetes"],"content":"scheduler çš„é€‰ä¸¾å®ç° kube-scheduler è·Ÿ k8s çš„å…¶ä»–ä¸»æ§ç»„ä»¶ä¸€æ ·, ä¹Ÿä¼šé€šè¿‡é€‰ä¸¾ leaderelection æœºåˆ¶ä¿è¯é›†ç¾¤åªæœ‰ä¸€ä¸ª leader å®ä¾‹è¿è¡Œè°ƒåº¦å™¨, å…¶ä»– follower å®ä¾‹åˆ™å°è¯•è½®è¯¢æŠ¢é”ç›´åˆ°æˆåŠŸ. æºç ä½ç½®: cmd/kube-scheduler/app/server.go func Run(ctx context.Context, cc *schedulerserverconfig.CompletedConfig, sched *scheduler.Scheduler) error { ... waitingForLeader := make(chan struct{}) isLeader := func() bool { select { case _, ok := \u003c-waitingForLeader: // if channel is closed, we are leading return !ok default: // channel is open, we are waiting for a leader return false } } // å¯åŠ¨ informers, è¿™é‡Œåªæœ‰ pod å’Œ node. cc.InformerFactory.Start(ctx.Done()) // åŒæ­¥ informer çš„æ•°æ®åˆ°æœ¬åœ°ç¼“å­˜ cc.InformerFactory.WaitForCacheSync(ctx.Done()) // å¦‚æœåœ¨é…ç½®ä¸­å¯åŠ¨äº†é€‰ä¸¾, åˆ›å»ºé€‰ä¸¾å¯¹è±¡, æ³¨å†Œäº‹ä»¶æ–¹æ³•, å¹¶å¯ç”¨é€‰ä¸¾. if cc.LeaderElection != nil { cc.LeaderElection.Callbacks = leaderelection.LeaderCallbacks{ OnStartedLeading: func(ctx context.Context) { // å½“é€‰ä¸¾æ‹¿åˆ° leader æ—¶, å¯åŠ¨ scheduler è°ƒåº¦å™¨ close(waitingForLeader) sched.Run(ctx) }, OnStoppedLeading: func() { // å½“é€‰ä¸¾æˆåŠŸä½†åé¢åˆä¸¢å¤± leader å, åˆ™é€€å‡ºè¿›ç¨‹. // è¿›ç¨‹é€€å‡ºå, ä¼šè¢« docker æˆ– systemd é‡æ–°æ‹‰èµ·, å°è¯•æ‹¿é”. select { case \u003c-ctx.Done(): // We were asked to terminate. Exit 0. os.Exit(0) default: // We lost the lock. klog.ErrorS(nil, \"Leaderelection lost\") klog.FlushAndExit(klog.ExitFlushTimeout, 1) } }, } // æ„å»º leaderelection å¯¹è±¡ leaderElector, err := leaderelection.NewLeaderElector(*cc.LeaderElection) if err != nil { return fmt.Errorf(\"couldn't create leader elector: %v\", err) } // å¯åŠ¨é€‰ä¸¾ leaderElector.Run(ctx) return fmt.Errorf(\"lost lease\") } // å¦‚æœæ²¡æœ‰å¼€å¯é€‰ä¸¾, åˆ™ç›´æ¥å¯åŠ¨ scheduler è°ƒåº¦å™¨. close(waitingForLeader) sched.Run(ctx) return fmt.Errorf(\"finished without leader elect\") } å…³äº client-go LeaderElection é€‰ä¸¾çš„å®ç°åŸç†, è¯·ç‚¹å‡»ä¸‹é¢è¿æ¥. https://github.com/rfyiamcool/notes/blob/main/kubernetes_leader_election_code.md ","date":"2023-04-18","objectID":"/posts/a3f5fa/:3:0","tags":["kubernetes","æºç ","è½¬è½½"],"title":"æºç åˆ†æ kubernetes scheduler æ ¸å¿ƒè°ƒåº¦å™¨çš„å®ç°åŸç†","uri":"/posts/a3f5fa/"},{"categories":["kubernetes"],"content":"scheudler å¯åŠ¨å…¥å£ Run() æ–¹æ³•æ˜¯ k8s scheduler çš„å¯åŠ¨è¿è¡Œå…¥å£, å…¶æµç¨‹æ˜¯å…ˆå¯åŠ¨ queue é˜Ÿåˆ—çš„ Run æ–¹æ³•, å†å¼‚æ­¥å¯åŠ¨ä¸€ä¸ªåç¨‹å¤„ç†æ ¸å¿ƒè°ƒåº¦æ–¹æ³• scheduleOne. schedulingQueue çš„ Run() æ–¹æ³•ç”¨æ¥ç›‘å¬å†…éƒ¨çš„å»¶è¿Ÿä»»åŠ¡, æŠŠåˆ°æœŸçš„ä»»åŠ¡æ”¾åˆ° activeQ ä¸­. è€Œ scheduleOne æ–¹æ³•ç”¨æ¥ä»ä¼˜å…ˆçº§é˜Ÿåˆ—é‡Œè·å–ç”± informer æ’å…¥çš„ pod å¯¹è±¡, è°ƒç”¨ schedulingCycle ä¸º pod é€‰æ‹©æœ€ä¼˜çš„ node èŠ‚ç‚¹. å¦‚æœæ‰¾åˆ°äº†åˆé€‚çš„ node èŠ‚ç‚¹, åˆ™è°ƒç”¨ bindingCycle æ–¹æ³•æ¥å‘èµ· pod å’Œ node ç»‘å®š. æºç ä½ç½®: pkg/scheduler/scheduler.go func (sched *Scheduler) Run(ctx context.Context) { sched.SchedulingQueue.Run() go wait.UntilWithContext(ctx, sched.scheduleOne, 0) \u003c-ctx.Done() sched.SchedulingQueue.Close() } func (sched *Scheduler) scheduleOne(ctx context.Context) { // ä» activeQ ä¸­è·å–éœ€è¦è°ƒåº¦çš„ pod æ•°æ® podInfo := sched.NextPod() pod := podInfo.Pod // ä¸º pod é€‰æ‹©æœ€ä¼˜çš„ node èŠ‚ç‚¹ scheduleResult, assumedPodInfo, err := sched.schedulingCycle(schedulingCycleCtx, state, fwk, podInfo, start, podsToActivate) if err != nil { // å¦‚ä½•æ²¡æœ‰æ‰¾åˆ°èŠ‚ç‚¹ï¼Œåˆ™æ‰§è¡Œå¤±è´¥æ–¹æ³•. sched.FailureHandler(schedulingCycleCtx, fwk, assumedPodInfo, err, scheduleResult.reason, scheduleResult.nominatingInfo, start) return } go func() { // åƒ apiserver å‘èµ· pod -\u003e node ç»‘å®š status := sched.bindingCycle(bindingCycleCtx, state, fwk, scheduleResult, assumedPodInfo, start, podsToActivate) if !status.IsSuccess() { sched.handleBindingCycleError(bindingCycleCtx, state, fwk, assumedPodInfo, start, scheduleResult, status) } }() } NextPod åº•å±‚å¼•ç”¨äº† MakeNextPodFunc æ–¹æ³•, å…¶å†…éƒ¨ä» PriorityQueue é˜Ÿåˆ—ä¸­è·å– pod å¯¹è±¡. func MakeNextPodFunc(queue SchedulingQueue) func() *framework.QueuedPodInfo { return func() *framework.QueuedPodInfo { podInfo, err := queue.Pop() if err == nil { return podInfo } return nil } } func (p *PriorityQueue) Pop() (*framework.QueuedPodInfo, error) { p.lock.Lock() defer p.lock.Unlock() for p.activeQ.Len() == 0 { // æ²¡æœ‰æ•°æ®åˆ™é™·å…¥æ¡ä»¶å˜é‡çš„ç­‰å¾…æ¥å£ p.cond.Wait() } obj, err := p.activeQ.Pop() if err != nil { return nil, err } pInfo := obj.(*framework.QueuedPodInfo) pInfo.Attempts++ // æ¯æ¬¡ pop åéƒ½å¢åŠ ä¸‹ attempts æ¬¡æ•°. return pInfo, nil } ","date":"2023-04-18","objectID":"/posts/a3f5fa/:4:0","tags":["kubernetes","æºç ","è½¬è½½"],"title":"æºç åˆ†æ kubernetes scheduler æ ¸å¿ƒè°ƒåº¦å™¨çš„å®ç°åŸç†","uri":"/posts/a3f5fa/"},{"categories":["kubernetes"],"content":"å•å®ä¾‹å•åç¨‹æ¨¡å‹çš„ schduler è°ƒåº¦å™¨ éœ€è¦å…³æ³¨çš„æ˜¯æ•´ä¸ª kubernetes scheduler è°ƒåº¦å™¨åªæœ‰ä¸€ä¸ªåç¨‹å¤„ç†ä¸»è°ƒåº¦å¾ªç¯ scheduleOne, è™½ç„¶ kubernetes scheduler å¯ä»¥å¯åŠ¨å¤šä¸ªå®ä¾‹, ä½†å¯åŠ¨æ—¶éœ€è¦ leaderelection é€‰ä¸¾, åªæœ‰ leader æ‰å¯ä»¥å¤„ç†è°ƒåº¦, å…¶ä»–èŠ‚ç‚¹ä½œä¸º follower ç­‰å¾… leader å¤±æ•ˆ. ä¹Ÿå°±æ˜¯è¯´æ•´ä¸ª k8s é›†ç¾¤è°ƒåº¦æ ¸å¿ƒçš„å¹¶å‘åº¦ä¸º 1 ä¸ª. äº‘åŸç”Ÿç¤¾åŒºä¸­æœ‰äººä½¿ç”¨ kubemark æ¨¡æ‹Ÿ 2000 ä¸ªèŠ‚ç‚¹çš„è§„æ¨¡æ¥å‹æµ‹ kube-scheduler å¤„ç†æ€§èƒ½åŠæ—¶å»¶, æµ‹è¯•ç»“æœæ˜¯ 30s å†…å®Œæˆ 15000 ä¸ª pod è°ƒåº¦ä»»åŠ¡. è™½ç„¶ kube-scheduler æ˜¯å•å¹¶å‘æ¨¡å‹, ä½†ç”±äºé¢„é€‰å’Œä¼˜é€‰éƒ½å±äºè®¡ç®—å‹ä»»åŠ¡éé˜»å¡IO, åˆæœ‰ percentageOfNodesToScore å‚æ•°ä¼˜åŒ–, æœ€é‡è¦çš„æ˜¯åˆ›å»º pod çš„æ“ä½œé€šå¸¸ä¸ä¼šå¤ªé«˜å¹¶å‘. è¿™å‡ ç‚¹ä¸‹æ¥å•å¹¶å‘æ¨¡å‹çš„ scheduler ä¹Ÿè¿˜å¯ä»¥æ¥å—çš„. ","date":"2023-04-18","objectID":"/posts/a3f5fa/:5:0","tags":["kubernetes","æºç ","è½¬è½½"],"title":"æºç åˆ†æ kubernetes scheduler æ ¸å¿ƒè°ƒåº¦å™¨çš„å®ç°åŸç†","uri":"/posts/a3f5fa/"},{"categories":["kubernetes"],"content":"ä¸ºä»€ä¹ˆ scheduler ä¸æ”¯æŒå¹¶å‘ ? æŒ‰ç…§å½“å‰ scheudler è°ƒåº¦å™¨çš„è®¾è®¡åŸç†, ä½¿ç”¨é¢„é€‰å’Œä¼˜é€‰ç®—æ³•é€‰å‡ºæœ€åˆé€‚çš„èŠ‚ç‚¹, å¹¶å‘åœºæ™¯ä¸‹æ— æ³•ä¿è¯å®‰å…¨, æ¯”å¦‚, é€‰å‡ºçš„æœ€ä¼˜èŠ‚ç‚¹åœ¨å¹¶å‘ä¸‹ä¼šè¢«å¤šä¸ª pod ç»‘å®š. ","date":"2023-04-18","objectID":"/posts/a3f5fa/:5:1","tags":["kubernetes","æºç ","è½¬è½½"],"title":"æºç åˆ†æ kubernetes scheduler æ ¸å¿ƒè°ƒåº¦å™¨çš„å®ç°åŸç†","uri":"/posts/a3f5fa/"},{"categories":["kubernetes"],"content":"ä½¿ç”¨è‡ªå®šä¹‰è°ƒåº¦å™¨è¿›è¡Œå¹¶å‘è°ƒåº¦ ? k8s é»˜è®¤çš„è°ƒåº¦å™¨ä¸º default-scheduler, è€Œä½¿ç”¨ç›¸åŒè°ƒåº¦å™¨åªèƒ½å•å¹¶å‘å¤„ç†è°ƒåº¦. ä½†æ˜¯å¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰å®ç°è°ƒåº¦å™¨çš„æ–¹æ¡ˆ, åœ¨åˆ›å»º pod æ—¶æŒ‡å®šä¸åŒçš„è°ƒåº¦å™¨ç®—æ³• pod.Spec.schedulerName = xiaorui.cc, è¿™æ ·å¯ä»¥ä½¿ä¸åŒè°ƒåº¦å™¨çš„ kube-schedueler å¹¶è¡Œè°ƒåº¦èµ·æ¥, å„è‡ªæŒ‰ç…§è°ƒåº¦ç®—æ³•æ¥è°ƒåº¦, è¿è¡Œäº’ä¸å½±å“. å½“ç„¶å¤§å¤šæ•°å…¬å¸æ²¡è¿™ä¸ªå¿…è¦. ","date":"2023-04-18","objectID":"/posts/a3f5fa/:5:2","tags":["kubernetes","æºç ","è½¬è½½"],"title":"æºç åˆ†æ kubernetes scheduler æ ¸å¿ƒè°ƒåº¦å™¨çš„å®ç°åŸç†","uri":"/posts/a3f5fa/"},{"categories":["kubernetes"],"content":"schedulingCycle æ ¸å¿ƒè°ƒåº¦å‘¨æœŸçš„å®ç° schedulingCycle() è¯¥æ–¹æ³•ä¸»è¦ä¸º pod é€‰å‡ºæœ€ä¼˜çš„ node èŠ‚ç‚¹. å…ˆé€šè¿‡é¢„é€‰è¿‡ç¨‹è¿‡æ»¤å‡ºç¬¦åˆ pod è¦æ±‚çš„èŠ‚ç‚¹é›†åˆ, å†é€šè¿‡æ’ä»¶å¯¹è¿™äº›èŠ‚ç‚¹è¿›è¡Œæ‰“åˆ†, ä½¿ç”¨åˆ†å€¼æœ€é«˜çš„ node ä¸º pod è°ƒåº¦èŠ‚ç‚¹. scheduler å†…ç½®å„ä¸ªé˜¶æ®µçš„å„ç§æ’ä»¶, é¢„é€‰å’Œä¼˜é€‰é˜¶æ®µå°±æ˜¯éå†å›è°ƒæ’ä»¶æ±‚å‡ºç»“æœ. è°ƒåº¦å‘¨æœŸ schedulingCycle å†…å…³é”®æ–¹æ³•æ˜¯ schedulePod, å…¶ç®€åŒ–æµç¨‹å¦‚ä¸‹. å…ˆè°ƒç”¨ findNodesThatFitPod è¿‡æ»¤å‡ºç¬¦åˆè¦æ±‚çš„é¢„é€‰èŠ‚ç‚¹. è°ƒç”¨ prioritizeNodes ä¸ºé¢„é€‰å‡ºæ¥çš„èŠ‚ç‚¹è¿›è¡Œæ‰“åˆ† score. æœ€åè°ƒç”¨ selectHost é€‰æ‹©æœ€åˆé€‚çš„ node èŠ‚ç‚¹. func (sched *Scheduler) schedulingCycle( ... ) (ScheduleResult, *framework.QueuedPodInfo, error) { pod := podInfo.Pod // é€‰æ‹©èŠ‚ç‚¹ scheduleResult, err := sched.SchedulePod(ctx, fwk, state, pod) ... // åœ¨ç¼“å­˜ cache ä¸­æ›´æ–°çŠ¶æ€ err = sched.assume(assumedPod, scheduleResult.SuggestedHost) ... } func (sched *Scheduler) schedulePod(ctx context.Context, fwk framework.Framework, state *framework.CycleState, pod *v1.Pod) (result ScheduleResult, err error) { // æ›´æ–°å¿«ç…§ if err := sched.Cache.UpdateSnapshot(sched.nodeInfoSnapshot); err != nil { return result, err } // è¿›è¡Œé¢„é€‰ç­›é€‰ feasibleNodes, diagnosis, err := sched.findNodesThatFitPod(ctx, fwk, state, pod) if err != nil { return result, err } // é¢„é€‰ä¸‹æ¥ï¼Œæ— èŠ‚ç‚¹å¯ä»¥ç”¨, è¿”å›é”™è¯¯ if len(feasibleNodes) == 0 { return result, \u0026framework.FitError{ Pod: pod, NumAllNodes: sched.nodeInfoSnapshot.NumNodes(), Diagnosis: diagnosis, } } // ç»è¿‡é¢„é€‰å°±åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œé‚£ä¹ˆç›´æ¥è¿”å› if len(feasibleNodes) == 1 { return ScheduleResult{ SuggestedHost: feasibleNodes[0].Name, EvaluatedNodes: 1 + len(diagnosis.NodeToStatusMap), FeasibleNodes: 1, }, nil } // è¿›è¡Œä¼˜é€‰è¿‡ç¨‹, å¯¹é¢„é€‰å‡ºæ¥çš„èŠ‚ç‚¹è¿›è¡Œæ‰“åˆ† priorityList, err := prioritizeNodes(ctx, sched.Extenders, fwk, state, pod, feasibleNodes) if err != nil { return result, err } // ä»ä¼˜é€‰ä¸­é€‰å‡ºæœ€é«˜åˆ†çš„èŠ‚ç‚¹ host, err := selectHost(priorityList) return ScheduleResult{ SuggestedHost: host, EvaluatedNodes: len(feasibleNodes) + len(diagnosis.NodeToStatusMap), FeasibleNodes: len(feasibleNodes), }, err } ","date":"2023-04-18","objectID":"/posts/a3f5fa/:6:0","tags":["kubernetes","æºç ","è½¬è½½"],"title":"æºç åˆ†æ kubernetes scheduler æ ¸å¿ƒè°ƒåº¦å™¨çš„å®ç°åŸç†","uri":"/posts/a3f5fa/"},{"categories":["kubernetes"],"content":"findNodesThatFitPod findNodesThatFitPod æ–¹æ³•ç”¨æ¥å®ç°è°ƒåº¦å™¨çš„é¢„é€‰è¿‡ç¨‹, å…¶å†…éƒ¨è°ƒç”¨æ’ä»¶çš„ PreFilter å’Œ Filter æ–¹æ³•æ¥ç­›é€‰å‡ºç¬¦åˆ pod è¦æ±‚çš„ node èŠ‚ç‚¹é›†åˆ. func (sched *Scheduler) findNodesThatFitPod(ctx context.Context, fwk framework.Framework, state *framework.CycleState, pod *v1.Pod) ([]*v1.Node, framework.Diagnosis, error) { diagnosis := framework.Diagnosis{ NodeToStatusMap: make(framework.NodeToStatusMap), UnschedulablePlugins: sets.NewString(), } // è·å–æ‰€æœ‰çš„ nodes allNodes, err := sched.nodeInfoSnapshot.NodeInfos().List() if err != nil { return nil, diagnosis, err } // è°ƒç”¨ framework çš„ PreFilter é›†åˆé‡Œçš„æ’ä»¶ preRes, s := fwk.RunPreFilterPlugins(ctx, state, pod) if !s.IsSuccess() { // å¦‚æœåœ¨ prefilter æœ‰å¼‚å¸¸, åˆ™ç›´æ¥è·³å‡º. if !s.IsUnschedulable() { return nil, diagnosis, s.AsError() } msg := s.Message() diagnosis.PreFilterMsg = msg return nil, diagnosis, nil } ... // æ ¹æ® prefilter æ‹¿åˆ°çš„ node names è·å– node info å¯¹è±¡. nodes := allNodes if !preRes.AllNodes() { nodes = make([]*framework.NodeInfo, 0, len(preRes.NodeNames)) for n := range preRes.NodeNames { nInfo, err := sched.nodeInfoSnapshot.NodeInfos().Get(n) if err != nil { return nil, diagnosis, err } nodes = append(nodes, nInfo) } } // è¿è¡Œ framework çš„ filter æ’ä»¶åˆ¤æ–­ node æ˜¯å¦å¯ä»¥è¿è¡Œæ–° pod. feasibleNodes, err := sched.findNodesThatPassFilters(ctx, fwk, state, pod, diagnosis, nodes) ... // è°ƒç”¨é¢å¤–çš„ extender è°ƒåº¦å™¨æ¥è¿›è¡Œé¢„é€‰ feasibleNodes, err = findNodesThatPassExtenders(sched.Extenders, pod, feasibleNodes, diagnosis.NodeToStatusMap) if err != nil { return nil, diagnosis, err } return feasibleNodes, diagnosis, nil } findNodesThatPassFilters å¹¶å‘æ‰§è¡Œ Filter æ’ä»¶æ–¹æ³• findNodesThatPassFilters æ–¹æ³•ç”¨æ¥éå†æ‰§è¡Œ framework é‡Œ Filter æ’ä»¶é›†åˆçš„ Filter æ–¹æ³•. ä¸ºäº†åŠ å¿«æ‰§è¡Œæ•ˆç‡, å‡å°‘é¢„é€‰é˜¶æ®µçš„æ—¶å»¶, framework å†…éƒ¨æœ‰ä¸ª Parallelizer å¹¶å‘æ§åˆ¶å™¨, å¯ç”¨ 16 ä¸ªåç¨‹å¹¶å‘è°ƒç”¨æ’ä»¶çš„ Filter æ–¹æ³•. åœ¨å¤§é›†ç¾¤ä¸‹ nodes èŠ‚ç‚¹ä¼šå¾ˆå¤š, ä¸ºäº†é¿å…éå†å…¨é‡çš„ nodes æ‰§è¡Œ Filter å’Œåç»­çš„æ’ä»¶é€»è¾‘, è¿™é‡Œé€šè¿‡ numFeasibleNodesToFind æ–¹æ³•æ¥å‡å°‘æ‰«æè®¡ç®—çš„ nodes æ•°é‡. å½“æˆåŠŸæ‰§è¡Œ filter æ’ä»¶æ–¹æ³•çš„æ•°é‡è¶…è¿‡ numNodesToFind æ—¶, åˆ™æ‰§è¡Œ context cancel(). è¿™æ · framework å¹¶å‘åç¨‹æ± ç›‘å¬åˆ° ctx è¢«å…³é—­å, åˆ™ä¸ä¼šç»§ç»­æ‰§è¡Œåç»­çš„ä»»åŠ¡. func (sched *Scheduler) findNodesThatPassFilters( ctx context.Context, fwk framework.Framework, pod *v1.Pod, nodes []*framework.NodeInfo) ([]*v1.Node, error) { numAllNodes := len(nodes) // è®¡ç®—éœ€è¦æ‰«æçš„ nodes æ•°, é¿å…äº†è¶…å¤§é›†ç¾¤ä¸‹ nodes çš„è®¡ç®—æ•°é‡. // å½“é›†ç¾¤çš„èŠ‚ç‚¹æ•°å°äº 100 æ—¶, åˆ™ç›´æ¥ä½¿ç”¨é›†ç¾¤çš„èŠ‚ç‚¹æ•°ä½œä¸ºæ‰«ææ•°æ®é‡ // å½“å¤§äº 100 æ—¶, åˆ™ä½¿ç”¨å…¬å¼è®¡ç®— `numAllNodes * (50 - numAllNodes/125) / 100` numNodesToFind := sched.numFeasibleNodesToFind(fwk.PercentageOfNodesToScore(), int32(numAllNodes)) feasibleNodes := make([]*v1.Node, numNodesToFind) // å¦‚æœ framework æœªæ³¨å†Œ Filter æ’ä»¶, åˆ™é€€å‡º. if !fwk.HasFilterPlugins() { for i := range feasibleNodes { feasibleNodes[i] = nodes[(sched.nextStartNodeIndex+i)%numAllNodes].Node() } return feasibleNodes, nil } // framework å†…ç½®å¹¶å‘æ§åˆ¶å™¨, å¹¶å‘ 16 ä¸ªåç¨‹å»è¯·æ±‚æ’ä»¶çš„ Filter æ–¹æ³•. errCh := parallelize.NewErrorChannel() var statusesLock sync.Mutex checkNode := func(i int) { // è·å– node info å¯¹è±¡ nodeInfo := nodes[(sched.nextStartNodeIndex+i)%numAllNodes] // éå†æ‰§è¡Œ framework çš„ Filter æ’ä»¶çš„ Filter æ–¹æ³•. status := fwk.RunFilterPluginsWithNominatedPods(ctx, state, pod, nodeInfo) if status.Code() == framework.Error { // å¦‚æœæœ‰é”™è¯¯, ç›´æ¥æŠŠé”™è¯¯ä¼ åˆ° errCh ç®¡é“é‡Œ. errCh.SendErrorWithCancel(status.AsError(), cancel) return } if status.IsSuccess() { // å¦‚æœæˆåŠŸæ‰§è¡Œ Filter æ’ä»¶çš„æ•°é‡è¶…è¿‡ numNodesToFind, åˆ™æ‰§è¡Œ cancel(). // å½“ ctx è¢« cancel(), framework çš„å¹¶å‘åç¨‹æ± ä¸ä¼šç»§ç»­æ‰§è¡Œåç»­çš„ä»»åŠ¡. length := atomic.AddInt32(\u0026feasibleNodesLen, 1) if length \u003e numNodesToFind { cancel() atomic.AddInt32(\u0026feasibleNodesLen, -1) } else { feasibleNodes[length-1] = nodeInfo.Node() } } ... } // å¹¶å‘è°ƒç”¨ framework çš„ Filter æ’ä»¶çš„ Filter æ–¹æ³•. fwk.Parallelizer().Until(ctx, numAllNodes, checkNode, frameworkruntime.Filter) feasibleNodes = feasibleNodes[:feasibleNodesLen] if err := errCh.ReceiveError(); err != nil { // å½“æœ‰é”™è¯¯æ—¶, ç›´æ¥è¿”å›. statusCode = framework.Error return feasibleNodes, err } // è¿”å›å¯ç”¨çš„ nodes åˆ—è¡¨. return feasibleNodes, nil } framework çš„å¹¶å‘åº“ä¹Ÿæ˜¯é€šè¿‡å°è£… workqueue.ParallelizeUntil æ¥å®ç°çš„, å…³äº parallelizer çš„å®ç°åŸç†è¿™é‡Œå°±ä¸åšåˆ†æäº†. k8s.io/client-go/util/workqueue/parallelizer.go numFeasibleNodesToFind è®¡ç®—å¤šå°‘èŠ‚ç‚¹å‚ä¸é¢„é€‰ ğŸ¤” è€ƒè™‘ä¸€ä¸ªé—®é¢˜, å½“ k8s çš„ node èŠ‚ç‚¹ç‰¹åˆ«å¤šæ—¶, è¿™äº›èŠ‚ç‚¹éƒ½è¦å‚ä¸é¢„å…ˆçš„è°ƒåº¦è¿‡ç¨‹ä¹ˆ ? æ¯”å¦‚å¤§é›†ç¾¤æœ‰ 2500 ä¸ªèŠ‚ç‚¹, æ³¨å†Œçš„æ’ä»¶æœ‰ 10 ä¸ª, é‚£ä¹ˆ ç­›é€‰ Filter å’Œ æ‰“åˆ† Score è¿‡ç¨‹éœ€è¦è¿›è¡Œ 2500 * 10 *","date":"2023-04-18","objectID":"/posts/a3f5fa/:6:1","tags":["kubernetes","æºç ","è½¬è½½"],"title":"æºç åˆ†æ kubernetes scheduler æ ¸å¿ƒè°ƒåº¦å™¨çš„å®ç°åŸç†","uri":"/posts/a3f5fa/"},{"categories":["kubernetes"],"content":"prioritizeNodes prioritizeNodes æ–¹æ³•ä¸ºè°ƒåº¦å™¨çš„ä¼˜é€‰é˜¶æ®µçš„å®ç°. å…¶å†…éƒ¨ä¼šéå†è°ƒç”¨ framework çš„ PreScore æ’ä»¶é›†åˆé‡Œ PeScore æ–¹æ³•, ç„¶åå†éå†è°ƒç”¨ framework çš„ Score æ’ä»¶é›†åˆçš„ Score æ–¹æ³•. ç»è¿‡ Score æ‰“åˆ†è®¡ç®—åå¯ä»¥æ‹¿åˆ°å„ä¸ª node çš„åˆ†å€¼. func prioritizeNodes( ctx context.Context, extenders []framework.Extender, fwk framework.Framework, state *framework.CycleState, pod *v1.Pod, nodes []*v1.Node, ) ([]framework.NodePluginScores, error) { // å¦‚æœ extenders ä¸ºç©ºå’Œscore æ’ä»¶ä¸ºç©º, åˆ™è·³å‡º if len(extenders) == 0 \u0026\u0026 !fwk.HasScorePlugins() { result := make([]framework.NodePluginScores, 0, len(nodes)) for i := range nodes { result = append(result, framework.NodePluginScores{ Name: nodes[i].Name, TotalScore: 1, }) } return result, nil } // åœ¨ framework çš„ PreScore æ’ä»¶é›†åˆé‡Œ, éå†æ‰§è¡Œæ’ä»¶çš„ PreSocre æ–¹æ³• preScoreStatus := fwk.RunPreScorePlugins(ctx, state, pod, nodes) if !preScoreStatus.IsSuccess() { // åªæœ‰æœ‰å¼‚å¸¸ç›´æ¥é€€å‡º return nil, preScoreStatus.AsError() } // åœ¨ framework çš„ Score æ’ä»¶é›†åˆé‡Œ, éå†æ‰§è¡Œæ’ä»¶çš„ Socre æ–¹æ³• nodesScores, scoreStatus := fwk.RunScorePlugins(ctx, state, pod, nodes) if !scoreStatus.IsSuccess() { return nil, scoreStatus.AsError() } klogV := klog.V(10) if klogV.Enabled() { for _, nodeScore := range nodesScores { // æ‰“å°æ’ä»¶åå­—å’Œåˆ†å€¼ score for _, pluginScore := range nodeScore.Scores { klogV.InfoS(\"Plugin scored node for pod\", \"pod\", klog.KObj(pod), \"plugin\", pluginScore.Name, \"node\", nodeScore.Name, \"score\", pluginScore.Score) } } } if len(extenders) != 0 \u0026\u0026 nodes != nil { // å½“é¢å¤– extenders è°ƒåº¦å™¨ä¸ä¸ºç©ºæ—¶, åˆ™éœ€è¦è®¡ç®—åˆ†å€¼. ... ... } return nodesScores, nil } ","date":"2023-04-18","objectID":"/posts/a3f5fa/:6:2","tags":["kubernetes","æºç ","è½¬è½½"],"title":"æºç åˆ†æ kubernetes scheduler æ ¸å¿ƒè°ƒåº¦å™¨çš„å®ç°åŸç†","uri":"/posts/a3f5fa/"},{"categories":["kubernetes"],"content":"selectHost selectHost æ˜¯ä»ä¼˜é€‰çš„ nodes é›†åˆé‡Œè·å–åˆ†å€¼ socre æœ€é«˜çš„ node. å†…éƒ¨è¿˜åšäº†ä¸€ä¸ªå°ä¼˜åŒ–, å½“ç›¸è¿‘çš„ä¸¤ä¸ª node åˆ†å€¼ç›¸åŒæ—¶, åˆ™é€šè¿‡éšæœºæ¥é€‰æ‹© node, ç›®çš„ä½¿ k8s node çš„è´Ÿè½½æ›´è¶‹äºå‡è¡¡. func selectHost(nodeScores []framework.NodePluginScores) (string, error) { // å¦‚æœ nodes ä¸ºç©º, åˆ™è¿”å›é”™è¯¯ if len(nodeScores) == 0 { return \"\", fmt.Errorf(\"empty priorityList\") } // ç›´æ¥ä»å¤´åˆ°ä½éå† nodeScores æ•°ç»„, æ‹¿åˆ°åˆ†å€¼ score æœ€åçš„ nodeName. maxScore := nodeScores[0].TotalScore selected := nodeScores[0].Name cntOfMaxScore := 1 for _, ns := range nodeScores[1:] { if ns.TotalScore \u003e maxScore { // å½“å‰çš„åˆ†å€¼æ›´å¤§, åˆ™è¿›è¡Œèµ‹å€¼. maxScore = ns.TotalScore selected = ns.Name cntOfMaxScore = 1 } else if ns.TotalScore == maxScore { // å½“ä¸¤ä¸ª node çš„ åˆ†å€¼ç›¸åŒæ—¶, // ä½¿ç”¨éšæœºç®—æ³•æ¥é€‰æ‹©å½“å‰å’Œä¸Šä¸€ä¸ª node. cntOfMaxScore++ if rand.Intn(cntOfMaxScore) == 0 { selected = ns.Name } } } // è¿”å›åˆ†å€¼æœ€é«˜çš„ node return selected, nil } ","date":"2023-04-18","objectID":"/posts/a3f5fa/:6:3","tags":["kubernetes","æºç ","è½¬è½½"],"title":"æºç åˆ†æ kubernetes scheduler æ ¸å¿ƒè°ƒåº¦å™¨çš„å®ç°åŸç†","uri":"/posts/a3f5fa/"},{"categories":["kubernetes"],"content":"PriorityQueue çš„å®ç° PriorityQueue ç”¨æ¥å®ç°ä¼˜å…ˆçº§é˜Ÿåˆ—, informer ä¼šæ¡ä»¶ pod åˆ° priorityQueue é˜Ÿåˆ—ä¸­, scheduleOne ä¼šä»è¯¥é˜Ÿåˆ—ä¸­ pop å¯¹è±¡. åœ¨åˆ›å»ºå»¶è¿Ÿé˜Ÿåˆ—æ—¶ä¼ å…¥ä¸€ä¸ª less æ¯”è¾ƒæ–¹æ³•, æ—¶é—´æœ€å°çš„ podInfo æ”¾åœ¨ heap çš„æœ€é¡¶ç«¯. flushBackoffQCompleted ä¼šä¸æ–­çš„æ£€æŸ¥ backoff heap å †é¡¶çš„å…ƒç´ æ˜¯å¦æ»¡è¶³æ¡ä»¶, å½“æ»¡è¶³æ¡ä»¶æŠŠ pod å¯¹è±¡æ‰”åˆ° activeQ é˜Ÿé‡Œ, å¹¶æ¿€æ´»æ¡ä»¶å˜é‡. è¿™é‡Œæ²¡æœ‰é‡‡ç”¨ç›‘å¬ç­‰å¾…å †é¡¶åˆ°æœŸæ—¶é—´çš„æ–¹æ³•ï¼Œè€Œæ˜¯æ¯éš”ä¸€ç§’å»æ£€æŸ¥å †é¡¶çš„ podInfo æ˜¯å¦å·²åˆ°æœŸ isPodBackingoff. backoff æ—¶é•¿æ˜¯ä¾èµ– podInfo.Attempts é‡è¯•æ¬¡æ•°çš„ï¼Œé»˜è®¤æƒ…å†µä¸‹é‡è¯• 5æ¬¡ æ˜¯ 5s, æœ€å¤§ä¸èƒ½è¶…è¿‡ 10s. ä¸»è°ƒåº¦æ–¹æ³• scheduleOne æ¯æ¬¡ä»é˜Ÿåˆ—è·å– podInfo æ—¶, å®ƒçš„ Attempts å­—æ®µéƒ½ä¼šåŠ ä¸€. ä»£ç ä½ç½®: pkg/scheduler/internal/queue/scheduling_queue.go const ( DefaultPodMaxBackoffDuration time.Duration = 10 * time.Second ) // å®ä¾‹åŒ–ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œè¯¥é˜Ÿåˆ—ä¸­å«æœ‰ activeQ, podBackoffQ, unschedulablePodsé›†åˆ. func NewPriorityQueue() { pq.podBackoffQ = heap.NewWithRecorder( podInfoKeyFunc, pq.podsCompareBackoffCompleted, ... ) } // æ·»åŠ  pod å¯¹è±¡ func (p *PriorityQueue) Add(pod *v1.Pod) error { p.lock.Lock() defer p.lock.Unlock() pInfo := p.newQueuedPodInfo(pod) gated := pInfo.Gated // æŠŠå¯¹è±¡åŠ åˆ° activeQ é˜Ÿåˆ—é‡Œ. if added, err := p.addToActiveQ(pInfo); !added { return err } // å¦‚æœè¯¥å¯¹è±¡åœ¨ä¸å¯è°ƒåº¦é›†åˆä¸­å­˜åœ¨, åˆ™éœ€è¦åœ¨é‡Œé¢åˆ é™¤. if p.unschedulablePods.get(pod) != nil { p.unschedulablePods.delete(pod, gated) } // ä» backoffQ åˆ é™¤ pod å¯¹è±¡ if err := p.podBackoffQ.Delete(pInfo); err == nil { klog.ErrorS(nil, \"Error: pod is already in the podBackoff queue\", \"pod\", klog.KObj(pod)) } // æ¡ä»¶å˜é‡é€šçŸ¥ p.cond.Broadcast() return nil } // è·å– pod info å¯¹è±¡ func (p *PriorityQueue) Pop() (*framework.QueuedPodInfo, error) { p.lock.Lock() defer p.lock.Unlock() // å¦‚æœ activeQ ä¸ºç©º, é™·å…¥ç­‰å¾… for p.activeQ.Len() == 0 { if p.closed { return nil, fmt.Errorf(queueClosed) } p.cond.Wait() } // ä» activeQ å †é¡¶ pop å¯¹è±¡ obj, err := p.activeQ.Pop() if err != nil { return nil, err } pInfo := obj.(*framework.QueuedPodInfo) // åŠ ä¸€ pInfo.Attempts++ p.schedulingCycle++ return pInfo, nil } // heap çš„æ¯”è¾ƒæ–¹æ³•ï¼Œç¡®ä¿ deadline æœ€ä½çš„åœ¨ heap é¡¶éƒ¨. func (p *PriorityQueue) podsCompareBackoffCompleted(podInfo1, podInfo2 interface{}) bool { bo1 := p.getBackoffTime(pInfo1) bo2 := p.getBackoffTime(pInfo2) return bo1.Before(bo2) } func (p *PriorityQueue) getBackoffTime(podInfo *framework.QueuedPodInfo) time.Time { duration := p.calculateBackoffDuration(podInfo) backoffTime := podInfo.Timestamp.Add(duration) return backoffTime } // backoff duration éšç€é‡è¯•æ¬¡æ•°ä¸æ–­å åŠ ï¼Œä½†æœ€å¤§ä¸èƒ½è¶…è¿‡ maxBackoffDuration. func (p *PriorityQueue) calculateBackoffDuration(podInfo *framework.QueuedPodInfo) time.Duration { duration := p.podInitialBackoffDuration // 1s for i := 1; i \u003c podInfo.Attempts; i++ { if duration \u003e p.podMaxBackoffDuration-duration { return p.podMaxBackoffDuration // 10s } duration += duration } return duration } ","date":"2023-04-18","objectID":"/posts/a3f5fa/:6:4","tags":["kubernetes","æºç ","è½¬è½½"],"title":"æºç åˆ†æ kubernetes scheduler æ ¸å¿ƒè°ƒåº¦å™¨çš„å®ç°åŸç†","uri":"/posts/a3f5fa/"},{"categories":["kubernetes"],"content":"å¦‚ä½•å¤„ç†è°ƒåº¦å¤±è´¥çš„ pod å‰é¢æœ‰è¯´ kubernetes scheduler çš„ scheduleOne ä½œä¸ºä¸»å¾ªç¯å¤„ç†å‡½æ•°ï¼Œå½“æ²¡æœ‰ä¸º pod æ‰¾åˆ°åˆé€‚ node æ—¶ï¼Œä¼šè°ƒç”¨ FailureHandler æ–¹æ³•. FailureHandler() æ˜¯ç”± handleSchedulingFailure() æ–¹æ³•å®ç°. è¯¥é€»è¾‘çš„å®ç°ç®€å•è¯´å°±æ˜¯æŠŠå¤±è´¥çš„ pod æ‰”åˆ° podBackoffQ é˜Ÿåˆ—æˆ–è€… unschedulablePods é›†åˆé‡Œ. func (sched *Scheduler) handleSchedulingFailure(ctx context.Context, fwk framework.Framework, podInfo *framework.QueuedPodInfo, err error, reason string, nominatingInfo *framework.NominatingInfo, start time.Time) { podLister := fwk.SharedInformerFactory().Core().V1().Pods().Lister() cachedPod, e := podLister.Pods(pod.Namespace).Get(pod.Name) if e != nil { } else { if len(cachedPod.Spec.NodeName) != 0 { klog.InfoS(\"Pod has been assigned to node. Abort adding it back to queue.\", \"pod\", klog.KObj(pod), \"node\", cachedPod.Spec.NodeName) } else { podInfo.PodInfo, _ = framework.NewPodInfo(cachedPod.DeepCopy()) // é‡æ–°å…¥é˜Ÿåˆ— if err := sched.SchedulingQueue.AddUnschedulableIfNotPresent(podInfo, sched.SchedulingQueue.SchedulingCycle()); err != nil { klog.ErrorS(err, \"Error occurred\") } } } ... } func (p *PriorityQueue) AddUnschedulableIfNotPresent(pInfo *framework.QueuedPodInfo, podSchedulingCycle int64) error { pod := pInfo.Pod // å»é‡åˆ¤æ–­ if _, exists, _ := p.activeQ.Get(pInfo); exists { return fmt.Errorf(\"Pod %v is already present in the active queue\", klog.KObj(pod)) } // å»é‡åˆ¤æ–­ if _, exists, _ := p.podBackoffQ.Get(pInfo); exists { return fmt.Errorf(\"Pod %v is already present in the backoff queue\", klog.KObj(pod)) } // æŠŠæ²¡æœ‰è°ƒåº¦æˆåŠŸçš„ podInfo æ‰”åˆ° backoffQ é˜Ÿåˆ—æˆ–è€… unschedulablePods é›†åˆä¸­. if p.moveRequestCycle \u003e= podSchedulingCycle { if err := p.podBackoffQ.Add(pInfo); err != nil { return fmt.Errorf(\"error adding pod %v to the backoff queue: %v\", klog.KObj(pod), err) } } else { p.unschedulablePods.addOrUpdate(pInfo) } return nil } scheduler queue åœ¨å¯åŠ¨æ—¶ä¼šå¼€å¯ä¸¤ä¸ªå¸¸é©»çš„åç¨‹. ä¸€ä¸ªåç¨‹æ¥ç®¡ç† flushBackoffQCompleted()ï¼Œæ¯éš”ä¸€ç§’æ¥è°ƒç”¨ä¸€æ¬¡. å¦ä¸€ä¸ªåç¨‹æ¥ç®¡ç† flushUnschedulablePodsLeftover, æ¯éš”ä¸‰åç§’æ¥è°ƒç”¨ä¸€æ¬¡. // Run starts the goroutine to pump from podBackoffQ to activeQ func (p *PriorityQueue) Run() { go wait.Until(p.flushBackoffQCompleted, 1.0*time.Second, p.stop) go wait.Until(p.flushUnschedulablePodsLeftover, 30*time.Second, p.stop) } flushBackoffQCompleted ä» podBackoffQ è·å– podInfo, ç„¶åæ‰”åˆ° activeQ é‡Œï¼Œç­‰å¾… scheduleOne æ¥è°ƒåº¦å¤„ç†. func (p *PriorityQueue) flushBackoffQCompleted() { activated := false for { rawPodInfo := p.podBackoffQ.Peek() pInfo := rawPodInfo.(*framework.QueuedPodInfo) pod := pInfo.Pod // ä» podBackoffQ ä¸­è·å–ä¸Šæ¬¡è°ƒåº¦å¤±è´¥çš„ podInfo. _, err := p.podBackoffQ.Pop() if err != nil { klog.ErrorS(err, \"Unable to pop pod from backoff queue despite backoff completion\", \"pod\", klog.KObj(pod)) break } // ç„¶åæŠŠè¿™ podInfo å†æ‰”åˆ° activeQ é‡Œï¼Œè®© scheduleOne ä¸»å¾ªç¯æ¥å¤„ç†. if added, _ := p.addToActiveQ(pInfo); added { klog.V(5).InfoS(\"Pod moved to an internal scheduling queue\", \"pod\", klog.KObj(pod), \"event\", BackoffComplete, \"queue\", activeQName) activated = true } } // å¦‚æœæœ‰æ·»åŠ æˆåŠŸçš„ï¼Œåˆ™æ¿€æ´»æ¡ä»¶å˜é‡. if activated { p.cond.Broadcast() } } flushUnschedulablePodsLeftover åŠ é”éå† PodInfoMap, å¦‚æœæŸä¸ª pod çš„è·ç¦»ä¸Šæ¬¡çš„è°ƒåº¦æ—¶é—´å¤§äº60s, åˆ™æ‰”åˆ°ä¸¤ä¸ªé˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªï¼Œå¦åˆ™ç­‰å¾…ä¸‹ä¸ª 30s å†æ¥å¤„ç†. func (p *PriorityQueue) flushUnschedulablePodsLeftover() { p.lock.Lock() defer p.lock.Unlock() var podsToMove []*framework.QueuedPodInfo for _, pInfo := range p.unschedulablePods.podInfoMap { lastScheduleTime := pInfo.Timestamp if currentTime.Sub(lastScheduleTime) \u003e p.podMaxInUnschedulablePodsDuration { podsToMove = append(podsToMove, pInfo) } } if len(podsToMove) \u003e 0 { // æŠŠ podInfo æ‰”åˆ° activeQ å’Œ backoffQ é˜Ÿåˆ—ä¸­. p.movePodsToActiveOrBackoffQueue(podsToMove, UnschedulableTimeout) } } func (p *PriorityQueue) movePodsToActiveOrBackoffQueue(podInfoList []*framework.QueuedPodInfo, event framework.ClusterEvent) { activated := false for _, pInfo := range podInfoList { pod := pInfo.Pod if p.isPodBackingoff(pInfo) { // å¦‚æœè¿˜éœ€è¦ backoff é€€é¿, åˆ™æ‰”åˆ° podBackoffQ é˜Ÿåˆ—ä¸­è¿›è¡Œå»¶è¿Ÿ, åé¢ç”± flushBackoffQCompleted å¤„ç†. if err := p.podBackoffQ.Add(pInfo); err != nil { } else { p.unschedulablePods.delete(pod, pInfo.Gated) } } else { // æŠŠ podInfo æ‰”åˆ° activeQ é‡Œ, ç­‰å¾… scheduleOne è°ƒåº¦å¤„ç†. if added, _ := p.addToActiveQ(pInfo); added { activated = true ","date":"2023-04-18","objectID":"/posts/a3f5fa/:6:5","tags":["kubernetes","æºç ","è½¬è½½"],"title":"æºç åˆ†æ kubernetes scheduler æ ¸å¿ƒè°ƒåº¦å™¨çš„å®ç°åŸç†","uri":"/posts/a3f5fa/"},{"categories":["kubernetes"],"content":"bindingCycle å®ç° pod å’Œ node ç»‘å®š bindingCycle ç”¨æ¥å®ç° pod å’Œ node ç»‘å®š, å…¶è¿‡ç¨‹ä¸º prebind -\u003e bind -\u003e postbind. func (sched *Scheduler) bindingCycle( ... { assumedPod := assumedPodInfo.Pod // æ‰§è¡Œæ’ä»¶çš„ prebind é€»è¾‘ if status := fwk.RunPreBindPlugins(ctx, state, assumedPod, scheduleResult.SuggestedHost); !status.IsSuccess() { return status } // æ‰§è¡Œ bind æ’ä»¶é€»è¾‘ if status := sched.bind(ctx, fwk, assumedPod, scheduleResult.SuggestedHost, state); !status.IsSuccess() { return status } // åœ¨ bind ç»‘å®šåæ‰§è¡Œæ”¶å°¾æ“ä½œ fwk.RunPostBindPlugins(ctx, state, assumedPod, scheduleResult.SuggestedHost) return nil } func (sched *Scheduler) bind(ctx context.Context, fwk framework.Framework, assumed *v1.Pod, targetNode string, state *framework.CycleState) (status *framework.Status) { defer func() { sched.finishBinding(fwk, assumed, targetNode, status) }() bound, err := sched.extendersBinding(assumed, targetNode) if bound { return framework.AsStatus(err) } return fwk.RunBindPlugins(ctx, state, assumed, targetNode) } func (sched *Scheduler) extendersBinding(pod *v1.Pod, node string) (bool, error) { for _, extender := range sched.Extenders { if !extender.IsBinder() || !extender.IsInterested(pod) { continue } return true, extender.Bind(\u0026v1.Binding{ ObjectMeta: metav1.ObjectMeta{Namespace: pod.Namespace, Name: pod.Name, UID: pod.UID}, Target: v1.ObjectReference{Kind: \"Node\", Name: node}, }) } return false, nil } extender é»˜è®¤å°±åªæœ‰ DefaultBinder æ’ä»¶, è¯¥æ’ä»¶çš„ bind é€»è¾‘æ˜¯é€šè¿‡ clientset å¯¹ pod è¿›è¡Œ node ç»‘å®š.. ä»£ç ä½ç½®: pkg/scheduler/framework/plugins/defaultbinder/default_binder.go func (b DefaultBinder) Bind(ctx context.Context, state *framework.CycleState, p *v1.Pod, nodeName string) *framework.Status { binding := \u0026v1.Binding{ ObjectMeta: metav1.ObjectMeta{Namespace: p.Namespace, Name: p.Name, UID: p.UID}, Target: v1.ObjectReference{Kind: \"Node\", Name: nodeName}, } err := b.handle.ClientSet().CoreV1().Pods(binding.Namespace).Bind(ctx, binding, metav1.CreateOptions{}) if err != nil { return framework.AsStatus(err) } return nil } ","date":"2023-04-18","objectID":"/posts/a3f5fa/:7:0","tags":["kubernetes","æºç ","è½¬è½½"],"title":"æºç åˆ†æ kubernetes scheduler æ ¸å¿ƒè°ƒåº¦å™¨çš„å®ç°åŸç†","uri":"/posts/a3f5fa/"},{"categories":["kubernetes"],"content":"framework çš„å®ç°åŸç† k8s scheduler è®¾è®¡äº†ä¸€å¥— framework ä½œä¸ºè°ƒåº¦å™¨çš„æ’ä»¶ç³»ç»Ÿ. å¦å¤–åœ¨ k8s ä¸­å†…ç½®äº†ä¸€æ³¢æ’ä»¶, æ’ä»¶æ˜¯å¯ä»¥åœ¨å¤šä¸ªæ‰©å±•ç‚¹å¤„è¿›è¡Œæ³¨å†Œ. å½“è°ƒåº¦å™¨åœ¨å¯åŠ¨æ—¶ä¼šåŠ è½½æ³¨å†Œæ’ä»¶åˆ° registry, å½“ pod éœ€è¦åˆ›å»ºæ—¶, scheduler é€šè¿‡æ’ä»¶ç³»ç»Ÿè¿‡æ»¤å‡ºé€‚åˆçš„èŠ‚ç‚¹é›†åˆ, ç„¶ååœ¨é€šè¿‡å®ç° socre æ‰“åˆ†çš„æ’ä»¶é€‰å‡ºåˆ†å€¼æœ€é«˜çš„èŠ‚ç‚¹. ","date":"2023-04-18","objectID":"/posts/a3f5fa/:8:0","tags":["kubernetes","æºç ","è½¬è½½"],"title":"æºç åˆ†æ kubernetes scheduler æ ¸å¿ƒè°ƒåº¦å™¨çš„å®ç°åŸç†","uri":"/posts/a3f5fa/"},{"categories":["kubernetes"],"content":"framework å…³é”®æŒ‚è½½ç‚¹åˆ†æ PreFilter åœ¨è°ƒç”¨ Filter æ–¹æ³•å‰, æ‰§è¡Œ PreFilter é¢„ç­›é€‰é€»è¾‘. æ’ä»¶ä¼šæ£€æµ‹é›†ç¾¤å’Œ pod æ˜¯å¦æ»¡è¶³å®šä¹‰çš„æ¡ä»¶. å½“ä¸æ»¡è¶³æ—¶è¿”å›é”™è¯¯, åˆ™åœæ­¢è°ƒåº¦å‘¨æœŸ. Filter è¿™äº›æ’ä»¶ç”¨äºè¿‡æ»¤å‡ºä¸èƒ½è¿è¡Œè¯¥ Pod çš„èŠ‚ç‚¹. PostFilter è¿™äº›æ’ä»¶åœ¨ Filter é˜¶æ®µåè°ƒç”¨, ä½†ä»…åœ¨è¯¥ Pod æ²¡æœ‰å¯è¡Œçš„èŠ‚ç‚¹æ—¶è°ƒç”¨. PreScore æ’ä»¶åœ¨æ‰§è¡Œ Score æ‰“åˆ†å‰, å¯ä»¥å…ˆè¿›è¡Œ PreScore å‰ç½®è¯„åˆ†å·¥ä½œ. Score å¯¹é€šè¿‡é¢„é€‰é˜¶æ®µçš„èŠ‚ç‚¹é›†åˆè¿›è¡Œæ‰“åˆ†. ","date":"2023-04-18","objectID":"/posts/a3f5fa/:8:1","tags":["kubernetes","æºç ","è½¬è½½"],"title":"æºç åˆ†æ kubernetes scheduler æ ¸å¿ƒè°ƒåº¦å™¨çš„å®ç°åŸç†","uri":"/posts/a3f5fa/"},{"categories":["kubernetes"],"content":"scheduler å†…ç½®æ’ä»¶çš„å®ç°åŸç† k8s scheduler å†…ç½®äº†ä¸å°‘æ’ä»¶, ä¸‹é¢æ˜¯å†…ç½®çš„æ’ä»¶. func getDefaultPlugins() *v1beta3.Plugins { plugins := \u0026v1beta3.Plugins{ MultiPoint: v1beta3.PluginSet{ Enabled: []v1beta3.Plugin{ {Name: names.PrioritySort}, {Name: names.NodeUnschedulable}, {Name: names.NodeName}, {Name: names.TaintToleration, Weight: pointer.Int32(3)}, {Name: names.NodeAffinity, Weight: pointer.Int32(2)}, {Name: names.NodePorts}, {Name: names.NodeResourcesFit, Weight: pointer.Int32(1)}, {Name: names.VolumeRestrictions}, {Name: names.EBSLimits}, {Name: names.GCEPDLimits}, {Name: names.NodeVolumeLimits}, {Name: names.AzureDiskLimits}, {Name: names.VolumeBinding}, {Name: names.VolumeZone}, {Name: names.PodTopologySpread, Weight: pointer.Int32(2)}, {Name: names.InterPodAffinity, Weight: pointer.Int32(2)}, {Name: names.DefaultPreemption}, {Name: names.NodeResourcesBalancedAllocation, Weight: pointer.Int32(1)}, {Name: names.ImageLocality, Weight: pointer.Int32(1)}, {Name: names.DefaultBinder}, }, }, } ... return plugins } è¿™é‡Œé€‰æ‹© NodeName, ImageLocality, NodeResourcesFit å’Œ NodeAffinity æ’ä»¶æ¥åˆ†æçš„æ’ä»¶å®ç°åŸç†. ","date":"2023-04-18","objectID":"/posts/a3f5fa/:9:0","tags":["kubernetes","æºç ","è½¬è½½"],"title":"æºç åˆ†æ kubernetes scheduler æ ¸å¿ƒè°ƒåº¦å™¨çš„å®ç°åŸç†","uri":"/posts/a3f5fa/"},{"categories":["kubernetes"],"content":"NodeName æ’ä»¶çš„å®ç°åŸç† NodeName æ’ä»¶æ˜¯ä¸€ä¸ªé¢„é€‰æ’ä»¶, æ’ä»¶å®ç°äº† Filter æ–¹æ³•, ç­›é€‰å‡ºè·Ÿ pod ç›¸åŒ nodeName çš„ node èŠ‚ç‚¹å¯¹è±¡. æºç ä½ç½®: pkg/scheduler/framework/plugins/nodename/node_name.go type NodeName struct{} var _ framework.FilterPlugin = \u0026NodeName{} const ( Name = names.NodeName ErrReason = \"node(s) didn't match the requested node name\" ) func (pl *NodeName) Name() string { return Name } func (pl *NodeName) Filter(ctx context.Context, _ *framework.CycleState, pod *v1.Pod, nodeInfo *framework.NodeInfo) *framework.Status { if nodeInfo.Node() == nil { return framework.NewStatus(framework.Error, \"node not found\") } if !Fits(pod, nodeInfo) { return framework.NewStatus(framework.UnschedulableAndUnresolvable, ErrReason) } return nil } func Fits(pod *v1.Pod, nodeInfo *framework.NodeInfo) bool { // è¿‡æ»¤èŠ‚ç‚¹, å½“è¿”å› true, è¯¥èŠ‚ç‚¹é€šè¿‡äº†åˆé€‰. // å½“ pod æ²¡æœ‰æŒ‡å®š nodeName æˆ–è€… pod æŒ‡å®šçš„ nodeName è·Ÿä¼ å…¥çš„ node åå­—ä¸€è‡´åˆ™è¿”å› true. return len(pod.Spec.NodeName) == 0 || pod.Spec.NodeName == nodeInfo.Node().Name } ... ","date":"2023-04-18","objectID":"/posts/a3f5fa/:9:1","tags":["kubernetes","æºç ","è½¬è½½"],"title":"æºç åˆ†æ kubernetes scheduler æ ¸å¿ƒè°ƒåº¦å™¨çš„å®ç°åŸç†","uri":"/posts/a3f5fa/"},{"categories":["kubernetes"],"content":"ImageLocality æ’ä»¶çš„å®ç°åŸç† ImageLocality æ’ä»¶å®ç°äº† Score åˆ†æ”¯è®¡ç®—æ¥å£, è¯¥æ’ä»¶ä¼šè®¡ç®— pod å…³è”çš„å®¹å™¨çš„é•œåƒåœ¨ node ä¸Šçš„çŠ¶æ€, ç»è¿‡å„ç§æ ¡éªŒå’Œå…¬å¼è®¡ç®—åå¾—å‡ºä¸€ä¸ª score åˆ†å€¼. è‡³äº ImageLocality æ’ä»¶å¦‚ä½•è®¡ç®— score åˆ†å€¼ä»£ç é‡Œå†™æ¸…æ¥šäº†, ä½†è‡³äºä¸ºä»€ä¹ˆè¦è¿™ä¹ˆè®¡ç®—å°±çœ‹ä¸æ˜ç™½äº†. æºç ä½ç½®: pkg/scheduler/framework/plugins/imagelocality/image_locality.go type ImageLocality struct { handle framework.Handle } var _ framework.ScorePlugin = \u0026ImageLocality{} const Name = names.ImageLocality ... func (pl *ImageLocality) Score(ctx context.Context, state *framework.CycleState, pod *v1.Pod, nodeName string) (int64, *framework.Status) { // é€šè¿‡ nodeName è·å– nodeInfo å¯¹è±¡ nodeInfo, err := pl.handle.SnapshotSharedLister().NodeInfos().Get(nodeName) if err != nil { return 0, framework.AsStatus(fmt.Errorf(\"getting node %q from Snapshot: %w\", nodeName, err)) } // è·å–ä¸»æœºåˆ—è¡¨ nodeInfos, err := pl.handle.SnapshotSharedLister().NodeInfos().List() if err != nil { return 0, framework.AsStatus(err) } // å½“å‰æœ‰å¤šå°‘ node totalNumNodes := len(nodeInfos) // ç»è¿‡ä¸€å †è¡¨è¾¾å¼è®¡ç®—å‡º node å¯¹åº”çš„ score åˆ†æ”¯ score := calculatePriority(sumImageScores(nodeInfo, pod.Spec.Containers, totalNumNodes), len(pod.Spec.Containers)) return score, nil } // æ ¹æ® node å½“å‰é•œåƒçš„çŠ¶æ€è®¡ç®—åˆ†å€¼. func calculatePriority(sumScores int64, numContainers int) int64 { maxThreshold := maxContainerThreshold * int64(numContainers) if sumScores \u003c minThreshold { sumScores = minThreshold } else if sumScores \u003e maxThreshold { sumScores = maxThreshold } return int64(framework.MaxNodeScore) * (sumScores - minThreshold) / (maxThreshold - minThreshold) } // éå† pod é‡Œçš„æ‰€æœ‰å®¹å™¨, å½“å®¹å™¨å¯¹åº”çš„é•œåƒåœ¨ node ä¸­, åˆ™ç´¯åŠ è®¡ç®—åˆ†å€¼ score. func sumImageScores(nodeInfo *framework.NodeInfo, containers []v1.Container, totalNumNodes int) int64 { var sum int64 for _, container := range containers { // è·å–å®¹å™¨çš„æ™¯è±¡åœ¨ node çš„çŠ¶æ€ if state, ok := nodeInfo.ImageStates[normalizedImageName(container.Image)]; ok { sum += scaledImageScore(state, totalNumNodes) } } return sum } ","date":"2023-04-18","objectID":"/posts/a3f5fa/:9:2","tags":["kubernetes","æºç ","è½¬è½½"],"title":"æºç åˆ†æ kubernetes scheduler æ ¸å¿ƒè°ƒåº¦å™¨çš„å®ç°åŸç†","uri":"/posts/a3f5fa/"},{"categories":["kubernetes"],"content":"NodeResourcesFit æ’ä»¶çš„å®ç°åŸç† NodeResourcesFit æ’ä»¶å®ç°äº†ä¸‰ä¸ª framework æ’ä»¶æ¥å£, åˆ†åˆ«æ˜¯ PreFilterPlugin, FilterPlugin, ScorePlugin æ¥å£. PreFilterPlugin åªæ˜¯åœ¨ state ç¼“å­˜é‡Œè®°å½• pod è¦æ±‚çš„ request èµ„æº. FilterPlugin ä¸»è¦ç”¨æ¥è¿‡æ»¤æ‰ä¸ç¬¦åˆèµ„æºè¦æ±‚çš„ node èŠ‚ç‚¹, å¦‚æœå½“å‰ node å¯ç”³è¯·çš„ cpu å’Œ mem ä¸æ»¡è¶³ pod éœ€æ±‚, åˆ™ node èŠ‚ç‚¹ä¼šè¢«è¿‡æ»¤æ‰. ScorePlugin ä¸»è¦å¯¹ç¬¦åˆè¦æ±‚é€šè¿‡é¢„é€‰çš„ node é›†åˆè¿›è¡Œæ‰“åˆ†, ç”¨ä»¥å¾—åˆ°æœ€ä¼˜çš„ node èŠ‚ç‚¹, å…¶å®å°±æ˜¯ cpu/mem èµ„æºæœ€å……è¶³æœ€ç©ºé—²çš„ node èŠ‚ç‚¹. ä»£ç ä½ç½®: pkg/scheduler/framework/plugins/noderesources/fit.go var _ framework.PreFilterPlugin = \u0026Fit{} var _ framework.FilterPlugin = \u0026Fit{} var _ framework.ScorePlugin = \u0026Fit{} ... // ç”¨æ¥åœ¨ cycleState é‡Œè®°å½• pod æ‰€éœ€çš„ request èµ„æº func (f *Fit) PreFilter(ctx context.Context, cycleState *framework.CycleState, pod *v1.Pod) (*framework.PreFilterResult, *framework.Status) { cycleState.Write(preFilterStateKey, computePodResourceRequest(pod)) return nil, nil } // è¿‡æ»¤æ‰ä¸ç¬¦åˆ resource request èµ„æºçš„ node. func (f *Fit) Filter(ctx context.Context, cycleState *framework.CycleState, pod *v1.Pod, nodeInfo *framework.NodeInfo) *framework.Status { // è·å–åœ¨ preFilter é˜¶æ®µå†™å…¥çš„ preFilterState s, err := getPreFilterState(cycleState) if err != nil { return framework.AsStatus(err) } // åˆ¤æ–­å½“å‰çš„ node æ˜¯å¦æ»¡è¶³ pod çš„èµ„æºè¯·æ±‚éœ€æ±‚ insufficientResources := fitsRequest(s, nodeInfo, f.ignoredResources, f.ignoredResourceGroups) // å¦‚æœä¸ä¸ºç©ºåˆ™æœ‰å¼‚å¸¸, æŠŠæ‰€æœ‰çš„å¼‚å¸¸åˆå¹¶åœ¨ä¸€èµ·, æ„å»º framework status å¯¹è±¡å†è¿”å›. if len(insufficientResources) != 0 { // We will keep all failure reasons. failureReasons := make([]string, 0, len(insufficientResources)) for i := range insufficientResources { failureReasons = append(failureReasons, insufficientResources[i].Reason) } return framework.NewStatus(framework.Unschedulable, failureReasons...) } // è¿”å› nil, è¯´æ˜è¯¥èŠ‚ç‚¹ç¬¦åˆèµ„æºè¦æ±‚ return nil } // åˆ¤æ–­å½“å‰ node æ˜¯å¦æ»¡è¶³ pod çš„èµ„æºè¦æ±‚ func fitsRequest(podRequest *preFilterState, nodeInfo *framework.NodeInfo, ignoredExtendedResources, ignoredResourceGroups sets.String) []InsufficientResource { insufficientResources := make([]InsufficientResource, 0, 4) allowedPodNumber := nodeInfo.Allocatable.AllowedPodNumber // å¦‚æœå½“å‰ node pods æ•°è¶…è¿‡äº†æœ€å¤§ pods æ•°, åˆ™ append. if len(nodeInfo.Pods)+1 \u003e allowedPodNumber { insufficientResources = append(insufficientResources, InsufficientResource{ ResourceName: v1.ResourcePods, Reason: \"Too many pods\", Requested: 1, Used: int64(len(nodeInfo.Pods)), Capacity: int64(allowedPodNumber), }) } // å¦‚æœæ²¡æœ‰ pod æ²¡æœ‰ resource request é…ç½®, å¯ç›´æ¥è¿”å› if podRequest.MilliCPU == 0 \u0026\u0026 podRequest.Memory == 0 \u0026\u0026 podRequest.EphemeralStorage == 0 \u0026\u0026 len(podRequest.ScalarResources) == 0 { return insufficientResources } // å¦‚æœå½“å‰ node ç©ºé—² cpu èµ„æºä¸è¶³ä»¥è¿è¡Œ pod, åˆ™ append å¼‚å¸¸. // å½“å‰çš„ cpu èµ„æºæ˜¯æŒ‰ç…§ request æ¥è®¡ç®—çš„, è€Œä¸æ˜¯ metrics å®æ—¶çš„. if podRequest.MilliCPU \u003e (nodeInfo.Allocatable.MilliCPU - nodeInfo.Requested.MilliCPU) { insufficientResources = append(insufficientResources, InsufficientResource{ ResourceName: v1.ResourceCPU, Reason: \"Insufficient cpu\", Requested: podRequest.MilliCPU, Used: nodeInfo.Requested.MilliCPU, Capacity: nodeInfo.Allocatable.MilliCPU, }) } // å¦‚æœå½“å‰ node ç©ºé—²çš„å†…å­˜ä¸æ»¡è¶³ pod çš„è¦æ±‚, åˆ™ append å¼‚å¸¸ if podRequest.Memory \u003e (nodeInfo.Allocatable.Memory - nodeInfo.Requested.Memory) { insufficientResources = append(insufficientResources, InsufficientResource{ ResourceName: v1.ResourceMemory, Reason: \"Insufficient memory\", Requested: podRequest.Memory, Used: nodeInfo.Requested.Memory, Capacity: nodeInfo.Allocatable.Memory, }) } // å¦‚æœå½“å‰ node çš„å­˜å‚¨ç©ºé—´ä¸å¤Ÿ pod çš„è¦æ±‚, åˆ™è¿”å›é”™è¯¯. if podRequest.EphemeralStorage \u003e (nodeInfo.Allocatable.EphemeralStorage - nodeInfo.Requested.EphemeralStorage) { insufficientResources = append(insufficientResources, InsufficientResource{ ResourceName: v1.ResourceEphemeralStorage, Reason: \"Insufficient ephemeral-storage\", Requested: podRequest.EphemeralStorage, Used: nodeInfo.Requested.EphemeralStorage, Capacity: nodeInfo.Allocatable.EphemeralStorage, }) } // è¿™ä¸ªæ˜¯ pod å¯¹æ‰©å±•èµ„æºçš„è¦æ±‚, å½“èŠ‚ç‚¹ä¸æ»¡è¶³å…¶è¦æ±‚æ—¶, append è¿½åŠ å¼‚å¸¸. for rName, rQuant := range podRequest.ScalarResources { ... if v1helper.IsExtendedResourceName(rName) { var rNamePrefix string if ignoredResourceGroups.Len() \u003e 0 { rNamePrefix = strings.Split(string(rName), \"/\")[0] } if ignoredExtendedResources.","date":"2023-04-18","objectID":"/posts/a3f5fa/:9:3","tags":["kubernetes","æºç ","è½¬è½½"],"title":"æºç åˆ†æ kubernetes scheduler æ ¸å¿ƒè°ƒåº¦å™¨çš„å®ç°åŸç†","uri":"/posts/a3f5fa/"},{"categories":["kubernetes"],"content":"NodeAffinity èŠ‚ç‚¹äº²å’Œæ€§æ’ä»¶åŸç† NodeAffinity æ˜¯å®ç°èŠ‚ç‚¹äº²å’Œæ€§çš„æ’ä»¶, ä¸»è¦å®ç°äº† PreFilter, Filter å’Œ PreScore, Score å››ä¸ªæ–¹æ³•. PreFilter å’Œ PreScore åœ¨ NodeAffinity æ’ä»¶é‡Œåš state ä¼ é€’, è¿™é‡Œé‡ç‚¹åˆ†æ Filter å’Œ Score æ–¹æ³•å®ç°. Filter ç”¨æ¥åˆ¤æ–­ä¼ å…¥çš„ node æ˜¯å¦åŒ¹é… pod çš„ RequiredDuringSchedulingIgnoredDuringExecution ç¡¬äº²å’Œé…ç½®, ä¸é€‚é…åˆ™è¿”å›å¼‚å¸¸. Score ç”¨æ¥ç»™ node æ‰“åˆ†, å¦‚æœèŠ‚ç‚¹ labels é€‚é… pod çš„ preferredDuringSchedulingIgnoredDuringExecution, åˆ™æŠŠ spec.nodeAffinity.weight ç´¯åŠ åˆ° score. é¦–å…ˆçœ‹ä¸‹ pod nodeAffinity èŠ‚ç‚¹äº²å’Œæ€§çš„ä¸¤ä¸ªå‚æ•°. RequiredDuringSchedulingIgnoredDuringExecution å‚æ•°è¡¨ç¤ºè°ƒåº¦å™¨åªä¼šè°ƒåº¦åˆ°ç¬¦åˆ pod è¦æ±‚çš„èŠ‚ç‚¹ä¸Š, æ²¡æœ‰ç¬¦åˆè¦æ±‚çš„èŠ‚ç‚¹åˆ™ä¸è¿›è¡Œè°ƒåº¦. preferredDuringSchedulingIgnoredDuringExecution å‚æ•°è¡¨ç¤ºè°ƒåº¦å™¨ä¼šä¼˜å…ˆå°è¯•å¯»æ‰¾æ»¡è¶³äº²å’Œæ€§è§„åˆ™çš„èŠ‚ç‚¹. å¦‚æœå®åœ¨æ‰¾ä¸åˆ°åŒ¹é…äº²å’Œæ€§çš„èŠ‚ç‚¹, è°ƒåº¦å™¨ä¼šé€‰æ‹©ä¸€ä¸ªåˆ†å€¼é«˜ä½†ä¸æ»¡è¶³ pod äº²å’Œæ€§è¦æ±‚çš„èŠ‚ç‚¹. ä¸‹é¢æ˜¯åŒ…å« pod çš„äº²å’Œæ€§çš„ pod é…ç½®æ–‡ä»¶, å¯å¯¹ç…§è¯¥é…ç½®æ¥ç†è§£ nodeAffinity æ’ä»¶çš„ Filter å’Œ Score çš„å®ç°. apiVersion: v1 kind: Pod metadata: name: test-xiaorui-cc spec: affinity: nodeAffinity: requiredDuringSchedulingIgnoredDuringExecution: nodeSelectorTerms: - matchExpressions: - key: kubernetes.io/os operator: In values: - linux preferredDuringSchedulingIgnoredDuringExecution: - weight: 50 preference: matchExpressions: - key: nodenames operator: In values: - xiaorui.cc containers: - name: with-node-affinity image: registry.k8s.io/pause:2.0 æºç ä½ç½®: pkg/scheduler/framework/plugins/nodeaffinity/node_affinity.go type NodeAffinity struct { handle framework.Handle addedNodeSelector *nodeaffinity.NodeSelector addedPrefSchedTerms *nodeaffinity.PreferredSchedulingTerms } var _ framework.FilterPlugin = \u0026NodeAffinity{} var _ framework.ScorePlugin = \u0026NodeAffinity{} ... // æ£€æŸ¥ä¼ å…¥çš„ node æ˜¯å¦åŒ¹é…è¯¥ pod çš„ nodeAffinity func (pl *NodeAffinity) Filter(ctx context.Context, state *framework.CycleState, pod *v1.Pod, nodeInfo *framework.NodeInfo) *framework.Status { node := nodeInfo.Node() // node å¯¹è±¡ä¸ºç©ºåˆ™è·³å‡º if node == nil { return framework.NewStatus(framework.Error, \"node not found\") } ... // è·å– prefilter é˜¶æ®µå†™å…¥çš„çŠ¶æ€, å…¶å®å°±æ˜¯ pod çš„ required é…ç½®. s, err := getPreFilterState(state) if err != nil { s = \u0026preFilterState{requiredNodeSelectorAndAffinity: nodeaffinity.GetRequiredNodeAffinity(pod)} } // åˆ¤æ–­ pod çš„ required è·Ÿ node æ˜¯å¦é€‚é… match, _ := s.requiredNodeSelectorAndAffinity.Match(node) if !match { // å¦‚ä¸é€‚é…ç›´æ¥é€€å‡º return framework.NewStatus(framework.UnschedulableAndUnresolvable, ErrReasonPod) } return nil } // è·Ÿ pod å’Œ node äº²å’Œæƒ…å†µè¿›è¡Œæ‰“åˆ† score func (pl *NodeAffinity) Score(ctx context.Context, state *framework.CycleState, pod *v1.Pod, nodeName string) (int64, *framework.Status) { ... node := nodeInfo.Node() var count int64 if pl.addedPrefSchedTerms != nil { count += pl.addedPrefSchedTerms.Score(node) } // è·å– prescore é˜¶æ®µå†™å…¥çš„ state s, err := getPreScoreState(state) if err != nil { // Fallback to calculate preferredNodeAffinity here when PreScore is disabled. preferredNodeAffinity, err := getPodPreferredNodeAffinity(pod) if err != nil { return 0, framework.AsStatus(err) } s = \u0026preScoreState{ preferredNodeAffinity: preferredNodeAffinity, } } // æ ¹æ® pod çš„ preferred å’Œ node labels çš„é€‚é…æƒ…å†µ, å¢åŠ  weight åˆ° score åˆ†å€¼. if s.preferredNodeAffinity != nil { count += s.preferredNodeAffinity.Score(node) } return count, nil } func (t *PreferredSchedulingTerms) Score(node *v1.Node) int64 { var score int64 nodeLabels := labels.Set(node.Labels) nodeFields := extractNodeFields(node) for _, term := range t.terms { // å¦‚æœ node åŒ¹é… pod preferred, åˆ™å¢åŠ å®šä¹‰çš„æƒé‡. if ok, _ := term.match(nodeLabels, nodeFields); ok { score += int64(term.weight) } } return score } ","date":"2023-04-18","objectID":"/posts/a3f5fa/:9:4","tags":["kubernetes","æºç ","è½¬è½½"],"title":"æºç åˆ†æ kubernetes scheduler æ ¸å¿ƒè°ƒåº¦å™¨çš„å®ç°åŸç†","uri":"/posts/a3f5fa/"},{"categories":["kubernetes"],"content":"æ€»ç»“ kubernetes scheduler ä» informer ç›‘å¬æ–°èµ„æºå˜åŠ¨, å½“æœ‰æ–° pod åˆ›å»ºæ—¶, scheduler éœ€è¦ä¸ºå…¶åˆ†é…ç»‘å®šä¸€ä¸ª node èŠ‚ç‚¹. åœ¨è°ƒåº¦ Pod æ—¶è¦ç»è¿‡ä¸¤ä¸ªé˜¶æ®µ, å³ è°ƒåº¦å‘¨æœŸ å’Œ ç»‘å®šå‘¨æœŸ. è°ƒåº¦å‘¨æœŸåˆ†ä¸ºé¢„é€‰é˜¶æ®µå’Œä¼˜é€‰é˜¶æ®µ. é¢„é€‰ (Predicates) æ˜¯é€šè¿‡æ’ä»¶çš„ Filter æ–¹æ³•è¿‡æ»¤å‡ºç¬¦åˆè¦æ±‚çš„ node èŠ‚ç‚¹ ä¼˜é€‰ (Priorities) åˆ™å¯¹é¢„é€‰å‡ºæ¥çš„ node èŠ‚ç‚¹è¿›è¡Œæ‰“åˆ†æ’åº ç»‘å®šå‘¨æœŸé»˜è®¤åªæœ‰ä¸€ä¸ªé»˜è®¤æ’ä»¶, ä»…ç»™ apiserver å‘èµ· node è·Ÿ pod ç»‘å®šçš„è¯·æ±‚. å‡ºå¤„: https://github.com/rfyiamcool/notes#kubernetes ","date":"2023-04-18","objectID":"/posts/a3f5fa/:10:0","tags":["kubernetes","æºç ","è½¬è½½"],"title":"æºç åˆ†æ kubernetes scheduler æ ¸å¿ƒè°ƒåº¦å™¨çš„å®ç°åŸç†","uri":"/posts/a3f5fa/"},{"categories":["istio","envoy"],"content":"Envoy åˆå§‹åŒ–é…ç½®æ–‡ä»¶ kubectl exec -ti productpage-v1-d4f8dfd97-p8xlb -c istio-proxy -- cat /etc/istio/proxy/envoy-rev.json é…ç½®æ–‡ä»¶ç»“æ„ ","date":"2023-03-28","objectID":"/posts/18798d/:0:0","tags":["istio","envoy"],"title":"æ·±å…¥Istioç³»åˆ— - Envoyé…ç½®åˆ†æ","uri":"/posts/18798d/"},{"categories":["istio","envoy"],"content":"Node åŒ…å«Envoyæ‰€åœ¨èŠ‚ç‚¹ç›¸å…³ä¿¡æ¯ id: sidecar~10.86.238.167~productpage-v1-d4f8dfd97-p8xlb.default~default.svc.cluster.local cluster: productpage.default locality: {} metadata: ANNOTATIONS: kubectl.kubernetes.io/default-container: productpage kubectl.kubernetes.io/default-logs-container: productpage kubernetes.io/config.seen: 2023-03-24T09:42:07.297289187+08:00 kubernetes.io/config.source: api prometheus.io/path: /stats/prometheus prometheus.io/port: \"15020\" prometheus.io/scrape: \"true\" sidecar.istio.io/status: '{\"initContainers\":[\"istio-init\"],\"containers\":[\"istio-proxy\"],\"volumes\":[\"workload-socket\",\"credential-socket\",\"workload-certs\",\"istio-envoy\",\"istio-data\",\"istio-podinfo\",\"istio-token\",\"istiod-ca-cert\"],\"imagePullSecrets\":null,\"revision\":\"default\"}' APP_CONTAINERS: productpage CLUSTER_ID: Kubernetes ENVOY_PROMETHEUS_PORT: 15090 ENVOY_STATUS_PORT: 15021 INSTANCE_IPS: 10.86.238.167 INTERCEPTION_MODE: REDIRECT ISTIO_PROXY_SHA: 6e6b45cd824e414453ac8f0c81be540269ddff3e ISTIO_VERSION: 1.17.1 LABELS: app: productpage security.istio.io/tlsMode: istio service.istio.io/canonical-name: productpage service.istio.io/canonical-revision: v1 version: v1 MESH_ID: cluster.local NAME: productpage-v1-d4f8dfd97-p8xlb NAMESPACE: default NODE_NAME: master OWNER: kubernetes://apis/apps/v1/namespaces/default/deployments/productpage-v1 PILOT_SAN: - istiod.istio-system.svc PLATFORM_METADATA: {} POD_PORTS: '[{\"containerPort\":9080,\"protocol\":\"TCP\"}]' PROXY_CONFIG: binaryPath: /usr/local/bin/envoy concurrency: 2 configPath: ./etc/istio/proxy controlPlaneAuthPolicy: MUTUAL_TLS discoveryAddress: istiod.istio-system.svc:15012 drainDuration: 45s proxyAdminPort: 15000 serviceCluster: istio-proxy statNameLength: 189 statusPort: 15020 terminationDrainDuration: 5s tracing: zipkin: address: zipkin.istio-system:9411 SERVICE_ACCOUNT: bookinfo-productpage WORKLOAD_NAME: productpage-v1 ","date":"2023-03-28","objectID":"/posts/18798d/:0:1","tags":["istio","envoy"],"title":"æ·±å…¥Istioç³»åˆ— - Envoyé…ç½®åˆ†æ","uri":"/posts/18798d/"},{"categories":["istio","envoy"],"content":"Admin é…ç½®Envoyçš„æ—¥å¿—è·¯å¾„ä»¥åŠç®¡ç†ç«¯å£ access_log: - name: envoy.access_loggers.file typed_config: \"@type\": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog path: /dev/null profile_path: /var/lib/istio/data/envoy.prof address: socket_address: address: 127.0.0.1 port_value: 15000 ","date":"2023-03-28","objectID":"/posts/18798d/:0:2","tags":["istio","envoy"],"title":"æ·±å…¥Istioç³»åˆ— - Envoyé…ç½®åˆ†æ","uri":"/posts/18798d/"},{"categories":["istio","envoy"],"content":"Dynamic_resources é…ç½®åŠ¨æ€èµ„æº,è¿™é‡Œé…ç½®äº† LDSã€CDS å’Œ ADS æœåŠ¡é…ç½® lds_config: ads: {} initial_fetch_timeout: 0s resource_api_version: V3 cds_config: ads: {} initial_fetch_timeout: 0s resource_api_version: V3 ads_config: api_type: GRPC set_node_on_first_message_only: true transport_api_version: V3 grpc_services: - envoy_grpc: cluster_name: xds-grpc ","date":"2023-03-28","objectID":"/posts/18798d/:0:3","tags":["istio","envoy"],"title":"æ·±å…¥Istioç³»åˆ— - Envoyé…ç½®åˆ†æ","uri":"/posts/18798d/"},{"categories":["istio","envoy"],"content":"Static_resources é…ç½®é™æ€èµ„æºï¼ŒåŒ…æ‹¬äº†prometheus_statsã€agentã€sds-grpcã€xds-grpc å’Œ zipkin äº”ä¸ªcluster, 15090å’Œ15021ä¸¤ä¸ªlistenerã€‚ prometheus_stats clusterå’Œ15090 listenerç”¨äºå¯¹å¤–æä¾›å…¼å®¹prometheusæ ¼å¼çš„ç»Ÿè®¡æŒ‡æ ‡ã€‚ agent sds-grpc cluster ç”¨äºè¯ä¹¦å‘ç°æœåŠ¡(SecretDiscoveryService) xds-grpc clusterå¯¹åº”å‰é¢dynamic_resourcesä¸­ADSé…ç½®ï¼ŒæŒ‡æ˜äº†Envoyç”¨äºè·å–åŠ¨æ€èµ„æºçš„æœåŠ¡å™¨åœ°å€ zipkin clusteråˆ™æ˜¯å¤–éƒ¨çš„zipkinè°ƒç”¨è·Ÿè¸ªæœåŠ¡å™¨åœ°å€ï¼ŒEnvoyä¼šå‘è¯¥åœ°å€ä¸ŠæŠ¥å…¼å®¹zipkinæ ¼å¼çš„è°ƒç”¨è·Ÿè¸ªä¿¡æ¯ã€‚ clusters: - name: prometheus_stats type: STATIC connect_timeout: 0.250s lb_policy: ROUND_ROBIN load_assignment: cluster_name: prometheus_stats endpoints: - lb_endpoints: - endpoint: address: socket_address: protocol: TCP address: 127.0.0.1 port_value: 15000 - name: agent type: STATIC connect_timeout: 0.250s lb_policy: ROUND_ROBIN load_assignment: cluster_name: agent endpoints: - lb_endpoints: - endpoint: address: socket_address: protocol: TCP address: 127.0.0.1 port_value: 15020 - name: sds-grpc type: STATIC typed_extension_protocol_options: envoy.extensions.upstreams.http.v3.HttpProtocolOptions: \"@type\": type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions explicit_http_config: http2_protocol_options: {} connect_timeout: 1s lb_policy: ROUND_ROBIN load_assignment: cluster_name: sds-grpc endpoints: - lb_endpoints: - endpoint: address: pipe: path: ./var/run/secrets/workload-spiffe-uds/socket - name: xds-grpc type: STATIC connect_timeout: 1s lb_policy: ROUND_ROBIN load_assignment: cluster_name: xds-grpc endpoints: - lb_endpoints: - endpoint: address: pipe: path: ./etc/istio/proxy/XDS circuit_breakers: thresholds: - priority: DEFAULT max_connections: 100000 max_pending_requests: 100000 max_requests: 100000 - priority: HIGH max_connections: 100000 max_pending_requests: 100000 max_requests: 100000 upstream_connection_options: tcp_keepalive: keepalive_time: 300 max_requests_per_connection: 1 typed_extension_protocol_options: envoy.extensions.upstreams.http.v3.HttpProtocolOptions: \"@type\": type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions explicit_http_config: http2_protocol_options: {} - name: zipkin type: STRICT_DNS respect_dns_ttl: true dns_lookup_family: V4_ONLY dns_refresh_rate: 30s connect_timeout: 1s lb_policy: ROUND_ROBIN load_assignment: cluster_name: zipkin endpoints: - lb_endpoints: - endpoint: address: socket_address: address: zipkin.istio-system port_value: 9411 listeners: - address: socket_address: protocol: TCP address: 0.0.0.0 port_value: 15090 filter_chains: - filters: - name: envoy.filters.network.http_connection_manager typed_config: \"@type\": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager codec_type: AUTO stat_prefix: stats route_config: virtual_hosts: - name: backend domains: - \"*\" routes: - match: prefix: /stats/prometheus route: cluster: prometheus_stats http_filters: - name: envoy.filters.http.router typed_config: \"@type\": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router - address: socket_address: protocol: TCP address: 0.0.0.0 port_value: 15021 filter_chains: - filters: - name: envoy.filters.network.http_connection_manager typed_config: \"@type\": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager codec_type: AUTO stat_prefix: agent route_config: virtual_hosts: - name: backend domains: - \"*\" routes: - match: prefix: /healthz/ready route: cluster: agent http_filters: - name: envoy.filters.http.router typed_config: \"@type\": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router ","date":"2023-03-28","objectID":"/posts/18798d/:0:4","tags":["istio","envoy"],"title":"æ·±å…¥Istioç³»åˆ— - Envoyé…ç½®åˆ†æ","uri":"/posts/18798d/"},{"categories":["istio","envoy"],"content":"Tracing é…ç½®åˆ†å¸ƒå¼é“¾è·¯è·Ÿè¸ªï¼Œè¿™é‡Œé…ç½®çš„åç«¯clusteræ˜¯å‰é¢static_resourcesé‡Œé¢å®šä¹‰çš„zipkin clusterã€‚ http: name: envoy.tracers.zipkin typed_config: \"@type\": type.googleapis.com/envoy.config.trace.v3.ZipkinConfig collector_cluster: zipkin collector_endpoint: /api/v2/spans collector_endpoint_version: HTTP_JSON trace_id_128bit: true shared_span_context: false Envoy é…ç½®åˆ†æ ä»Envoyåˆå§‹åŒ–é…ç½®æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¤§è‡´çœ‹åˆ°Istioé€šè¿‡Envoyæ¥å®ç°æœåŠ¡å‘ç°å’Œæµé‡ç®¡ç†çš„åŸºæœ¬åŸç†ã€‚å³æ§åˆ¶é¢å°†xDS serverä¿¡æ¯é€šè¿‡static resourceçš„æ–¹å¼é…ç½®åˆ°Envoyçš„åˆå§‹åŒ–é…ç½®æ–‡ä»¶ä¸­ï¼ŒEnvoyå¯åŠ¨åé€šè¿‡xDS serverè·å–åˆ°dynamic resourceï¼ŒåŒ…æ‹¬ç½‘æ ¼ä¸­çš„serviceä¿¡æ¯åŠè·¯ç”±è§„åˆ™ã€‚ Envoy é…ç½®åˆå§‹åŒ–æµç¨‹: Pilot-agentæ ¹æ®å¯åŠ¨å‚æ•°å’ŒK8S API Serverä¸­çš„é…ç½®ä¿¡æ¯ç”ŸæˆEnvoyçš„åˆå§‹é…ç½®æ–‡ä»¶envoy-rev.jsonï¼Œè¯¥æ–‡ä»¶å‘Šè¯‰Envoyä»xDS serverä¸­è·å–åŠ¨æ€é…ç½®ä¿¡æ¯ï¼Œå¹¶é…ç½®äº†xDS serverçš„åœ°å€ä¿¡æ¯ï¼Œå³æ§åˆ¶é¢çš„Pilotã€‚ Pilot-agentä½¿ç”¨envoy-rev.jsonå¯åŠ¨Envoyè¿›ç¨‹ã€‚ Envoyæ ¹æ®åˆå§‹é…ç½®è·å¾—Pilotåœ°å€ï¼Œé‡‡ç”¨xDSæ¥å£ä»Pilotè·å–åˆ°Listenerï¼ŒClusterï¼ŒRouteç­‰dåŠ¨æ€é…ç½®ä¿¡æ¯ã€‚ Envoyæ ¹æ®è·å–åˆ°çš„åŠ¨æ€é…ç½®å¯åŠ¨Listenerï¼Œå¹¶æ ¹æ®Listenerçš„é…ç½®ï¼Œç»“åˆRouteå’ŒClusterå¯¹æ‹¦æˆªåˆ°çš„æµé‡è¿›è¡Œå¤„ç† Envoyä¸­å®é™…ç”Ÿæ•ˆçš„é…ç½®æ˜¯ç”±åˆå§‹åŒ–é…ç½®æ–‡ä»¶ä¸­çš„é™æ€é…ç½®å’Œä»Pilotè·å–çš„åŠ¨æ€é…ç½®ä¸€èµ·ç»„æˆçš„ã€‚æ¥ä¸‹æ¥é€šè¿‡Envoyçš„ç®¡ç†æ¥å£æ¥è·å–Envoyçš„å®Œæ•´é…ç½®ã€‚ # kubectl exec -ti productpage-v1-d4f8dfd97-p8xlb -c istio-proxy -- curl localhost:15000/config_dump\u003e envoy-productpage-v1-d4f8dfd97-p8xlb.json root@master:~# wc -l envoy-productpage-v1-d4f8dfd97-p8xlb.json 11870 envoy-productpage-v1-d4f8dfd97-p8xlb.json é…ç½®æ–‡ä»¶å†…å®¹å¤ªé•¿ä¸Šä¼ åˆ°github envoy-productpage-v1-d4f8dfd97-p8xlb.yaml é…ç½®ç»“æ„ ","date":"2023-03-28","objectID":"/posts/18798d/:0:5","tags":["istio","envoy"],"title":"æ·±å…¥Istioç³»åˆ— - Envoyé…ç½®åˆ†æ","uri":"/posts/18798d/"},{"categories":["istio","envoy"],"content":"Bootstrap è¿™éƒ¨åˆ†æ˜¯Envoyçš„åˆå§‹åŒ–é…ç½®ï¼Œåœ¨ä¸Šé¢å·²ç»ä»‹ç»å°±ä¸åœ¨èµ˜è¿°ã€‚ ","date":"2023-03-28","objectID":"/posts/18798d/:1:0","tags":["istio","envoy"],"title":"æ·±å…¥Istioç³»åˆ— - Envoyé…ç½®åˆ†æ","uri":"/posts/18798d/"},{"categories":["istio","envoy"],"content":"Clusters åœ¨Envoyä¸­ï¼ŒClusteræ˜¯ä¸€ä¸ªæœåŠ¡é›†ç¾¤ï¼ŒClusterä¸­åŒ…å«ä¸€ä¸ªåˆ°å¤šä¸ªendpointï¼Œæ¯ä¸ªendpointéƒ½å¯ä»¥æä¾›æœåŠ¡ï¼ŒEnvoyæ ¹æ®è´Ÿè½½å‡è¡¡ç®—æ³•å°†è¯·æ±‚å‘é€åˆ°è¿™äº›endpointä¸­ã€‚ åœ¨Productpageçš„clustersé…ç½®ä¸­åŒ…å«static_clusterså’Œdynamic_active_clustersä¸¤éƒ¨åˆ†ï¼Œå…¶ä¸­static_clustersæ˜¯æ¥è‡ªäºenvoy-rev.jsonçš„åˆå§‹åŒ–é…ç½®ä¸­çš„ä¿¡æ¯ã€‚dynamic_active_clustersæ˜¯é€šè¿‡xDSæ¥å£ä»Istioæ§åˆ¶é¢è·å–çš„åŠ¨æ€æœåŠ¡ä¿¡æ¯ã€‚ ","date":"2023-03-28","objectID":"/posts/18798d/:2:0","tags":["istio","envoy"],"title":"æ·±å…¥Istioç³»åˆ— - Envoyé…ç½®åˆ†æ","uri":"/posts/18798d/"},{"categories":["istio","envoy"],"content":"Dynamic_active_clusters Dynamic Clusterä¸­æœ‰ä»¥ä¸‹å‡ ç±»Cluster Outbound Cluster Inbound Cluster BlackHoleCluster PassthroughCluster Outbound Cluster è¿™éƒ¨åˆ†çš„Clusterå äº†ç»å¤§å¤šæ•°ï¼Œè¯¥ç±»Clusterå¯¹åº”äºEnvoyæ‰€åœ¨èŠ‚ç‚¹çš„å¤–éƒ¨æœåŠ¡ã€‚ä»¥reviewsä¸ºä¾‹ï¼Œå¯¹äºProductpageæ¥è¯´,reviewsæ˜¯ä¸€ä¸ªå¤–éƒ¨æœåŠ¡ï¼Œå› æ­¤å…¶Clusteråç§°ä¸­åŒ…å«outboundå­—æ · # ./istioctl pc c -f envoy-productpage-v1-d4f8dfd97-p8xlb.json --direction outbound SERVICE FQDN PORT SUBSET DIRECTION TYPE DESTINATION RULE details.default.svc.cluster.local 9080 - outbound EDS details.default details.default.svc.cluster.local 9080 v1 outbound EDS details.default details.default.svc.cluster.local 9080 v2 outbound EDS details.default istio-egressgateway.istio-system.svc.cluster.local 80 - outbound EDS istio-egressgateway.istio-system.svc.cluster.local 443 - outbound EDS istio-ingressgateway.istio-system.svc.cluster.local 80 - outbound EDS istio-ingressgateway.istio-system.svc.cluster.local 443 - outbound EDS istio-ingressgateway.istio-system.svc.cluster.local 15021 - outbound EDS istio-ingressgateway.istio-system.svc.cluster.local 15443 - outbound EDS istio-ingressgateway.istio-system.svc.cluster.local 31400 - outbound EDS istiod.istio-system.svc.cluster.local 443 - outbound EDS istiod.istio-system.svc.cluster.local 15010 - outbound EDS istiod.istio-system.svc.cluster.local 15012 - outbound EDS istiod.istio-system.svc.cluster.local 15014 - outbound EDS kubernetes.default.svc.cluster.local 443 - outbound EDS productpage.default.svc.cluster.local 9080 - outbound EDS productpage.default productpage.default.svc.cluster.local 9080 v1 outbound EDS productpage.default ratings.default.svc.cluster.local 9080 - outbound EDS ratings.default ratings.default.svc.cluster.local 9080 v1 outbound EDS ratings.default ratings.default.svc.cluster.local 9080 v2 outbound EDS ratings.default ratings.default.svc.cluster.local 9080 v2-mysql outbound EDS ratings.default ratings.default.svc.cluster.local 9080 v2-mysql-vm outbound EDS ratings.default reviews.default.svc.cluster.local 9080 - outbound EDS ä»reviews æœåŠ¡å¯¹åº”çš„clusteré…ç½®ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå…¶ç±»å‹ä¸ºEDSï¼Œå³è¡¨ç¤ºè¯¥Clusterçš„endpointæ¥è‡ªäºåŠ¨æ€å‘ç°ï¼ŒåŠ¨æ€å‘ç°ä¸­eds_configåˆ™æŒ‡å‘äº†adsï¼Œæœ€ç»ˆæŒ‡å‘static Resourceä¸­é…ç½®çš„xds-grpc cluster,å³Pilotçš„åœ°å€ã€‚ ./istioctl pc c productpage-v1-d4f8dfd97-p8xlb.default --fqdn reviews.default.svc.cluster.local -o yaml - circuitBreakers: thresholds: - maxConnections: 4294967295 maxPendingRequests: 4294967295 maxRequests: 4294967295 maxRetries: 4294967295 trackRemaining: true commonLbConfig: localityWeightedLbConfig: {} connectTimeout: 10s edsClusterConfig: edsConfig: ads: {} initialFetchTimeout: 0s resourceApiVersion: V3 serviceName: outbound|9080||reviews.default.svc.cluster.local filters: - name: istio.metadata_exchange typedConfig: '@type': type.googleapis.com/envoy.tcp.metadataexchange.config.MetadataExchange protocol: istio-peer-exchange lbPolicy: LEAST_REQUEST metadata: filterMetadata: istio: default_original_port: 9080 services: - host: reviews.default.svc.cluster.local name: reviews namespace: default name: outbound|9080||reviews.default.svc.cluster.local transportSocketMatches: - match: tlsMode: istio name: tlsMode-istio transportSocket: name: envoy.transport_sockets.tls typedConfig: '@type': type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext commonTlsContext: alpnProtocols: - istio-peer-exchange - istio combinedValidationContext: defaultValidationContext: matchSubjectAltNames: - exact: spiffe://cluster.local/ns/default/sa/bookinfo-reviews validationContextSdsSecretConfig: name: ROOTCA sdsConfig: apiConfigSource: apiType: GRPC grpcServices: - envoyGrpc: clusterName: sds-grpc setNodeOnFirstMessageOnly: true transportApiVersion: V3 initialFetchTimeout: 0s resourceApiVersion: V3 tlsCertificateSdsSecretConfigs: - name: default sdsConfig: apiConfigSource: apiType: GRPC grpcServices: - envoyGrpc: clusterName: sds-grpc setNodeOnFirstMessageOnly: true transportApiVersion: V3 initialFetchTimeout: 0s resourceApiVersion: V3 tlsParams: tlsMaximumProtocolVersion: TLSv1_3 tlsMinimumProtocolVersion: TLSv1_2 sni: outbound_.9080_._.reviews.defaul","date":"2023-03-28","objectID":"/posts/18798d/:2:1","tags":["istio","envoy"],"title":"æ·±å…¥Istioç³»åˆ— - Envoyé…ç½®åˆ†æ","uri":"/posts/18798d/"},{"categories":["istio","envoy"],"content":"Listeners Envoyé‡‡ç”¨listeneræ¥æ¥æ”¶å¹¶å¤„ç†downstreamå‘è¿‡æ¥çš„è¯·æ±‚ï¼Œlisteneré‡‡ç”¨äº†æ’ä»¶å¼çš„æ¶æ„ï¼Œå¯ä»¥é€šè¿‡é…ç½®ä¸åŒçš„filteråœ¨Listenerä¸­æ’å…¥ä¸åŒçš„å¤„ç†é€»è¾‘ã€‚ Listenerå¯ä»¥ç»‘å®šåˆ°IP Socketæˆ–è€…Unix Domain Socketä¸Šï¼Œä»¥æ¥æ”¶æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚;ä¹Ÿå¯ä»¥ä¸ç»‘å®šï¼Œè€Œæ˜¯æ¥æ”¶ä»å…¶ä»–listenerè½¬å‘æ¥çš„æ•°æ®ã€‚Istioåˆ©ç”¨äº†Envoy listenerçš„è¿™ä¸€ç‰¹ç‚¹ï¼Œé€šè¿‡VirtualOutboundListeneråœ¨ä¸€ä¸ªç«¯å£æ¥æ”¶æ‰€æœ‰å‡ºå‘è¯·æ±‚ï¼Œç„¶åå†æŒ‰ç…§è¯·æ±‚çš„ç«¯å£åˆ†åˆ«è½¬å‘ç»™ä¸åŒçš„listeneråˆ†åˆ«å¤„ç†ã€‚ ","date":"2023-03-28","objectID":"/posts/18798d/:2:2","tags":["istio","envoy"],"title":"æ·±å…¥Istioç³»åˆ— - Envoyé…ç½®åˆ†æ","uri":"/posts/18798d/"},{"categories":["istio","envoy"],"content":"Routers é…ç½®Envoyçš„è·¯ç”±è§„åˆ™ã€‚Istioä¸‹å‘çš„ç¼ºçœè·¯ç”±è§„åˆ™ä¸­å¯¹æ¯ä¸ªç«¯å£è®¾ç½®äº†ä¸€ä¸ªè·¯ç”±è§„åˆ™ï¼Œæ ¹æ®hostæ¥å¯¹è¯·æ±‚è¿›è¡Œè·¯ç”±åˆ†å‘ ","date":"2023-03-28","objectID":"/posts/18798d/:2:3","tags":["istio","envoy"],"title":"æ·±å…¥Istioç³»åˆ— - Envoyé…ç½®åˆ†æ","uri":"/posts/18798d/"},{"categories":["istio","envoy"],"content":"Secrets ","date":"2023-03-28","objectID":"/posts/18798d/:2:4","tags":["istio","envoy"],"title":"æ·±å…¥Istioç³»åˆ— - Envoyé…ç½®åˆ†æ","uri":"/posts/18798d/"},{"categories":["istio","envoy"],"content":"å‚è€ƒèµ„æ–™ Envoyä¸­æ–‡æ–‡æ¡£ Istioæµé‡ç®¡ç†å®ç°æœºåˆ¶æ·±åº¦è§£æ Istio ä¸­çš„ Sidecar æ³¨å…¥ã€é€æ˜æµé‡åŠ«æŒåŠæµé‡è·¯ç”±è¿‡ç¨‹è¯¦è§£ ","date":"2023-03-28","objectID":"/posts/18798d/:3:0","tags":["istio","envoy"],"title":"æ·±å…¥Istioç³»åˆ— - Envoyé…ç½®åˆ†æ","uri":"/posts/18798d/"},{"categories":["istio"],"content":"å¼€å¯ Access æ—¥å¿— apiVersion: v1 kind: ConfigMap metadata: name: istio namespace: istio-system data: mesh: | accessLogEncoding: JSON accessLogFile: /dev/stdout accessLogFormat: \"\" ","date":"2023-03-17","objectID":"/posts/5a662f/:0:1","tags":["envoyfilter","access"],"title":"Istio Proxy Accessæ—¥å¿—","uri":"/posts/5a662f/"},{"categories":["istio"],"content":"æ ¼å¼åŒ– Access æ—¥å¿— { \"authority\": \"%REQ(:AUTHORITY)%\", \"bytes_received\": \"%BYTES_RECEIVED%\", \"bytes_sent\": \"%BYTES_SENT%\", \"downstream_local_address\": \"%DOWNSTREAM_LOCAL_ADDRESS%\", \"downstream_remote_address\": \"%DOWNSTREAM_REMOTE_ADDRESS%\", \"duration\": \"%DURATION%\", \"istio_policy_status\": \"%DYNAMIC_METADATA(istio.mixer:status)%\", \"method\": \"%REQ(:METHOD)%\", \"path\": \"%REQ(X-ENVOY-ORIGINAL-PATH?:PATH)%\", \"protocol\": \"%PROTOCOL%\", \"request_id\": \"%REQ(X-REQUEST-ID)%\", \"requested_server_name\": \"%REQUESTED_SERVER_NAME%\", \"response_code\": \"%RESPONSE_CODE%\", \"response_flags\": \"%RESPONSE_FLAGS%\", \"route_name\": \"%ROUTE_NAME%\", \"start_time\": \"%START_TIME%\", \"upstream_cluster\": \"%UPSTREAM_CLUSTER%\", \"upstream_host\": \"%UPSTREAM_HOST%\", \"upstream_local_address\": \"%UPSTREAM_LOCAL_ADDRESS%\", \"upstream_service_time\": \"%RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)%\", \"upstream_transport_failure_reason\": \"%UPSTREAM_TRANSPORT_FAILURE_REASON%\", \"user_agent\": \"%REQ(USER-AGENT)%\", \"x_forwarded_for\": \"%REQ(X-FORWARDED-FOR)%\" } ","date":"2023-03-17","objectID":"/posts/5a662f/:0:2","tags":["envoyfilter","access"],"title":"Istio Proxy Accessæ—¥å¿—","uri":"/posts/5a662f/"},{"categories":["istio"],"content":"è‡ªå®šä¹‰æ—¥å¿—æ–‡ä»¶è·¯å¾„ accessLogFile: /var/log/envoy/envoy.log ","date":"2023-03-17","objectID":"/posts/5a662f/:0:3","tags":["envoyfilter","access"],"title":"Istio Proxy Accessæ—¥å¿—","uri":"/posts/5a662f/"},{"categories":["istio"],"content":"å±€éƒ¨å¯ç”¨ ä¿®æ”¹ istio-sidecar-injector sidecar æ¨¡æ¿,æŒ‚è½½ä¸€ä¸ªä¸´æ—¶å· # kubectl edit cm -n istio-system istio-sidecar-injector ... ... ... #å¤§æ¦‚åœ¨392è¡Œ volumeMounts: - name: access-log mountPath: /var/log/istio ... ... ... #å¤§æ¦‚åœ¨447è¡Œ volumes: - emptyDir: name: access-log cat \u003c\u003c EOF | kubectl apply -f - --- apiVersion: networking.istio.io/v1alpha3 kind: EnvoyFilter metadata: name: enable-accesslog spec: workloadSelector: labels: app: details configPatches: - applyTo: NETWORK_FILTER match: context: ANY listener: filterChain: filter: name: envoy.filters.network.http_connection_manager patch: operation: MERGE value: typed_config: \"@type\": \"type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager\" access_log: - name: envoy.access_loggers.file typed_config: \"@type\": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog path: \"/var/log/istio/access.log\" ## æ³¨æ„æ­¤å¤„æ–‡ä»¶ç›®å½•æ˜¯åˆšåˆšè°ƒæ•´çš„ä¸´æ—¶å·ç›®å½• log_format: json_format: authority: \"%REQ(:AUTHORITY)%\" bytes_received: \"%BYTES_RECEIVED%\" bytes_sent: \"%BYTES_SENT%\" downstream_local_address: \"%DOWNSTREAM_LOCAL_ADDRESS%\" downstream_remote_address: \"%DOWNSTREAM_REMOTE_ADDRESS%\" duration: \"%DURATION%\" method: \"%REQ(:METHOD)%\" path: \"%REQ(X-ENVOY-ORIGINAL-PATH?:PATH)%\" protocol: \"%PROTOCOL%\" request_id: \"%REQ(X-REQUEST-ID)%\" requested_server_name: \"%REQUESTED_SERVER_NAME%\" response_code: \"%RESPONSE_CODE%\" response_flags: \"%RESPONSE_FLAGS%\" route_name: \"%ROUTE_NAME%\" start_time: \"%START_TIME%\" upstream_cluster: \"%UPSTREAM_CLUSTER%\" upstream_host: \"%UPSTREAM_HOST%\" upstream_local_address: \"%UPSTREAM_LOCAL_ADDRESS%\" upstream_service_time: \"%RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)%\" upstream_transport_failure_reason: \"%UPSTREAM_TRANSPORT_FAILURE_REASON%\" user_agent: \"%REQ(USER-AGENT)%\" x_forwarded_for: \"%REQ(X-FORWARDED-FOR)%\" EOF ä½¿ç”¨logrotateæ¥æ»šåŠ¨æ—¥å¿—ä»å­˜åœ¨é—®é¢˜ ","date":"2023-03-17","objectID":"/posts/5a662f/:0:4","tags":["envoyfilter","access"],"title":"Istio Proxy Accessæ—¥å¿—","uri":"/posts/5a662f/"},{"categories":["istio"],"content":"æ—¥å¿—æ»šåŠ¨ FROM istio/proxyv2:1.13.4 RUN apt update \u0026\u0026 apt install -y logrotate RUN install -d -m 0755 -o istio-proxy -g istio-proxy /var/log/istio # logrotate_envoy.conf is logrotate config file COPY logrotate_envoy.conf /etc/logrotate.d/envoy /var/log/istio/access.log { missingok hourly compress notifempty nocreate rotate 5 size=100M sharedscripts copytruncate } template: metadata: annotations: sidecar.istio.io/proxyImage: registry.cn-hangzhou.aliyuncs.com/seam/istio-proxyv2:1.13.4-logrotate ","date":"2023-03-17","objectID":"/posts/5a662f/:0:5","tags":["envoyfilter","access"],"title":"Istio Proxy Accessæ—¥å¿—","uri":"/posts/5a662f/"},{"categories":["istio"],"content":"å‚è€ƒèµ„æ–™ istio å®˜æ–¹æ–‡æ¡£ç»™å‡ºçš„å¸¸è§å˜é‡ ","date":"2023-03-17","objectID":"/posts/5a662f/:1:0","tags":["envoyfilter","access"],"title":"Istio Proxy Accessæ—¥å¿—","uri":"/posts/5a662f/"},{"categories":["Kubernetes"],"content":"å‰è¨€ è¿™ç¯‡å†…å®¹ç¯‡å¹…æ¯”è¾ƒé•¿ï¼Œå¦‚æœä¸æƒ³æ·±å…¥æ¢è®¨æˆ–æ—¶é—´æœ‰é™ï¼Œè¿™æ˜¯å…¨æ–‡ç®€è¿°ï¼š åœ¨é»˜è®¤è®¾ç½®ä¸‹ï¼Œæ‰©å±• Kubernetes é›†ç¾¤ä¸­çš„ pod å’ŒèŠ‚ç‚¹å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ã€‚ äº†è§£å¦‚ä½•è°ƒæ•´é›†ç¾¤èŠ‚ç‚¹çš„å¤§å°ã€é…ç½®æ°´å¹³å’Œé›†ç¾¤è‡ªåŠ¨ç¼©æ”¾å™¨ä»¥åŠè¿‡åº¦é…ç½®é›†ç¾¤ä»¥åŠ å¿«æ‰©å±•é€Ÿåº¦ã€‚ ","date":"2023-03-16","objectID":"/posts/a18401/:1:0","tags":["è‡ªåŠ¨ä¼¸ç¼©"],"title":"å¦‚ä½•é€‰æ‹©æœ€ä½³çš„Kubernetesé›†ç¾¤è‡ªåŠ¨ä¼¸ç¼©ç­–ç•¥","uri":"/posts/a18401/"},{"categories":["Kubernetes"],"content":"ç›®å½• å½“è‡ªåŠ¨ä¼¸ç¼©çš„ Pod æŠ¥é”™ Kubernetes çš„ Cluster Autoscaler æ˜¯å¦‚ä½•å·¥ä½œçš„ æ¢ç´¢ Pod è‡ªåŠ¨ä¼¸ç¼©æå‰æœŸ ä¸º Kubernetes èŠ‚ç‚¹é€‰æ‹©æœ€ä½³å®ä¾‹å¤§å° åœ¨ Kubernetes é›†ç¾¤ä¸­è¿‡åº¦é…ç½®èŠ‚ç‚¹ ä¸º Pod é€‰æ‹©æ­£ç¡®çš„å†…å­˜å’ŒCPUèµ„æº å…³äºé›†ç¾¤çš„ç¼©å®¹ ä¸ºä»€ä¹ˆä¸åŸºäºå†…å­˜æˆ–CPUè¿›è¡Œè‡ªåŠ¨ä¼¸ç¼© åœ¨ Kubernetes ä¸­, è‡ªåŠ¨ä¼¸ç¼©åŠŸèƒ½åŒ…æ‹¬: Podæ°´å¹³è‡ªåŠ¨ä¼¸ç¼©ï¼ˆHorizontal Pod Autoscalerï¼ŒHPAï¼‰ Podå‚ç›´è‡ªåŠ¨ä¼¸ç¼©ï¼ˆVertical Pod Autoscalerï¼ŒVPAï¼‰ é›†ç¾¤è‡ªåŠ¨ä¼¸ç¼©ï¼ˆCluster Autoscalerï¼ŒCAï¼‰ è¿™äº›è‡ªåŠ¨ä¼¸ç¼©ç»„ä»¶å±äºä¸åŒçš„ç±»åˆ«ï¼Œå…³æ³¨ç‚¹ä¹Ÿä¸åŒã€‚ Horizontal Pod Autoscaler è´Ÿè´£å¢åŠ  Pod çš„å‰¯æœ¬æ•°é‡ã€‚éšç€ä½ çš„åº”ç”¨æ¥æ”¶åˆ°çš„æµé‡è¶Šæ¥è¶Šå¤šï¼Œä½ å¯ä»¥è®©è‡ªåŠ¨ä¼¸ç¼©ç»„ä»¶è°ƒæ•´å‰¯æœ¬æ•°é‡æ¥å¤„ç†æ›´å¤šçš„è¯·æ±‚ã€‚ Vertical Pod Autoscaler çš„ä½¿ç”¨åœºæ™¯æ˜¯ï¼Œå½“èµ„æºä¸è¶³æ— æ³•åˆ›å»ºæ›´å¤šçš„ Pod å‰¯æœ¬æ—¶ï¼Œè€Œåˆä»ç„¶éœ€è¦å¤„ç†æ›´å¤šçš„æµé‡ã€‚ ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œä½ æ— æ³•é€šè¿‡ç®€å•åœ°æ·»åŠ æ›´å¤šçš„ Pod å‰¯æœ¬æ¥æ‰©å®¹æ•°æ®åº“ã€‚æ•°æ®åº“å¯èƒ½éœ€è¦è¿›è¡Œæ•°æ®åˆ†ç‰‡æˆ–è€…é…ç½®åªè¯»èŠ‚ç‚¹ã€‚ ä½†ä½ å¯ä»¥é€šè¿‡å¢åŠ å†…å­˜å’ŒCPUèµ„æºæ¥è®©æ•°æ®åº“èƒ½å¤Ÿå¤„ç†æ›´å¤šçš„è¿æ¥æ•°ã€‚ è¿™æ­£æ˜¯ VPA çš„ç›®çš„ï¼Œå¢åŠ  Pod çš„èµ„æºå¤§å°ã€‚ æœ€åï¼Œæˆ‘ä»¬è¦è¯´è¯´é›†ç¾¤è‡ªåŠ¨ä¼¸ç¼©ç»„ä»¶äº†ã€‚ å½“ä½ çš„é›†ç¾¤èµ„æºä¸è¶³æ—¶ï¼ŒCluster Autoscaler ä¼šé…ç½®ä¸€ä¸ªæ–°çš„è®¡ç®—å•å…ƒå¹¶å°†å…¶æ·»åŠ åˆ°é›†ç¾¤ä¸­ã€‚å¦‚æœç©ºèŠ‚ç‚¹è¿‡å¤šï¼Œä¼šç§»é™¤å®ƒä»¬ä»¥é™ä½æˆæœ¬ã€‚ è™½ç„¶è¿™ä¸‰ä¸ªç»„ä»¶éƒ½ â€œè‡ªåŠ¨ä¼¸ç¼©â€ äº†ä¸€äº›ä¸œè¥¿ï¼Œä½†å®ƒä»¬å¹¶ä¸é€ æˆç›¸äº’ä¹‹é—´çš„å¹²æ‰°ã€‚å®ƒä»¬å„è‡ªéƒ½æœ‰è‡ªå·±ä½¿ç”¨åœºæ™¯ï¼Œå®šä¹‰å’Œå·¥ä½œæœºåˆ¶ã€‚å¹¶ä¸”å®ƒä»¬æ˜¯åœ¨ç‹¬ç«‹çš„é¡¹ç›®ä¸­å¼€å‘çš„ï¼Œç‹¬ç«‹çš„ä½¿ç”¨ã€‚ ç„¶è€Œï¼Œæ›´é‡è¦çš„æ˜¯ï¼Œä¸ºäº†æœ€å¥½çš„ scaling ä½ çš„é›†ç¾¤ï¼Œä½ å¿…é¡»èŠ±äº›å¿ƒæ€å»è®¾ç½®å¥½è¿™äº› Autoscalerï¼Œè®©æˆ‘ä»¬çœ‹ä¸ªä¾‹å­ã€‚ ","date":"2023-03-16","objectID":"/posts/a18401/:2:0","tags":["è‡ªåŠ¨ä¼¸ç¼©"],"title":"å¦‚ä½•é€‰æ‹©æœ€ä½³çš„Kubernetesé›†ç¾¤è‡ªåŠ¨ä¼¸ç¼©ç­–ç•¥","uri":"/posts/a18401/"},{"categories":["Kubernetes"],"content":"å½“è‡ªåŠ¨ä¼¸ç¼©çš„ Pod æŠ¥é”™ æƒ³è±¡ä¸€ä¸‹ï¼Œæœ‰ä¸€ä¸ªåº”ç”¨ç¨‹åºå§‹ç»ˆéœ€è¦å¹¶ä½¿ç”¨ 1.5GB å†…å­˜å’Œ 0.25 ä¸ª vCPUã€‚ ä½ é…ç½®äº†ä¸€ä¸ªå…·æœ‰ 8GB å’Œ 2 ä¸ª vCPU çš„å•ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤ â€”â€” å®ƒåº”è¯¥èƒ½å¤Ÿå®Œç¾åœ°å®¹çº³å››ä¸ª podï¼ˆå¹¶ä¸”è¿˜æœ‰ä¸€ç‚¹é¢å¤–çš„ç©ºé—´ï¼‰ã€‚ :size=700 ç°åœ¨ï¼Œä½ éƒ¨ç½²äº†ä¸€ä¸ª Pod å¹¶ä¸”é…ç½®å¦‚ä¸‹ï¼š HPA é…ç½®æ¯ 10 ä¸ªè¯·æ±‚è¿›æ¥å°±æ·»åŠ ä¸€ä¸ª Pod å‰¯æœ¬ï¼ˆä¾‹å¦‚ï¼šå¦‚æœæœ‰ 40 ä¸ªå¹¶å‘è¯·æ±‚æ¶Œå…¥ï¼Œä¼šæ‰©å®¹åˆ° 4 ä¸ª Pod å‰¯æœ¬ï¼‰ã€‚ CA é…ç½®åœ¨èµ„æºä¸è¶³æ—¶ï¼Œåˆ›å»ºæ›´å¤šçš„ Node èŠ‚ç‚¹ã€‚ HPA å¯ä»¥é€šè¿‡åœ¨ deployment æ–‡ä»¶ä¸­ä½¿ç”¨ Custom Metricsï¼ˆä¾‹å¦‚åœ¨ Ingress Controller ä¸­çš„ queries per secondï¼ˆQPSï¼‰ï¼‰ æ¥æ‰©å®¹ Pod å‰¯æœ¬æ•°é‡ã€‚ ç°åœ¨ï¼Œä½ å¼€å§‹ä¸ºé›†ç¾¤å¢åŠ  30 ä¸ªå¹¶å‘è¯·æ±‚ï¼Œå¹¶è§‚å¯Ÿä¸€ä¸‹æƒ…å†µï¼š HPA å¼€å§‹æ‰©å®¹ Podã€‚ åˆ›å»ºäº†ä¸¤ä¸ª Pod å‰¯æœ¬ã€‚ CA æ²¡æœ‰è§¦å‘ - æ²¡æœ‰æ–°å¢é›†ç¾¤ Node èŠ‚ç‚¹ã€‚ è¿™å¾ˆå¥½ç†è§£ï¼Œå› ä¸ºç°åœ¨æœ‰è¶³å¤Ÿçš„å†…å­˜å’Œ CPU èµ„æºæ¥æ”¯æŒæ›´å¤šçš„ Podã€‚ :size=700 ä½ è¿›ä¸€æ­¥å°†æµé‡å¢åŠ åˆ° 40 ä¸ªå¹¶å‘è¯·æ±‚ï¼Œå¹¶å†æ¬¡è§‚å¯Ÿï¼š HPA åˆåˆ›å»ºäº†ä¸€ä¸ª Podã€‚ è¿™ä¸ª Pod æ˜¯ pending çŠ¶æ€å¹¶ä¸”æ— æ³•è¢«éƒ¨ç½²ã€‚ CA è§¦å‘åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ Node èŠ‚ç‚¹ã€‚ æ–° Node èŠ‚ç‚¹å¯åŠ¨ 4 åˆ†é’Ÿåå¼€å§‹å·¥ä½œã€‚ä¹‹åï¼Œpending Pod ä¹ŸæˆåŠŸè¢«éƒ¨ç½²äº†ã€‚ :size=700 :size=700 ä¸ºä»€ä¹ˆç¬¬å››ä¸ª Pod æ²¡æœ‰éƒ¨ç½²åœ¨ç¬¬ä¸€ä¸ª Node èŠ‚ç‚¹ä¸Šå‘¢ï¼Ÿ Pod éƒ¨ç½²åœ¨é›†ç¾¤ä¸Šéœ€è¦æ¶ˆè€—å†…å­˜ï¼ŒCPUï¼Œç¡¬ç›˜ç©ºé—´ç­‰èµ„æºï¼Œåœ¨åŒä¸€ä¸ª Node ä¸Šï¼Œæ“ä½œç³»ç»Ÿå’Œ kubelet ç»„ä»¶ä¹Ÿéœ€è¦æ¶ˆè€—å†…å­˜å’Œ CPU èµ„æºã€‚ Kubernetes ä¸­ä¸€ä¸ª Worker Node èŠ‚ç‚¹çš„å†…å­˜å’Œ CPU ç­‰èµ„æºä½¿ç”¨åˆ†å¸ƒå¦‚ä¸‹ï¼š éœ€è¦è¿è¡Œæ“ä½œç³»ç»Ÿå’Œä¸€äº›ç³»ç»Ÿçº§çš„å®ˆæŠ¤è¿›ç¨‹ï¼Œä¾‹å¦‚ SSHï¼ŒSystemd ç­‰ã€‚ éœ€è¦è¿è¡Œ Kubernetes Agent ç»„ä»¶ï¼Œä¾‹å¦‚ Kubeletï¼ŒContainer Runtimeï¼ŒNode Problem Detector ç­‰ã€‚ éœ€è¦è¿è¡Œ Podã€‚ éœ€è¦ä¿ç•™ä¸€äº›èµ„æºç”¨æ¥é©±é€é˜€å€¼ ä¹‹ç”¨ã€‚ :size=700 ä½ çŒœçš„æ²¡é”™ï¼Œæ‰€æœ‰è¿™äº›é…é¢éƒ½æ˜¯å¯å®šåˆ¶çš„ï¼Œä½†ä½ éœ€è¦å¥½å¥½è®¡ç®—ä¸€ä¸‹ã€‚ åœ¨ä¸€ä¸ª 8GB å†…å­˜å’Œ 2vCPU çš„å•ä¸ªèŠ‚ç‚¹çš„ï¼Œå¯ä»¥æŒ‰å¦‚ä¸‹ä¼°ç®—ï¼š æ“ä½œç³»ç»Ÿè¿è¡Œå¤§æ¦‚éœ€è¦ 100MB å†…å­˜å’Œ 0.1vCPUã€‚ kubelet è¿è¡Œå¤§æ¦‚éœ€è¦ 1.8GB å†…å­˜å’Œ 0.07vCPUã€‚ é©±é€é˜€å€¼å¤§æ¦‚éœ€è¦ 100MB å†…å­˜ã€‚ å‰©ä½™çš„å¤§çº¦ 6GB å†…å­˜ç©ºé—´å’Œ 1.83vCPU æ˜¯æä¾›ç»™ Pod ä½¿ç”¨çš„ã€‚ å¦‚æœä½ çš„é›†ç¾¤éœ€è¦è¿è¡Œ DaemonSet èµ„æºï¼Œåƒ kube-proxyï¼Œé‚£ä¹ˆä½ åº”è¯¥è¿›ä¸€æ­¥å‡å°‘æä¾›ç»™ Pod çš„èµ„æºã€‚è€ƒè™‘åˆ° kube-proxy å¤§æ¦‚éœ€è¦ 128MB å†…å­˜å’Œ 0.1vCPUï¼Œé‚£ä¹ˆå‰©ä½™å¤§çº¦ 5.9GB å†…å­˜ç©ºé—´å’Œ 1.73vCPU æ˜¯æä¾›ç»™ Pod ä½¿ç”¨çš„ã€‚ å¦å¤–ï¼Œå¦‚æœè¿˜éœ€è¦è¿è¡Œ CNI ç»„ä»¶ï¼ˆä¾‹å¦‚ï¼šFlannelï¼‰å’Œæ—¥å¿—æ”¶é›†ç»„ä»¶ï¼ˆFlentdï¼‰ï¼Œåˆä¼šè¿›ä¸€æ­¥å‡å°‘æä¾›ç»™ Pod çš„èµ„æºã€‚ åœ¨ç»Ÿè®¡å®Œæ‰€æœ‰å…¶ä»–çš„èµ„æºå ç”¨æƒ…å†µåï¼Œé›†ç¾¤çš„å‰©ä½™ç©ºé—´å°±åªå¤Ÿè¿è¡Œä¸‰ä¸ª Pod äº†ã€‚ :size=700 æ‰€ä»¥ç¬¬å››ä¸ªä¼šä¸€ç›´ä¿æŒ â€œpendingâ€ çŠ¶æ€ï¼Œç›´åˆ°å®ƒè¢«è°ƒåº¦åˆ°å…¶ä»–çš„ Node èŠ‚ç‚¹ä¸Šã€‚ æ—¢ç„¶ Cluster Autoscaler çŸ¥é“æ²¡æœ‰ç©ºé—´å®¹çº³ç¬¬å››ä¸ª Podï¼Œä¸ºä»€ä¹ˆä¸æå‰é…ç½®ä¸€ä¸ªæ–°èŠ‚ç‚¹ï¼Ÿ ä¸ºä»€ä¹ˆå®ƒè¦åœ¨ Pod å¤„äº â€œpendingâ€ çŠ¶æ€ä¹‹åå†è§¦å‘åˆ›å»ºæ–° Node èŠ‚ç‚¹çš„æ“ä½œï¼Ÿ ","date":"2023-03-16","objectID":"/posts/a18401/:2:1","tags":["è‡ªåŠ¨ä¼¸ç¼©"],"title":"å¦‚ä½•é€‰æ‹©æœ€ä½³çš„Kubernetesé›†ç¾¤è‡ªåŠ¨ä¼¸ç¼©ç­–ç•¥","uri":"/posts/a18401/"},{"categories":["Kubernetes"],"content":"Kubernetes çš„ Cluster Autoscaler æ˜¯å¦‚ä½•å·¥ä½œçš„ Cluster Autoscaler ä¸æ˜¯é€šè¿‡è§‚å¯Ÿå†…å­˜æˆ– CPU çš„ä½¿ç”¨æƒ…å†µæ¥è§¦å‘è‡ªåŠ¨ä¼¸ç¼©çš„ã€‚ç›¸ååœ°ï¼Œæ˜¯é€šè¿‡å¯¹äº‹ä»¶çš„å“åº”å’Œæ¯ 10s å¯¹ä¸å¯è°ƒåº¦çš„ Pod è¿›è¡Œæ£€æŸ¥ã€‚ å½“ Scheduler æ— æ³•æ‰¾åˆ°å¯ä»¥å®¹çº³å®ƒçš„ Node èŠ‚ç‚¹æ—¶ï¼ŒPod å°±ä¼šå˜æˆä¸å¯è°ƒåº¦çŠ¶æ€ã€‚ä¾‹å¦‚ï¼Œå½“ä¸€ä¸ª Pod éœ€è¦ 1vCPU èµ„æºè€Œé›†ç¾¤åªæœ‰ 0.5vCPU èµ„æºå¯ç”¨ï¼ŒScheduler å°±ä¼šæŠŠè¯¥ Pod æ ‡è®°ä¸ºä¸å¯è°ƒåº¦çŠ¶æ€ã€‚ è¿™æ—¶ï¼ŒCluster Autoscaler ä¼šå¼€å§‹åˆ›å»ºæ–° Node èŠ‚ç‚¹ã€‚åˆ›å»ºå®Œæˆåï¼Œå®ƒä¼šæ‰«æé›†ç¾¤ä¸­çš„ä¸å¯è°ƒåº¦çŠ¶æ€çš„ Podï¼Œæ£€æŸ¥æ˜¯å¦å¯ä»¥å°†è¿™äº› Pod è°ƒåº¦åˆ°æ–°èŠ‚ç‚¹ä¸Šã€‚ å¦‚æœä½ çš„é›†ç¾¤å…·æœ‰å¤šç§èŠ‚ç‚¹ç±»å‹ï¼ˆé€šå¸¸ä¹Ÿç§°ä¸ºèŠ‚ç‚¹ç»„æˆ–èŠ‚ç‚¹æ± ï¼‰ï¼Œåˆ™ Cluster Autoscaler å°†ä½¿ç”¨ä»¥ä¸‹ç­–ç•¥é€‰æ‹©å…¶ä¸­ä¸€ç§ï¼š Random - éšæœºé€‰æ‹©ä¸€ç§èŠ‚ç‚¹ç±»å‹ï¼ˆé»˜è®¤ç­–ç•¥ï¼‰ã€‚ Most Pods - é€‰æ‹©å°†è°ƒåº¦æœ€å¤š Pod çš„èŠ‚ç‚¹ç»„ã€‚ Least waste - é€‰æ‹©æ‰©å®¹åç©ºé—² CPU æœ€å°‘çš„èŠ‚ç‚¹ç»„ã€‚ Price - é€‰æ‹©æˆæœ¬æœ€ä½çš„èŠ‚ç‚¹ç»„ï¼ˆç›®å‰ä»…é€‚ç”¨äº GCPï¼‰ã€‚ Priority - é€‰æ‹©ä¼˜å…ˆçº§æœ€é«˜çš„èŠ‚ç‚¹ç»„ï¼ˆä¼˜å…ˆçº§å¯ä»¥æ‰‹åŠ¨è®¾ç½®ï¼‰ã€‚ ä¸€æ—¦ç¡®å®šäº†èŠ‚ç‚¹ç±»å‹ï¼ŒCluster Autoscaler å°†è°ƒç”¨ç›¸å…³ API æ¥æä¾›æ–°çš„è®¡ç®—èµ„æºã€‚ å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ AWSï¼ŒCluster Autoscaler å°†é¢„ç½®ä¸€ä¸ªæ–°çš„ EC2 å®ä¾‹ã€‚åœ¨ Azure ä¸Šï¼Œå®ƒå°†åˆ›å»ºä¸€ä¸ªæ–°çš„è™šæ‹Ÿæœºï¼Œå¹¶åœ¨ GCP ä¸Šåˆ›å»ºä¸€ä¸ªæ–°çš„è®¡ç®—å¼•æ“ã€‚ åˆ›å»ºçš„èŠ‚ç‚¹å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´æ‰èƒ½å‡ºç°åœ¨ Kubernetes ä¸­ã€‚è®¡ç®—èµ„æºå‡†å¤‡å°±ç»ªåï¼ŒèŠ‚ç‚¹å°†è¢«åˆå§‹åŒ–å¹¶æ·»åŠ åˆ°å¯ä»¥éƒ¨ç½²æœªè¢«è°ƒåº¦ Pod çš„é›†ç¾¤ä¸­ã€‚ ä¸å¹¸çš„æ˜¯ï¼Œé…ç½®ä¸€ä¸ªæ–°èŠ‚ç‚¹é€šå¸¸ä¼šå¾ˆæ…¢ã€‚å®ƒå¯èƒ½ä¼šèŠ±è´¹å¥½å‡ åˆ†é’Ÿæ¥åšè¿™ä»¶äº‹ã€‚ è®©æˆ‘ä»¬æ¥çœ‹çœ‹è¿™å‡ åˆ†é’Ÿåˆ°åº•å¹²äº†ä»€ä¹ˆã€‚ ","date":"2023-03-16","objectID":"/posts/a18401/:2:2","tags":["è‡ªåŠ¨ä¼¸ç¼©"],"title":"å¦‚ä½•é€‰æ‹©æœ€ä½³çš„Kubernetesé›†ç¾¤è‡ªåŠ¨ä¼¸ç¼©ç­–ç•¥","uri":"/posts/a18401/"},{"categories":["Kubernetes"],"content":"æ¢ç´¢ Pod è‡ªåŠ¨ä¼¸ç¼©å‰ç½®æœŸ åœ¨æ–°èŠ‚ç‚¹ä¸Šåˆ›å»ºæ–° Pod æ‰€éœ€çš„æ—¶é—´ç”±å››ä¸ªä¸»è¦å› ç´ å†³å®šï¼š HPA çš„ååº”æ—¶é—´ã€‚ CA çš„ååº”æ—¶é—´ã€‚ Node èŠ‚ç‚¹çš„ååº”æ—¶é—´ã€‚ Pod åˆ›å»ºçš„æ—¶é—´ã€‚ é»˜è®¤åœ°ï¼Œkubelet æ¯ 10 ç§’æŠ“å–ä¸€æ¬¡ Pod çš„ CPU å’Œå†…å­˜ä½¿ç”¨æƒ…å†µã€‚æ¯åˆ†é’Ÿï¼ŒMetrics Server éƒ½ä¼šèšåˆè¿™äº›æŒ‡æ ‡å¹¶å°†å®ƒä»¬å‘é€ç»™ Kubernetes API çš„å…¶ä»–ç»„ä»¶ã€‚ Horizontal Pod Autoscaler æ§åˆ¶å™¨è´Ÿè´£æ£€æŸ¥æŒ‡æ ‡å¹¶å†³å®šæ‰©å¤§æˆ–ç¼©å°å‰¯æœ¬æ•°é‡ã€‚ é»˜è®¤åœ°ï¼ŒHorizontal Pod Autoscaler æ¯ 15 ç§’æ£€æŸ¥ä¸€æ¬¡ Pod æŒ‡æ ‡ã€‚ Cluster Autoscaler æ¯ 10 ç§’æ£€æŸ¥ä¸€æ¬¡é›†ç¾¤ä¸­ä¸å¯è°ƒåº¦çš„ Podã€‚ ä¸€æ—¦ CA æ£€æµ‹åˆ°ä¸å¯è°ƒåº¦çš„ Podï¼Œå®ƒå°±ä¼šè¿è¡Œä¸€ä¸ªç®—æ³•æ¥åšå†³ç­–ï¼š éœ€è¦å¤šå°‘ä¸ªèŠ‚ç‚¹æ¥å°†æ‰€æœ‰çš„ä¸å¯è°ƒåº¦ Pod éƒ¨ç½²å®Œæˆã€‚ éœ€è¦åˆ›å»ºé‚£ç§ç±»å‹çš„èŠ‚ç‚¹ç»„ã€‚ æ•´ä¸ªè¿‡ç¨‹çš„æ—¶é—´èŠ±è´¹åº”è¯¥æ˜¯ï¼š åœ¨å°‘äº 100 ä¸ªèŠ‚ç‚¹ä¸”æ¯ä¸ªèŠ‚ç‚¹æœ€å¤š 30 ä¸ª Pod çš„é›†ç¾¤ä¸Šä¸è¶…è¿‡ 30 ç§’ã€‚ å¹³å‡å»¶è¿Ÿåº”è¯¥æ˜¯å¤§çº¦ 5 ç§’ã€‚ åœ¨å…·æœ‰ 100 åˆ° 1000 ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤ä¸Šä¸è¶…è¿‡ 60 ç§’ã€‚ å¹³å‡å»¶è¿Ÿåº”çº¦ä¸º 15 ç§’ã€‚ :size=700 ç„¶åæ˜¯èŠ‚ç‚¹é…ç½®æ—¶é—´ï¼Œè¿™ä¸»è¦å–å†³äºäº‘æä¾›å•†ã€‚åœ¨ 3-5 åˆ†é’Ÿå†…ä¾›åº”æ–°çš„è®¡ç®—èµ„æºæ˜¯éå¸¸æ ‡å‡†çš„ã€‚ :size=700 æœ€åï¼ŒPod å¿…é¡»ç”±å®¹å™¨è¿è¡Œæ—¶åˆ›å»ºã€‚å¯åŠ¨ä¸€ä¸ªå®¹å™¨åº”è¯¥ä¸ä¼šè¶…è¿‡å‡ æ¯«ç§’ï¼Œä½†ä¸‹è½½å®¹å™¨é•œåƒå¯èƒ½éœ€è¦å‡ ç§’é’Ÿã€‚ å¦‚æœæ²¡æœ‰ç¼“å­˜å®¹å™¨æ˜ åƒï¼Œåˆ™ä»å®¹å™¨æ³¨å†Œè¡¨ä¸‹è½½æ˜ åƒå¯èƒ½éœ€è¦å‡ ç§’é’Ÿåˆ°ä¸€åˆ†é’Ÿçš„æ—¶é—´ï¼Œå…·ä½“å–å†³äºå±‚çš„å¤§å°å’Œæ•°é‡ã€‚ :size=700 å› æ­¤ï¼Œå½“é›†ç¾¤ä¸­æ²¡æœ‰ç©ºé—´è€Œè§¦å‘è‡ªåŠ¨ä¼¸ç¼©çš„æ—¶é—´æ¶ˆè€—å¦‚ä¸‹ï¼š Horizontal Pod Autoscaler å¯èƒ½éœ€è¦é•¿è¾¾ 1min30s æ¥å¢åŠ å‰¯æœ¬æ•°é‡ã€‚ å¯¹äºå°‘äº 100 ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤ï¼ŒCluster Autoscaler åº”è¯¥èŠ±è´¹ä¸åˆ° 30s çš„æ—¶é—´ï¼Œå¯¹äºè¶…è¿‡ 100 ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤ï¼Œåº”è¯¥ä¸åˆ° 1minã€‚ äº‘æä¾›å•†å¯èƒ½éœ€è¦ 3-5min æ¥åˆ›å»ºè®¡ç®—æœºèµ„æºã€‚ å®¹å™¨è¿è¡Œæ—¶å¯èƒ½éœ€è¦é•¿è¾¾ 30s æ‰èƒ½ä¸‹è½½å®¹å™¨æ˜ åƒã€‚ å¦‚æœä½ çš„é›†ç¾¤è§„æ¨¡ä¸æ˜¯å¾ˆå¤§ï¼Œåœ¨æœ€åçš„æƒ…å†µä¸‹ï¼Œæ—¶é—´æ¶ˆè€—ï¼š :size=700 å¯¹äºè¶…è¿‡ 100 ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤ï¼Œæ€»å»¶è¿Ÿå¯èƒ½é«˜è¾¾ 7 åˆ†é’Ÿã€‚åœ¨æœ‰æ›´å¤š Pod æ¥å¤„ç†çªç„¶æ¿€å¢çš„æµé‡ä¹‹å‰ï¼Œæ‚¨æ˜¯å¦æ„¿æ„ç­‰å¾…è¿™ 7 åˆ†é’Ÿï¼Ÿ è¿™é‡Œæä¾›äº†å‡ ç§å‡å°‘ scaling æ—¶é—´çš„æ–¹æ³•ï¼š è°ƒæ•´ Horizontal Pod Autoscaler çš„åˆ·æ–°æ—¶é—´ï¼ˆç”± â€“horizontal-pod-autoscaler-sync-period å‚æ•°æ§åˆ¶ï¼Œé»˜è®¤ 15sï¼‰ã€‚ è°ƒæ•´æŠ“å– Pod çš„ CPU å’Œå†…å­˜ä½¿ç”¨æƒ…å†µçš„é—´éš”é¢‘ç‡ï¼ˆç”± metric-resolution å˜é‡æ§åˆ¶ï¼Œé»˜è®¤ 60sï¼‰ã€‚ è°ƒæ•´ Cluster Autoscaler æ‰«ææœªè¢«è°ƒåº¦ Pod çš„é—´éš”é¢‘ç‡ï¼ˆç”± scan-interval å˜é‡æ§åˆ¶ï¼Œé»˜è®¤10sï¼‰ã€‚ è°ƒæ•´ Node èŠ‚ç‚¹ä¸Šç¼“å­˜å®¹å™¨é•œåƒçš„æ–¹å¼ï¼ˆé€šè¿‡è¯¸å¦‚ kube-fledged ç­‰å·¥å…·ï¼‰ã€‚ ä½†å³ä½¿å°†è¿™äº›è®¾ç½®è°ƒæ•´ä¸ºå¾ˆå°çš„å€¼ï¼Œä½ ä»ç„¶ä¼šæ”¶åˆ°äº‘æä¾›å•†åˆ›å»ºè®¡ç®—èµ„æºçš„æ—¶é—´é™åˆ¶ã€‚æœ‰ä»€ä¹ˆæ–¹å¼ä¼˜åŒ–è¿™ä¸ªéƒ¨åˆ†å—ï¼Ÿ è¿™é‡Œå¯ä»¥åšä¸¤ä»¶äº‹ï¼š å°½å¯èƒ½åœ°é¿å…åˆ›å»ºæ–°åœ° Node èŠ‚ç‚¹ã€‚ ä¸»åŠ¨æå‰åˆ›å»ºèŠ‚ç‚¹ï¼Œä»¥ä¾¿åœ¨éœ€è¦æ—¶èƒ½ç›´æ¥ä½¿ç”¨ã€‚ ","date":"2023-03-16","objectID":"/posts/a18401/:2:3","tags":["è‡ªåŠ¨ä¼¸ç¼©"],"title":"å¦‚ä½•é€‰æ‹©æœ€ä½³çš„Kubernetesé›†ç¾¤è‡ªåŠ¨ä¼¸ç¼©ç­–ç•¥","uri":"/posts/a18401/"},{"categories":["Kubernetes"],"content":"ä¸º Kubernetes èŠ‚ç‚¹é€‰æ‹©æœ€ä½³å®ä¾‹å¤§å° é€‰æ‹©æ­£ç¡®çš„èŠ‚ç‚¹å®ä¾‹ç±»å‹å¯¹é›†ç¾¤çš„æ‰©å±•ç­–ç•¥æœ‰å¾ˆå¤§çš„å½±å“ã€‚ è€ƒè™‘ä¸€ä¸ªè¿™æ ·çš„åœºæ™¯ã€‚ ä½ æœ‰ä¸€ä¸ªåº”ç”¨éœ€è¦ 1GB çš„å†…å­˜èµ„æºå’Œ 0.1 vCPU èµ„æºã€‚ ä½ æä¾›çš„ Node èŠ‚ç‚¹æœ‰ 4GB çš„å†…å­˜èµ„æºå’Œ 1 vCPU èµ„æºã€‚ åœ¨ä¸ºæ“ä½œç³»ç»Ÿã€kubelet å’Œé©±é€é˜€å€¼ä¿ç•™å†…å­˜å’Œ CPU åï¼Œå°†æ‹¥æœ‰çº¦ 2.5GB çš„å†…å­˜èµ„æºå’Œ 0.7 vCPU å¯ç”¨äºè¿è¡Œ Podã€‚ æ‰€ä»¥ä½ çš„ Node èŠ‚ç‚¹åªèƒ½æ‰¿è½½ 2 ä¸ª Pod çš„è¿è¡Œã€‚ :size=700 æ¯æ¬¡æ‰©å±• Pod å‰¯æœ¬æ—¶ï¼Œéƒ½å¯èƒ½ä¼šäº§ç”Ÿæœ€å¤š 7 åˆ†é’Ÿçš„å»¶è¿Ÿï¼ˆè§¦å‘ HPAï¼ŒCA å’Œäº‘æä¾›å•†é…ç½®è®¡ç®—èµ„æºçš„å‰ç½®æ—¶é—´ï¼‰ã€‚ è®©æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚æœæ”¹æˆæä¾› 64GB çš„å†…å­˜å’Œ 16 vCPU çš„èŠ‚ç‚¹ä¼šå‘ç”Ÿä»€ä¹ˆã€‚ åœ¨ä¸ºæ“ä½œç³»ç»Ÿã€kubelet å’Œé©±é€é˜€å€¼ä¿ç•™å†…å­˜å’Œ CPU åï¼Œå°†æ‹¥æœ‰çº¦ 58.32GB çš„å†…å­˜èµ„æºå’Œ 15.8 vCPU å¯ç”¨äºè¿è¡Œ Podã€‚ Node èŠ‚ç‚¹å¯ä»¥æ‰¿è½½ 58 ä¸ª Pod çš„è¿è¡Œï¼Œåªæœ‰è¶…è¿‡ 58 ä¸ª Pod å‰¯æœ¬æ—¶ï¼Œæ‰éœ€è¦ä¸€ä¸ªæ–°çš„èŠ‚ç‚¹ã€‚ :size=700 æ­¤å¤–ï¼Œæ¯æ¬¡å‘é›†ç¾¤ä¸­æ·»åŠ èŠ‚ç‚¹æ—¶ï¼Œéƒ½å¯ä»¥éƒ¨ç½²å¤šä¸ª Podã€‚å†æ¬¡è§¦å‘ Cluster Autoscaler çš„æœºä¼šæ›´å°‘ã€‚ é€‰æ‹©å¤§å‹èŠ‚ç‚¹å®ä¾‹ç±»å‹è¿˜æœ‰å¦ä¸€ä¸ªå¥½å¤„ã€‚ ä¸º kubelet é¢„ç•™çš„èµ„æºã€æ“ä½œç³»ç»Ÿå’Œé©±é€é˜€å€¼ä¸è¿è¡Œ Pod çš„å¯ç”¨èµ„æºä¹‹é—´çš„æ¯”ç‡æ›´å¤§ã€‚ çœ‹çœ‹è¿™å¼ å›¾ï¼Œå®ƒæç»˜äº† Pod å¯ç”¨çš„å†…å­˜ã€‚ :size=700 éšç€ Node å®ä¾‹å¤§å°çš„å¢åŠ ï¼Œä½ å¯ä»¥æ³¨æ„åˆ°ï¼ˆæŒ‰æ¯”ä¾‹ï¼‰å¯ç”¨äº Pod çš„èµ„æºå¢åŠ ã€‚æ¢å¥è¯è¯´ï¼Œä¸æ‹¥æœ‰ä¸¤ä¸ªå¤§å°ä¸€åŠçš„å®ä¾‹ç›¸æ¯”ï¼Œå¯ä»¥æ›´é«˜æ•ˆåœ°åˆ©ç”¨èµ„æºã€‚ é‚£åº”è¯¥ä¸€ç›´é€‰æ‹©æœ€å¤§çš„å®ä¾‹å—ï¼Ÿ èŠ‚ç‚¹ä¸Šå¯ä»¥æ‹¥æœ‰çš„ Pod æ•°é‡å†³å®šäº†æ•ˆç‡çš„å³°å€¼ã€‚ ä¸€äº›äº‘æä¾›å•†å°† Pod çš„æ•°é‡é™åˆ¶ä¸º 110 ä¸ªï¼ˆæ¯”å¦‚ GKEï¼‰ã€‚å…¶ä»–ä¸€äº›é™åˆ¶æ˜¯ç”±åº•å±‚ç½‘ç»œåŸºäºæ¯ä¸ªå®ä¾‹ï¼ˆå³AWSï¼‰è§„å®šçš„ã€‚ ä½ å¯ä»¥åœ¨è¿™é‡ŒæŸ¥çœ‹å¤§å¤šæ•°äº‘æä¾›å•†çš„é™åˆ¶ æ‰€ä»¥é€‰æ‹©æ›´å¤§çš„å®ä¾‹ç±»å‹å¹¶ä¸æ€»æ˜¯ä¸€ä¸ªå¥½çš„é€‰æ‹©ã€‚ æˆ‘ä»¬è¿˜éœ€è¦è€ƒè™‘ï¼š çˆ†ç‚¸åŠå¾„ - å¦‚æœä½ åªæœ‰å‡ ä¸ªèŠ‚ç‚¹ï¼Œé‚£ä¹ˆä¸€ä¸ªå¤±è´¥èŠ‚ç‚¹çš„å½±å“æ¯”ä½ æœ‰å¾ˆå¤šèŠ‚ç‚¹çš„å½±å“æ›´å¤§ã€‚ è‡ªåŠ¨ä¼¸ç¼©çš„æˆæœ¬æ›´é«˜ï¼Œå› ä¸ºä¸‹ä¸€ä¸ªå¢é‡æ˜¯ï¼ˆéå¸¸ï¼‰å¤§çš„èŠ‚ç‚¹ã€‚ å‡è®¾ä½ ä¸ºé›†ç¾¤é€‰æ‹©äº†æ­£ç¡®çš„å®ä¾‹ç±»å‹ï¼Œä½ åœ¨é…ç½®æ–°è®¡ç®—å•å…ƒæ—¶å¯èƒ½ä»ç„¶ä¼šé‡åˆ°å»¶è¿Ÿã€‚ å¦‚æœä¸æ˜¯åœ¨éœ€è¦æ‰©å±•æ—¶åˆ›å»ºæ–°èŠ‚ç‚¹ï¼Œè€Œæ˜¯æå‰åˆ›å»ºç›¸åŒçš„èŠ‚ç‚¹ä¼šæ€ä¹ˆæ ·ï¼Ÿ ","date":"2023-03-16","objectID":"/posts/a18401/:2:4","tags":["è‡ªåŠ¨ä¼¸ç¼©"],"title":"å¦‚ä½•é€‰æ‹©æœ€ä½³çš„Kubernetesé›†ç¾¤è‡ªåŠ¨ä¼¸ç¼©ç­–ç•¥","uri":"/posts/a18401/"},{"categories":["Kubernetes"],"content":"åœ¨ Kubernetes é›†ç¾¤ä¸­è¿‡åº¦é…ç½®èŠ‚ç‚¹ å¦‚æœä½ å¯ä»¥è´Ÿæ‹…å¾—èµ·éšæ—¶å¯ç”¨çš„å¤‡ç”¨èŠ‚ç‚¹çš„è¯ï¼Œä½ å¯ä»¥ï¼š æå‰åˆ›å»ºä¸€ä¸ªç©ºçš„ Node èŠ‚ç‚¹ã€‚ ä¸€æ—¦ç©ºçš„ Node èŠ‚ç‚¹ä¸Šæœ‰ Pod äº†ï¼Œå°±ä¼šåˆ›å»ºå¦ä¸€ä¸ªç©ºçš„ Node èŠ‚ç‚¹ã€‚ æ¢å¥è¯è¯´ï¼Œè®© Cluster Autoscaler æ€»æ˜¯ä¿æŒæœ‰ä¸€ä¸ªå¤‡ç”¨çš„ç©º Node èŠ‚ç‚¹ã€‚ è¿™æ˜¯ä¸€ç§æƒè¡¡ï¼šä½ ä¼šäº§ç”Ÿé¢å¤–çš„æˆæœ¬ï¼Œä½†æ‰©å±•æ–°èŠ‚ç‚¹çš„é€Ÿåº¦ä¼šæé«˜ã€‚ ä½†æœ‰åæ¶ˆæ¯å’Œå¥½æ¶ˆæ¯ã€‚ åæ¶ˆæ¯æ˜¯ Cluster Autoscaler æ²¡æœ‰å†…ç½®æ­¤åŠŸèƒ½ã€‚å®ƒä¸èƒ½è¢«æ˜¾å¼çš„é…ç½®ï¼Œå¹¶ä¸”ä¹Ÿæ²¡æœ‰æä¾›ç›¸åº”çš„å‚æ•°ã€‚ å¥½æ¶ˆæ¯æ˜¯ä½ ä»ç„¶å¯ä»¥é€šè¿‡ä¸€äº› trick çš„æ–¹å¼æ¥è¾¾åˆ°è¿™ä¸ªç›®çš„ã€‚ ä½ å¯ä»¥è¿è¡Œå…·æœ‰è¶³å¤Ÿè¯·æ±‚çš„ Deployment æ¥ä¿ç•™ä¸€ä¸ªå®Œæ•´çš„ Node èŠ‚ç‚¹ã€‚ä½ å¯ä»¥å°†è¿™äº› Pod è§†ä¸ºå ä½ç¬¦ - å®ƒæ—¨åœ¨ä¿ç•™ç©ºé—´ï¼Œè€Œä¸æ˜¯ä½¿ç”¨èµ„æºã€‚ ä¸€æ—¦åˆ›å»ºäº†çœŸæ­£çš„ Podï¼Œå°±å¯ä»¥é©±é€å ä½ç¬¦å¹¶éƒ¨ç½²çœŸæ­£çš„ Podã€‚ è¯·æ³¨æ„ï¼Œè¿™ä¸€æ¬¡ä½ ä»ç„¶éœ€è¦ç­‰å¾… 5 åˆ†é’Ÿæ‰èƒ½å°†èŠ‚ç‚¹æ·»åŠ åˆ°é›†ç¾¤ä¸­ï¼Œä½†ä½ å¯ä»¥ç»§ç»­ä½¿ç”¨å½“å‰èŠ‚ç‚¹ã€‚åŒæ—¶ï¼Œåœ¨åå°åˆæä¾›äº†ä¸€ä¸ªæ–°çš„èŠ‚ç‚¹ã€‚ å¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹å‘¢ï¼Ÿ å¯ä»¥ä½¿ç”¨è¿è¡Œæ°¸ä¹…ä¼‘çœ çš„ pod çš„éƒ¨ç½²æ¥é…ç½®è¿‡åº¦é…ç½®ã€‚ :size=700 ä¸Šå›¾ä¸­ï¼Œä½ éœ€è¦ç‰¹åˆ«å…³æ³¨å†…å­˜å’Œ CPU é…ç½®ã€‚Scheduler ä¼šä½¿ç”¨è¿™äº›å€¼æ¥å†³å®šéƒ¨ç½² Pod çš„ä½ç½®ã€‚åœ¨è¿™ç§ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œå®ƒä»¬ç”¨äºä¿ç•™ç©ºé—´ã€‚ ä½ å¯ä»¥é…ç½®ä¸€ä¸ªå¤§å‹ Podï¼Œè¯¥ Pod çš„è¯·æ±‚å¤§è‡´ä¸å¯ç”¨èŠ‚ç‚¹èµ„æºç›¸åŒ¹é…ã€‚åŒæ—¶è¦ç¡®ä¿ä½ è€ƒè™‘äº† kubeletã€æ“ä½œç³»ç»Ÿã€kube-proxy ç­‰æ¶ˆè€—çš„èµ„æºã€‚ å¦‚æœä½ çš„èŠ‚ç‚¹å®ä¾‹æ˜¯ 2 vCPU å’Œ 8GB å†…å­˜ï¼Œå¹¶ä¸” pod çš„å¯ç”¨ç©ºé—´æ˜¯ 1.73 vCPU å’Œ ~5.9GB å†…å­˜ï¼Œåˆ™è¯¥èŠ‚ç‚¹å°±æ— æ³•æ‰¿è½½è¿™ä¸ª Podï¼Œå› ä¸ºå®é™…çš„ Pod å¯ç”¨èµ„æºæ˜¯è¦å°äºæ‰€éœ€èµ„æºçš„ã€‚ :size=700 ä¸ºäº†ç¡®ä¿åœ¨åˆ›å»ºçœŸæ­£çš„ Pod æ—¶èƒ½å¿«é€Ÿçš„é©±é€å ä½Podï¼Œå¯ä»¥ä½¿ç”¨ä¼˜å…ˆçº§å’ŒæŠ¢å ã€‚ Pod Priority è¡¨ç¤ºä¸€ä¸ª Pod ç›¸å¯¹äºå…¶ä»– Pod çš„é‡è¦æ€§ã€‚ å½“ä¸€ä¸ª Pod æ— æ³•è¢«è°ƒåº¦æ—¶ï¼ŒScheduler ä¼šå°è¯•æŠ¢å ï¼ˆé©±é€ï¼‰è¾ƒä½ä¼˜å…ˆçº§çš„ Pod ä»¥è°ƒåº¦ â€œpendingâ€ çš„ Podã€‚ å¯ä»¥ä½¿ç”¨ PodPriorityClass åœ¨é›†ç¾¤ä¸­é…ç½® Pod ä¼˜å…ˆçº§ï¼š :size=700 ç”±äº Pod çš„é»˜è®¤ä¼˜å…ˆçº§ä¸º 0ï¼Œè€Œè¿‡åº¦é…ç½®çš„ PriorityClass å€¼ä¸º -1ï¼Œå› æ­¤å½“é›†ç¾¤ç©ºé—´ä¸è¶³æ—¶ï¼Œè¿™äº› Pod å°†é¦–å…ˆè¢«é€å‡ºã€‚ PriorityClass è¿˜æœ‰ä¸¤ä¸ªå¯é€‰å­—æ®µï¼šglobalDefault å’Œ descriptionã€‚ description å­—æ®µæ˜¯æä¾›ç»™äººé˜…è¯»çš„å…³äº PriorityClass çš„æè¿°ä¿¡æ¯ã€‚ globalDefault å­—æ®µè¡¨ç¤ºè¿™ä¸ª PriorityClass çš„å€¼åº”è¯¥ç”¨äºæ²¡æœ‰ priorityClassName çš„ Podã€‚ç³»ç»Ÿä¸­åªèƒ½å­˜åœ¨ä¸€ä¸ª global Default è®¾ç½®ä¸º true çš„ PriorityClassã€‚ ä½ å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ä¸ºä½ çš„ Pod æŒ‡å®šä¼˜å…ˆçº§ï¼š :size=700 è®¾ç½®å®Œæˆï¼ å½“é›†ç¾¤ä¸­æ²¡æœ‰è¶³å¤Ÿçš„èµ„æºæ—¶ï¼ŒPause Pod ä¼šè¢«æŠ¢å ï¼Œå¹¶ç”±æ–°çš„ Pod å–è€Œä»£ä¹‹ã€‚ ç”±äº Pause pod å˜å¾—ä¸å¯è°ƒåº¦ï¼Œå®ƒä¼šå¼ºåˆ¶ Cluster Autoscaler å‘é›†ç¾¤æ·»åŠ æ›´å¤šèŠ‚ç‚¹ã€‚ ç°åœ¨ï¼Œä½ å·²å‡†å¤‡å¥½è¿‡åº¦é…ç½®é›†ç¾¤ï¼Œè¯¥æ˜¯æ—¶å€™è€ƒè™‘ä¼˜åŒ–åº”ç”¨ç¨‹åºä»¥è¿›è¡Œæ‰©å±•äº†ã€‚ ","date":"2023-03-16","objectID":"/posts/a18401/:2:5","tags":["è‡ªåŠ¨ä¼¸ç¼©"],"title":"å¦‚ä½•é€‰æ‹©æœ€ä½³çš„Kubernetesé›†ç¾¤è‡ªåŠ¨ä¼¸ç¼©ç­–ç•¥","uri":"/posts/a18401/"},{"categories":["Kubernetes"],"content":"ä¸º Pod é€‰æ‹©æ­£ç¡®çš„å†…å­˜å’ŒCPUèµ„æº Cluster Autoscaler ä¼šæ ¹æ® pending Pod çš„å‡ºç°æ¥åšå‡º scaling å†³ç­–ã€‚ Kubernetes Scheduler æ ¹æ® Node èŠ‚ç‚¹çš„å†…å­˜å’Œ CPU è´Ÿè½½æƒ…å†µå†³å®šå°† Pod åˆ†é…ï¼ˆæˆ–ä¸åˆ†é…ï¼‰ç»™èŠ‚ç‚¹ã€‚ å› æ­¤ï¼Œå¿…é¡»ä¸ºä½ çš„å·¥ä½œè´Ÿè½½è®¾ç½®æ­£ç¡®çš„èµ„æºä½¿ç”¨è¯·æ±‚ï¼Œå¦åˆ™æ‚¨å¯èƒ½ä¼šè¿‡æ™šï¼ˆæˆ–è¿‡æ—©ï¼‰è§¦å‘è‡ªåŠ¨ä¼¸ç¼©æœºåˆ¶ã€‚ è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­ã€‚ æ‚¨å†³å®šè¦æµ‹è¯•ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œå¹¶å‘ç°ï¼š åœ¨å¹³å‡è´Ÿè½½ä¸‹ï¼Œåº”ç”¨ç¨‹åºæ¶ˆè€— 512MB å†…å­˜å’Œ 0.25 vCPUã€‚ åœ¨é«˜å³°æœŸï¼Œåº”ç”¨ç¨‹åºåº”æœ€å¤šæ¶ˆè€— 4GB å†…å­˜å’Œ 1 vCPUã€‚ :size=700 ä½ çš„å®¹å™¨çš„é™åˆ¶åº”è¯¥æ˜¯ 4GB å†…å­˜å’Œ 1 ä¸ª vCPUã€‚ä½†æ˜¯ï¼Œè¯·æ±‚å‘¢ï¼Ÿ Scheduler åœ¨åˆ›å»º Pod ä¹‹å‰ä½¿ç”¨ Pod çš„å†…å­˜å’Œ CPU è¯·æ±‚æ¥é€‰æ‹©æœ€ä½³èŠ‚ç‚¹ã€‚ æ‰€ä»¥ä½ å¯ä»¥ï¼š å°†è¯·æ±‚è®¾ç½®ä¸ºä½äºå®é™…å¹³å‡ä½¿ç”¨é‡ã€‚ ä¿å®ˆä¸€ç‚¹ï¼Œåˆ†é…æ›´æ¥è¿‘é™åˆ¶çš„è¯·æ±‚ã€‚ è®¾ç½®è¯·æ±‚ä»¥åŒ¹é…å®é™…çš„é™åˆ¶ã€‚ :size=700 :size=700 :size=700 å®šä¹‰ä½äºå®é™…ä½¿ç”¨çš„è¯·æ±‚æ˜¯æœ‰é—®é¢˜çš„ï¼Œå› ä¸ºä½ çš„èŠ‚ç‚¹ç»å¸¸ä¼šè¢«è¿‡åº¦ä½¿ç”¨ã€‚ ä¾‹å¦‚ï¼Œä½ å¯ä»¥åˆ†é… 256MB çš„å†…å­˜ä½œä¸ºå†…å­˜è¯·æ±‚ã€‚Scheduler å¯ä»¥ä¸ºæ¯ä¸ªèŠ‚ç‚¹å®‰è£…ä¸¤å€çš„ Podã€‚ç„¶è€Œï¼ŒPod åœ¨å®è·µä¸­ä½¿ç”¨ä¸¤å€çš„å†…å­˜å¹¶å¼€å§‹ç«äº‰èµ„æº (CPU) å¹¶è¢«é©±é€ï¼ˆèŠ‚ç‚¹ä¸Šæ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜ï¼‰ã€‚ :size=700 è¿‡åº¦ä½¿ç”¨èŠ‚ç‚¹ä¼šå¯¼è‡´è¿‡å¤šçš„é©±é€ã€æ›´å¤šçš„ kubelet å·¥ä½œå’Œå¤§é‡çš„é‡æ–°è°ƒåº¦ã€‚ å¦‚æœå°†è¯·æ±‚è®¾ç½®ä¸ºä¸é™åˆ¶ç›¸åŒçš„å€¼ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ åœ¨ Kubernetes ä¸­ï¼Œè¿™é€šå¸¸è¢«ç§°ä¸º Guaranteed Quality of Service ç±»ï¼ŒæŒ‡çš„æ˜¯ pod ä¸å¤ªå¯èƒ½è¢«ç»ˆæ­¢å’Œé©±é€ã€‚Scheduler å°†ä¸ºåˆ†é…çš„èŠ‚ç‚¹ä¸Šçš„ Pod ä¿ç•™æ•´ä¸ª CPU å’Œå†…å­˜ã€‚è¯¥ç±» Pod è¿è¡Œç¨³å®šï¼Œä½†åŒæ—¶è¯¥èŠ‚ç‚¹çš„ä½¿ç”¨æ•ˆç‡å°±ä¼šæ¯”è¾ƒä½ã€‚ å¦‚æœä½ çš„åº”ç”¨å¹³å‡ä½¿ç”¨ 512MB çš„å†…å­˜ï¼Œä½†ä¸ºå®ƒé¢„ç•™äº† 4GBï¼Œé‚£ä¹ˆå¤§éƒ¨åˆ†æ—¶é—´æœ‰ 3.5GB æœªä½¿ç”¨ã€‚ :size=700 è¿™å€¼å¾—ä¹ˆï¼Ÿ å¦‚æœä½ æƒ³è¦æ›´å¤šçš„ç¨³å®šæ€§ï¼Œæ˜¯å€¼å¾—çš„ã€‚ å¦‚æœä½ æƒ³è¦æ•ˆç‡ï¼Œä½ å¯èƒ½å¸Œæœ›é™ä½è¯·æ±‚å¹¶åœ¨è¿™äº›è¯·æ±‚ä¸é™åˆ¶ä¹‹é—´æ‰¾åˆ°å¹³è¡¡ã€‚ è¿™é€šå¸¸è¢«ç§°ä¸º Burstable Quality of Service ç±»ï¼ŒæŒ‡çš„æ˜¯ Pod æ¶ˆè€—ç¨³å®šä½†å¶å°”ä¼šçªç„¶ä½¿ç”¨æ›´å¤šå†…å­˜å’Œ CPUã€‚ å½“ä½ çš„è¯·æ±‚ä¸åº”ç”¨çš„å®é™…ä½¿ç”¨ç›¸åŒ¹é…æ—¶ï¼ŒScheduler å°†é«˜æ•ˆåœ°å°†ä½ çš„ Pod æ‰“åŒ…åˆ°ä½ çš„èŠ‚ç‚¹ä¸­ã€‚ æœ‰æ—¶ï¼Œåº”ç”¨ç¨‹åºå¯èƒ½éœ€è¦æ›´å¤šå†…å­˜æˆ– CPUã€‚ å¦‚æœ Node ä¸­æœ‰èµ„æºï¼Œåº”ç”¨ç¨‹åºå°†ä¼šåœ¨è¾¾åˆ°æœ€ä½æ¶ˆè€—ä¹‹å‰ä½¿ç”¨å®ƒä»¬ã€‚ å¦‚æœ Node ä¸­èµ„æºä¸è¶³ï¼ŒPod å°†ç«äº‰èµ„æºï¼ˆCPUï¼‰ï¼Œkubelet å¯èƒ½ä¼šå°è¯•é©±é€ Podï¼ˆå†…å­˜ï¼‰ã€‚ æ­¤æ—¶ï¼Œä½ åº”è¯¥ä½¿ç”¨ Guaranteed Quality of Service è¿˜æ˜¯ Burstable Quality of Serviceï¼Ÿ è¿™å–å†³äºå¦‚ä¸‹ä¸¤ç‚¹ï¼š å½“ä½ å¸Œæœ›æœ€å°åŒ– Pod çš„é‡æ–°è°ƒåº¦å’Œé©±é€æ—¶ï¼Œè¯·ä½¿ç”¨ Guaranteed Quality of Serviceï¼ˆè¯·æ±‚ç­‰äºé™åˆ¶ï¼‰ã€‚ ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­æ˜¯ç”¨äºæ•°æ®åº“çš„ Podã€‚ å½“ä½ æƒ³è¦ä¼˜åŒ–é›†ç¾¤å¹¶æ˜æ™ºåœ°ä½¿ç”¨èµ„æºæ—¶ï¼Œè¯·ä½¿ç”¨ Burstable Quality of Serviceï¼ˆè¯·æ±‚åŒ¹é…å®é™…å¹³å‡ä½¿ç”¨æƒ…å†µï¼‰ã€‚ å¦‚æœæ‚¨æœ‰ Web åº”ç”¨ç¨‹åºæˆ– REST APIï¼Œæ‚¨å¯èƒ½å¸Œæœ›ä½¿ç”¨ Burstable Quality of Serviceã€‚ é‚£å¦‚ä½•é€‰æ‹©æ­£ç¡®çš„è¯·æ±‚å’Œé™åˆ¶å€¼ï¼Ÿ ä½ åº”è¯¥åˆ†æåº”ç”¨ç¨‹åºå¹¶æµ‹é‡ç©ºé—²ã€è´Ÿè½½å’Œå³°å€¼æ—¶çš„å†…å­˜å’Œ CPU æ¶ˆè€—ã€‚æ›´ç›´æ¥çš„ç­–ç•¥åŒ…æ‹¬éƒ¨ç½² Vertical Pod Autoscaler å¹¶ç­‰å¾…å®ƒå»ºè®®æ­£ç¡®çš„å€¼ã€‚ Vertical Pod Autoscaler ä» Pod æ”¶é›†æ•°æ®å¹¶åº”ç”¨å›å½’æ¨¡å‹æ¥æ¨æ–­è¯·æ±‚å’Œé™åˆ¶ã€‚ æ‚¨å¯ä»¥åœ¨æœ¬æ–‡ä¸­äº†è§£æœ‰å…³å¦‚ä½•æ‰§è¡Œæ­¤æ“ä½œçš„æ›´å¤šä¿¡æ¯ã€‚ ","date":"2023-03-16","objectID":"/posts/a18401/:2:6","tags":["è‡ªåŠ¨ä¼¸ç¼©"],"title":"å¦‚ä½•é€‰æ‹©æœ€ä½³çš„Kubernetesé›†ç¾¤è‡ªåŠ¨ä¼¸ç¼©ç­–ç•¥","uri":"/posts/a18401/"},{"categories":["Kubernetes"],"content":"å…³äºé›†ç¾¤çš„ç¼©å®¹ æ¯ 10 ç§’ï¼Œåªæœ‰å½“è¯·æ±‚åˆ©ç”¨ç‡ä½äº 50% æ—¶ï¼ŒCluster Autoscaler æ‰ä¼šå†³å®šåˆ é™¤èŠ‚ç‚¹ã€‚ æ¢å¥è¯è¯´ï¼Œå¯¹äºåŒä¸€èŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰ Podï¼Œå®ƒä¼šæ±‡æ€» CPU å’Œå†…å­˜è¯·æ±‚ã€‚ å¦‚æœå®ƒä»¬ä½äºèŠ‚ç‚¹å®¹é‡çš„ä¸€åŠï¼ŒCluster Autoscaler å°†è€ƒè™‘å½“å‰èŠ‚ç‚¹è¿›è¡Œç¼©å‡ã€‚ å€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒCluster Autoscaler ä¸è€ƒè™‘å®é™…çš„ CPU å’Œå†…å­˜ä½¿ç”¨æˆ–é™åˆ¶ï¼Œè€ŒåªæŸ¥çœ‹èµ„æºè¯·æ±‚ã€‚ åœ¨ç§»é™¤èŠ‚ç‚¹ä¹‹å‰ï¼ŒCluster Autoscaler æ‰§è¡Œï¼š Pod æ£€æŸ¥ä»¥ç¡®ä¿ Pod å¯ä»¥ç§»åŠ¨åˆ°å…¶ä»–èŠ‚ç‚¹ã€‚ Node èŠ‚ç‚¹æ£€æŸ¥ä»¥é˜²æ­¢èŠ‚ç‚¹è¿‡æ—©è¢«ç ´åã€‚ å¦‚æœæ£€æŸ¥é€šè¿‡ï¼ŒCluster Autoscaler å°†ä»é›†ç¾¤ä¸­åˆ é™¤èŠ‚ç‚¹ã€‚ ","date":"2023-03-16","objectID":"/posts/a18401/:2:7","tags":["è‡ªåŠ¨ä¼¸ç¼©"],"title":"å¦‚ä½•é€‰æ‹©æœ€ä½³çš„Kubernetesé›†ç¾¤è‡ªåŠ¨ä¼¸ç¼©ç­–ç•¥","uri":"/posts/a18401/"},{"categories":["Kubernetes"],"content":"ä¸ºä»€ä¹ˆä¸åŸºäºå†…å­˜æˆ–CPUè¿›è¡Œè‡ªåŠ¨ä¼¸ç¼© åœ¨æ‰©ç¼©å®¹æ—¶ï¼ŒåŸºäº CPU æˆ–å†…å­˜çš„ Cluster Autoscaler ä¸å…³å¿ƒ podã€‚ æƒ³è±¡ä¸€ä¸‹ï¼Œæœ‰ä¸€ä¸ªåªæœ‰ä¸€ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤ï¼Œå¹¶è®¾ç½® Autoscaler æ¥æ·»åŠ ä¸€ä¸ªæ–°èŠ‚ç‚¹å½“ CPU ä½¿ç”¨ç‡è¾¾åˆ°æ€»å®¹é‡çš„ 80%ã€‚ ç„¶åä½ å†³å®šåˆ›å»ºä¸€ä¸ªå…·æœ‰ 3 ä¸ªå‰¯æœ¬çš„ Deploymentã€‚ä¸‰ä¸ª Pod çš„æ€»èµ„æºä½¿ç”¨ç‡è¾¾åˆ°äº† CPU çš„ 85%ã€‚ ä¸€ä¸ªæ–°çš„ Node èŠ‚ç‚¹è¢«æä¾›ã€‚å¦‚æœä½ ä¸éœ€è¦æ›´å¤š Pod æ€ä¹ˆåŠï¼Ÿä½ æœ‰ä¸€ä¸ªå®Œæ•´èŠ‚ç‚¹å¤„äºç©ºé—²çš„çŠ¶æ€â€”â€”è¿™ä¸æ˜¯å¾ˆå¥½ã€‚è¿™ç§ä½¿ç”¨ Autoscaler çš„æ–¹å¼æ˜¯ä¸é¼“åŠ±çš„ã€‚ ","date":"2023-03-16","objectID":"/posts/a18401/:2:8","tags":["è‡ªåŠ¨ä¼¸ç¼©"],"title":"å¦‚ä½•é€‰æ‹©æœ€ä½³çš„Kubernetesé›†ç¾¤è‡ªåŠ¨ä¼¸ç¼©ç­–ç•¥","uri":"/posts/a18401/"},{"categories":["Kubernetes"],"content":"æ€»ç»“ åœ¨ Kubernetes ä¸­å®šä¹‰å’Œå®æ–½æˆåŠŸçš„æ‰©ç¼©å®¹ç­–ç•¥éœ€è¦æ‚¨æŒæ¡å‡ ä¸ªä¸»é¢˜ï¼š ç†Ÿæ‚‰ Kubernetes èŠ‚ç‚¹ä¸­çš„å¯åˆ†é…èµ„æºã€‚ å¾®è°ƒ Metrics Serverã€Horizontal Pod Autoscaler å’Œ Cluster Autoscalers çš„åˆ·æ–°é—´éš”ã€‚ è§„åˆ’é›†ç¾¤å’ŒèŠ‚ç‚¹å®ä¾‹å¤§å°ã€‚ åšå¥½å®¹å™¨é•œåƒçš„ç¼“å­˜ã€‚ åšå¥½åº”ç”¨ç¨‹åºåŸºå‡†æµ‹è¯•å’Œåˆ†æã€‚ ä½†æ˜¯ä¸Šé¢è¿™äº›è¿˜ä¸å¤Ÿï¼Œä½ è¿˜éœ€è¦ä½¿ç”¨é€‚å½“çš„ç›‘æ§å·¥å…·ï¼Œåå¤æµ‹è¯•æ‚¨çš„æ‰©ç¼©å®¹ç­–ç•¥å¹¶è°ƒæ•´é›†ç¾¤çš„èŠ‚ç‚¹åˆ›å»ºé€Ÿåº¦å’Œæˆæœ¬ã€‚ https://cloudnative.to/blog/kubernetes-autoscaling-strategy/ ","date":"2023-03-16","objectID":"/posts/a18401/:3:0","tags":["è‡ªåŠ¨ä¼¸ç¼©"],"title":"å¦‚ä½•é€‰æ‹©æœ€ä½³çš„Kubernetesé›†ç¾¤è‡ªåŠ¨ä¼¸ç¼©ç­–ç•¥","uri":"/posts/a18401/"},{"categories":["sre"],"content":"1ï¼ŒSLA SLAæ˜¯Service-Level Agreementçš„ç¼©å†™ï¼Œæ„æ€æ˜¯æœåŠ¡ç­‰çº§åè®®ï¼Œä¸€èˆ¬æ˜¯åè®®åŒæ–¹åšçš„å½¼æ­¤æ‰¿è¯ºï¼Œæ”¾åœ¨è¿ç»´çš„é¢†åŸŸï¼Œå¾ˆé‡è¦çš„ä¸€ä¸ªç»“æœæŒ‡æ ‡å°±æ˜¯ç³»ç»Ÿçš„SLAï¼Œè¿™ä¸ªæ˜¯æŠ€æœ¯å‘ä¸šåŠ¡åšçš„ä¸€ä¸ªæ‰¿è¯ºã€‚ ç³»ç»ŸSLAçš„å®šåˆ¶æ–¹æ³•ä¸€èˆ¬æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯é€šè¿‡æ—¶é—´ç»´åº¦è¿›è¡Œæµ‹ç®—ï¼Œå¦å¤–ä¸€ç§æ˜¯é€šè¿‡ç”¨æˆ·è¯·æ±‚çŠ¶æ€è¿›è¡Œæµ‹ç®—ã€‚ æ—¶é—´ç»´åº¦æµ‹ç®— å…¬å¼ï¼š PSï¼šå¦‚æœå¹´åº¦SLAï¼Œåˆ™n=365 è¿™ç§è®¡ç®—æ–¹å¼æ¯”è¾ƒå¸¸è§„ï¼Œé€šç”¨ï¼Œä½†çœŸæ­£è¾ƒçœŸèµ·æ¥ï¼Œè¿˜æ˜¯æ¯”è¾ƒéº»çƒ¦çš„ï¼Œéº»çƒ¦çš„åœ°æ–¹ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š 1ï¼‰ï¼Œä¸šåŠ¡ä¸­æ–­æ€ä¹ˆåˆ¤æ–­ï¼Œé¡»çŸ¥ä¸€ä¸ªä¸šåŠ¡å®Œå…¨ä¸­æ–­çš„åœºæ™¯å¹¶ä¸å¤šè§ï¼Œå¾€å¾€æ˜¯å‡ºç°éƒ¨åˆ†ä¸šåŠ¡å—åˆ°å½±å“ã€‚ 2ï¼‰ï¼Œå¤æ‚ç»„ç»‡åœºæ™¯ä¸‹ï¼Œå¦‚ä½•åšè´£ä»»åˆ’åˆ†ï¼Œæ¯”å¦‚Aéƒ¨é—¨å¼•å‘çš„é—®é¢˜ï¼Œä½†Béƒ¨é—¨çš„å®¹é”™æ€§åšçš„ä¹Ÿä¸å¥½ï¼Œè¿™ç§æƒ…å†µAï¼ŒBçš„å„è‡ªSLAæ˜¯å¤šå°‘ï¼Ÿ 3ï¼‰ï¼Œæ—¶é—´åˆ†ç‰‡å¹¶ä¸æ˜¯å®Œå…¨ç­‰ä»·çš„ï¼Œä¸šåŠ¡é«˜å³°æ—¶çš„ä¸€ä¸ªå°æ—¶è¦æ¯”ä¸šåŠ¡ä½è°·å€¼é’±çš„å¤šï¼Œå¦‚æœæŒ‰ç…§åŒæ ·çš„æ—¶é—´å»è®¡ç®—ï¼Œå…¶å®æ˜¯æœ‰å¤±å…¬å…çš„ã€‚ é‰´äºä»¥ä¸Šç§ç§åŸå› ï¼Œåœ¨å…¬å¸SLAå®é™…è®¡ç®—ä¸­ï¼Œè®¡ç®—å…¬å¼ä¼šå˜å¾—éå¸¸å¤æ‚ï¼Œæ¯”è¾ƒå¸¸è§çš„ä¸€ç§å°±æ˜¯æ ¹æ®ä¸šåŠ¡è¿›è¡Œæ—¶é—´æ¢ç®—ï¼Œå…¬å¼ä¸ºï¼š PSï¼šå¦‚æœå¹´åº¦SLAï¼Œåˆ™n=365 ä¸¾ä¾‹ï¼š å¦‚æœä¸€å¤©çš„ä¸šåŠ¡é‡æ˜¯ä¸€ä¸‡å•ï¼Œä¸šåŠ¡æ—¶å‡ºç°æ•…éšœé«˜å³°ï¼ŒæŒç»­ä¸€ä¸ªå°æ—¶ï¼Œå½±å“1000å•ï¼Œé‚£ä¹ˆæ—¶é—´ä¸šåŠ¡å½±å“æ—¶é—´æ¢ç®—ä¸ºï¼š1000 / 10000 * 24 = 2.4ä¸ªå°æ—¶ï¼Œå½“å¤©çš„SLAä¸º 90%ï¼Œè€Œé95.8% è¿™ç§ç®—æ³•çš„ä¼˜ç‚¹æ˜¯ï¼š ç›´è§‚ï¼Œè®¡ç®—ç®€å•ï¼Œä¸šåŠ¡éƒ¨é—¨å®¹æ˜“ç†è§£ ç¼ºç‚¹æ˜¯ï¼š è¿™æ˜¯ä¸ªç»“æœæŒ‡æ ‡ï¼Œæ”¹è¿›æŒ‡å‘ä¸æ˜ç¡®ã€‚ ç”¨æˆ·è¯·æ±‚çŠ¶æ€æµ‹ç®— å…¬å¼ï¼š ä¸¾ä¾‹ï¼š å¦‚æœä¸€ä¸ªç³»ç»Ÿï¼Œç”¨æˆ·ä¸€å¤©è¯·æ±‚é‡ä¸º10000ï¼Œå…¶ä¸­5XXçš„è¯·æ±‚ä¸º1000ï¼Œé‚£ä¹ˆå½“å¤©çš„SLAä¸º90% ä¼˜ç‚¹ï¼š å¯ä»¥æœ‰é’ˆå¯¹æ€§çš„æ”¹è¿›ï¼Œåªè¦å¢åŠ è®¿é—®æˆåŠŸç‡å³å¯ ç¼ºç‚¹ï¼š ä¸šåŠ¡ä¸å®¹æ˜“ç†è§£ï¼Œåœ¨ä»€ä¹ˆäº‹è¯·æ±‚æˆåŠŸä¸Šå®¹æ˜“äº§ç”Ÿåˆ†æ­§ 2ï¼Œæ”¯æ’‘SLAçš„è¿ç»´æŒ‡æ ‡ SLAä¸€èˆ¬æˆ‘ä»¬å®šä¹‰ä¸ºç»“æœæŒ‡æ ‡ï¼Œä¹Ÿå°±æ˜¯åˆ°æœ€åä¸€åˆ»æ‰çŸ¥é“æ˜¯å¦æ­£å¸¸ï¼Œæ‰€ä»¥ä¸€èˆ¬éœ€è¦æœ‰ä¸€äº›è¿‡ç¨‹æŒ‡æ ‡è¿›è¡Œè·Ÿè¸ªï¼Œè¿™é‡Œç€é‡ä»‹ç»ä¸€ä¸‹è¿ç»´ä¾§æŒ‡æ ‡ï¼Œå¼€å‘ä¾§æ¯”è¾ƒç®€å•ï¼Œä¸åšè¯¦ç»†ä»‹ç» ä¸€çº§æŒ‡æ ‡ ä¸€çº§æŒ‡æ ‡ç›´æ¥æ‰¿è½½SLAï¼ŒæŒ‡æ ‡å¥½åï¼Œä¼šå¯¹SLAæœ‰ç›´æ¥å½±å“ 1ï¼‰ï¼Œæ•…éšœæ¬¡æ•°ï¼Œè¿™ä¸ªæ¯”è¾ƒç†è§£ï¼Œå°±æ˜¯æœ‰ä¸šåŠ¡å½±å“çš„å¼‚å¸¸æ¬¡æ•° 2ï¼‰ï¼Œæ•…éšœçš„å¹³å‡æ¢å¤æ—¶é—´ï¼Œä¸ºäº†é¿å…æŸå‡ ä¸ªæ•…éšœå¤„ç†æ—¶é—´è¿‡é•¿ï¼Œå¯¼è‡´æŒ‡æ ‡ä¸èƒ½åæ˜ çœŸå®æƒ…å†µï¼Œä¸€èˆ¬ä¼šé‡‡ç”¨P90ï¼ŒP95çš„æ•…éšœå¹³å‡æ¢å¤æ—¶é—´ 3ï¼‰ï¼ŒNåˆ†é’Ÿå†…çš„å¼‚å¸¸æ¢å¤æ¯”ä¾‹ï¼ŒNçš„å–å€¼å’Œå…¬å¸çš„æŠ€æœ¯èƒ½åŠ›å’Œå®é™…æƒ…å†µå®šï¼Œä»¥æ•…éšœä¸ºä¾‹ï¼Œä¸€èˆ¬æ˜¯30åˆ†é’Ÿèƒ½æ¢å¤å°±å·²ç»å¾ˆä¸é”™äº† äºŒçº§æŒ‡æ ‡ äºŒçº§æŒ‡æ ‡é—´æ¥æ‰¿è½½SLAï¼ŒæŒ‡æ ‡å¥½åä¼šå¯¹ä¸€çº§æŒ‡æ ‡æœ‰ç›´æ¥å½±å“ 1ï¼‰ï¼Œç”¨æˆ·æŠ¥éšœæ¯”ï¼Œæœ‰å¤šå°‘æ•…éšœæ˜¯ç”¨æˆ·å‘ç°çš„ï¼Œè€Œéç›‘æ§ç³»ç»Ÿå‘ç°çš„ 2ï¼‰ï¼Œè‡ªåŠ¨åŒ–å˜æ›´å æ¯”ï¼Œæ•°å­—è¯æ˜ï¼Œè‡ªåŠ¨åŒ–çš„å˜æ›´è´¨é‡è¦æ›´å¥½ä¸€äº› 3ï¼‰ï¼Œé—®é¢˜åŠæ—¶è§£å†³ç‡ï¼Œé—®é¢˜å•å°¤å…¶æ˜¯æ•…éšœäº§ç”Ÿçš„é—®é¢˜å•è§£å†³æ•ˆç‡ 4ï¼‰ï¼Œäº‹ä»¶åŠæ—¶è§£å†³ç‡ï¼Œäº‹ä»¶å•åŠæ—¶å¤„ç†æ•ˆç‡ 5ï¼‰ï¼Œå‘Šè­¦åŠæ—¶å¤„ç†ç‡ï¼Œè¿™ä¸ªæ˜¯æŠŠæ•…éšœæ§åˆ¶åœ¨èŒèŠ½ä¸­çš„å¾ˆæœ‰æ•ˆæ‰‹æ®µ 6ï¼‰ï¼Œç›‘æ§è¦†ç›–ç‡ï¼Œç”Ÿäº§é‡è¦çš„åº”ç”¨å’Œç»„ä»¶çš„ç›‘æ§è¦†ç›–ç¨‹åº¦ è¿™äº›æŒ‡æ ‡è®¡ç®—å…¬å¼æ¯”è¾ƒç®€å•ï¼Œè¿™é‡Œä¸èµ˜è¿°ã€‚ ","date":"2023-03-08","objectID":"/posts/3e3c43/:0:0","tags":["sla"],"title":"SLAå’Œè¿ç»´æŒ‡æ ‡","uri":"/posts/3e3c43/"},{"categories":["openebs"],"content":"CStor å­˜å‚¨ç­–ç•¥ ","date":"2023-03-03","objectID":"/posts/4df4f1/:1:0","tags":["openebs","cstor"],"title":"OpenEBS-CStorä½¿ç”¨æŒ‡å—","uri":"/posts/4df4f1/"},{"categories":["openebs"],"content":"ç›®æ ‡èŠ‚ç‚¹ nodeSelector cat \u003c\u003c EOF | kubectl apply -f - apiVersion: cstor.openebs.io/v1 kind: CStorVolumePolicy metadata: name: csi-volume-policy namespace: openebs spec: target: nodeSelector: biz.type: test EOF ","date":"2023-03-03","objectID":"/posts/4df4f1/:1:1","tags":["openebs","cstor"],"title":"OpenEBS-CStorä½¿ç”¨æŒ‡å—","uri":"/posts/4df4f1/"},{"categories":["openebs"],"content":"ç›®æ ‡èŠ‚ç‚¹äº²å’Œè¡Œ affinity apiVersion: cstor.openebs.io/v1 kind: CStorVolumePolicy metadata: name: csi-volume-policy namespace: openebs spec: target: affinity: requiredDuringSchedulingIgnoredDuringExecution: - labelSelector: matchExpressions: - key: openebs.io/target-affinity operator: In values: - fio-cstor // application-unique-label topologyKey: kubernetes.io/hostname namespaces: [\"default\"] ","date":"2023-03-03","objectID":"/posts/4df4f1/:1:2","tags":["openebs","cstor"],"title":"OpenEBS-CStorä½¿ç”¨æŒ‡å—","uri":"/posts/4df4f1/"},{"categories":["openebs"],"content":"ç›®æ ‡èŠ‚ç‚¹èµ„æºé™åˆ¶ resources apiVersion: cstor.openebs.io/v1 kind: CStorVolumePolicy metadata: name: csi-volume-policy namespace: openebs spec: target: resources: requests: memory: \"64Mi\" cpu: \"250m\" limits: memory: \"128Mi\" cpu: \"500m\" auxResources: requests: memory: \"64Mi\" cpu: \"250m\" limits: memory: \"128Mi\" cpu: \"500m\" ","date":"2023-03-03","objectID":"/posts/4df4f1/:1:3","tags":["openebs","cstor"],"title":"OpenEBS-CStorä½¿ç”¨æŒ‡å—","uri":"/posts/4df4f1/"},{"categories":["openebs"],"content":"ç›®æ ‡èŠ‚ç‚¹æ±¡ç‚¹ tolerations apiVersion: cstor.openebs.io/v1 kind: CStorVolumePolicy metadata: name: csi-volume-policy namespace: openebs spec: replica: {} target: tolerations: - key: \"key1\" operator: \"Equal\" value: \"value1\" effect: \"NoSchedule\" ","date":"2023-03-03","objectID":"/posts/4df4f1/:1:4","tags":["openebs","cstor"],"title":"OpenEBS-CStorä½¿ç”¨æŒ‡å—","uri":"/posts/4df4f1/"},{"categories":["äº‘åŸç”Ÿ"],"content":"æœ¬æ–‡ä¸è®²æºç ï¼Œæ¥è¯´è¯´ istio sidecar é…ç½®ï¼Œä»è€Œçµæ´»çš„æ§åˆ¶ sidecar æ³¨å…¥ã€èµ„æºä¿®æ”¹ç­‰åœºæ™¯ã€‚ kubectl get cm -n istio-system istio-sidecar-injector -o yaml å…ˆæ¥é¢„è§ˆä¸€ä¸‹ istio-sidecar-injectorï¼Œä¸»è¦åŒ…å« config å’Œ values ","date":"2023-02-24","objectID":"/posts/aaad19/:0:0","tags":["istio","sidecars"],"title":"æ·±å…¥Istioç³»åˆ—-Sidecaré…ç½®æ¨¡æ¿","uri":"/posts/aaad19/"},{"categories":["äº‘åŸç”Ÿ"],"content":"config å¯ä»¥çœ‹åˆ°é…ç½®é¡¹æœ‰ é»˜è®¤æ¨¡æ¿ defaultTemplatesã€æ³¨å…¥ç­–ç•¥ policyã€æ³¨å…¥é€‰æ‹©å™¨ alwaysInjectSelectorã€ æ°¸ä¸æ³¨å…¥é€‰æ‹©å™¨ neverInjectSelectorã€injectedAnnotations å’Œ æ¨¡æ¿å†…å®¹ templates ç­‰ å…³äºæ³¨å…¥ç­–ç•¥(policy)ã€æ³¨å…¥é€‰æ‹©å™¨(alwaysInjectSelectorã€neverInjectSelector)å’Œæ³¨å…¥æ³¨è§£(injectedAnnotations)å¯ä»¥æŸ¥çœ‹ Sidecar è‡ªåŠ¨æ³¨å…¥ æœ¬æ–‡ä¸»è¦æ¥äº†è§£ Sidecar æ³¨å…¥çš„æ¨¡æ¿ï¼Œæ–¹ä¾¿åç»­éœ€è¦é’ˆå¯¹Sidecar çš„éƒ¨ç½²è°ƒæ•´ ","date":"2023-02-24","objectID":"/posts/aaad19/:1:0","tags":["istio","sidecars"],"title":"æ·±å…¥Istioç³»åˆ—-Sidecaré…ç½®æ¨¡æ¿","uri":"/posts/aaad19/"},{"categories":["äº‘åŸç”Ÿ"],"content":"templates - sidecar istio é»˜è®¤æä¾›äº†4ç§ä¸åŒçš„æ³¨å…¥æ¨¡æ¿ sidecarã€gatewayã€grpc-simple å’Œ grpc-agent,åŸºæœ¬ä¸Šéƒ½æ˜¯å¤§åŒå°å¼‚ã€‚æ¥ä¸‹æ¥ä¸»è¦çœ‹çœ‹sidecarè¿™ä¸ªæ¨¡æ¿é…ç½®äº†å“ªäº›ã€‚ ","date":"2023-02-24","objectID":"/posts/aaad19/:2:0","tags":["istio","sidecars"],"title":"æ·±å…¥Istioç³»åˆ—-Sidecaré…ç½®æ¨¡æ¿","uri":"/posts/aaad19/"},{"categories":["äº‘åŸç”Ÿ"],"content":"é€šè¿‡ Annotations çµæ´»æ§åˆ¶ä¸åŒéƒ¨ç½²çš„èµ„æºé™åˆ¶ template: metadata: annotations: ... sidecar.istio.io/proxyCPU: 50m ## proxy CPU request sidecar.istio.io/proxyCPULimit: 2000m ## proxy CPU limit sidecar.istio.io/proxyMemory: 500Mi ## proxy memory request sidecar.istio.io/proxyMemoryLimit: 2Gi ## proxy memory limit ... ","date":"2023-02-24","objectID":"/posts/aaad19/:2:1","tags":["istio","sidecars"],"title":"æ·±å…¥Istioç³»åˆ—-Sidecaré…ç½®æ¨¡æ¿","uri":"/posts/aaad19/"},{"categories":["äº‘åŸç”Ÿ"],"content":"ä¿®æ”¹éƒ¨ç½²çš„proxyé•œåƒ template: metadata: annotations: ... sidecar.istio.io/proxyImage: aeraki/meta-protocol-proxy:1.1.2 ... ","date":"2023-02-24","objectID":"/posts/aaad19/:2:2","tags":["istio","sidecars"],"title":"æ·±å…¥Istioç³»åˆ—-Sidecaré…ç½®æ¨¡æ¿","uri":"/posts/aaad19/"},{"categories":["äº‘åŸç”Ÿ"],"content":"ä¿®æ”¹éƒ¨ç½²çš„proxy åˆå§‹åŒ–é…ç½® template: metadata: annotations: ... sidecar.istio.io/bootstrapOverride: aeraki-bootstrap-config ... ä»¥ä¸‹æ“ä½œå…¨å±€ç”Ÿæ•ˆ ","date":"2023-02-24","objectID":"/posts/aaad19/:2:3","tags":["istio","sidecars"],"title":"æ·±å…¥Istioç³»åˆ—-Sidecaré…ç½®æ¨¡æ¿","uri":"/posts/aaad19/"},{"categories":["äº‘åŸç”Ÿ"],"content":"ä¿®æ”¹ç¯å¢ƒå˜é‡ kubectl edit cm -n istio-system istio-sidecar-injector env: {{- if eq (env \"PILOT_ENABLE_INBOUND_PASSTHROUGH\" \"true\") \"false\" }} - name: REWRITE_PROBE_LEGACY_LOCALHOST_DESTINATION value: \"true\" {{- end }} - name: JWT_POLICY value: {{ .Values.global.jwtPolicy }} - name: PILOT_CERT_PROVIDER value: {{ .Values.global.pilotCertProvider }} - name: CA_ADDR {{- if .Values.global.caAddress }} value: {{ .Values.global.caAddress }} {{- else }} value: istiod{{- if not (eq .Values.revision \"\") }}-{{ .Values.revision }}{{- end }}.{{ .Values.global.istioNamespace }}.svc:15012 {{- end }} - name: POD_NAME valueFrom: fieldRef: fieldPath: metadata.name ","date":"2023-02-24","objectID":"/posts/aaad19/:2:4","tags":["istio","sidecars"],"title":"æ·±å…¥Istioç³»åˆ—-Sidecaré…ç½®æ¨¡æ¿","uri":"/posts/aaad19/"},{"categories":["sentry"],"content":"ç³»åˆ— 1 åˆ†é’Ÿå¿«é€Ÿä½¿ç”¨ Docker ä¸Šæ‰‹æœ€æ–°ç‰ˆ Sentry-CLI - åˆ›å»ºç‰ˆæœ¬ å¿«é€Ÿä½¿ç”¨ Docker ä¸Šæ‰‹ Sentry-CLI - 30 ç§’ä¸Šæ‰‹ Source Maps Sentry For React å®Œæ•´æ¥å…¥è¯¦è§£ Sentry For Vue å®Œæ•´æ¥å…¥è¯¦è§£ Sentry-CLI ä½¿ç”¨è¯¦è§£ Sentry Web æ€§èƒ½ç›‘æ§ - Web Vitals Sentry Web æ€§èƒ½ç›‘æ§ - Metrics Sentry Web æ€§èƒ½ç›‘æ§ - Trends Sentry Web å‰ç«¯ç›‘æ§ - æœ€ä½³å®è·µ(å®˜æ–¹æ•™ç¨‹) Sentry åç«¯ç›‘æ§ - æœ€ä½³å®è·µ(å®˜æ–¹æ•™ç¨‹) Sentry ç›‘æ§ - Discover å¤§æ•°æ®æŸ¥è¯¢åˆ†æå¼•æ“ Sentry ç›‘æ§ - Dashboards æ•°æ®å¯è§†åŒ–å¤§å± Sentry ç›‘æ§ - Environments åŒºåˆ†ä¸åŒéƒ¨ç½²ç¯å¢ƒçš„äº‹ä»¶æ•°æ® Sentry ç›‘æ§ - Security Policy å®‰å…¨ç­–ç•¥æŠ¥å‘Š Sentry ç›‘æ§ - Search æœç´¢æŸ¥è¯¢å®æˆ˜ Sentry ç›‘æ§ - Alerts å‘Šè­¦ Sentry ç›‘æ§ - Distributed Tracing åˆ†å¸ƒå¼è·Ÿè¸ª Sentry ç›‘æ§ - é¢å‘å…¨æ ˆå¼€å‘äººå‘˜çš„åˆ†å¸ƒå¼è·Ÿè¸ª 101 ç³»åˆ—æ•™ç¨‹(ä¸€) Sentry ç›‘æ§ - Snuba æ•°æ®ä¸­å°æ¶æ„ç®€ä»‹(Kafka+Clickhouse) Sentry ç›‘æ§ - Snuba æ•°æ®ä¸­å°æ¶æ„(Data Model ç®€ä»‹) Sentry ç›‘æ§ - Snuba æ•°æ®ä¸­å°æ¶æ„(Query Processing ç®€ä»‹) Sentry å®˜æ–¹ JavaScript SDK ç®€ä»‹ä¸è°ƒè¯•æŒ‡å— Sentry ç›‘æ§ - Snuba æ•°æ®ä¸­å°æ¶æ„(ç¼–å†™å’Œæµ‹è¯• Snuba æŸ¥è¯¢) Sentry ç›‘æ§ - Snuba æ•°æ®ä¸­å°æ¶æ„(SnQL æŸ¥è¯¢è¯­è¨€ç®€ä»‹) ","date":"2023-01-03","objectID":"/posts/ac8605/:1:0","tags":["snuba"],"title":"Sentry ç›‘æ§ - Snuba æ•°æ®ä¸­å°æœ¬åœ°å¼€å‘ç¯å¢ƒé…ç½®å®æˆ˜","uri":"/posts/ac8605/"},{"categories":["sentry"],"content":"å…‹éš†ä»“åº“ åˆ†åˆ«å…‹éš† getsentry/sentry ä¸ getsentry/snubaï¼š git clone https://github.com/getsentry/sentry.git git clone https://github.com/getsentry/snuba.git ","date":"2023-01-03","objectID":"/posts/ac8605/:2:0","tags":["snuba"],"title":"Sentry ç›‘æ§ - Snuba æ•°æ®ä¸­å°æœ¬åœ°å¼€å‘ç¯å¢ƒé…ç½®å®æˆ˜","uri":"/posts/ac8605/"},{"categories":["sentry"],"content":"å®‰è£…ç³»ç»Ÿä¾èµ–(ä»¥ Mac ä¸ºä¾‹) ","date":"2023-01-03","objectID":"/posts/ac8605/:3:0","tags":["snuba"],"title":"Sentry ç›‘æ§ - Snuba æ•°æ®ä¸­å°æœ¬åœ°å¼€å‘ç¯å¢ƒé…ç½®å®æˆ˜","uri":"/posts/ac8605/"},{"categories":["sentry"],"content":"Xcode CLI tools xcode-select --install ","date":"2023-01-03","objectID":"/posts/ac8605/:3:1","tags":["snuba"],"title":"Sentry ç›‘æ§ - Snuba æ•°æ®ä¸­å°æœ¬åœ°å¼€å‘ç¯å¢ƒé…ç½®å®æˆ˜","uri":"/posts/ac8605/"},{"categories":["sentry"],"content":"Brewfile è¿›å…¥ sentry æ–‡ä»¶å¤¹ï¼Œä½ ä¼šçœ‹åˆ°ä¸€ä¸ª Brewfile æ–‡ä»¶ï¼š cd sentry Brewfile # required to run devservices cask 'docker' brew 'pyenv' # required for pyenv's python-build brew 'openssl' brew 'readline' # required for yarn test -u brew 'watchman' # required to build some of sentry's dependencies brew 'pkgconfig' brew 'libxslt' brew 'libxmlsec1' brew 'geoip' # Currently needed because on Big Sur there's no wheel for it brew 'librdkafka' # direnv isn't defined here, because we have it configured to check for a bootstrapped environment. # If it's installed in the early steps of the setup process, it just leads to confusion. # brew 'direnv' tap 'homebrew/cask' # required for acceptance testing cask 'chromedriver' å¦‚æœä½ æœ¬åœ°å·²ç»å®‰è£…äº† Docker Desktop å¹¶ä¸”å·²ç»å¯åŠ¨ï¼Œå¯ä»¥æŠŠ cask 'docker' æ³¨é‡Šæ‰ã€‚ æ¥ä¸‹æ¥ï¼Œè¿è¡Œï¼š brew bundle --verbose å¦‚æœä½ ä¹‹å‰æœ¬åœ°æ²¡æœ‰ Docker Desktopï¼Œåˆ™è¿˜éœ€è¦æ‰‹åŠ¨å¯åŠ¨ä¸€ä¸‹å®ƒï¼š open -g -a Docker.app ","date":"2023-01-03","objectID":"/posts/ac8605/:3:2","tags":["snuba"],"title":"Sentry ç›‘æ§ - Snuba æ•°æ®ä¸­å°æœ¬åœ°å¼€å‘ç¯å¢ƒé…ç½®å®æˆ˜","uri":"/posts/ac8605/"},{"categories":["sentry"],"content":"æ„å»ºå·¥å…·é“¾ Sentry ä¾èµ–äº Python Wheels(åŒ…å«äºŒè¿›åˆ¶æ‰©å±•æ¨¡å—çš„åŒ…)ï¼Œå®˜æ–¹ä¸ºä»¥ä¸‹å¹³å°åˆ†å‘ï¼š Linux å…¼å®¹ PEP-513 (manylinux1) macOS 10.15 æˆ–æ›´é«˜ç‰ˆæœ¬ å¦‚æœæ‚¨çš„å¼€å‘æœºå™¨æ²¡æœ‰è¿è¡Œä¸Šè¿°ç³»ç»Ÿä¹‹ä¸€ï¼Œåˆ™éœ€è¦å®‰è£… Rust å·¥å…·é“¾ã€‚ æŒ‰ç…§ https://www.rust-lang.org/tools/install ä¸Šçš„è¯´æ˜å®‰è£…ç¼–è¯‘å™¨å’Œç›¸å…³å·¥å…·ã€‚å®‰è£…åï¼ŒSentry å®‰è£…ç¨‹åºå°†è‡ªåŠ¨ä½¿ç”¨ Rust æ„å»ºæ‰€æœ‰äºŒè¿›åˆ¶æ¨¡å—ï¼Œæ— éœ€é¢å¤–é…ç½®ã€‚ å®˜æ–¹é€šå¸¸ä¼šè·Ÿè¸ªæœ€æ–°çš„ç¨³å®š Rust ç‰ˆæœ¬ï¼Œè¯¥ç‰ˆæœ¬æ¯å…­å‘¨æ›´æ–°ä¸€æ¬¡ã€‚ å› æ­¤ï¼Œè¯·ç¡®ä¿é€šè¿‡å¶å°”è¿è¡Œæ¥ä½¿æ‚¨çš„ Rust å·¥å…·é“¾ä¿æŒæœ€æ–°ï¼š rustup update stable ","date":"2023-01-03","objectID":"/posts/ac8605/:4:0","tags":["snuba"],"title":"Sentry ç›‘æ§ - Snuba æ•°æ®ä¸­å°æœ¬åœ°å¼€å‘ç¯å¢ƒé…ç½®å®æˆ˜","uri":"/posts/ac8605/"},{"categories":["sentry"],"content":"Python Sentry ä½¿ç”¨ pyenv æ¥å®‰è£…å’Œç®¡ç† Python ç‰ˆæœ¬ã€‚ å®ƒæ˜¯åœ¨æ‚¨è¿è¡Œ brew bundle æ—¶å®‰è£…çš„ã€‚ è¦å®‰è£…æ‰€éœ€ç‰ˆæœ¬çš„ Pythonï¼Œæ‚¨éœ€è¦è¿è¡Œä»¥ä¸‹å‘½ä»¤ã€‚ è¿™å°†éœ€è¦ä¸€æ®µæ—¶é—´ï¼Œå› ä¸ºæ‚¨çš„è®¡ç®—æœºå®é™…ä¸Šæ­£åœ¨ç¼–è¯‘ Pythonï¼ make setup-pyenv è¿™é‡Œå‡è®¾ä½ æ˜¯ Zsh ç”¨æˆ·ã€‚ å¦‚æœæ‚¨é”®å…¥ which pythonï¼Œæ‚¨åº”è¯¥çœ‹åˆ°ç±»ä¼¼ $HOME/.pyenv/shims/python è€Œä¸æ˜¯ /usr/bin/python çš„å†…å®¹ã€‚è¿™æ˜¯å› ä¸ºä»¥ä¸‹å†…å®¹å·²æ·»åŠ åˆ°æ‚¨çš„å¯åŠ¨è„šæœ¬ä¸­ï¼š cat ~/.zprofileï¼Œä½ ä¼šçœ‹åˆ°å¦‚ä¸‹å†…å®¹ï¼š # MacPorts Installer addition on 2021-10-20_at_11:48:22: adding an appropriate PATH variable for use with MacPorts. export PATH=\"/opt/local/bin:/opt/local/sbin:$PATH\" # Finished adapting your PATH environment variable for use with MacPorts. # It is assumed that pyenv is installed via Brew, so this is all we need to do. eval \"$(pyenv init --path)\" ","date":"2023-01-03","objectID":"/posts/ac8605/:5:0","tags":["snuba"],"title":"Sentry ç›‘æ§ - Snuba æ•°æ®ä¸­å°æœ¬åœ°å¼€å‘ç¯å¢ƒé…ç½®å®æˆ˜","uri":"/posts/ac8605/"},{"categories":["sentry"],"content":"è™šæ‹Ÿç¯å¢ƒ æ‚¨ç°åœ¨å·²å‡†å¤‡å¥½åˆ›å»º Python è™šæ‹Ÿç¯å¢ƒã€‚è¿è¡Œï¼š python -m venv .venv å¹¶æ¿€æ´»è™šæ‹Ÿç¯å¢ƒï¼š source .venv/bin/activate å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œè¿è¡Œ which python ç°åœ¨åº”è¯¥ä¼šå¯¼è‡´ç±»ä¼¼ /Users/you/sentry/.venv/bin/python çš„ç»“æœã€‚ ","date":"2023-01-03","objectID":"/posts/ac8605/:5:1","tags":["snuba"],"title":"Sentry ç›‘æ§ - Snuba æ•°æ®ä¸­å°æœ¬åœ°å¼€å‘ç¯å¢ƒé…ç½®å®æˆ˜","uri":"/posts/ac8605/"},{"categories":["sentry"],"content":"Snuba é…ç½®å®æˆ˜ ","date":"2023-01-03","objectID":"/posts/ac8605/:6:0","tags":["snuba"],"title":"Sentry ç›‘æ§ - Snuba æ•°æ®ä¸­å°æœ¬åœ°å¼€å‘ç¯å¢ƒé…ç½®å®æˆ˜","uri":"/posts/ac8605/"},{"categories":["sentry"],"content":"å¯åŠ¨ Snuba ç›¸å…³ä¾èµ–é¡¹å®¹å™¨ cd ../sentry git checkout master git pull source .venv/bin/activate sentry devservices up --exclude=snuba # 11:17:59 [WARNING] sentry.utils.geo: settings.GEOIP_PATH_MMDB not configured. # 11:18:01 [INFO] sentry.plugins.github: apps-not-configured # \u003e Pulling image 'postgres:9.6-alpine' # \u003e Pulling image 'yandex/clickhouse-server:20.3.9.70' # \u003e Not starting container 'sentry_relay' because it should be started on-demand with devserver. # \u003e Creating 'sentry_redis' volume # \u003e Creating 'sentry_zookeeper_6' volume # \u003e Creating 'sentry_kafka_6' volume # \u003e Creating container 'sentry_redis' # \u003e Creating container 'sentry_zookeeper' # \u003e Creating container 'sentry_kafka' # \u003e Starting container 'sentry_redis' (listening: ('127.0.0.1', 6379)) # \u003e Starting container 'sentry_kafka' (listening: ('127.0.0.1', 9092)) # \u003e Starting container 'sentry_zookeeper' # \u003e Creating 'sentry_clickhouse' volume # \u003e Creating container 'sentry_clickhouse' # \u003e Creating 'sentry_postgres' volume # \u003e Creating 'sentry_wal2json' volume # \u003e Starting container 'sentry_clickhouse' (listening: ('127.0.0.1', 9000), ('127.0.0.1', 9009), ('127.0.0.1', 8123)) # \u003e Creating container 'sentry_postgres' # \u003e Starting container 'sentry_postgres' (listening: ('127.0.0.1', 5432)) è¿™å°†åœ¨ master ä¸Šè·å–æœ€æ–°ç‰ˆæœ¬çš„ Sentryï¼Œå¹¶è°ƒå‡ºæ‰€æœ‰ snuba çš„ä¾èµ–é¡¹ã€‚ Snuba ä¸»è¦ä¾èµ– clickhouseï¼Œzookeeperï¼Œkafkaï¼Œredis ç›¸å…³å®¹å™¨ã€‚ docker ps æŸ¥çœ‹ä¸€ä¸‹ï¼š 1149a6f6ff23 postgres:9.6-alpine \"docker-entrypoint.sâ€¦\" 3 minutes ago Up 3 minutes 127.0.0.1:5432-\u003e5432/tcp sentry_postgres a7f3af7d52bb yandex/clickhouse-server:20.3.9.70 \"/entrypoint.sh\" 3 minutes ago Up 3 minutes 127.0.0.1:8123-\u003e8123/tcp, 127.0.0.1:9000-\u003e9000/tcp, 127.0.0.1:9009-\u003e9009/tcp sentry_clickhouse 68913ee15c43 confluentinc/cp-zookeeper:6.2.0 \"/etc/confluent/dockâ€¦\" 3 minutes ago Up 3 minutes 2181/tcp, 2888/tcp, 3888/tcp sentry_zookeeper 5a248eb26ed3 confluentinc/cp-kafka:6.2.0 \"/etc/confluent/dockâ€¦\" 3 minutes ago Up 3 minutes 127.0.0.1:9092-\u003e9092/tcp sentry_kafka 0573aff7b5af redis:5.0-alpine \"docker-entrypoint.sâ€¦\" 3 minutes ago Up 3 minutes 127.0.0.1:6379-\u003e6379/tcp sentry_redis ","date":"2023-01-03","objectID":"/posts/ac8605/:6:1","tags":["snuba"],"title":"Sentry ç›‘æ§ - Snuba æ•°æ®ä¸­å°æœ¬åœ°å¼€å‘ç¯å¢ƒé…ç½®å®æˆ˜","uri":"/posts/ac8605/"},{"categories":["sentry"],"content":"è®¾ç½® Snuba è™šæ‹Ÿç¯å¢ƒ cd snuba make pyenv-setup python -m venv .venv source .venv/bin/activate pip install --upgrade pip==21.1.3 make develop ","date":"2023-01-03","objectID":"/posts/ac8605/:6:2","tags":["snuba"],"title":"Sentry ç›‘æ§ - Snuba æ•°æ®ä¸­å°æœ¬åœ°å¼€å‘ç¯å¢ƒé…ç½®å®æˆ˜","uri":"/posts/ac8605/"},{"categories":["sentry"],"content":"æŸ¥çœ‹è¿ç§»åˆ—è¡¨ snuba migrations list # system # [ ] 0001_migrations # # events # [ ] 0001_events_initial # [ ] 0002_events_onpremise_compatibility # [ ] 0003_errors # [ ] 0004_errors_onpremise_compatibility # [ ] 0005_events_tags_hash_map (blocking) # [ ] 0006_errors_tags_hash_map (blocking) # [ ] 0007_groupedmessages # [ ] 0008_groupassignees # [ ] 0009_errors_add_http_fields # [ ] 0010_groupedmessages_onpremise_compatibility (blocking) # [ ] 0011_rebuild_errors # [ ] 0012_errors_make_level_nullable # [ ] 0013_errors_add_hierarchical_hashes # [ ] 0014_backfill_errors (blocking) # [ ] 0015_truncate_events # # transactions # [ ] 0001_transactions # [ ] 0002_transactions_onpremise_fix_orderby_and_partitionby (blocking) # [ ] 0003_transactions_onpremise_fix_columns (blocking) # [ ] 0004_transactions_add_tags_hash_map (blocking) # [ ] 0005_transactions_add_measurements # [ ] 0006_transactions_add_http_fields # [ ] 0007_transactions_add_discover_cols # [ ] 0008_transactions_add_timestamp_index # [ ] 0009_transactions_fix_title_and_message # [ ] 0010_transactions_nullable_trace_id # [ ] 0011_transactions_add_span_op_breakdowns # [ ] 0012_transactions_add_spans # # discover # [ ] 0001_discover_merge_table # [ ] 0002_discover_add_deleted_tags_hash_map # [ ] 0003_discover_fix_user_column # [ ] 0004_discover_fix_title_and_message # [ ] 0005_discover_fix_transaction_name # [ ] 0006_discover_add_trace_id # [ ] 0007_discover_add_span_id # # outcomes # [ ] 0001_outcomes # [ ] 0002_outcomes_remove_size_and_bytes # [ ] 0003_outcomes_add_category_and_quantity # [ ] 0004_outcomes_matview_additions (blocking) # # metrics # [ ] 0001_metrics_buckets # [ ] 0002_metrics_sets # [ ] 0003_counters_to_buckets # [ ] 0004_metrics_counters # [ ] 0005_metrics_distributions_buckets # [ ] 0006_metrics_distributions # [ ] 0007_metrics_sets_granularity_10 # [ ] 0008_metrics_counters_granularity_10 # [ ] 0009_metrics_distributions_granularity_10 # [ ] 0010_metrics_sets_granularity_1h # [ ] 0011_metrics_counters_granularity_1h # [ ] 0012_metrics_distributions_granularity_1h # [ ] 0013_metrics_sets_granularity_1d # [ ] 0014_metrics_counters_granularity_1d # [ ] 0015_metrics_distributions_granularity_1d # # sessions # [ ] 0001_sessions # [ ] 0002_sessions_aggregates # [ ] 0003_sessions_matview ","date":"2023-01-03","objectID":"/posts/ac8605/:6:3","tags":["snuba"],"title":"Sentry ç›‘æ§ - Snuba æ•°æ®ä¸­å°æœ¬åœ°å¼€å‘ç¯å¢ƒé…ç½®å®æˆ˜","uri":"/posts/ac8605/"},{"categories":["sentry"],"content":"è¿è¡Œè¿ç§» snuba migrations migrate --force # ...... # 2021-12-01 19:45:57,557 Running migration: 0014_metrics_counters_granularity_1d # 2021-12-01 19:45:57,575 Finished: 0014_metrics_counters_granularity_1d # 2021-12-01 19:45:57,589 Running migration: 0015_metrics_distributions_granularity_1d # 2021-12-01 19:45:57,610 Finished: 0015_metrics_distributions_granularity_1d # 2021-12-01 19:45:57,623 Running migration: 0001_sessions # 2021-12-01 19:45:57,656 Finished: 0001_sessions # 2021-12-01 19:45:57,669 Running migration: 0002_sessions_aggregates # 2021-12-01 19:45:57,770 Finished: 0002_sessions_aggregates # 2021-12-01 19:45:57,792 Running migration: 0003_sessions_matview # 2021-12-01 19:45:57,849 Finished: 0003_sessions_matview # Finished running migrations ","date":"2023-01-03","objectID":"/posts/ac8605/:6:4","tags":["snuba"],"title":"Sentry ç›‘æ§ - Snuba æ•°æ®ä¸­å°æœ¬åœ°å¼€å‘ç¯å¢ƒé…ç½®å®æˆ˜","uri":"/posts/ac8605/"},{"categories":["sentry"],"content":"æ£€æŸ¥è¿ç§» è¿›å…¥ Clickhouse å®¹å™¨ï¼š docker exec -it sentry_clickhouse clickhouse-client # è¿è¡Œå¦‚ä¸‹ `sql` è¯­å¥ï¼š select count() from sentry_local # ClickHouse client version 20.3.9.70 (official build). # Connecting to localhost:9000 as user default. # Connected to ClickHouse server version 20.3.9 revision 54433. # a7f3af7d52bb :) select count() from sentry_local # SELECT count() # FROM sentry_local # â”Œâ”€count()â”€â” # â”‚ 0 â”‚ # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ # 1 rows in set. Elapsed: 0.008 sec. # a7f3af7d52bb :) ","date":"2023-01-03","objectID":"/posts/ac8605/:6:5","tags":["snuba"],"title":"Sentry ç›‘æ§ - Snuba æ•°æ®ä¸­å°æœ¬åœ°å¼€å‘ç¯å¢ƒé…ç½®å®æˆ˜","uri":"/posts/ac8605/"},{"categories":["sentry"],"content":"æŸ¥çœ‹ç›¸å…³å®ä½“æ•°æ®é›† snuba entities list # Declared Entities: # discover # events # groups # groupassignee # groupedmessage # metrics_sets # metrics_counters # metrics_distributions # outcomes # outcomes_raw # sessions # org_sessions # spans # transactions # discover_transactions # discover_events ","date":"2023-01-03","objectID":"/posts/ac8605/:6:6","tags":["snuba"],"title":"Sentry ç›‘æ§ - Snuba æ•°æ®ä¸­å°æœ¬åœ°å¼€å‘ç¯å¢ƒé…ç½®å®æˆ˜","uri":"/posts/ac8605/"},{"categories":["sentry"],"content":"å¯åŠ¨å¼€å‘æœåŠ¡å™¨ æ­¤å‘½ä»¤å°†å¯åŠ¨ api å’Œæ‰€æœ‰ Snuba æ¶ˆè´¹è€…ä»¥ä» Kafka æ‘„å–æ•°æ®ï¼š snuba devserver è½¬åˆ° http://localhost:1218/events/snqlï¼Œä½ å°†ä¼šçœ‹åˆ°ä¸€ä¸ªç®€æ˜“çš„æŸ¥è¯¢ UIã€‚ sentryå¼€å‘ç¯å¢ƒ ","date":"2023-01-03","objectID":"/posts/ac8605/:6:7","tags":["snuba"],"title":"Sentry ç›‘æ§ - Snuba æ•°æ®ä¸­å°æœ¬åœ°å¼€å‘ç¯å¢ƒé…ç½®å®æˆ˜","uri":"/posts/ac8605/"},{"categories":[],"content":"åˆ›å»º aws IAMæƒé™ https://github.com/kubernetes-sigs/aws-ebs-csi-driver/blob/v1.13.0/docs/example-iam-policy.json è·å–AKã€SK ","date":"2022-12-30","objectID":"/posts/4842bb/:0:1","tags":[],"title":"è‡ªå»ºk8séƒ¨ç½²aws-ebs-csi-driver","uri":"/posts/4842bb/"},{"categories":[],"content":"éƒ¨ç½²aws-ebs-csi-driver kubectl create secret generic aws-secret \\ --namespace kube-system \\ --from-literal \"key_id=${AWS_ACCESS_KEY_ID}\" \\ --from-literal \"access_key=${AWS_SECRET_ACCESS_KEY}\" `` ```yaml # helm repo add aws-ebs-csi-driver https://kubernetes-sigs.github.io/aws-ebs-csi-driver # helm upgrade --install aws-ebs-csi-driver --version 2.13.0\\ --namespace kube-system \\ aws-ebs-csi-driver/aws-ebs-csi-driver \\ --set sidecars.provisioner.image.repository=registry.cn-hangzhou.aliyuncs.com/seam/csi-provisioner \\ --set sidecars.attacher.image.repository=registry.cn-hangzhou.aliyuncs.com/seam/csi-attacher \\ --set sidecars.snapshotter.image.repository=registry.cn-hangzhou.aliyuncs.com/seam/csi-snapshotter \\ --set sidecars.livenessProbe.image.repository=registry.cn-hangzhou.aliyuncs.com/seam/livenessprobe \\ --set sidecars.resizer.image.repository=registry.cn-hangzhou.aliyuncs.com/seam/csi-resizer \\ --set sidecars.nodeDriverRegistrar.image.repository=registry.cn-hangzhou.aliyuncs.com/seam/csi-node-driver-registrar \\ --set node.kubeletPath=/data/k8s/kubelet # kubectl get pod -n kube-system -l \"app.kubernetes.io/name=aws-ebs-csi-driver,app.kubernetes.io/instance=aws-ebs-csi-driver\" NAME READY STATUS RESTARTS AGE ebs-csi-controller-5cbfd45dc-2fq9q 6/6 Running 0 102s ebs-csi-controller-5cbfd45dc-jgpl9 6/6 Running 0 102s ebs-csi-node-2s8lj 3/3 Running 0 101s ebs-csi-node-4jstr 3/3 Running 0 101s ebs-csi-node-72w69 3/3 Running 0 101s ebs-csi-node-759rd 0/3 Pending 0 101s ebs-csi-node-cq86s 3/3 Running 0 101s ebs-csi-node-jnfxk 0/3 Pending 0 101s ebs-csi-node-m48nn 3/3 Running 0 101s ","date":"2022-12-30","objectID":"/posts/4842bb/:0:2","tags":[],"title":"è‡ªå»ºk8séƒ¨ç½²aws-ebs-csi-driver","uri":"/posts/4842bb/"},{"categories":[],"content":"æŒ‚è½½éªŒè¯ cat \u003c\u003c EOF | kubectl apply -f - apiVersion: storage.k8s.io/v1 kind: StorageClass metadata: name: ebs-sc provisioner: ebs.csi.aws.com volumeBindingMode: WaitForFirstConsumer parameters: csi.storage.k8s.io/fstype: xfs type: gp3 iopsPerGB: \"500\" tagSpecification_1: \"businessid=000000040629041578\" --- apiVersion: v1 kind: PersistentVolumeClaim metadata: name: ebs-claim spec: accessModes: - ReadWriteOnce storageClassName: ebs-sc resources: requests: storage: 10Gi --- apiVersion: v1 kind: Pod metadata: name: app spec: # nodeSelector: # hostname: 10.86.183.104 containers: - name: app image: centos command: [\"/bin/sh\"] args: [\"-c\", \"while true; do echo $(date -u) \u003e\u003e /data/out.txt; sleep 5; done\"] volumeMounts: - name: persistent-storage mountPath: /data volumes: - name: persistent-storage persistentVolumeClaim: claimName: ebs-claim EOF ","date":"2022-12-30","objectID":"/posts/4842bb/:0:3","tags":[],"title":"è‡ªå»ºk8séƒ¨ç½²aws-ebs-csi-driver","uri":"/posts/4842bb/"},{"categories":[],"content":"è®¾ç½®å­˜å‚¨ç±» cat \u003c\u003c EOF | kubectl apply -f - apiVersion: storage.k8s.io/v1 kind: StorageClass metadata: name: ebs-sc parameters: type: gp3 # io1, io2, gp2, gp3, sc1, st1, standard, sbp1, sbg1 csi.storage.k8s.io/fstype: ext4 # xfs, ext2, ext3, ext4 iops: \"3000\" # iopsPerGB: 500 æ¯GBå­˜å‚¨çš„iops,è·ŸiopsäºŒé€‰ä¸€ throughput: \"125\" tagSpecification_1: \"businessid=000000040629041578\" tagSpecification_2: \"pvcnamespace={{ .PVCNamespace }}\" tagSpecification_3: \"pvcname={{ .PVCName }}\" tagSpecification_4: \"pvname={{ .PVName }}\" provisioner: ebs.csi.aws.com reclaimPolicy: Delete volumeBindingMode: WaitForFirstConsumer EOF ","date":"2022-12-30","objectID":"/posts/4842bb/:0:4","tags":[],"title":"è‡ªå»ºk8séƒ¨ç½²aws-ebs-csi-driver","uri":"/posts/4842bb/"},{"categories":[],"content":"æ€§èƒ½æµ‹è¯• åŸºå‡†æµ‹è¯•è„šæœ¬ cat \u003c\u003c EOF \u003e fio-job.yaml # NOTE: For details of params to construct an fio job, refer to this link: # https://fio.readthedocs.io/en/latest/fio_doc.html --- apiVersion: v1 kind: PersistentVolumeClaim metadata: name: ebs-fio spec: accessModes: - ReadWriteOnce storageClassName: ebs-sc resources: requests: storage: 6Gi --- apiVersion: batch/v1 kind: Job metadata: generateName: dbench- spec: template: spec: containers: - name: dbench image: openebs/perf-test:latest imagePullPolicy: IfNotPresent env: ## storage mount point on which testfiles are created - name: DBENCH_MOUNTPOINT value: /data ########################################################## # I/O PROFILE COVERAGE FOR SPECIFIC PERF CHARACTERISTICS # ########################################################## ## quick: {read, write} iops, {read, write} bw (all random) ## detailed: {quick}, {read, write} latency \u0026 mixed 75r:25w (all random), {read, write} bw (all sequential) ## custom: a single user-defined job run with params specified in env 'CUSTOM' - name: DBENCH_TYPE value: detailed #################################################### # STANDARD TUNABLES FOR DBENCH_TYPE=QUICK/DETAILED # #################################################### ## active data size for the bench test - name: FIO_SIZE value: 2G ## use un-buffered i/o (usually O_DIRECT) - name: FIO_DIRECT value: '1' ## no of independent threads doing the same i/o - name: FIO_NUMJOBS value: '1' ## space b/w starting offsets on a file in case of parallel file i/o - name: FIO_OFFSET_INCREMENT value: 250M ## nature of i/o to file. commonly supported: libaio, sync, - name: FIO_IOENGINE value: libaio ## additional runtime options which will be appended to the above params ## ensure options used are not mutually exclusive w/ above params ## ex: '--group_reporting=1, stonewall, --ramptime=\u003cval\u003e etc.., - name: OPTIONS value: '' #################################################### # CUSTOM JOB SPEC FOR DBENCH_TYPE=CUSTOM # #################################################### ## this will execute a single job run with the params specified ## ex: '--bs=16k --iodepth=64 --ioengine=sync --size=500M --name=custom --readwrite=randrw --rwmixread=80 --random_distribution=pareto' - name: CUSTOM value: '' volumeMounts: - name: dbench-pv mountPath: /data restartPolicy: Never nodeSelector: hostname: shopline-xinjiapo-aws-dev-vm-8c32g-10.90.208.109 volumes: - name: dbench-pv persistentVolumeClaim: claimName: ebs-fio backoffLimit: 4 --- EOF kubectl create -f fio-job.yaml 3000 iops root@k8s-master-7b4d73fd8d:~# kubectl get pvc NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE ebs-fio Bound pvc-d603d626-1013-4fef-b1c7-b406d2d93546 6Gi RWO ebs-sc 4s root@k8s-master-7b4d73fd8d:~# kubectl get pod NAME READY STATUS RESTARTS AGE dbench-dgkpv-457kk 1/1 Running 0 110s root@k8s-master-7b4d73fd8d:~# root@k8s-master-7b4d73fd8d:~# root@k8s-master-7b4d73fd8d:~# root@k8s-master-7b4d73fd8d:~# kubectl get pod NAME READY STATUS RESTARTS AGE dbench-dgkpv-457kk 1/1 Running 0 2m59s root@k8s-master-7b4d73fd8d:~# kubectl logs -f dbench-dgkpv-457kk Working dir: /data Testing Read IOPS... read_iops: (g=0): rw=randread, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=64 fio-3.13 Starting 1 process read_iops: Laying out IO file (1 file / 2048MiB) read_iops: (groupid=0, jobs=1): err= 0: pid=18: Tue Dec 27 07:59:57 2022 read: IOPS=2995, BW=11.7MiB/s (12.3MB/s)(176MiB/15029msec) bw ( KiB/s): min=11912, max=12056, per=100.00%, avg=11999.47, stdev=27.31, samples=30 iops : min= 2978, max= 3014, avg=2999.87, stdev= 6.83, samples=30 cpu : usr=0.31%, sys=0.89%, ctx=9728, majf=0, minf=15 IO depths : 1=0.0%, 2=0.0%, 4=0.0%, 8=0.0%, 16=0.0%, 32=0.0%, \u003e=64=100.0% submit : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, \u003e=64=0.0% complete : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.1%, \u003e=64=0.0% issued rwts: total=45018,0,0,0 short=0,0,0,0 dropped=0,0,0,0 latency : target=0, window=0, percentile=100.00%, depth=64 Ru","date":"2022-12-30","objectID":"/posts/4842bb/:0:5","tags":[],"title":"è‡ªå»ºk8séƒ¨ç½²aws-ebs-csi-driver","uri":"/posts/4842bb/"},{"categories":[],"content":"å­˜åœ¨é—®é¢˜ RBACè§’è‰²é—®é¢˜å¯¼è‡´èŠ‚ç‚¹æ— æ³•æŒ‚è½½ attacher.Attach failed: volumeattachments.storage.k8s.io is forbidden kubectl apply -f - \u003c\u003cEOF apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: name: system:nodes:volumeattachments rules: - apiGroups: - storage.k8s.io resources: - volumeattachments verbs: - create - watch - delete --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: name: system:nodes:volumeattachments roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: system:nodes:volumeattachments subjects: - apiGroup: rbac.authorization.k8s.io kind: Group name: system:nodes EOF æ“ä½œç³»ç»Ÿç‰ˆæœ¬é—®é¢˜æ‰¾ä¸åˆ°é©±åŠ¨ æºç  ubuntu 16 ubuntu 22 ","date":"2022-12-30","objectID":"/posts/4842bb/:0:6","tags":[],"title":"è‡ªå»ºk8séƒ¨ç½²aws-ebs-csi-driver","uri":"/posts/4842bb/"},{"categories":[],"content":"1. Fork in the cloud Visit https://github.com/kubernetes/kubernetes Click Fork button (top right) to establish a cloud-based fork. ","date":"2022-12-30","objectID":"/posts/f09cdc/:1:0","tags":[],"title":"githubå·¥ä½œæµ","uri":"/posts/f09cdc/"},{"categories":[],"content":"2. Clone fork to local storage Per Goâ€™s workspace instructions, place Kubernetesâ€™ code on your GOPATH using the following cloning procedure. In your shell, define a local working directory as working_dir. If your GOPATH has multiple paths, pick just one and use it instead of $GOPATH. You must follow exactly this pattern, neither $GOPATH/src/github.com/${your github profile name}/ nor any other pattern will work. export working_dir=\"$(go env GOPATH)/src/k8s.io\" If you already do Go development on github, the k8s.io directory will be a sibling to your existing github.com directory. Set user to match your github profile name: export user=\u003cyour github profile name\u003e Both $working_dir and $user are mentioned in the figure above. Create your clone: mkdir -p $working_dir cd $working_dir git clone https://github.com/$user/kubernetes.git # or: git clone git@github.com:$user/kubernetes.git cd $working_dir/kubernetes git remote add upstream https://github.com/kubernetes/kubernetes.git # or: git remote add upstream git@github.com:kubernetes/kubernetes.git # Never push to upstream master git remote set-url --push upstream no_push # Confirm that your remotes make sense: git remote -v ","date":"2022-12-30","objectID":"/posts/f09cdc/:2:0","tags":[],"title":"githubå·¥ä½œæµ","uri":"/posts/f09cdc/"},{"categories":[],"content":"3. Create a Working Branch Get your local master up to date. Note that depending on which repository you are working from, the default branch may be called â€œmainâ€ instead of â€œmasterâ€. cd $working_dir/kubernetes git fetch upstream git checkout master git rebase upstream/master Create your new branch. git checkout -b myfeature You may now edit files on the myfeature branch. ","date":"2022-12-30","objectID":"/posts/f09cdc/:3:0","tags":[],"title":"githubå·¥ä½œæµ","uri":"/posts/f09cdc/"},{"categories":[],"content":"Building Kubernetes This workflow is process-specific. For quick-start build instructions for kubernetes/kubernetes, please see here. ","date":"2022-12-30","objectID":"/posts/f09cdc/:3:1","tags":[],"title":"githubå·¥ä½œæµ","uri":"/posts/f09cdc/"},{"categories":[],"content":"4. Keep your branch in sync You will need to periodically fetch changes from the upstream repository to keep your working branch in sync. Note that depending on which repository you are working from, the default branch may be called â€˜mainâ€™ instead of â€˜masterâ€™. Make sure your local repository is on your working branch and run the following commands to keep it in sync: git fetch upstream git rebase upstream/master Please donâ€™t use git pull instead of the above fetch and rebase. Since git pull executes a merge, it creates merge commits. These make the commit history messy and violate the principle that commits ought to be individually understandable and useful (see below). You might also consider changing your .git/config file via git config branch.autoSetupRebase always to change the behavior of git pull, or another non-merge option such as git pull --rebase. ","date":"2022-12-30","objectID":"/posts/f09cdc/:4:0","tags":[],"title":"githubå·¥ä½œæµ","uri":"/posts/f09cdc/"},{"categories":[],"content":"5. Commit Your Changes You will probably want to regularly commit your changes. It is likely that you will go back and edit, build, and test multiple times. After a few cycles of this, you might amend your previous commit. git commit ","date":"2022-12-30","objectID":"/posts/f09cdc/:5:0","tags":[],"title":"githubå·¥ä½œæµ","uri":"/posts/f09cdc/"},{"categories":[],"content":"6. Push to GitHub When your changes are ready for review, push your working branch to your fork on GitHub. git push -f \u003cyour_remote_name\u003e myfeature ","date":"2022-12-30","objectID":"/posts/f09cdc/:6:0","tags":[],"title":"githubå·¥ä½œæµ","uri":"/posts/f09cdc/"},{"categories":[],"content":"7. Create a Pull Request Visit your fork at https://github.com/\u003cuser\u003e/kubernetes Click the Compare \u0026 Pull Request button next to your myfeature branch. Check out the pull request process for more details and advice. If you have upstream write access, please refrain from using the GitHub UI for creating PRs, because GitHub will create the PR branch inside the main repository rather than inside your fork. ","date":"2022-12-30","objectID":"/posts/f09cdc/:7:0","tags":[],"title":"githubå·¥ä½œæµ","uri":"/posts/f09cdc/"},{"categories":[],"content":"Get a code review Once your pull request has been opened it will be assigned to one or more reviewers. Those reviewers will do a thorough code review, looking for correctness, bugs, opportunities for improvement, documentation and comments, and style. Commit changes made in response to review comments to the same branch on your fork. Very small PRs are easy to review. Very large PRs are very difficult to review. ","date":"2022-12-30","objectID":"/posts/f09cdc/:7:1","tags":[],"title":"githubå·¥ä½œæµ","uri":"/posts/f09cdc/"},{"categories":[],"content":"Squash commits After a review, prepare your PR for merging by squashing your commits. All commits left on your branch after a review should represent meaningful milestones or units of work. Use commits to add clarity to the development and review process. Before merging a PR, squash the following kinds of commits: Fixes/review feedback Typos Merges and rebases Work in progress Aim to have every commit in a PR compile and pass tests independently if you can, but itâ€™s not a requirement. In particular, merge commits must be removed, as they will not pass tests. To squash your commits, perform an interactive rebase: Check your git branch: git status The output should be similar to this: On branch your-contribution Your branch is up to date with 'origin/your-contribution'. Start an interactive rebase using a specific commit hash, or count backwards from your last commit using HEAD~\u003cn\u003e, where \u003cn\u003e represents the number of commits to include in the rebase. git rebase -i HEAD~3 The output should be similar to this: pick 2ebe926 Original commit pick 31f33e9 Address feedback pick b0315fe Second unit of work # Rebase 7c34fc9..b0315ff onto 7c34fc9 (3 commands) # # Commands: # p, pick \u003ccommit\u003e = use commit # r, reword \u003ccommit\u003e = use commit, but edit the commit message # e, edit \u003ccommit\u003e = use commit, but stop for amending # s, squash \u003ccommit\u003e = use commit, but meld into previous commit # f, fixup \u003ccommit\u003e = like \"squash\", but discard this commit's log message ... Use a command line text editor to change the word pick to squash for the commits you want to squash, then save your changes and continue the rebase: pick 2ebe926 Original commit squash 31f33e9 Address feedback pick b0315fe Second unit of work ... The output after saving changes should look similar to this: [detached HEAD 61fdded] Second unit of work Date: Thu Mar 5 19:01:32 2020 +0100 2 files changed, 15 insertions(+), 1 deletion(-) ... Successfully rebased and updated refs/heads/master. Force push your changes to your remote branch: git push --force For mass automated fixups such as automated doc formatting, use one or more commits for the changes to tooling and a final commit to apply the fixup en masse. This makes reviews easier. ","date":"2022-12-30","objectID":"/posts/f09cdc/:7:2","tags":[],"title":"githubå·¥ä½œæµ","uri":"/posts/f09cdc/"},{"categories":[],"content":"Merging a commit Once youâ€™ve received review and approval, your commits are squashed, your PR is ready for merging. Merging happens automatically after both a Reviewer and Approver have approved the PR. If you havenâ€™t squashed your commits, they may ask you to do so before approving a PR. ","date":"2022-12-30","objectID":"/posts/f09cdc/:8:0","tags":[],"title":"githubå·¥ä½œæµ","uri":"/posts/f09cdc/"},{"categories":[],"content":"Reverting a commit In case you wish to revert a commit, use the following instructions. If you have upstream write access, please refrain from using the Revert button in the GitHub UI for creating the PR, because GitHub will create the PR branch inside the main repository rather than inside your fork. Create a branch and sync it with upstream. Note that depending on which repository you are working from, the default branch may be called â€˜mainâ€™ instead of â€˜masterâ€™. # create a branch git checkout -b myrevert # sync the branch with upstream git fetch upstream git rebase upstream/master If the commit you wish to revert is a merge commit, use this command: # SHA is the hash of the merge commit you wish to revert git revert -m 1 \u003cSHA\u003e If it is a single commit, use this command: # SHA is the hash of the single commit you wish to revert git revert \u003cSHA\u003e This will create a new commit reverting the changes. Push this new commit to your remote. git push \u003cyour_remote_name\u003e myrevert Finally, create a Pull Request using this branch. ","date":"2022-12-30","objectID":"/posts/f09cdc/:9:0","tags":[],"title":"githubå·¥ä½œæµ","uri":"/posts/f09cdc/"},{"categories":["å­˜å‚¨"],"content":"ä¾èµ–è¯´æ˜ ","date":"2022-10-18","objectID":"/posts/f41ffb/:1:0","tags":["openebs"],"title":"OpenEBSæ€§èƒ½æµ‹è¯•","uri":"/posts/f41ffb/"},{"categories":["å­˜å‚¨"],"content":"å‡†å¤‡è£¸ç›˜ root@ubuntu:~# lsblk NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT nvme2n1 259:2 0 50G 0 disk ### 50Gæœªæ ¼å¼åŒ–ç£ç›˜ nvme1n1 259:0 0 600G 0 disk â””â”€nvme1n1p1 259:3 0 600G 0 part /data nvme0n1 259:1 0 40G 0 disk â””â”€nvme0n1p1 259:4 0 40G 0 part / ","date":"2022-10-18","objectID":"/posts/f41ffb/:1:1","tags":["openebs"],"title":"OpenEBSæ€§èƒ½æµ‹è¯•","uri":"/posts/f41ffb/"},{"categories":["å­˜å‚¨"],"content":"å®‰è£…iscsi sudo apt-get update sudo apt-get install open-iscsi sudo systemctl enable --now iscsid ","date":"2022-10-18","objectID":"/posts/f41ffb/:1:2","tags":["openebs"],"title":"OpenEBSæ€§èƒ½æµ‹è¯•","uri":"/posts/f41ffb/"},{"categories":["å­˜å‚¨"],"content":"OpenEBSå®‰è£… helm repo add openebs https://openebs.github.io/charts helm repo update ### é»˜è®¤å®‰è£… helm install openebs --namespace openebs openebs/openebs --create-namespace ","date":"2022-10-18","objectID":"/posts/f41ffb/:2:0","tags":["openebs"],"title":"OpenEBSæ€§èƒ½æµ‹è¯•","uri":"/posts/f41ffb/"},{"categories":["å­˜å‚¨"],"content":"å¯ç”¨cstor ### å¯ç”¨cstor,æ›¿æ¢é•œåƒåœ°å€:k8s.gcr.io/sig-storage cat \u003c\u003c EOF \u003e\u003e custom-values.yaml USER-SUPPLIED VALUES: cstor: admissionServer: nodeSelector: biz.type: test csiController: attacher: image: registry: registry.cn-hangzhou.aliyuncs.com/ repository: seam/csi-attacher nodeSelector: biz.type: test provisioner: image: registry: registry.cn-hangzhou.aliyuncs.com/ repository: seam/csi-provisioner resizer: image: registry: registry.cn-hangzhou.aliyuncs.com/ repository: seam/csi-resizer snapshotController: image: registry: registry.cn-hangzhou.aliyuncs.com/ repository: seam/snapshot-controller snapshotter: image: registry: registry.cn-hangzhou.aliyuncs.com/ repository: seam/csi-snapshotter csiNode: driverRegistrar: image: registry: registry.cn-hangzhou.aliyuncs.com/ repository: seam/csi-node-driver-registrar kubeletDir: /data/k8s/kubelet/ nodeSelector: biz.type: test cspcOperator: nodeSelector: biz.type: test cvcOperator: nodeSelector: biz.type: test enabled: true localprovisioner: nodeSelector: biz.type: test ndm: nodeSelector: biz.type: test ndmOperator: nodeSelector: biz.type: test provisioner: nodeSelector: biz.type: test snapshotOperator: nodeSelector: biz.type: test webhook: nodeSelector: biz.type: test EOF helm upgrade --install openebs --namespace openebs openebs/openebs --version 3.4.1 -f custom-values.yaml cstor.csiNode.kubeletDir=\"/data/k8s/kubelet/\" è®¾ç½®ä¸ºå®é™…é›†ç¾¤è¿è¡Œé…ç½® ","date":"2022-10-18","objectID":"/posts/f41ffb/:2:1","tags":["openebs"],"title":"OpenEBSæ€§èƒ½æµ‹è¯•","uri":"/posts/f41ffb/"},{"categories":["å­˜å‚¨"],"content":"å®‰è£…åæŸ¥çœ‹ç£ç›˜æƒ…å†µ root@ubuntu:~# lsblk NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT nvme2n1 259:2 0 50G 0 disk â””â”€nvme2n1p1 259:6 0 50G 0 part ### æ ¼å¼åŒ–æœªæŒ‚è½½ç›˜ nvme1n1 259:0 0 600G 0 disk â””â”€nvme1n1p1 259:3 0 600G 0 part /data nvme0n1 259:1 0 40G 0 disk â””â”€nvme0n1p1 259:4 0 40G 0 part / # kubectl get bd -n openebs NAME NODENAME SIZE CLAIMSTATE STATUS AGE blockdevice-5cc77e185a944270fa46b7d233320660 dev-vm-8c32g-600g-10-86-183-104 53686025728 Unclaimed Active 4m56s blockdevice-b3978ac55b8d0fc6ae9e2bc3b5b92fd6 dev-vm-8c64g-600g-10-86-16-225 53686025728 Unclaimed Active 4m56s blockdevice-d93d0a91351a13f4de81fd0a5e6e4540 dev-vm-4c16g-600g-10-86-141-68 53686025728 Unclaimed Active 4m56s ","date":"2022-10-18","objectID":"/posts/f41ffb/:2:2","tags":["openebs"],"title":"OpenEBSæ€§èƒ½æµ‹è¯•","uri":"/posts/f41ffb/"},{"categories":["å­˜å‚¨"],"content":"Local PV device æµ‹è¯• ","date":"2022-10-18","objectID":"/posts/f41ffb/:3:0","tags":["openebs"],"title":"OpenEBSæ€§èƒ½æµ‹è¯•","uri":"/posts/f41ffb/"},{"categories":["å­˜å‚¨"],"content":"éªŒè¯PVCæŒ‚è½½ # cat \u003c\u003c EOF \u003e local-device-pod.yaml --- kind: PersistentVolumeClaim apiVersion: v1 metadata: name: local-device-pvc spec: storageClassName: openebs-device accessModes: - ReadWriteOnce resources: requests: storage: 5G --- apiVersion: v1 kind: Pod metadata: name: hello-local-device-pod spec: volumes: - name: local-storage persistentVolumeClaim: claimName: local-device-pvc containers: - name: hello-container image: dockerhub.kubekey.local/library/busybox:latest command: - sh - -c - 'while true; do echo \"`date` [`hostname`] Hello from OpenEBS Local PV.\" \u003e\u003e /mnt/store/greet.txt; sleep $(($RANDOM % 5 + 300)); done' volumeMounts: - mountPath: /mnt/store name: local-storage EOF # kubectl apply -f local-device-pod.yaml ","date":"2022-10-18","objectID":"/posts/f41ffb/:3:1","tags":["openebs"],"title":"OpenEBSæ€§èƒ½æµ‹è¯•","uri":"/posts/f41ffb/"},{"categories":["å­˜å‚¨"],"content":"æŸ¥çœ‹PVCæŒ‚è½½æƒ…å†µ # kubectl get pvc local-device-pvc NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE local-device-pvc Bound pvc-b743d6b9-2854-4e9c-aaff-39064605e594 5G RWO openebs-device 2m3s # kubectl get pod hello-local-device-pod -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES hello-local-device-pod 1/1 Running 0 18s 10.86.232.79 dev-vm-4c16g-600g-10-86-141-68 \u003cnone\u003e \u003cnone\u003e # kubectl get bd -n openebs NAME NODENAME SIZE CLAIMSTATE STATUS AGE blockdevice-5cc77e185a944270fa46b7d233320660 dev-vm-8c32g-600g-10-86-183-104 53686025728 Unclaimed Active 11m blockdevice-b3978ac55b8d0fc6ae9e2bc3b5b92fd6 dev-vm-8c64g-600g-10-86-16-225 53686025728 Unclaimed Active 11m blockdevice-d93d0a91351a13f4de81fd0a5e6e4540 dev-vm-4c16g-600g-10-86-141-68 53686025728 Claimed Active 11m Podè°ƒåº¦åˆ°èŠ‚ç‚¹10-86-141-68, èŠ‚ç‚¹10-86-141-68å¯¹åº”çš„ blockdevice çŠ¶æ€ä¸º Claimed ç™»å½•èŠ‚ç‚¹10-86-141-68 éªŒè¯æ•°æ®æ˜¯å¦å†™å…¥ # lsblk NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT nvme2n1 259:2 0 50G 0 disk â””â”€nvme2n1p1 259:5 0 50G 0 part /data/k8s/kubelet/pods/d1f84232-f355-4f9f-850d-129b8fd59864/volumes/kubernetes.io~local-volume/pvc-b743d6b9-2854-4e9c-aaff-39064605e594 nvme1n1 259:0 0 600G 0 disk â””â”€nvme1n1p1 259:3 0 600G 0 part /data nvme0n1 259:1 0 40G 0 disk â””â”€nvme0n1p1 259:4 0 40G 0 part / # ls -l /data/k8s/kubelet/pods/d1f84232-f355-4f9f-850d-129b8fd59864/volumes/kubernetes.io~local-volume/pvc-b743d6b9-2854-4e9c-aaff-39064605e594/ total 20 -rw-r--r-- 1 root root 67 Oct 18 15:33 greet.txt drwx------ 2 root root 16384 Oct 18 15:28 lost+found # ls -l /data/k8s/kubelet/pods/d1f84232-f355-4f9f-850d-129b8fd59864/volumes/kubernetes.io~local-volume/pvc-b743d6b9-2854-4e9c-aaff-39064605e594/greet.txt -rw-r--r-- 1 root root 67 Oct 18 15:33 /data/k8s/kubelet/pods/d1f84232-f355-4f9f-850d-129b8fd59864/volumes/kubernetes.io~local-volume/pvc-b743d6b9-2854-4e9c-aaff-39064605e594/greet.txt # cat /data/k8s/kubelet/pods/d1f84232-f355-4f9f-850d-129b8fd59864/volumes/kubernetes.io~local-volume/pvc-b743d6b9-2854-4e9c-aaff-39064605e594/greet.txt Tue Oct 18 15:32:27 CST 2022 [ubuntu] Hello from OpenEBS Local PV. ","date":"2022-10-18","objectID":"/posts/f41ffb/:3:2","tags":["openebs"],"title":"OpenEBSæ€§èƒ½æµ‹è¯•","uri":"/posts/f41ffb/"},{"categories":["å­˜å‚¨"],"content":"Local PV device æ€§èƒ½æµ‹è¯• åˆ›å»ºPVC cat \u003e dbench-pvc.yaml \u003c\u003cEOF --- kind: PersistentVolumeClaim apiVersion: v1 metadata: name: dbench spec: storageClassName: openebs-device accessModes: - ReadWriteOnce resources: requests: storage: 5G EOF kubectl apply -f dbench-pvc.yaml åˆ›å»ºå‹æµ‹ä»»åŠ¡ cat \u003c\u003c EOF \u003e fio-job.yaml # NOTE: For details of params to construct an fio job, refer to this link: # https://fio.readthedocs.io/en/latest/fio_doc.html --- apiVersion: batch/v1 kind: Job metadata: generateName: dbench- spec: template: spec: containers: - name: dbench image: openebs/perf-test:latest imagePullPolicy: IfNotPresent env: ## storage mount point on which testfiles are created - name: DBENCH_MOUNTPOINT value: /data ########################################################## # I/O PROFILE COVERAGE FOR SPECIFIC PERF CHARACTERISTICS # ########################################################## ## quick: {read, write} iops, {read, write} bw (all random) ## detailed: {quick}, {read, write} latency \u0026 mixed 75r:25w (all random), {read, write} bw (all sequential) ## custom: a single user-defined job run with params specified in env 'CUSTOM' - name: DBENCH_TYPE value: detailed #################################################### # STANDARD TUNABLES FOR DBENCH_TYPE=QUICK/DETAILED # #################################################### ## active data size for the bench test - name: FIO_SIZE value: 2G ## use un-buffered i/o (usually O_DIRECT) - name: FIO_DIRECT value: '1' ## no of independent threads doing the same i/o - name: FIO_NUMJOBS value: '1' ## space b/w starting offsets on a file in case of parallel file i/o - name: FIO_OFFSET_INCREMENT value: 250M ## nature of i/o to file. commonly supported: libaio, sync, - name: FIO_IOENGINE value: libaio ## additional runtime options which will be appended to the above params ## ensure options used are not mutually exclusive w/ above params ## ex: '--group_reporting=1, stonewall, --ramptime=\u003cval\u003e etc.., - name: OPTIONS value: '' #################################################### # CUSTOM JOB SPEC FOR DBENCH_TYPE=CUSTOM # #################################################### ## this will execute a single job run with the params specified ## ex: '--bs=16k --iodepth=64 --ioengine=sync --size=500M --name=custom --readwrite=randrw --rwmixread=80 --random_distribution=pareto' - name: CUSTOM value: '' volumeMounts: - name: dbench-pv mountPath: /data restartPolicy: Never volumes: - name: dbench-pv persistentVolumeClaim: claimName: dbench backoffLimit: 4 --- EOF kubectl create -f fio-job.yaml IOPS Bandwidth éšæœºè¯» 2997 125MiB/s éšæœºå†™ 2997 125MiB/s é¡ºåºè¯» 126MiB/s é¡ºåºå†™ 128MiB/s æ··åˆè¯»å†™50%:50% 3070/1011 ç¬¬ä¸€æ¬¡å‹æµ‹æ—¥å¿— # kubectl logs -f dbench-4jwlb-qjhzg Working dir: /data Testing Read IOPS... read_iops: (g=0): rw=randread, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=64 fio-3.13 Starting 1 process read_iops: Laying out IO file (1 file / 2048MiB) read_iops: (groupid=0, jobs=1): err= 0: pid=13: Tue Oct 18 07:55:44 2022 read: IOPS=2997, BW=11.7MiB/s (12.3MB/s)(176MiB/15027msec) bw ( KiB/s): min=11848, max=12136, per=99.92%, avg=11997.87, stdev=44.56, samples=30 iops : min= 2962, max= 3034, avg=2999.47, stdev=11.14, samples=30 cpu : usr=0.24%, sys=1.06%, ctx=13280, majf=0, minf=15 IO depths : 1=0.0%, 2=0.0%, 4=0.0%, 8=0.0%, 16=0.0%, 32=0.0%, \u003e=64=100.0% submit : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, \u003e=64=0.0% complete : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.1%, \u003e=64=0.0% issued rwts: total=45049,0,0,0 short=0,0,0,0 dropped=0,0,0,0 latency : target=0, window=0, percentile=100.00%, depth=64 Run status group 0 (all jobs): READ: bw=11.7MiB/s (12.3MB/s), 11.7MiB/s-11.7MiB/s (12.3MB/s-12.3MB/s), io=176MiB (185MB), run=15027-15027msec Disk stats (read/write): nvme2n1: ios=53999/2, merge=0/1, ticks=537596/20, in_queue=537796, util=99.46% Testing Write IOPS... write_iops: (g=0): rw=randwrite, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=64 fio-3.13 Starting 1 process w","date":"2022-10-18","objectID":"/posts/f41ffb/:3:3","tags":["openebs"],"title":"OpenEBSæ€§èƒ½æµ‹è¯•","uri":"/posts/f41ffb/"},{"categories":["å­˜å‚¨"],"content":"cStor PV æµ‹è¯• ","date":"2022-10-18","objectID":"/posts/f41ffb/:4:0","tags":["openebs"],"title":"OpenEBSæ€§èƒ½æµ‹è¯•","uri":"/posts/f41ffb/"},{"categories":["å­˜å‚¨"],"content":"åˆ›å»ºå­˜å‚¨æ± (cStor storage pools) # kubectl get bd -n openebs NAME NODENAME SIZE CLAIMSTATE STATUS AGE blockdevice-5cc77e185a944270fa46b7d233320660 dev-vm-8c32g-600g-10-86-183-104 53686025728 Unclaimed Active 84m blockdevice-b3978ac55b8d0fc6ae9e2bc3b5b92fd6 dev-vm-8c64g-600g-10-86-16-225 53686025728 Unclaimed Active 84m blockdevice-d93d0a91351a13f4de81fd0a5e6e4540 dev-vm-4c16g-600g-10-86-141-68 53686025728 Unclaimed Active 84m cat \u003c\u003c EOF \u003e cspc.yaml apiVersion: cstor.openebs.io/v1 kind: CStorPoolCluster metadata: name: cstor-disk-pool namespace: openebs spec: pools: - nodeSelector: kubernetes.io/hostname: dev-vm-8c32g-600g-10-86-183-104 dataRaidGroups: - blockDevices: - blockDeviceName: \"blockdevice-5cc77e185a944270fa46b7d233320660\" poolConfig: dataRaidGroupType: \"stripe\" - nodeSelector: kubernetes.io/hostname: dev-vm-8c64g-600g-10-86-16-225 dataRaidGroups: - blockDevices: - blockDeviceName: \"blockdevice-b3978ac55b8d0fc6ae9e2bc3b5b92fd6\" poolConfig: dataRaidGroupType: \"stripe\" - nodeSelector: kubernetes.io/hostname: dev-vm-4c16g-600g-10-86-141-68 dataRaidGroups: - blockDevices: - blockDeviceName: \"blockdevice-d93d0a91351a13f4de81fd0a5e6e4540\" poolConfig: dataRaidGroupType: \"stripe\" EOF kubectl apply -f cspc.yaml blockdeviceçš„CLAIMSTATEçŠ¶æ€ä¸ºUnclaimedæ‰å¯åŠ å…¥å­˜å‚¨æ±  # kubectl get cspc -n openebs NAME HEALTHYINSTANCES PROVISIONEDINSTANCES DESIREDINSTANCES AGE cstor-disk-pool 3 3 72s # kubectl get cspi -n openebs NAME HOSTNAME FREE CAPACITY READONLY PROVISIONEDREPLICAS HEALTHYREPLICAS STATUS AGE cstor-disk-pool-2v28 dev-vm-8c32g-600g-10-86-183-104 0 0 false 0 0 75s cstor-disk-pool-6mpx dev-vm-8c64g-600g-10-86-16-225 0 0 false 0 0 75s cstor-disk-pool-qmz7 dev-vm-4c16g-600g-10-86-141-68 0 0 false 0 0 74s ","date":"2022-10-18","objectID":"/posts/f41ffb/:4:1","tags":["openebs"],"title":"OpenEBSæ€§èƒ½æµ‹è¯•","uri":"/posts/f41ffb/"},{"categories":["å­˜å‚¨"],"content":"åˆ›å»ºå­˜å‚¨å·å£°æ˜(StorageClass) cat \u003c\u003c EOF \u003e cstor-csi-disk.yaml kind: StorageClass apiVersion: storage.k8s.io/v1 metadata: name: cstor-csi-disk provisioner: cstor.csi.openebs.io allowVolumeExpansion: true parameters: cas-type: cstor # cstorPoolCluster should have the name of the CSPC cstorPoolCluster: cstor-disk-pool # replicaCount should be \u003c= no. of CSPI created in the selected CSPC replicaCount: \"2\" EOF kubectl apply -f cstor-csi-disk.yaml æŸ¥çœ‹å­˜å‚¨å·å£°æ˜ # kubectl get sc cstor-csi-disk NAME PROVISIONER RECLAIMPOLICY VOLUMEBINDINGMODE ALLOWVOLUMEEXPANSION AGE cstor-csi-disk cstor.csi.openebs.io Delete Immediate true 8s ","date":"2022-10-18","objectID":"/posts/f41ffb/:4:2","tags":["openebs"],"title":"OpenEBSæ€§èƒ½æµ‹è¯•","uri":"/posts/f41ffb/"},{"categories":["å­˜å‚¨"],"content":"åˆ›å»ºPVC cat \u003e cstor-pvc.yaml \u003c\u003cEOF --- kind: PersistentVolumeClaim apiVersion: v1 metadata: name: cstor-pvc spec: storageClassName: cstor-csi-disk accessModes: - ReadWriteOnce resources: requests: storage: 5G EOF kubectl apply -f cstor-pvc.yaml ","date":"2022-10-18","objectID":"/posts/f41ffb/:4:3","tags":["openebs"],"title":"OpenEBSæ€§èƒ½æµ‹è¯•","uri":"/posts/f41ffb/"},{"categories":["å­˜å‚¨"],"content":"éªŒè¯PVCæŒ‚è½½æ˜¯å¦æ­£å¸¸ cat \u003c\u003cEOF \u003ecstor-pod.yaml apiVersion: v1 kind: Pod metadata: name: busybox namespace: default spec: containers: - command: - sh - -c - 'date \u003e\u003e /mnt/openebs-csi/date.txt; hostname \u003e\u003e /mnt/openebs-csi/hostname.txt; sync; sleep 5; sync; tail -f /dev/null;' image: busybox imagePullPolicy: Always name: busybox volumeMounts: - mountPath: /mnt/openebs-csi name: demo-vol volumes: - name: demo-vol persistentVolumeClaim: claimName: cstor-pvc EOF kubectl apply -f cstor-pod.yaml ","date":"2022-10-18","objectID":"/posts/f41ffb/:4:4","tags":["openebs"],"title":"OpenEBSæ€§èƒ½æµ‹è¯•","uri":"/posts/f41ffb/"},{"categories":["å­˜å‚¨"],"content":"åˆ›å»ºå‹æµ‹ä»»åŠ¡ cat \u003c\u003c EOF \u003e fio-job.yaml # NOTE: For details of params to construct an fio job, refer to this link: # https://fio.readthedocs.io/en/latest/fio_doc.html --- apiVersion: batch/v1 kind: Job metadata: generateName: dbench- spec: template: spec: containers: - name: dbench image: openebs/perf-test:latest imagePullPolicy: IfNotPresent env: ## storage mount point on which testfiles are created - name: DBENCH_MOUNTPOINT value: /data ########################################################## # I/O PROFILE COVERAGE FOR SPECIFIC PERF CHARACTERISTICS # ########################################################## ## quick: {read, write} iops, {read, write} bw (all random) ## detailed: {quick}, {read, write} latency \u0026 mixed 75r:25w (all random), {read, write} bw (all sequential) ## custom: a single user-defined job run with params specified in env 'CUSTOM' - name: DBENCH_TYPE value: detailed #################################################### # STANDARD TUNABLES FOR DBENCH_TYPE=QUICK/DETAILED # #################################################### ## active data size for the bench test - name: FIO_SIZE value: 2G ## use un-buffered i/o (usually O_DIRECT) - name: FIO_DIRECT value: '1' ## no of independent threads doing the same i/o - name: FIO_NUMJOBS value: '1' ## space b/w starting offsets on a file in case of parallel file i/o - name: FIO_OFFSET_INCREMENT value: 250M ## nature of i/o to file. commonly supported: libaio, sync, - name: FIO_IOENGINE value: libaio ## additional runtime options which will be appended to the above params ## ensure options used are not mutually exclusive w/ above params ## ex: '--group_reporting=1, stonewall, --ramptime=\u003cval\u003e etc.., - name: OPTIONS value: '' #################################################### # CUSTOM JOB SPEC FOR DBENCH_TYPE=CUSTOM # #################################################### ## this will execute a single job run with the params specified ## ex: '--bs=16k --iodepth=64 --ioengine=sync --size=500M --name=custom --readwrite=randrw --rwmixread=80 --random_distribution=pareto' - name: CUSTOM value: '' volumeMounts: - name: dbench-pv mountPath: /data restartPolicy: Never volumes: - name: dbench-pv persistentVolumeClaim: claimName: cstor-pvc ## ä¿®æ”¹pvc backoffLimit: 4 --- EOF kubectl create -f fio-job.yaml ç¬¬ä¸€æ¬¡æµ‹è¯• root@k8s-master-7b4d73fd8d:~# kubectl logs -f dbench-4j6xm-v8xzk Working dir: /data Testing Read IOPS... read_iops: (g=0): rw=randread, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=64 fio-3.13 Starting 1 process read_iops: Laying out IO file (1 file / 2048MiB) read_iops: (groupid=0, jobs=1): err= 0: pid=17: Tue Oct 18 10:44:57 2022 read: IOPS=8859, BW=34.6MiB/s (36.3MB/s)(520MiB/15014msec) bw ( KiB/s): min=33912, max=36200, per=99.98%, avg=35446.50, stdev=496.88, samples=30 iops : min= 8478, max= 9050, avg=8861.60, stdev=124.22, samples=30 cpu : usr=2.42%, sys=9.91%, ctx=127613, majf=0, minf=15 IO depths : 1=0.0%, 2=0.0%, 4=0.0%, 8=0.0%, 16=0.0%, 32=0.0%, \u003e=64=100.0% submit : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, \u003e=64=0.0% complete : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.1%, \u003e=64=0.0% issued rwts: total=133015,0,0,0 short=0,0,0,0 dropped=0,0,0,0 latency : target=0, window=0, percentile=100.00%, depth=64 Run status group 0 (all jobs): READ: bw=34.6MiB/s (36.3MB/s), 34.6MiB/s-34.6MiB/s (36.3MB/s-36.3MB/s), io=520MiB (545MB), run=15014-15014msec Disk stats (read/write): sda: ios=149875/8, merge=20/18, ticks=1085532/44, in_queue=1086020, util=99.44% Testing Write IOPS... write_iops: (g=0): rw=randwrite, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=64 fio-3.13 Starting 1 process write_iops: (groupid=0, jobs=1): err= 0: pid=33: Tue Oct 18 10:45:15 2022 write: IOPS=2064, BW=8276KiB/s (8474kB/s)(125MiB/15503msec); 0 zone resets bw ( KiB/s): min= 152, max=13240, per=99.81%, avg=8259.35, stdev=3710.86, samples=31 iops : min= 38, max= 3310, avg=2064.81, stdev=927.72, samples=31 cpu : usr=1.01%, sys=","date":"2022-10-18","objectID":"/posts/f41ffb/:4:5","tags":["openebs"],"title":"OpenEBSæ€§èƒ½æµ‹è¯•","uri":"/posts/f41ffb/"},{"categories":["æ€§èƒ½"],"content":"FIO ä»‹ç» fio æ˜¯ä¸€ä¸ªå¸¸è§çš„ç”¨äºæµ‹è¯•ç£ç›˜ I/O æ€§èƒ½çš„å·¥å…·ï¼Œæ”¯æŒ 19 ç§ä¸åŒçš„ I/O å¼•æ“ï¼ŒåŒ…æ‹¬ï¼šsync, mmap, libaio, posixaio, SG v3, splice, null, network, syslet, guasi, solarisaio ç­‰ç­‰ã€‚fio ä¸€ç›´åœ¨æ›´æ–°ï¼Œæœ€æ–°çš„ç‰ˆæœ¬æ˜¯ v3.19ï¼Œå®ƒçš„å®˜ç½‘æ˜¯ fioã€‚ å¸¸ç”¨å‚æ•° å¸¸ç”¨å‚æ•° å‚æ•°è¯´æ˜ å‚æ•°å–å€¼(eg:) name FIO è¿è¡Œä»»åŠ¡çš„åç§° ï¼ˆå¯é€‰ï¼‰ name=fio-test description FIO è¿è¡Œæ—¶çš„æè¿° ï¼ˆå¯é€‰ï¼‰ description=â€œthis is a testâ€ loops FIO æ˜¯å¦è¦å¾ªç¯æ‰§è¡Œè¯¥ä»»åŠ¡ ï¼ˆå¯é€‰ï¼‰ loops=5 numjobs æ¯ä¸ªFIO ä»»åŠ¡è¦å¼€å¯å¤šå°‘æ•°é‡çš„çº¿ç¨‹ numjobs=8 runtime FIO ä»»åŠ¡è¦æ‰§è¡Œçš„æ—¶é—´ï¼Œå•ä½ä¸ºs runtime=300 time_based è®¾ç½®åï¼Œå³ä¾¿FIOå†™å®Œäº†æ•´ä¸ªç£ç›˜ï¼Œä¹Ÿä¸ä¼šé€€å‡ºä»»åŠ¡ã€‚å½“ä»»åŠ¡çš„æ—¶é—´æ»¡è¶³runtimeè®¾ç½®çš„æ—¶é—´åï¼Œæ‰ä¼šé€€å‡ºä»»åŠ¡ time_based startdelay å»¶è¿Ÿä½œä¸šçš„å¯åŠ¨æ—¶é—´ã€‚å¦‚æœæŒ‡å®šåŒºé—´ç±»å‹çš„æ•°å€¼ï¼Œå°†ä»åŒºé—´ä¸­é€‰æ‹©ä¸€ä¸ªéšæœºå€¼ç”¨æ¥å¯åŠ¨ä»»åŠ¡ã€‚å•ä½ä¸ºs startdelay=10 ramp_time FIO åœ¨æ‰§è¡Œä»»åŠ¡æ—¶é¢„çƒ­çš„æ—¶é—´ã€‚å¯ä»¥ä½¿æ€§èƒ½æµ‹è¯•çš„ç»“æœæ›´åŠ ç²¾ç¡®å¯é ã€‚å•ä½ä¸ºs ramp_time=60 filename æµ‹è¯•æ–‡ä»¶çš„åç§°ï¼Œé€šå¸¸ä¸ºç¡¬ç›˜çš„ç›˜ç¬¦åç§° filename=/dev/sdd pre_read åœ¨FIOä¸‹å‘ I/O å‰ï¼Œæ–‡ä»¶ä¼šè¢«åŠ è½½åˆ°å†…å­˜ä¸­ã€‚å½“ pre_read=true æ—¶ä¼šæ¸…é™¤æ‰ç£ç›˜ä¸­çš„å…ƒæ•°æ®ï¼Œé»˜è®¤ä¸ºfalse pre_read=false max_open_zones FIO æ‰§è¡Œéšæœºå†™å…¥ä»»åŠ¡æ—¶ï¼Œå…è®¸å†™å…¥/è¯»å–çš„ç£ç›˜çš„åŒºåŸŸçš„æœ€å¤§æ•°é‡ã€‚ max_open_zones=1000000 direct æ˜¯å¦ä½¿ç”¨éç¼“å†²I/Oã€‚é»˜è®¤ä¸ºfalse direct=true readwrite I/O æ¨¡å¼ã€‚readã€writeã€randwriteã€randreadã€randrwã€‚æ··åˆè¯»å†™æ—¶é»˜è®¤è¯»å†™æ¯”ä¾‹ä¸º50%:50% readwrite=read percentage_random éšæœºå†™å…¥æ—¶åŒ…å«å¤šå°‘çš„éšæœºæ•°æ® percentage_random=30% blocksize è¯»å–/å†™å…¥æ—¶å—çš„å¤§å° bs=1M zero_buffers åˆå§‹åŒ–æ‰€æœ‰é›¶çš„ç¼“å†²åŒºã€‚é»˜è®¤ç”¨éšæœºæ•°å¡«å……ç¼“å†²åŒº zero_buffers rwmixread æ··åˆæ¨¡å¼ä¸­è¯»å–æ‰€å çš„ç™¾åˆ†æ¯” rwmixread=30 rwmixwrite æ··åˆæ¨¡å¼ä¸­å†™å…¥æ‰€å çš„ç™¾åˆ†æ¯” rwmixwrite=70 refill_buffers FIO åœ¨æ¯æ¬¡æäº¤æ—¶é‡æ–°å¡«å…… I/O ç¼“å†²åŒºã€‚ä½¿ç”¨ zero_buffers å‚æ•°åï¼Œè¯¥å‚æ•°ä¼šå¤±æ•ˆ refill_buffers buffer_compress_percentage å‹ç¼© I/O ç¼“å†²åŒºçš„ç™¾åˆ†æ¯”ï¼Œé…åˆ refill_buffers å¯ä»¥é™ä½ç¡¬ç›˜ä¸­ç›¸é‚»å—ä¸­æ•°æ®çš„ä¸€è‡´æ€§ buffer_compress_percentage=70 size FIO æ‰§è¡Œä»»åŠ¡æ—¶è¦è¯»å–æˆ–å†™å…¥çš„æ•°æ®æ€»å’Œã€‚sizeä¸ºç™¾åˆ†æ¯”æ—¶å°†æŒ‰ç…§ç¡¬ç›˜å®¹é‡ * percentage size=300G or size=50% ioengine FIO ä»»åŠ¡å·¥å…·æ—¶çš„å¼•æ“ï¼Œsync, libaio, rdmaâ€¦ ioengine=libaio iodepth ä»»åŠ¡æ‰§è¡Œæ—¶çš„ I/O é˜Ÿåˆ—æ·±åº¦çš„å•å…ƒæ•°ã€‚ä»»åŠ¡çš„çº¿ç¨‹æ•° = numjobs * iodepth iodepth=16 å‘½ä»¤è¡Œä½¿ç”¨ # é¡ºåºè¯» $ fio -filename=/dev/sda -direct=1 -iodepth 1 -thread -rw=read -ioengine=psync -bs=16k -size=200G -numjobs=30 -runtime=1000 -group_reporting -name=mytest # é¡ºåºå†™ $ fio -filename=/dev/sda -direct=1 -iodepth 1 -thread -rw=write -ioengine=psync -bs=16k -size=200G -numjobs=30 -runtime=1000 -group_reporting -name=mytest # éšæœºè¯» $ fio -filename=/dev/sda -direct=1 -iodepth 1 -thread -rw=randread -ioengine=psync -bs=16k -size=200G -numjobs=30 -runtime=1000 -group_reporting -name=mytest # éšæœºå†™ $ fio -filename=/dev/sda -direct=1 -iodepth 1 -thread -rw=randwrite -ioengine=psync -bs=16k -size=200G -numjobs=30 -runtime=1000 -group_reporting -name=mytest # æ··åˆéšæœºè¯»å†™ $ fio -filename=/dev/sda -direct=1 -iodepth 1 -thread -rw=randrw -rwmixread=70 -ioengine=psync -bs=16k -size=200G -numjobs=30 -runtime=100 -group_reporting -name=mytest -ioscheduler=noop é…ç½®æ–‡ä»¶ # fio.conf [global] ioengine=libaio iodepth=128 direct=0 thread=1 numjobs=16 norandommap=1 randrepeat=0 runtime=60 ramp_time=6 size=1g directory=/your/path [read4k-rand] stonewall group_reporting bs=4k rw=randread [read64k-seq] stonewall group_reporting bs=64k rw=read [write4k-rand] stonewall group_reporting bs=4k rw=randwrite [write64k-seq] stonewall group_reporting bs=64k rw=write ","date":"2022-10-18","objectID":"/posts/4d68ea/:0:1","tags":["fio","å­˜å‚¨"],"title":"FIOå­˜å‚¨æ€§èƒ½å·¥å…·","uri":"/posts/4d68ea/"},{"categories":["æ€§èƒ½"],"content":"æµ‹è¯•åœºæ™¯ å¤§æ–‡ä»¶è¯»å†™æµ‹è¯• å¤§æ–‡ä»¶é¡ºåºè¯» fio --name=big-file-sequential-read \\ --directory=/data \\ --rw=read --refill_buffers \\ --bs=256k --size=4G å¤§æ–‡ä»¶é¡ºåºå†™ fio --name=big-file-sequential-write \\ --directory=/data \\ --rw=write --refill_buffers \\ --bs=256k --size=4G å¤§æ–‡ä»¶å¹¶å‘è¯» fio --name=big-file-multi-read \\ --directory=/data \\ --rw=read --refill_buffers \\ --bs=256k --size=4G \\ --numjobs={1, 2, 4, 8, 16} å¤§æ–‡ä»¶å¹¶å‘å†™ fio --name=big-file-multi-write \\ --directory=/data \\ --rw=write --refill_buffers \\ --bs=256k --size=4G \\ --numjobs={1, 2, 4, 8, 16} å¤§æ–‡ä»¶éšæœºè¯» fio --name=big-file-rand-read \\ --directory=/data \\ --rw=randread --refill_buffers \\ --size=4G --filename=randread.bin \\ --bs={4k, 16k, 64k, 256k} --pre_read=1 sync \u0026\u0026 echo 3 \u003e /proc/sys/vm/drop_caches fio --name=big-file-rand-read \\ --directory=/data \\ --rw=randread --refill_buffers \\ --size=4G --filename=randread.bin \\ --bs={4k, 16k, 64k, 256k} å¤§æ–‡ä»¶éšæœºå†™ fio --name=big-file-random-write \\ --directory=/data \\ --rw=randwrite --refill_buffers \\ --size=4G --bs={4k, 16k, 64k, 256k} å°æ–‡ä»¶è¯»å†™æµ‹è¯• å°æ–‡ä»¶è¯» fio --name=small-file-seq-read \\ --directory=/data \\ --rw=read --file_service_type=sequential \\ --bs={file_size} --filesize={file_size} --nrfiles=1000 å°æ–‡ä»¶å†™ fio --name=small-file-seq-write \\ --directory=/data \\ --rw=write --file_service_type=sequential \\ --bs={file_size} --filesize={file_size} --nrfiles=1000 å°æ–‡ä»¶å¹¶å‘è¯» fio --name=small-file-multi-read \\ --directory=/data \\ --rw=read --file_service_type=sequential \\ --bs=4k --filesize=4k --nrfiles=1000 \\ --numjobs={1, 2, 4, 8, 16} å°æ–‡ä»¶å¹¶å‘å†™ fio --name=small-file-multi-write \\ --directory=/data \\ --rw=write --file_service_type=sequential \\ --bs=4k --filesize=4k --nrfiles=1000 \\ --numjobs={1, 2, 4, 8, 16} ","date":"2022-10-18","objectID":"/posts/4d68ea/:0:2","tags":["fio","å­˜å‚¨"],"title":"FIOå­˜å‚¨æ€§èƒ½å·¥å…·","uri":"/posts/4d68ea/"},{"categories":["æ€§èƒ½"],"content":"æ€»ç»“ ç¡¬ç›˜æ€§èƒ½æŒ‡æ ‡ é¡ºåºè¯»å†™ï¼ˆååé‡ï¼Œå¸¸ç”¨å•ä½ä¸º MB/sï¼‰ï¼šæ–‡ä»¶åœ¨ç¡¬ç›˜ä¸Šå­˜å‚¨ä½ç½®æ˜¯è¿ç»­çš„ã€‚ é€‚ç”¨åœºæ™¯ï¼šå¤§æ–‡ä»¶æ‹·è´ï¼ˆæ¯”å¦‚è§†é¢‘éŸ³ä¹ï¼‰ã€‚é€Ÿåº¦å³ä½¿å¾ˆé«˜ï¼Œå¯¹æ•°æ®åº“æ€§èƒ½ä¹Ÿæ²¡æœ‰å‚è€ƒä»·å€¼ã€‚ 4K éšæœºè¯»å†™ï¼ˆIOPSï¼Œå¸¸ç”¨å•ä½ä¸ºæ¬¡ï¼‰ï¼šåœ¨ç¡¬ç›˜ä¸Šéšæœºä½ç½®è¯»å†™æ•°æ®ï¼Œæ¯æ¬¡ 4KBã€‚ é€‚ç”¨åœºæ™¯ï¼šæ“ä½œç³»ç»Ÿè¿è¡Œã€è½¯ä»¶è¿è¡Œã€æ•°æ®åº“ã€‚ ","date":"2022-10-18","objectID":"/posts/4d68ea/:0:3","tags":["fio","å­˜å‚¨"],"title":"FIOå­˜å‚¨æ€§èƒ½å·¥å…·","uri":"/posts/4d68ea/"},{"categories":["æ€§èƒ½"],"content":"å‚è€ƒèµ„æ–™ å®˜æ–¹æ–‡æ¡£ fioå•æœºæ€§èƒ½æµ‹è¯• é˜¿é‡Œäº‘æµ‹è¯•å—å­˜å‚¨æ€§èƒ½ ","date":"2022-10-18","objectID":"/posts/4d68ea/:0:4","tags":["fio","å­˜å‚¨"],"title":"FIOå­˜å‚¨æ€§èƒ½å·¥å…·","uri":"/posts/4d68ea/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":" ç®€ä»‹ ","date":"2022-10-15","objectID":"/posts/d75507/:0:0","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"OpenEBS æ˜¯ä»€ä¹ˆï¼Ÿ OpenEBS æ˜¯ä¸€ç§å¼€æºäº‘åŸç”Ÿå­˜å‚¨è§£å†³æ–¹æ¡ˆï¼Œæ‰˜ç®¡äº CNCF åŸºé‡‘ä¼šï¼Œç›®å‰è¯¥é¡¹ç›®å¤„äºæ²™ç®±é˜¶æ®µã€‚ OpenEBS æ˜¯ä¸€ç»„å­˜å‚¨å¼•æ“ï¼Œå…è®¸æ‚¨ä¸ºæœ‰çŠ¶æ€å·¥ä½œè´Ÿè½½ (StatefulSet) å’Œ Kubernetes å¹³å°ç±»å‹é€‰æ‹©æ­£ç¡®çš„å­˜å‚¨è§£å†³æ–¹æ¡ˆã€‚åœ¨é«˜å±‚æ¬¡ä¸Šï¼ŒOpenEBS æ”¯æŒä¸¤å¤§ç±»å·â€”â€”æœ¬åœ°å·å’Œå¤åˆ¶å·ã€‚ OpenEBS æ˜¯ Kubernetes æœ¬åœ°è¶…èåˆå­˜å‚¨è§£å†³æ–¹æ¡ˆï¼Œå®ƒç®¡ç†èŠ‚ç‚¹å¯ç”¨çš„æœ¬åœ°å­˜å‚¨ï¼Œå¹¶ä¸ºæœ‰çŠ¶æ€å·¥ä½œè´Ÿè½½æä¾›æœ¬åœ°æˆ–é«˜å¯ç”¨çš„åˆ†å¸ƒå¼æŒä¹…å·ã€‚ä½œä¸ºä¸€ä¸ªå®Œå…¨çš„ Kubernetes åŸç”Ÿè§£å†³æ–¹æ¡ˆçš„å¦ä¸€ä¸ªä¼˜åŠ¿æ˜¯ï¼Œç®¡ç†å‘˜å’Œå¼€å‘äººå‘˜å¯ä»¥ä½¿ç”¨ kubectlã€Helmã€ Prometheusã€Grafanaã€Weave Scope ç­‰ Kubernetes å¯ç”¨çš„æ‰€æœ‰ä¼˜ç§€å·¥å…·æ¥äº¤äº’å’Œç®¡ç† OpenEBSã€‚ ","date":"2022-10-15","objectID":"/posts/d75507/:0:1","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"OpenEBS èƒ½åšä»€ä¹ˆï¼Ÿ OpenEBS ç®¡ç† k8s èŠ‚ç‚¹ä¸Šå­˜å‚¨ï¼Œå¹¶ä¸º k8s æœ‰çŠ¶æ€è´Ÿè½½ï¼ˆStatefulSetï¼‰æä¾›æœ¬åœ°å­˜å‚¨å·æˆ–åˆ†å¸ƒå¼å­˜å‚¨å·ã€‚ æœ¬åœ°å·ï¼ˆLocal Storageï¼‰ OpenEBS å¯ä»¥ä½¿ç”¨å®¿ä¸»æœºè£¸å—è®¾å¤‡æˆ–åˆ†åŒºï¼Œæˆ–è€…ä½¿ç”¨ Hostpaths ä¸Šçš„å­ç›®å½•ï¼Œæˆ–è€…ä½¿ç”¨ LVMã€ZFS æ¥åˆ›å»ºæŒä¹…åŒ–å· æœ¬åœ°å·ç›´æ¥æŒ‚è½½åˆ° Stateful Pod ä¸­ï¼Œè€Œä¸éœ€è¦ OpenEBS åœ¨æ•°æ®è·¯å¾„ä¸­å¢åŠ ä»»ä½•å¼€é”€ OpenEBS ä¸ºæœ¬åœ°å·æä¾›äº†é¢å¤–çš„å·¥å…·ï¼Œç”¨äºç›‘æ§ã€å¤‡ä»½ / æ¢å¤ã€ç¾éš¾æ¢å¤ã€ç”± ZFS æˆ– LVM æ”¯æŒçš„å¿«ç…§ç­‰ å¯¹äºåˆ†å¸ƒå¼å· (å³å¤åˆ¶å·) OpenEBS ä½¿ç”¨å…¶ä¸­ä¸€ä¸ªå¼•æ“ (Mayastorã€cStor æˆ– Jiva) ä¸ºæ¯ä¸ªåˆ†å¸ƒå¼æŒä¹…å·åˆ›å»ºå¾®æœåŠ¡ æœ‰çŠ¶æ€ Pod å°†æ•°æ®å†™å…¥ OpenEBS å¼•æ“ï¼ŒOpenEBS å¼•æ“å°†æ•°æ®åŒæ­¥å¤åˆ¶åˆ°é›†ç¾¤ä¸­çš„å¤šä¸ªèŠ‚ç‚¹ã€‚OpenEBS å¼•æ“æœ¬èº«ä½œä¸º Pod éƒ¨ç½²ï¼Œå¹¶ç”± Kubernetes è¿›è¡Œåè°ƒã€‚å½“è¿è¡Œ Stateful Pod çš„èŠ‚ç‚¹å¤±è´¥æ—¶ï¼ŒPod å°†è¢«é‡æ–°è°ƒåº¦åˆ°é›†ç¾¤ä¸­çš„å¦ä¸€ä¸ªèŠ‚ç‚¹ï¼ŒOpenEBS å°†ä½¿ç”¨å…¶ä»–èŠ‚ç‚¹ä¸Šçš„å¯ç”¨æ•°æ®å‰¯æœ¬æä¾›å¯¹æ•°æ®çš„è®¿é—® æœ‰çŠ¶æ€çš„ Pods ä½¿ç”¨ iSCSI (cStor å’Œ Jiva) æˆ– NVMeoF (Mayastor) è¿æ¥ OpenEBS åˆ†å¸ƒå¼æŒä¹…å· OpenEBS cStor å’Œ Jiva ä¸“æ³¨äºå­˜å‚¨çš„æ˜“ç”¨æ€§å’ŒæŒä¹…æ€§ã€‚å®ƒä»¬åˆ†åˆ«ä½¿ç”¨è‡ªå®šä¹‰ç‰ˆæœ¬çš„ ZFS å’Œ Longhorn æŠ€æœ¯å°†æ•°æ®å†™å…¥å­˜å‚¨ã€‚OpenEBS Mayastor æ˜¯æœ€æ–°å¼€å‘çš„ä»¥è€ä¹…æ€§å’Œæ€§èƒ½ä¸ºè®¾è®¡ç›®æ ‡çš„å¼•æ“ï¼Œé«˜æ•ˆåœ°ç®¡ç†è®¡ç®— (å¤§é¡µé¢ã€æ ¸å¿ƒ) å’Œå­˜å‚¨ (NVMe Drives)ï¼Œä»¥æä¾›å¿«é€Ÿåˆ†å¸ƒå¼å—å­˜å‚¨ âæ³¨æ„ï¼šOpenEBS åˆ†å¸ƒå¼å—å·è¢«ç§°ä¸ºå¤åˆ¶å·ï¼Œä»¥é¿å…ä¸ä¼ ç»Ÿçš„åˆ†å¸ƒå¼å—å­˜å‚¨æ··æ·†ï¼Œä¼ ç»Ÿçš„åˆ†å¸ƒå¼å—å­˜å‚¨å€¾å‘äºå°†æ•°æ®åˆ†å¸ƒåˆ°é›†ç¾¤ä¸­çš„è®¸å¤šèŠ‚ç‚¹ä¸Šã€‚å¤åˆ¶å·æ˜¯ä¸ºäº‘åŸç”Ÿæœ‰çŠ¶æ€å·¥ä½œè´Ÿè½½è®¾è®¡çš„ï¼Œè¿™äº›å·¥ä½œè´Ÿè½½éœ€è¦å¤§é‡çš„å·ï¼Œè¿™äº›å·çš„å®¹é‡é€šå¸¸å¯ä»¥ä»å•ä¸ªèŠ‚ç‚¹æä¾›ï¼Œè€Œä¸æ˜¯ä½¿ç”¨è·¨é›†ç¾¤ä¸­çš„å¤šä¸ªèŠ‚ç‚¹åˆ†ç‰‡çš„å•ä¸ªå¤§å· ","date":"2022-10-15","objectID":"/posts/d75507/:0:2","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"å¯¹æ¯”ä¼ ç»Ÿåˆ†å¸ƒå¼å­˜å‚¨ OpenEBS ä¸å…¶ä»–ä¼ ç»Ÿå­˜å‚¨è§£å†³æ–¹æ¡ˆä¸åŒçš„å‡ ä¸ªå…³é”®æ–¹é¢ : ä½¿ç”¨å¾®æœåŠ¡ä½“ç³»ç»“æ„æ„å»ºï¼Œå°±åƒå®ƒæ‰€æœåŠ¡çš„åº”ç”¨ç¨‹åºä¸€æ ·ã€‚OpenEBS æœ¬èº«ä½œä¸ºä¸€ç»„å®¹å™¨éƒ¨ç½²åœ¨ Kubernetes å·¥ä½œèŠ‚ç‚¹ä¸Šã€‚ä½¿ç”¨ Kubernetes æœ¬èº«æ¥ç¼–æ’å’Œç®¡ç† OpenEBS ç»„ä»¶ å®Œå…¨å»ºç«‹åœ¨ç”¨æˆ·ç©ºé—´ï¼Œä½¿å…¶é«˜åº¦å¯ç§»æ¤æ€§ï¼Œä»¥è¿è¡Œåœ¨ä»»ä½•æ“ä½œç³»ç»Ÿ / å¹³å°ã€‚ å®Œå…¨æ„å›¾é©±åŠ¨ï¼Œç»§æ‰¿äº† Kubernetes æ˜“ç”¨æ€§çš„ç›¸åŒåŸåˆ™ OpenEBS æ”¯æŒä¸€ç³»åˆ—å­˜å‚¨å¼•æ“ï¼Œå› æ­¤å¼€å‘äººå‘˜å¯ä»¥éƒ¨ç½²é€‚åˆäºå…¶åº”ç”¨ç¨‹åºè®¾è®¡ç›®æ ‡çš„å­˜å‚¨æŠ€æœ¯ã€‚åƒ Cassandra è¿™æ ·çš„åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºå¯ä»¥ä½¿ç”¨ LocalPV å¼•æ“è¿›è¡Œæœ€ä½å»¶è¿Ÿçš„å†™æ“ä½œã€‚åƒ MySQL å’Œ PostgreSQL è¿™æ ·çš„å•ç‰‡åº”ç”¨ç¨‹åºå¯ä»¥ä½¿ç”¨ä½¿ç”¨ NVMe å’Œ SPDK æ„å»ºçš„ Mayastor æˆ–åŸºäº ZFS çš„ cStor æ¥å®ç°å¼¹æ€§ã€‚åƒ Kafka è¿™æ ·çš„æµåª’ä½“åº”ç”¨ç¨‹åºå¯ä»¥åœ¨è¾¹ç¼˜ç¯å¢ƒä¸­ä½¿ç”¨ NVMe å¼•æ“ Mayastor ä»¥è·å¾—æœ€ä½³æ€§èƒ½ã€‚ é©±ä½¿ç”¨æˆ·ä½¿ç”¨ OpenEBS çš„ä¸»è¦åŸå› æ˜¯ : åœ¨æ‰€æœ‰çš„ Kubernetes å‘è¡Œç‰ˆä¸Šéƒ½æ˜¯å¯ç§»æ¤çš„ æé«˜äº†å¼€å‘äººå‘˜å’Œå¹³å° SRE çš„ç”Ÿäº§åŠ› ä¸å…¶ä»–è§£å†³æ–¹æ¡ˆç›¸æ¯”ï¼Œæ˜“äºä½¿ç”¨ ä¼˜ç§€çš„ç¤¾åŒºæ”¯æŒ å…è´¹å¼€æº ","date":"2022-10-15","objectID":"/posts/d75507/:0:3","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"æœ¬åœ°å·ç±»å‹ æœ¬åœ°å·åªèƒ½ä»é›†ç¾¤ä¸­çš„å•ä¸ªèŠ‚ç‚¹è®¿é—®ã€‚å¿…é¡»åœ¨æä¾›å·çš„èŠ‚ç‚¹ä¸Šè°ƒåº¦ä½¿ç”¨ Local Volume çš„ Podsã€‚æœ¬åœ°å·é€šå¸¸æ˜¯åˆ†å¸ƒå¼å·¥ä½œè´Ÿè½½çš„é¦–é€‰ï¼Œæ¯”å¦‚ Cassandraã€MongoDBã€Elastic ç­‰ï¼Œè¿™äº›å·¥ä½œè´Ÿè½½æœ¬è´¨ä¸Šæ˜¯åˆ†å¸ƒå¼çš„ï¼Œå¹¶ä¸”å†…ç½®äº†é«˜å¯ç”¨æ€§ï¼ˆåˆ†ç‰‡ï¼‰ æ ¹æ®é™„åŠ åˆ° Kubernetes å·¥ä½œèŠ‚ç‚¹ä¸Šçš„å­˜å‚¨ç±»å‹ï¼Œæ‚¨å¯ä»¥ä»ä¸åŒçš„åŠ¨æ€æœ¬åœ° PV è¿›è¡Œé€‰æ‹©â€”â€”Hostpathã€Deviceã€LVMã€ZFS æˆ– Rawfile ","date":"2022-10-15","objectID":"/posts/d75507/:0:4","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"å¯å¤åˆ¶å·ç±»å‹ å¤åˆ¶å·é¡¾åæ€ä¹‰ï¼Œæ˜¯æŒ‡å°†æ•°æ®åŒæ­¥å¤åˆ¶åˆ°å¤šä¸ªèŠ‚ç‚¹çš„å·ã€‚å·å¯ä»¥æ”¯æŒèŠ‚ç‚¹æ•…éšœã€‚è¿˜å¯ä»¥è·¨å¯ç”¨æ€§åŒºåŸŸè®¾ç½®å¤åˆ¶ï¼Œä»¥å¸®åŠ©åº”ç”¨ç¨‹åºè·¨å¯ç”¨æ€§åŒºåŸŸç§»åŠ¨ã€‚ å¤åˆ¶å·è¿˜èƒ½å¤Ÿæä¾›åƒå¿«ç…§ã€å…‹éš†ã€å·æ‰©å±•ç­‰ä¼ä¸šå­˜å‚¨ç‰¹æ€§ã€‚å¤åˆ¶å·æ˜¯æœ‰çŠ¶æ€å·¥ä½œè´Ÿè½½ (å¦‚ Percona/MySQLã€Jiraã€GitLab ç­‰) çš„é¦–é€‰ã€‚ æ ¹æ®é™„åŠ åˆ° Kubernetes å·¥ä½œèŠ‚ç‚¹çš„å­˜å‚¨ç±»å‹å’Œåº”ç”¨ç¨‹åºæ€§èƒ½éœ€æ±‚ï¼Œæ‚¨å¯ä»¥ä» Jivaã€cStor æˆ– Mayastor ä¸­è¿›è¡Œé€‰æ‹© ","date":"2022-10-15","objectID":"/posts/d75507/:0:5","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"OpenEBS å­˜å‚¨å¼•æ“å»ºè®® åº”ç”¨éœ€æ±‚ å­˜å‚¨ç±»å‹ OpenEBS å·ç±»å‹ ä½æ—¶å»¶ã€é«˜å¯ç”¨æ€§ã€åŒæ­¥å¤åˆ¶ã€å¿«ç…§ã€å…‹éš†ã€ç²¾ç®€é…ç½® SSD/ äº‘å­˜å‚¨å· OpenEBS Mayastor é«˜å¯ç”¨æ€§ã€åŒæ­¥å¤åˆ¶ã€å¿«ç…§ã€å…‹éš†ã€ç²¾ç®€é…ç½® æœºæ¢° /SSD/ äº‘å­˜å‚¨å· OpenEBS cStor é«˜å¯ç”¨æ€§ã€åŒæ­¥å¤åˆ¶ã€ç²¾ç®€é…ç½® ä¸»æœºè·¯å¾„æˆ–å¤–éƒ¨æŒ‚è½½å­˜å‚¨ OpenEBS Jiva ä½æ—¶å»¶ã€æœ¬åœ° PV ä¸»æœºè·¯å¾„æˆ–å¤–éƒ¨æŒ‚è½½å­˜å‚¨ Dynamic Local PV - Hostpath, Dynamic Local PV - Rawfile ä½æ—¶å»¶ã€æœ¬åœ° PV æœ¬åœ°æœºæ¢° /SSD/ äº‘å­˜å‚¨å·ç­‰å—è®¾å¤‡ Dynamic Local PV - Device ä½å»¶è¿Ÿï¼Œæœ¬åœ° PVï¼Œå¿«ç…§ï¼Œå…‹éš† æœ¬åœ°æœºæ¢° /SSD/ äº‘å­˜å‚¨å·ç­‰å—è®¾å¤‡ OpenEBS Dynamic Local PV - ZFS , OpenEBS Dynamic Local PV - LVM æ€»ç»“ï¼š å¤šæœºç¯å¢ƒï¼Œå¦‚æœæœ‰é¢å¤–çš„å—è®¾å¤‡ï¼ˆéç³»ç»Ÿç›˜å—è®¾å¤‡ï¼‰ä½œä¸ºæ•°æ®ç›˜ï¼Œé€‰ç”¨ OpenEBS Mayastorã€OpenEBS cStor å¤šæœºç¯å¢ƒï¼Œå¦‚æœæ²¡æœ‰é¢å¤–çš„å—è®¾å¤‡ï¼ˆéç³»ç»Ÿç›˜å—è®¾å¤‡ï¼‰ä½œä¸ºæ•°æ®ç›˜ï¼Œä»…å•å—ç³»ç»Ÿç›˜å—è®¾å¤‡ï¼Œé€‰ç”¨ OpenEBS Jiva å•æœºç¯å¢ƒï¼Œå»ºè®®æœ¬åœ°è·¯å¾„ Dynamic Local PV - Hostpath, Dynamic Local PV - Rawfileï¼Œç”±äºå•æœºå¤šç”¨äºæµ‹è¯•ç¯å¢ƒï¼Œæ•°æ®å¯é æ€§è¦æ±‚è¾ƒä½ã€‚ ç”±æ­¤çœ‹æ¥ï¼ŒOpenEBS å¸¸ç”¨åœºæ™¯ä¸ºä»¥ä¸Šä¸‰ä¸ªåœºæ™¯ ","date":"2022-10-15","objectID":"/posts/d75507/:0:6","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"OpenEBS ç‰¹æ€§ ","date":"2022-10-15","objectID":"/posts/d75507/:0:7","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"å®¹å™¨é™„åŠ å­˜å‚¨ OpenEBS æ˜¯ä¸€ä¸ªå®¹å™¨é™„åŠ å­˜å‚¨ (Container Attached Storage, CAS) çš„ä¾‹å­ã€‚é€šè¿‡ OpenEBS æä¾›çš„å·æ€»æ˜¯è¢«å®¹å™¨åŒ–ã€‚æ¯ä¸ªå·éƒ½æœ‰ä¸€ä¸ªä¸“ç”¨çš„å­˜å‚¨æ§åˆ¶å™¨ï¼Œç”¨äºæé«˜æœ‰çŠ¶æ€åº”ç”¨ç¨‹åºçš„æŒä¹…æ€§å­˜å‚¨æ“ä½œçš„æ•æ·æ€§å’Œç²’åº¦ã€‚ ","date":"2022-10-15","objectID":"/posts/d75507/:0:8","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"åŒæ­¥å¤åˆ¶ åŒæ­¥å¤åˆ¶æ˜¯ OpenEBS çš„ä¸€ä¸ªå¯é€‰çš„æµè¡Œç‰¹æ€§ã€‚å½“ä¸ Jivaã€cStor å’Œ Mayastor å­˜å‚¨å¼•æ“ä¸€èµ·ä½¿ç”¨æ—¶ï¼ŒOpenEBS å¯ä»¥åŒæ­¥å¤åˆ¶æ•°æ®å·ä»¥å®ç°é«˜å¯ç”¨æ€§ã€‚è·¨ Kubernetes åŒºåŸŸè¿›è¡Œå¤åˆ¶ï¼Œä»è€Œä¸ºè·¨ AZ è®¾ç½®æä¾›é«˜å¯ç”¨æ€§ã€‚è¿™ä¸ªç‰¹æ€§å¯¹äºä½¿ç”¨ GKEã€EKS å’Œ AKS ç­‰äº‘æä¾›å•†æœåŠ¡ä¸Šçš„æœ¬åœ°ç£ç›˜æ„å»ºé«˜å¯ç”¨çŠ¶æ€åº”ç”¨ç¨‹åºç‰¹åˆ«æœ‰ç”¨ ","date":"2022-10-15","objectID":"/posts/d75507/:0:9","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"å¿«ç…§å’Œå…‹éš† å†™æ—¶æ‹·è´å¿«ç…§æ˜¯ OpenEBS å¦ä¸€ä¸ªå¯é€‰çš„æµè¡Œç‰¹æ€§ã€‚ä½¿ç”¨ cStor å¼•æ“æ—¶ï¼Œå¿«ç…§æ˜¯ç¬æ—¶åˆ›å»ºçš„ï¼Œå¹¶ä¸”ä¸å—å¿«ç…§ä¸ªæ•°çš„é™åˆ¶ã€‚å¢é‡å¿«ç…§åŠŸèƒ½å¢å¼ºäº†è·¨ Kubernetes é›†ç¾¤å’Œè·¨ä¸åŒäº‘æä¾›å•†æˆ–æ•°æ®ä¸­å¿ƒçš„æ•°æ®è¿ç§»å’Œå¯ç§»æ¤æ€§ã€‚å¯¹å¿«ç…§å’Œå…‹éš†çš„æ“ä½œå®Œå…¨ä»¥ Kubernetes åŸç”Ÿæ–¹æ³•æ‰§è¡Œï¼Œä½¿ç”¨æ ‡å‡† kubectl å‘½ä»¤ã€‚å¸¸è§çš„ç”¨ä¾‹åŒ…æ‹¬ç”¨äºå¤‡ä»½çš„é«˜æ•ˆå¤åˆ¶å’Œç”¨äºæ•…éšœæ’é™¤æˆ–é’ˆå¯¹æ•°æ®çš„åªè¯»å‰¯æœ¬è¿›è¡Œå¼€å‘çš„å…‹éš† ","date":"2022-10-15","objectID":"/posts/d75507/:0:10","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"å¤‡ä»½å’Œæ¢å¤ OpenEBS å·çš„å¤‡ä»½å’Œæ¢å¤å¯ä»¥é€šè¿‡å¼€æºçš„ OpenEBS Velero æ’ä»¶ä¸ Kubernetes å¤‡ä»½å’Œæ¢å¤è§£å†³æ–¹æ¡ˆ (å¦‚ Velero(å‰èº«ä¸º Heptio Ark)) ååŒå·¥ä½œã€‚ç»å¸¸ä½¿ç”¨ OpenEBS å¢é‡å¿«ç…§åŠŸèƒ½ï¼Œå°†æ•°æ®å¤‡ä»½åˆ° AWS S3ã€GCP object storageã€MinIO ç­‰å¯¹è±¡å­˜å‚¨ç›®æ ‡ã€‚è¿™ç§å­˜å‚¨çº§åˆ«çš„å¿«ç…§å’Œå¤‡ä»½åªä½¿ç”¨å¢é‡æ•°æ®è¿›è¡Œå¤‡ä»½ï¼ŒèŠ‚çœäº†å¤§é‡çš„å¸¦å®½å’Œå­˜å‚¨ç©ºé—´ã€‚ ","date":"2022-10-15","objectID":"/posts/d75507/:0:11","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"çœŸæ­£çš„ Kubernetes äº‘åŸç”Ÿå­˜å‚¨ OpenEBS æ˜¯ Kubernetes ä¸Šæœ‰çŠ¶æ€åº”ç”¨ç¨‹åºçš„äº‘åŸç”Ÿå­˜å‚¨ï¼Œäº‘åŸç”Ÿæ„å‘³ç€éµå¾ªæ¾æ•£è€¦åˆçš„ä½“ç³»ç»“æ„ã€‚å› æ­¤ï¼Œäº‘åŸç”Ÿã€æ¾æ•£è€¦åˆä½“ç³»ç»“æ„çš„ä¸€èˆ¬å¥½å¤„æ˜¯é€‚ç”¨çš„ã€‚ä¾‹å¦‚ï¼Œå¼€å‘äººå‘˜å’Œ DevOps æ¶æ„å¸ˆå¯ä»¥ä½¿ç”¨æ ‡å‡†çš„ Kubernetes æŠ€èƒ½å’Œå®ç”¨ç¨‹åºæ¥é…ç½®ã€ä½¿ç”¨å’Œç®¡ç†æŒä¹…å­˜å‚¨éœ€æ±‚ ","date":"2022-10-15","objectID":"/posts/d75507/:0:12","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"å‡å°‘å­˜å‚¨ TCO é«˜è¾¾ 50% åœ¨å¤§å¤šæ•°äº‘ä¸Šï¼Œå—å­˜å‚¨çš„æ”¶è´¹æ˜¯åŸºäºè´­ä¹°çš„å¤šå°‘ï¼Œè€Œä¸æ˜¯ä½¿ç”¨çš„å¤šå°‘ ; ä¸ºäº†å®ç°æ›´é«˜çš„æ€§èƒ½ï¼Œå¹¶åœ¨å……åˆ†åˆ©ç”¨å®¹é‡æ—¶æ¶ˆé™¤ä¸­æ–­çš„é£é™©ï¼Œå®¹é‡ç»å¸¸è¢«è¿‡åº¦é…ç½®ã€‚OpenEBS çš„ç²¾ç®€é…ç½®èƒ½åŠ›å¯ä»¥å…±äº«æœ¬åœ°å­˜å‚¨æˆ–äº‘å­˜å‚¨ï¼Œç„¶åæ ¹æ®éœ€è¦å¢åŠ æœ‰çŠ¶æ€åº”ç”¨ç¨‹åºçš„æ•°æ®é‡ã€‚å¯ä»¥åŠ¨æ€æ·»åŠ å­˜å‚¨ï¼Œè€Œä¸ä¼šä¸­æ–­æš´éœ²ç»™å·¥ä½œè´Ÿè½½æˆ–åº”ç”¨ç¨‹åºçš„å·ã€‚æŸäº›ç”¨æˆ·æŠ¥å‘Šè¯´ï¼Œç”±äºä½¿ç”¨äº† OpenEBSçš„ç²¾ç®€é…ç½®ï¼ŒèŠ‚çœäº†è¶…è¿‡ 60% çš„èµ„æºã€‚ ","date":"2022-10-15","objectID":"/posts/d75507/:0:13","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"é«˜å¯ç”¨æ€§ ç”±äº OpenEBS éµå¾ª CAS æ¶æ„ï¼Œåœ¨èŠ‚ç‚¹æ•…éšœæ—¶ï¼ŒKubernetes å°†é‡æ–°è°ƒåº¦ OpenEBS æ§åˆ¶å™¨ï¼Œè€Œåº•å±‚æ•°æ®åˆ™é€šè¿‡ä½¿ç”¨ä¸€ä¸ªæˆ–å¤šä¸ªå‰¯æœ¬æ¥ä¿æŠ¤ã€‚æ›´é‡è¦çš„æ˜¯â€”â€”å› ä¸ºæ¯ä¸ªå·¥ä½œè´Ÿè½½éƒ½å¯ä»¥åˆ©ç”¨è‡ªå·±çš„ OpenEBSâ€”â€”ä¸å­˜åœ¨å› å­˜å‚¨ä¸¢å¤±è€Œå¯¼è‡´ç³»ç»Ÿå¤§èŒƒå›´å®•æœºçš„é£é™©ã€‚ä¾‹å¦‚ï¼Œå·çš„å…ƒæ•°æ®ä¸æ˜¯é›†ä¸­çš„ï¼Œå®ƒå¯èƒ½ä¼šåƒè®¸å¤šå…±äº«å­˜å‚¨ç³»ç»Ÿé‚£æ ·å—åˆ°ç¾éš¾æ€§çš„é€šç”¨ä¸­æ–­çš„å½±å“ã€‚ç›¸åï¼Œå…ƒæ•°æ®ä¿æŒåœ¨å·çš„æœ¬åœ°ã€‚ä¸¢å¤±ä»»ä½•èŠ‚ç‚¹éƒ½ä¼šå¯¼è‡´åªå­˜åœ¨äºè¯¥èŠ‚ç‚¹ä¸Šçš„å·å‰¯æœ¬çš„ä¸¢å¤±ã€‚ç”±äºå·æ•°æ®è‡³å°‘åœ¨å…¶ä»–ä¸¤ä¸ªèŠ‚ç‚¹ä¸Šè¿›è¡Œäº†åŒæ­¥å¤åˆ¶ï¼Œå› æ­¤å½“ä¸€ä¸ªèŠ‚ç‚¹å‡ºç°æ•…éšœæ—¶ï¼Œè¿™äº›æ•°æ®å°†åœ¨ç›¸åŒçš„æ€§èƒ½çº§åˆ«ä¸Šç»§ç»­å¯ç”¨ ","date":"2022-10-15","objectID":"/posts/d75507/:0:14","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"CAS ä»‹ç» åœ¨ CAS æˆ–å®¹å™¨é™„åŠ å­˜å‚¨ (Container Attached Storage) ä½“ç³»ç»“æ„ä¸­ï¼Œå­˜å‚¨åœ¨å®¹å™¨ä¸­è¿è¡Œï¼Œå¹¶ä¸”ä¸å­˜å‚¨ç»‘å®šåˆ°çš„åº”ç”¨ç¨‹åºå¯†åˆ‡ç›¸å…³ã€‚å­˜å‚¨ä½œä¸ºå¾®æœåŠ¡è¿è¡Œï¼Œæ²¡æœ‰å†…æ ¸æ¨¡å—ä¾èµ–å…³ç³»ã€‚åƒ Kubernetes è¿™æ ·çš„ç¼–æ’ç³»ç»Ÿç¼–æ’å­˜å‚¨å·ï¼Œå°±åƒä»»ä½•å…¶ä»–å¾®æœåŠ¡æˆ–å®¹å™¨ä¸€æ ·ã€‚CAS å…·æœ‰ DAS å’Œ NAS çš„ä¼˜ç‚¹ ","date":"2022-10-15","objectID":"/posts/d75507/:0:15","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"é CAS ç³»ç»Ÿä¸Šçš„ PV åœ¨é CAS æ¨¡å‹ä¸­ï¼ŒKubernetes æŒä¹…å·ä»ç„¶ä¸å†…æ ¸æ¨¡å—ç´§å¯†è€¦åˆï¼Œä½¿å¾— Kubernetes èŠ‚ç‚¹ä¸Šçš„å­˜å‚¨è½¯ä»¶æœ¬è´¨ä¸Šæ˜¯å•ç‰‡çš„ ","date":"2022-10-15","objectID":"/posts/d75507/:0:16","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"åŸºäº CAS ç³»ç»Ÿä¸Šçš„ PV ç›¸åï¼ŒCAS ä½¿æ‚¨èƒ½å¤Ÿåˆ©ç”¨äº‘åŸç”Ÿåº”ç”¨ç¨‹åºçš„çµæ´»æ€§å’Œå¯ä¼¸ç¼©æ€§ã€‚å®šä¹‰ Kubernetes PV (Persistent Volume) çš„å­˜å‚¨è½¯ä»¶æ˜¯åŸºäºå¾®æœåŠ¡æ¶æ„çš„ã€‚å­˜å‚¨è½¯ä»¶çš„æ§åˆ¶å¹³é¢ (å­˜å‚¨æ§åˆ¶å™¨) å’Œæ•°æ®å¹³é¢ (å­˜å‚¨å‰¯æœ¬) ä½œä¸º Kubernetes Podsè¿è¡Œï¼Œå› æ­¤ï¼Œä½¿æ‚¨èƒ½å¤Ÿå°†äº‘åŸç”Ÿçš„æ‰€æœ‰ä¼˜åŠ¿åº”ç”¨åˆ° CASã€‚ ","date":"2022-10-15","objectID":"/posts/d75507/:0:17","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"CAS ä¼˜åŠ¿ æ•æ· CAS ä¸­çš„æ¯ä¸ªå­˜å‚¨å·éƒ½æœ‰ä¸€ä¸ªå®¹å™¨åŒ–çš„å­˜å‚¨æ§åˆ¶å™¨å’Œç›¸åº”çš„å®¹å™¨åŒ–å‰¯æœ¬ã€‚å› æ­¤ï¼Œå›´ç»•è¿™äº›ç»„ä»¶çš„èµ„æºçš„ç»´æŠ¤å’Œè°ƒä¼˜æ˜¯çœŸæ­£æ•æ·çš„ã€‚Kubernetes æ»šåŠ¨å‡çº§åŠŸèƒ½å¯ä»¥å®ç°å­˜å‚¨æ§åˆ¶å™¨å’Œå­˜å‚¨å‰¯æœ¬çš„æ— ç¼å‡çº§ã€‚å¯ä»¥ä½¿ç”¨å®¹å™¨ cGroups è°ƒä¼˜ CPUå’Œå†…å­˜ç­‰èµ„æºé…é¢ã€‚ å­˜å‚¨ç­–ç•¥ç²’åº¦åŒ– å°†å­˜å‚¨è½¯ä»¶å®¹å™¨åŒ–å¹¶å°†å­˜å‚¨æ§åˆ¶å™¨ä¸“ç”¨äºæ¯ä¸ªå·å¯ä»¥å¸¦æ¥æœ€å¤§çš„å­˜å‚¨ç­–ç•¥ç²’åº¦ã€‚åœ¨ CAS ä½“ç³»ç»“æ„ä¸­ï¼Œå¯ä»¥æŒ‰å·é…ç½®æ‰€æœ‰å­˜å‚¨ç­–ç•¥ã€‚æ­¤å¤–ï¼Œæ‚¨å¯ä»¥ç›‘è§†æ¯ä¸ªå·çš„å­˜å‚¨å‚æ•°ï¼Œå¹¶åŠ¨æ€æ›´æ–°å­˜å‚¨ç­–ç•¥ï¼Œä»¥å®ç°æ¯ä¸ªå·¥ä½œè´Ÿè½½çš„é¢„æœŸç»“æœã€‚éšç€å·å­˜å‚¨ç­–ç•¥ä¸­è¿™ç§é¢å¤–ç²’åº¦çº§åˆ«çš„å¢åŠ ï¼Œå­˜å‚¨ååé‡ã€IOPS å’Œå»¶è¿Ÿçš„æ§åˆ¶ä¹Ÿä¼šå¢åŠ ã€‚ äº‘åŸç”Ÿ CAS å°†å­˜å‚¨è½¯ä»¶è£…å…¥å®¹å™¨ï¼Œå¹¶ä½¿ç”¨ Kubernetes è‡ªå®šä¹‰èµ„æºå®šä¹‰ (CRDs) æ¥å£°æ˜ä½çº§å­˜å‚¨èµ„æºï¼Œå¦‚ç£ç›˜å’Œå­˜å‚¨æ± ã€‚è¿™ä¸ªæ¨¡å‹ä½¿å­˜å‚¨èƒ½å¤Ÿæ— ç¼åœ°é›†æˆåˆ°å…¶ä»–äº‘åŸç”Ÿå·¥å…·ä¸­ã€‚å¯ä»¥ä½¿ç”¨ Prometheusã€Grafanaã€Fluentdã€Weavescopeã€Jaeger ç­‰äº‘åŸç”Ÿå·¥å…·æ¥ä¾›åº”ã€ç›‘æ§å’Œç®¡ç†å­˜å‚¨èµ„æº PV æ˜¯ CAS ä¸­çš„ä¸€ä¸ªå¾®æœåŠ¡ å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œåœ¨ CAS æ¶æ„ä¸­ï¼Œå­˜å‚¨æ§åˆ¶å™¨å’Œå‰¯æœ¬çš„è½¯ä»¶å®Œå…¨æ˜¯åŸºäºå¾®æœåŠ¡çš„ï¼Œå› æ­¤ä¸æ¶‰åŠå†…æ ¸ç»„ä»¶ã€‚é€šå¸¸ï¼Œå­˜å‚¨æ§åˆ¶å™¨ POD è¢«è°ƒåº¦åœ¨ä¸æŒä¹…å·ç›¸åŒçš„èŠ‚ç‚¹ä¸Šï¼Œä»¥æé«˜æ•ˆç‡ï¼Œå‰¯æœ¬ POD å¯ä»¥è¢«è°ƒåº¦åœ¨é›†ç¾¤èŠ‚ç‚¹ä¸Šçš„ä»»ä½•ä½ç½®ã€‚æ¯ä¸ªå‰¯æœ¬ä½¿ç”¨æœ¬åœ°ç£ç›˜ã€SAN ç£ç›˜å’Œäº‘ç£ç›˜çš„ä»»æ„ç»„åˆå®Œå…¨ç‹¬ç«‹äºå…¶ä»–å‰¯æœ¬è¿›è¡Œé…ç½®ã€‚è¿™ä¸ºå¤§è§„æ¨¡ç®¡ç†å·¥ä½œè´Ÿè½½çš„å­˜å‚¨åˆ†é…æä¾›äº†å·¨å¤§çš„çµæ´»æ€§ã€‚ è¶…èåˆéåˆ†å¸ƒå¼ CAS æ¶æ„æ²¡æœ‰éµå¾ªå…¸å‹åˆ†å¸ƒå¼å­˜å‚¨æ¶æ„ã€‚é€šè¿‡ä»å­˜å‚¨æ§åˆ¶å™¨åˆ°å­˜å‚¨å‰¯æœ¬çš„åŒæ­¥å¤åˆ¶ï¼Œå­˜å‚¨å˜å¾—é«˜åº¦å¯ç”¨ã€‚å·å‰¯æœ¬çš„å…ƒæ•°æ®ä¸æ˜¯åœ¨èŠ‚ç‚¹ä¹‹é—´å…±äº«çš„ï¼Œè€Œæ˜¯åœ¨æ¯ä¸ªæœ¬åœ°èŠ‚ç‚¹ä¸Šç‹¬ç«‹ç®¡ç†ã€‚å¦‚æœä¸€ä¸ªèŠ‚ç‚¹æ•…éšœï¼Œå­˜å‚¨æ§åˆ¶å™¨ (åœ¨æœ¬ä¾‹ä¸­æ˜¯ä¸€ä¸ªæ— çŠ¶æ€å®¹å™¨) å°†åœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸Šè½®è½¬ï¼Œè¯¥èŠ‚ç‚¹ä¸Šè¿è¡Œç€ç¬¬äºŒä¸ªæˆ–ç¬¬ä¸‰ä¸ªå‰¯æœ¬ï¼Œæ•°æ®ä»ç„¶å¯ç”¨ã€‚ ä¸è¶…èåˆç³»ç»Ÿç±»ä¼¼ï¼ŒCAS ä¸­çš„å·çš„å­˜å‚¨å’Œæ€§èƒ½æ˜¯å¯æ‰©å±•çš„ã€‚ç”±äºæ¯ä¸ªå·éƒ½æœ‰è‡ªå·±çš„å­˜å‚¨æ§åˆ¶å™¨ï¼Œå› æ­¤å­˜å‚¨å¯ä»¥åœ¨ä¸€ä¸ªèŠ‚ç‚¹çš„å­˜å‚¨å®¹é‡å…è®¸çš„èŒƒå›´å†…è¿›è¡Œæ‰©å±•ã€‚åœ¨ç»™å®šçš„ Kubernetes é›†ç¾¤ä¸­ï¼Œéšç€å®¹å™¨åº”ç”¨ç¨‹åºæ•°é‡çš„å¢åŠ ï¼Œä¼šå¢åŠ æ›´å¤šçš„èŠ‚ç‚¹ï¼Œä»è€Œæé«˜å­˜å‚¨å®¹é‡å’Œæ€§èƒ½çš„æ•´ä½“å¯ç”¨æ€§ï¼Œä»è€Œä½¿å­˜å‚¨å¯¹æ–°çš„åº”ç”¨ç¨‹åºå®¹å™¨å¯ç”¨ã€‚è¿™ä¸€è¿‡ç¨‹ä¸ Nutanix ç­‰æˆåŠŸçš„è¶…èåˆç³»ç»Ÿéå¸¸ç›¸ä¼¼ã€‚ ","date":"2022-10-15","objectID":"/posts/d75507/:0:18","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"OpenESB æ¶æ„ä»‹ç» OpenESB éµå¾ªå®¹å™¨é™„åŠ å­˜å‚¨ï¼ˆCASï¼‰æ¨¡å‹ï¼Œæ¯ä¸ªå·éƒ½æœ‰ä¸€ä¸ªä¸“ç”¨çš„æ§åˆ¶å™¨ POD å’Œä¸€ç»„å‰¯æœ¬ PODã€‚CAS ä½“ç³»ç»“æ„çš„ä¼˜ç‚¹åœ¨**`CNCF` åšå®¢[1]** ä¸Šè¿›è¡Œäº†è®¨è®ºã€‚OpenEBS æ“ä½œå’Œä½¿ç”¨éƒ½å¾ˆç®€å•ï¼Œå› ä¸ºå®ƒçœ‹èµ·æ¥å’Œæ„Ÿè§‰ä¸Šå°±åƒå…¶ä»–äº‘åŸç”Ÿå’Œ Kubernetes å‹å¥½çš„é¡¹ç›®ã€‚ OpenEBS æœ‰è®¸å¤šç»„ä»¶ï¼Œå¯ä»¥åˆ†ä¸ºä»¥ä¸‹ç±»åˆ« : æ§åˆ¶é¢ç»„ä»¶ - Provisioner, API Server, volume exports,volume sidecars æ•°æ®é¢ç»„ä»¶ - Jivaã€cStor èŠ‚ç‚¹ç£ç›˜ç®¡ç†å™¨ - Discover, monitor, ç®¡ç†è¿æ¥ k8s çš„åª’ä»‹ ä¸äº‘åŸç”Ÿå·¥å…·çš„é›†æˆ - å·²ç»ä¸ Prometheus,Grafana, Fluentdã€Jaeger é›†æˆ ","date":"2022-10-15","objectID":"/posts/d75507/:1:0","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"æ§åˆ¶é¢ OpenEBSé›†ç¾¤çš„æ§åˆ¶å¹³é¢é€šå¸¸è¢«ç§°ä¸ºMayaã€‚ OpenEBS æ§åˆ¶å¹³é¢è´Ÿè´£æä¾›å·ã€ç›¸å…³çš„å·æ“ä½œï¼Œå¦‚å¿«ç…§ã€å…‹éš†ã€åˆ›å»ºå­˜å‚¨ç­–ç•¥ã€æ‰§è¡Œå­˜å‚¨ç­–ç•¥ã€å¯¼å‡º Prometheus/grafana ä½¿ç”¨çš„å·æŒ‡æ ‡ï¼Œç­‰ç­‰ã€‚ OpenEBS æä¾›äº†ä¸€ä¸ªåŠ¨æ€æä¾›ç¨‹åºï¼Œè¿™æ˜¯ Kubernetes çš„æ ‡å‡†å¤–éƒ¨å­˜å‚¨æ’ä»¶ã€‚OpenEBS PV æä¾›è€…çš„ä¸»è¦ä»»åŠ¡æ˜¯å‘åº”ç”¨ç¨‹åº PODS å¯åŠ¨å·ä¾›åº”ï¼Œå¹¶å®ç° PV çš„ Kubernetes è§„èŒƒã€‚ m-apiserver å¼€æ”¾å­˜å‚¨çš„ REST APIï¼Œå¹¶æ‰¿æ‹…å¤§é‡å·ç­–ç•¥å¤„ç†å’Œç®¡ç†å·¥ä½œã€‚ æ§åˆ¶å¹³é¢å’Œæ•°æ®å¹³é¢ä¹‹é—´çš„è¿é€šæ€§ä½¿ç”¨ Kubernetes sidecar æ¨¡å¼ã€‚æ§åˆ¶å¹³é¢éœ€è¦ä¸æ•°æ®å¹³é¢é€šä¿¡çš„åœºæ™¯å¦‚ä¸‹æ‰€ç¤ºã€‚ å¯¹äºå·çš„ç»Ÿè®¡ï¼Œå¦‚ IOPSï¼Œååé‡ï¼Œå»¶è¿Ÿç­‰â€“é€šè¿‡å·æš´æ¼çš„ sidecar å®ç° ä½¿ç”¨å·æ§åˆ¶å™¨ pod æ‰§è¡Œå·ç­–ç•¥ï¼Œä½¿ç”¨å·å‰¯æœ¬ pod è¿›è¡Œç£ç›˜ / æ± ç®¡ç†-é€šè¿‡å·ç®¡ç† sidecar å®ç° ","date":"2022-10-15","objectID":"/posts/d75507/:1:1","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"OpenEBS PV Provisioner æ­¤ç»„ä»¶ä½œä¸º POD è¿è¡Œï¼Œå¹¶åšå‡ºé…ç½®å†³ç­– , å®ƒçš„ä½¿ç”¨æ–¹å¼æ˜¯ : å¼€å‘äººå‘˜ç”¨æ‰€éœ€çš„å·å‚æ•°æ„é€ ä¸€ä¸ªå£°æ˜ï¼Œé€‰æ‹©é€‚å½“çš„å­˜å‚¨ç±»ï¼Œå¹¶åœ¨ YAML è§„èŒƒä¸Šè°ƒç”¨ kubeletã€‚OpenEBS PV åŠ¨æ€æä¾›ç¨‹åºä¸ maya-apiserver äº¤äº’ï¼Œåœ¨é€‚å½“çš„èŠ‚ç‚¹ä¸Šä¸ºå·æ§åˆ¶å™¨ pod å’Œå·å‰¯æœ¬ pod åˆ›å»ºéƒ¨ç½²è§„èŒƒã€‚å¯ä»¥ä½¿ç”¨ PVC è§„èŒƒä¸­çš„æ³¨é‡Šæ¥æ§åˆ¶å· Pod(æ§åˆ¶å™¨ / å‰¯æœ¬) çš„è°ƒåº¦ã€‚ ç›®å‰ï¼ŒOpenEBS Provisioner åªæ”¯æŒä¸€ç§ç»‘å®šç±»å‹ï¼Œå³ iSCSIã€‚ ","date":"2022-10-15","objectID":"/posts/d75507/:1:2","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"Maya-ApiServer m-apiserverä½œä¸ºPODè¿è¡Œã€‚é¡¾åæ€ä¹‰ï¼Œm-apiserverå…¬å¼€OpenEBS REST api`ã€‚ m-apiserver è¿˜è´Ÿè´£åˆ›å»ºåˆ›å»ºå· pod æ‰€éœ€çš„éƒ¨ç½²è§„èŒƒæ–‡ä»¶ã€‚åœ¨ç”Ÿæˆè¿™äº›è§„èŒƒæ–‡ä»¶ä¹‹åï¼Œå®ƒå°†è°ƒç”¨ kube-apiserver æ¥ç›¸åº”åœ°è°ƒåº¦è¿™äº› podsã€‚OpenEBS PV æä¾›è€…åœ¨å·å‘æ”¾ç»“æŸæ—¶ï¼Œå°†åˆ›å»ºä¸€ä¸ª PV å¯¹è±¡å¹¶å°†å…¶æŒ‚è½½åˆ°åº”ç”¨ç¨‹åº pod ä¸Šã€‚PV ç”±æ§åˆ¶å™¨ pod æ‰¿è½½ï¼Œæ§åˆ¶å™¨ pod ç”±ä¸åŒèŠ‚ç‚¹ä¸­çš„ä¸€ç»„å‰¯æœ¬ pod æ”¯æŒã€‚æ§åˆ¶å™¨ pod å’Œå¤åˆ¶ pod æ˜¯æ•°æ®å¹³é¢çš„ä¸€éƒ¨åˆ†ï¼Œåœ¨å­˜å‚¨å¼•æ“éƒ¨åˆ†æœ‰æ›´è¯¦ç»†çš„æè¿°ã€‚ m-apiserver çš„å¦ä¸€ä¸ªé‡è¦ä»»åŠ¡æ˜¯å·ç­–ç•¥ç®¡ç†ã€‚OpenEBS ä¸ºè¡¨ç¤ºç­–ç•¥æä¾›äº†éå¸¸ç»†ç²’åº¦çš„è§„èŒƒã€‚m-apiserver è§£é‡Šè¿™äº› YAML è§„èŒƒï¼Œå°†å®ƒä»¬è½¬æ¢ä¸ºå¯æ‰§è¡Œçš„ç»„ä»¶ï¼Œå¹¶é€šè¿‡å®¹é‡ç®¡ç† sidecar æ¥æ‰§è¡Œå®ƒä»¬ ","date":"2022-10-15","objectID":"/posts/d75507/:1:3","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"Maya Volume Exporter Mayaå·å¯¼å‡ºå™¨æ˜¯æ¯ä¸ªå­˜å‚¨æ§åˆ¶å™¨podçš„sidecar`ã€‚ è¿™äº› sidecar å°†æ§åˆ¶å¹³é¢è¿æ¥åˆ°æ•°æ®å¹³é¢ä»¥è·å–ç»Ÿè®¡ä¿¡æ¯ã€‚ç»Ÿè®¡ä¿¡æ¯çš„ç²’åº¦åœ¨å·çº§åˆ«ã€‚ä¸€äº›ç»Ÿè®¡æ•°æ®ç¤ºä¾‹å¦‚ä¸‹ï¼š å·è¯»å–å»¶è¿Ÿ å·å†™å…¥å»¶è¿Ÿ å·æ¯ç§’è¯»å–é€Ÿåº¦ å·æ¯ç§’å†™å…¥é€Ÿåº¦ è¯»å–å—å¤§å° å†™å…¥å—å¤§å° å®¹é‡ç»Ÿè®¡ è¿™äº›ç»Ÿè®¡ä¿¡æ¯é€šå¸¸ç”± Prometheus å®¢æˆ·ç«¯æ¥æ‹‰å–ï¼Œè¯¥å®¢æˆ·ç«¯åœ¨ OpenBS å®‰è£…æœŸé—´å®‰è£…å’Œé…ç½®ã€‚ ","date":"2022-10-15","objectID":"/posts/d75507/:1:4","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"å·ç®¡ç† sidecar Sidecars è¿˜ç”¨äºå°†æ§åˆ¶å™¨é…ç½®å‚æ•°å’Œå·ç­–ç•¥ä¼ é€’ç»™å·æ§åˆ¶å™¨ pod(å·æ§åˆ¶å™¨ pod æ˜¯ä¸€ä¸ªæ•°æ®å¹³é¢)ï¼Œ å¹¶å°†å‰¯æœ¬é…ç½®å‚æ•°å’Œå‰¯æœ¬æ•°æ®ä¿æŠ¤å‚æ•°ä¼ é€’ç»™å·å‰¯æœ¬ podã€‚ ","date":"2022-10-15","objectID":"/posts/d75507/:1:5","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"æ•°æ®é¢ OpenEBS æ•°æ®å¹³é¢è´Ÿè´£å®é™…çš„å· IO è·¯å¾„ã€‚å­˜å‚¨å¼•æ“åœ¨æ•°æ®å¹³é¢å®ç°å®é™…çš„ IO è·¯å¾„ã€‚ç›®å‰ï¼ŒOpenEBS æä¾›äº†ä¸¤ä¸ªå¯ä»¥è½»æ¾æ’å…¥çš„å­˜å‚¨å¼•æ“ã€‚å®ƒä»¬è¢«ç§°ä¸º Jiva å’Œ cStorã€‚è¿™ä¸¤ä¸ªå­˜å‚¨å¼•æ“éƒ½å®Œå…¨è¿è¡Œåœ¨ Linux ç”¨æˆ·ç©ºé—´ä¸­ï¼Œå¹¶åŸºäºå¾®æœåŠ¡æ¶æ„ã€‚ ","date":"2022-10-15","objectID":"/posts/d75507/:1:6","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"Jiva Jiva å­˜å‚¨å¼•æ“åŸºäº Rancher's LongHorn ä¸ gotgt å¼€å‘å®ç°ï¼Œ ä½¿ç”¨ go è¯­è¨€å¼€å‘ï¼Œå¹¶è¿è¡Œäºç”¨æˆ·å‘½åç©ºé—´ä¸‹ã€‚LongHorn æ§åˆ¶å™¨å°†è¾“å…¥çš„ IO åŒæ­¥å¤åˆ¶åˆ° LongHorn å‰¯æœ¬ã€‚è¯¥å‰¯æœ¬å°† Linux ç¨€ç–æ–‡ä»¶è§†ä¸ºæ„å»ºå­˜å‚¨ç‰¹æ€§ (å¦‚ç²¾ç®€é…ç½®ã€å¿«ç…§ã€é‡å»ºç­‰) çš„åŸºç¡€ã€‚ ","date":"2022-10-15","objectID":"/posts/d75507/:1:7","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"cStor cStor æ•°æ®å¼•æ“ä½¿ç”¨ C è¯­è¨€ç¼–å†™ï¼Œå…·æœ‰é«˜æ€§èƒ½çš„ iSCSI target å’Œ Copy-On-Write å—ç³»ç»Ÿï¼Œæä¾›æ•°æ®å®Œæ•´æ€§ã€æ•°æ®å¼¹æ€§å’Œæ—¶é—´ç‚¹çš„å¿«ç…§å’Œå…‹éš†ã€‚cStor æœ‰ä¸€ä¸ªæ± ç‰¹æ€§ï¼Œå®ƒä»¥æ¡å¸¦ã€é•œåƒæˆ– RAIDZ æ¨¡å¼èšåˆä¸€ä¸ªèŠ‚ç‚¹ä¸Šçš„ç£ç›˜ï¼Œä»¥æä¾›æ›´å¤§çš„å®¹é‡å’Œæ€§èƒ½å•ä½ã€‚cStor è¿˜å¯ä»¥è·¨åŒºåŸŸå°†æ•°æ®åŒæ­¥å¤åˆ¶åˆ°å¤šä¸ªèŠ‚ç‚¹ï¼Œä»è€Œé¿å…èŠ‚ç‚¹ä¸¢å¤±æˆ–èŠ‚ç‚¹é‡å¯å¯¼è‡´æ•°æ®ä¸å¯ç”¨ã€‚ ","date":"2022-10-15","objectID":"/posts/d75507/:1:8","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"LocalPV å¯¹äºé‚£äº›ä¸éœ€è¦å­˜å‚¨çº§å¤åˆ¶çš„åº”ç”¨ç¨‹åºï¼ŒLocalPV å¯èƒ½æ˜¯å¾ˆå¥½çš„é€‰æ‹©ï¼Œå› ä¸ºå®ƒèƒ½æä¾›æ›´é«˜çš„æ€§èƒ½ã€‚OpenEBS LocalPVä¸ Kubernetes LocalPV ç±»ä¼¼ï¼Œä¸åŒä¹‹å¤„åœ¨äºå®ƒæ˜¯ç”± OpenEBS æ§åˆ¶å¹³é¢åŠ¨æ€æä¾›çš„ï¼Œ å°±åƒä»»ä½•å…¶ä»–å¸¸è§„ PVä¸€æ ·ã€‚OpenEBS LocalPV æœ‰ä¸¤ç§ç±»å‹ :hostpath LocalPV å’Œ device LocalPVã€‚hostpath LocalPV æŒ‡çš„æ˜¯ä¸»æœºä¸Šçš„å­ç›®å½•ï¼ŒLocalPV æŒ‡çš„æ˜¯åœ¨èŠ‚ç‚¹ä¸Šå‘ç°çš„ç£ç›˜ (å¯ä»¥æ˜¯ç›´æ¥è¿æ¥çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯ç½‘ç»œè¿æ¥çš„)ã€‚OpenEBSå¼•å…¥äº†ä¸€ä¸ª LocalPV æä¾›è€…ï¼Œç”¨äºæ ¹æ® PVC å’Œå­˜å‚¨ç±»è§„èŒƒä¸­çš„ä¸€äº›æ ‡å‡†é€‰æ‹©åŒ¹é…çš„ç£ç›˜æˆ–ä¸»æœºè·¯å¾„ã€‚ ","date":"2022-10-15","objectID":"/posts/d75507/:1:9","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"èŠ‚ç‚¹ç£ç›˜ç®¡ç†å™¨ èŠ‚ç‚¹ç£ç›˜ç®¡ç†å™¨ (NDM) å¡«è¡¥äº†ä½¿ç”¨ Kubernetes ç®¡ç†æœ‰çŠ¶æ€åº”ç”¨ç¨‹åºçš„æŒä¹…å­˜å‚¨æ‰€éœ€çš„å·¥å…·é“¾çš„ç©ºç™½ã€‚å®¹å™¨æ—¶ä»£çš„ DevOps æ¶æ„å¸ˆå¿…é¡»ä»¥ä¸€ç§è‡ªåŠ¨åŒ–çš„æ–¹å¼æ»¡è¶³åº”ç”¨ç¨‹åºå’Œåº”ç”¨ç¨‹åºå¼€å‘äººå‘˜çš„åŸºç¡€è®¾æ–½éœ€æ±‚ï¼Œ è¿™ç§æ–¹å¼å¯ä»¥è·¨ç¯å¢ƒæä¾›å¼¹æ€§å’Œä¸€è‡´æ€§ã€‚è¿™äº›è¦æ±‚æ„å‘³ç€å­˜å‚¨å †æ ˆæœ¬èº«å¿…é¡»éå¸¸çµæ´»ï¼Œ ä»¥ä¾¿ Kubernetes å’Œäº‘åŸç”Ÿç”Ÿæ€ç³»ç»Ÿä¸­çš„å…¶ä»–è½¯ä»¶å¯ä»¥è½»æ¾åœ°ä½¿ç”¨è¿™ä¸ªå †æ ˆã€‚NDM åœ¨ Kubernetes çš„å­˜å‚¨å †æ ˆä¸­èµ·ç€åŸºç¡€æ€§çš„ä½œç”¨ï¼Œå®ƒç»Ÿä¸€äº†ä¸åŒçš„ç£ç›˜ï¼Œ å¹¶é€šè¿‡å°†å®ƒä»¬æ ‡è¯†ä¸º Kubernetes å¯¹è±¡ï¼Œæä¾›äº†å°†å®ƒä»¬æ±‡èšçš„èƒ½åŠ›ã€‚æ­¤å¤–ï¼ŒNDM å‘ç°ã€æä¾›ã€ç›‘è§†å’Œç®¡ç†åº•å±‚ç£ç›˜çš„æ–¹å¼ï¼Œå¯ä»¥è®© Kubernetes PV æä¾›è€… (å¦‚ OpenEBS å’Œå…¶ä»–å­˜å‚¨ç³»ç»Ÿ) å’Œ Prometheus ç®¡ç†ç£ç›˜å­ç³»ç»Ÿ ","date":"2022-10-15","objectID":"/posts/d75507/:1:10","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"CAS å¼•æ“ ","date":"2022-10-15","objectID":"/posts/d75507/:2:0","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"å­˜å‚¨å¼•æ“æ¦‚è¿° å­˜å‚¨å¼•æ“æ˜¯æŒä¹…åŒ–å· IO è·¯å¾„çš„æ•°æ®å¹³é¢ç»„ä»¶ã€‚åœ¨ CAS æ¶æ„ä¸­ï¼Œç”¨æˆ·å¯ä»¥æ ¹æ®ä¸åŒçš„é…ç½®ç­–ç•¥ï¼Œä¸ºä¸åŒçš„åº”ç”¨å·¥ä½œè´Ÿè½½é€‰æ‹©ä¸åŒçš„æ•°æ®å¹³é¢ã€‚å­˜å‚¨å¼•æ“å¯ä»¥é€šè¿‡ç‰¹æ€§é›†æˆ–æ€§èƒ½ä¼˜åŒ–ç»™å®šçš„å·¥ä½œè´Ÿè½½ã€‚ æ“ä½œå‘˜æˆ–ç®¡ç†å‘˜é€šå¸¸é€‰æ‹©å…·æœ‰ç‰¹å®šè½¯ä»¶ç‰ˆæœ¬çš„å­˜å‚¨å¼•æ“ï¼Œå¹¶æ„å»ºä¼˜åŒ–çš„å·æ¨¡æ¿ï¼Œ è¿™äº›å·æ¨¡æ¿æ ¹æ®åº•å±‚ç£ç›˜çš„ç±»å‹ã€å¼¹æ€§ã€å‰¯æœ¬æ•°é‡å’Œå‚ä¸ Kubernetes é›†ç¾¤çš„èŠ‚ç‚¹é›†è¿›è¡Œå¾®è°ƒã€‚ç”¨æˆ·å¯ä»¥åœ¨å‘æ”¾å·æ—¶é€‰æ‹©æœ€ä¼˜çš„å·æ¨¡æ¿ï¼Œä»è€Œåœ¨ç»™å®šçš„ Kubernetes é›†ç¾¤ä¸Šä¸ºæ‰€æœ‰å­˜å‚¨å·è¿è¡Œæœ€ä¼˜çš„è½¯ä»¶å’Œå­˜å‚¨ç»„åˆæä¾›æœ€å¤§çš„çµæ´»æ€§ã€‚ ","date":"2022-10-15","objectID":"/posts/d75507/:2:1","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"å­˜å‚¨å¼•æ“ç±»å‹ OpenEBS æä¾›äº†ä¸‰ç§å­˜å‚¨å¼•æ“ Jiva Jiva æ˜¯ OpenEBS 0.1 ç‰ˆä¸­å‘å¸ƒçš„ç¬¬ä¸€ä¸ªå­˜å‚¨å¼•æ“ï¼Œä½¿ç”¨èµ·æ¥æœ€ç®€å•ã€‚å®ƒåŸºäº GoLang å¼€å‘ï¼Œå†…éƒ¨ä½¿ç”¨ LongHorn å’Œ gotgt å †æ ˆã€‚ Jiva å®Œå…¨åœ¨ç”¨æˆ·ç©ºé—´ä¸­è¿è¡Œï¼Œå¹¶æä¾›åŒæ­¥å¤åˆ¶ç­‰æ ‡å‡†å—å­˜å‚¨åŠŸèƒ½ã€‚ Jiva é€šå¸¸é€‚ç”¨äºå®¹é‡è¾ƒå°çš„å·¥ä½œè´Ÿè½½ï¼Œä¸é€‚ç”¨äºå¤§é‡å¿«ç…§å’Œå…‹éš†ç‰¹æ€§æ˜¯ä¸»è¦éœ€æ±‚çš„æƒ…å†µ cStor cStor æ˜¯ OpenEBS 0.7 ç‰ˆæœ¬ä¸­æœ€æ–°å‘å¸ƒçš„å­˜å‚¨å¼•æ“ã€‚cStor éå¸¸å¥å£®ï¼Œæä¾›æ•°æ®ä¸€è‡´æ€§ï¼Œå¾ˆå¥½åœ°æ”¯æŒå¿«ç…§å’Œå…‹éš†ç­‰ä¼ä¸šå­˜å‚¨ç‰¹æ€§ã€‚ å®ƒè¿˜æä¾›äº†ä¸€ä¸ªå¥å£®çš„å­˜å‚¨æ± ç‰¹æ€§ï¼Œç”¨äºåœ¨å®¹é‡å’Œæ€§èƒ½æ–¹é¢è¿›è¡Œå…¨é¢çš„å­˜å‚¨ç®¡ç†ã€‚ cStor ä¸ NDM (Node Disk Manager) ä¸€èµ·ï¼Œä¸º Kubernetes ä¸Šçš„æœ‰çŠ¶æ€åº”ç”¨ç¨‹åºæä¾›å®Œæ•´çš„æŒä¹…åŒ–å­˜å‚¨ç‰¹æ€§ OpenEBS Local PV OpenEBS Local PV æ˜¯ä¸€ä¸ªæ–°çš„å­˜å‚¨å¼•æ“ï¼Œå®ƒå¯ä»¥ä»æœ¬åœ°ç£ç›˜æˆ–å·¥ä½œèŠ‚ç‚¹ä¸Šçš„ä¸»æœºè·¯å¾„åˆ›å»ºæŒä¹…å·æˆ– PVã€‚ CASå¼•æ“å¯ä»¥ä» OpenEBS çš„ 1.0.0 ç‰ˆæœ¬ä¸­è·å¾—ã€‚ä½¿ç”¨ OpenEBS Local PVï¼Œæ€§èƒ½å°†ç­‰åŒäºåˆ›å»ºå·çš„æœ¬åœ°ç£ç›˜æˆ–æ–‡ä»¶ç³»ç»Ÿ (ä¸»æœºè·¯å¾„)ã€‚ è®¸å¤šäº‘åŸç”Ÿåº”ç”¨ç¨‹åºå¯èƒ½ä¸éœ€è¦å¤åˆ¶ã€å¿«ç…§æˆ–å…‹éš†ç­‰é«˜çº§å­˜å‚¨ç‰¹æ€§ï¼Œå› ä¸ºå®ƒä»¬æœ¬èº«å°±æä¾›äº†è¿™äº›ç‰¹æ€§ã€‚è¿™ç±»åº”ç”¨ç¨‹åºéœ€è¦ä»¥æŒä¹…å·çš„å½¢å¼è®¿é—®ç®¡ç†çš„ç£ç›˜ SP å­˜å‚¨æ± ï¼Œè¡¨ç¤º Jiva è‡ªå®šä¹‰å­˜å‚¨èµ„æº CV cStor å·ï¼Œè¡¨ç¤º cStor å·è‡ªå®šä¹‰èµ„æº CVR cStor å·å‰¯æœ¬ SPC å­˜å‚¨æ± å£°æ˜ï¼Œè¡¨ç¤º cStor æ± èšåˆçš„è‡ªå®šä¹‰èµ„æº CSP cStor å­˜å‚¨æ± ï¼Œè¡¨ç¤º cStor Pool æ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„è‡ªå®šä¹‰èµ„æº ä¸€ä¸ª SPC å¯¹åº”å¤šä¸ª CSPï¼Œç›¸åº”çš„ä¸€ä¸ª CV å¯¹åº”å¤šä¸ª CVR ","date":"2022-10-15","objectID":"/posts/d75507/:2:2","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"å­˜å‚¨å¼•æ“å£°æ˜ é€šè¿‡æŒ‡å®šæ³¨é‡Š openebs æ¥é€‰æ‹©å­˜å‚¨å¼•æ“ã€‚StorageClass è§„èŒƒä¸­çš„ io/cas-typeã€‚StorageClass å®šä¹‰äº†æä¾›ç¨‹åºçš„ç»†èŠ‚ã€‚ä¸ºæ¯ä¸ª CAS å¼•æ“æŒ‡å®šå•ç‹¬çš„ä¾›åº”ç¨‹åºã€‚ ","date":"2022-10-15","objectID":"/posts/d75507/:2:3","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"cStor å­˜å‚¨ç±»è§„èŒƒæ–‡ä»¶å†…å®¹ --- apiVersion: storage.k8s.io/v1 kind: StorageClass metadata: name: cStor-storageclass annotations: openebs.io/cas-type: cstor cas.openebs.io/config: | - name: StoragePoolClaim value: \"cStorPool-SSD\" provisioner: openebs.io/provisioner-iscsi --- ","date":"2022-10-15","objectID":"/posts/d75507/:2:4","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"Jiva å­˜å‚¨ç±»è§„èŒƒæ–‡ä»¶å†…å®¹ --- apiVersion: storage.k8s.io/v1 kind: StorageClass metadata: name: jiva-storageclass annotations: openebs.io/cas-type: jiva cas.openebs.io/config: | - name: StoragePool value: default provisioner: openebs.io/provisioner-iscsi --- å½“ cas ç±»å‹ä¸º Jiva æ—¶ï¼ŒStoragePool çš„ default å€¼å…·æœ‰ç‰¹æ®Šå«ä¹‰ã€‚å½“ pool ä¸ºé»˜è®¤å€¼æ—¶ï¼ŒJiva å¼•æ“å°†ä»å®¹å™¨ (å‰¯æœ¬ pod) æœ¬èº«çš„å­˜å‚¨ç©ºé—´ä¸­ä¸ºå‰¯æœ¬ pod å¼€è¾Ÿæ•°æ®å­˜å‚¨ç©ºé—´ã€‚å½“æ‰€éœ€çš„å·å¤§å°å¾ˆå° (æ¯”å¦‚ 5G åˆ° 10G) æ—¶ï¼ŒStoragePool default å·¥ä½œå¾—å¾ˆå¥½ï¼Œå› ä¸ºå®ƒå¯ä»¥å®¹çº³åœ¨å®¹å™¨æœ¬èº«å†…ã€‚ ","date":"2022-10-15","objectID":"/posts/d75507/:2:5","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"Local PV å­˜å‚¨ç±»è§„èŒƒæ–‡ä»¶å†…å®¹-ä¸»æœºè·¯å¾„ --- apiVersion: storage.k8s.io/v1 kind: StorageClass metadata: name: localpv-hostpath-sc annotations: openebs.io/cas-type: local cas.openebs.io/config: | - name: BasePath value: \"/var/openebs/local\" - name: StorageType value: \"hostpath\" provisioner: openebs.io/local --- ","date":"2022-10-15","objectID":"/posts/d75507/:2:6","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"Local PV å­˜å‚¨ç±»è§„èŒƒæ–‡ä»¶å†…å®¹-ä¸»æœºè®¾å¤‡ --- apiVersion: storage.k8s.io/v1 kind: StorageClass metadata: name: localpv-device-sc annotations: openebs.io/cas-type: local cas.openebs.io/config: | - name: StorageType value: \"device\" - name: FSType value: ext4 provisioner: openebs.io/local --- cStorã€Jivaã€LocalPV ç‰¹æ€§æ¯”è¾ƒï¼š ç‰¹æ€§ Jiva cStor Local PV è½»é‡çº§è¿è¡Œäºç”¨æˆ·ç©ºé—´ Yes Yes Yes åŒæ­¥å¤åˆ¶ Yes Yes No é€‚åˆä½å®¹é‡å·¥ä½œè´Ÿè½½ Yes Yes Yes æ”¯æŒå¿«ç…§ï¼Œå…‹éš† Basic Advanced No æ•°æ®ä¸€è‡´æ€§ Yes Yes NA ä½¿ç”¨ Velero æ¢å¤å¤‡ä»½ Yes Yes Yes é€‚åˆé«˜å®¹é‡å·¥ä½œè´Ÿè½½ No Yes Yes è‡ªåŠ¨ç²¾ç®€é…ç½® Yes No ç£ç›˜æ± æˆ–èšåˆæ”¯æŒ Yes No åŠ¨æ€æ‰©å®¹ Yes Yes æ•°æ®å¼¹æ€§ (RAID æ”¯æŒ) Yes No æ¥è¿‘åŸç”Ÿç£ç›˜æ€§èƒ½ No No Yes å¤§å¤šæ•°åœºæ™¯æ¨è cStorï¼Œå› å…¶æä¾›äº†å¼ºå¤§çš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬å¿«ç…§ / å…‹éš†ã€å­˜å‚¨æ± åŠŸèƒ½ï¼ˆå¦‚ç²¾ç®€èµ„æºè°ƒé…ã€æŒ‰éœ€æ‰©å®¹ç­‰ï¼‰ã€‚ Jiva é€‚ç”¨äºä½å®¹é‡éœ€æ±‚çš„å·¥ä½œè´Ÿè½½åœºæ™¯ï¼Œä¾‹å¦‚ 5 åˆ° 50Gã€‚å°½ç®¡ä½¿ç”¨ Jiva æ²¡æœ‰ç©ºé—´é™åˆ¶ï¼Œä½†å»ºè®®å°†å…¶ç”¨äºä½å®¹é‡å·¥ä½œè´Ÿè½½ã€‚Jiva éå¸¸æ˜“äºä½¿ç”¨ï¼Œå¹¶æä¾›ä¼ä¸šçº§å®¹å™¨æœ¬åœ°å­˜å‚¨ï¼Œè€Œä¸éœ€è¦ä¸“ç”¨ç¡¬ç›˜ã€‚æœ‰å¿«ç…§å’Œå…‹éš†åŠŸèƒ½çš„éœ€æ±‚çš„åœºæ™¯ï¼Œä¼˜å…ˆè€ƒè™‘ä½¿ç”¨ cStor è€Œä¸æ˜¯ Jivaã€‚ ","date":"2022-10-15","objectID":"/posts/d75507/:2:7","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"CAS å¼•æ“ä½¿ç”¨åœºæ™¯ å¦‚ä¸Šè¡¨æ‰€ç¤ºï¼Œæ¯ä¸ªå­˜å‚¨å¼•æ“éƒ½æœ‰è‡ªå·±çš„ä¼˜åŠ¿ã€‚é€‰æ‹©å¼•æ“å®Œå…¨å–å†³äºåº”ç”¨ç¨‹åºçš„å·¥ä½œè´Ÿè½½ä»¥åŠå®ƒå½“å‰å’Œæœªæ¥çš„å®¹é‡å’Œ / æˆ–æ€§èƒ½å¢é•¿ã€‚ä¸‹é¢çš„æŒ‡å¯¼åŸåˆ™åœ¨å®šä¹‰å­˜å‚¨ç±»æ—¶ä¸ºé€‰æ‹©ç‰¹å®šçš„å¼•æ“æä¾›ä¸€äº›å¸®åŠ©ã€‚ ","date":"2022-10-15","objectID":"/posts/d75507/:2:8","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"é€‰æ‹© cStor çš„ç†æƒ³æ¡ä»¶ å½“éœ€è¦åŒæ­¥å¤åˆ¶æ•°æ®å¹¶åœ¨èŠ‚ç‚¹ä¸Šæœ‰å¤šä¸ªç£ç›˜æ—¶ å½“æ‚¨ä»æ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„æœ¬åœ°ç£ç›˜æˆ–ç½‘ç»œç£ç›˜æ± ç®¡ç†å¤šä¸ªåº”ç”¨ç¨‹åºçš„å­˜å‚¨æ—¶ã€‚é€šè¿‡ç²¾ç®€é…ç½®ã€å­˜å‚¨æ± å’Œå·çš„æŒ‰éœ€æ‰©å®¹ã€å­˜å‚¨æ± çš„æ€§èƒ½æŒ‰éœ€æ‰©å®¹ç­‰ç‰¹æ€§ï¼Œå®ç°å¯¹å­˜å‚¨å±‚çš„ç®¡ç†ã€‚cStor ç”¨äºåœ¨æœ¬åœ°è¿è¡Œçš„ Kubernetes é›†ç¾¤ä¸Šæ„å»º Kubernetes æœ¬åœ°å­˜å‚¨æœåŠ¡ï¼Œç±»ä¼¼äº AWS EBS æˆ–è°·æ­Œ PDã€‚ å½“éœ€è¦å­˜å‚¨çº§å¿«ç…§å’Œå…‹éš†èƒ½åŠ›æ—¶ å½“æ‚¨éœ€è¦ä¼ä¸šçº§å­˜å‚¨ä¿æŠ¤ç‰¹æ€§ï¼Œå¦‚æ•°æ®ä¸€è‡´æ€§ã€å¼¹æ€§ (RAID ä¿æŠ¤)ã€‚ å¦‚æœæ‚¨çš„åº”ç”¨ç¨‹åºä¸éœ€è¦å­˜å‚¨çº§å¤åˆ¶ï¼Œé‚£ä¹ˆä½¿ç”¨ OpenEBS ä¸»æœºè·¯å¾„ LocalPV æˆ– OpenEBS è®¾å¤‡ LocalPV å¯èƒ½æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚ ","date":"2022-10-15","objectID":"/posts/d75507/:2:9","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"é€‰æ‹© Jiva çš„ç†æƒ³æ¡ä»¶ : å½“æ‚¨æƒ³è¦æ•°æ®çš„åŒæ­¥å¤åˆ¶ï¼Œå¹¶ä¸”æ‹¥æœ‰å•ä¸ªæœ¬åœ°ç£ç›˜æˆ–å•ä¸ªç®¡ç†ç£ç›˜ (å¦‚äº‘ç£ç›˜ (EBSã€GPD))ï¼Œå¹¶ä¸”ä¸éœ€è¦å¿«ç…§æˆ–å…‹éš†ç‰¹æ€§æ—¶ Jiva æ˜¯æœ€å®¹æ˜“ç®¡ç†çš„ï¼Œå› ä¸ºç£ç›˜ç®¡ç†æˆ–æ± ç®¡ç†ä¸åœ¨è¿™ä¸ªå¼•æ“çš„èŒƒå›´å†…ã€‚Jiva æ± æ˜¯æœ¬åœ°ç£ç›˜ã€ç½‘ç»œç£ç›˜ã€è™šæ‹Ÿç£ç›˜æˆ–äº‘ç£ç›˜çš„æŒ‚è½½è·¯å¾„ã€‚ ä»¥ä¸‹åœºæ™¯ Jiva æ›´ä¼˜äº cStor : å½“ç¨‹åºä¸éœ€è¦å­˜å‚¨çº§çš„å¿«ç…§ã€å…‹éš†ç‰¹æ€§ å½“èŠ‚ç‚¹ä¸Šæ²¡æœ‰ç©ºé—²ç£ç›˜æ—¶ã€‚Jiva å¯ä»¥åœ¨ä¸»æœºç›®å½•ä¸Šä½¿ç”¨ï¼Œå¹¶ä¸”ä»ç„¶å¯ä»¥å®ç°å¤åˆ¶ã€‚ å½“ä¸éœ€è¦åŠ¨æ€æ‰©å±•æœ¬åœ°ç£ç›˜ä¸Šçš„å­˜å‚¨æ—¶ã€‚å°†æ›´å¤šç£ç›˜æ·»åŠ åˆ° Jiva æ± æ˜¯ä¸å¯èƒ½çš„ï¼Œå› æ­¤ Jiva æ± çš„å¤§å°æ˜¯å›ºå®šçš„ï¼Œå¦‚æœå®ƒåœ¨ç‰©ç†ç£ç›˜ä¸Šã€‚ä½†æ˜¯ï¼Œå¦‚æœåº•å±‚ç£ç›˜æ˜¯è™šæ‹Ÿç£ç›˜ã€ç½‘ç»œç£ç›˜æˆ–äº‘ç£ç›˜ï¼Œåˆ™å¯ä»¥åŠ¨æ€åœ°æ›´æ”¹ Jiva æ± çš„å¤§å° å®¹é‡éœ€æ±‚è¾ƒå°ã€‚å¤§å®¹é‡åº”ç”¨é€šå¸¸éœ€è¦åŠ¨æ€å¢åŠ å®¹é‡ï¼ŒcStor æ›´é€‚åˆè¿™ç§éœ€æ±‚ ","date":"2022-10-15","objectID":"/posts/d75507/:2:10","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"é€‰æ‹© OpenEBS ä¸»æœºè·¯å¾„ LocalPV çš„ç†æƒ³æ¡ä»¶ : å½“åº”ç”¨ç¨‹åºæœ¬èº«å…·å¤‡ç®¡ç†å¤åˆ¶èƒ½åŠ›ï¼ˆä¾‹å¦‚ï¼šesï¼‰æ—¶ï¼Œä¸éœ€è¦åœ¨å­˜å‚¨å±‚è¿›è¡Œå¤åˆ¶ã€‚åœ¨å¤§å¤šæ•°è¿™æ ·çš„æƒ…å†µä¸‹ï¼Œåº”ç”¨ç¨‹åºæ˜¯ä½œä¸º statefulset éƒ¨ç½²çš„ é«˜äº Jiva ä¸ cStor çš„è¯»å†™æ€§èƒ½éœ€æ±‚ å½“ç‰¹å®šåº”ç”¨ç¨‹åºæ²¡æœ‰ä¸“ç”¨çš„æœ¬åœ°ç£ç›˜æˆ–ç‰¹å®šåº”ç”¨ç¨‹åºä¸éœ€è¦ä¸“ç”¨çš„å­˜å‚¨æ—¶ï¼Œå»ºè®®ä½¿ç”¨ Hostpathã€‚å¦‚æœæ‚¨æƒ³è·¨å¤šä¸ªåº”ç”¨ç¨‹åºå…±äº«ä¸€ä¸ªæœ¬åœ°ç£ç›˜ï¼Œä¸»æœºè·¯å¾„ LocalPV æ˜¯æ­£ç¡®çš„æ–¹æ³• ","date":"2022-10-15","objectID":"/posts/d75507/:2:11","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"é€‰æ‹© OpenEBS ä¸»æœºè®¾å¤‡ LocalPV çš„ç†æƒ³æ¡ä»¶ : å½“åº”ç”¨ç¨‹åºç®¡ç†å¤åˆ¶æœ¬èº«ï¼Œä¸éœ€è¦åœ¨å­˜å‚¨å±‚è¿›è¡Œå¤åˆ¶æ—¶ã€‚åœ¨å¤§å¤šæ•°è¿™ç§æƒ…å†µä¸‹ï¼Œåº”ç”¨ç¨‹åºè¢«éƒ¨ç½²ä¸ºæœ‰çŠ¶æ€é›† é«˜äº Jiva ä¸ cStor çš„è¯»å†™æ€§èƒ½éœ€æ±‚ é«˜äº OpenEBS ä¸»æœºè·¯å¾„ LocalPV çš„è¯»å†™æ€§èƒ½éœ€æ±‚ å½“éœ€è¦æ¥è¿‘ç£ç›˜æ€§èƒ½æ—¶ã€‚è¯¥å·ä¸“ç”¨äºå†™å…¥å•ä¸ª SSD æˆ– NVMe æ¥å£ä»¥è·å¾—æœ€é«˜æ€§èƒ½ ","date":"2022-10-15","objectID":"/posts/d75507/:2:12","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"æ€»ç»“ å¦‚æœåº”ç”¨ç¨‹åºå¤„äºç”Ÿäº§ä¸­ï¼Œå¹¶ä¸”ä¸éœ€è¦å­˜å‚¨çº§å¤åˆ¶ï¼Œé‚£ä¹ˆé¦–é€‰ LocalPV å¦‚æœæ‚¨çš„åº”ç”¨ç¨‹åºå¤„äºç”Ÿäº§çŠ¶æ€ï¼Œå¹¶ä¸”éœ€è¦å­˜å‚¨çº§å¤åˆ¶ï¼Œé‚£ä¹ˆé¦–é€‰ cStor å¦‚æœåº”ç”¨ç¨‹åºè¾ƒå°ï¼Œéœ€è¦å­˜å‚¨çº§å¤åˆ¶ï¼Œä½†ä¸éœ€è¦å¿«ç…§æˆ–å…‹éš†ï¼Œåˆ™é¦–é€‰ Jiva ","date":"2022-10-15","objectID":"/posts/d75507/:2:13","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"èŠ‚ç‚¹ç£ç›˜ç®¡ç†å™¨ï¼ˆNDMï¼‰ èŠ‚ç‚¹ç£ç›˜ç®¡ç†å™¨ (NDM) æ˜¯ OpenEBS ä½“ç³»ç»“æ„ä¸­çš„ä¸€ä¸ªé‡è¦ç»„ä»¶ã€‚NDM å°†å—è®¾å¤‡è§†ä¸ºéœ€è¦ç›‘è§†å’Œç®¡ç†çš„èµ„æºï¼Œå°±åƒ CPUã€å†…å­˜å’Œç½‘ç»œç­‰å…¶ä»–èµ„æºä¸€æ ·ã€‚å®ƒæ˜¯ä¸€ä¸ªåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œçš„å®ˆæŠ¤è¿›ç¨‹ï¼ŒåŸºäºè¿‡æ»¤å™¨æ£€æµ‹é™„åŠ çš„å—è®¾å¤‡ï¼Œå¹¶å°†å®ƒä»¬ä½œä¸ºå—è®¾å¤‡è‡ªå®šä¹‰èµ„æºåŠ è½½åˆ° Kubernetes ä¸­ã€‚è¿™äº›å®šåˆ¶èµ„æºæ—¨åœ¨é€šè¿‡æä¾›ç±»ä¼¼äº : è½»æ¾è®¿é—® Kubernetes é›†ç¾¤ä¸­å¯ç”¨çš„å—è®¾å¤‡æ¸…å• é¢„æµ‹ç£ç›˜çš„æ•…éšœï¼Œä»¥å¸®åŠ©é‡‡å–é¢„é˜²æªæ–½ å…è®¸åŠ¨æ€åœ°å°†ç£ç›˜æŒ‚è½½ / å¸è½½åˆ°å­˜å‚¨ Pod ä¸­ï¼Œè€Œæ— éœ€é‡æ–°å¯åŠ¨åœ¨ç£ç›˜æŒ‚è½½ / å¸è½½çš„èŠ‚ç‚¹ä¸Šè¿è¡Œçš„ç›¸åº” NDM Pod å°½ç®¡åšäº†ä¸Šè¿°æ‰€æœ‰å·¥ä½œï¼ŒNDM è¿˜æ˜¯æœ‰åŠ©äºæä¾›æŒä¹…å·çš„æ€»ä½“ç®€åŒ–ã€‚ NDM æ˜¯åœ¨ OpenEBS å®‰è£…æœŸé—´ä½œä¸ºå®ˆæŠ¤è¿›ç¨‹éƒ¨ç½²çš„ã€‚NDM daemonset å‘ç°æ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„ç£ç›˜ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªåä¸º Block Device æˆ– BD çš„è‡ªå®šä¹‰èµ„æºã€‚ ","date":"2022-10-15","objectID":"/posts/d75507/:2:14","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"è®¿é—®æƒé™è¯´æ˜ NDM å®ˆæŠ¤è¿›ç¨‹è¿è¡Œåœ¨å®¹å™¨ä¸­ï¼Œå¿…é¡»è®¿é—®åº•å±‚å­˜å‚¨è®¾å¤‡å¹¶ä»¥ç‰¹æƒæ¨¡å¼è¿è¡Œã€‚NDM éœ€è¦ç‰¹æƒæ¨¡å¼ï¼Œå› ä¸ºå®ƒéœ€è¦è®¿é—® /devã€/proc å’Œ /sys ç›®å½•æ¥ç›‘è§†é™„åŠ è®¾å¤‡ï¼Œè¿˜éœ€è¦ä½¿ç”¨å„ç§æ¢æµ‹å™¨è·å–é™„åŠ è®¾å¤‡çš„è¯¦ç»†ä¿¡æ¯ã€‚NDM è´Ÿè´£å‘ç°å—è®¾å¤‡å¹¶è¿‡æ»¤æ‰ä¸åº”è¯¥è¢« OpenEBS ä½¿ç”¨çš„è®¾å¤‡ ; ä¾‹å¦‚ï¼Œæ£€æµ‹æœ‰ OS æ–‡ä»¶ç³»ç»Ÿçš„ç£ç›˜ã€‚NDM pod é»˜è®¤æƒ…å†µä¸‹åœ¨å®¹å™¨ä¸­æŒ‚è½½ä¸»æœºçš„ /proc ç›®å½•ï¼Œç„¶ååŠ è½½ /proc/1/mountsï¼Œä»¥æ‰¾åˆ°æ“ä½œç³»ç»Ÿä½¿ç”¨çš„ç£ç›˜ ","date":"2022-10-15","objectID":"/posts/d75507/:2:15","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"NDM å®ˆæŠ¤ç¨‹åºåŠŸèƒ½ å‘ç° Kubernetes èŠ‚ç‚¹ä¸Šçš„å—è®¾å¤‡ åœ¨å¯åŠ¨æ—¶å‘ç°å—è®¾å¤‡-åˆ›å»ºå’Œ / æˆ–æ›´æ–°çŠ¶æ€ã€‚ ç»´æŠ¤é›†ç¾¤èŒƒå›´å†…ç£ç›˜çš„å”¯ä¸€ id: å¯¹ WWN / PartitionUUID / FileSystemUUID / DeviceMapperUUID è¿›è¡Œ Hashè®¡ç®— æ£€æµ‹èŠ‚ç‚¹ä¸­æ·»åŠ  / ç§»é™¤å—è®¾å¤‡ï¼Œå¹¶æ›´æ–°å—è®¾å¤‡çŠ¶æ€ æ·»åŠ å—è®¾å¤‡ä½œä¸º Kubernetes è‡ªå®šä¹‰èµ„æºï¼Œå…·æœ‰ä»¥ä¸‹å±æ€§ï¼š Active : èŠ‚ç‚¹ä¸Šå­˜åœ¨å—è®¾å¤‡ Inactive : ç»™å®šèŠ‚ç‚¹ä¸Šä¸å­˜åœ¨å—è®¾å¤‡ Unknown : NDM åœ¨å—è®¾å¤‡æœ€åè¢«æ£€æµ‹åˆ°çš„èŠ‚ç‚¹ä¸Šåœæ­¢ / æ— æ³•ç¡®å®šçŠ¶æ€ ä¸»æœºåç§° (kubernetes.io/hostname) å—è®¾å¤‡ç±»å‹ (ndm.io/blockdevice-type) Managed (ndm.io/managed) è®¾å¤‡è·¯å¾„ è®¾å¤‡é“¾æ¥ ä¾›åº”å•†å’Œå‹å·ä¿¡æ¯ WWN å’Œåºåˆ—å· å®¹é‡ æ‰‡åŒºå’ŒåŒºå—å¤§å° spec: å¦‚æœå¯ç”¨ï¼Œå°†æ›´æ–°ä»¥ä¸‹å†…å®¹ labels: status: çŠ¶æ€å¯ä»¥æœ‰ä»¥ä¸‹å€¼ ","date":"2022-10-15","objectID":"/posts/d75507/:2:16","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"è¿‡æ»¤å™¨ ä¸ºè¦åˆ›å»ºå—è®¾å¤‡ CR çš„å—è®¾å¤‡ç±»å‹é…ç½®è¿‡æ»¤å™¨ã€‚è¿‡æ»¤å™¨å¯ä»¥é€šè¿‡ä¾›åº”å•†ç±»å‹ã€è®¾å¤‡è·¯å¾„æ¨¡å¼æˆ–æŒ‚è½½ç‚¹è¿›è¡Œé…ç½® è¿‡æ»¤å™¨å¯ä»¥æ˜¯åŒ…å«è¿‡æ»¤å™¨ï¼Œä¹Ÿå¯ä»¥æ˜¯æ’é™¤è¿‡æ»¤å™¨ã€‚å®ƒä»¬è¢«é…ç½®ä¸º configmapã€‚ç®¡ç†å‘˜ç”¨æˆ·å¯ä»¥åœ¨ OpenEBS å®‰è£…æ—¶é€šè¿‡æ›´æ”¹ OpenEBS æ“ä½œå‘˜ yaml æ–‡ä»¶æˆ– helm å€¼ä¸­çš„ NDM configmap æ¥é…ç½®è¿™äº›è¿‡æ»¤å™¨ã€‚yaml æ–‡ä»¶ã€‚å¦‚æœè¿™äº›è¿‡æ»¤å™¨éœ€è¦åœ¨å®‰è£…åæ›´æ–°ï¼Œé‚£ä¹ˆå¯ä»¥éµå¾ªä»¥ä¸‹æ–¹æ³•ä¹‹ä¸€ : ä½¿ç”¨ operator æ–¹å¼å®‰è£… OpenEBSã€‚åœ¨ Yaml æ–‡ä»¶ä¸­ï¼Œæ›´æ–° configmap ä¸­çš„è¿‡æ»¤å™¨å¹¶åº”ç”¨ operator.yaml å¦‚æœ OpenEBS æ˜¯ä½¿ç”¨ helm å®‰è£…çš„ï¼Œæ›´æ–° values.yaml ä¸­çš„ configmap å¹¶ä½¿ç”¨ helm è¿›è¡Œå‡çº§ æˆ–è€…ï¼Œä½¿ç”¨ kubectl ç¼–è¾‘ NDM configmapï¼Œæ›´æ–°è¿‡æ»¤å™¨ ","date":"2022-10-15","objectID":"/posts/d75507/:2:17","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"è½åœ°å®è·µ OpenEBS çš„ cStor ä¸ Jiva å¼•æ“ç”±äºç»„ä»¶è¿‡å¤šï¼Œé…ç½®ç›¸è¾ƒå…¶ä»–å­˜å‚¨æ–¹æ¡ˆç¹çï¼Œç”Ÿäº§ç¯å¢ƒä¸å»ºè®®ä½¿ç”¨ï¼Œè¿™é‡Œæˆ‘ä»¬ä»…è®ºè¿° Local PV å¼•æ“ã€‚ Local PV å¼•æ“ä¸å…·å¤‡å­˜å‚¨çº§å¤åˆ¶èƒ½åŠ›ï¼Œé€‚ç”¨äº k8s æœ‰çŠ¶æ€æœåŠ¡çš„åç«¯å­˜å‚¨ï¼ˆå¦‚ : esã€redis ç­‰ï¼‰ ","date":"2022-10-15","objectID":"/posts/d75507/:3:0","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"Local PV Hostpath å®è·µ å¯¹æ¯” Kubernetes Hostpath å·ç›¸æ¯”ï¼ŒOpenEBS æœ¬åœ° PV Hostpath å·å…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ : OpenEBS æœ¬åœ° PV Hostpath å…è®¸æ‚¨çš„åº”ç”¨ç¨‹åºé€šè¿‡ StorageClassã€PVC å’Œ PV è®¿é—® Hostpathã€‚è¿™ä¸ºæ‚¨æä¾›äº†æ›´æ”¹ PV æä¾›è€…çš„çµæ´»æ€§ï¼Œè€Œæ— éœ€é‡æ–°è®¾è®¡åº”ç”¨ç¨‹åº YAML ä½¿ç”¨ Velero å¤‡ä»½å’Œæ¢å¤è¿›è¡Œæ•°æ®ä¿æŠ¤ é€šè¿‡å¯¹åº”ç”¨ç¨‹åº YAML å’Œ pod å®Œå…¨å±è”½ä¸»æœºè·¯å¾„æ¥é˜²èŒƒä¸»æœºè·¯å¾„å®‰å…¨æ¼æ´ ç¯å¢ƒä¾èµ– : k8s 1.12 ä»¥ä¸Š OpenEBS 1.0 ä»¥ä¸Š å®è·µç¯å¢ƒ : docker 19.03.8 k8s 1.18.6 CentOS7 $ kubectl get node NAME STATUS ROLES AGE VERSION node1 Ready master,worker 8m8s v1.18.6 node2 Ready master,worker 7m15s v1.18.6 node3 Ready master,worker 7m15s v1.18.6 ","date":"2022-10-15","objectID":"/posts/d75507/:3:1","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"åˆ›å»ºæ•°æ®ç›®å½• åœ¨å°†è¦åˆ›å»º Local PV Hostpaths çš„èŠ‚ç‚¹ä¸Šè®¾ç½®ç›®å½•ã€‚è¿™ä¸ªç›®å½•å°†è¢«ç§°ä¸º BasePathã€‚é»˜è®¤ä½ç½®æ˜¯ /var/openebs/local èŠ‚ç‚¹ node1ã€node2ã€node3 åˆ›å»º /data/openebs/local ç›®å½• ï¼ˆ/data å¯ä»¥é¢„å…ˆæŒ‚è½½æ•°æ®ç›˜ï¼Œå¦‚æœªæŒ‚è½½é¢å¤–æ•°æ®ç›˜ï¼Œåˆ™ä½¿ç”¨æ“ä½œç³»ç»Ÿ â€˜/â€™ æŒ‚è½½ç‚¹å­˜å‚¨ç©ºé—´ï¼‰ $ mkdir -p /data/openebs/local ","date":"2022-10-15","objectID":"/posts/d75507/:3:2","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"ä¸‹è½½åº”ç”¨æè¿°æ–‡ä»¶ ","date":"2022-10-15","objectID":"/posts/d75507/:3:3","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"å‘å¸ƒ openebs åº”ç”¨ æ ¹æ®ä¸Šè¿°é…ç½®æ–‡ä»¶ï¼Œä¿è¯ k8s é›†ç¾¤å¯è®¿é—®åˆ°å¦‚ä¸‹é•œåƒï¼ˆå»ºè®®å¯¼å…¥æœ¬åœ°ç§æœ‰é•œåƒåº“ï¼Œå¦‚ : harborï¼‰ openebs/node-disk-manager:1.5.0 openebs/node-disk-operator:1.5.0 openebs/provisioner-localpv:2.10.0 æ›´æ–° openebs-operator.yaml ä¸­é•œåƒ tag ä¸ºå®é™… tag image: openebs/node-disk-manager:1.5.0 image: openebs/node-disk-operator:1.5.0 image: openebs/provisioner-localpv:2.10.0 å‘å¸ƒ $ kubectl apply -f openebs-operator.yaml æŸ¥çœ‹å‘å¸ƒçŠ¶æ€ $ kubectl get pod -n openebs -w NAME READY STATUS RESTARTS AGE openebs-localpv-provisioner-6d6d9cfc99-4sltp 1/1 Running 0 10s openebs-ndm-85rng 1/1 Running 0 10s openebs-ndm-operator-7df6668998-ptnlq 0/1 Running 0 10s openebs-ndm-qgqm9 1/1 Running 0 10s openebs-ndm-zz7ps 1/1 Running 0 10s ","date":"2022-10-15","objectID":"/posts/d75507/:3:4","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"åˆ›å»ºå­˜å‚¨ç±» æ›´æ”¹é…ç½®æ–‡ä»¶ä¸­çš„å†…å®¹ value: \"/var/openebs/local/\" å‘å¸ƒåˆ›å»ºå­˜å‚¨ç±» $ cat \u003e openebs-hostpath-sc.yaml \u003c\u003cEOF apiVersion: storage.k8s.io/v1 kind: StorageClass metadata: name: openebs-hostpath annotations: openebs.io/cas-type: local cas.openebs.io/config: | #hostpath type will create a PV by # creating a sub-directory under the # BASEPATH provided below. - name: StorageType value: \"hostpath\" #Specify the location (directory) where # where PV(volume) data will be saved. # A sub-directory with pv-name will be # created. When the volume is deleted, # the PV sub-directory will be deleted. #Default value is /var/openebs/local - name: BasePath value: \"/data/openebs/local/\" provisioner: openebs.io/local volumeBindingMode: WaitForFirstConsumer reclaimPolicy: Delete EOF $ kubectl apply -f openebs-hostpath-sc.yaml ","date":"2022-10-15","objectID":"/posts/d75507/:3:5","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"åˆ›å»º PVC éªŒè¯å¯ç”¨æ€§ $ cat \u003e local-hostpath-pvc.yaml \u003c\u003cEOF kind: PersistentVolumeClaim apiVersion: v1 metadata: name: local-hostpath-pvc spec: storageClassName: openebs-hostpath accessModes: - ReadWriteOnce resources: requests: storage: 5G EOF $ kubectl apply -f local-hostpath-pvc.yaml æŸ¥çœ‹ pvc çŠ¶æ€ $ kubectl get pvc NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE local-hostpath-pvc Pending openebs-hostpath 2m15s è¾“å‡ºæ˜¾ç¤º STATUS ä¸º Pendingã€‚è¿™æ„å‘³ç€ PVC è¿˜æ²¡æœ‰è¢«åº”ç”¨ç¨‹åºä½¿ç”¨ã€‚ ","date":"2022-10-15","objectID":"/posts/d75507/:3:6","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"åˆ›å»º Pd $ cat \u003e local-hostpath-pod.yaml \u003c\u003cEOF apiVersion: v1 kind: Pod metadata: name: hello-local-hostpath-pod spec: volumes: - name: local-storage persistentVolumeClaim: claimName: local-hostpath-pvc containers: - name: hello-container image: busybox command: - sh - -c - 'while true; do echo \"`date` [`hostname`] Hello from OpenEBS Local PV.\" \u003e\u003e /mnt/store/greet.txt; sleep $(($RANDOM % 5 + 300)); done' volumeMounts: - mountPath: /mnt/store name: local-storage EOF å‘å¸ƒåˆ›å»º $ kubectl apply -f local-hostpath-pod.yaml ","date":"2022-10-15","objectID":"/posts/d75507/:3:7","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"éªŒè¯æ•°æ®æ˜¯å¦å†™å…¥å· $ kubectl exec hello-local-hostpath-pod -- cat /mnt/store/greet.txt Thu Jun 24 15:10:45 CST 2021 [node1] Hello from OpenEBS Local PV. ","date":"2022-10-15","objectID":"/posts/d75507/:3:8","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"éªŒè¯å®¹å™¨æ˜¯å¦ä½¿ç”¨ Local PV Hostpath å· $ kubectl describe pod hello-local-hostpath-pod Name: hello-local-hostpath-pod Namespace: default Priority: 0 ... Volumes: local-storage: Type: PersistentVolumeClaim (a reference to a PersistentVolumeClaim in the same namespace) ClaimName: local-hostpath-pvc ReadOnly: false default-token-98scc: Type: Secret (a volume populated by a Secret) SecretName: default-token-98scc Optional: false ... ","date":"2022-10-15","objectID":"/posts/d75507/:3:9","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"æŸ¥çœ‹ PVC çŠ¶æ€ $ kubectl get pvc local-hostpath-pvc NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE local-hostpath-pvc Bound pvc-6eac3773-49ef-47af-a475-acb57ed15cf6 5G RWO openebs-hostpath 10m ","date":"2022-10-15","objectID":"/posts/d75507/:3:10","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"æŸ¥çœ‹è¯¥ PV å·æ•°æ®å­˜å‚¨ç›®å½•ä¸º $ kubectl get -o yaml pv pvc-6eac3773-49ef-47af-a475-acb57ed15cf6|grep 'path:' f:path: {} path: /data/openebs/local/pvc-6eac3773-49ef-47af-a475-acb57ed15cf6 å¹¶ä¸” pv é…ç½®äº†äº²å’Œæ€§ï¼Œåˆ¶å®šäº†è°ƒåº¦èŠ‚ç‚¹ä¸º node2 spec: accessModes: - ReadWriteOnce capacity: storage: 5G claimRef: apiVersion: v1 kind: PersistentVolumeClaim name: local-hostpath-pvc namespace: default resourceVersion: \"9034\" uid: 6eac3773-49ef-47af-a475-acb57ed15cf6 local: fsType: \"\" path: /data/openebs/local/pvc-6eac3773-49ef-47af-a475-acb57ed15cf6 nodeAffinity: required: nodeSelectorTerms: - matchExpressions: - key: kubernetes.io/hostname operator: In values: - node2 persistentVolumeReclaimPolicy: Delete storageClassName: openebs-hostpath volumeMode: Filesystem ç»“æœè¯æ˜æ•°æ®ä»…å­˜åœ¨äº node2 ä¸‹ã€‚ ","date":"2022-10-15","objectID":"/posts/d75507/:3:11","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"æ¸…ç† Pod $ kubectl delete pod hello-local-hostpath-pod ","date":"2022-10-15","objectID":"/posts/d75507/:3:12","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"åŸºå‡†æµ‹è¯• ä¸‹è½½**åŸºå‡†æµ‹è¯• Job å£°æ˜æ–‡ä»¶** è°ƒæ•´ä»¥ä¸‹å†…å®¹ image: openebs/perf-test:latest # è°ƒæ•´ä¸ºå†…ç½‘é•œåƒåº“tag claimName: dbench # è°ƒæ•´ä¸ºlocal-hostpath-pvc å‘å¸ƒè¿è¡Œ $ kubectl create -f fio-deploy.yaml æŸ¥çœ‹è¿è¡ŒçŠ¶æ€ $ kubectl get pod NAME READY STATUS RESTARTS AGE dbench-729cw-nqfpt 1/1 Running 0 24s æŸ¥çœ‹åŸºå‡†æµ‹è¯•ç»“æœ $ kubectl logs -f dbench-729cw-nqfpt ... All tests complete. ================== = Dbench Summary = ================== Random Read/Write IOPS: 2144/6654. BW: 131MiB/s / 403MiB/s Average Latency (usec) Read/Write: 4254.08/3661.59 Sequential Read/Write: 1294MiB/s / 157MiB/s Mixed Random Read/Write IOPS: 1350/443 ","date":"2022-10-15","objectID":"/posts/d75507/:3:13","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"æ¸…ç† $ kubectl delete pvc local-hostpath-pvc $ kubectl delete sc openebs-hostpath ","date":"2022-10-15","objectID":"/posts/d75507/:3:14","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"Local PV Device å®è·µ å¯¹æ¯” Kubernetes æœ¬åœ°æŒä¹…å·ï¼ŒOpenEBS æœ¬åœ° PV è®¾å¤‡å·æœ‰ä»¥ä¸‹ä¼˜ç‚¹ : OpenEBS æœ¬åœ° PV è®¾å¤‡å· provider æ˜¯åŠ¨æ€çš„ï¼ŒKubernetes è®¾å¤‡å· provider æ˜¯é™æ€çš„ OpenEBS NDM æ›´å¥½åœ°ç®¡ç†ç”¨äºåˆ›å»ºæœ¬åœ° pv çš„å—è®¾å¤‡ã€‚NDM æä¾›äº†å‘ç°å—è®¾å¤‡å±æ€§ã€è®¾ç½®è®¾å¤‡ç­›é€‰å™¨ã€åº¦é‡é›†åˆä»¥åŠæ£€æµ‹å—è®¾å¤‡æ˜¯å¦å·²ç»è·¨èŠ‚ç‚¹ç§»åŠ¨ç­‰åŠŸèƒ½ ç¯å¢ƒä¾èµ– : k8s 1.12 ä»¥ä¸Š OpenEBS 1.0 ä»¥ä¸Š å®è·µç¯å¢ƒ : docker 19.03.8 k8s 1.18.6 CentOS7 $ kubectl get node NAME STATUS ROLES AGE VERSION node1 Ready master,worker 8m8s v1.18.6 node2 Ready master,worker 7m15s v1.18.6 node3 Ready master,worker 7m15s v1.18.6 ä¸‰ä¸ªèŠ‚ç‚¹ä¸Šçš„ /dev/sdb ä½œä¸ºå—è®¾å¤‡å­˜å‚¨ [root@node1 ~]# lsblk NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT sda 8:0 0 400G 0 disk â”œâ”€sda1 8:1 0 1G 0 part /boot â””â”€sda2 8:2 0 399G 0 part â””â”€centos-root 253:0 0 399G 0 lvm / sdb 8:16 0 20G 0 disk sr0 11:0 1 4.4G 0 rom [root@node2 ~]# lsblk NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT sda 8:0 0 400G 0 disk â”œâ”€sda1 8:1 0 1G 0 part /boot â””â”€sda2 8:2 0 399G 0 part â””â”€centos-root 253:0 0 399G 0 lvm / sdb 8:16 0 20G 0 disk sr0 11:0 1 4.4G 0 rom [root@node3 ~]# lsblk NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT sda 8:0 0 400G 0 disk â”œâ”€sda1 8:1 0 1G 0 part /boot â””â”€sda2 8:2 0 399G 0 part â””â”€centos-root 253:0 0 399G 0 lvm / sdb 8:16 0 20G 0 disk sr0 11:0 1 4.4G 0 rom ","date":"2022-10-15","objectID":"/posts/d75507/:3:15","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"åˆ›å»ºæ•°æ®ç›®å½• åœ¨å°†è¦åˆ›å»º Local PV Hostpaths çš„èŠ‚ç‚¹ä¸Šè®¾ç½®ç›®å½•ã€‚è¿™ä¸ªç›®å½•å°†è¢«ç§°ä¸º BasePathã€‚é»˜è®¤ä½ç½®æ˜¯ /var/openebs/local èŠ‚ç‚¹ node1ã€node2ã€node3 åˆ›å»º /data/openebs/local ç›®å½• ï¼ˆ/data å¯ä»¥é¢„å…ˆæŒ‚è½½æ•°æ®ç›˜ï¼Œå¦‚æœªæŒ‚è½½é¢å¤–æ•°æ®ç›˜ï¼Œåˆ™ä½¿ç”¨æ“ä½œç³»ç»Ÿ â€˜/â€™ æŒ‚è½½ç‚¹å­˜å‚¨ç©ºé—´ï¼‰ $ mkdir -p /data/openebs/local ","date":"2022-10-15","objectID":"/posts/d75507/:3:16","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"ä¸‹è½½åº”ç”¨æè¿°æ–‡ä»¶ ","date":"2022-10-15","objectID":"/posts/d75507/:3:17","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"å‘å¸ƒ openebs åº”ç”¨ æ ¹æ®ä¸Šè¿°é…ç½®æ–‡ä»¶ï¼Œä¿è¯ k8s é›†ç¾¤å¯è®¿é—®åˆ°å¦‚ä¸‹é•œåƒï¼ˆå»ºè®®å¯¼å…¥æœ¬åœ°ç§æœ‰é•œåƒåº“ï¼Œå¦‚ : harborï¼‰ openebs/node-disk-manager:1.5.0 openebs/node-disk-operator:1.5.0 openebs/provisioner-localpv:2.10.0 æ›´æ–° openebs-operator.yaml ä¸­é•œåƒ tag ä¸ºå®é™… tag image: openebs/node-disk-manager:1.5.0 image: openebs/node-disk-operator:1.5.0 image: openebs/provisioner-localpv:2.10.0 å‘å¸ƒ $ kubectl apply -f openebs-operator.yaml æŸ¥çœ‹å‘å¸ƒçŠ¶æ€ $ kubectl get pod -n openebs -w NAME READY STATUS RESTARTS AGE openebs-localpv-provisioner-6d6d9cfc99-4sltp 1/1 Running 0 10s openebs-ndm-85rng 1/1 Running 0 10s openebs-ndm-operator-7df6668998-ptnlq 0/1 Running 0 10s openebs-ndm-qgqm9 1/1 Running 0 10s openebs-ndm-zz7ps 1/1 Running 0 10s ","date":"2022-10-15","objectID":"/posts/d75507/:3:18","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"åˆ›å»ºå­˜å‚¨ç±» $ cat \u003e local-device-sc.yaml \u003c\u003cEOF apiVersion: storage.k8s.io/v1 kind: StorageClass metadata: name: local-device annotations: openebs.io/cas-type: local cas.openebs.io/config: | - name: StorageType value: device provisioner: openebs.io/local reclaimPolicy: Delete volumeBindingMode: WaitForFirstConsumer EOF $ kubectl apply -f local-device-sc.yaml ","date":"2022-10-15","objectID":"/posts/d75507/:3:19","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"åˆ›å»º Pod åŠ PVC $ cat \u003e local-device-pod.yaml \u003c\u003cEOF --- kind: PersistentVolumeClaim apiVersion: v1 metadata: name: local-device-pvc spec: storageClassName: local-device accessModes: - ReadWriteOnce resources: requests: storage: 5G --- apiVersion: v1 kind: Pod metadata: name: hello-local-device-pod spec: volumes: - name: local-storage persistentVolumeClaim: claimName: local-device-pvc containers: - name: hello-container image: busybox command: - sh - -c - 'while true; do echo \"`date` [`hostname`] Hello from OpenEBS Local PV.\" \u003e\u003e /mnt/store/greet.txt; sleep $(($RANDOM % 5 + 300)); done' volumeMounts: - mountPath: /mnt/store name: local-storage EOF å‘å¸ƒ $ kubectl apply -f local-device-pod.yaml æŸ¥çœ‹ pod çŠ¶æ€ $ kubectl get pod hello-local-device-pod -w NAME READY STATUS RESTARTS AGE hello-local-device-pod 1/1 Running 0 9s ç¡®è®¤ pod å…³è” pvc æ˜¯å¦ä¸º local-device-pvc $ kubectl describe pod hello-local-device-pod Name: hello-local-device-pod Namespace: default Node: node2/192.168.1.112 ... Volumes: local-storage: Type: PersistentVolumeClaim (a reference to a PersistentVolumeClaim in the same namespace) ClaimName: local-device-pvc ReadOnly: false ... è§‚å¯Ÿåˆ°è°ƒåº¦çš„èŠ‚ç‚¹ä¸º node2ï¼Œç¡®è®¤ node2 èŠ‚ç‚¹ /dev/sdb æ˜¯å¦è¢«ä½¿ç”¨ [root@node2 ~]# lsblk NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT sda 8:0 0 400G 0 disk â”œâ”€sda1 8:1 0 1G 0 part /boot â””â”€sda2 8:2 0 399G 0 part â””â”€centos-root 253:0 0 399G 0 lvm / sdb 8:16 0 20G 0 disk sr0 11:0 1 4.4G 0 rom [root@node2 ~]# lsblk NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT sda 8:0 0 400G 0 disk â”œâ”€sda1 8:1 0 1G 0 part /boot â””â”€sda2 8:2 0 399G 0 part â””â”€centos-root 253:0 0 399G 0 lvm / sdb 8:16 0 20G 0 disk /var/lib/kubelet/pods/266b7b14-5eb7-40ec-bccb-3ac189acf939/volumes/kubernetes.io~local-volume/pvc-9bd89019-13dc-4 sr0 11:0 1 4.4G 0 rom ç¡®å®è¢«ä½¿ç”¨ï¼ŒOpenEBS å¼ºå¤§ä¹‹å¤„åˆ™åœ¨äºæ­¤ï¼Œæè‡´çš„ç®€æ´ã€‚å¦‚ä¸Šæ–‡æˆ‘ä»¬è®¨è®ºçš„é‚£æ ·ï¼ŒNDM è´Ÿè´£å‘ç°å—è®¾å¤‡å¹¶è¿‡æ»¤æ‰ä¸åº”è¯¥è¢« OpenEBS ä½¿ç”¨çš„è®¾å¤‡ï¼Œä¾‹å¦‚ï¼Œæ£€æµ‹æœ‰ OS æ–‡ä»¶ç³»ç»Ÿçš„ç£ç›˜ã€‚ ","date":"2022-10-15","objectID":"/posts/d75507/:3:20","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"åŸºå‡†æµ‹è¯• åˆ›å»ºåŸºå‡†æµ‹è¯• pvc $ cat \u003e dbench-pvc.yaml \u003c\u003cEOF --- kind: PersistentVolumeClaim apiVersion: v1 metadata: name: dbench spec: storageClassName: local-device accessModes: - ReadWriteOnce resources: requests: storage: 5G EOF ä¸‹è½½**åŸºå‡†æµ‹è¯• Job å£°æ˜æ–‡ä»¶** è°ƒæ•´ä»¥ä¸‹å†…å®¹ image: openebs/perf-test:latest # è°ƒæ•´ä¸ºå†…ç½‘é•œåƒåº“tag å‘å¸ƒè¿è¡Œ $ kubectl create -f dbench-pvc.yaml $ kubectl create -f fio-deploy.yaml æŸ¥çœ‹è¿è¡ŒçŠ¶æ€ $ kubectl get pod NAME READY STATUS RESTARTS AGE dbench-vqk68-f9877 1/1 Running 0 24s æŸ¥çœ‹åŸºå‡†æµ‹è¯•ç»“æœ $ kubectl logs -f dbench-vqk68-f9877 ... All tests complete. ================== = Dbench Summary = ================== Random Read/Write IOPS: 3482/6450. BW: 336MiB/s / 1017MiB/s Average Latency (usec) Read/Write: 2305.77/1508.63 Sequential Read/Write: 6683MiB/s / 2312MiB/s Mixed Random Read/Write IOPS: 3496/1171 ä»ç»“æœæ¥çœ‹ï¼Œç›¸è¾ƒ Local PV HostPath æ¨¡å¼æ€§èƒ½ç¿»å€ ","date":"2022-10-15","objectID":"/posts/d75507/:3:21","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"æ€»ç»“ åœ¨æ•´ä¸ªæµ‹è¯•éªŒè¯è¿‡ç¨‹ï¼ŒOpenEBS ç»™æˆ‘çš„æ„Ÿè§‰æ˜¯ï¼šæç®€çš„æ“ä½œï¼Œå°¤å…¶ Local PV å¼•æ“çš„éƒ¨ç½²ä½¿ç”¨ã€‚ ä½† OpenEBS ç°é˜¶æ®µä¹Ÿå­˜åœ¨ä¸€äº›ä¸è¶³ï¼š cStor ä¸ Jiva æ•°æ®é¢ç»„ä»¶è¾ƒå¤šï¼Œé…ç½®è¾ƒä¸ºç¹çï¼ˆç¬¬ä¸€æ„Ÿè§‰æ¦‚å¿µæ€§çš„ç»„ä»¶è¿‡å¤šï¼Œï¼‰ cStor ä¸ Jiva éƒ¨åˆ†ç»„ä»¶åˆ›å»ºä¾èµ–å†…éƒ¨å®šä¹‰çš„é•œåƒ tagï¼Œåœ¨ç¦»çº¿ç¯å¢ƒä¸‹æ— æ³•é€šè¿‡è°ƒæ•´ä¸ºç§æœ‰åº“ tag å¯¼è‡´ç»„ä»¶æ— æ³•æˆåŠŸè¿è¡Œ å­˜å‚¨ç±»å‹å•ä¸€ï¼Œå¤šä¸ªå¼•æ“ä»…æ”¯æŒå—å­˜å‚¨ç±»å‹ï¼Œä¸æ”¯æŒåŸç”Ÿå¤šèŠ‚ç‚¹è¯»å†™ï¼ˆéœ€ç»“åˆ NFS å®ç°ï¼‰ï¼Œå¯¹æ¯” ceph ç­‰ç¨æ˜¾é€Šè‰² å»ºè®®ä»¥ä¸‹åœºæ™¯ä½¿ç”¨ OpenEBS ä½œä¸ºåç«¯å­˜å‚¨ï¼š å•æœºæµ‹è¯•ç¯å¢ƒ å¤šæœºå®éªŒ / æ¼”ç¤ºç¯å¢ƒ ","date":"2022-10-15","objectID":"/posts/d75507/:3:22","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["äº‘åŸç”Ÿ","å­˜å‚¨"],"content":"å‚è€ƒèµ„æ–™ å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å— ","date":"2022-10-15","objectID":"/posts/d75507/:3:23","tags":["openebs","å­˜å‚¨"],"title":"å…¨ç½‘æœ€å…¨çš„äº‘åŸç”Ÿå­˜å‚¨ OpenEBS ä½¿ç”¨æŒ‡å—","uri":"/posts/d75507/"},{"categories":["golang","æ¯æ—¥ä¸€åº“"],"content":"åœ¨ç”¨ Go å’Œ gin æ¡†æ¶å¼€å‘ç½‘ç«™æ—¶ï¼Œgin ç¼ºä¹å®æ—¶é‡è½½çš„åŠŸèƒ½æ˜¯ä»¤äººé—æ†¾çš„,ä¿®æ”¹å®Œä»£ç ä¹‹åç»å¸¸éœ€è¦ ctrl + c ç»“æŸæœåŠ¡ï¼Œé‡æ–°è¿è¡Œ go run,å½±å“å¼€å‘æ•ˆç‡ã€‚ Air æ˜¯ä¸º Go åº”ç”¨å¼€å‘è®¾è®¡çš„å¦å¤–ä¸€ä¸ªçƒ­é‡è½½çš„å‘½ä»¤è¡Œå·¥å…·ã€‚åªéœ€åœ¨ä½ çš„é¡¹ç›®æ ¹ç›®å½•ä¸‹è¾“å…¥ airï¼Œç„¶åæŠŠå®ƒæ”¾åœ¨ä¸€è¾¹ï¼Œä¸“æ³¨äºä½ çš„ä»£ç å³å¯ ","date":"2022-09-19","objectID":"/posts/f7f93a/:0:0","tags":["golang","air"],"title":"golangçƒ­åŠ è½½å·¥å…·","uri":"/posts/f7f93a/"},{"categories":["golang","æ¯æ—¥ä¸€åº“"],"content":"å®‰è£… # binary æ–‡ä»¶ä¼šæ˜¯åœ¨ $(go env GOPATH)/bin/air curl -sSfL https://raw.githubusercontent.com/cosmtrek/air/master/install.sh | sh -s -- -b $(go env GOPATH)/bin # æˆ–è€…æŠŠå®ƒå®‰è£…åœ¨ ./bin/ è·¯å¾„ä¸‹ curl -sSfL https://raw.githubusercontent.com/cosmtrek/air/master/install.sh | sh -s air -v ","date":"2022-09-19","objectID":"/posts/f7f93a/:1:0","tags":["golang","air"],"title":"golangçƒ­åŠ è½½å·¥å…·","uri":"/posts/f7f93a/"},{"categories":["golang","æ¯æ—¥ä¸€åº“"],"content":"åˆå§‹åŒ– cd /path/project/app air init # å½“å‰ç›®å½•ä¸‹ç”Ÿæˆé…ç½®æ–‡ä»¶ `.air.toml` ","date":"2022-09-19","objectID":"/posts/f7f93a/:2:0","tags":["golang","air"],"title":"golangçƒ­åŠ è½½å·¥å…·","uri":"/posts/f7f93a/"},{"categories":["golang","æ¯æ—¥ä¸€åº“"],"content":"é…ç½® root = \".\" testdata_dir = \"testdata\" tmp_dir = \"tmp\" [build] args_bin = [] bin = \"./tmp/main\" # ç¼–è¯‘è¾“å‡ºçš„äºŒè¿›åˆ¶æ–‡ä»¶ cmd = \"go build -o ./tmp/main .\" # ç¼–è¯‘å‘½ä»¤,å¦‚æœæœ‰å…¶ä»–å­å‘½ä»¤æˆ–è€…å‚æ•°å¯ä»¥é€šè¿‡ `air server --port 8081` ä¼ å…¥ delay = 1000 exclude_dir = [\"assets\", \"tmp\", \"vendor\", \"testdata\"] exclude_file = [] exclude_regex = [\"_test.go\"] exclude_unchanged = false follow_symlink = false full_bin = \"\" include_dir = [] include_ext = [\"go\", \"tpl\", \"tmpl\", \"html\"] kill_delay = \"0s\" log = \"build-errors.log\" send_interrupt = false stop_on_error = true [color] app = \"\" build = \"yellow\" main = \"magenta\" runner = \"green\" watcher = \"cyan\" [log] time = false [misc] clean_on_exit = false [screen] clear_on_rebuild = false ","date":"2022-09-19","objectID":"/posts/f7f93a/:3:0","tags":["golang","air"],"title":"golangçƒ­åŠ è½½å·¥å…·","uri":"/posts/f7f93a/"},{"categories":["golang","æ¯æ—¥ä¸€åº“"],"content":"ä½¿ç”¨ # è¿›å…¥é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ `air` å‘½ä»¤å³å¯ ","date":"2022-09-19","objectID":"/posts/f7f93a/:4:0","tags":["golang","air"],"title":"golangçƒ­åŠ è½½å·¥å…·","uri":"/posts/f7f93a/"},{"categories":["äº‘åŸç”Ÿ","Istio"],"content":"æŸ¥çœ‹ç›‘å¬ç«¯å£å’Œè¿›ç¨‹ istio-proxy@istio-ingressgateway-799bbc9474-hf7kv:/$ ss -ntlp State Recv-Q Send-Q Local Address:Port Peer Address:Port Process LISTEN 0 128 127.0.0.1:15000 0.0.0.0:* users:((\"envoy\",pid=16,fd=18)) LISTEN 0 128 127.0.0.1:15004 0.0.0.0:* users:((\"pilot-agent\",pid=1,fd=15)) LISTEN 0 128 0.0.0.0:15021 0.0.0.0:* users:((\"envoy\",pid=16,fd=24)) LISTEN 0 128 0.0.0.0:15021 0.0.0.0:* users:((\"envoy\",pid=16,fd=23)) LISTEN 0 128 0.0.0.0:8080 0.0.0.0:* users:((\"envoy\",pid=16,fd=40)) LISTEN 0 128 0.0.0.0:8080 0.0.0.0:* users:((\"envoy\",pid=16,fd=39)) LISTEN 0 128 0.0.0.0:15090 0.0.0.0:* users:((\"envoy\",pid=16,fd=22)) LISTEN 0 128 0.0.0.0:15090 0.0.0.0:* users:((\"envoy\",pid=16,fd=21)) LISTEN 0 128 *:15020 *:* users:((\"pilot-agent\",pid=1,fd=12)) istio-proxy@istio-ingressgateway-799bbc9474-hf7kv:/$ ps -ef |grep pilot-agent istio-p+ 1 0 0 Sep14 ? 00:01:27 /usr/local/bin/pilot-agent proxy router --domain istio-system.svc.cluster.local --proxyLogLevel=warning --proxyComponentLogLevel=misc:error --log_output_level=default:info istio-p+ 74 30 0 09:37 pts/0 00:00:00 grep --color=auto pilot-agent ","date":"2022-09-16","objectID":"/posts/3d18d6/:0:1","tags":["istio","pilot"],"title":"æ·±å…¥Istioç³»åˆ—-Pilot agent","uri":"/posts/3d18d6/"},{"categories":["äº‘åŸç”Ÿ","Istio"],"content":"pilot-agent proxy router å¯åŠ¨å‚æ•° istio-proxy@istio-ingressgateway-799bbc9474-hf7kv:/$ /usr/local/bin/pilot-agent proxy router --help XDS proxy agent Usage: pilot-agent proxy [flags] Flags: --concurrency int number of worker threads to run --domain string DNS domain suffix. If not provided uses ${POD_NAMESPACE}.svc.cluster.local -h, --help help for proxy --meshConfig string File name for Istio mesh configuration. If not specified, a default mesh will be used. This may be overridden by PROXY_CONFIG environment variable or proxy.istio.io/config annotation. (default \"./etc/istio/config/mesh\") --outlierLogPath string The log path for outlier detection --proxyComponentLogLevel string The component log level used to start the Envoy proxy. Deprecated, use proxyLogLevel instead --proxyLogLevel string The log level used to start the Envoy proxy (choose from {trace, debug, info, warning, error, critical, off}).Level may also include one or more scopes, such as 'info,misc:error,upstream:debug' (default \"warning,misc:error\") --serviceCluster string Service cluster (default \"istio-proxy\") --stsPort int HTTP Port on which to serve Security Token Service (STS). If zero, STS service will not be provided. --templateFile string Go template bootstrap config --tokenManagerPlugin string Token provider specific plugin name. (default \"GoogleTokenExchange\") Global Flags: --log_as_json Whether to format output as JSON or in plain console-friendly format --log_caller string Comma-separated list of scopes for which to include caller information, scopes can be any of [ads, all, authn, authorization, ca, cache, citadelclient, controllers, default, delta, dns, gcecred, googleca, googlecas, grpcgen, healthcheck, iptables, klog, mockcred, model, proxyconfig, sds, security, serviceentry, spiffe, stsclient, stsserver, telemetry, token, trustBundle, validation, wasm, wle, xdsproxy] --log_output_level string Comma-separated minimum per-scope logging level of messages to output, in the form of \u003cscope\u003e:\u003clevel\u003e,\u003cscope\u003e:\u003clevel\u003e,... where scope can be one of [ads, all, authn, authorization, ca, cache, citadelclient, controllers, default, delta, dns, gcecred, googleca, googlecas, grpcgen, healthcheck, iptables, klog, mockcred, model, proxyconfig, sds, security, serviceentry, spiffe, stsclient, stsserver, telemetry, token, trustBundle, validation, wasm, wle, xdsproxy] and level can be one of [debug, info, warn, error, fatal, none] (default \"default:info\") --log_rotate string The path for the optional rotating log file --log_rotate_max_age int The maximum age in days of a log file beyond which the file is rotated (0 indicates no limit) (default 30) --log_rotate_max_backups int The maximum number of log file backups to keep before older files are deleted (0 indicates no limit) (default 1000) --log_rotate_max_size int The maximum size in megabytes of a log file beyond which the file is rotated (default 104857600) --log_stacktrace_level string Comma-separated minimum per-scope logging level at which stack traces are captured, in the form of \u003cscope\u003e:\u003clevel\u003e,\u003cscope:level\u003e,... where scope can be one of [ads, all, authn, authorization, ca, cache, citadelclient, controllers, default, delta, dns, gcecred, googleca, googlecas, grpcgen, healthcheck, iptables, klog, mockcred, model, proxyconfig, sds, security, serviceentry, spiffe, stsclient, stsserver, telemetry, token, trustBundle, validation, wasm, wle, xdsproxy] and level can be one of [debug, info, warn, error, fatal, none] (default \"default:none\") --log_target stringArray The set of paths where to output the log. This can be any path as well as the special values stdout and stderr (default [stdout]) --vklog Level number for the log level verbosity. Like -v flag. ex: --vklog=9 istio-proxy@istio-ingressgateway-799bbc9474-hf7kv:/$ 20220916174047 ","date":"2022-09-16","objectID":"/posts/3d18d6/:0:2","tags":["istio","pilot"],"title":"æ·±å…¥Istioç³»åˆ—-Pilot agent","uri":"/posts/3d18d6/"},{"categories":["äº‘åŸç”Ÿ","Istio"],"content":"æŸ¥çœ‹meshconfigé…ç½® istio-proxy@istio-ingressgateway-799bbc9474-hf7kv:/$ cat ./etc/istio/config/mesh accessLogFile: /dev/stdout defaultConfig: discoveryAddress: istiod.istio-system.svc:15012 proxyMetadata: {} tracing: zipkin: address: zipkin.istio-system:9411 enablePrometheusMerge: true extensionProviders: - envoyOtelAls: port: 4317 service: opentelemetry-collector.istio-system.svc.cluster.local name: otel rootNamespace: istio-system trustDomain: cluster.local istio-proxy@istio-ingressgateway-799bbc9474-hf7kv:/$ 20220916174246 ","date":"2022-09-16","objectID":"/posts/3d18d6/:0:3","tags":["istio","pilot"],"title":"æ·±å…¥Istioç³»åˆ—-Pilot agent","uri":"/posts/3d18d6/"},{"categories":["äº‘åŸç”Ÿ"],"content":" # ss -ntlp State Recv-Q Send-Q Local Address:Port Peer Address:Port Process LISTEN 0 4096 127.0.0.1:10245 0.0.0.0:* users:((\"nginx-ingress-c\",pid=2671,fd=8)) LISTEN 0 511 127.0.0.1:10246 0.0.0.0:* users:((\"nginx\",pid=2783,fd=17),(\"nginx\",pid=2738,fd=17)) LISTEN 0 511 127.0.0.1:10247 0.0.0.0:* users:((\"nginx\",pid=2783,fd=18),(\"nginx\",pid=2738,fd=18)) LISTEN 0 4096 0.0.0.0:80 0.0.0.0:* users:((\"nginx\",pid=2783,fd=11),(\"nginx\",pid=2738,fd=11)) LISTEN 0 4096 0.0.0.0:8181 0.0.0.0:* users:((\"nginx\",pid=2783,fd=15),(\"nginx\",pid=2738,fd=15)) LISTEN 0 4096 0.0.0.0:443 0.0.0.0:* users:((\"nginx\",pid=2783,fd=13),(\"nginx\",pid=2738,fd=13)) LISTEN 0 4096 *:10254 *:* users:((\"nginx-ingress-c\",pid=2671,fd=33)) LISTEN 0 4096 [::]:80 [::]:* users:((\"nginx\",pid=2783,fd=12),(\"nginx\",pid=2738,fd=12)) LISTEN 0 4096 [::]:8181 [::]:* users:((\"nginx\",pid=2783,fd=16),(\"nginx\",pid=2738,fd=16)) LISTEN 0 4096 *:8443 *:* users:((\"nginx-ingress-c\",pid=2671,fd=34)) LISTEN 0 4096 [::]:443 [::]:* users:((\"nginx\",pid=2783,fd=14),(\"nginx\",pid=2738,fd=14)) ## nginx-ingress-controllerè¿›ç¨‹ # ps aux |grep -w 2671 _rpc 2671 0.4 0.2 743856 42000 ? Ssl Sep15 5:06 /nginx-ingress-controller --publish-service=ingress-nginx/ingress-nginx-controller --election-id=ingress-controller-leader --controller-class=k8s.io/ingress-nginx --ingress-class=nginx --configmap=ingress-nginx/ingress-nginx-controller --validating-webhook=:8443 --validating-webhook-certificate=/usr/local/certificates/cert --validating-webhook-key=/usr/local/certificates/key root 284760 0.0 0.0 3100 812 pts/1 S+ 04:15 0:00 grep -w 2671 # ## Nginx Master è¿›ç¨‹ # ps aux |grep -w 2738 _rpc 2738 0.0 0.2 145128 35448 ? S Sep15 0:00 nginx: master process /usr/local/nginx/sbin/nginx -c /etc/nginx/nginx.conf root 284662 0.0 0.0 3100 844 pts/1 S+ 04:15 0:00 grep -w 2738 # ## Nginx worker è¿›ç¨‹ # ps aux |grep -w 2783 _rpc 2783 0.0 0.2 157240 41060 ? Sl Sep15 0:31 nginx: worker process root 285147 0.0 0.0 3100 832 pts/1 S+ 04:17 0:00 grep -w 2783 # ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºæ•´ä¸ªIngress Nginx Controller Pod åŒ…å«ä¸¤éƒ¨åˆ† nginx-ingress-controller å’Œ Nginx nginx-ingress-controller å¦‚å…¶å æ§åˆ¶ç®¡ç†ï¼ˆcontrolï¼‰ingressèµ„æºçš„åº”ç”¨ã€‚ingress controllerä¼šç›‘å¬é›†ç¾¤ä¸­ingressèµ„æºäº‹ä»¶ï¼Œç„¶åæ ¹æ®å¯¹åº”çš„äº‹ä»¶å¤„ç†é€»è¾‘æ›´æ–°Nginxçš„é…ç½®ã€‚ ","date":"2022-09-16","objectID":"/posts/2da521/:0:0","tags":["ingress"],"title":"æ·±å…¥Ingress - Ingress Controlleræºç è§£æ","uri":"/posts/2da521/"},{"categories":["äº‘åŸç”Ÿ"],"content":"1 Controller æ§åˆ¶å™¨ ","date":"2022-09-16","objectID":"/posts/2da521/:1:0","tags":["ingress"],"title":"æ·±å…¥Ingress - Ingress Controlleræºç è§£æ","uri":"/posts/2da521/"},{"categories":["äº‘åŸç”Ÿ"],"content":"ç¼–è¯‘ Controller build/build.sh ${GO_BUILD_CMD} \\ -trimpath -ldflags=\"-buildid= -w -s \\ -X ${PKG}/version.RELEASE=${TAG} \\ -X ${PKG}/version.COMMIT=${COMMIT_SHA} \\ -X ${PKG}/version.REPO=${REPO_INFO}\" \\ -o \"${TARGETS_DIR}/nginx-ingress-controller\" \"${PKG}/cmd/nginx\" ä»æ„å»ºå‘½ä»¤å¯ä»¥çŸ¥é“ nginx-ingress-controller çš„å…¥å£åœ¨ cmd/nginx cmd/nginx/main.go func main() { klog.InitFlags(nil) rand.Seed(time.Now().UnixNano()) fmt.Println(version.String()) // å‘½ä»¤è¡Œä¼ å…¥é…ç½®ä¿¡æ¯ä»¥åŠä¸€äº›é»˜è®¤é…ç½®é¡¹ï¼Œå¹¶å®ä¾‹åŒ–controller.Configuration showVersion, conf, err := ingressflags.ParseFlags() if showVersion { os.Exit(0) } if err != nil { klog.Fatal(err) } err = file.CreateRequiredDirectories() if err != nil { klog.Fatal(err) } kubeClient, err := createApiserverClient(conf.APIServerHost, conf.RootCAFile, conf.KubeConfigFile) if err != nil { handleFatalInitError(err) } if len(conf.DefaultService) \u003e 0 { err := checkService(conf.DefaultService, kubeClient) if err != nil { klog.Fatal(err) } klog.InfoS(\"Valid default backend\", \"service\", conf.DefaultService) } if len(conf.PublishService) \u003e 0 { err := checkService(conf.PublishService, kubeClient) if err != nil { klog.Fatal(err) } } if conf.Namespace != \"\" { _, err = kubeClient.CoreV1().Namespaces().Get(context.TODO(), conf.Namespace, metav1.GetOptions{}) if err != nil { klog.Fatalf(\"No namespace with name %v found: %v\", conf.Namespace, err) } } conf.FakeCertificate = ssl.GetFakeSSLCert() klog.InfoS(\"SSL fake certificate created\", \"file\", conf.FakeCertificate.PemFileName) // æ£€æŸ¥ç‰ˆæœ¬ä¿¡æ¯ if !k8s.NetworkingIngressAvailable(kubeClient) { klog.Fatalf(\"ingress-nginx requires Kubernetes v1.19.0 or higher\") } _, err = kubeClient.NetworkingV1().IngressClasses().List(context.TODO(), metav1.ListOptions{}) if err != nil { if !errors.IsNotFound(err) { if errors.IsForbidden(err) { klog.Warningf(\"No permissions to list and get Ingress Classes: %v, IngressClass feature will be disabled\", err) conf.IngressClassConfiguration.IgnoreIngressClass = true } } } conf.Client = kubeClient err = k8s.GetIngressPod(kubeClient) if err != nil { klog.Fatalf(\"Unexpected error obtaining ingress-nginx pod: %v\", err) } // æ³¨å†ŒPrometheus reg := prometheus.NewRegistry() reg.MustRegister(collectors.NewGoCollector()) reg.MustRegister(collectors.NewProcessCollector(collectors.ProcessCollectorOpts{ PidFn: func() (int, error) { return os.Getpid(), nil }, ReportErrors: true, })) // metricæŒ‡æ ‡æ•°æ®é‡‡é›†ï¼Œmcæ˜¯ä¸€ä¸ªç”¨äºæ”¶é›†æŒ‡æ ‡çš„collectorå®ä¾‹ mc := metric.NewDummyCollector() if conf.EnableMetrics { mc, err = metric.NewCollector(conf.MetricsPerHost, conf.ReportStatusClasses, reg, conf.IngressClassConfiguration.Controller, *conf.MetricsBuckets) if err != nil { klog.Fatalf(\"Error creating prometheus collector: %v\", err) } } // Pass the ValidationWebhook status to determine if we need to start the collector // for the admissionWebhook mc.Start(conf.ValidationWebhook) // å¯ç”¨æ€§èƒ½è°ƒè¯•ç«¯å£ if conf.EnableProfiling { go metrics.RegisterProfiler(\"127.0.0.1\", nginx.ProfilerPort) } // å®ä¾‹åŒ– ngx controller æ§åˆ¶å™¨ ngx := controller.NewNGINXController(conf, mc) mux := http.NewServeMux() metrics.RegisterHealthz(nginx.HealthPath, mux, ngx) metrics.RegisterMetrics(reg, mux) _, errExists := os.Stat(\"/chroot\") if errExists == nil { conf.IsChroot = true go logger(conf.InternalLoggerAddress) } // å¯åŠ¨å¥åº·æ£€æŸ¥å’Œ metrics API æ¥å£ go metrics.StartHTTPServer(conf.HealthCheckHost, conf.ListenPorts.Health, mux) // å¯åŠ¨ nginx master è¿›ç¨‹ go ngx.Start() process.HandleSigterm(ngx, conf.PostShutdownGracePeriod, func(code int) { os.Exit(code) }) } controller å¯åŠ¨è¿›ç¨‹ä¸­ä¼ å…¥é…ç½®ä¿¡æ¯ä»¥åŠä¸€äº›é»˜è®¤é…ç½®é¡¹, å¹¶æ ¹æ®é…ç½®é¡¹å¯ç”¨ Metricsã€HealthCheckã€Profileã€Logging ç­‰åŠŸèƒ½ï¼Œæœ¬æ–‡ä¸»è¦ä»‹ç» Controller æ§åˆ¶å™¨ä¸»æµç¨‹ ngx := controller.NewNGINXController(conf, mc) ","date":"2022-09-16","objectID":"/posts/2da521/:1:1","tags":["ingress"],"title":"æ·±å…¥Ingress - Ingress Controlleræºç è§£æ","uri":"/posts/2da521/"},{"categories":["äº‘åŸç”Ÿ"],"content":"2 åˆ›å»ºNGINXController æ§åˆ¶å™¨ ","date":"2022-09-16","objectID":"/posts/2da521/:2:0","tags":["ingress"],"title":"æ·±å…¥Ingress - Ingress Controlleræºç è§£æ","uri":"/posts/2da521/"},{"categories":["äº‘åŸç”Ÿ"],"content":"2.1 NGINXController type NGINXController struct { // é…ç½®ä¿¡æ¯ cfg *Configuration // äº‹ä»¶é€šçŸ¥å™¨ recorder record.EventRecorder // åŒæ­¥é˜Ÿåˆ— syncQueue *task.Queue // åŒæ­¥çŠ¶æ€ -- [kubernetes-ingressçŠ¶æ€ä¸ŠæŠ¥æœºåˆ¶](https://blog.dianduidian.com/post/kubernetes-ingress%E7%8A%B6%E6%80%81%E4%B8%8A%E6%8A%A5%E6%9C%BA%E5%88%B6/) syncStatus status.Syncer // åŒæ­¥é™æµå™¨ syncRateLimiter flowcontrol.RateLimiter // stopLock is used to enforce that only a single call to Stop send at // a given time. We allow stopping through an HTTP endpoint and // allowing concurrent stoppers leads to stack traces. stopLock *sync.Mutex stopCh chan struct{} // æ›´æ–°ç¯çŠ¶channel updateCh *channels.RingChannel // æ¥å—nginx é”™è¯¯ä¿¡æ¯channel // ngxErrCh is used to detect errors with the NGINX processes ngxErrCh chan error // å½“å‰é…ç½®æ–‡ä»¶,ç”¨æ¥å¯¹æ¯”é…ç½®æ˜¯å¦æœ‰æ›´æ–° // runningConfig contains the running configuration in the Backend runningConfig *ingress.Configuration // nginx é…ç½®æ¨¡æ¿æ¸²æŸ“å™¨ t ngx_template.Writer // nameserver åˆ—è¡¨ // è¯»å–/etc/resolv.conf ä¸­çš„nsåœ°å€ï¼Œç”¨æ¥ç”Ÿæˆnginx.confä½¿ç”¨ï¼Œeg:resolver 127.0.0.1 [::1]:5353; resolver []net.IP // æ˜¯å¦å¯ç”¨ipv6 isIPV6Enabled bool // æ˜¯å¦å…³é—­ isShuttingDown bool // TCPä»£ç†ï¼Œå¯ç”¨SSLPassthroughæ—¶ä½¿ç”¨ Proxy *tcpproxy.TCPProxy // æœ¬åœ°ç¼“å­˜ store store.Storer // metrics æ”¶é›†å™¨ metricCollector metric.Collector admissionCollector metric.Collector // webhook validationWebhookServer *http.Server // æ“ä½œNginxçš„æ¥å£ï¼Œç”¨æ¥å¯åŠ¨Nginxè¿›ç¨‹å’Œæµ‹è¯•é…ç½®æ–‡ä»¶ command NginxExecTester } ","date":"2022-09-16","objectID":"/posts/2da521/:2:1","tags":["ingress"],"title":"æ·±å…¥Ingress - Ingress Controlleræºç è§£æ","uri":"/posts/2da521/"},{"categories":["äº‘åŸç”Ÿ"],"content":"2.2 Configuration type Configuration struct { APIServerHost string RootCAFile string KubeConfigFile string Client clientset.Interface ResyncPeriod time.Duration ConfigMapName string DefaultService string Namespace string WatchNamespaceSelector labels.Selector // +optional TCPConfigMapName string // +optional UDPConfigMapName string DefaultSSLCertificate string // +optional PublishService string PublishStatusAddress string UpdateStatus bool UseNodeInternalIP bool ElectionID string UpdateStatusOnShutdown bool HealthCheckHost string ListenPorts *ngx_config.ListenPorts DisableServiceExternalName bool EnableSSLPassthrough bool EnableProfiling bool EnableMetrics bool MetricsPerHost bool MetricsBuckets *collectors.HistogramBuckets ReportStatusClasses bool FakeCertificate *ingress.SSLCert SyncRateLimit float32 DisableCatchAll bool IngressClassConfiguration *ingressclass.IngressClassConfiguration ValidationWebhook string ValidationWebhookCertPath string ValidationWebhookKeyPath string DisableFullValidationTest bool GlobalExternalAuth *ngx_config.GlobalExternalAuth MaxmindEditionFiles *[]string MonitorMaxBatchSize int PostShutdownGracePeriod int ShutdownGracePeriod int InternalLoggerAddress string IsChroot bool DeepInspector bool DynamicConfigurationRetries int } è¿™äº›é…ç½®éœ€è¦æ§åˆ¶å™¨å¯åŠ¨æ—¶é€šè¿‡å‘½ä»¤è¡Œä¼ å…¥ ","date":"2022-09-16","objectID":"/posts/2da521/:2:2","tags":["ingress"],"title":"æ·±å…¥Ingress - Ingress Controlleræºç è§£æ","uri":"/posts/2da521/"},{"categories":["äº‘åŸç”Ÿ"],"content":"2.3 å®ä¾‹åŒ– NewNGINXController æ§åˆ¶å™¨ func NewNGINXController(config *Configuration, mc metric.Collector) *NGINXController { // kubectl describe å‘½ä»¤çœ‹åˆ°çš„äº‹ä»¶æ—¥å¿—å°±æ˜¯è¿™ä¸ªåº“äº§ç”Ÿçš„ eventBroadcaster := record.NewBroadcaster() eventBroadcaster.StartLogging(klog.Infof) eventBroadcaster.StartRecordingToSink(\u0026v1core.EventSinkImpl{ Interface: config.Client.CoreV1().Events(config.Namespace), }) // è¯»å–podé‡Œé¢çš„/etc/resolv.conf h, err := dns.GetSystemNameServers() if err != nil { klog.Warningf(\"Error reading system nameservers: %v\", err) } // å®ä¾‹åŒ– NGINXController n := \u0026NGINXController{ isIPV6Enabled: ing_net.IsIPv6Enabled(), resolver: h, cfg: config, syncRateLimiter: flowcontrol.NewTokenBucketRateLimiter(config.SyncRateLimit, 1), recorder: eventBroadcaster.NewRecorder(scheme.Scheme, apiv1.EventSource{ Component: \"nginx-ingress-controller\", }), stopCh: make(chan struct{}), updateCh: channels.NewRingChannel(1024), ngxErrCh: make(chan error), stopLock: \u0026sync.Mutex{}, // å½“å‰è¿è¡Œçš„é…ç½®æ–‡ä»¶ï¼Œåˆšå¯åŠ¨æ˜¯ä¸ºç©º runningConfig: new(ingress.Configuration), Proxy: \u0026tcpproxy.TCPProxy{}, metricCollector: mc, // ä¸€ä¸ªå¯ä»¥è°ƒç”¨ nginx -c nginx.conf å‘½ä»¤çš„å¯¹è±¡ command: NewNginxCommand(), } // å¯åŠ¨ webhook æœåŠ¡ if n.cfg.ValidationWebhook != \"\" { n.validationWebhookServer = \u0026http.Server{ Addr: config.ValidationWebhook, //G112 (CWE-400): Potential Slowloris Attack ReadHeaderTimeout: 10 * time.Second, Handler: adm_controller.NewAdmissionControllerServer(\u0026adm_controller.IngressAdmission{Checker: n}), TLSConfig: ssl.NewTLSListener(n.cfg.ValidationWebhookCertPath, n.cfg.ValidationWebhookKeyPath).TLSConfig(), // disable http/2 // https://github.com/kubernetes/kubernetes/issues/80313 // https://github.com/kubernetes/ingress-nginx/issues/6323#issuecomment-737239159 TLSNextProto: make(map[string]func(*http.Server, *tls.Conn, http.Handler)), } } // å®ä¾‹åŒ– store (æœ¬åœ°ç¼“å­˜) // store å¯¹è±¡ï¼Œå¾ˆé‡è¦ï¼Œæ•°æ®ç¼“å­˜ä¸k8säº¤äº’çš„æ¥å£éƒ½åœ¨è¿™ä¸ªå¯¹è±¡ n.store = store.New( config.Namespace, config.WatchNamespaceSelector, config.ConfigMapName, config.TCPConfigMapName, config.UDPConfigMapName, config.DefaultSSLCertificate, config.ResyncPeriod, config.Client, n.updateCh, config.DisableCatchAll, config.DeepInspector, config.IngressClassConfiguration) // åˆ›å»ºå·¥ä½œé˜Ÿåˆ—ï¼Œè¿™é‡ŒæŠŠ syncIngress æ³¨å†Œåˆ°è¿™ä¸ªå·¥ä½œé˜Ÿåˆ— n.syncQueue = task.NewTaskQueue(n.syncIngress) if config.UpdateStatus { n.syncStatus = status.NewStatusSyncer(status.Config{ Client: config.Client, PublishService: config.PublishService, PublishStatusAddress: config.PublishStatusAddress, IngressLister: n.store, UpdateStatusOnShutdown: config.UpdateStatusOnShutdown, UseNodeInternalIP: config.UseNodeInternalIP, }) } else { klog.Warning(\"Update of Ingress status is disabled (flag --update-status)\") } // ç›‘å¬æ¨¡æ¿æ–‡ä»¶æ›´æ–° onTemplateChange := func() { // æ¸²æŸ“æ¨¡æ¿ template, err := ngx_template.NewTemplate(nginx.TemplatePath) if err != nil { // this error is different from the rest because it must be clear why nginx is not working klog.ErrorS(err, \"Error loading new template\") return } // è‹¥æ¨¡æ¿æ¸²æŸ“æ­£ç¡®ï¼Œåˆ™æ›´æ–°åˆ° nginxcontroller å¯¹è±¡ä¸­ï¼Œå¹¶å¾€åŒæ­¥é˜Ÿåˆ—å‘é€ä¸€ä¸ª template-change äº‹ä»¶ n.t = template klog.InfoS(\"New NGINX configuration template loaded\") n.syncQueue.EnqueueTask(task.GetDummyObject(\"template-change\")) } // é¦–æ¬¡å¯åŠ¨åŠ è½½é…ç½®æ¨¡æ¿æ–‡ä»¶ ngxTpl, err := ngx_template.NewTemplate(nginx.TemplatePath) if err != nil { klog.Fatalf(\"Invalid NGINX configuration template: %v\", err) } n.t = ngxTpl // ç›‘å¬æ¨¡æ¿æ–‡ä»¶å˜åŒ– // ç›‘å¬ /etc/nginx/template/nginx.tmpl æ¨¡æ¿æ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–ï¼Œæœ‰å˜åŒ–åˆ™è°ƒç”¨ onTemplateChange _, err = file.NewFileWatcher(nginx.TemplatePath, onTemplateChange) if err != nil { klog.Fatalf(\"Error creating file watcher for %v: %v\", nginx.TemplatePath, err) } filesToWatch := []string{} err = filepath.Walk(\"/etc/nginx/geoip/\", func(path string, info os.FileInfo, err error) error { if err != nil { return err } if info.IsDir() { return nil } filesToWatch = append(filesToWatch, path) return nil }) if err != nil { klog.Fatalf(\"Error creating file watchers: %v\", err) } // é…ç½®æ–‡ä»¶æœ‰å˜åŒ–åˆ™å¾€åŒæ­¥é˜Ÿåˆ—å‘é€ä¸€ä¸ª file-change äº‹ä»¶ for _, f := range filesToWatch { _, err = file.NewFileWatcher(f, func() { klog.InfoS(\"File changed detected. Reloading NGINX\", \"path\", f) n.syncQueu","date":"2022-09-16","objectID":"/posts/2da521/:2:3","tags":["ingress"],"title":"æ·±å…¥Ingress - Ingress Controlleræºç è§£æ","uri":"/posts/2da521/"},{"categories":["äº‘åŸç”Ÿ"],"content":"2.4 åˆ›å»ºstore(æœ¬åœ°ç¼“å­˜) func New( namespace string, namespaceSelector labels.Selector, configmap, tcp, udp, defaultSSLCertificate string, resyncPeriod time.Duration, client clientset.Interface, updateCh *channels.RingChannel, disableCatchAll bool, deepInspector bool, icConfig *ingressclass.IngressClassConfiguration) Storer { // storeçš„å…·ä½“å®ç°æ˜¯k8sStore store := \u0026k8sStore{ informers: \u0026Informer{}, listers: \u0026Lister{}, sslStore: NewSSLCertTracker(), updateCh: updateCh, backendConfig: ngx_config.NewDefault(), syncSecretMu: \u0026sync.Mutex{}, backendConfigMu: \u0026sync.RWMutex{}, secretIngressMap: NewObjectRefMap(), defaultSSLCertificate: defaultSSLCertificate, } // kubectl describe å‘½ä»¤çœ‹åˆ°çš„äº‹ä»¶æ—¥å¿—å°±æ˜¯è¿™ä¸ªåº“äº§ç”Ÿçš„ eventBroadcaster := record.NewBroadcaster() eventBroadcaster.StartLogging(klog.Infof) eventBroadcaster.StartRecordingToSink(\u0026clientcorev1.EventSinkImpl{ Interface: client.CoreV1().Events(namespace), }) recorder := eventBroadcaster.NewRecorder(scheme.Scheme, corev1.EventSource{ Component: \"nginx-ingress-controller\", }) // ç”¨äºæå–æ³¨é‡Šçš„å¯¹è±¡ // é›†ä¸­åœ¨internal/ingress/annotationsç›®å½• // k8sStore fulfills resolver.Resolver interface store.annotations = annotations.NewAnnotationExtractor(store) // å°†æ•°æ®å†ç¼“å­˜ä¸€ä»½ç”¨äºæœ¬åœ°æŸ¥è¯¢ï¼Œç¼“å­˜çš„å¯¹è±¡æ­£å¦‚å…¶åIngressWithAnnotation // ä¼šç¼“å­˜internal/ingress/types.go:Ingress store.listers.IngressWithAnnotation.Store = cache.NewStore(cache.DeletionHandlingMetaNamespaceKeyFunc) // As we currently do not filter out kubernetes objects we list, we can // retrieve a huge amount of data from the API server. // In a cluster using HELM \u003c v3 configmaps are used to store binary data. // If you happen to have a lot of HELM releases in the cluster it will make // the memory consumption of nginx-ingress-controller explode. // In order to avoid that we filter out labels OWNER=TILLER. labelsTweakListOptionsFunc := func(options *metav1.ListOptions) { if len(options.LabelSelector) \u003e 0 { options.LabelSelector += \",OWNER!=TILLER\" } else { options.LabelSelector = \"OWNER!=TILLER\" } } // As of HELM \u003e= v3 helm releases are stored using Secrets instead of ConfigMaps. // In order to avoid listing those secrets we discard type \"helm.sh/release.v1\" secretsTweakListOptionsFunc := func(options *metav1.ListOptions) { helmAntiSelector := fields.OneTermNotEqualSelector(\"type\", \"helm.sh/release.v1\") baseSelector, err := fields.ParseSelector(options.FieldSelector) if err != nil { options.FieldSelector = helmAntiSelector.String() } else { options.FieldSelector = fields.AndSelectors(baseSelector, helmAntiSelector).String() } } // åˆ›å»ºinformerå·¥å‚å‡½æ•° // create informers factory, enable and assign required informers infFactory := informers.NewSharedInformerFactoryWithOptions(client, resyncPeriod, informers.WithNamespace(namespace), ) // infFactoryConfigmaps, infFactorySecrets // create informers factory for configmaps infFactoryConfigmaps := informers.NewSharedInformerFactoryWithOptions(client, resyncPeriod, informers.WithNamespace(namespace), informers.WithTweakListOptions(labelsTweakListOptionsFunc), ) // create informers factory for secrets infFactorySecrets := informers.NewSharedInformerFactoryWithOptions(client, resyncPeriod, informers.WithNamespace(namespace), informers.WithTweakListOptions(secretsTweakListOptionsFunc), ) store.informers.Ingress = infFactory.Networking().V1().Ingresses().Informer() store.listers.Ingress.Store = store.informers.Ingress.GetStore() if !icConfig.IgnoreIngressClass { store.informers.IngressClass = infFactory.Networking().V1().IngressClasses().Informer() store.listers.IngressClass.Store = cache.NewStore(cache.MetaNamespaceKeyFunc) } store.informers.Endpoint = infFactory.Core().V1().Endpoints().Informer() store.listers.Endpoint.Store = store.informers.Endpoint.GetStore() store.informers.Secret = infFactorySecrets.Core().V1().Secrets().Informer() store.listers.Secret.Store = store.informers.Secret.GetStore() store.informers.ConfigMap = infFactoryConfigmaps.Core().V1().ConfigMaps().Informer() store.listers.ConfigMap.Store = store.informers.ConfigMap.GetStore() store.informers.Ser","date":"2022-09-16","objectID":"/posts/2da521/:2:4","tags":["ingress"],"title":"æ·±å…¥Ingress - Ingress Controlleræºç è§£æ","uri":"/posts/2da521/"},{"categories":["äº‘åŸç”Ÿ"],"content":"2.5 syncIngress æ³¨æ„æœ‰ä¸¤ä¸ª syncIngress æ–¹æ³•,åˆ†åˆ«æ˜¯ NGINXController å’Œ store 2.5.1 NGINXController å…¥å£ n.syncQueue = task.NewTaskQueue(n.syncIngress) 2.5.2 store å…¥å£ AddFunc: func(obj interface{}) { ... ... store.syncIngress(ing) // ... updateCh.In() \u003c- Event{ Type: CreateEvent, Obj: obj, } } ","date":"2022-09-16","objectID":"/posts/2da521/:2:5","tags":["ingress"],"title":"æ·±å…¥Ingress - Ingress Controlleræºç è§£æ","uri":"/posts/2da521/"},{"categories":["äº‘åŸç”Ÿ"],"content":"3 Nginx åå‘ä»£ç† ","date":"2022-09-16","objectID":"/posts/2da521/:3:0","tags":["ingress"],"title":"æ·±å…¥Ingress - Ingress Controlleræºç è§£æ","uri":"/posts/2da521/"},{"categories":["äº‘åŸç”Ÿ"],"content":"3.1 nginx.tmpl æ–‡ä»¶å†…å®¹å¤ªå¤§ï¼Œè¯¦ç»†è¯·æŸ¥çœ‹æºæ–‡ä»¶ æ³¨è§£å†…å®¹ ","date":"2022-09-16","objectID":"/posts/2da521/:3:1","tags":["ingress"],"title":"æ·±å…¥Ingress - Ingress Controlleræºç è§£æ","uri":"/posts/2da521/"},{"categories":["äº‘åŸç”Ÿ"],"content":"Grafana å®éªŒå®¤çš„ Mimir æ˜¯ä¸€ä¸ªåœ¨ AGPLv3 è®¸å¯ä¸‹æ–°çš„æ—¶é—´åºåˆ—æ•°æ®åº“ï¼Œè¯¥å·¥ç¨‹å›¢é˜Ÿä» Cortex TSDB ä¸­æ±²å–ç²¾åï¼ŒåŒæ—¶é™ä½äº†å¤æ‚æ€§å¹¶æé«˜äº†å¯æ‰©å±•æ€§ã€‚ æ ¹æ® Grafana å®éªŒå®¤çš„æµ‹è¯•ï¼ŒMimir å¯ä»¥æ‰©å±•åˆ° 10 äº¿ä¸ªæ´»è·ƒæ—¶é—´åºåˆ—å’Œ 5000 ä¸‡ä¸ªæ ·æœ¬/ç§’çš„æ‘„å–ç‡ï¼Œè¯¥åŸºå‡†æµ‹è¯•è¦æ±‚è¿è¡Œä¸€ä¸ªå…·æœ‰ 7000 ä¸ª CPU æ ¸å¿ƒå’Œ 30TiB å†…å­˜çš„é›†ç¾¤ï¼Œè¿™å·²ç»æ˜¯æˆ‘å¬è¯´çš„æœ€å¤§ã€æœ€æ˜‚è´µçš„æ—¶é—´åºåˆ—æ•°æ®åº“çš„å…¬å…±åŸºå‡†æµ‹è¯•äº†ã€‚è¦é‡ç°è¿™æ ·è§„æ¨¡çš„åŸºå‡†æµ‹è¯•å¹¶ä¸é‚£ä¹ˆå®¹æ˜“ï¼Œå¹¸è¿çš„æ˜¯ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œç”¨æˆ·çš„å·¥ä½œè´Ÿè·è¦æ±‚è¦ä½å¾—å¤šï¼Œæ¯”è¾ƒå®¹æ˜“æ¨¡æ‹Ÿã€‚åœ¨æœ¬æ–‡æˆ‘ä»¬å°†å°è¯•æ¯”è¾ƒ VictoriaMetrics å’Œ Grafana Mimir é›†ç¾¤åœ¨ç›¸åŒç¡¬ä»¶ä¸Šçš„ä¸­ç­‰å·¥ä½œè´Ÿè½½ä¸‹è¿è¡Œçš„æ€§èƒ½å’Œèµ„æºä½¿ç”¨æƒ…å†µã€‚ ","date":"2022-09-14","objectID":"/posts/6650ff/:0:0","tags":["grafana","monitor","è½¬è½½"],"title":"Grafana Mimir å’Œ VictoriaMetrics ä¹‹é—´çš„æ€§èƒ½æµ‹è¯•","uri":"/posts/6650ff/"},{"categories":["äº‘åŸç”Ÿ"],"content":"æ–¹æ³• åœ¨æ¯”è¾ƒä¸¤ç§ä¸åŒäº§å“çš„æ—¶å€™ï¼Œæœ€å¤æ‚çš„äº‹æƒ…æ˜¯ä¿æŒé€æ˜å’Œå…¬æ­£ã€‚å°¤å…¶æ˜¯å½“ä½ å¯¹ä¸€ç§äº§å“éå¸¸ç†Ÿæ‚‰è€Œå¯¹å¦ä¸€ç§äº§å“å®Œå…¨é™Œç”Ÿçš„æ—¶å€™ã€‚åœ¨è¿™é‡Œæˆ‘ä»¬è¦éå¸¸æ„Ÿè°¢ Mimir çš„å·¥ç¨‹å›¢é˜Ÿï¼Œæˆ‘ä»¬åœ¨å‡†å¤‡è¿™ä¸ªåŸºå‡†çš„è¿‡ç¨‹ä¸­ä¸ä»–ä»¬è¿›è¡Œäº†è”ç³»ã€‚æˆ‘ä»¬éå¸¸æ„Ÿè°¢ä»–ä»¬æ„¿æ„å¼€æ”¾åœ°å›ç­”ä¸äº§å“æœ‰å…³çš„é—®é¢˜ï¼Œå¹¶è§£é‡Šå®çš„ç›¸å…³ç»†èŠ‚ï¼Œè¿™ç¡®å®å¾ˆæœ‰å¸®åŠ©ã€‚ VictoriaMetrics å’Œ Grafana Mimir éƒ½æ˜¯æ—¶é—´åºåˆ—æ•°æ®åº“ï¼Œæ”¯æŒå¤§éƒ¨åˆ†ç›¸åŒçš„åè®®å’Œ APIã€‚ä½†æ˜¯ï¼Œå®ƒä»¬å…·æœ‰ä¸åŒçš„æ¶æ„å’Œç»„ä»¶ï¼Œè¿™ä½¿å¾—æ¯”è¾ƒèµ·æ¥æ›´åŠ å¤æ‚ã€‚åœ¨åŸºå‡†æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨æœ‰é™çš„èµ„æºï¼Œå¹¶æ ¹æ®æˆ‘çš„ç†è§£å°†å®ƒä»¬åˆ†é…ç»™ä¸¤ä¸ªé›†ç¾¤ã€‚ ç„¶åï¼Œæˆ‘å°†è¿›è¡Œä¸€è½®åŸºå‡†æµ‹è¯•ï¼Œä»¥äº†è§£ä¸¤ç§è§£å†³æ–¹æ¡ˆå¦‚ä½•å¤„ç†ç›¸åŒçš„å·¥ä½œè´Ÿè½½ï¼Œä»¥åŠå®ƒä»¬åœ¨ä½¿ç”¨åˆ†é…çš„èµ„æºæ–¹é¢çš„æ•ˆç‡å¦‚ä½•ã€‚ åŸºå‡†æµ‹è¯•å°†åœ¨ Google Kubernetes Engine ä¸­è¿è¡Œï¼Œè¯¥å¼•æ“ç”± e2-standard-16 èŠ‚ç‚¹ï¼ˆæ¯ä¸ªèŠ‚ç‚¹å…·æœ‰ 16vCPU å’Œ 64GiB çš„ RAMï¼‰å’ŒåŸºäº SSD çš„æ ‡å‡†æŒä¹…å·ç»„æˆã€‚ ","date":"2022-09-14","objectID":"/posts/6650ff/:1:0","tags":["grafana","monitor","è½¬è½½"],"title":"Grafana Mimir å’Œ VictoriaMetrics ä¹‹é—´çš„æ€§èƒ½æµ‹è¯•","uri":"/posts/6650ff/"},{"categories":["äº‘åŸç”Ÿ"],"content":"Prometheus åŸºå‡†å·¥å…· ä¸ºäº†ç”Ÿæˆè´Ÿè½½ï¼Œæˆ‘å°†ä½¿ç”¨ Prometheus-benchmark(https://github.com/VictoriaMetrics/prometheus-benchmark) è¿™ä¸ªå·¥å…·ï¼Œå®ƒåœ¨ VictoriaMetrics å†…éƒ¨ç”¨äºå¯¹æ–°ç‰ˆæœ¬è¿›è¡Œæµ‹è¯•å’ŒåŸºå‡†æµ‹è¯•ã€‚ç”±äºä»¥ä¸‹åŸå› ï¼Œè¯¥å·¥å…·ä¼šäº§ç”Ÿç±»ä¼¼ç”Ÿäº§çš„å·¥ä½œè´Ÿè½½ï¼š ä½œä¸ºæ‘„å–æŒ‡æ ‡çš„æ¥æºï¼Œå®ƒä½¿ç”¨çœŸæ­£çš„ node_exporter ç›®æ ‡ï¼Œè¿™é€šå¸¸æ˜¯å¤§å¤šæ•°ç”Ÿäº§ç¯å¢ƒçš„æƒ…å†µï¼› ä½œä¸ºè¯»å–æŸ¥è¯¢çš„æ¥æºï¼Œå®ƒä½¿ç”¨ node_exporter æ¨èçš„è­¦æŠ¥è§„åˆ™ åˆ—è¡¨ï¼› éé›¶æŒ‡æ ‡æµå¤±ç‡ä¼šäº§ç”Ÿé¢å¤–çš„å‹åŠ›ï¼Œæ¨¡æ‹Ÿ Kubernetes ä¸­å‘¨æœŸæ€§çš„ pods é‡æ–°éƒ¨ç½²çš„åœºæ™¯ã€‚ Benchmark è¿è¡Œä¸¤ç»„ç›¸åŒçš„éš”ç¦»æœåŠ¡ï¼Œå®ƒä»¬ä¸­çš„æ¯ä¸€ä¸ªéƒ½è¢«é…ç½®ä¸ºæŠ“å–æŒ‡æ ‡ï¼Œé€šè¿‡è¿œç¨‹å†™å…¥å°†å®ƒä»¬è½¬å‘åˆ°é…ç½®çš„å­˜å‚¨ï¼Œå¹¶å®šæœŸæ‰§è¡Œè­¦æŠ¥è§„åˆ™ã€‚åŸºå‡†æµ‹è¯•çš„é…ç½®å¦‚ä¸‹ï¼š #Â howÂ frequentlyÂ toÂ scrapeÂ node_exporterÂ targets scrapeInterval:Â 15s #Â howÂ oftenÂ toÂ executeÂ configuredÂ rules queryInterval:Â 15s #Â definesÂ theÂ numberÂ ofÂ node_exporterÂ instancesÂ toÂ scrape targetsCount:Â 6000 #Â percentÂ ofÂ node_exporterÂ targetsÂ toÂ update #Â inÂ orderÂ toÂ generateÂ seriesÂ churnÂ rate scrapeConfigUpdatePercent:Â 1 #Â specifiesÂ howÂ frequentlyÂ toÂ updateÂ targets #Â forÂ generatingÂ timeÂ seriesÂ churnÂ rate scrapeConfigUpdateInterval:Â 10m åœ¨ https://gist.github.com/hagen1778/a0824cde3903d6506e1b18eff7fd8b40 æ­¤æ¬¡å¯ä»¥æŸ¥çœ‹ä½¿ç”¨çš„é…ç½®å‚æ•°çš„å®Œæ•´åˆ—è¡¨ã€‚ åŸºå‡†æµ‹è¯•ä¸­çš„æ¯ä¸ª node_exporter ç›®æ ‡äº§ç”Ÿå¤§çº¦ 900 ä¸ªï¼ˆå–å†³äº node_exporter è¿è¡Œçš„ç¡¬ä»¶ï¼‰æ—¶é—´åºåˆ—ï¼ŒtargetCount=6000 å’Œ scrapeInterval=15s ä»¥ 360k æ ·æœ¬/ç§’ çš„æ‘„å–ç‡äº§ç”Ÿå¤§çº¦ 550 ä¸‡ä¸ªæ´»è·ƒæ—¶é—´åºåˆ—åˆ°æ¯ä¸ªé…ç½®çš„è¿œç¨‹å­˜å‚¨ã€‚å¯¹äºé…ç½®çš„è­¦æŠ¥åˆ—è¡¨ï¼ŒqueryInterval=15s é€šè¿‡å³æ—¶æŸ¥è¯¢ç”Ÿæˆå¤§çº¦ 1.5 ä¸ªæŸ¥è¯¢/ç§’çš„è¯»å–è´Ÿè½½ã€‚scrapeConfigUpdatePercent=1 å’Œ scrapeConfigUpdateInterval=10m äº§ç”Ÿæ¯ 10 åˆ†é’Ÿçº¦ 60k æ–°æ—¶é—´åºåˆ—çš„ æµå¤±ç‡ ã€‚ ","date":"2022-09-14","objectID":"/posts/6650ff/:2:0","tags":["grafana","monitor","è½¬è½½"],"title":"Grafana Mimir å’Œ VictoriaMetrics ä¹‹é—´çš„æ€§èƒ½æµ‹è¯•","uri":"/posts/6650ff/"},{"categories":["äº‘åŸç”Ÿ"],"content":"Mimir å®‰è£… æˆ‘ä»¥å‰ä»æœªä½¿ç”¨è¿‡ Cortex æˆ– Mimirï¼Œæ‰€ä»¥æˆ‘ä» å®˜æ–¹æ–‡æ¡£ å’Œä¸€ä¸ªåˆ†å¸ƒå¼å®‰è£…çš„ Helm Chart å¼€å§‹æ¢ç´¢è¿™ä¸ªé¡¹ç›®ã€‚å…¶æ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ Mimir åˆ†å¸ƒå¼æ¶æ„ ä»ä¸Šå›¾å¯ä»¥çœ‹å‡º Mimir æœ‰ 7 ä¸ªä¸åŒçš„ç»„ä»¶ï¼Œç»™äººçš„ç¬¬ä¸€å°è±¡æ˜¯ä¸€ä¸ªå¤æ‚çš„ç³»ç»Ÿã€‚å€¼å¾—åº†å¹¸çš„æ˜¯ï¼Œhelm chart ä½¿äº‹æƒ…å˜å¾—æ›´å®¹æ˜“ï¼Œè€Œä¸”è¿˜æœ‰æ ¹æ®æœ‰æ•ˆè´Ÿè½½æä¾›äº†èµ„æºåˆ†é…å»ºè®®ã€‚å¤§å‹å·¥ä½œè´Ÿè½½çš„å»ºè®® è¦æ±‚å¤§çº¦ 140 ä¸ª CPU å’Œ 800GB å†…å­˜ï¼Œç”¨äº 1000 ä¸‡ä¸ªæ´»è·ƒæ—¶é—´åºåˆ—ã€‚å¯¹äºä¸€ä¸ªç®€å•çš„åŸºå‡†æµ‹è¯•ï¼Œæ˜¾ç„¶è¿™è¦æ±‚å¤ªé«˜äº†ï¼Œæ‰€ä»¥æˆ‘ä»é’ˆå¯¹ 100 ä¸‡ä¸ªæ´»è·ƒæ—¶é—´åºåˆ—çš„å°å‹å·¥ä½œè´Ÿè½½çš„æ¨èé…ç½®å¼€å§‹ï¼Œèµ„æºè¦æ±‚çº¦ä¸º 30 ä¸ª CPU å’Œ 200GB å†…å­˜ã€‚ é€šè¿‡å‡ æ¬¡æµ‹è¯•è¿è¡Œï¼Œæˆ‘å‘ç°æ¨èçš„å®¹é‡è§„åˆ’æ˜¯æ¯”è¾ƒä¿å®ˆçš„ã€‚ä¸º å°å‹å·¥ä½œè´Ÿè½½ æ‰€åšçš„è®¾ç½®å®Œå…¨èƒ½å¤Ÿæ¯”è¿™å¤šå‡ºä¸¤å€ï¼Œè€Œä¸”ï¼Œé€šè¿‡å¯¹ç»„ä»¶èµ„æºçš„ä¸€äº›æ‰‹åŠ¨è°ƒæ•´ï¼Œå®ƒè¿˜èƒ½å¤Ÿå¤„ç†æ›´å¤šã€‚ helm chart ä¸­æœ‰å¤§çº¦ 7 ä¸ªç¼“å­˜å‰¯æœ¬å’Œ overrides_exporterï¼Œæ²¡æœ‰è®¾ç½®æ˜ç¡®çš„é™åˆ¶ã€‚æˆ‘å‡è®¾å®ƒä»¬æ€»å…±æ¶ˆè€—çº¦ 1 ä¸ª CPUã€‚ å¯ä»¥åœ¨æ­¤å¤„ https://gist.github.com/hagen1778/856fb6e99d7b1dfe284158ca8952a9fd æ‰¾åˆ° Helm Chart Values å€¼çš„å®Œæ•´è¦†ç›–åˆ—è¡¨ã€‚ åœ¨æµ‹è¯•æœŸé—´ï¼Œæˆ‘ä¸å¾—ä¸çªç ´ä»¥ä¸‹é™åˆ¶ï¼š distributor: extraArgs: distributor.ingestion-rate-limit:Â \"10000000000000\" ingester: extraArgs: ingester.max-global-series-per-user:Â \"0\" ingester.max-global-series-per-metric:Â \"0\" querier: extraArgs: querier.max-fetched-chunks-per-query:Â \"8000000\" mimir: structuredConfig: limits: out_of_order_time_window:Â 1h æˆ‘åœ¨è¿™ä¸ªåŸºå‡†æµ‹è¯•ä¸­ä½¿ç”¨äº† grafana/mimir:2.2.0 è¿™ä¸ªå‘è¡Œç‰ˆã€‚ ä¸ºäº†ç›‘æ§å·²éƒ¨ç½²çš„è®¾ç½®ï¼Œæˆ‘ä½¿ç”¨äº† https://github.com/grafana/mimir/tree/main/operations/mimir-mixin-compiled è¿™é‡Œåˆ—å‡ºçš„ä»ªè¡¨ç›˜å’Œè®°å½•è§„åˆ™ã€‚ä»ªè¡¨ç›˜çš„åˆ—è¡¨éå¸¸ä¸°å¯Œå’Œè¯¦ç»†ï¼Œä½†æˆ‘å‘ç°ç”±äºä»¥ä¸‹åŸå› ï¼Œå®ƒä¸æ˜¯å¾ˆæ–¹ä¾¿ã€‚ æˆ‘æ²¡æœ‰æ‰¾åˆ°å…·æœ‰å…¨å±€æ¦‚è§ˆçš„ä»ªè¡¨ç›˜ï¼Œåªæ˜¯ä¸ºäº†æ˜¾ç¤ºé›†ç¾¤æ˜¯å¦ä¸€åˆ‡æ­£å¸¸ï¼› ä»ªè¡¨ç›˜ä¸­çš„æŸäº›é¢æ¿éœ€è¦éƒ¨ç½² è®°å½•è§„åˆ™ ï¼Œè¿™æ˜¯ä¸€ä¸ªé¢å¤–çš„æ­¥éª¤ï¼Œæœ‰äººå¯èƒ½ä¼šé”™è¿‡ï¼› ä¸€äº›é¢æ¿ä¾èµ–äºå¸¦æœ‰ cortex_ å‰ç¼€å’Œé€‰æ‹©å™¨çš„æŒ‡æ ‡ï¼Œä¾‹å¦‚ job=~\"(query-frontend.*|cortex|mimir)\"ã€‚Cortex å’Œ Mimir å‰ç¼€æŒ‡æ ‡æ··åˆåœ¨ä¸€èµ·ï¼Œå¯èƒ½ä¼šè®©å¤§å®¶æ„Ÿåˆ°å›°æƒ‘ã€‚ ä¸è¿‡æ€»çš„æ¥è¯´ Helm Chart éå¸¸æœ‰ç”¨ä¸”æ˜“äºç†è§£ï¼ŒMimir çš„å›¢é˜Ÿåœ¨è¿™é‡Œåšå¾—å¾ˆå¥½ï¼Œè®©æ–°æ‰‹æ›´å®¹æ˜“å®‰è£…ã€‚ ","date":"2022-09-14","objectID":"/posts/6650ff/:3:0","tags":["grafana","monitor","è½¬è½½"],"title":"Grafana Mimir å’Œ VictoriaMetrics ä¹‹é—´çš„æ€§èƒ½æµ‹è¯•","uri":"/posts/6650ff/"},{"categories":["äº‘åŸç”Ÿ"],"content":"VictoriaMetrics å®‰è£… VictoriaMetrics é›†ç¾¤æ¶æ„å¦‚ä¸‹æ‰€ç¤ºï¼š VictoriaMetrics é›†ç¾¤æ¶æ„ VictoriaMetrics æœ‰ 3 ç§ä¸åŒç±»å‹çš„ç»„ä»¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ helm chart è¿›è¡Œéƒ¨ç½²ã€‚VictoriaMetrics é›†ç¾¤çš„ç»„ä»¶ä¸ Mimir çš„ç»„ä»¶ä¸åŒï¼Œå…¶èµ„æºé…ç½®æ–‡ä»¶ä¹Ÿä¸åŒã€‚Mimir çš„ä¸€äº›ç»„ä»¶éœ€è¦é¢å¤–çš„å†…å­˜ï¼Œä½† VictoriaMetrics çš„ç»„ä»¶éœ€è¦é¢å¤–çš„ CPUã€‚å› æ­¤ï¼Œåœ¨èµ„æºåˆ†é…æ–¹é¢ï¼Œæˆ‘å°†å°½é‡åœ¨ä¸º Mimir åˆ†é…çš„è¾¹ç•Œå†…ã€‚ è¯·æ³¨æ„ï¼Œæˆ‘ä»¬ å»ºè®® è¿è¡Œå…·æœ‰å¤§é‡å°å‹ vmstorage èŠ‚ç‚¹çš„é›†ç¾¤ï¼Œè€Œä¸æ˜¯è¿è¡Œå…·æœ‰å°‘é‡å¤§å‹ vmstorage èŠ‚ç‚¹çš„é›†ç¾¤ã€‚ VictoriaMetrics çš„èµ„æºåˆ†é…æ¯” CPU çš„é™åˆ¶å¤šå‡ºçº¦ 1 ä¸ªæ ¸å¿ƒï¼Œä½†æ˜¯å†…å­˜å°‘ç”¨äº†å¤§çº¦ 80GiBï¼Œå¯ä»¥åœ¨ https://gist.github.com/hagen1778/bf143173b5512515950f41e3a9bd6005 è¿™é‡Œæ‰¾åˆ°å®Œæ•´çš„ helm chart values å€¼åˆ—è¡¨ã€‚ VictoriaMetrics é…ç½®äº† -replicationFactor=2ï¼Œè¿™ä¸ Mimir çš„é»˜è®¤å¤åˆ¶å› å­ ä¸åŒï¼Œè¿™æ˜¯ VictoriaMetrics çš„æ¨èå€¼ï¼Œç¨åä¼šæœ‰æ›´è¯¦ç»†çš„ä»‹ç»ã€‚ æˆ‘åœ¨è¿™ä¸ªåŸºå‡†æµ‹è¯•ä¸­ä½¿ç”¨çš„æ˜¯ VictoriaMetrics/VictoriaMetrics:1.80.0-cluster è¿™ä¸ªç‰ˆæœ¬ã€‚ VictoriaMetrics é…å¤‡äº† Grafana ä»ªè¡¨ç›˜ å’Œç”¨äº è‡ªæˆ‘ç›‘æ§çš„é¢„å®šä¹‰è­¦æŠ¥è§„åˆ™ ã€‚ ","date":"2022-09-14","objectID":"/posts/6650ff/:4:0","tags":["grafana","monitor","è½¬è½½"],"title":"Grafana Mimir å’Œ VictoriaMetrics ä¹‹é—´çš„æ€§èƒ½æµ‹è¯•","uri":"/posts/6650ff/"},{"categories":["äº‘åŸç”Ÿ"],"content":"åŸºå‡†æµ‹è¯• ","date":"2022-09-14","objectID":"/posts/6650ff/:5:0","tags":["grafana","monitor","è½¬è½½"],"title":"Grafana Mimir å’Œ VictoriaMetrics ä¹‹é—´çš„æ€§èƒ½æµ‹è¯•","uri":"/posts/6650ff/"},{"categories":["äº‘åŸç”Ÿ"],"content":"å¿«é€Ÿç»Ÿè®¡ è¯¥åŸºå‡†æµ‹è¯•å·²è¿è¡Œ 24 å°æ—¶ï¼› å‘é€åˆ° VictoriaMetrics å’Œ Mimir çš„æ ·æœ¬æ€»æ•°çº¦ä¸º 310 äº¿ï¼š360K æ ·æœ¬/ç§’ * 86400ï¼› åŸºå‡†æµ‹è¯•æœŸé—´ç”Ÿæˆçš„æ–°æ—¶é—´åºåˆ—æ€»æ•°çº¦ä¸º 1360 ä¸‡ï¼š550 ä¸‡åˆå§‹åºåˆ— + 6K ç³»åˆ—/åˆ†é’Ÿ * 60 åˆ†é’Ÿ * 24ã€‚ åœ¨ä½¿ç”¨çš„ åŸºå‡†å·¥å…· ä¸­ï¼Œæ‘„å–è´Ÿè½½ç”± vmagent ç”Ÿæˆã€‚å®ƒæš´éœ²äº†è®¸å¤šæœ‰ç”¨çš„æŒ‡æ ‡ï¼Œå¥½å¥‡çš„è¯»è€…å¯ä»¥åœ¨ Grafana ä»ªè¡¨æ¿å¿«ç…§ ä¸Šç ”ç©¶è¿™äº›æŒ‡æ ‡ã€‚æ ¹æ®è¿™äº›æŒ‡æ ‡ï¼Œä¸¤ä¸ªè¿œç¨‹å­˜å‚¨éƒ½å¯ä»¥å¾ˆå¥½åœ°æ‘„å–ï¼Œæ²¡æœ‰è¿”å›é”™è¯¯ï¼Œæ²¡æœ‰ä¸¢å¤±æ•°æ®ï¼Œæ¯ä¸ªæŒ‡æ ‡éƒ½æŒ‰é¢„æœŸäº¤ä»˜ã€‚ å¦‚å‰æ‰€è¿°ï¼ŒVictoriaMetrics å’Œ Mimir éƒ½æä¾›äº†ç”¨äºç›‘æ§çš„å·¥å…·å’Œä»ªè¡¨ç›˜ã€‚ä¸ºäº†å®¢è§‚åœ°æ¯”è¾ƒç»Ÿè®¡æ•°æ®ï¼Œæˆ‘ç”¨ Mimir çš„ä»ªè¡¨ç›˜æ‰€ä½¿ç”¨çš„ç£ç›˜ã€å†…å­˜å’Œ CPU ä½¿ç”¨ç‡çš„ç›¸åŒæŸ¥è¯¢æ¥åˆ¶ä½œäº†æ–°çš„ Grafana ä»ªè¡¨ç›˜ã€‚è¯¸å¦‚æ‘„å–ç‡ã€æ´»è·ƒæ—¶é—´åºåˆ—æˆ–å»¶è¿Ÿç­‰é¢æ¿ä½¿ç”¨ä¸åŒçš„æŒ‡æ ‡ï¼Œå› ä¸ºå®ƒä»¬æ˜¯ç”±æ¯ä¸ªè§£å†³æ–¹æ¡ˆçš„å†…éƒ¨ç»„ä»¶å¯¼å‡ºçš„ï¼Œè¯¥ä»ªè¡¨ç›˜çš„å¿«ç…§å¯åœ¨ https://snapshots.raintank.io/dashboard/snapshot/1lXGSoVm6xVDtKVZ8LFQvBCG1uDYKChJ è·å¾—ã€‚å…³äºæ¯ä¸ªä½¿ç”¨çš„æŸ¥è¯¢çš„ç»†èŠ‚å¯ä»¥åœ¨é¢æ¿çš„å·¦ä¸Šè§’æ‰¾åˆ°ã€‚ ","date":"2022-09-14","objectID":"/posts/6650ff/:5:1","tags":["grafana","monitor","è½¬è½½"],"title":"Grafana Mimir å’Œ VictoriaMetrics ä¹‹é—´çš„æ€§èƒ½æµ‹è¯•","uri":"/posts/6650ff/"},{"categories":["äº‘åŸç”Ÿ"],"content":"ç»“æœ Mimir å’Œ VictoriaMetrics éƒ½å®Œå…¨èƒ½å¤Ÿå¤„ç† 360k æ ·æœ¬/ç§’çš„æ‘„å–ç‡ï¼š Mimir å’Œ VictoriaMetrics çš„æ‘„å–ç‡å’Œæ´»è·ƒæ—¶é—´åºåˆ—æ•° VictoriaMetrics å’Œ Mimir ä¹‹é—´çš„æ´»è·ƒæ—¶é—´åºåˆ—æ•°é‡ç•¥æœ‰ä¸åŒï¼Œå› ä¸ºä¸¤ç§è§£å†³æ–¹æ¡ˆå¯¹å®ƒä»¬çš„è®¡ç®—æ–¹å¼ä¸åŒã€‚ç”±äºéé›¶æµå¤±ç‡ï¼ŒMimir çš„æ´»è·ƒæ—¶é—´åºåˆ—æ•°é‡åœ¨ä¸æ–­å¢é•¿ï¼Œæ¯ 2 å°æ—¶åˆ›å»ºä¸€ä¸ªæ–°çš„ TSDB å—æ—¶å°±ä¼šé‡ç½®å›æ¥ã€‚ Ingester æ˜¯ Mimir è´Ÿè´£æ¥æ”¶å’Œå¤„ç†å†™å…¥çš„ç»„ä»¶ï¼Œå°†æ¥æ”¶åˆ°çš„æ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­ã€‚è¿™æ ·çš„æ–¹æ³•å¤§å¤§å‡å°‘äº†å†™çš„æ”¾å¤§ä½œç”¨ï¼Œå¹¶æœ‰åŠ©äºå‡å°‘æ¥è§¦ç£ç›˜çš„é¢‘ç‡ã€‚ä½†æ˜¯æ¯ 2 å°æ—¶ï¼ˆå¯é…ç½®ï¼‰Ingester éœ€è¦åˆ·æ–°ç£ç›˜ä¸Šæ‰€æœ‰ç¼“å†²çš„æ•°æ®ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ TSDB å—å¹¶å°†å…¶ä¸Šä¼ åˆ°å¯¹è±¡å­˜å‚¨ã€‚æ­¤æ“ä½œå¯¹ç£ç›˜ä½¿ç”¨æŒ‡æ ‡æœ‰å½±å“ï¼š Mimir å’Œ VictoriaMetrics çš„ç£ç›˜ç»Ÿè®¡ä¿¡æ¯ è™½ç„¶å¤§å¤šæ•°æ—¶å€™ Mimir çš„ç£ç›˜ IO ä»ç„¶å¾ˆä½ï¼Œå‡ ä¹æ¯” VictoriaMetrics ä½ 2 å€ï¼Œä½†æ¯ 2 å°æ—¶ Mimir å°±å¼€å§‹åˆ›å»ºä¸€ä¸ª TSDB å—ï¼Œå¹¶æ¶ˆè€—é¢å¤–çš„ç£ç›˜èµ„æºã€‚ è§£å†³æ–¹æ¡ˆä¹‹é—´çš„ç£ç›˜ç©ºé—´ä½¿ç”¨é‡æƒ…å†µä¸ºï¼ŒVictoriaMetrics çš„ 49GiB å’Œ Mimir çš„ 369GiBã€‚è¯·æ³¨æ„ï¼Œè¯¥é¢æ¿ä»…è€ƒè™‘æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿçš„å¤§å°ã€‚Mimir è¿˜ä½¿ç”¨ Google Cloud Storage è¿›è¡Œé•¿æœŸå­˜å‚¨ï¼Œé¢å¤–å ç”¨äº† 149GiBï¼š gsutilÂ duÂ -shÂ gs://mimir-bench-tsdb/ 149.7Â GiBÂ gs://mimir-bench-tsdb ä¸€ä¸ªé‡è¦çš„æ³¨æ„äº‹é¡¹æ˜¯ï¼ŒIngester åœ¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸Šå­˜å‚¨ TSDB å—ï¼Œé»˜è®¤ä¸º 24 å°æ—¶ï¼Œå¯ä»¥æŸ¥çœ‹ -blocks-storage.tsdb.retention-period å‚æ•°ã€‚å› æ­¤æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸Šå ç”¨çš„ç£ç›˜å¤§å°å¯ä»¥å¤§å¤§å‡å°‘ã€‚ä½†æ˜¯ï¼Œåœ¨æ­¤æµ‹è¯•ä¸­ï¼Œä»ç„¶åªæœ‰é•¿æœŸå­˜å‚¨æ¯” VictoriaMetrics æœ¬åœ°å­˜å‚¨å ç”¨çš„ç©ºé—´å¤š 3 å€ã€‚ åœ¨æµ‹è¯•ä¹‹åï¼Œè¿˜å‘ç°äº†å…¶ä»–ç»†èŠ‚ã€‚Compactor åœ¨å¤šä¸ªæ—¶é—´é—´éš”å†…è¿è¡Œåˆå¹¶å¯¹è±¡å­˜å‚¨çš„æ•°æ®å—çš„å‹ç¼©ä½œä¸šï¼šé»˜è®¤ä¸º 2hã€12h å’Œ 24hã€‚ç”±äºæµ‹è¯•åªè¿è¡Œäº† 24 å°æ—¶ï¼Œæ‰€ä»¥ä¸å¯èƒ½å‘ç”Ÿæ‰€æœ‰çš„å‹ç¼©ä½œä¸šã€‚æ­£ç¡®çš„å‹ç¼©æ¯”è¾ƒå°†éœ€è¦è¿è¡Œå¤šå¤©çš„åŸºå‡†æµ‹è¯•ã€‚ æ­¤å¤– VictoriaMetrics çš„ CPU ä½¿ç”¨ç‡ä½äº Mimir çš„ï¼š Mimir å’Œ VictoriaMetrics çš„ CPU ä½¿ç”¨ç‡ å¯¹äºå¥½å¥‡çš„è¯»è€…ï¼Œå¯ä»¥ä»ä»ªè¡¨ç›˜å¿«ç…§ https://snapshots.raintank.io/dashboard/snapshot/1lXGSoVm6xVDtKVZ8LFQvBCG1uDYKChJ?viewPanel=2 ä¸­æŸ¥çœ‹æœ‰å…³æ¯ä¸ª pod CPU ä½¿ç”¨æƒ…å†µçš„è¯¦ç»†ä¿¡æ¯ã€‚è¿™äº›æŒ‡æ ‡å†æ¬¡è¯æ˜ï¼Œè¿™ä¸¤ä¸ªè§£å†³æ–¹æ¡ˆéƒ½å…·æœ‰éå¸¸ä¸åŒçš„æ¶æ„å’Œç»„ä»¶è®¾è®¡ã€‚å¯¹äº Mimir æ¥è¯´ï¼Œæœ€å¤§çš„ CPU ç”¨æˆ·æ˜¯ Ingester â€”â€” ä»…ä»–ä»¬å°±å¹³å‡æ¶ˆè€—äº† 13 ä¸ª CPU æ ¸ï¼Œé«˜å³°æ—¶è¾¾åˆ° 18 ä¸ªï¼Œåˆ©ç”¨ç‡ä¸ºå…¶æé™çš„ 80%ã€‚å¯¹äº VictoriaMetrics æ¥è¯´ï¼Œvmselects ä½¿ç”¨äº†å¤§éƒ¨åˆ† CPUï¼šå¹³å‡ 7 ä¸ª CPUï¼Œå³°å€¼é«˜è¾¾ 12 ä¸ª CPU å†…æ ¸ï¼Œåˆ©ç”¨ç‡ä¸ºå…¶æé™çš„ 70%ã€‚åœ¨è¿™ä¸ªåŸºå‡†æµ‹è¯•ä¸­ï¼ŒVictoriaMetrics å¹³å‡æ¶ˆè€—çš„ CPU æ¯” Mimir å°‘ 1.7 å€ã€‚ Mimir å’Œ VictoriaMetrics çš„å†…å­˜ä½¿ç”¨é‡ä¹Ÿä¸åŒï¼š Mimir å’Œ VictoriaMetrics çš„å†…å­˜ä½¿ç”¨ åœ¨æ­¤åŸºå‡†æµ‹è¯•ä¸­ï¼Œä¸ Mimir ç›¸æ¯”ï¼ŒVictoriaMetrics ä½¿ç”¨çš„å†…å­˜å°‘äº†å¤§çº¦ 5 å€ã€‚å¯ä»¥åœ¨ä»ªè¡¨ç›˜å¿«ç…§ https://snapshots.raintank.io/dashboard/snapshot/1lXGSoVm6xVDtKVZ8LFQvBCG1uDYKChJ ä¸­æ‰¾åˆ°ç»„ä»¶ä¹‹é—´çš„æ›´è¯¦ç»†æ¯”è¾ƒã€‚æœ€æœ‰ä»·å€¼çš„æ”¶è·æ˜¯ Mimir çš„ Ingester è¿è¡Œéå¸¸æ¥è¿‘æé™ï¼Œåˆ©ç”¨ç‡ä¸º 80-90%ï¼Œè¿™æ„å‘³ç€è¿›ä¸€æ­¥å¢åŠ è´Ÿè½½å¯èƒ½ä¼šå¯¼è‡´ OOM å¼‚å¸¸ã€‚ è¯»å–æŸ¥è¯¢çš„å»¶è¿Ÿå…·æœ‰ä»¥ä¸‹ç»Ÿè®¡ä¿¡æ¯ï¼š Mimir å’Œ VictoriaMetrics çš„è¯»å–æŸ¥è¯¢å»¶è¿Ÿ å¦‚å‰æ‰€è¿°ï¼Œè¯»å–è´Ÿè½½åªåŒ…æ‹¬å³æ—¶æŸ¥è¯¢ï¼Œå¹¶ä¸”ç”±æ‰§è¡Œ node_exporter æŒ‡æ ‡çš„è­¦æŠ¥è§„åˆ™çš„å¤–éƒ¨ ruler ç”Ÿæˆã€‚è§„åˆ™åˆ—è¡¨åŒ…å«è½»é‡çº§æŸ¥è¯¢å’Œæ¶‰åŠæ•°å°æ—¶æ•°æ®çš„é‡åº¦æŸ¥è¯¢ã€‚è¿™ä¼šå½±å“å»¶è¿Ÿï¼Œä½¿å¾—ä¸¤ä¸ªè§£å†³æ–¹æ¡ˆçš„ç¬¬ 50 ç™¾åˆ†ä½æ•°åœ¨ 100 åˆ° 500ms ä¹‹é—´ï¼Œä½†æ˜¯ï¼ŒMimir çš„ç¬¬ 99 ç™¾åˆ†ä½æ•°æœ€å¤§ä¸º 47 ç§’ï¼ŒVictoriaMetrics çš„æœ€å¤§ä¸º 20 ç§’ã€‚ æˆ‘æ²¡æœ‰åœ¨è¿™ä¸ªåŸºå‡†ä¸­æµ‹è¯•èŒƒå›´æŸ¥è¯¢ï¼Œè¿™å°†æ˜¯æœªæ¥è¿è¡Œçš„ä¸€ä¸ªå¾ˆå¥½çš„æµ‹è¯•åœºæ™¯ã€‚ ","date":"2022-09-14","objectID":"/posts/6650ff/:5:2","tags":["grafana","monitor","è½¬è½½"],"title":"Grafana Mimir å’Œ VictoriaMetrics ä¹‹é—´çš„æ€§èƒ½æµ‹è¯•","uri":"/posts/6650ff/"},{"categories":["äº‘åŸç”Ÿ"],"content":"å‰¯æœ¬ ä¸¤ç§è§£å†³æ–¹æ¡ˆéƒ½æœ‰ä¸åŒçš„å¤åˆ¶æ–¹æ³•ã€‚ åœ¨ Mimirï¼Œæ¯ä¸ªç³»åˆ—éƒ½ç”± distributors å¤åˆ¶ç»™ ingestersï¼Œå¦‚æœ Mimir é›†ç¾¤ä¸¢å¤±äº†ä¸€ä¸ª ingesterï¼Œåˆ™ä¸¢å¤±çš„ ingester æŒæœ‰çš„å†…å­˜ä¸­çš„ç³»åˆ—è‡³å°‘åœ¨å¦ä¸€ä¸ª ingester ä¸­å¯ç”¨ã€‚å› æ­¤ï¼Œåªè¦è‡³å°‘æœ‰ä¸€ä¸ªå‰¯æœ¬è¿˜æ´»ç€ï¼Œè¯»å–æŸ¥è¯¢å°±ä¼šæˆåŠŸã€‚å†™å…¥æŸ¥è¯¢éœ€è¦ä¸€å®šæ•°é‡çš„å‰¯æœ¬æ‰èƒ½æˆåŠŸï¼Œå› æ­¤å¤åˆ¶å› å­ä¸º 3 æ—¶ï¼Œåªæœ‰ä¸€ä¸ªå‰¯æœ¬ä¼šä¸¢å¤±ã€‚ å½“ ingester è¿”å›æ—¶ï¼Œå®ƒä¼šé€šè¿‡è¯»å– WAL æ¥æ¢å¤å…¶å†…å­˜çŠ¶æ€ã€‚æ¢å¤çš„ ingester åœ¨ç¦»çº¿æ—¶å¯èƒ½ä¼šä¸¢å¤±æœ€è¿‘çš„æ•°æ®ï¼Œå› æ­¤æŸ¥è¯¢è€…éœ€è¦æŸ¥è¯¢æ‰€æœ‰ ingester å¹¶åˆå¹¶æ•°æ®ä»¥å¡«è¡¥ç©ºç™½ï¼ˆå¦‚æœæœ‰ï¼‰ã€‚æ¯éš” 2 å°æ—¶ï¼Œæ¯ä¸ª ingester å°† TSDB æ•°æ®å—ä¸Šä¼ åˆ°å¯¹è±¡å­˜å‚¨ï¼Œå…¶ä¸­ compactor åˆå¹¶æ•°æ®å—ï¼Œå¦‚æœæœ‰é—´éš™ï¼Œåˆ™å¯¹æ•°æ®è¿›è¡Œå»é‡ï¼Œæ‰€ä»¥åªæœ‰ä¸€ä¸ªæ ·æœ¬è¢«é•¿æœŸä¿å­˜ã€‚ Mimir çš„å¤åˆ¶ä¿æŠ¤äº†åœ¨è®¡åˆ’ä¸­çš„é‡å¯æˆ–ç”±äºç¡¬ä»¶é—®é¢˜é€ æˆçš„æ„å¤– ingester å´©æºƒçš„æƒ…å†µä¸‹ï¼Œä¸ä¼šä¸¢å¤± ingester å†…å­˜ä¸­çš„æœ€æ–°æ•°æ®ã€‚ingester ä¸Šçš„å¤åˆ¶å¹¶ä¸èƒ½ä¿æŠ¤æ— æ³•åˆ°è¾¾çš„å¯¹è±¡å­˜å‚¨æˆ–å¯¹è±¡å­˜å‚¨ä¸Šçš„æ•°æ®æŸåï¼ˆç”±äºäººä¸ºé”™è¯¯æˆ–å‹ç¼©é”™è¯¯ï¼‰ã€‚å¯¹è±¡å­˜å‚¨çš„æ•°æ®å®‰å…¨ä¸ºå­˜å‚¨æä¾›å•†çš„è´£ä»»ã€‚ åœ¨ VictoriaMetrics ä¸­ï¼Œæ¯ä¸ªç³»åˆ—éƒ½ç”± vminserts å¤åˆ¶åˆ°å­˜å‚¨èŠ‚ç‚¹ã€‚è¿™æ„å‘³ç€ï¼Œåœ¨ä»»ä½•æ—¶å€™ï¼ŒVictoriaMetrics é›†ç¾¤éƒ½ä¼šåœ¨å­˜å‚¨èŠ‚ç‚¹ä¸Šä¿å­˜æ‰€æœ‰æ ·æœ¬çš„ N ä¸ªå‰¯æœ¬ã€‚å¤åˆ¶å› å­ä¸º 2 æ—¶ï¼Œåªæœ‰ä¸€ä¸ª vmstorage pod å¯ä»¥ä¸¢å¤±ï¼Œä»¥ä¿æŒå†™å…¥å’Œè¯»å–æˆåŠŸã€‚vmstorage èŠ‚ç‚¹æ²¡æœ‰æ•…æ„ä½¿ç”¨ WALï¼Œå› æ­¤å®ƒä»¬å¯ä»¥éå¸¸å¿«é€Ÿåœ°å¯åŠ¨å’Œè¿è¡Œã€‚æ¢å¤çš„ vmstorage åœ¨ç¦»çº¿æ—¶å¯èƒ½ä¼šä¸¢å¤±æœ€è¿‘çš„æ•°æ®ï¼Œå› æ­¤ vmselects éœ€è¦æŸ¥è¯¢æ‰€æœ‰ vmstorage å¹¶åˆå¹¶æ•°æ®ä»¥å¡«è¡¥ç©ºç™½ï¼ˆå¦‚æœæœ‰ï¼‰ã€‚ VictoriaMetrics çš„å¤åˆ¶å¯é˜²æ­¢ä¸¢å¤±å­˜å‚¨èŠ‚ç‚¹ï¼Œè¿™æ„å‘³ç€ï¼Œåœ¨æ•´ä¸ªæ—¶é—´èŒƒå›´å†…ï¼Œä¸€ä¸ªæˆ–å¤šä¸ªå­˜å‚¨èŠ‚ç‚¹å¯ä»¥ä¸¢å¤±ã€åœç”¨ã€æ›´æ¢æˆ–åªæ˜¯é‡æ–°å¯åŠ¨ï¼Œè€Œä¸ä¼šå¯¹æ•´ä¸ªæ—¶é—´èŒƒå›´å†…çš„è¯»è€…äº§ç”Ÿå½±å“ã€‚ è™½ç„¶åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œå¤åˆ¶éƒ½æ˜¯å…³äºæ•°æ®å®‰å…¨çš„ï¼Œä½†å®ƒä»ç„¶ä¸èƒ½ä¿è¯æ•°æ®å®‰å…¨ã€‚æˆ‘ä»¬åœ¨ Google Cloud ä¸­è¿è¡ŒåŸºå‡†æµ‹è¯•ï¼Œä½¿ç”¨ SSD æ°¸ä¹…æ€§ç£ç›˜ (SSD PD) ä½œä¸ºæœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶å°† Cloud Storage ä½œä¸º Mimir çš„å¯¹è±¡å­˜å‚¨ã€‚SSD PD å…·æœ‰ 5 ä¸ª 9 çš„æŒä¹…æ€§ï¼Œå¹¶åœ¨ä½¿ç”¨ x3 å¤åˆ¶ã€‚å¦‚æœæˆ‘ä»¬å‡è®¾ Cloud Storage å…·æœ‰è¶³å¤Ÿé«˜çš„å¯ç”¨æ€§è€Œä¸è¿›è¡Œå¤åˆ¶ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¹Ÿå¯ä»¥å¯¹ SSD PD è¿›è¡Œç›¸åŒçš„å‡è®¾ï¼Œå¹¶åœ¨æ•°æ®å¯ç”¨æ€§æ–¹é¢è·å¾—åŒç­‰åœ°ä½ã€‚å³ä½¿ Cloud Storage æ¯” SSD PD å…·æœ‰æ›´é«˜çš„å¯ç”¨æ€§æ‰¿è¯º - Mimir å’Œ VictoriaMetrics éƒ½ä¼šåœ¨ SSD PD å‘ç”Ÿæ•…éšœæ—¶é¢ä¸´å†™å…¥å’Œè¯»å–é—®é¢˜ï¼Œå°½ç®¡å­˜åœ¨å¤åˆ¶å› ç´ ã€‚ å¤åˆ¶æ— æ³•é˜²æ­¢å› èµ„æºä¸è¶³æˆ–å·¥ä½œè´Ÿè½½çªç„¶å¢åŠ è€Œå¯¼è‡´çš„å†…å­˜ä¸è¶³å¼‚å¸¸ (OOM)ã€‚åœ¨ VictoriaMetrics å’Œ Mimir ä¸­ï¼Œæ‘„å–çš„æ—¶é—´åºåˆ—åœ¨å„ç»„ä»¶ï¼ˆåˆ†åˆ«ä¸º vmstorage å’Œ ingesterï¼‰ä¹‹é—´å‡åŒ€åˆ†ç‰‡ã€‚å› æ­¤ï¼Œå¦‚æœå…¶ä¸­ä¸€ä¸ªç»„ä»¶ç”±äºè¿‡è½½è€Œå¼€å§‹å‡ºç° OOMï¼Œåˆ™å¾ˆå¯èƒ½å…¶ä»–ç»„ä»¶ä¹Ÿä¼šå‡ºç°è¿™ç§æƒ…å†µã€‚è¿™ç§æƒ…å†µå¯èƒ½ä¼šç”±äºçº§è”æ•…éšœè€Œå¯¼è‡´æ•°æ®ä¸¢å¤±ï¼Œç»„ä»¶å¼€å§‹ä¸€ä¸ªæ¥ä¸€ä¸ªåœ°å´©æºƒã€‚åªæœ‰å¢åŠ æ›´å¤šçš„èµ„æºæˆ–å‡å°‘å·¥ä½œè´Ÿè·ï¼Œæ‰èƒ½å¸®åŠ©æ‘†è„±è¿™ç§æƒ…å†µã€‚å¯¹äº VictoriaMetricsï¼Œæˆ‘å»ºè®®å°†å¤åˆ¶å› å­è®¾ç½®ä¸º 2ï¼Œä»¥é˜²æ­¢åœ¨ç»´æŠ¤æˆ–ç£ç›˜æ•…éšœæœŸé—´ä¸¢å¤±ä¸€ä¸ª vmstorage èŠ‚ç‚¹æ•°æ®ã€‚å¦‚æœéœ€è¦æ›´é«˜çš„å¯ç”¨æ€§ï¼Œæˆ‘ä»¬å»ºè®®å°†å¤åˆ¶ä¸‹æ²‰åˆ° SSD PD ç­‰æŒä¹…å­˜å‚¨æˆ–ä¸ºé›†ç¾¤åˆ†é…é¢å¤–èµ„æºã€‚ Mimir åœ¨å¤åˆ¶åæ¶ˆé™¤é‡å¤æ•°æ®çš„èƒ½åŠ›éå¸¸é…·ã€‚å®ƒä¸ä»…é™ä½äº†å­˜å‚¨æˆæœ¬ï¼Œè€Œä¸”è¿˜åº”è¯¥æé«˜äº†è¯»å–æ€§èƒ½ã€‚VictoriaMetrics ä»ä¸åˆ é™¤å¤åˆ¶æ•°æ®çš„é‡å¤æ•°æ®ï¼Œä»¥ç¡®ä¿åœ¨æŸäº› vmstorage èŠ‚ç‚¹ä¸Šçš„æ•°æ®ä¸¢å¤±æ—¶æ•°æ®ä»ç„¶å¯ç”¨äºæŸ¥è¯¢ã€‚ ","date":"2022-09-14","objectID":"/posts/6650ff/:5:3","tags":["grafana","monitor","è½¬è½½"],"title":"Grafana Mimir å’Œ VictoriaMetrics ä¹‹é—´çš„æ€§èƒ½æµ‹è¯•","uri":"/posts/6650ff/"},{"categories":["äº‘åŸç”Ÿ"],"content":"æ€»ç»“ ä¸¤ç§è§£å†³æ–¹æ¡ˆåœ¨å¤„ç†è´Ÿè½½æ–¹é¢éƒ½åšå¾—å¾ˆå¥½ã€‚æ²¡æœ‰å‘ç”Ÿæ•…éšœæˆ–ä¸­æ–­ï¼Œç³»ç»Ÿåœ¨ 24 å°æ—¶çš„æŒç»­è¯»å†™å‹åŠ›ä¸‹ä¿æŒç¨³å®šã€‚ä½†æ˜¯ï¼Œä¸¤ç§è§£å†³æ–¹æ¡ˆçš„ä¸åŒæ¶æ„éƒ½ä¼šäº§ç”Ÿå½±å“ã€‚æˆ‘å¯ä»¥è‚¯å®šåœ°è¯´ï¼ŒMimir æ¯” VictoriaMetrics æ›´è€—è´¹å†…å­˜â€”â€”å¯¹äºç›¸åŒçš„è´Ÿè½½ï¼Œå®ƒéœ€è¦ 5 å€ä»¥ä¸Šçš„å†…å­˜ã€‚åœ¨è¿›ä¸€æ­¥æ‰©å±•å·¥ä½œè´Ÿè½½æœŸé—´ï¼Œå†…å­˜æ˜¯ Mimir çš„ç“¶é¢ˆã€‚å³ä½¿æˆ‘å°† ingester çš„å¤åˆ¶å› å­ä» 3 é™ä½åˆ° 2ï¼Œå®ƒä»ç„¶éœ€è¦æ¯” VictoriaMetrics æ›´å¤šçš„å†…å­˜ã€‚ è™½ç„¶æ²¡æœ‰ä¸€ä¸ªé›†ç¾¤è¾¾åˆ°å®ƒä»¬çš„ CPU é™åˆ¶ï¼Œä½† VictoriaMetrics å¹³å‡æ¶ˆè€—çš„ CPU æ¯” Mimir å°‘äº†çº¦ 1.7 å€ã€‚ Mimir çš„ç¬¬ 50 ä¸ªç™¾åˆ†ç‚¹çš„å»¶è¿Ÿè¾ƒå¥½ï¼Œä½†ç¬¬ 99 ä¸ªç™¾åˆ†ç‚¹çš„å»¶è¿Ÿæ¯” VictoriaMetrics é«˜ä¸€å€ã€‚ç›®å‰å°šä¸æ¸…æ¥šæ˜¯ä»€ä¹ˆåŸå› å¯¼è‡´ Mimir çš„å»¶è¿Ÿå‡ºç°å¦‚æ­¤é«˜çš„å³°å€¼ã€‚ç„¶è€Œï¼Œé˜…è¯» Grafana Labs å›¢é˜Ÿè¿›è¡Œå…¶ä»–æµ‹è¯•æ–‡æ¡£ï¼Œè®©æˆ‘è§‰å¾— Mimir åœ¨è¯»å–å¤§æ—¶é—´èŒƒå›´å†…çš„æŒ‡æ ‡æ—¶å¯ä»¥èƒœè¿‡ VictoriaMetricsï¼Œå› ä¸ºå®ƒéœ€è¦æ‰«æå·²ç»é‡å¤çš„æ•°æ®ã€‚ VictoriaMetrics çš„ç£ç›˜ç©ºé—´ä½¿ç”¨ç‡è¾ƒä½ã€‚å¦‚æœæˆ‘ä»¬ä¸è€ƒè™‘ ingesters çš„æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼Œä»…å°† Mimir çš„é•¿æœŸå­˜å‚¨ä¸ VictoriaMetrics çš„ç£ç›˜ä½¿ç”¨æƒ…å†µè¿›è¡Œæ¯”è¾ƒâ€”â€”åè€…çš„ç£ç›˜ç©ºé—´ä½¿ç”¨é‡ä»ç„¶æ˜¯å‰è€…çš„ 3 å€ã€‚è™½ç„¶å¯¹è±¡å­˜å‚¨ä¸ SSD PD ç›¸æ¯”è¦ä¾¿å®œå¾—å¤šï¼Œä½†å®ƒä¹Ÿæ„å‘³ç€æ•°æ®è®¿é—®çš„é¢å¤–æˆæœ¬ã€‚é˜…è¯» Mimir å’Œ VictoriaMetrics ç”¨æˆ·å…³äºå­˜å‚¨æŒ‡æ ‡æˆæœ¬çš„è¯„è®ºä¼šå¾ˆæœ‰è¶£ã€‚ Mimir æœ‰å¾ˆå¤§çš„è§„æ¨¡æ½œåŠ›ï¼Œæ¯ä¸ªç»„ä»¶éƒ½å¯ä»¥å¾ˆå®¹æ˜“åœ°æ‰©å±•ã€‚å®ƒè¿˜å…·æœ‰å¼€ç®±å³ç”¨çš„åŒºåŸŸæ„ŸçŸ¥å¤åˆ¶ã€å¯¹ ingester å’Œ querier çš„å¯é…ç½®é™åˆ¶ã€é«˜æ•ˆçš„æ•°æ®å­˜å‚¨ä»¥åŠè®¸å¤šå…¶ä»–åŠŸèƒ½ï¼Œä¾‹å¦‚æŸ¥è¯¢åˆ†ç‰‡ã€‚æ–‡æ¡£ä»ç„¶éœ€è¦ä¸€äº›ä¼˜åŒ–ï¼Œä½†æ€»çš„æ¥è¯´æˆ‘å–œæ¬¢è¿™ä¸ªäº§å“ï¼ åœ¨æ­¤åŸºå‡†æµ‹è¯•ä¸­ï¼Œä¸ Mimir åœ¨ç›¸åŒç¡¬ä»¶ä¸Šç›¸æ¯”ï¼ŒVictoriaMetrics è¡¨ç°å‡ºæ›´é«˜çš„èµ„æºæ•ˆç‡å’Œæ€§èƒ½ã€‚ä»æ“ä½œä¸Šè®²ï¼ŒVictoriaMetrics æ‰©å±•æœ‰ç‚¹å¤æ‚ï¼Œå› ä¸ºæ•°æ®å­˜å‚¨åœ¨æœ‰çŠ¶æ€çš„ vmstorage èŠ‚ç‚¹ä¸Šã€‚è¿™ä½¿å¾—ç¼©å‡ vmstorage èŠ‚ç‚¹çš„æ•°é‡å˜å¾—éå¸¸é‡è¦ã€‚æˆ‘å»ºè®®åœ¨è§„åˆ’é›†ç¾¤çš„æ¶æ„æ—¶ï¼Œä¸€å®šè¦æœ‰ç›¸å½“æ•°é‡çš„ vmstorage èŠ‚ç‚¹ã€‚ åœ¨æ•°æ®æ–¹é¢ï¼ŒåŸºå‡†æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š å¯¹äºç›¸åŒçš„å·¥ä½œè´Ÿè½½ï¼ŒVictoriaMetrics ä½¿ç”¨çš„ CPU å‡å°‘äº† x1.7ï¼› å¯¹äºç›¸åŒæ•°é‡çš„æ´»è·ƒç³»åˆ—ï¼ŒVictoriaMetrics ä½¿ç”¨çš„å†…å­˜å‡å°‘äº† 5 å€ï¼› VictoriaMetrics åœ¨åŸºå‡†æµ‹è¯•æœŸé—´æ”¶é›†çš„ 24 å°æ—¶æ•°æ®ä½¿ç”¨çš„å­˜å‚¨ç©ºé—´å‡å°‘äº† 3 å€ã€‚ ","date":"2022-09-14","objectID":"/posts/6650ff/:5:4","tags":["grafana","monitor","è½¬è½½"],"title":"Grafana Mimir å’Œ VictoriaMetrics ä¹‹é—´çš„æ€§èƒ½æµ‹è¯•","uri":"/posts/6650ff/"},{"categories":["äº‘åŸç”Ÿ"],"content":"æ¢ç´¢æé™ åœ¨åŸºå‡†æµ‹è¯•çš„æé™æ¢ç´¢å›åˆä¸­ï¼Œæˆ‘å°†åªæµ‹è¯• VictoriaMetricsï¼Œå› ä¸º Mimir è´Ÿè½½çš„å¢åŠ å¼€å§‹å¯¼è‡´æ‘„å–å™¨ä¸Šçš„ OOM å¼‚å¸¸ã€‚è‡ªä¸Šä¸€ä¸ªåŸºå‡†æµ‹è¯•ä»¥æ¥ï¼Œä»…æ›´æ”¹äº†ä¸¤ä¸ªå‚æ•°ï¼š #Â definesÂ theÂ numberÂ ofÂ node_exporterÂ instancesÂ toÂ scrape targetsCount:Â 8000 #Â definesÂ howÂ manyÂ podsÂ ofÂ writersÂ toÂ deploy. #Â eachÂ replicaÂ willÂ scrapeÂ targetsCountÂ targetsÂ andÂ willÂ have #Â itsÂ ownÂ extraÂ labelÂ `replica`Â attachedÂ toÂ writtenÂ timeÂ series. writeReplicas:Â 4 è¯¥æ›´æ”¹å°†å”¯ä¸€ç›®æ ‡çš„æ•°é‡ä» 6000 ä¸ªå¢åŠ åˆ° 8000 ä¸ªï¼Œå¹¶å¯åŠ¨äº† 4 ä¸ª vmagent å‰¯æœ¬ï¼ˆæ¯ä¸ªå‰¯æœ¬éƒ½æœ‰å”¯ä¸€æ ‡ç­¾ï¼‰ï¼Œè¿™æ€»å…±ä½¿è´Ÿè½½å¢åŠ äº† 8000 * 4 / 6000 =~ 5 å€ ã€‚ å¯ä»¥åœ¨æ­¤å¤„ https://gist.github.com/hagen1778/dec1d6c73fb9cd1ae8f715ec5356a88e æ‰¾åˆ° helm chart values çš„å®Œæ•´è¦†ç›–åˆ—è¡¨ã€‚ ","date":"2022-09-14","objectID":"/posts/6650ff/:6:0","tags":["grafana","monitor","è½¬è½½"],"title":"Grafana Mimir å’Œ VictoriaMetrics ä¹‹é—´çš„æ€§èƒ½æµ‹è¯•","uri":"/posts/6650ff/"},{"categories":["äº‘åŸç”Ÿ"],"content":"å¿«é€Ÿç»Ÿè®¡ åŸºå‡†æµ‹è¯•å·²è¿è¡Œ 3 å°æ—¶ï¼› å‘é€åˆ° VictoriaMetrics çš„æ ·æœ¬æ€»æ•°çº¦ä¸º 195 äº¿ï¼š180 ä¸‡æ ·æœ¬/ç§’ * 3 * 3600ï¼› åŸºå‡†æµ‹è¯•æœŸé—´ç”Ÿæˆçš„æ–°æ—¶é—´åºåˆ—æ€»æ•°çº¦ä¸º 3180 ä¸‡ï¼š2750 ä¸‡åˆå§‹åºåˆ— + 24K ç³»åˆ—/åˆ†é’Ÿ * 60 åˆ†é’Ÿ * 3ã€‚ ","date":"2022-09-14","objectID":"/posts/6650ff/:6:1","tags":["grafana","monitor","è½¬è½½"],"title":"Grafana Mimir å’Œ VictoriaMetrics ä¹‹é—´çš„æ€§èƒ½æµ‹è¯•","uri":"/posts/6650ff/"},{"categories":["äº‘åŸç”Ÿ"],"content":"ç»“æœ åŸºå‡†æµ‹è¯•ç»“æœåœ¨ä¸Šä¸€è½®åŸºå‡†ä¸­ä½¿ç”¨çš„ä»ªè¡¨ç›˜å¿«ç…§ https://snapshots.raintank.io/dashboard/snapshot/hoDTqThPYDoLQ6YfHeGsRVtTB80pMLG5 ä¸Šè·å–ã€‚ VictoriaMetrics çš„æ‘„å–ç‡å’Œæ´»è·ƒæ—¶é—´åºåˆ— æˆ‘è¿˜æŠ“å–äº† VictoriaMetrics é›†ç¾¤ä»ªè¡¨æ¿çš„å¿«ç…§ https://snapshots.raintank.io/dashboard/snapshot/J61xIFLm5oV2Q5MDaQ2kADq3JeG18RUQ ï¼Œå…¶ä¸­åŒ…å«æ¯ä¸ªç»„ä»¶çš„æ›´è¯¦ç»†æŒ‡æ ‡ã€‚ VictoriaMetrics åœ¨åŸºå‡†æµ‹è¯•æœŸé—´ä¿æŒç¨³å®šï¼ŒæˆåŠŸæ¥æ”¶çº¦ 180 ä¸‡ä¸ªæ ·æœ¬/ç§’å’Œ 2900 ä¸‡ä¸ªæ´»è·ƒæ—¶é—´åºåˆ—ï¼ˆåŒ…æ‹¬å¤åˆ¶åœ¨å†… 5800 ä¸‡ä¸ªï¼‰ã€‚ä¸ä¹‹å‰çš„æµ‹è¯•ç›¸æ¯”ï¼ŒCPU åˆ©ç”¨ç‡æ˜¾ç€æé«˜ï¼š VictoriaMetrics CPU ä½¿ç”¨ç‡ ç°åœ¨çš„å¹³å‡ä½¿ç”¨ç‡åœ¨ 32 ä¸ªå¯ç”¨æ ¸å¿ƒä¸­è¾¾åˆ°äº†çº¦ 26 ä¸ªã€‚å¦‚æœæ£€æŸ¥æ¯ä¸ª pod çš„ CPU åˆ©ç”¨ç‡ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ° vmstorage å¹³å‡ä»¥ 80% çš„é€Ÿåº¦è¿è¡Œï¼Œå³°å€¼é«˜è¾¾ 99%ã€‚è¿™æ„å‘³ç€è¿›ä¸€æ­¥æ‰©å±•éœ€è¦æ›´å¤šçš„ CPU ç”¨äº vmstorage èŠ‚ç‚¹ã€‚ ç›¸åï¼ŒVictoriaMetrics åªä½¿ç”¨äº†å…è®¸å†…å­˜çš„ 1/4ï¼š VictoriaMetrics å†…å­˜ä½¿ç”¨ å­˜å‚¨èŠ‚ç‚¹ä¸Šå†…å­˜çš„å¹³å‡åˆ©ç”¨ç‡çº¦ä¸º 30%ã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœæ‘„å–ç‡ä¿æŒä¸å˜ï¼Œåˆ™æ´»è·ƒæ—¶é—´åºåˆ—çš„æ•°é‡å¯ä»¥ç¿»å€ã€‚ æŸ¥è¯¢å»¶è¿Ÿéšç€è´Ÿè½½çš„å¢åŠ è€Œæ˜¾ç€é™ä½ï¼š VictoriaMetrics çš„è¯»å–æŸ¥è¯¢å»¶è¿Ÿ ä»”ç»†è§‚å¯Ÿä¼šå‘ç° vmselects ä¹‹é—´çš„å‡è¡¡æ€§å¾ˆå·®ã€‚VictoriaMetrics é›†ç¾¤ helm chart ä½¿ç”¨æ ‡å‡† Kubernetes æœåŠ¡è¿›è¡Œè´Ÿè½½å‡è¡¡ï¼Œä½†æ²¡æœ‰æä¾›å¤ªå¤§çš„çµæ´»æ€§ã€‚åŸºäºæ­¤åŸºå‡†æµ‹è¯•çš„ç»“æœï¼Œæˆ‘ä»¬è®¡åˆ’ é€šè¿‡ nginx ä½¿ç”¨æ›´å¥½çš„å‡è¡¡ç­–ç•¥ ã€‚ç±»ä¼¼äº Mimir çš„ helm chart ä¸­çš„æ“ä½œæ–¹å¼ã€‚ ","date":"2022-09-14","objectID":"/posts/6650ff/:6:2","tags":["grafana","monitor","è½¬è½½"],"title":"Grafana Mimir å’Œ VictoriaMetrics ä¹‹é—´çš„æ€§èƒ½æµ‹è¯•","uri":"/posts/6650ff/"},{"categories":["äº‘åŸç”Ÿ"],"content":"æ€»ç»“ åŸºå‡†æµ‹è¯•æ–‡ç« æ€»æ˜¯å¾ˆæœ‰è¶£çš„ã€‚å†™è¿™äº›æ–‡ç« çš„ç›®çš„æ˜¯ä¸ºäº†è¯æ˜ä¸åŒè§£å†³æ–¹æ¡ˆçš„ä¼˜åŠ¿å’ŒåŠ£åŠ¿ï¼Œä»¥å±•ç¤ºä»¤äººå°è±¡æ·±åˆ»çš„æ•°å­—å’Œç»“è®ºã€‚ä½†æ˜¯ï¼Œæˆ‘å¿…é¡»è­¦å‘Šï¼Œæ²¡æœ‰ä¸€ä¸ªåŸºå‡†æµ‹è¯•æ˜¯å®¢è§‚çš„ï¼Œé€šå¸¸ä¸ç°å®çš„å…³è”æ€§å¾ˆå¼±ã€‚æˆ‘é¼“åŠ±è¯»è€…é’ˆå¯¹ä»–ä»¬çš„å…·ä½“éœ€æ±‚ã€ç¡¬ä»¶å’Œæ•°æ®è¿è¡Œè‡ªå·±çš„åŸºå‡†æµ‹è¯•ã€‚åªæœ‰è¿™æ ·ï¼Œä½ æ‰èƒ½ç¡®å®šç»è¿‡æµ‹è¯•çš„è§£å†³æ–¹æ¡ˆæ˜¯å¦ç¬¦åˆä½ çš„éœ€æ±‚å’ŒæœŸæœ›ã€‚ ç‰¹åˆ«æ„Ÿè°¢ Nikolay Khramchikhin ååŠ©æ’°å†™è¿™ç¯‡åšæ–‡ï¼Œå¹¶æ„Ÿè°¢ Mimir çš„å·¥ç¨‹å›¢é˜Ÿæä¾›å’¨è¯¢ï¼ åŸæ–‡åœ°å€ï¼šhttps://victoriametrics.com/blog/mimir-benchmark/ ","date":"2022-09-14","objectID":"/posts/6650ff/:7:0","tags":["grafana","monitor","è½¬è½½"],"title":"Grafana Mimir å’Œ VictoriaMetrics ä¹‹é—´çš„æ€§èƒ½æµ‹è¯•","uri":"/posts/6650ff/"},{"categories":["Linux"],"content":"Iptaleså››è¡¨äº”é“¾ ","date":"2022-09-14","objectID":"/posts/d2d1d6/:1:0","tags":["iptables"],"title":"Iptableçš„æ¦‚å¿µ","uri":"/posts/d2d1d6/"},{"categories":["Linux"],"content":"å››è¡¨äº”é“¾å…³ç³»æ¦‚è§ˆ raw è¡¨ mangle è¡¨ nat è¡¨ filter è¡¨ PREROUTING é“¾ âœ… âœ… âœ… âŒ INPUT é“¾ âŒ âœ… âœ… âœ” FORWARD é“¾ âŒ âœ… âŒ âœ… OUTPUT é“¾ âœ… âœ… âœ… âœ… POSTROUTING é“¾ âŒ âœ… âœ… âŒ Centos6ä¸­NATè¡¨ä¸æ”¯æŒINPUTé“¾ âœ… è¡¨ç¤ºé“¾æ”¯æŒåœ¨è¡¨æ“ä½œ, âŒ è¡¨ç¤ºé“¾ä¸æ”¯æŒåœ¨è¡¨æ“ä½œ, âœ” è¡¨ç¤ºéƒ¨åˆ†æ”¯æŒ iptablesä¸­åŒä¸€æ¡é“¾å››å¼ è¡¨çš„æ‰§è¡Œä¼˜å…ˆçº§ raw -\u003e mangle -\u003e nat -\u003e filter ","date":"2022-09-14","objectID":"/posts/d2d1d6/:1:1","tags":["iptables"],"title":"Iptableçš„æ¦‚å¿µ","uri":"/posts/d2d1d6/"},{"categories":["Linux"],"content":"æ•°æ®ç»è¿‡é˜²ç«å¢™çš„æµå‘ ","date":"2022-09-14","objectID":"/posts/d2d1d6/:1:2","tags":["iptables"],"title":"Iptableçš„æ¦‚å¿µ","uri":"/posts/d2d1d6/"},{"categories":["Linux"],"content":"è§„åˆ™æ¦‚å¿µ åŒ¹é…æ¡ä»¶ åŸºæœ¬åŒ¹é…æ¡ä»¶ æºåœ°å€ Source IP , ç›®æ ‡åœ°å€ Destination IP æ‰©å±•åŒ¹é…æ¡ä»¶ æºç«¯å£ Source Port , ç›®æ ‡ç«¯å£ Destination Port å¤„ç†åŠ¨ä½œ åºå· åç§° æè¿° 1 ACCEPT å…è®¸æ•°æ®åŒ…é€šè¿‡ 2 DROP ç›´æ¥ä¸¢å¼ƒæ•°æ®åŒ…ï¼Œä¸ç»™ä»»ä½•å›åº”ä¿¡æ¯ï¼Œå®¢æˆ·ç«¯ç›´åˆ°è¶…æ—¶æ‰åšå‡ºååº” 3 REJECT æ‹’ç»æ•°æ®åŒ…é€šè¿‡ï¼Œå¿…è¦æ—¶ä¼šç»™æ•°æ®å‘é€ç«¯ä¸€ä¸ªå“åº”çš„ä¿¡æ¯ï¼Œå®¢æˆ·ç«¯åˆšè¯·æ±‚å°±ä¼šæ”¶åˆ°æ‹’ç»çš„ä¿¡æ¯ 4 SNAT æºåœ°å€è½¬æ¢ï¼Œè§£å†³å†…ç½‘ç”¨æˆ·ç”¨åŒä¸€ä¸ªå…¬ç½‘åœ°å€ä¸Šç½‘çš„é—®é¢˜ 5 MASQUERADE SNATçš„ä¸€ç§ç‰¹æ®Šå½¢å¼ï¼Œé€‚ç”¨äºåŠ¨æ€çš„ä¸´æ—¶ä¼šå˜çš„IPä¸Š 6 DNAT ç›®æ ‡åœ°å€è½¬æ¢ 7 REDIRECT DNATçš„ç‰¹æ®Šå½¢å¼ï¼Œé‡å®šå‘è‡³åœ¨æœ¬æœºåšç«¯å£æ˜ å°„ 8 LOG åœ¨/var/log/messagesæ–‡ä»¶è®°å½•æ—¥å¿—ä¿¡æ¯ï¼Œç„¶åå°†æ•°æ®åŒ…ä¼ é€’ç»™ä¸‹ä¸€æ¡è§„åˆ™ ","date":"2022-09-14","objectID":"/posts/d2d1d6/:1:3","tags":["iptables"],"title":"Iptableçš„æ¦‚å¿µ","uri":"/posts/d2d1d6/"},{"categories":["äº‘åŸç”Ÿ"],"content":"Prometheus Operator å®‰è£…å®Œæˆåä¼šæœ‰å¾ˆå¤šé»˜è®¤çš„ç›‘æ§æŒ‡æ ‡ï¼Œä¸€ä¸æ³¨æ„å°±å¤§é‡çš„æŠ¥è­¦äº§ç”Ÿï¼Œæ‰€ä»¥æˆ‘ä»¬éå¸¸æœ‰å¿…è¦äº†è§£ä¸‹è¿™äº›å¸¸ç”¨çš„ç›‘æ§æŒ‡æ ‡ï¼Œæœ‰éƒ¨åˆ†æŒ‡æ ‡å¾ˆæœ‰å¯èƒ½å¯¹äºæˆ‘ä»¬è‡ªå·±çš„ä¸šåŠ¡å¯æœ‰å¯æ— ï¼Œæ‰€ä»¥å¯ä»¥é€‚å½“çš„è¿›è¡Œä¿®æ”¹ï¼Œè¿™é‡Œæˆ‘ä»¬å°±æ¥å¯¹å¸¸ç”¨çš„å‡ ä¸ªæŒ‡æ ‡è¿›è¡Œç®€å•çš„è¯´æ˜ã€‚ ","date":"2022-09-13","objectID":"/posts/adb863/:0:0","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"1. Kubernetes èµ„æºç›¸å…³ ","date":"2022-09-13","objectID":"/posts/adb863/:1:0","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"1.1 CPUThrottlingHigh å…³äº CPU çš„ limit åˆç†æ€§æŒ‡æ ‡ã€‚æŸ¥å‡ºæœ€è¿‘5åˆ†é’Ÿï¼Œè¶…è¿‡25%çš„ CPU æ‰§è¡Œå‘¨æœŸå—åˆ°é™åˆ¶çš„å®¹å™¨ã€‚è¡¨è¾¾å¼ï¼š sum(increase(container_cpu_cfs_throttled_periods_total{container!=\"\", }[5m])) by (container, pod, namespace) / sum(increase(container_cpu_cfs_periods_total{}[5m])) by (container, pod, namespace) \u003e ( 25 / 100 ) ç›¸å…³æŒ‡æ ‡ï¼š container_cpu_cfs_periods_totalï¼šå®¹å™¨ç”Ÿå‘½å‘¨æœŸä¸­åº¦è¿‡çš„ cpu å‘¨æœŸæ€»æ•° container_cpu_cfs_throttled_periods_totalï¼šå®¹å™¨ç”Ÿå‘½å‘¨æœŸä¸­åº¦è¿‡çš„å—é™çš„ cpu å‘¨æœŸæ€»æ•° ","date":"2022-09-13","objectID":"/posts/adb863/:1:1","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"1.2 KubeCPUOvercommit é›†ç¾¤ CPU è¿‡åº¦ä½¿ç”¨ã€‚CPU å·²ç»è¿‡åº¦ä½¿ç”¨æ— æ³•å®¹å¿èŠ‚ç‚¹æ•…éšœï¼ŒèŠ‚ç‚¹èµ„æºä½¿ç”¨çš„æ€»é‡è¶…è¿‡èŠ‚ç‚¹çš„ CPU æ€»é‡ï¼Œæ‰€ä»¥å¦‚æœæœ‰èŠ‚ç‚¹æ•…éšœå°†å½±å“é›†ç¾¤èµ„æºè¿è¡Œå› ä¸ºæ‰€éœ€èµ„æºå°†æ— æ³•è¢«åˆ†é…ã€‚ è¡¨è¾¾å¼ï¼š sum(namespace:kube_pod_container_resource_requests_cpu_cores:sum{}) / sum(kube_node_status_allocatable_cpu_cores) \u003e (count(kube_node_status_allocatable_cpu_cores)-1) / count(kube_node_status_allocatable_cpu_cores) ç›¸å…³æŒ‡æ ‡ï¼š kube_pod_container_resource_requests_cpu_coresï¼šèµ„æº CPU ä½¿ç”¨çš„ cores æ•°é‡ kube_node_status_allocatable_cpu_coresï¼šèŠ‚ç‚¹ CPU cores æ•°é‡ ","date":"2022-09-13","objectID":"/posts/adb863/:1:2","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"1.3 KubeMemoryOvercommit é›†ç¾¤å†…å­˜è¿‡åº¦ä½¿ç”¨ã€‚å†…å­˜å·²ç»è¿‡åº¦ä½¿ç”¨æ— æ³•å®¹å¿èŠ‚ç‚¹æ•…éšœï¼ŒèŠ‚ç‚¹èµ„æºä½¿ç”¨çš„æ€»é‡è¶…è¿‡èŠ‚ç‚¹çš„å†…å­˜æ€»é‡ï¼Œæ‰€ä»¥å¦‚æœæœ‰èŠ‚ç‚¹æ•…éšœå°†å½±å“é›†ç¾¤èµ„æºè¿è¡Œå› ä¸ºæ‰€éœ€èµ„æºå°†æ— æ³•è¢«åˆ†é…ã€‚è¡¨è¾¾å¼ï¼š sum(namespace:kube_pod_container_resource_requests_memory_bytes:sum{}) / sum(kube_node_status_allocatable_memory_bytes) \u003e (count(kube_node_status_allocatable_memory_bytes)-1) / count(kube_node_status_allocatable_memory_bytes) ç›¸å…³æŒ‡æ ‡ï¼š kube_pod_container_resource_requests_memory_bytesï¼šèµ„æºå†…å­˜ä½¿ç”¨çš„é‡ kube_node_status_allocatable_memory_bytesï¼šèŠ‚ç‚¹å†…å­˜é‡ ","date":"2022-09-13","objectID":"/posts/adb863/:1:3","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"1.4 KubeCPUQuotaOvercommit é›†ç¾¤CPUæ˜¯å¦è¶…åˆ†ã€‚æŸ¥çœ‹ CPU èµ„æºåˆ†é…çš„é¢åº¦æ˜¯å¦è¶…è¿‡è¿›ç¾¤æ€»é¢åº¦ è¡¨è¾¾å¼ï¼š sum(kube_pod_container_resource_limits_cpu_cores{job=\"kube-state-metrics\"}) / sum(kube_node_status_allocatable_cpu_cores) \u003e 1.1 ç›¸å…³æŒ‡æ ‡ï¼š kube_pod_container_resource_limits_cpu_coresï¼šèµ„æºåˆ†é…çš„ CPU èµ„æºé¢åº¦ kube_node_status_allocatable_cpu_coresï¼šèŠ‚ç‚¹ CPU æ€»é‡ ","date":"2022-09-13","objectID":"/posts/adb863/:1:4","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"1.5 KubeMemoryQuotaOvercommit é›†ç¾¤è¶…åˆ†å†…å­˜ï¼ŒæŸ¥çœ‹å†…å­˜èµ„æºåˆ†é…çš„é¢åº¦æ˜¯å¦è¶…è¿‡è¿›ç¾¤æ€»é¢åº¦ è¡¨è¾¾å¼ï¼š sum(kube_pod_container_resource_limits_memory_bytes{job=\"kube-state-metrics\"}) / sum(kube_node_status_allocatable_memory_bytes{job=\"kube-state-metrics\"}) \u003e 1.1 ç›¸å…³æŒ‡æ ‡: kube_pod_container_resource_limits_memory_bytesï¼šèµ„æºé…é¢å†…å­˜é‡ kube_node_status_allocatable_memory_bytesï¼šèŠ‚ç‚¹å†…å­˜é‡ ","date":"2022-09-13","objectID":"/posts/adb863/:1:5","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"1.6 KubeMEMQuotaExceeded å‘½åç©ºé—´çº§å†…å­˜èµ„æºä½¿ç”¨çš„æ¯”ä¾‹ï¼Œå…³ä¹èµ„æºé…é¢ã€‚å½“ä½¿ç”¨ request å’Œ limit é™åˆ¶èµ„æºæ—¶ï¼Œä½¿ç”¨å€¼å’Œæœ€å¤§å€¼è¿˜æ˜¯æœ‰ä¸€ç‚¹åŒºåˆ«ï¼Œå½“æœ‰ request æ—¶è¯´æ˜æœ€ä½åˆ†é…äº†è¿™ä¹ˆå¤šèµ„æºã€‚éœ€è¦æ³¨æ„å½“ request ç­‰äº limit æ—¶é‚£ä¹ˆè¯´æ˜èµ„æºå·²ç»æ˜¯100%å·²ç»åˆ†é…ä½¿ç”¨å½“ç›‘æ§å‘Šè­¦å‘å‡ºçš„æ—¶å€™éœ€è¦åŒºåˆ†ã€‚è¡¨è¾¾å¼ï¼š sum (kube_pod_container_resource_requests_memory_bytes{job=\"kube-state-metrics\"} ) by (namespace)/ (sum(kube_pod_container_resource_limits_memory_bytes{job=\"kube-state-metrics\"}) by (namespace)) \u003e 0.8 ç›¸å…³æŒ‡æ ‡: kube_pod_container_resource_requests_memory_bytesï¼šå†…å­˜èµ„æºä½¿ç”¨é‡ kube_pod_container_resource_limits_memory_bytesï¼šå†…å­˜èµ„æºæœ€å¤§å€¼ ","date":"2022-09-13","objectID":"/posts/adb863/:1:6","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"1.7 KubeCPUQuotaExceeded å‘½åç©ºé—´çº§ CPU èµ„æºä½¿ç”¨çš„æ¯”ä¾‹ï¼Œå…³ä¹èµ„æºé…é¢ã€‚å½“ä½¿ç”¨ request å’Œ limit é™åˆ¶èµ„æºæ—¶ï¼Œä½¿ç”¨å€¼å’Œæœ€å¤§å€¼è¿˜æ˜¯æœ‰ä¸€ç‚¹åŒºåˆ«ï¼Œå½“æœ‰ request æ—¶è¯´æ˜æœ€ä½åˆ†é…äº†è¿™ä¹ˆå¤šèµ„æºã€‚éœ€è¦æ³¨æ„å½“ request ç­‰äº limit æ—¶é‚£ä¹ˆè¯´æ˜èµ„æºå·²ç»æ˜¯100%å·²ç»åˆ†é…ä½¿ç”¨å½“ç›‘æ§å‘Šè­¦å‘å‡ºçš„æ—¶å€™éœ€è¦åŒºåˆ†ã€‚ è¡¨è¾¾å¼ï¼š sum (kube_pod_container_resource_requests_cpu_cores{job=\"kube-state-metrics\"} ) by (namespace)/ (sum(kube_pod_container_resource_limits_cpu_cores{job=\"kube-state-metrics\"}) by (namespace)) \u003e 0.8 ç›¸å…³æŒ‡æ ‡: kube_pod_container_resource_requests_cpu_coresï¼šCPU ä½¿ç”¨é‡ kube_pod_container_resource_limits_cpu_coresï¼šCPU é™é¢æœ€å¤§å€¼ ","date":"2022-09-13","objectID":"/posts/adb863/:1:7","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"2. Kubernetes å­˜å‚¨ç›¸å…³ ","date":"2022-09-13","objectID":"/posts/adb863/:2:0","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"2.1 KubePersistentVolumeFillingUp PVC å®¹é‡ç›‘æ§ è¡¨è¾¾å¼ï¼š kubelet_volume_stats_available_bytes{job=\"kubelet\", metrics_path=\"/metrics\"} / kubelet_volume_stats_capacity_bytes{job=\"kubelet\", metrics_path=\"/metrics\"} \u003c 0.3 ç›¸å…³æŒ‡æ ‡ï¼š kubelet_volume_stats_available_bytesï¼šå‰©ä½™ç©ºé—´ kubelet_volume_stats_capacity_bytesï¼šç©ºé—´æ€»é‡ ","date":"2022-09-13","objectID":"/posts/adb863/:2:1","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"2.2 KubePersistentVolumeFillingUp ç£ç›˜ç©ºé—´è€—å°½é¢„æµ‹ï¼šé€šè¿‡PVCèµ„æºä½¿ç”¨6å°æ—¶å˜åŒ–ç‡é¢„æµ‹ æ¥ä¸‹æ¥4å¤©çš„ç£ç›˜ä½¿ç”¨ç‡ è¡¨è¾¾å¼ï¼š (kubelet_volume_stats_available_bytes{job=\"kubelet\", metrics_path=\"/metrics\"} / kubelet_volume_stats_capacity_bytes{job=\"kubelet\", metrics_path=\"/metrics\"} ) \u003c 0.4 and predict_linear(kubelet_volume_stats_available_bytes{job=\"kubelet\", metrics_path=\"/metrics\"}[6h], 4 * 24 * 3600) \u003c 0 ç›¸å…³æŒ‡æ ‡: kubelet_volume_stats_available_bytesï¼šå‰©ä½™ç©ºé—´ kubelet_volume_stats_capacity_bytesï¼šç©ºé—´æ€»é‡ ","date":"2022-09-13","objectID":"/posts/adb863/:2:2","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"2.3 KubePersistentVolumeErrors PV ä½¿ç”¨çŠ¶æ€ç›‘æ§ã€‚ è¡¨è¾¾å¼ï¼š kube_persistentvolume_status_phase{phase=~\"Failed|Pending\",job=\"kube-state-metrics\"} ç›¸å…³æŒ‡æ ‡ï¼š kube_persistentvolume_status_phaseï¼šPV ä½¿ç”¨çŠ¶æ€ ","date":"2022-09-13","objectID":"/posts/adb863/:2:3","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"3. kubernetes system ç›¸å…³ ","date":"2022-09-13","objectID":"/posts/adb863/:3:0","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"3.1 KubeVersionMismatch ç»„ä»¶ç‰ˆæœ¬ä¸å½“å‰é›†ç¾¤ç‰ˆæœ¬æ˜¯å¦æœ‰å·®å¼‚ã€‚å¯¹æ¯”ç»„ä»¶ç‰ˆæœ¬æ˜¯å¦æœ‰å·®å¼‚ï¼Œé»˜è®¤ä¸º1 ã€‚ è¡¨è¾¾å¼ï¼š count(count by (gitVersion) (label_replace(kubernetes_build_info{job!~\"kube-dns|coredns\"},\"gitVersion\",\"$1\",\"gitVersion\",\"(v[0-9]*.[0-9]*.[0-9]*).*\"))) ç›¸å…³æŒ‡æ ‡ï¼š kubernetes_build_infoï¼šè·å–ç»„ä»¶ä¿¡æ¯ ","date":"2022-09-13","objectID":"/posts/adb863/:3:1","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"3.2 KubeClientErrors å®¢æˆ·ç«¯è®¿é—®æŸäº›æ¥å£çš„é”™è¯¯ç‡ã€‚ è¡¨è¾¾å¼ï¼š (sum(rate(rest_client_requests_total{code=~\"5..\"}[5m])) by (instance, job) / sum(rate(rest_client_requests_total[5m])) by (instance, job)) \u003e 0.01 ç›¸å…³æŒ‡æ ‡ï¼š rest_client_requests_totalï¼šçŠ¶æ€ç  ","date":"2022-09-13","objectID":"/posts/adb863/:3:2","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"4. APIServer ç›¸å…³ ","date":"2022-09-13","objectID":"/posts/adb863/:4:0","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"4.1 KubeAPIErrorsHigh APIServer è¯·æ±‚é”™è¯¯ç‡ã€‚5åˆ†é’Ÿå†… APIServer è¯·æ±‚é”™è¯¯ç‡ã€‚ è¡¨è¾¾å¼ï¼š sum(rate(apiserver_request_total{job=\"apiserver\",code=~\"5..\"}[5m])) by (resource,subresource,verb) / sum(rate(apiserver_request_total{job=\"apiserver\"}[5m])) by (resource,subresource,verb) \u003e 0.05 ç›¸å…³æŒ‡æ ‡ï¼š apiserver_request_totalï¼šAPIServer è¯·æ±‚æ•° ","date":"2022-09-13","objectID":"/posts/adb863/:4:1","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"4.2 KubeClientCertificateExpiration kubelet å®¢æˆ·ç«¯è¯ä¹¦è¿‡æœŸã€‚ç›‘æµ‹è¯ä¹¦çŠ¶æ€30å¤©å‘Šè­¦å’Œ7å¤©å‘Šè­¦ã€‚ è¡¨è¾¾å¼ï¼š apiserver_client_certificate_expiration_seconds_count{job=\"apiserver\"} \u003e 0 and on(job) histogram_quantile(0.01, sum by (job, le) (rate(apiserver_client_certificate_expiration_seconds_bucket{job=\"apiserver\"}[5m]))) \u003c 2592000 apiserver_client_certificate_expiration_seconds_count{job=\"apiserver\"} \u003e 0 and on(job) histogram_quantile(0.01, sum by (job, le) (rate(apiserver_client_certificate_expiration_seconds_bucket{job=\"apiserver\"}[5m]))) \u003c 604800 ç›¸å…³æŒ‡æ ‡ï¼š apiserver_client_certificate_expiration_seconds_countï¼šè¯ä¹¦æœ‰æ•ˆå‰©ä½™æ—¶é—´ ","date":"2022-09-13","objectID":"/posts/adb863/:4:2","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"4.3 AggregatedAPIErrors è‡ªå®šä¹‰æ³¨å†Œçš„ APIServer æœåŠ¡å¯ç”¨æ€§ç›‘æ§ï¼Œå½“æ£€æµ‹åˆ°è‡ªå®šä¹‰æ³¨å†Œçš„ APIServer äº”åˆ†é’Ÿä¸ç”¨æ¬¡æ•°è¾¾åˆ°2æ¬¡ã€‚ è¡¨è¾¾å¼ï¼š sum by(name, namespace)(increase(aggregator_unavailable_apiservice_count[5m])) \u003e 2 ç›¸å…³æŒ‡æ ‡: aggregator_unavailable_apiservice_countï¼šç›‘æµ‹è‡ªå®šä¹‰æ³¨å†Œçš„ APIService ä¸å¯ç”¨æ¬¡æ•°ã€‚ ","date":"2022-09-13","objectID":"/posts/adb863/:4:3","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"4.4 KubeAPIDown APIserver å¤±è”ï¼Œç›‘æ§ APIServer æœåŠ¡ï¼Œå¤±è”åŸå› å¯èƒ½æ˜¯æœåŠ¡ down è¿˜å¯èƒ½æ˜¯ç½‘ç»œå‡ºç°çŠ¶å†µã€‚ è¡¨è¾¾å¼ï¼š absent(up{job=\"apiserver\"} == 1) ","date":"2022-09-13","objectID":"/posts/adb863/:4:4","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"5. kubelet ç›¸å…³ ","date":"2022-09-13","objectID":"/posts/adb863/:5:0","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"5.1 KubeNodeNotReady èŠ‚ç‚¹æ˜¯å¦å¤„äºå°±ç»ªçŠ¶æ€ã€‚æ£€æµ‹èŠ‚ç‚¹æ˜¯å¦ä¸ºå°±ç»ªçŠ¶æ€ï¼Œæˆ–è€…å¯èƒ½æ˜¯ kubelet æœåŠ¡down äº†ã€‚ è¡¨è¾¾å¼ï¼š - kube_node_status_condition{job=\"kube-state-metrics\",condition=\"Ready\",status=\"true\"} == 0 ç›¸å…³æŒ‡æ ‡ï¼š kube_node_status_conditionï¼šèŠ‚ç‚¹çŠ¶æ€ç›‘æµ‹ ","date":"2022-09-13","objectID":"/posts/adb863/:5:1","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"5.2 KubeNodeUnreachable èŠ‚ç‚¹çŠ¶æ€ä¸º Unreachableã€‚ è¡¨è¾¾å¼ï¼š kube_node_spec_unschedulable{job=\"kube-state-metrics\"} == 1 ","date":"2022-09-13","objectID":"/posts/adb863/:5:2","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"5.3 KubeletTooManyPods èŠ‚ç‚¹è¿è¡Œè¿‡å¤šçš„ Podï¼Œç›‘æµ‹èŠ‚ç‚¹ä¸Šè¿è¡Œçš„ Pods æ•°é‡ã€‚ è¡¨è¾¾å¼ï¼š max(max(kubelet_running_pod_count{job=\"kubelet\", metrics_path=\"/metrics\"}) by(instance) * on(instance) group_left(node) kubelet_node_name{job=\"kubelet\", metrics_path=\"/metrics\"}) by(node) / max(kube_node_status_capacity_pods{job=\"kube-state-metrics\"} != 1) by(node) \u003e 0.95 ç›¸å…³æŒ‡æ ‡ï¼š kubelet_running_pod_countï¼šèŠ‚ç‚¹è¿è¡Œçš„ Pods æ•°é‡ kubelet_node_nameï¼šèŠ‚ç‚¹åç§° kube_node_status_capacity_podsï¼šèŠ‚ç‚¹å¯è¿è¡Œçš„æœ€å¤§ Pod æ•°é‡ ","date":"2022-09-13","objectID":"/posts/adb863/:5:3","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"5.4 KubeNodeReadinessFlapping ç›‘æµ‹é›†ç¾¤çŠ¶æ€ï¼ŒæŸ¥çœ‹é›†ç¾¤å†…èŠ‚ç‚¹çŠ¶æ€æ”¹å˜çš„é¢‘ç‡ã€‚ è¡¨è¾¾å¼ï¼š sum(changes(kube_node_status_condition{status=\"true\",condition=\"Ready\"}[15m])) by (node) \u003e 2 ","date":"2022-09-13","objectID":"/posts/adb863/:5:4","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"5.5 KubeletDown ç›‘æ§ kubelet æœåŠ¡ï¼Œdown æˆ–è€…ç½‘ç»œå‡ºç°é—®é¢˜ã€‚ è¡¨è¾¾å¼ï¼š absent(up{job=\"kubelet\", metrics_path=\"/metrics\"} == 1) ","date":"2022-09-13","objectID":"/posts/adb863/:5:5","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"6. é›†ç¾¤ç»„ä»¶ ","date":"2022-09-13","objectID":"/posts/adb863/:6:0","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"6.1 KubeSchedulerDown KubeScheduler å¤±è”ï¼Œç›‘æµ‹ KubeScheduler æ˜¯å¦æ­£å¸¸ã€‚ è¡¨è¾¾å¼ï¼š absent(up{job=\"kube-scheduler\"} == 1) ","date":"2022-09-13","objectID":"/posts/adb863/:6:1","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"6.2 KubeControllerManagerDown ç›‘æµ‹ KubeControllerManager æœåŠ¡ï¼ŒDown æˆ–è€…ç½‘ç»œä¸é€šã€‚ è¡¨è¾¾å¼ï¼š absent(up{job=\"kube-controller-manager\"} == 1) ","date":"2022-09-13","objectID":"/posts/adb863/:6:2","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"7. åº”ç”¨ç›¸å…³ ","date":"2022-09-13","objectID":"/posts/adb863/:7:0","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"7.1 KubePodCrashLooping Pod é‡å¯æ—¶é—´ï¼Œé‡å¯æ—¶é—´è¶…è¿‡3må‘Šè­¦ã€‚ è¡¨è¾¾å¼ï¼š rate(kube_pod_container_status_restarts_total{job=\"kube-state-metrics\"}[5m]) * 60 * 3 \u003e 0 ç›¸å…³æŒ‡æ ‡: kube_pod_container_status_restarts_totalï¼šé‡å¯çŠ¶æ€0ä¸ºæ­£å¸¸ ","date":"2022-09-13","objectID":"/posts/adb863/:7:1","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"7.2 KubePodNotReady Pods æ²¡æœ‰å°±ç»ªï¼Œæ£€æµ‹ Pod æ˜¯å¦å°±ç»ªã€‚ è¡¨è¾¾å¼ï¼š sum by (namespace, pod) (max by(namespace, pod) (kube_pod_status_phase{job=\"kube-state-metrics\", phase=~\"Pending|Unknown\"}) * on(namespace, pod) group_left(owner_kind) max by(namespace, pod, owner_kind) (kube_pod_owner{owner_kind!=\"Job\"})) \u003e 0 ç›¸å…³æŒ‡æ ‡ï¼š kube_pod_status_phaseï¼šPod çŠ¶æ€ ","date":"2022-09-13","objectID":"/posts/adb863/:7:2","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"7.3 KubeDeploymentGenerationMismatch Deployment éƒ¨ç½²å¤±è´¥ï¼ŒDeployment ç”Ÿæˆçš„èµ„æºä¸å®šä¹‰çš„èµ„æºä¸åŒ¹é…ã€‚ è¡¨è¾¾å¼ï¼š kube_deployment_status_observed_generation{job=\"kube-state-metrics\"} != kube_deployment_metadata_generation{job=\"kube-state-metrics\"} ç›¸å…³æŒ‡æ ‡ï¼š kube_deployment_status_observed_generationï¼šDeployment ç”Ÿæˆèµ„æºæ•° kube_deployment_metadata_generationï¼šDeployment å®šä¹‰èµ„æºæ•° ","date":"2022-09-13","objectID":"/posts/adb863/:7:3","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"7.4 KubeDeploymentReplicasMismatch æŸ¥çœ‹ Deplyment å‰¯æœ¬æ˜¯å¦è¾¾åˆ°é¢„æœŸã€‚ è¡¨è¾¾å¼ï¼š ( kube_deployment_spec_replicas{job=\"kube-state-metrics\"} != kube_deployment_status_replicas_available{job=\"kube-state-metrics\"} ) and ( changes(kube_deployment_status_replicas_updated{job=\"kube-state-metrics\"}[3m]) == 0 ) ç›¸å…³æŒ‡æ ‡ï¼š kube_deployment_spec_replicas èµ„æºå®šä¹‰å‰¯æœ¬æ•° kube_deployment_status_replicas_available æ­£åœ¨è¿è¡Œå‰¯æœ¬æ•° kube_deployment_status_replicas_updated æ›´æ–°çš„å‰¯æœ¬æ•° ","date":"2022-09-13","objectID":"/posts/adb863/:7:4","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"7.5 KubeStatefulSetReplicasMismatch ç›‘æµ‹ StatefulSet å‰¯æœ¬æ˜¯å¦è¾¾åˆ°é¢„æœŸã€‚ è¡¨è¾¾å¼ï¼š ( kube_statefulset_status_replicas_ready{job=\"kube-state-metrics\"} != kube_statefulset_status_replicas{job=\"kube-state-metrics\"} ) and ( changes(kube_statefulset_status_replicas_updated{job=\"kube-state-metrics\"}[5m]) == 0 ) ç›¸å…³æŒ‡æ ‡ï¼š kube_statefulset_status_replicas_readyï¼šå°±ç»ªå‰¯æœ¬æ•° kube_statefulset_status_replicasï¼šå½“å‰å‰¯æœ¬æ•° kube_statefulset_status_replicas_updatedï¼šæ›´æ–°çš„å‰¯æœ¬æ•° ","date":"2022-09-13","objectID":"/posts/adb863/:7:5","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"7.6 KubeStatefulSetUpdateNotRolledOut StatefulSet æ›´æ–°å¤±è´¥ä¸”æœªå›æ»šï¼Œå¯¹æ¯”ç‰ˆæœ¬å·å’Œå‰¯æœ¬æ•°ã€‚ è¡¨è¾¾å¼ï¼š max without (revision) ( kube_statefulset_status_current_revision{job=\"kube-state-metrics\"} unless kube_statefulset_status_update_revision{job=\"kube-state-metrics\"} ) * ( kube_statefulset_replicas{job=\"kube-state-metrics\"} != kube_statefulset_status_replicas_updated{job=\"kube-state-metrics\"} ) ç›¸å…³æŒ‡æ ‡ï¼š kube_statefulset_status_replicasï¼šæ¯ä¸ª StatefulSet çš„å‰¯æœ¬æ•°ã€‚ kube_statefulset_status_replicas_currentï¼šæ¯ä¸ª StatefulSet çš„å½“å‰å‰¯æœ¬æ•°ã€‚ kube_statefulset_status_replicas_readyï¼šæ¯ä¸ªStatefulSet çš„å°±ç»ªå‰¯æœ¬æ•°ã€‚ kube_statefulset_status_replicas_updatedï¼šæ¯ä¸ªStatefulSet çš„æ›´æ–°å‰¯æœ¬æ•°ã€‚ kube_statefulset_status_observed_generationï¼šStatefulSet æ§åˆ¶å™¨è§‚å¯Ÿåˆ°çš„ç”Ÿæˆã€‚ kube_statefulset_replicasï¼šStatefulSet æ‰€éœ€çš„å‰¯æœ¬æ•°ã€‚ kube_statefulset_metadata_generationï¼šè¡¨ç¤º StatefulSet æ‰€éœ€çŠ¶æ€çš„ç‰¹å®šç”Ÿæˆçš„åºåˆ—å·ã€‚ kube_statefulset_createdï¼šåˆ›å»ºæ—¶é—´æˆ³ã€‚ kube_statefulset_labelsï¼šKubernetes æ ‡ç­¾è½¬æ¢ä¸º Prometheus æ ‡ç­¾ã€‚ kube_statefulset_status_current_revisionï¼šæŒ‡ç¤ºç”¨äºæŒ‰é¡ºåº(0ï¼ŒcurrentReplicas)ç”Ÿæˆ Pod çš„StatefulSet çš„ç‰ˆæœ¬ã€‚ kube_statefulset_status_update_revisionï¼šæŒ‡ç¤ºç”¨äºæŒ‰é¡ºåº [replicas-updatedReplicasï¼Œreplicas] ç”Ÿæˆ Pod çš„ StatefulSet çš„ç‰ˆæœ¬ã€‚ ","date":"2022-09-13","objectID":"/posts/adb863/:7:6","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"7.7 KubeDaemonSetRolloutStuck ç›‘æµ‹ DaemonSet æ˜¯å¦å¤„äºå°±ç»ªçŠ¶æ€ã€‚ è¡¨è¾¾å¼ï¼š kube_daemonset_status_number_ready{job=\"kube-state-metrics\"} / kube_daemonset_status_desired_number_scheduled{job=\"kube-state-metrics\"} \u003c 1.00 ç›¸å…³æŒ‡æ ‡ï¼š kube_daemonset_status_number_readyï¼šå°±ç»ªçš„ DaemonSet kube_daemonset_status_desired_number_scheduledï¼šåº”è¯¥è°ƒåº¦çš„ DaemonSet æ•°é‡ ","date":"2022-09-13","objectID":"/posts/adb863/:7:7","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"7.8 KubeDaemonSetMisScheduled DaemonSet è¿è¡Œåœ¨ä¸è¯¥è¿è¡Œçš„èŠ‚ç‚¹ä¸Šé¢ã€‚ è¡¨è¾¾å¼ï¼š kube_daemonset_status_number_misscheduled{job=\"kube-state-metrics\"} \u003e 0 ç›¸å…³æŒ‡æ ‡ï¼š kube_daemonset_status_number_misscheduledï¼šè¿è¡Œåœ¨ä¸è¯¥è¿è¡Œçš„èŠ‚ç‚¹çŠ¶æ€ ","date":"2022-09-13","objectID":"/posts/adb863/:7:8","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"7.9 KubeContainerWaiting ç›‘æµ‹å“ªäº›å®¹å™¨æ˜¯åœ¨ç­‰å¾…çŠ¶æ€çš„ã€‚ è¡¨è¾¾å¼ï¼š sum by (namespace, pod, container) (kube_pod_container_status_waiting_reason{job=\"kube-state-metrics\"}) \u003e 0 ç›¸å…³æŒ‡æ ‡ï¼š kube_pod_container_status_waiting_reasonï¼šå®¹å™¨å£°æ˜å‘¨æœŸè¿‡ç¨‹ä¸­çš„çŠ¶æ€ï¼Œæ— è®ºæ˜¯åˆ›å»ºæˆåŠŸè¿˜æ˜¯å¤±è´¥éƒ½åº”è¯¥æ˜¯0ã€‚ ","date":"2022-09-13","objectID":"/posts/adb863/:7:9","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"8. èŠ‚ç‚¹ç›¸å…³ ","date":"2022-09-13","objectID":"/posts/adb863/:8:0","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"8.1 NodeClockNotSynchronising ä¸»æœºä¸æ—¶é—´æœåŠ¡å™¨å¤±è”ã€‚ è¡¨è¾¾å¼ï¼š min_over_time(node_timex_sync_status[5m]) == 0 ç›¸å…³æŒ‡æ ‡ï¼š node_timex_sync_statusï¼šåŒæ­¥çŠ¶æ€ã€‚ ","date":"2022-09-13","objectID":"/posts/adb863/:8:1","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"8.2 NodeClockSkewDetected æœ¬åœ°æ—¶é—´åç§»é‡ã€‚ è¡¨è¾¾å¼ï¼š (node_timex_offset_seconds \u003e 0.05 and deriv(node_timex_offset_seconds[5m]) \u003e= 0 ) or ( node_timex_offset_seconds \u003c -0.05 and deriv(node_timex_offset_seconds[5m]) \u003c= 0) ç›¸å…³æŒ‡æ ‡ï¼š node_timex_offset_secondsï¼šè¯¯å·® ","date":"2022-09-13","objectID":"/posts/adb863/:8:2","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"8.3 NodeHighNumberConntrackEntriesUsed é“¾æ¥çŠ¶æ€è·Ÿè¸ªã€‚ è¡¨è¾¾å¼ï¼š (node_nf_conntrack_entries / node_nf_conntrack_entries_limit) \u003e 0.75 ç›¸å…³æŒ‡æ ‡ï¼š node_nf_conntrack_entriesï¼šé“¾æ¥çŠ¶æ€è·Ÿè¸ªè¡¨åˆ†é…çš„æ•°é‡ node_nf_conntrack_entries_limitï¼šè¡¨æ€»é‡ ","date":"2022-09-13","objectID":"/posts/adb863/:8:3","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"8.4 NodeNetworkReceiveErrs ç½‘å¡æ¥æ”¶é”™è¯¯é‡ã€‚ è¡¨è¾¾å¼ï¼š increase(node_network_receive_errs_total[2m]) \u003e 10 ç›¸å…³æŒ‡æ ‡ï¼š node_network_receive_errs_totalï¼šæ¥æ”¶é”™è¯¯æ€»é‡ ","date":"2022-09-13","objectID":"/posts/adb863/:8:4","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"8.5 NodeNetworkTransmitErrs ç½‘å¡ä¼ è¾“é”™è¯¯é‡ã€‚ è¡¨è¾¾å¼ï¼š increase(node_network_transmit_errs_total[2m]) \u003e 10 ç›¸å…³æŒ‡æ ‡ï¼š node_network_transmit_errs_totalï¼šä¼ è¾“é”™è¯¯æ€»é‡ ","date":"2022-09-13","objectID":"/posts/adb863/:8:5","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"8.6 NodeFilesystemAlmostOutOfFiles inode æ•°é‡ç›‘æµ‹ è¡¨è¾¾å¼ï¼š ( node_filesystem_files_free{job=\"node-exporter\",fstype!=\"\"} / node_filesystem_files{job=\"node-exporter\",fstype!=\"\"} * 100 \u003c 5 and node_filesystem_readonly{job=\"node-exporter\",fstype!=\"\"} == 0 ) ç›¸å…³æŒ‡æ ‡ï¼š node_filesystem_files_freeï¼šç©ºé—²çš„ inode node_filesystem_filesï¼šinodes æ€»é‡ ","date":"2022-09-13","objectID":"/posts/adb863/:8:6","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"8.7 NodeFilesystemFilesFillingUp inode è€—å°½é¢„æµ‹ï¼Œä»¥6å°æ—¶æ›²çº¿å˜åŒ–é¢„æµ‹æ¥ä¸‹æ¥24å°æ—¶å’Œ4å°æ—¶å¯èƒ½ä½¿ç”¨çš„ inodesã€‚ è¡¨è¾¾å¼ï¼š (node_filesystem_files_free{job=\"node-exporter\",fstype!=\"\"} / node_filesystem_files{job=\"node-exporter\",fstype!=\"\"} * 100 \u003c 20 and predict_linear(node_filesystem_files_free{job=\"node-exporter\",fstype!=\"\"}[6h], 4*60*60) \u003c 0 and node_filesystem_readonly{job=\"node-exporter\",fstype!=\"\"} == 0) ç›¸å…³æŒ‡æ ‡ï¼š node_filesystem_files_freeï¼šç©ºé—²çš„ inode node_filesystem_filesï¼šinodes æ€»é‡ ","date":"2022-09-13","objectID":"/posts/adb863/:8:7","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"8.8 NodeFilesystemAlmostOutOfSpace åˆ†åŒºå®¹é‡ä½¿ç”¨ç‡ã€‚ è¡¨è¾¾å¼ï¼š (node_filesystem_avail_bytes{job=\"node-exporter\",fstype!=\"\"} / node_filesystem_size_bytes{job=\"node-exporter\",fstype!=\"\"} * 100 \u003c 10 and node_filesystem_readonly{job=\"node-exporter\",fstype!=\"\"} == 0 ) ç›¸å…³æŒ‡æ ‡ï¼š node_filesystem_avail_bytesï¼šç©ºé—²å®¹é‡ node_filesystem_size_bytesï¼šæ€»å®¹é‡ ","date":"2022-09-13","objectID":"/posts/adb863/:8:8","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"8.9 NodeFilesystemSpaceFillingUp åˆ†åŒºå®¹é‡è€—å°½é¢„æµ‹ï¼Œä»¥6å°æ—¶æ›²çº¿å˜åŒ–é¢„æµ‹æ¥ä¸‹æ¥24å°æ—¶å’Œ4å°æ—¶å¯èƒ½ä½¿ç”¨çš„å®¹é‡ã€‚ è¡¨è¾¾å¼ï¼š (node_filesystem_avail_bytes{job=\"node-exporter\",fstype!=\"\"} / node_filesystem_size_bytes{job=\"node-exporter\",fstype!=\"\"} * 100 \u003c 15 and predict_linear(node_filesystem_avail_bytes{job=\"node-exporter\",fstype!=\"\"}[6h], 4*60*60) \u003c 0 and node_filesystem_readonly{job=\"node-exporter\",fstype!=\"\"} == 0) ç›¸å…³æŒ‡æ ‡ï¼š node_filesystem_avail_bytesï¼šç©ºé—²å®¹é‡ node_filesystem_size_bytesï¼šæ€»å®¹é‡ ","date":"2022-09-13","objectID":"/posts/adb863/:8:9","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"9. Etcd ç›¸å…³ ","date":"2022-09-13","objectID":"/posts/adb863/:9:0","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"9.1 Etcdlived etcd å­˜æ´»æ£€æµ‹ã€‚ è¡¨è¾¾å¼ï¼š up{job=\"etcd\"} \u003c 1 ","date":"2022-09-13","objectID":"/posts/adb863/:9:1","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"9.2 EtcdCluseterUnavailable etcd é›†ç¾¤å¥åº·æ£€æŸ¥ï¼Œdown æ•°é‡å¤§äºé›†ç¾¤å¯å…è®¸æ•…éšœæ•°é‡ã€‚ è¡¨è¾¾å¼ï¼š count(up{job=\"etcd\"} == 0) \u003e (count(up{job=\"etcd\"}) / 2 - 1) ","date":"2022-09-13","objectID":"/posts/adb863/:9:2","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"9.3 EtcdLeaderCheck æ£€æŸ¥ leaderã€‚ è¡¨è¾¾å¼ï¼š max(etcd_server_has_leader) != 1 ","date":"2022-09-13","objectID":"/posts/adb863/:9:3","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"9.4 EtcdBackendFsync etcd io ç›‘æµ‹ï¼Œåç«¯æäº¤ å»¶æ—¶ã€‚ è¡¨è¾¾å¼ï¼š histogram_quantile(0.99, sum(rate(etcd_disk_backend_commit_duration_seconds_bucket[5m])) by (instance, le)) \u003e 100 ","date":"2022-09-13","objectID":"/posts/adb863/:9:4","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"9.5 EtcdWalFsync etcd io ç›‘æµ‹ï¼Œæ–‡ä»¶åŒæ­¥åˆ°ç£ç›˜å»¶æ—¶ã€‚ è¡¨è¾¾å¼ï¼š histogram_quantile(0.99, sum(rate(etcd_disk_wal_fsync_duration_seconds_bucket[5m])) by (instance, le)) \u003e 100 ","date":"2022-09-13","objectID":"/posts/adb863/:9:5","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"9.6 EtcdDbSize æ£€æµ‹æ•°æ®åº“å¤§å°ã€‚ è¡¨è¾¾å¼ï¼š etcd_debugging_mvcc_db_total_size_in_bytes/1024/1024 \u003e 1024 ","date":"2022-09-13","objectID":"/posts/adb863/:9:6","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"9.7 EtcdGrpc Grpc è°ƒç”¨é€Ÿç‡ã€‚è¡¨è¾¾å¼ï¼š sum(rate(grpc_server_handled_total{grpc_type=\"unary\"}[1m])) \u003e 100 ","date":"2022-09-13","objectID":"/posts/adb863/:9:7","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"10. CoreDNS ç›¸å…³ ","date":"2022-09-13","objectID":"/posts/adb863/:10:0","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"10.1 DnsRequest DNS æŸ¥è¯¢é€Ÿç‡ï¼Œæ¯åˆ†é’ŸæŸ¥è¯¢è¶…è¿‡100å‘Šè­¦ã€‚ è¡¨è¾¾å¼ï¼š sum(irate(coredns_dns_request_count_total{zone !=\"dropped\"}[1m])) \u003e 100 ç›¸å…³æŒ‡æ ‡ï¼š coredns_dns_request_count_totalï¼šæ€»æŸ¥è¯¢æ•° ","date":"2022-09-13","objectID":"/posts/adb863/:10:1","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"10.2 DnsRequestFaild å¼‚å¸¸æŸ¥è¯¢ï¼Œå¼‚å¸¸çŠ¶æ€ç ï¼Œä¸æ˜¯ NOERRORã€‚ è¡¨è¾¾å¼ï¼š irate(coredns_dns_response_rcode_count_total{rcode!=\"NOERROR\"} [1m]) \u003e 0 ç›¸å…³æŒ‡æ ‡ï¼š coredns_dns_response_rcode_count_totalï¼šæŸ¥è¯¢è¿”å›çŠ¶æ€ç  DNS-Rcodeï¼š DNS-Rcode ä½œä¸º DNS åº”ç­”æŠ¥æ–‡ä¸­æœ‰æ•ˆçš„å­—æ®µï¼Œä¸»è¦ç”¨æ¥è¯´æ˜ DNS åº”ç­”çŠ¶æ€ï¼Œæ˜¯æ’æŸ¥åŸŸåè§£æå¤±è´¥çš„é‡è¦æŒ‡æ ‡ã€‚é€šå¸¸å¸¸è§çš„ Rcode å€¼å¦‚ä¸‹ï¼š Rcode å€¼ä¸º0ï¼Œå¯¹åº”çš„ DNS åº”ç­”çŠ¶æ€ä¸º NOERRORï¼Œæ„æ€æ˜¯æˆåŠŸçš„å“åº”ï¼Œå³è¿™ä¸ªåŸŸåè§£ææ˜¯æˆåŠŸ Rcode å€¼ä¸º2ï¼Œå¯¹åº”çš„ DNS åº”ç­”çŠ¶æ€ä¸º SERVFAILï¼Œæ„æ€æ˜¯æœåŠ¡å™¨å¤±è´¥ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªåŸŸåçš„æƒå¨æœåŠ¡å™¨æ‹’ç»å“åº”æˆ–è€…å“åº” REFUSEï¼Œé€’å½’æœåŠ¡å™¨è¿”å› Rcode å€¼ä¸º 2 ç»™ CLIENT Rcode å€¼ä¸º3ï¼Œå¯¹åº”çš„ DNS åº”ç­”çŠ¶æ€ä¸º NXDOMAINï¼Œæ„æ€æ˜¯ä¸å­˜åœ¨çš„è®°å½•ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªå…·ä½“çš„åŸŸååœ¨æƒå¨æœåŠ¡å™¨ä¸­å¹¶ä¸å­˜åœ¨ Rcode å€¼ä¸º5ï¼Œå¯¹åº”çš„ DNS åº”ç­”çŠ¶æ€ä¸º REFUSEï¼Œæ„æ€æ˜¯æ‹’ç»ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªè¯·æ±‚æºIPä¸åœ¨æœåŠ¡çš„èŒƒå›´å†… ","date":"2022-09-13","objectID":"/posts/adb863/:10:2","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"10.3 DnsPanic DNS ææ…Œå€¼ï¼Œå¯èƒ½æ”¶åˆ°æ”»å‡»ã€‚ è¡¨è¾¾å¼ï¼š irate(coredns_panic_count_total[1m]) \u003e 100 ","date":"2022-09-13","objectID":"/posts/adb863/:10:3","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"å‚è€ƒé“¾æ¥ https://my.oschina.net/54188zz/blog/4305978 https://github.com/coreos/kube-prometheus https://github.com/kubernetes-monitoring/kubernetes-mixin ","date":"2022-09-13","objectID":"/posts/adb863/:11:0","tags":["prometheus","monitor"],"title":"Prometheus Operator å¸¸ç”¨æŒ‡æ ‡","uri":"/posts/adb863/"},{"categories":["äº‘åŸç”Ÿ"],"content":"Istio æŒ‡æ ‡ ","date":"2022-09-13","objectID":"/posts/6899d1/:0:0","tags":["istio","è½¬è½½"],"title":"Istioæ€§èƒ½æŒ‡æ ‡","uri":"/posts/6899d1/"},{"categories":["äº‘åŸç”Ÿ"],"content":"Istio è‡ªå·±çš„ Metrics ","date":"2022-09-13","objectID":"/posts/6899d1/:1:0","tags":["istio","è½¬è½½"],"title":"Istioæ€§èƒ½æŒ‡æ ‡","uri":"/posts/6899d1/"},{"categories":["äº‘åŸç”Ÿ"],"content":"æ ‡å‡†æŒ‡æ ‡è¯´æ˜ å‚è€ƒï¼šhttps://istio.io/latest/docs/reference/config/metrics/ Metrics å¯¹äº HTTPã€HTTP/2 å’Œ GRPC æµé‡ï¼ŒIstio é»˜è®¤ç”Ÿæˆä»¥ä¸‹æŒ‡æ ‡ï¼š Request Count (istio_requests_total): This is a COUNTER incremented for every request handled by an Istio proxy. Request Duration (istio_request_duration_milliseconds): This is a DISTRIBUTION which measures the duration of requests. Request Size (istio_request_bytes): This is a DISTRIBUTION which measures HTTP request body sizes. Response Size (istio_response_bytes): This is a DISTRIBUTION which measures HTTP response body sizes. gRPC Request Message Count (istio_request_messages_total): This is a COUNTER incremented for every gRPC message sent from a client. gRPC Response Message Count (istio_response_messages_total): This is a COUNTER incremented for every gRPC message sent from a server. å¯¹äº TCP æµé‡ï¼ŒIstio ç”Ÿæˆä»¥ä¸‹æŒ‡æ ‡ï¼š Tcp Bytes Sent (istio_tcp_sent_bytes_total): This is a COUNTER which measures the size of total bytes sent during response in case of a TCP connection. Tcp Bytes Received (istio_tcp_received_bytes_total): This is a COUNTER which measures the size of total bytes received during request in case of a TCP connection. Tcp Connections Opened (istio_tcp_connections_opened_total): This is a COUNTER incremented for every opened connection. Tcp Connections Closed (istio_tcp_connections_closed_total): This is a COUNTER incremented for every closed connection. Prometheus çš„ Labels Reporter: This identifies the reporter of the request. It is set to destination if report is from a server Istio proxy and source if report is from a client Istio proxy or a gateway. Source Workload: This identifies the name of source workload which controls the source, or â€œunknownâ€ if the source information is missing. Source Workload Namespace: This identifies the namespace of the source workload, or â€œunknownâ€ if the source information is missing. Source Principal: This identifies the peer principal of the traffic source. It is set when peer authentication is used. Source App: This identifies the source application based on app label of the source workload, or â€œunknownâ€ if the source information is missing. Source Version: This identifies the version of the source workload, or â€œunknownâ€ if the source information is missing. Destination Workload: This identifies the name of destination workload, or â€œunknownâ€ if the destination information is missing. Destination Workload Namespace: This identifies the namespace of the destination workload, or â€œunknownâ€ if the destination information is missing. Destination Principal: This identifies the peer principal of the traffic destination. It is set when peer authentication is used. Destination App: This identifies the destination application based on app label of the destination workload, or â€œunknownâ€ if the destination information is missing. Destination Version: This identifies the version of the destination workload, or â€œunknownâ€ if the destination information is missing. Destination Service: This identifies destination service host responsible for an incoming request. Ex: details.default.svc.cluster.local. Destination Service Name: This identifies the destination service name. Ex: â€œdetailsâ€. Destination Service Namespace: This identifies the namespace of destination service. Request Protocol: This identifies the protocol of the request. It is set to request or connection protocol. Response Code: This identifies the response code of the request. This label is present only on HTTP metrics. Connection Security Policy: This identifies the service authentication policy of the request. It is set to mutual_tls when Istio is used to make communication secure and report is from destination. It is set to unknown when report is from source since security policy cannot be properly populated. Response Flags: Additional details about the response or connection from proxy. In case of Envoy, see %RESPONSE_FLAGS% in Envoy Access Log for more detail. Canonical Service: A workload belongs to exactly one canonical s","date":"2022-09-13","objectID":"/posts/6899d1/:1:1","tags":["istio","è½¬è½½"],"title":"Istioæ€§èƒ½æŒ‡æ ‡","uri":"/posts/6899d1/"},{"categories":["äº‘åŸç”Ÿ"],"content":"ä½¿ç”¨ istio-proxy ä¸åº”ç”¨çš„ Metrics æ•´åˆè¾“å‡º å‚è€ƒï¼šhttps://istio.io/v1.14/docs/ops/integrations/prometheus/#option-1-metrics-merging Istio èƒ½å¤Ÿå®Œå…¨é€šè¿‡ prometheus.io annotations æ¥æ§åˆ¶æŠ“å–ã€‚è™½ç„¶ prometheus.io annotations ä¸æ˜¯ Prometheus çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œä½†å®ƒä»¬å·²æˆä¸ºé…ç½®æŠ“å–çš„äº‹å®æ ‡å‡†ã€‚ æ­¤é€‰é¡¹é»˜è®¤å¯ç”¨ï¼Œä½†å¯ä»¥é€šè¿‡åœ¨ å®‰è£… æœŸé—´ä¼ é€’ --set meshConfig.enablePrometheusMerge=false æ¥ç¦ç”¨ã€‚å¯ç”¨åï¼Œå°†å‘æ‰€æœ‰æ•°æ®å¹³é¢ pod æ·»åŠ é€‚å½“çš„ prometheus.io annotations ä»¥è®¾ç½®æŠ“å–ã€‚å¦‚æœè¿™äº›æ³¨é‡Šå·²ç»å­˜åœ¨ï¼Œå®ƒä»¬å°†è¢«è¦†ç›–ã€‚ä½¿ç”¨æ­¤é€‰é¡¹ï¼ŒEnvoy sidecar ä¼šå°† Istio çš„æŒ‡æ ‡ä¸åº”ç”¨ç¨‹åºæŒ‡æ ‡åˆå¹¶ã€‚åˆå¹¶åçš„æŒ‡æ ‡å°†ä» /stats/prometheus:15020 ä¸­æŠ“å–ã€‚ æ­¤é€‰é¡¹ä»¥æ˜æ–‡å½¢å¼å…¬å¼€æ‰€æœ‰æŒ‡æ ‡ã€‚ å®šåˆ¶ï¼šä¸º Metrics å¢åŠ ç»´åº¦ å‚è€ƒï¼š https://istio.io/latest/docs/tasks/observability/metrics/customize-metrics/#custom-statistics-configuration å¦‚ï¼Œå¢åŠ ç«¯å£ã€ä¸ HTTP HOST å¤´ ç»´åº¦ã€‚ apiVersion: install.istio.io/v1alpha1 kind: IstioOperator spec: values: telemetry: v2: prometheus: configOverride: inboundSidecar: metrics: - name: requests_total dimensions: destination_port: string(destination.port) request_host: request.host outboundSidecar: metrics: - name: requests_total dimensions: destination_port: string(destination.port) request_host: request.host gateway: metrics: - name: requests_total dimensions: destination_port: string(destination.port) request_host: request.host ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å°†ä»¥ä¸‹ annotation åº”ç”¨åˆ°æ‰€æœ‰æ³¨å…¥çš„ podï¼Œå…¶ä¸­åŒ…å«è¦æå–åˆ° Prometheus æ—¶é—´åºåˆ— çš„ç»´åº¦åˆ—è¡¨ï¼š ä»…å½“æ‚¨çš„ç»´åº¦ä¸åœ¨ [DefaultStatTags åˆ—è¡¨] ä¸­æ—¶æ‰éœ€è¦æ­¤æ­¥éª¤ï¼ˆhttps://github.com/istio/istio/blob/release-1.14/pkg/bootstrap/config.goï¼‰ apiVersion: apps/v1 kind: Deployment spec: template: # pod template metadata: annotations: sidecar.istio.io/extraStatTags: destination_port,request_host è¦åœ¨ç½‘æ ¼èŒƒå›´å†…å¯ç”¨é¢å¤– Tag ï¼Œæ‚¨å¯ä»¥å°† extraStatTags æ·»åŠ åˆ°ç½‘æ ¼é…ç½®ä¸­ï¼š meshConfig: defaultConfig: extraStatTags: - destination_port - request_host å‚è€ƒ : https://istio.io/latest/docs/reference/config/proxy_extensions/stats/#MetricConfig å®šåˆ¶ï¼šåŠ å…¥ request / response å…ƒä¿¡æ¯ç»´åº¦ å¯ä»¥æŠŠ request æˆ– repsonse é‡Œä¸€äº›åŸºç¡€ä¿¡æ¯ åŠ å…¥åˆ° æŒ‡æ ‡çš„ç»´åº¦ã€‚å¦‚ï¼ŒURL Pathï¼Œè¿™åœ¨éœ€è¦ä¸ºç›¸åŒæœåŠ¡åˆ†éš”ç»Ÿè®¡ä¸åŒ REST API çš„æŒ‡æ ‡æ—¶ï¼Œç›¸å½“æœ‰ç”¨ã€‚ å‚è€ƒ : https://istio.io/latest/docs/tasks/observability/metrics/classify-metrics/ ","date":"2022-09-13","objectID":"/posts/6899d1/:1:2","tags":["istio","è½¬è½½"],"title":"Istioæ€§èƒ½æŒ‡æ ‡","uri":"/posts/6899d1/"},{"categories":["äº‘åŸç”Ÿ"],"content":"å·¥ä½œåŸç† istio stat filter ä½¿ç”¨ Istio åœ¨è‡ªå·±çš„å®šåˆ¶ç‰ˆæœ¬ Envoy ä¸­ï¼ŒåŠ å…¥äº† stats-filter æ’ä»¶ï¼Œç”¨äºè®¡ç®— Istio è‡ªå·±æƒ³è¦çš„æŒ‡æ ‡ï¼š $ k -n istio-system get envoyfilters.networking.istio.io stats-filter-1.14 -o yaml apiVersion: networking.istio.io/v1alpha3 kind: EnvoyFilter metadata: annotations: labels: install.operator.istio.io/owning-resource-namespace: istio-system istio.io/rev: default operator.istio.io/component: Pilot operator.istio.io/version: 1.14.3 name: stats-filter-1.14 namespace: istio-system spec: configPatches: - applyTo: HTTP_FILTER match: context: SIDECAR_OUTBOUND listener: filterChain: filter: name: envoy.filters.network.http_connection_manager subFilter: name: envoy.filters.http.router proxy: proxyVersion: ^1\\.14.* patch: operation: INSERT_BEFORE value: name: istio.stats typed_config: '@type': type.googleapis.com/udpa.type.v1.TypedStruct type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm value: config: configuration: '@type': type.googleapis.com/google.protobuf.StringValue value: | { \"debug\": \"false\", \"stat_prefix\": \"istio\" } root_id: stats_outbound vm_config: code: local: inline_string: envoy.wasm.stats runtime: envoy.wasm.runtime.null vm_id: stats_outbound - applyTo: HTTP_FILTER match: context: SIDECAR_INBOUND listener: filterChain: filter: name: envoy.filters.network.http_connection_manager subFilter: name: envoy.filters.http.router proxy: proxyVersion: ^1\\.14.* patch: operation: INSERT_BEFORE value: name: istio.stats typed_config: '@type': type.googleapis.com/udpa.type.v1.TypedStruct type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm value: config: configuration: '@type': type.googleapis.com/google.protobuf.StringValue value: | { \"debug\": \"false\", \"stat_prefix\": \"istio\", \"disable_host_header_fallback\": true, \"metrics\": [ { \"dimensions\": { \"destination_cluster\": \"node.metadata['CLUSTER_ID']\", \"source_cluster\": \"downstream_peer.cluster_id\" } } ] } root_id: stats_inbound vm_config: code: local: inline_string: envoy.wasm.stats runtime: envoy.wasm.runtime.null vm_id: stats_inbound - applyTo: HTTP_FILTER match: context: GATEWAY listener: filterChain: filter: name: envoy.filters.network.http_connection_manager subFilter: name: envoy.filters.http.router proxy: proxyVersion: ^1\\.14.* patch: operation: INSERT_BEFORE value: name: istio.stats typed_config: '@type': type.googleapis.com/udpa.type.v1.TypedStruct type_url: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm value: config: configuration: '@type': type.googleapis.com/google.protobuf.StringValue value: | { \"debug\": \"false\", \"stat_prefix\": \"istio\", \"disable_host_header_fallback\": true } root_id: stats_outbound vm_config: code: local: inline_string: envoy.wasm.stats runtime: envoy.wasm.runtime.null vm_id: stats_outbound priority: -1 istio stat Plugin å®ç° https://github.com/istio/proxy/blob/release-1.14/extensions/stats/plugin.cc å†…ç½®çš„ Metric: const std::vector\u003cMetricFactory\u003e\u0026 PluginRootContext::defaultMetrics() { static const std::vector\u003cMetricFactory\u003e default_metrics = { // HTTP, HTTP/2, and GRPC metrics MetricFactory{\"requests_total\", MetricType::Counter, [](::Wasm::Common::RequestInfo\u0026) -\u003e uint64_t { return 1; }, static_cast\u003cuint32_t\u003e(Protocol::HTTP) | static_cast\u003cuint32_t\u003e(Protocol::GRPC), count_standard_labels, /* recurrent */ false}, MetricFactory{\"request_duration_milliseconds\", MetricType::Histogram, [](::Wasm::Common::RequestInfo\u0026 request_info) -\u003e uint64_t { return request_info.duration /* in nanoseconds */ / 1000000; }, static_cast\u003cuint32_t\u003e(Protocol::HTTP) | static_cast\u003cuint32_t\u003e(Protocol::GRPC), count_standard_labels, /* recurrent */ false}, MetricFactory{\"request_bytes\", MetricType::Histogram, [](::Wasm::Common::RequestInfo\u0026 request_info) -\u003e uint64_t { return request_info.request_size; }, static_cast\u003cuint32_t\u003e(Protocol::HTTP) | static_cast\u003cuint32_t\u003e(Protocol::GRPC), count_standard_labels, /* recurrent */ false}, MetricFactory{\"response_bytes\", MetricType::Histogram, [](::Wasm::Common::RequestInfo\u0026 request_info) -\u003e uint64_t { return reque","date":"2022-09-13","objectID":"/posts/6899d1/:1:3","tags":["istio","è½¬è½½"],"title":"Istioæ€§èƒ½æŒ‡æ ‡","uri":"/posts/6899d1/"},{"categories":["äº‘åŸç”Ÿ"],"content":"Envoy å†…ç½®çš„ Metrics Istio é»˜è®¤ç”¨ istio-agent å»æ•´åˆ Envoy çš„ metricsã€‚ è€Œ Istio é»˜è®¤æ‰“å¼€çš„ Envoy å†…ç½® Metrics å¾ˆå°‘ï¼š è§ï¼šhttps://istio.io/latest/docs/ops/configuration/telemetry/envoy-stats/ cluster_manager listener_manager server cluster.xds-grpc ","date":"2022-09-13","objectID":"/posts/6899d1/:2:0","tags":["istio","è½¬è½½"],"title":"Istioæ€§èƒ½æŒ‡æ ‡","uri":"/posts/6899d1/"},{"categories":["äº‘åŸç”Ÿ"],"content":"å®šåˆ¶ Envoy å†…ç½®çš„ Metrics å‚è€ƒï¼šhttps://istio.io/latest/docs/ops/configuration/telemetry/envoy-stats/ å¦‚æœè¦é…ç½® Istio Proxy ä»¥è®°å½• å…¶å®ƒ Envoy åŸç”Ÿçš„æŒ‡æ ‡ï¼Œæ‚¨å¯ä»¥å°† ProxyConfig.ProxyStatsMatcher æ·»åŠ åˆ°ç½‘æ ¼é…ç½®ä¸­ã€‚ ä¾‹å¦‚ï¼Œè¦å…¨å±€å¯ç”¨æ–­è·¯å™¨ã€é‡è¯•å’Œä¸Šæ¸¸è¿æ¥çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œæ‚¨å¯ä»¥æŒ‡å®š stats matcherï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š ä»£ç†éœ€è¦é‡æ–°å¯åŠ¨ä»¥è·å–ç»Ÿè®¡åŒ¹é…å™¨é…ç½®ã€‚ apiVersion: install.istio.io/v1alpha1 kind: IstioOperator spec: meshConfig: defaultConfig: proxyStatsMatcher: inclusionRegexps: - \".*circuit_breakers.*\" inclusionPrefixes: - \"upstream_rq_retry\" - \"upstream_cx\" æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ proxy.istio.io/config annotation ä¸ºä¸ªåˆ«ä»£ç æŒ‡å®šé…ç½®ã€‚ ä¾‹å¦‚ï¼Œè¦é…ç½®ä¸ä¸Šé¢ç›¸åŒçš„ç»Ÿè®¡ä¿¡æ¯ï¼Œæ‚¨å¯ä»¥å°† annotation æ·»åŠ åˆ° gateway proxy æˆ– workloadï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š metadata: annotations: proxy.istio.io/config: |- proxyStatsMatcher: inclusionRegexps: - \".*circuit_breakers.*\" inclusionPrefixes: - \"upstream_rq_retry\" - \"upstream_cx\" ","date":"2022-09-13","objectID":"/posts/6899d1/:2:1","tags":["istio","è½¬è½½"],"title":"Istioæ€§èƒ½æŒ‡æ ‡","uri":"/posts/6899d1/"},{"categories":["äº‘åŸç”Ÿ"],"content":"åŸç† ä¸‹é¢ï¼Œçœ‹çœ‹ Istio é»˜è®¤é…ç½®ä¸‹ï¼Œå¦‚ä½•é…ç½® Envoyã€‚ istioctl proxy-config bootstrap fortio-server | yq eval -P \u003e envoy-config-bootstrap-default.yaml è¾“å‡ºï¼š bootstrap: ... statsConfig: statsTags: # ä»æŒ‡æ ‡åä¸­æŠ“å– Tag(prometheus label) - tagName: cluster_name regex: ^cluster\\.((.+?(\\..+?\\.svc\\.cluster\\.local)?)\\.) - tagName: tcp_prefix regex: ^tcp\\.((.*?)\\.)\\w+?$ - tagName: response_code regex: (response_code=\\.=(.+?);\\.;)|_rq(_(\\.d{3}))$ - tagName: response_code_class regex: _rq(_(\\dxx))$ - tagName: http_conn_manager_listener_prefix regex: ^listener(?=\\.).*?\\.http\\.(((?:[_.[:digit:]]*|[_\\[\\]aAbBcCdDeEfF[:digit:]]*))\\.) ... useAllDefaultTags: false statsMatcher: inclusionList: patterns: # é€‰æ‹©è¦è®°å½•çš„æŒ‡æ ‡ - prefix: reporter= - prefix: cluster_manager - prefix: listener_manager - prefix: server - prefix: cluster.xds-grpc ## åªè®°å½• xDS cluster. å³ä¸è®°å½•ç”¨æˆ·è‡ªå·±æœåŠ¡çš„ cluster !!! - prefix: wasm - suffix: rbac.allowed - suffix: rbac.denied - suffix: shadow_allowed - suffix: shadow_denied - prefix: component è¿™æ—¶ï¼Œå¦‚æœä¿®æ”¹ pod çš„å®šä¹‰ä¸ºï¼š annotations: proxy.istio.io/config: |- proxyStatsMatcher: inclusionRegexps: - \"cluster\\\\..*fortio.*\" #proxy upstream(outbound) - \"cluster\\\\..*inbound.*\" #proxy upstream(inboundï¼Œè¿™é‡Œä¸€èˆ¬å°±æ˜¯æŒ‡åˆ°åŒä¸€ pod ä¸­è¿è¡Œçš„åº”ç”¨äº†) - \"http\\\\..*\" - \"listener\\\\..*\" äº§ç”Ÿæ–°çš„ Envoy é…ç½®ï¼š \"stats_matcher\": { \"inclusion_list\": { \"patterns\": [ { \"prefix\": \"reporter=\" }, { \"prefix\": \"cluster_manager\" }, { \"prefix\": \"listener_manager\" }, { \"prefix\": \"server\" }, { \"prefix\": \"cluster.xds-grpc\" }, { \"safe_regex\": { \"google_re2\": {}, \"regex\": \"cluster\\\\..*fortio.*\" } }, { \"safe_regex\": { \"google_re2\": {}, \"regex\": \"cluster\\\\..*inbound.*\" } }, { \"safe_regex\": { \"google_re2\": {}, \"regex\": \"http\\\\..*\" } }, { \"safe_regex\": { \"google_re2\": {}, \"regex\": \"listener\\\\..*\" } }, ","date":"2022-09-13","objectID":"/posts/6899d1/:2:2","tags":["istio","è½¬è½½"],"title":"Istioæ€§èƒ½æŒ‡æ ‡","uri":"/posts/6899d1/"},{"categories":["äº‘åŸç”Ÿ"],"content":"æ€»ç»“ï¼šIstio-Proxy æŒ‡æ ‡åœ°å›¾ è¦åšå¥½ç›‘æ§ï¼Œé¦–å…ˆè¦æ·±å…¥äº†è§£æŒ‡æ ‡åŸç†ã€‚è€Œè¦äº†è§£æŒ‡æ ‡åŸç†ï¼Œå½“ç„¶è¦çŸ¥é“æŒ‡æ ‡æ˜¯äº§ç”Ÿæµç¨‹ä¸­çš„ä»€ä¹ˆä½ç½®ï¼Œä»€ä¹ˆç»„ä»¶ã€‚çœ‹å®Œä¸Šé¢å…³äº Envoy ä¸ Istio çš„æŒ‡æ ‡è¯´æ˜åã€‚å¯ä»¥å¤§æ¦‚å¾—åˆ°ä»¥ä¸‹ç»“è®ºï¼š æœ¬èŠ‚çš„å®éªŒç¯å¢ƒè¯´æ˜è§äºï¼š {ref}`appendix-lab-env/appendix-lab-env-base:ç®€å•åˆ†å±‚å®éªŒç¯å¢ƒ` æœ¬æ–‡å‡ºè‡ªhttps://istio-insider.readthedocs.io/ ","date":"2022-09-13","objectID":"/posts/6899d1/:3:0","tags":["istio","è½¬è½½"],"title":"Istioæ€§èƒ½æŒ‡æ ‡","uri":"/posts/6899d1/"},{"categories":["äº‘åŸç”Ÿ"],"content":"Envoy æŒ‡æ ‡ ","date":"2022-09-13","objectID":"/posts/0affe7/:0:0","tags":["istio","envoy","è½¬è½½"],"title":"Envoyæ€§èƒ½æŒ‡æ ‡","uri":"/posts/0affe7/"},{"categories":["äº‘åŸç”Ÿ"],"content":"Envoy æŒ‡æ ‡æ¦‚è¿° Envoy çš„ä¸»è¦ç›®æ ‡ä¹‹ä¸€æ˜¯ä½¿ç½‘ç»œæ˜“äºç†è§£ã€‚ Envoy ä¼šæ ¹æ®å…¶é…ç½®æ–¹å¼äº§ç”Ÿå¤§é‡ç»Ÿè®¡ä¿¡æ¯ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œç»Ÿè®¡æ•°æ®(æŒ‡æ ‡)åˆ†ä¸ºä¸‰ç±»ï¼š Downstreamï¼šDownstream æŒ‡æ ‡ä¸å¤–æ¥çš„è¿æ¥/è¯·æ±‚æœ‰å…³ã€‚å®ƒä»¬ç”± listenerã€HTTP connection manager(HCM)ã€TCP proxy filter ç­‰äº§ç”Ÿã€‚ Upstreamï¼šUpstream æŒ‡æ ‡ä¸å¤–å‘çš„è¿æ¥/è¯·æ±‚æœ‰å…³ã€‚å®ƒä»¬ç”± connection poolã€router filterã€tcp proxy filterç­‰äº§ç”Ÿã€‚ Serverï¼šServer æŒ‡æ ‡ä¿¡æ¯æè¿° Envoy æœåŠ¡å™¨å®ä¾‹çš„è¿ä½œæƒ…å†µã€‚æœåŠ¡å™¨æ­£å¸¸è¿è¡Œæ—¶é—´æˆ–åˆ†é…çš„å†…å­˜é‡ç­‰ç»Ÿè®¡ä¿¡æ¯ã€‚ åœ¨æœ€ç®€å•åœºæ™¯ä¸‹ï¼Œå•ä¸ª Envoy Proxy é€šå¸¸æ¶‰åŠ Downstream å’Œ Upstream ç»Ÿè®¡æ•°æ®ã€‚è¿™ä¸¤ç§æŒ‡æ ‡åæ˜ äº†å–è¯¥ ç½‘ç»œèŠ‚ç‚¹ çš„è¿è¡Œæƒ…å†µã€‚æ¥è‡ªæ•´ä¸ªç½‘æ ¼çš„ç»Ÿè®¡æ•°æ®æä¾›äº†æ¯ä¸ª ç½‘ç»œèŠ‚ç‚¹ å’Œæ•´ä½“ç½‘ç»œå¥åº·çŠ¶å†µçš„éå¸¸è¯¦ç»†çš„æ±‡æ€»ä¿¡æ¯ã€‚Envoy çš„æ–‡æ¡£å¯¹è¿™äº›æŒ‡æ ‡æœ‰ä¸€äº›ç®€å•çš„è¯´æ˜ã€‚ ","date":"2022-09-13","objectID":"/posts/0affe7/:1:0","tags":["istio","envoy","è½¬è½½"],"title":"Envoyæ€§èƒ½æŒ‡æ ‡","uri":"/posts/0affe7/"},{"categories":["äº‘åŸç”Ÿ"],"content":"Tag Envoy çš„æŒ‡æ ‡è¿˜æœ‰ä¸¤ä¸ªå­æ¦‚å¿µï¼Œæ”¯æŒåœ¨æŒ‡æ ‡ä¸­ä½¿ç”¨ï¼š æ ‡ç­¾(tags)/ç»´åº¦(dimensions) ã€‚è¿™é‡Œçš„ tags å¯¹ç­‰äº Prometheus æŒ‡æ ‡çš„ labelã€‚æ„ä¹‰ä¸Šï¼Œå¯ä»¥ç†è§£ä¸ºï¼šåˆ†ç±»ç»´åº¦ã€‚ Envoy çš„ æŒ‡æ ‡ ç”±è§„èŒƒçš„å­—ç¬¦ä¸²æ¥æ ‡è¯†ã€‚è¿™äº›å­—ç¬¦ä¸²çš„åŠ¨æ€éƒ¨åˆ†ï¼ˆå­å­—ç¬¦ä¸²ï¼‰è¢«æå–æˆä¸º æ ‡ç­¾(tag)ã€‚å¯ä»¥é€šè¿‡æŒ‡å®š tag æå–è§„åˆ™(Tag Specifier configuration.) æ¥å®šåˆ¶ tag ã€‚ ä¸¾ä¸ªä¾‹å­ï¼š ### 1. åŸå§‹çš„ Envoy æŒ‡æ ‡ ### $ kubectl exec fortio-server -c istio-proxy -- curl 'localhost:15000/stats' # è¿”å›ï¼š cluster.outbound|8080||fortio-server-l2.mark.svc.cluster.local.external.upstream_rq_2xx: 300 # å…¶ä¸­ï¼š # - `outbound|8080||fortio-server-l2.mark.svc.cluster.local` éƒ¨åˆ†æ˜¯ upstream cluster çš„åå­—ã€‚å¯ä»¥æ­£åˆ™æå–ä½œä¸º tagã€‚ # - `2xx` éƒ¨åˆ†æ˜¯ HTTP Status Code çš„åˆ†ç±»ã€‚å¯ä»¥æ­£åˆ™æå–ä½œä¸º tagã€‚ ä¸‹æ–‡å°†æœ‰è¿™ä¸ªæå–è§„åˆ™çš„é…ç½®è¯´æ˜ã€‚ ### 2. ç»™ Prometheus çš„æŒ‡æ ‡ ### $ kubectl exec fortio-server -c istio-proxy -- curl 'localhost:15000/stats?format=prometheus' | grep 'outbound|8080||fortio-server-l2' | grep 'external.upstream_rq' # è¿”å›ï¼š envoy_cluster_external_upstream_rq{response_code_class=\"2xx\",cluster_name=\"outbound|8080||fortio-server-l2.mark.svc.cluster.local\"} 300 ","date":"2022-09-13","objectID":"/posts/0affe7/:1:1","tags":["istio","envoy","è½¬è½½"],"title":"Envoyæ€§èƒ½æŒ‡æ ‡","uri":"/posts/0affe7/"},{"categories":["äº‘åŸç”Ÿ"],"content":"æŒ‡æ ‡æ•°æ®ç±»å‹ Envoy å‘å‡ºä¸‰ç§ç±»å‹çš„å€¼ä½œä¸ºç»Ÿè®¡ä¿¡æ¯ï¼š è®¡æ•°å™¨(Counters)ï¼šæ— ç¬¦å·æ•´æ•°ï¼Œåªä¼šå¢åŠ è€Œä¸ä¼šå‡å°‘ã€‚ä¾‹å¦‚ï¼Œæ€»è¯·æ±‚ã€‚ ä»ªè¡¨(Gauges)ï¼šå¢åŠ å’Œå‡å°‘çš„æ— ç¬¦å·æ•´æ•°ã€‚ä¾‹å¦‚ï¼Œå½“å‰æ´»åŠ¨çš„è¯·æ±‚ã€‚ ç›´æ–¹å›¾(Histograms)ï¼šä½œä¸ºæŒ‡æ ‡æµçš„ä¸€éƒ¨åˆ†çš„æ— ç¬¦å·æ•´æ•°ï¼Œç„¶åç”±æ”¶é›†å™¨èšåˆä»¥æœ€ç»ˆäº§ç”Ÿæ±‡æ€»çš„ç™¾åˆ†ä½å€¼(percentileï¼Œå³å¹³å¸¸è¯´çš„ P99/P50/Pxx)ã€‚ä¾‹å¦‚ï¼ŒUpsteam å“åº”æ—¶é—´ã€‚ åœ¨ Envoy çš„å†…éƒ¨å®ç°ä¸­ï¼ŒCounters å’Œ Gauges è¢«åˆ†æ‰¹å¹¶å®šæœŸåˆ·æ–°ä»¥æé«˜æ€§èƒ½ã€‚Histograms åœ¨æ¥æ”¶æ—¶å†™å…¥ã€‚ ","date":"2022-09-13","objectID":"/posts/0affe7/:1:2","tags":["istio","envoy","è½¬è½½"],"title":"Envoyæ€§èƒ½æŒ‡æ ‡","uri":"/posts/0affe7/"},{"categories":["äº‘åŸç”Ÿ"],"content":"æŒ‡æ ‡é‡Šä¹‰ ä»æŒ‡æ ‡çš„äº§å‡ºåœ°ç‚¹æ¥åˆ’åˆ†ï¼Œå¯ä»¥åˆ†ä¸ºï¼š cluster manager : é¢å‘ upstream çš„ L3/L4/L7 å±‚æŒ‡æ ‡ http connection manager(HCM) ï¼š é¢å‘ upstream \u0026 downstream çš„ L7 å±‚æŒ‡æ ‡ listeners : é¢å‘ downstream çš„ L3/L4 å±‚æŒ‡æ ‡ server(å…¨å±€) watch dog ä¸‹é¢æˆ‘åªé€‰æ‹©äº†éƒ¨åˆ†å…³é”®çš„æ€§èƒ½æŒ‡æ ‡æ¥ç®€å•è¯´æ˜ã€‚ ","date":"2022-09-13","objectID":"/posts/0affe7/:2:0","tags":["istio","envoy","è½¬è½½"],"title":"Envoyæ€§èƒ½æŒ‡æ ‡","uri":"/posts/0affe7/"},{"categories":["äº‘åŸç”Ÿ"],"content":"cluster manager Envoy æ–‡æ¡£:cluster manager stats ä¸Šé¢æ–‡æ¡£å·²ç»è¯´å¾—æ¯”è¾ƒè¯¦ç»†äº†ã€‚æˆ‘åªè¡¥å……ä¸€äº›åœ¨æ€§èƒ½è°ƒä¼˜æ—¶éœ€è¦å…³æ³¨çš„æ–¹é¢ã€‚é‚£ä¹ˆï¼Œä¸€èˆ¬éœ€è¦å…³æ³¨ä»€ä¹ˆæŒ‡æ ‡ï¼Ÿ æˆ‘ä»¬ä»è‘—åçš„ Utilization Saturation and Errors (USE) æ–¹æ³•å­¦æ¥åˆ†æã€‚ åˆ©ç”¨ç‡(Utilization): upstream_cx_total (Counter): è¿æ¥æ•° upstream_rq_active é¥±å’Œåº¦(Saturation): upstream_rq_time (Histogram): å“åº”æ—¶é—´ upstream_cx_connect_ms (Histogram) upstream_cx_rx_bytes_buffered upstream_cx_tx_bytes_buffered upstream_rq_pending_total upstream_rq_pending_active (Gauge) é”™è¯¯(Error): upstream_cx_connect_fail (Counter): è¿æ¥å¤±è´¥æ•° upstream_cx_connect_timeout (Counter): è¿æ¥è¶…æ—¶æ•° upstream_cx_overflow (Counter): é›†ç¾¤è¿æ¥æ–­è·¯å™¨æº¢å‡ºçš„æ€»æ¬¡æ•° upstream_cx_pool_overflow upstream_cx_destroy_local_with_active_rq upstream_cx_destroy_remote_with_active_rq upstream_rq_timeout upstream_rq_retry upstream_rq_rx_reset upstream_rq_tx_reset å…¶å®ƒï¼š upstream_rq_total (Counter): TPS (åå) upstream_cx_destroy_local (Counter): Envoy ä¸»åŠ¨æ–­å¼€çš„è¿æ¥è®¡æ•° upstream_cx_destroy_remote (Counter): Envoy è¢«åŠ¨æ–­å¼€çš„è¿æ¥è®¡æ•° upstream_cx_length_ms (Histogram) ","date":"2022-09-13","objectID":"/posts/0affe7/:2:1","tags":["istio","envoy","è½¬è½½"],"title":"Envoyæ€§èƒ½æŒ‡æ ‡","uri":"/posts/0affe7/"},{"categories":["äº‘åŸç”Ÿ"],"content":"http connection manager(HCM) Envoy æ–‡æ¡£:http connection manager(HCM) stats å¯ä»¥è®¤ä¸ºï¼Œè¿™æ˜¯é¢å‘ downstream \u0026 éƒ¨åˆ† upstream çš„ L7 å±‚æŒ‡æ ‡ åˆ©ç”¨ç‡(Utilization): downstream_cx_total downstream_cx_active downstream_cx_http1_active downstream_rq_total downstream_rq_http1_total downstream_rq_active é¥±å’Œåº¦(Saturation): downstream_cx_rx_bytes_buffered downstream_cx_tx_bytes_buffered downstream_flow_control_paused_reading_total downstream_flow_control_resumed_reading_total é”™è¯¯(Error): downstream_cx_destroy_local_active_rq downstream_cx_destroy_remote_active_rq downstream_rq_rx_reset downstream_rq_tx_reset downstream_rq_too_large downstream_rq_max_duration_reached downstream_rq_timeout downstream_rq_overload_close rs_too_large å…¶å®ƒï¼š downstream_cx_destroy_remote downstream_cx_destroy_local downstream_cx_length_ms ","date":"2022-09-13","objectID":"/posts/0affe7/:2:2","tags":["istio","envoy","è½¬è½½"],"title":"Envoyæ€§èƒ½æŒ‡æ ‡","uri":"/posts/0affe7/"},{"categories":["äº‘åŸç”Ÿ"],"content":"listeners Envoy æ–‡æ¡£:listener stats å¯ä»¥è®¤ä¸ºï¼Œè¿™æ˜¯ downstream çš„ L3/L4 å±‚çš„æŒ‡æ ‡ã€‚ åˆ©ç”¨ç‡(Utilization): downstream_cx_total downstream_cx_active é¥±å’Œåº¦(Saturation): downstream_pre_cx_active é”™è¯¯(Error): downstream_cx_transport_socket_connect_timeout downstream_cx_overflow no_filter_chain_match downstream_listener_filter_error no_certificate å…¶å®ƒï¼š downstream_cx_length_ms ","date":"2022-09-13","objectID":"/posts/0affe7/:2:3","tags":["istio","envoy","è½¬è½½"],"title":"Envoyæ€§èƒ½æŒ‡æ ‡","uri":"/posts/0affe7/"},{"categories":["äº‘åŸç”Ÿ"],"content":"server Envoy åŸºç¡€ä¿¡æ¯æŒ‡æ ‡ Envoy æ–‡æ¡£:server stats åˆ©ç”¨ç‡(Utilization): concurrency é”™è¯¯(Error): days_until_first_cert_expiring ","date":"2022-09-13","objectID":"/posts/0affe7/:2:4","tags":["istio","envoy","è½¬è½½"],"title":"Envoyæ€§èƒ½æŒ‡æ ‡","uri":"/posts/0affe7/"},{"categories":["äº‘åŸç”Ÿ"],"content":"watch dog Envoy æ–‡æ¡£: Watchdog Envoy è¿˜åŒ…æ‹¬ä¸€ä¸ªå¯é…ç½®çš„çœ‹é—¨ç‹—ç³»ç»Ÿï¼Œå®ƒå¯ä»¥åœ¨ Envoy æ²¡æœ‰å“åº”æ—¶å¢åŠ ç»Ÿè®¡æ•°æ®å¹¶é€‰æ‹©æ€§åœ°ç»ˆæ­¢æœåŠ¡å™¨ã€‚ ç³»ç»Ÿæœ‰ä¸¤ä¸ªç‹¬ç«‹çš„çœ‹é—¨ç‹—é…ç½®ï¼Œä¸€ä¸ªç”¨äºä¸»çº¿ç¨‹ï¼Œä¸€ä¸ªç”¨äºå·¥ä½œçº¿ç¨‹ï¼› å› ä¸ºä¸åŒçš„çº¿ç¨‹æœ‰ä¸åŒçš„å·¥ä½œè´Ÿè½½ã€‚ è¿™äº›ç»Ÿè®¡æ•°æ®æœ‰åŠ©äºä»é«˜å±‚æ¬¡ä¸Šç†è§£ Envoy çš„äº‹ä»¶å¾ªç¯æ˜¯å¦å› ä¸ºå®ƒæ­£åœ¨åšå¤ªå¤šå·¥ä½œã€é˜»å¡æˆ–æ²¡æœ‰è¢«æ“ä½œç³»ç»Ÿè°ƒåº¦è€Œæ²¡æœ‰å“åº”ã€‚ é¥±å’Œåº¦(Saturation): watchdog_mega_miss(Counter): mega æœªå‘½ä¸­æ•° watchdog_miss(Counter): æœªå‘½ä¸­æ•° å¦‚æœä½ å¯¹ watchdog æœºåˆ¶çš„å…´è¶£ï¼Œå¯ä»¥å‚è€ƒï¼š https://github.com/envoyproxy/envoy/issues/11391 https://github.com/envoyproxy/envoy/issues/11388 ","date":"2022-09-13","objectID":"/posts/0affe7/:2:5","tags":["istio","envoy","è½¬è½½"],"title":"Envoyæ€§èƒ½æŒ‡æ ‡","uri":"/posts/0affe7/"},{"categories":["äº‘åŸç”Ÿ"],"content":"Event loop Envoy æ–‡æ¡£: Event loop Envoy æ¶æ„æ—¨åœ¨é€šè¿‡åœ¨å°‘é‡çº¿ç¨‹ä¸Šè¿è¡Œäº‹ä»¶å¾ªç¯æ¥ä¼˜åŒ–å¯æ‰©å±•æ€§å’Œèµ„æºåˆ©ç”¨ç‡ã€‚ â€œmainâ€ çº¿ç¨‹è´Ÿè´£æ§åˆ¶é¢å¤„ç†ï¼Œæ¯ä¸ª â€œworkerâ€ çº¿ç¨‹åˆ†æ‹…æ•°æ®é¢çš„ä¸€éƒ¨åˆ†ä»»åŠ¡ã€‚ Envoy å…¬å¼€äº†ä¸¤ä¸ªç»Ÿè®¡ä¿¡æ¯æ¥ç›‘æ§æ‰€æœ‰è¿™äº›çº¿ç¨‹äº‹ä»¶å¾ªç¯çš„æ€§èƒ½ã€‚ è·‘ä¸€è½®å¾ªç¯çš„è€—æ—¶ï¼šäº‹ä»¶å¾ªç¯çš„æ¯æ¬¡è¿­ä»£éƒ½ä¼šæ‰§è¡Œä¸€äº›ä»»åŠ¡ã€‚ä»»åŠ¡æ•°é‡ä¼šéšç€è´Ÿè½½çš„å˜åŒ–è€Œå˜åŒ–ã€‚ä½†æ˜¯ï¼Œå¦‚æœä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹å…·æœ‰å¼‚å¸¸é•¿å°¾å¾ªç¯æ‰§è¡Œè€—æ—¶ï¼Œåˆ™å¯èƒ½å­˜åœ¨æ€§èƒ½é—®é¢˜ã€‚ä¾‹å¦‚ï¼Œè´Ÿè´£å¯èƒ½åœ¨å·¥ä½œçº¿ç¨‹ä¹‹é—´åˆ†é…ä¸å‡ï¼Œæˆ–è€…æ’ä»¶ä¸­å¯èƒ½å­˜åœ¨é•¿æ—¶é—´é˜»å¡æ“ä½œé˜»ç¢äº†ä»»åŠ¡è¿›åº¦ã€‚ è½®è¯¢å»¶è¿Ÿï¼šåœ¨äº‹ä»¶å¾ªç¯çš„æ¯æ¬¡è¿­ä»£ä¸­ï¼Œäº‹ä»¶è°ƒåº¦ç¨‹åºéƒ½ä¼šè½®è¯¢ I/O äº‹ä»¶ï¼Œå¹¶åœ¨æŸäº› I/O äº‹ä»¶å°±ç»ª æˆ– å‘ç”Ÿ è¶…æ—¶ æ—¶ â€œå”¤é†’â€ çº¿ç¨‹ï¼Œä»¥å…ˆå‘ç”Ÿè€…ä¸ºå‡†ã€‚åœ¨ è¶…æ—¶ çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥æµ‹é‡è½®è¯¢åé¢„æœŸå”¤é†’æ—¶é—´ä¸å®é™…å”¤é†’æ—¶é—´çš„å·®å€¼ï¼›è¿™ç§å·®å¼‚ç§°ä¸º â€œè½®è¯¢å»¶è¿Ÿâ€ã€‚çœ‹åˆ°ä¸€äº›å°çš„ è½®è¯¢å»¶è¿Ÿ æ˜¯æ­£å¸¸çš„ï¼Œé€šå¸¸ç­‰äºå†…æ ¸è°ƒåº¦ç¨‹åºçš„ â€œæ—¶é—´ç‰‡(time sliceâ€)â€ æˆ– â€œé‡å­(quantum)â€ â€”â€”è¿™å–å†³äºè¿è¡Œ Envoy çš„æ“ä½œç³»ç»Ÿ â€”â€” ä½†å¦‚æœè¿™ä¸ªæ•°å­—å¤§å¤§é«˜äºå…¶æ­£å¸¸è§‚å¯Ÿåˆ°çš„åŸºçº¿ï¼Œå®ƒè¡¨ç¤ºå†…æ ¸è°ƒåº¦ç¨‹åºå¯èƒ½å‘ç”Ÿå»¶è¿Ÿã€‚ å¯ä»¥é€šè¿‡å°† enable_dispatcher_stats è®¾ç½®ä¸º true æ¥å¯ç”¨è¿™äº›ç»Ÿè®¡ä¿¡æ¯ã€‚ main çº¿ç¨‹çš„äº‹ä»¶è°ƒåº¦å™¨æœ‰ä¸€ä¸ªä»¥ server.dispatcher. ä¸ºæ ¹çš„ç»Ÿè®¡æ ‘ã€‚ æ¯ä¸ª worker çº¿ç¨‹çš„äº‹ä»¶è°ƒåº¦å™¨éƒ½æœ‰ä¸€ä¸ªä»¥ listener_manager.worker_\u003cid\u003e.dispatcher. ä¸ºæ ¹çš„ç»Ÿè®¡æ ‘ã€‚ æ¯æ£µæ ‘éƒ½æœ‰ä»¥ä¸‹ç»Ÿè®¡ä¿¡æ¯ï¼š Name Type Description loop_duration_us Histogram ä»¥å¾®ç§’ä¸ºå•ä½çš„äº‹ä»¶å¾ªç¯æŒç»­æ—¶é—´ poll_delay_us Histogram ä»¥å¾®ç§’ä¸ºå•ä½çš„è½®è¯¢å»¶è¿Ÿ è¯·æ³¨æ„ï¼Œæ­¤å¤„ä¸åŒ…æ‹¬ä»»ä½•è¾…åŠ©(é main ä¸ worker)çº¿ç¨‹ã€‚ Watch Dog å’Œ Event loop éƒ½æ˜¯è§£å†³ä¸ç›‘æ§äº‹ä»¶å¤„ç†å»¶è¿Ÿä¸æ—¶æ•ˆçš„å·¥å…·ï¼Œè¿™é‡Œæœ‰å¾ˆå¤šç»†èŠ‚å’Œæ•…äº‹ï¼Œç”šè‡³å¯ä»¥è¯´åˆ° Linux Kernelã€‚å¸Œæœ›æœ¬ä¹¦åé¢æœ‰æ—¶é—´ï¼Œå¯ä»¥å’Œå¤§å®¶ä¸€èµ·å­¦ä¹ å’Œåˆ†æè¿™äº›æœ‰è¶£çš„ç»†èŠ‚ã€‚ ","date":"2022-09-13","objectID":"/posts/0affe7/:2:6","tags":["istio","envoy","è½¬è½½"],"title":"Envoyæ€§èƒ½æŒ‡æ ‡","uri":"/posts/0affe7/"},{"categories":["äº‘åŸç”Ÿ"],"content":"é…ç½®è¯´æ˜ æœ¬èŠ‚å‚è€ƒï¼š [Envoy æ–‡æ¡£](https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/metrics/v3/stats.proto) ","date":"2022-09-13","objectID":"/posts/0affe7/:3:0","tags":["istio","envoy","è½¬è½½"],"title":"Envoyæ€§èƒ½æŒ‡æ ‡","uri":"/posts/0affe7/"},{"categories":["äº‘åŸç”Ÿ"],"content":"config.bootstrap.v3.Bootstrap Envoy æ–‡æ¡£:config.bootstrap.v3.Bootstrap proto { \"node\": {...}, \"static_resources\": {...}, \"dynamic_resources\": {...}, \"cluster_manager\": {...}, \"stats_sinks\": [], \"stats_config\": {...}, \"stats_flush_interval\": {...}, \"stats_flush_on_admin\": ..., ... } ä»€ä¹ˆæ˜¯ `stats sink`ï¼Ÿ æœ¬ä¹¦ä¸ä½œè¯´æ˜ã€‚Istio é»˜è®¤æ²¡å®šåˆ¶ç›¸å…³é…ç½®ã€‚ä»¥ä¸‹åªè¯´å…³æ³¨çš„éƒ¨åˆ†é…ç½®ã€‚ stats_config (config.metrics.v3.StatsConfig) ç”¨äºå†…éƒ¨å¤„ç†ç»Ÿè®¡ä¿¡æ¯çš„é…ç½®ã€‚ stats_flush_interval (Duration) åˆ·æ–° stats sink çš„æ—¶é—´é—´éš”ã€‚ã€‚å‡ºäºæ€§èƒ½åŸå› ï¼ŒEnvoy ä¸ä¼šå®æ—¶åˆ·æ–° counter ï¼Œä»…å®šæœŸåˆ·æ–° counter å’Œ gauge ã€‚ å¦‚æœæœªæŒ‡å®šï¼Œåˆ™é»˜è®¤å€¼ä¸º 5000 æ¯«ç§’ã€‚ stats_flush_interval æˆ– stats_flush_on_admin åªèƒ½è®¾ç½®ä¹‹ä¸€ã€‚ Duration å¿…é¡»è‡³å°‘ä¸º 1 æ¯«ç§’ï¼Œæœ€å¤šä¸º 5 åˆ†é’Ÿã€‚ stats_flush_on_admin (bool) ä»…å½“åœ¨ ç®¡ç†ç•Œé¢(admin interface) ä¸ŠæŸ¥è¯¢æ—¶æ‰å°†ç»Ÿè®¡ä¿¡æ¯åˆ·æ–°åˆ° sinkã€‚ å¦‚æœè®¾ç½®ï¼Œåˆ™ä¸ä¼šåˆ›å»ºåˆ·æ–°è®¡æ—¶å™¨ã€‚ åªèƒ½è®¾ç½® stats_flush_on_admin æˆ– stats_flush_interval ä¹‹ä¸€ã€‚ ","date":"2022-09-13","objectID":"/posts/0affe7/:3:1","tags":["istio","envoy","è½¬è½½"],"title":"Envoyæ€§èƒ½æŒ‡æ ‡","uri":"/posts/0affe7/"},{"categories":["äº‘åŸç”Ÿ"],"content":"config.metrics.v3.StatsConfig Envoy æ–‡æ¡£:config-metrics-v3-statsconfig { \"stats_tags\": [], \"use_all_default_tags\": {...}, \"stats_matcher\": {...}, \"histogram_bucket_settings\": [] } stats_tags - ç»´åº¦æå–è§„åˆ™(å¯¹åº” Prometheus çš„ label æå–) (å¤šä¸ª config.metrics.v3.TagSpecifier ) æ¯ä¸ª æŒ‡æ ‡åç§°å­—ç¬¦ä¸² éƒ½é€šè¿‡è¿™äº›æ ‡ç­¾è§„åˆ™ç‹¬ç«‹å¤„ç†ã€‚ å½“ä¸€ä¸ªæ ‡ç­¾åŒ¹é…æ—¶ï¼Œç¬¬ä¸€ä¸ªæ•è·ç»„ä¸ä¼šç«‹å³ä»åç§°ä¸­åˆ é™¤ï¼Œæ‰€ä»¥åé¢çš„ TagSpecifiers ä¹Ÿå¯ä»¥é‡å¤åŒ¹é…åŒä¸€éƒ¨åˆ†ã€‚åœ¨å®Œæˆæ‰€æœ‰æ ‡ç­¾åŒ¹é…åï¼Œå†å‰ªè£ æŒ‡æ ‡åç§°å­—ç¬¦ä¸² çš„åŒ¹é…éƒ¨åˆ†ï¼Œå¹¶ä½œä¸º stats sink çš„æŒ‡æ ‡åï¼Œä¾‹å¦‚ Prometheusçš„æŒ‡æ ‡åã€‚ use_all_default_tags (BoolValue) ä½¿ç”¨ Envoy ä¸­æŒ‡å®šçš„æ‰€æœ‰é»˜è®¤æ ‡ç­¾æ­£åˆ™è¡¨è¾¾å¼ã€‚ è¿™äº›å¯ä»¥ä¸ stats_tags ä¸­æŒ‡å®šçš„è‡ªå®šä¹‰æ ‡ç­¾ç»“åˆä½¿ç”¨ã€‚ å®ƒä»¬å°†åœ¨è‡ªå®šä¹‰æ ‡ç­¾ä¹‹å‰è¿›è¡Œå¤„ç†ã€‚Istio é»˜è®¤ä¸º false. stats_matcher (config.metrics.v3.StatsMatcher) æŒ‡å®š Envoy è¦äº§å‡ºå“ªäº›æŒ‡æ ‡ã€‚æ”¯æŒ åŒ…å«/æ’é™¤ è§„åˆ™æŒ‡å®šã€‚ å¦‚æœæœªæä¾›ï¼Œåˆ™æ‰€æœ‰æŒ‡æ ‡éƒ½å°†äº§å‡ºã€‚ é˜»æ­¢æŸäº›æŒ‡æ ‡é›†çš„ç»Ÿè®¡å¯ä»¥æé«˜ä¸€ç‚¹ Envoy è¿è¡Œæ€§èƒ½ã€‚ ","date":"2022-09-13","objectID":"/posts/0affe7/:3:2","tags":["istio","envoy","è½¬è½½"],"title":"Envoyæ€§èƒ½æŒ‡æ ‡","uri":"/posts/0affe7/"},{"categories":["äº‘åŸç”Ÿ"],"content":"config.metrics.v3.StatsMatcher Envoy æ–‡æ¡£:config-metrics-v3-statsmatcher ç”¨äºç¦ç”¨/å¼€å¯ç»Ÿè®¡æŒ‡æ ‡è®¡ç®—ä¸äº§å‡ºçš„é…ç½®ã€‚ { \"reject_all\": ..., \"exclusion_list\": {...}, \"inclusion_list\": {...} } reject_all (bool) å¦‚æœ reject_all ä¸º true ï¼Œåˆ™ç¦ç”¨æ‰€æœ‰ç»Ÿè®¡ä¿¡æ¯ã€‚ å¦‚æœ reject_all ä¸º falseï¼Œåˆ™å¯ç”¨æ‰€æœ‰ç»Ÿè®¡ä¿¡æ¯ã€‚ exclusion_list (type.matcher.v3.ListStringMatcher) æ’é™¤åˆ—è¡¨ inclusion_list (type.matcher.v3.ListStringMatcher) åŒ…å«åˆ—è¡¨ æœ¬èŠ‚å‚è€ƒäº†ï¼š https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/observability/statistics ä¸‹ä¸€èŠ‚ï¼Œå°†ä»¥ Istio å¦‚ä½•ä½¿ç”¨ä¸Šé¢çš„é…ç½®ä¸ºä¾‹ï¼Œä¸¾ä¾‹è¯´æ˜ã€‚ ","date":"2022-09-13","objectID":"/posts/0affe7/:3:3","tags":["istio","envoy","è½¬è½½"],"title":"Envoyæ€§èƒ½æŒ‡æ ‡","uri":"/posts/0affe7/"},{"categories":["äº‘åŸç”Ÿ"],"content":"åœ¨å‰ä¸¤ç¯‡åšå®¢ä¸­ï¼š Istio ä¸­çš„ Sidecar æ³¨å…¥ã€é€æ˜æµé‡åŠ«æŒåŠæµé‡è·¯ç”±è¿‡ç¨‹è¯¦è§£ Sidecar ä¸­çš„æµé‡ç±»å‹åŠ iptables è§„åˆ™è¯¦è§£ æˆ‘å‘ä½ è¯¦ç»†ä»‹ç»äº† Istio æ•°æ®å¹³é¢ä¸­çš„æµé‡ï¼Œä½†æ•°æ®å¹³é¢å¹¶ä¸èƒ½å­¤ç«‹çš„å­˜åœ¨ï¼Œæœ¬æ–‡å°†å‘ä½ å±•ç¤º Istio ä¸­çš„æ§åˆ¶å¹³é¢å’Œæ•°æ®å¹³é¢å„ç»„ä»¶çš„ç«¯å£åŠå…¶åŠŸèƒ½ï¼Œæœ‰åŠ©äºä½ äº†è§£è¿™äº›æµé‡ä¹‹é—´çš„å…³ç³»åŠæ•…éšœæ’æŸ¥ã€‚ ","date":"2022-09-12","objectID":"/posts/6be15f/:0:0","tags":["istio","sicader","è½¬è½½"],"title":"Istioç»„ä»¶è¯¦è§£","uri":"/posts/6be15f/"},{"categories":["äº‘åŸç”Ÿ"],"content":"Istio ä¸­çš„ç»„ä»¶åŠç«¯å£ç¤ºæ„å›¾ æŒ‰ç…§ä¹ æƒ¯ï¼Œæˆ‘ä»¬é¦–å…ˆå±•ç¤ºä¸€ä¸ªå…¨å±€ç¤ºæ„å›¾ã€‚ä¸‹å›¾å±•ç¤ºçš„æ˜¯ Istio æ•°æ®å¹³é¢ä¸­ sidecar çš„ç»„æˆï¼Œä»¥åŠä¸å…¶äº¤äº’çš„å¯¹è±¡ã€‚ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ nsenter å‘½ä»¤è¿›å…¥Bookinfo ç¤ºä¾‹çš„ productpage Podçš„ç½‘ç»œç©ºé—´ï¼ŒæŸ¥çœ‹å…¶å†…éƒ¨ç›‘å¬çš„ç«¯å£ä¿¡æ¯ã€‚ ä»å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°é™¤äº† productpage åº”ç”¨æœ¬èº«ç›‘å¬çš„ 9080 ç«¯å£ä»¥å¤–ï¼ŒSidecar å®¹å™¨è¿˜æœ‰ç›‘å¬å¤§é‡çš„å…¶ä»–ç«¯å£ï¼Œå¦‚ 15000ã€15001ã€15004ã€15006ã€15021ã€15090 ç­‰ï¼Œä½ å¯ä»¥åœ¨ Istio æ–‡æ¡£ä¸Šäº†è§£ Istio ä¸­ä½¿ç”¨çš„ç«¯å£ã€‚ æˆ‘ä»¬å†è¿›å…¥ productpage Pod ä¸­ï¼Œä½¿ç”¨ lsof -i å‘½ä»¤æŸ¥çœ‹å®ƒæ‰“å¼€çš„ç«¯å£ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ ! æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å…¶ä¸­æœ‰ pilot-agent ä¸ istiod å»ºç«‹äº† TCP è¿æ¥ï¼Œä¸Šæ–‡ä¸­æ‰€è¿°çš„ç›‘å¬ä¸­çš„ç«¯å£ï¼Œè¿˜æœ‰åœ¨ Pod å†…éƒ¨å»ºç«‹çš„ TCP è¿æ¥ï¼Œè¿™äº›è¿æ¥å¯¹åº”äº†æ–‡ç« å¼€å¤´çš„ç¤ºæ„å›¾ã€‚ Sidecar å®¹å™¨ï¼ˆistio-proxy ï¼‰çš„æ ¹è¿›ç¨‹æ˜¯ pilot-agentï¼Œå¯åŠ¨å‘½ä»¤å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š ä»å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå®ƒ pilot-agent è¿›ç¨‹çš„ PID æ˜¯ 1ï¼Œæ˜¯å®ƒæ‹‰èµ·äº† envoy è¿›ç¨‹ã€‚ åœ¨ istiod çš„ Pod ä¸­æŸ¥çœ‹å®ƒæ‰“å¼€çš„ç«¯å£ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å…¶ä¸­çš„ç›‘å¬çš„ç«¯å£ã€è¿›ç¨‹é—´å’Œè¿œç¨‹é€šä¿¡è¿æ¥ã€‚ ","date":"2022-09-12","objectID":"/posts/6be15f/:1:0","tags":["istio","sicader","è½¬è½½"],"title":"Istioç»„ä»¶è¯¦è§£","uri":"/posts/6be15f/"},{"categories":["äº‘åŸç”Ÿ"],"content":"Istio ä¸­å„ç«¯å£çš„åŠŸèƒ½æ¦‚è¿° è¿™äº›ç«¯å£åœ¨ä½ è¿›è¡Œé—®é¢˜æ’æŸ¥æ—¶å¯ä»¥èµ·ç€ä¸¾è¶³è½»é‡çš„ä½œç”¨ã€‚ä¸‹é¢å°†æ ¹æ®ç«¯å£æ‰€åœ¨çš„ç»„ä»¶å’ŒåŠŸèƒ½åˆ†ç±»æè¿°ã€‚ ","date":"2022-09-12","objectID":"/posts/6be15f/:2:0","tags":["istio","sicader","è½¬è½½"],"title":"Istioç»„ä»¶è¯¦è§£","uri":"/posts/6be15f/"},{"categories":["äº‘åŸç”Ÿ"],"content":"Istiod ä¸­çš„ç«¯å£ Istiod ä¸­çš„ç«¯å£ç›¸å¯¹æ¯”è¾ƒå°‘ä¸”åŠŸèƒ½å•ä¸€ï¼š 9876ï¼šControlZ ç”¨æˆ·ç•Œé¢ï¼Œæš´éœ² istiod çš„è¿›ç¨‹ä¿¡æ¯ 8080ï¼šistiod è°ƒè¯•ç«¯å£ï¼Œé€šè¿‡è¯¥ç«¯å£å¯ä»¥æŸ¥è¯¢ç½‘æ ¼çš„é…ç½®å’ŒçŠ¶æ€ä¿¡æ¯ 15010ï¼šæš´éœ² xDS API å’Œé¢å‘çº¯æ–‡æœ¬è¯ä¹¦ 15012ï¼šåŠŸèƒ½åŒ 15010 ç«¯å£ï¼Œä½†ä½¿ç”¨ TLS é€šä¿¡ 15014ï¼šæš´éœ²æ§åˆ¶å¹³é¢çš„æŒ‡æ ‡ç»™ Prometheus 15017ï¼šSidecar æ³¨å…¥å’Œé…ç½®æ ¡éªŒç«¯å£ ","date":"2022-09-12","objectID":"/posts/6be15f/:3:0","tags":["istio","sicader","è½¬è½½"],"title":"Istioç»„ä»¶è¯¦è§£","uri":"/posts/6be15f/"},{"categories":["äº‘åŸç”Ÿ"],"content":"Sidecar ä¸­çš„ç«¯å£ ä»ä¸Šæ–‡ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ° sidecar ä¸­æœ‰ä¼—å¤šç«¯å£ï¼š 15000ï¼šEnvoy ç®¡ç†æ¥å£ï¼Œä½ å¯ä»¥ç”¨å®ƒæ¥æŸ¥è¯¢å’Œä¿®æ”¹ Envoy ä»£ç†çš„çš„é…ç½®ï¼Œè¯¦æƒ…è¯·å‚è€ƒ Envoy æ–‡æ¡£ã€‚ 15001ï¼šç”¨äºå¤„ç†å‡ºç«™æµé‡ã€‚ 15004ï¼šè°ƒè¯•ç«¯å£ï¼Œå°†åœ¨ä¸‹æ–‡ä¸­è§£é‡Šã€‚ 15006ï¼šç”¨äºå¤„ç†å…¥ç«™æµé‡ã€‚ 15020ï¼šæ±‡æ€»ç»Ÿè®¡æ•°æ®ï¼Œå¯¹ Envoy å’Œ DNS ä»£ç†è¿›è¡Œå¥åº·æ£€æŸ¥ï¼Œè°ƒè¯• pilot-agent è¿›ç¨‹ï¼Œå°†åœ¨ä¸‹æ–‡ä¸­è¯¦ç»†è§£é‡Šã€‚ 15021ï¼šç”¨äº sidecar å¥åº·æ£€æŸ¥ï¼Œä»¥åˆ¤æ–­å·²æ³¨å…¥ Pod æ˜¯å¦å‡†å¤‡å¥½æ¥æ”¶æµé‡ã€‚æˆ‘ä»¬åœ¨è¯¥ç«¯å£çš„ /healthz/ready è·¯å¾„ä¸Šè®¾ç½®äº†å°±ç»ªæ¢é’ˆï¼ŒIstio æŠŠ sidecar çš„å°±ç»ªæ£€æµ‹äº¤ç»™äº† kubeletï¼Œæœ€å¤§åŒ–åˆ©ç”¨ Kubernetes å¹³å°è‡ªèº«çš„åŠŸèƒ½ã€‚envoy è¿›ç¨‹å°†å¥åº·æ£€æŸ¥è·¯ç”±åˆ° pilot-agent è¿›ç¨‹çš„ 15020 ç«¯å£ï¼Œå®é™…çš„å¥åº·æ£€æŸ¥å°†å‘ç”Ÿåœ¨é‚£é‡Œã€‚ 15053ï¼šæœ¬åœ° DNS ä»£ç†ï¼Œç”¨äºè§£æ Kubernetes DNS è§£æä¸äº†çš„é›†ç¾¤å†…éƒ¨åŸŸåçš„åœºæ™¯ã€‚ 15090ï¼šEnvoy Prometheus æŸ¥è¯¢ç«¯å£ï¼Œpilot-agent å°†é€šè¿‡æ­¤ç«¯å£æ”¶é›†ç»Ÿè®¡ä¿¡æ¯ã€‚ ä»¥ä¸Šç«¯å£å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ç±»ï¼š è´Ÿè´£è¿›ç¨‹é—´é€šä¿¡ï¼Œä¾‹å¦‚ 15001ã€15006ã€15053 è´Ÿè´£å¥åº·æ£€æŸ¥å’Œä¿¡æ¯ç»Ÿè®¡ï¼Œä¾‹å¦‚ 150021ã€15090 è°ƒè¯•ï¼š15000ã€15004 ä¸‹æ–‡å°†å¯¹å‡ ä¸ªé‡ç‚¹ç«¯å£è¯¦è§£ã€‚ ","date":"2022-09-12","objectID":"/posts/6be15f/:4:0","tags":["istio","sicader","è½¬è½½"],"title":"Istioç»„ä»¶è¯¦è§£","uri":"/posts/6be15f/"},{"categories":["äº‘åŸç”Ÿ"],"content":"15000 ç«¯å£ 15000 æ˜¯ Envoy çš„ Admin æ¥å£ï¼Œè¯¥æ¥å£å…è®¸æˆ‘ä»¬ä¿®æ”¹ Envoyï¼Œå¹¶è·å¾—ä¸€ä¸ªè§†å›¾å’ŒæŸ¥è¯¢æŒ‡æ ‡å’Œé…ç½®ã€‚ ç®¡ç†æ¥å£ç”±ä¸€ä¸ªå…·æœ‰å¤šä¸ªç«¯ç‚¹çš„ REST API å’Œä¸€ä¸ªç®€å•çš„ç”¨æˆ·ç•Œé¢ç»„æˆï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å¼€å¯ productpage Pod ä¸­çš„ Envoy ç®¡ç†æ¥å£è§†å›¾ã€‚ kubectl -n default port-forward deploy/productpage-v1 15000 åœ¨æµè§ˆå™¨ä¸­è®¿é—® http://localhost:15000ï¼Œä½ å°†çœ‹åˆ° Envoy Admin ç•Œé¢å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ ","date":"2022-09-12","objectID":"/posts/6be15f/:5:0","tags":["istio","sicader","è½¬è½½"],"title":"Istioç»„ä»¶è¯¦è§£","uri":"/posts/6be15f/"},{"categories":["äº‘åŸç”Ÿ"],"content":"15004 ç«¯å£ é€šè¿‡ pilot-agent ä»£ç† istiod 8080 ç«¯å£ä¸Šçš„è°ƒè¯•ç«¯ç‚¹ï¼Œä½ å¯ä»¥è¿›å…¥æ•°æ®å¹³é¢ Pod ä¸­è®¿é—® localhost çš„ 15004 ç«¯å£æŸ¥è¯¢ç½‘æ ¼ä¿¡æ¯ï¼Œå…¶æ•ˆæœä¸ä¸‹é¢çš„ 8080 ç«¯å£ç­‰åŒã€‚ ","date":"2022-09-12","objectID":"/posts/6be15f/:6:0","tags":["istio","sicader","è½¬è½½"],"title":"Istioç»„ä»¶è¯¦è§£","uri":"/posts/6be15f/"},{"categories":["äº‘åŸç”Ÿ"],"content":"8080 ç«¯å£ ä½ è¿˜å¯ä»¥åœ¨æœ¬åœ°è½¬å‘ istiod 8080 ç«¯å£ï¼Œè¯·è¿è¡Œä¸‹é¢çš„å‘½ä»¤ã€‚ kubectl -n istio-system port-forward deploy/istiod 8080 åœ¨æµè§ˆå™¨ä¸­è®¿é—® http://localhost:8080/debugï¼Œä½ å°†çœ‹åˆ°è°ƒè¯•ç«¯ç‚¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ å½“ç„¶ï¼Œè¿™åªæ˜¯ä¸€ç§è·å–ç½‘æ ¼ä¿¡æ¯å’Œè°ƒè¯•ç½‘æ ¼çš„æ–¹å¼ï¼Œä½ è¿˜å¯ä»¥ä½¿ç”¨ istioctl å‘½ä»¤æˆ– Kiali æ¥è°ƒè¯•ï¼Œé‚£æ ·å°†æ›´åŠ é«˜æ•ˆå’Œç›´è§‚ã€‚ ","date":"2022-09-12","objectID":"/posts/6be15f/:7:0","tags":["istio","sicader","è½¬è½½"],"title":"Istioç»„ä»¶è¯¦è§£","uri":"/posts/6be15f/"},{"categories":["äº‘åŸç”Ÿ"],"content":"15020 ç«¯å£ 15020 ç«¯å£æœ‰ä¸‰å¤§åŠŸèƒ½ï¼š æ±‡æ€»ç»Ÿè®¡æ•°æ®ï¼šæŸ¥è¯¢ 15090 ç«¯å£è·å– envoy çš„æŒ‡æ ‡ï¼Œä¹Ÿå¯ä»¥é…ç½®æŸ¥è¯¢åº”ç”¨ç¨‹åºçš„æŒ‡æ ‡ï¼Œå°† envoyã€åº”ç”¨ç¨‹åºå’Œè‡ªèº«çš„æŒ‡æ ‡æ±‡æ€»ä»¥ä¾› Prometheus æ”¶é›†ã€‚å¯¹åº”çš„è°ƒè¯•ç«¯ç‚¹æ˜¯ /stats/prometheusã€‚ å¯¹ Envoy å’Œ DNS ä»£ç†è¿›è¡Œå¥åº·æ£€æŸ¥ï¼šå¯¹åº”çš„è°ƒè¯•ç«¯ç‚¹æ˜¯ /healthz/ready å’Œ /app-healthã€‚ è°ƒè¯• pilot-agent è¿›ç¨‹ï¼šå¯¹åº”çš„è°ƒè¯•ç«¯ç‚¹æ˜¯ /quitquitquitã€debug/ndsz å’Œ /debug/pprofã€‚ ä¸‹å›¾å±•ç¤ºçš„æ˜¯ä½¿ç”¨æœ¬åœ°ç«¯å£è½¬å‘åï¼Œåœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ http://localhost:15020/debug/pprof çœ‹åˆ°çš„è°ƒè¯•ä¿¡æ¯ã€‚ å›¾ä¸­ä¿¡æ¯å±•ç¤ºçš„æ˜¯ pilot-agent çš„å †æ ˆä¿¡æ¯ã€‚ ","date":"2022-09-12","objectID":"/posts/6be15f/:8:0","tags":["istio","sicader","è½¬è½½"],"title":"Istioç»„ä»¶è¯¦è§£","uri":"/posts/6be15f/"},{"categories":["äº‘åŸç”Ÿ"],"content":"æ€»ç»“ é€šè¿‡å¯¹ Istio ä¸­å„ç»„ä»¶ç«¯å£çš„äº†è§£ï¼Œä½ åº”è¯¥å¯¹ Istio ä¸­å„ç»„ä»¶çš„å…³ç³»åŠå…¶å†…éƒ¨æµé‡æœ‰äº†æ›´è¿›ä¸€æ­¥çš„è®¤è¯†ï¼Œç†Ÿæ‚‰è¿™äº›ç«¯å£çš„åŠŸèƒ½ï¼Œæœ‰åŠ©äºå¯¹ç½‘æ ¼çš„æ•…éšœæ’é™¤ã€‚ ","date":"2022-09-12","objectID":"/posts/6be15f/:9:0","tags":["istio","sicader","è½¬è½½"],"title":"Istioç»„ä»¶è¯¦è§£","uri":"/posts/6be15f/"},{"categories":["äº‘åŸç”Ÿ"],"content":"æˆ‘åœ¨ä¹‹å‰çš„ä¸€ç¯‡åšå®¢ä¸­è®²è§£è¿‡ Istio ä¸­ sidecar çš„æ³¨å…¥ã€ä½¿ç”¨ iptables è¿›è¡Œé€æ˜æµé‡æ‹¦æˆªåŠæµé‡è·¯ç”±çš„è¯¦ç»†è¿‡ç¨‹ï¼Œå¹¶ä»¥ Bookinfo ç¤ºä¾‹ä¸­çš„ productpage æœåŠ¡è®¿é—® reviews æœåŠ¡ï¼Œå’Œ reviews æœåŠ¡è®¿é—® ratings æœåŠ¡ä¸ºä¾‹ç»˜åˆ¶äº†é€æ˜æµé‡åŠ«æŒç¤ºæ„å›¾ã€‚åœ¨é‚£ä¸ªç¤ºæ„å›¾ä¸­ä»…å±•ç¤ºäº† reviews pod æ¥æ”¶æµé‡å’Œå¯¹å¤–è®¿é—®çš„è·¯ç”±ï¼Œå®é™…ä¸Š sidecar å†…çš„æµé‡è¿œä¸æ­¢äºæ­¤ã€‚ ","date":"2022-09-11","objectID":"/posts/61aaaf/:0:0","tags":["sicader","è½¬è½½"],"title":"Sidecar ä¸­çš„æµé‡ç±»å‹åŠ iptables è§„åˆ™è¯¦è§£","uri":"/posts/61aaaf/"},{"categories":["äº‘åŸç”Ÿ"],"content":"ISTIO_OUTPUT è§„åˆ™ åœ¨æ‰€æœ‰çš„ iptables è°ƒç”¨é“¾ä¸­æœ€å¤æ‚çš„ä¸€ä¸ªæ˜¯ ISTIO_OUTPUTï¼Œå…¶ä¸­å…±æœ‰ 9 æ¡è§„åˆ™å¦‚ä¸‹ï¼š Rule target in out source destination 1 RETURN any lo 127.0.0.6 anywhere 2 ISTIO_IN_REDIRECT any lo anywhere !localhost owner UID match 1337 3 RETURN any lo anywhere anywhere !owner UID match 1337 4 RETURN any any anywhere anywhere owner UID match 1337 5 ISTIO_IN_REDIRECT any lo anywhere !localhost owner GID match 1337 6 RETURN any lo anywhere anywhere !owner GID match 1337 7 RETURN any any anywhere anywhere owner GID match 1337 8 RETURN any any anywhere localhost 9 ISTIO_REDIRECT any any anywhere anywhere æœ¬æ–‡å°†å‘ä½ å±•ç¤º Istio sidecar ä¸­çš„å…­ç§æµé‡ç±»å‹åŠå…¶ iptables è§„åˆ™ï¼Œ ä»¥ç¤ºæ„å›¾çš„å½¢å¼å¸¦ä½ ä¸€è§ˆå…¶å…¨è²Œï¼Œå…¶ä¸­è¯¦ç»†æŒ‡å‡ºäº†è·¯ç”±å…·ä½“ä½¿ç”¨çš„æ˜¯ ISTIO_OUTPUT ä¸­çš„å“ªä¸€æ¡è§„åˆ™ã€‚ ","date":"2022-09-11","objectID":"/posts/61aaaf/:1:0","tags":["sicader","è½¬è½½"],"title":"Sidecar ä¸­çš„æµé‡ç±»å‹åŠ iptables è§„åˆ™è¯¦è§£","uri":"/posts/61aaaf/"},{"categories":["äº‘åŸç”Ÿ"],"content":"Sidecar ä¸­çš„ iptables æµé‡è·¯ç”± Sidecar ä¸­çš„æµé‡å¯ä»¥åˆ’åˆ†ä¸ºä»¥ä¸‹å‡ ç±»ï¼š è¿œç¨‹æœåŠ¡è®¿é—®æœ¬åœ°æœåŠ¡ï¼šRemote Pod -\u003e Local Pod æœ¬åœ°æœåŠ¡è®¿é—®è¿œç¨‹æœåŠ¡ï¼šLocal Pod -\u003e Remote Pod Prometheus æŠ“å–æœ¬åœ°æœåŠ¡çš„ metricsï¼šPrometheus -\u003e Local Pod æœ¬åœ° Pod æœåŠ¡é—´çš„æµé‡ï¼šLocal Pod -\u003e Local Pod Envoy å†…éƒ¨çš„è¿›ç¨‹é—´ TCP æµé‡ Sidecar åˆ° Istiod çš„æµé‡ ä¸‹é¢å°†ä¾æ¬¡è§£é‡Šæ¯ä¸ªåœºæ™¯ä¸‹ Sidecar å†…çš„ iptables è·¯ç”±è§„åˆ™ã€‚ ","date":"2022-09-11","objectID":"/posts/61aaaf/:2:0","tags":["sicader","è½¬è½½"],"title":"Sidecar ä¸­çš„æµé‡ç±»å‹åŠ iptables è§„åˆ™è¯¦è§£","uri":"/posts/61aaaf/"},{"categories":["äº‘åŸç”Ÿ"],"content":"ç±»å‹ä¸€ï¼šRemote Pod -\u003e Local Pod ä»¥ä¸‹æ˜¯è¿œç¨‹æœåŠ¡ã€åº”ç”¨æˆ–å®¢æˆ·ç«¯è®¿é—®æ•°æ®å¹³é¢æœ¬åœ° Pod IP çš„ iptables è§„åˆ™ã€‚ Remote Pod -\u003e RREROUTING -\u003e ISTIO_INBOUND -\u003e ISTIO_IN_REDIRECT -\u003e Envoy 15006ï¼ˆInboundï¼‰-\u003e OUTPUT -\u003e ISTIO_OUTPUT RULE 1 -\u003e POSTROUTING -\u003e Local Pod æˆ‘ä»¬çœ‹åˆ°æµé‡åªç»è¿‡ä¸€æ¬¡ Envoy 15006 Inbound ç«¯å£ã€‚è¿™ç§åœºæ™¯ä¸‹çš„ iptables è§„åˆ™çš„ç¤ºæ„å›¾å¦‚ä¸‹ã€‚ ","date":"2022-09-11","objectID":"/posts/61aaaf/:3:0","tags":["sicader","è½¬è½½"],"title":"Sidecar ä¸­çš„æµé‡ç±»å‹åŠ iptables è§„åˆ™è¯¦è§£","uri":"/posts/61aaaf/"},{"categories":["äº‘åŸç”Ÿ"],"content":"ç±»å‹äºŒï¼šLocal Pod -\u003e Remote Pod ä»¥ä¸‹æ˜¯æœ¬åœ° Pod IP è®¿é—®è¿œç¨‹æœåŠ¡ç»è¿‡çš„ iptables è§„åˆ™ã€‚ Local Pod-\u003e OUTPUT -\u003e ISTIO_OUTPUT RULE 9 -\u003e ISTIO_REDIRECT -\u003e Envoy 15001ï¼ˆOutboundï¼‰-\u003e OUTPUT -\u003e ISTIO_OUTPUT RULE 4 -\u003e POSTROUTING -\u003e Remote Pod æˆ‘ä»¬çœ‹åˆ°æµé‡åªç»è¿‡ Envoy 15001 Outbound ç«¯å£ã€‚ ä»¥ä¸Šä¸¤ç§åœºæ™¯ä¸­çš„æµé‡éƒ½åªç»è¿‡ä¸€æ¬¡ Envoyï¼Œå› ä¸ºè¯¥ Pod ä¸­åªæœ‰å‘å‡ºæˆ–æ¥å—è¯·æ±‚ä¸€ç§åœºæ™¯å‘ç”Ÿã€‚ ","date":"2022-09-11","objectID":"/posts/61aaaf/:4:0","tags":["sicader","è½¬è½½"],"title":"Sidecar ä¸­çš„æµé‡ç±»å‹åŠ iptables è§„åˆ™è¯¦è§£","uri":"/posts/61aaaf/"},{"categories":["äº‘åŸç”Ÿ"],"content":"ç±»å‹ä¸‰ï¼šPrometheus -\u003e Local Pod Prometheus æŠ“å–æ•°æ®å¹³é¢ metrics çš„æµé‡ä¸ä¼šä¹Ÿæ— é¡»ç»è¿‡ Envoy ä»£ç†ã€‚ è¿™äº›æµé‡é€šè¿‡çš„ iptables è§„åˆ™å¦‚ä¸‹ã€‚ Prometheus-\u003e RREROUTING -\u003e ISTIO_INBOUNDï¼ˆå¯¹ç›®çš„åœ°ä¸º 15002ã€15090 ç«¯å£æµé‡å°†è½¬åˆ° INPUTï¼‰-\u003e INPUT -\u003e Local Pod è¿™ç§åœºæ™¯ä¸‹çš„ iptables è§„åˆ™çš„ç¤ºæ„å›¾å¦‚ä¸‹ã€‚ ","date":"2022-09-11","objectID":"/posts/61aaaf/:5:0","tags":["sicader","è½¬è½½"],"title":"Sidecar ä¸­çš„æµé‡ç±»å‹åŠ iptables è§„åˆ™è¯¦è§£","uri":"/posts/61aaaf/"},{"categories":["äº‘åŸç”Ÿ"],"content":"ç±»å‹å››ï¼šLocal Pod -\u003e Local Pod ä¸€ä¸ª Pod å¯èƒ½åŒæ—¶å­˜åœ¨ä¸¤ä¸ªæˆ–å¤šä¸ªæœåŠ¡ï¼Œå¦‚æœ Local Pod è®¿é—®çš„æœåŠ¡ä¹Ÿåœ¨è¯¥å½“å‰ Pod ä¸Šï¼Œæµé‡ä¼šä¾æ¬¡ç»è¿‡ Envoy 15001 å’Œ Envoy 15006 ç«¯å£æœ€ååˆ°è¾¾æœ¬åœ° Pod çš„æœåŠ¡ç«¯å£ä¸Šã€‚ è¿™äº›æµé‡é€šè¿‡çš„ iptables è§„åˆ™å¦‚ä¸‹ã€‚ Local Pod-\u003e OUTPUT -\u003e ISTIO_OUTPUT RULE 9 -\u003e ISTIO_REDIRECT -\u003e Envoy 15001ï¼ˆOutboundï¼‰-\u003e OUTPUT -\u003e ISTIO_OUTPUT RULE 2 -\u003e ISTIO_IN_REDIRECT -\u003e Envoy 15006ï¼ˆInboundï¼‰-\u003e OUTPUT -\u003e ISTIO_OUTPUT RULE 1 -\u003e POSTROUTING -\u003e Local Pod ","date":"2022-09-11","objectID":"/posts/61aaaf/:6:0","tags":["sicader","è½¬è½½"],"title":"Sidecar ä¸­çš„æµé‡ç±»å‹åŠ iptables è§„åˆ™è¯¦è§£","uri":"/posts/61aaaf/"},{"categories":["äº‘åŸç”Ÿ"],"content":"ç±»å‹äº”ï¼šEnvoy å†…éƒ¨çš„è¿›ç¨‹é—´ TCP æµé‡ Envoy å†…éƒ¨è¿›ç¨‹çš„ UID å’Œ GID ä¸º 1337ï¼Œå®ƒä»¬ä¹‹é—´çš„æµé‡å°†ä½¿ç”¨ lo ç½‘å¡ï¼Œä½¿ç”¨ localhost åŸŸåæ¥é€šä¿¡ã€‚ è¿™äº›æµé‡é€šè¿‡çš„ iptables è§„åˆ™å¦‚ä¸‹ã€‚ Envoy è¿›ç¨‹ï¼ˆLocalhostï¼‰ -\u003e OUTPUT -\u003e ISTIO_OUTPUT RULE 8 -\u003e POSTROUTING -\u003e Envoy è¿›ç¨‹ï¼ˆLocalhostï¼‰ ","date":"2022-09-11","objectID":"/posts/61aaaf/:7:0","tags":["sicader","è½¬è½½"],"title":"Sidecar ä¸­çš„æµé‡ç±»å‹åŠ iptables è§„åˆ™è¯¦è§£","uri":"/posts/61aaaf/"},{"categories":["äº‘åŸç”Ÿ"],"content":"ç±»å‹å…­ï¼šSidecar åˆ° Istiod çš„æµé‡ Sidecar éœ€è¦è®¿é—® Istiod ä»¥åŒæ­¥é…ç½®ï¼Œpilot-agent è¿›ç¨‹ä¼šå‘ Istiod å‘é€è¯·æ±‚ï¼Œä»¥åŒæ­¥é…ç½®ã€‚ è¿™äº›æµé‡é€šè¿‡çš„ iptables è§„åˆ™å¦‚ä¸‹ã€‚ pilot-agent è¿›ç¨‹ -\u003e OUTPUT -\u003e Istio_OUTPUT RULE 9 -\u003e Envoy 15001 (Outbound Handler) -\u003e OUTPUT -\u003e ISTIO_OUTPUT RULE 4 -\u003e POSTROUTING -\u003e Istiod ","date":"2022-09-11","objectID":"/posts/61aaaf/:8:0","tags":["sicader","è½¬è½½"],"title":"Sidecar ä¸­çš„æµé‡ç±»å‹åŠ iptables è§„åˆ™è¯¦è§£","uri":"/posts/61aaaf/"},{"categories":["äº‘åŸç”Ÿ"],"content":"æ€»ç»“ Istio æ³¨å…¥åœ¨ Pod å†…æˆ–è™šæ‹Ÿæœºä¸­å®‰è£…çš„æ‰€æœ‰ sidecar ä»£ç†ç»„æˆäº†æœåŠ¡ç½‘æ ¼çš„æ•°æ®å¹³é¢ï¼Œä¹Ÿæ˜¯ Istio çš„ä¸»è¦å·¥ä½œè´Ÿè½½æ‰€åœ¨åœ°ï¼Œé€šè¿‡ Istio ä¸­çš„é€æ˜æµé‡åŠ«æŒ åŠè¿™ç¯‡åšå®¢ï¼Œç›¸ä¿¡ä½ ä¸€å®šå¯¹ sidecar ä»£ç†ä¸­çš„æµé‡æœ‰äº†ä¸€ä¸ªæ·±åˆ»çš„äº†è§£ï¼Œä½†è¿™è¿˜åªæ˜¯ç®¡ä¸­çª¥è±¹ï¼Œç•¥è§ä¸€æ–‘ï¼Œåœ¨æˆ‘çš„ä¸‹ä¸€ç¯‡åšå®¢ä¸­ï¼Œæˆ‘å°†å¸¦ä½ äº†è§£ Envoy ä¸­å„ä¸ªç»„ä»¶çš„ç«¯å£åŠå…¶åŠŸèƒ½ï¼Œè¿™æ ·å¯ä»¥è®©æˆ‘ä»¬å¯¹ Istio ä¸­çš„æµé‡æœ‰ä¸€ä¸ªæ›´å…¨é¢çš„äº†è§£ã€‚ ","date":"2022-09-11","objectID":"/posts/61aaaf/:9:0","tags":["sicader","è½¬è½½"],"title":"Sidecar ä¸­çš„æµé‡ç±»å‹åŠ iptables è§„åˆ™è¯¦è§£","uri":"/posts/61aaaf/"},{"categories":["äº‘åŸç”Ÿ"],"content":"æœ¬æ–‡æœ€æ—©æ˜¯åŸºäº Istio 1.11 æ’°å†™ï¼Œä¹‹åéšç€ Istio çš„ç‰ˆæœ¬é™†ç»­æ›´æ–°ï¼Œæœ€æ–°æ›´æ–°æ—¶é—´ä¸º 2022 å¹´ 5 æœˆ 12 æ—¥ï¼Œå…³äºæœ¬æ–‡å†å²ç‰ˆæœ¬çš„æ›´æ–°è¯´æ˜è¯·è§æ–‡ç« æœ€åã€‚æœ¬æ–‡è®°å½•äº†è¯¦ç»†çš„å®è·µè¿‡ç¨‹ï¼ŒåŠ›å›¾èƒ½å¤Ÿè®©è¯»è€…å¤ç°ï¼Œå› æ­¤äº‹æ— å·¨ç»†ï¼Œæƒ³è¦ç†è§£æŸä¸ªéƒ¨åˆ†è¿‡ç¨‹çš„è¯»è€…å¯ä»¥ä½¿ç”¨ç›®å½•è·³è½¬åˆ°å¯¹åº”çš„å°èŠ‚é˜…è¯»ã€‚ ä¸ºäº†ç†è§£æœ¬æ–‡å¸Œæœ›ä½ å…ˆé˜…è¯»ä»¥ä¸‹å†…å®¹ï¼š ç†è§£ iptables Istio æ•°æ®å¹³é¢ Pod å¯åŠ¨è¿‡ç¨‹è¯¦è§£ ","date":"2022-09-11","objectID":"/posts/fe0ba1/:0:0","tags":["istio","è½¬è½½"],"title":"Istio ä¸­çš„ Sidecar æ³¨å…¥ã€é€æ˜æµé‡åŠ«æŒåŠæµé‡è·¯ç”±è¿‡ç¨‹è¯¦è§£","uri":"/posts/fe0ba1/"},{"categories":["äº‘åŸç”Ÿ"],"content":"å†…å®¹ä»‹ç» æœ¬æ–‡åŸºäº Istio 1.13 ç‰ˆæœ¬ï¼Œå°†ä¸ºå¤§å®¶ä»‹ç»ä»¥ä¸‹å†…å®¹ï¼š ä»€ä¹ˆæ˜¯ sidecar æ¨¡å¼å’Œå®ƒçš„ä¼˜åŠ¿åœ¨å“ªé‡Œã€‚ Istio ä¸­æ˜¯å¦‚ä½•åš sidecar æ³¨å…¥çš„ã€‚ Sidecar ä»£ç†æ˜¯å¦‚ä½•åšé€æ˜æµé‡åŠ«æŒçš„ã€‚ iptables çš„è·¯ç”±è§„åˆ™ã€‚ Envoy ä»£ç†æ˜¯å¦‚ä½•è·¯ç”±æµé‡åˆ°ä¸Šæ¸¸çš„ã€‚ è¯·å¤§å®¶ç»“åˆä¸‹å›¾ç†è§£æœ¬æ–‡ä¸­çš„å†…å®¹ï¼Œæœ¬å›¾åŸºäº Istio å®˜æ–¹æä¾›çš„ Bookinfo ç¤ºä¾‹ç»˜åˆ¶ï¼Œå±•ç¤ºçš„æ˜¯ reviews Pod çš„å†…éƒ¨ç»“æ„ï¼ŒåŒ…æ‹¬ Linux Kernel ç©ºé—´ä¸­çš„ iptables è§„åˆ™ã€Sidecar å®¹å™¨ã€åº”ç”¨å®¹å™¨ã€‚ productpage è®¿é—® reviews Podï¼Œå…¥ç«™æµé‡å¤„ç†è¿‡ç¨‹å¯¹åº”äºå›¾ç¤ºä¸Šçš„æ­¥éª¤ï¼š1ã€2ã€3ã€4ã€Envoy Inbound Handlerã€5ã€6ã€7ã€8ã€åº”ç”¨å®¹å™¨ã€‚ reviews Pod è®¿é—® rating æœåŠ¡çš„å‡ºç«™æµé‡å¤„ç†è¿‡ç¨‹å¯¹åº”äºå›¾ç¤ºä¸Šçš„æ­¥éª¤æ˜¯ï¼š9ã€10ã€11ã€12ã€Envoy Outbound Handlerã€13ã€14ã€15ã€‚ æ³¨æ„ï¼šå›¾ä¸­çš„è·¯å¾„ 16 è¿‘ç”¨äºè·¯ç”±è§„åˆ™è¯´æ˜ï¼Œå®ƒä¸ä¸å‡ºç°åœ¨å½“å‰ç¤ºä¾‹ä¸­ã€‚å®é™…ä¸Šä»…å½“ Pod å†…å‘å‡ºçš„å¯¹å½“å‰ Pod å†…çš„æœåŠ¡è®¿é—®çš„æ—¶å€™æ‰ä¼šé€”å¾„å®ƒã€‚ ä¸Šå›¾ä¸­å…³äºæµé‡è·¯ç”±éƒ¨åˆ†ï¼ŒåŒ…å«ï¼š productpage æœåŠ¡è¯·æ±‚è®¿é—® http://reviews.default.svc.cluster.local:9080/ï¼Œå½“æµé‡è¿›å…¥ reviews Pod å†…éƒ¨æ—¶ï¼Œæµé‡æ˜¯å¦‚ä½•è¢« iptables åŠ«æŒåˆ° Envoy ä»£ç†è¢« Inbound Handler å¤„ç†çš„ï¼› reviews è¯·æ±‚è®¿é—® ratings æœåŠ¡çš„ Podï¼Œåº”ç”¨ç¨‹åºå‘å‡ºçš„å‡ºç«™æµé‡è¢« iptables åŠ«æŒåˆ° Envoy ä»£ç†çš„ Outbound Handler çš„å¤„ç†ã€‚ åœ¨é˜…è¯»ä¸‹æ–‡æ—¶ï¼Œè¯·å¤§å®¶ç¡®ç«‹ä»¥ä¸‹å·²çŸ¥ç‚¹ï¼š é¦–å…ˆï¼Œproductpage å‘å‡ºçš„å¯¹ reivews çš„è®¿é—®æµé‡ï¼Œæ˜¯åœ¨ Envoy å·²ç»é€šè¿‡ EDS é€‰æ‹©å‡ºäº†è¦è¯·æ±‚çš„ reviews æœåŠ¡çš„æŸä¸ª Podï¼ŒçŸ¥æ™“äº†å…¶ IP åœ°å€ï¼Œç›´æ¥å‘è¯¥ IP å‘é€çš„ TCP è¿æ¥è¯·æ±‚ã€‚ reviews æœåŠ¡æœ‰ä¸‰ä¸ªç‰ˆæœ¬ï¼Œæ¯ä¸ªç‰ˆæœ¬æœ‰ä¸€ä¸ªå®ä¾‹ï¼Œä¸‰ä¸ªç‰ˆæœ¬ä¸­çš„ sidecar å·¥ä½œæ­¥éª¤ç±»ä¼¼ï¼Œä¸‹æ–‡åªä»¥å…¶ä¸­ä¸€ä¸ª Pod ä¸­çš„ sidecar æµé‡è½¬å‘æ­¥éª¤æ¥è¯´æ˜ã€‚ æ‰€æœ‰è¿›å…¥ reviews Pod çš„ TCP æµé‡éƒ½æ ¹æ® Pod ä¸­çš„ iptables è§„åˆ™è½¬å‘åˆ°äº† Envoy ä»£ç†çš„ 15006 ç«¯å£ï¼Œç„¶åç»è¿‡ Envoy çš„å¤„ç†ç¡®å®šè½¬å‘ç»™ Pod å†…çš„åº”ç”¨å®¹å™¨è¿˜æ˜¯é€ä¼ ã€‚ ","date":"2022-09-11","objectID":"/posts/fe0ba1/:1:0","tags":["istio","è½¬è½½"],"title":"Istio ä¸­çš„ Sidecar æ³¨å…¥ã€é€æ˜æµé‡åŠ«æŒåŠæµé‡è·¯ç”±è¿‡ç¨‹è¯¦è§£","uri":"/posts/fe0ba1/"},{"categories":["äº‘åŸç”Ÿ"],"content":"Sidecar æ¨¡å¼ å°†åº”ç”¨ç¨‹åºçš„åŠŸèƒ½åˆ’åˆ†ä¸ºå•ç‹¬çš„è¿›ç¨‹è¿è¡Œåœ¨åŒä¸€ä¸ªæœ€å°è°ƒåº¦å•å…ƒä¸­ï¼ˆä¾‹å¦‚ Kubernetes ä¸­çš„ Podï¼‰å¯ä»¥è¢«è§†ä¸º sidecar æ¨¡å¼ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œsidecar æ¨¡å¼å…è®¸æ‚¨åœ¨åº”ç”¨ç¨‹åºæ—è¾¹æ·»åŠ æ›´å¤šåŠŸèƒ½ï¼Œè€Œæ— éœ€é¢å¤–ç¬¬ä¸‰æ–¹ç»„ä»¶é…ç½®æˆ–ä¿®æ”¹åº”ç”¨ç¨‹åºä»£ç ã€‚ å°±åƒè¿æ¥äº† Sidecar çš„ä¸‰è½®æ‘©æ‰˜è½¦ä¸€æ ·ï¼Œåœ¨è½¯ä»¶æ¶æ„ä¸­ï¼Œ Sidecar è¿æ¥åˆ°çˆ¶åº”ç”¨å¹¶ä¸”ä¸ºå…¶æ·»åŠ æ‰©å±•æˆ–è€…å¢å¼ºåŠŸèƒ½ã€‚Sidecar åº”ç”¨ä¸ä¸»åº”ç”¨ç¨‹åºæ¾æ•£è€¦åˆã€‚å®ƒå¯ä»¥å±è”½ä¸åŒç¼–ç¨‹è¯­è¨€çš„å·®å¼‚ï¼Œç»Ÿä¸€å®ç°å¾®æœåŠ¡çš„å¯è§‚å¯Ÿæ€§ã€ç›‘æ§ã€æ—¥å¿—è®°å½•ã€é…ç½®ã€æ–­è·¯å™¨ç­‰åŠŸèƒ½ã€‚ ","date":"2022-09-11","objectID":"/posts/fe0ba1/:2:0","tags":["istio","è½¬è½½"],"title":"Istio ä¸­çš„ Sidecar æ³¨å…¥ã€é€æ˜æµé‡åŠ«æŒåŠæµé‡è·¯ç”±è¿‡ç¨‹è¯¦è§£","uri":"/posts/fe0ba1/"},{"categories":["äº‘åŸç”Ÿ"],"content":"ä½¿ç”¨ Sidecar æ¨¡å¼çš„ä¼˜åŠ¿ ä½¿ç”¨ sidecar æ¨¡å¼éƒ¨ç½²æœåŠ¡ç½‘æ ¼æ—¶ï¼Œæ— éœ€åœ¨èŠ‚ç‚¹ä¸Šè¿è¡Œä»£ç†ï¼Œä½†æ˜¯é›†ç¾¤ä¸­å°†è¿è¡Œå¤šä¸ªç›¸åŒçš„ sidecar å‰¯æœ¬ã€‚åœ¨ sidecar éƒ¨ç½²æ–¹å¼ä¸­ï¼Œæ¯ä¸ªåº”ç”¨çš„å®¹å™¨æ—éƒ½ä¼šéƒ¨ç½²ä¸€ä¸ªä¼´ç”Ÿå®¹å™¨ï¼ˆå¦‚ Envoy æˆ– MOSNï¼‰ï¼Œè¿™ä¸ªå®¹å™¨ç§°ä¹‹ä¸º sidecar å®¹å™¨ã€‚Sidecar æ¥ç®¡è¿›å‡ºåº”ç”¨å®¹å™¨çš„æ‰€æœ‰æµé‡ã€‚åœ¨ Kubernetes çš„ Pod ä¸­ï¼Œåœ¨åŸæœ‰çš„åº”ç”¨å®¹å™¨æ—è¾¹æ³¨å…¥ä¸€ä¸ª Sidecar å®¹å™¨ï¼Œä¸¤ä¸ªå®¹å™¨å…±äº«å­˜å‚¨ã€ç½‘ç»œç­‰èµ„æºï¼Œå¯ä»¥å¹¿ä¹‰çš„å°†è¿™ä¸ªåŒ…å«äº† sidecar å®¹å™¨çš„ Pod ç†è§£ä¸ºä¸€å°ä¸»æœºï¼Œä¸¤ä¸ªå®¹å™¨å…±äº«ä¸»æœºèµ„æºã€‚ å› å…¶ç‹¬ç‰¹çš„éƒ¨ç½²ç»“æ„ï¼Œä½¿å¾— sidecar æ¨¡å¼å…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š å°†ä¸åº”ç”¨ä¸šåŠ¡é€»è¾‘æ— å…³çš„åŠŸèƒ½æŠ½è±¡åˆ°å…±åŒåŸºç¡€è®¾æ–½ï¼Œé™ä½äº†å¾®æœåŠ¡ä»£ç çš„å¤æ‚åº¦ã€‚ å› ä¸ºä¸å†éœ€è¦ç¼–å†™ç›¸åŒçš„ç¬¬ä¸‰æ–¹ç»„ä»¶é…ç½®æ–‡ä»¶å’Œä»£ç ï¼Œæ‰€ä»¥èƒ½å¤Ÿé™ä½å¾®æœåŠ¡æ¶æ„ä¸­çš„ä»£ç é‡å¤åº¦ã€‚ Sidecar å¯ç‹¬ç«‹å‡çº§ï¼Œé™ä½åº”ç”¨ç¨‹åºä»£ç å’Œåº•å±‚å¹³å°çš„è€¦åˆåº¦ã€‚ ","date":"2022-09-11","objectID":"/posts/fe0ba1/:2:1","tags":["istio","è½¬è½½"],"title":"Istio ä¸­çš„ Sidecar æ³¨å…¥ã€é€æ˜æµé‡åŠ«æŒåŠæµé‡è·¯ç”±è¿‡ç¨‹è¯¦è§£","uri":"/posts/fe0ba1/"},{"categories":["äº‘åŸç”Ÿ"],"content":"Sidecar æ³¨å…¥ç¤ºä¾‹åˆ†æ ä»¥ Istio å®˜æ–¹æä¾›çš„ bookinfo ä¸­ productpage çš„ YAML ä¸ºä¾‹ï¼Œå…³äº bookinfo åº”ç”¨çš„è¯¦ç»† YAML é…ç½®è¯·å‚è€ƒ bookinfo.yamlã€‚ ä¸‹æ–‡å°†ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢è®²è§£ï¼š Sidecar å®¹å™¨çš„æ³¨å…¥ iptables è§„åˆ™çš„åˆ›å»º è·¯ç”±çš„è¯¦ç»†è¿‡ç¨‹ apiVersion: apps/v1 kind: Deployment metadata: name: productpage-v1 labels: app: productpage version: v1 spec: replicas: 1 selector: matchLabels: app: productpage version: v1 template: metadata: labels: app: productpage version: v1 spec: serviceAccountName: bookinfo-productpage containers: - name: productpage image: docker.io/istio/examples-bookinfo-productpage-v1:1.15.0 imagePullPolicy: IfNotPresent ports: - containerPort: 9080 volumeMounts: - name: tmp mountPath: /tmp volumes: - name: tmp emptyDir: {} å†æŸ¥çœ‹ä¸‹ productpage å®¹å™¨çš„ Dockerfileã€‚ FROM python:3.7.4-slim COPY requirements.txt ./ RUN pip install --no-cache-dir -r requirements.txt COPY test-requirements.txt ./ RUN pip install --no-cache-dir -r test-requirements.txt COPY productpage.py /opt/microservices/ COPY tests/unit/* /opt/microservices/ COPY templates /opt/microservices/templates COPY static /opt/microservices/static COPY requirements.txt /opt/microservices/ ARG flood_factor ENV FLOOD_FACTOR ${flood_factor:-0} EXPOSE 9080 WORKDIR /opt/microservices RUN python -m unittest discover USER 1 CMD [\"python\", \"productpage.py\", \"9080\"] æˆ‘ä»¬çœ‹åˆ° Dockerfile ä¸­æ²¡æœ‰é…ç½® ENTRYPOINTï¼Œæ‰€ä»¥ CMD çš„é…ç½® python productpage.py 9080 å°†ä½œä¸ºé»˜è®¤çš„ ENTRYPOINTï¼Œè®°ä½è¿™ä¸€ç‚¹ï¼Œå†çœ‹ä¸‹æ³¨å…¥ sidecar ä¹‹åçš„é…ç½®ã€‚ $ istioctl kube-inject -f samples/bookinfo/platform/kube/bookinfo.yaml æˆ‘ä»¬åªæˆªå–å…¶ä¸­ä¸ productpage ç›¸å…³çš„ Deployment é…ç½®ä¸­çš„éƒ¨åˆ† YAML é…ç½®ã€‚ containers: - image: docker.io/istio/examples-bookinfo-productpage-v1:1.15.0 # åº”ç”¨é•œåƒ name: productpage ports: - containerPort: 9080 - args: - proxy - sidecar - --domain - $(POD_NAMESPACE).svc.cluster.local - --configPath - /etc/istio/proxy - --binaryPath - /usr/local/bin/envoy - --serviceCluster - productpage.$(POD_NAMESPACE) - --drainDuration - 45s - --parentShutdownDuration - 1m0s - --discoveryAddress - istiod.istio-system.svc:15012 - --zipkinAddress - zipkin.istio-system:9411 - --proxyLogLevel=warning - --proxyComponentLogLevel=misc:error - --connectTimeout - 10s - --proxyAdminPort - \"15000\" - --concurrency - \"2\" - --controlPlaneAuthPolicy - NONE - --dnsRefreshRate - 300s - --statusPort - \"15020\" - --trust-domain=cluster.local - --controlPlaneBootstrap=false image: docker.io/istio/proxyv2:1.5.1 # sidecar proxy name: istio-proxy ports: - containerPort: 15090 name: http-envoy-prom protocol: TCP initContainers: - command: - istio-iptables - -p - \"15001\" - -z - \"15006\" - -u - \"1337\" - -m - REDIRECT - -i - '*' - -x - \"\" - -b - '*' - -d - 15090,15020 image: docker.io/istio/proxyv2:1.5.1 # init å®¹å™¨ name: istio-init Istio ç»™åº”ç”¨ Pod æ³¨å…¥çš„é…ç½®ä¸»è¦åŒ…æ‹¬ï¼š Init å®¹å™¨ istio-initï¼šç”¨äº pod ä¸­è®¾ç½® iptables ç«¯å£è½¬å‘ Sidecar å®¹å™¨ istio-proxyï¼šè¿è¡Œ sidecar ä»£ç†ï¼Œå¦‚ Envoy æˆ– MOSNã€‚ ","date":"2022-09-11","objectID":"/posts/fe0ba1/:3:0","tags":["istio","è½¬è½½"],"title":"Istio ä¸­çš„ Sidecar æ³¨å…¥ã€é€æ˜æµé‡åŠ«æŒåŠæµé‡è·¯ç”±è¿‡ç¨‹è¯¦è§£","uri":"/posts/fe0ba1/"},{"categories":["äº‘åŸç”Ÿ"],"content":"iptables è§„åˆ™æ³¨å…¥è§£æ ä¸ºäº†æŸ¥çœ‹ iptables é…ç½®ï¼Œæˆ‘ä»¬éœ€è¦ç™»é™†åˆ° sidecar å®¹å™¨ä¸­ä½¿ç”¨ root ç”¨æˆ·æ¥æŸ¥çœ‹ï¼Œå› ä¸º kubectl æ— æ³•ä½¿ç”¨ç‰¹æƒæ¨¡å¼æ¥è¿œç¨‹æ“ä½œ docker å®¹å™¨ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç™»é™†åˆ° productpage pod æ‰€åœ¨çš„ä¸»æœºä¸Šä½¿ç”¨ docker å‘½ä»¤ç™»é™†å®¹å™¨ä¸­æŸ¥çœ‹ã€‚ å¦‚æœæ‚¨ä½¿ç”¨ minikube éƒ¨ç½²çš„ Kubernetesï¼Œå¯ä»¥ç›´æ¥ç™»å½•åˆ° minikube çš„è™šæ‹Ÿæœºä¸­å¹¶åˆ‡æ¢ä¸º root ç”¨æˆ·ã€‚æŸ¥çœ‹ iptables é…ç½®ï¼Œåˆ—å‡º NATï¼ˆç½‘ç»œåœ°å€è½¬æ¢ï¼‰è¡¨çš„æ‰€æœ‰è§„åˆ™ï¼Œå› ä¸ºåœ¨ Init å®¹å™¨å¯åŠ¨çš„æ—¶å€™é€‰æ‹©ç»™ istio-iptables ä¼ é€’çš„å‚æ•°ä¸­æŒ‡å®šå°†å…¥ç«™æµé‡é‡å®šå‘åˆ° sidecar çš„æ¨¡å¼ä¸º REDIRECTï¼Œå› æ­¤åœ¨ iptables ä¸­å°†åªæœ‰ NAT è¡¨çš„è§„æ ¼é…ç½®ï¼Œå¦‚æœé€‰æ‹© TPROXY è¿˜ä¼šæœ‰ mangle è¡¨é…ç½®ã€‚iptables å‘½ä»¤çš„è¯¦ç»†ç”¨æ³•è¯·å‚è€ƒ iptables å‘½ä»¤ã€‚ æˆ‘ä»¬ä»…æŸ¥çœ‹ä¸ productpage æœ‰å…³çš„ iptables è§„åˆ™å¦‚ä¸‹ï¼Œå› ä¸ºè¿™äº›è§„åˆ™æ˜¯è¿è¡Œåœ¨è¯¥å®¹å™¨ç‰¹å®šçš„ç½‘ç»œç©ºé—´ä¸‹ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨ nsenter å‘½ä»¤è¿›å…¥å…¶ç½‘ç»œç©ºé—´ã€‚è¿›å…¥çš„æ—¶å€™éœ€è¦æŒ‡å®šè¿›ç¨‹ IDï¼ˆPIDï¼‰ï¼Œå› æ­¤é¦–å…ˆæˆ‘ä»¬éœ€è¦æ‰¾åˆ° productpage å®¹å™¨çš„ PIDã€‚å¯¹äºåœ¨ä¸åŒå¹³å°ä¸Šå®‰è£…çš„ Kubernetesï¼ŒæŸ¥æ‰¾å®¹å™¨çš„æ–¹å¼ä¼šç•¥æœ‰ä¸åŒï¼Œä¾‹å¦‚åœ¨ GKE ä¸Šï¼Œæ‰§è¡Œ docker ps -a å‘½ä»¤æ˜¯æŸ¥çœ‹ä¸åˆ°ä»»ä½•å®¹å™¨è¿›ç¨‹çš„ã€‚ä¸‹é¢å·² minikube å’Œ GKE ä¸¤ä¸ªå…¸å‹çš„å¹³å°ä¸ºä¾‹ï¼ŒæŒ‡å¯¼ä½ å¦‚ä½•è¿›å…¥å®¹å™¨çš„ç½‘ç»œç©ºé—´ã€‚ ","date":"2022-09-11","objectID":"/posts/fe0ba1/:4:0","tags":["istio","è½¬è½½"],"title":"Istio ä¸­çš„ Sidecar æ³¨å…¥ã€é€æ˜æµé‡åŠ«æŒåŠæµé‡è·¯ç”±è¿‡ç¨‹è¯¦è§£","uri":"/posts/fe0ba1/"},{"categories":["äº‘åŸç”Ÿ"],"content":"åœ¨ minikube ä¸­æŸ¥çœ‹å®¹å™¨ä¸­çš„ iptabes è§„åˆ™ å¯¹äº minikubeï¼Œå› ä¸ºæ‰€æœ‰çš„è¿›ç¨‹éƒ½è¿è¡Œåœ¨å•ä¸ªèŠ‚ç‚¹ä¸Šï¼Œå› æ­¤ä½ åªéœ€è¦ç™»å½•åˆ° minikube è™šæ‹Ÿæœºï¼Œåˆ‡æ¢ä¸º root ç”¨æˆ·ç„¶åæŸ¥æ‰¾ productpage è¿›ç¨‹å³å¯ï¼Œå‚è€ƒä¸‹é¢çš„æ­¥éª¤ã€‚ # è¿›å…¥ minikube å¹¶åˆ‡æ¢ä¸º root ç”¨æˆ·ï¼Œminikube é»˜è®¤ç”¨æˆ·ä¸º docker $ minikube ssh $ sudo -i # æŸ¥çœ‹ productpage pod çš„ istio-proxy å®¹å™¨ä¸­çš„è¿›ç¨‹ $ docker top `docker ps|grep \"istio-proxy_productpage\"|cut -d \" \" -f1` UID PID PPID C STIME TTY TIME CMD 1337 10576 10517 0 08:09 ? 00:00:07 /usr/local/bin/pilot-agent proxy sidecar --domain default.svc.cluster.local --configPath /etc/istio/proxy --binaryPath /usr/local/bin/envoy --serviceCluster productpage.default --drainDuration 45s --parentShutdownDuration 1m0s --discoveryAddress istiod.istio-system.svc:15012 --zipkinAddress zipkin.istio-system:9411 --proxyLogLevel=warning --proxyComponentLogLevel=misc:error --connectTimeout 10s --proxyAdminPort 15000 --concurrency 2 --controlPlaneAuthPolicy NONE --dnsRefreshRate 300s --statusPort 15020 --trust-domain=cluster.local --controlPlaneBootstrap=false 1337 10660 10576 0 08:09 ? 00:00:33 /usr/local/bin/envoy -c /etc/istio/proxy/envoy-rev0.json --restart-epoch 0 --drain-time-s 45 --parent-shutdown-time-s 60 --service-cluster productpage.default --service-node sidecar~172.17.0.16~productpage-v1-7f44c4d57c-ksf9b.default~default.svc.cluster.local --max-obj-name-len 189 --local-address-ip-version v4 --log-format [Envoy (Epoch 0)] [%Y-%m-%d %T.%e][%t][%l][%n] %v -l warning --component-log-level misc:error --concurrency 2 # ä½¿ç”¨ nsenter è¿›å…¥ sidecar å®¹å™¨çš„å‘½åç©ºé—´ï¼ˆä»¥ä¸Šä»»ä½•ä¸€ä¸ªéƒ½å¯ä»¥ï¼‰ $ nsenter -n --target 10660 # æŸ¥çœ‹ NAT è¡¨ä¸­è§„åˆ™é…ç½®çš„è¯¦ç»†ä¿¡æ¯ã€‚ $ iptables -t nat -L ","date":"2022-09-11","objectID":"/posts/fe0ba1/:4:1","tags":["istio","è½¬è½½"],"title":"Istio ä¸­çš„ Sidecar æ³¨å…¥ã€é€æ˜æµé‡åŠ«æŒåŠæµé‡è·¯ç”±è¿‡ç¨‹è¯¦è§£","uri":"/posts/fe0ba1/"},{"categories":["äº‘åŸç”Ÿ"],"content":"åœ¨ GKE ä¸­æŸ¥çœ‹å®¹å™¨çš„ iptables è§„åˆ™ å¦‚æœä½ åœ¨ GKE ä¸­å®‰è£…çš„å¤šèŠ‚ç‚¹çš„ Kubernetes é›†ç¾¤ï¼Œé¦–å…ˆä½ éœ€è¦ç¡®å®šè¿™ä¸ª Pod è¿è¡Œåœ¨å“ªä¸ªèŠ‚ç‚¹ä¸Šï¼Œç„¶åç™»é™†åˆ°é‚£å°ä¸»æœºï¼Œä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æŸ¥æ‰¾è¿›ç¨‹çš„ PIDï¼Œä½ ä¼šå¾—åˆ°ç±»ä¼¼ä¸‹é¢çš„è¾“å‡ºã€‚ $ ps aux|grep \"productpage\" chronos 4268 0.0 0.6 43796 24856 ? Ss Apr22 0:00 python productpage.py 9080 chronos 4329 0.9 0.6 117524 24616 ? Sl Apr22 13:43 /usr/local/bin/python /opt/microservices/productpage.py 9080 root 361903 0.0 0.0 4536 812 pts/0 S+ 01:54 0:00 grep --colour=auto productpage ç„¶ååœ¨ç»ˆç«¯ä¸­è¾“å‡º iptables -t nat -L å³å¯æŸ¥çœ‹ iptables è§„åˆ™ã€‚ ","date":"2022-09-11","objectID":"/posts/fe0ba1/:4:2","tags":["istio","è½¬è½½"],"title":"Istio ä¸­çš„ Sidecar æ³¨å…¥ã€é€æ˜æµé‡åŠ«æŒåŠæµé‡è·¯ç”±è¿‡ç¨‹è¯¦è§£","uri":"/posts/fe0ba1/"},{"categories":["äº‘åŸç”Ÿ"],"content":"iptables æµé‡åŠ«æŒè¿‡ç¨‹è¯¦è§£ ç»è¿‡ä¸Šé¢çš„æ­¥éª¤ï¼Œä½ å·²ç»å¯ä»¥æŸ¥çœ‹åˆ° init å®¹å™¨å‘ Pod ä¸­æ³¨å…¥çš„ iptables è§„åˆ™ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ # PREROUTING é“¾ï¼šç”¨äºç›®æ ‡åœ°å€è½¬æ¢ï¼ˆDNATï¼‰ï¼Œå°†æ‰€æœ‰å…¥ç«™ TCP æµé‡è·³è½¬åˆ° ISTIO_INBOUND é“¾ä¸Šã€‚ Chain PREROUTING (policy ACCEPT 2701 packets, 162K bytes) pkts bytes target prot opt in out source destination 2701 162K ISTIO_INBOUND tcp -- any any anywhere anywhere # INPUT é“¾ï¼šå¤„ç†è¾“å…¥æ•°æ®åŒ…ï¼Œé TCP æµé‡å°†ç»§ç»­ OUTPUT é“¾ã€‚ Chain INPUT (policy ACCEPT 2701 packets, 162K bytes) pkts bytes target prot opt in out source destination # OUTPUT é“¾ï¼šå°†æ‰€æœ‰å‡ºç«™æ•°æ®åŒ…è·³è½¬åˆ° ISTIO_OUTPUT é“¾ä¸Šã€‚ Chain OUTPUT (policy ACCEPT 79 packets, 6761 bytes) pkts bytes target prot opt in out source destination 15 900 ISTIO_OUTPUT tcp -- any any anywhere anywhere # POSTROUTING é“¾ï¼šæ‰€æœ‰æ•°æ®åŒ…æµå‡ºç½‘å¡æ—¶éƒ½è¦å…ˆè¿›å…¥ POSTROUTING é“¾ï¼Œå†…æ ¸æ ¹æ®æ•°æ®åŒ…ç›®çš„åœ°åˆ¤æ–­æ˜¯å¦éœ€è¦è½¬å‘å‡ºå»ï¼Œæˆ‘ä»¬çœ‹åˆ°æ­¤å¤„æœªåšä»»ä½•å¤„ç†ã€‚ Chain POSTROUTING (policy ACCEPT 79 packets, 6761 bytes) pkts bytes target prot opt in out source destination # ISTIO_INBOUND é“¾ï¼šå°†æ‰€æœ‰å…¥ç«™æµé‡é‡å®šå‘åˆ° ISTIO_IN_REDIRECT é“¾ä¸Šã€‚ç›®çš„åœ°ä¸º 15090ï¼ˆPrometheus ä½¿ç”¨ï¼‰å’Œ 15020ï¼ˆIngress gateway ä½¿ç”¨ï¼Œç”¨äº Pilot å¥åº·æ£€æŸ¥ï¼‰ç«¯å£çš„æµé‡é™¤å¤–ï¼Œå‘é€åˆ°ä»¥ä¸Šä¸¤ä¸ªç«¯å£çš„æµé‡å°†è¿”å› iptables è§„åˆ™é“¾çš„è°ƒç”¨ç‚¹ï¼Œå³ PREROUTING é“¾çš„åç»§ POSTROUTING åç›´æ¥è°ƒç”¨åŸå§‹ç›®çš„åœ°ã€‚ Chain ISTIO_INBOUND (1 references) pkts bytes target prot opt in out source destination 0 0 RETURN tcp -- any any anywhere anywhere tcp dpt:ssh 2 120 RETURN tcp -- any any anywhere anywhere tcp dpt:15090 2699 162K RETURN tcp -- any any anywhere anywhere tcp dpt:15020 0 0 ISTIO_IN_REDIRECT tcp -- any any anywhere anywhere # ISTIO_IN_REDIRECT é“¾ï¼šå°†æ‰€æœ‰çš„å…¥ç«™æµé‡è·³è½¬åˆ°æœ¬åœ°çš„ 15006 ç«¯å£ï¼Œè‡³æ­¤æˆåŠŸçš„æ‹¦æˆªäº†æµé‡åˆ° sidecar ä»£ç†çš„ Inbound Handler ä¸­ã€‚ Chain ISTIO_IN_REDIRECT (3 references) pkts bytes target prot opt in out source destination 0 0 REDIRECT tcp -- any any anywhere anywhere redir ports 15006 # ISTIO_OUTPUT é“¾ï¼šè§„åˆ™æ¯”è¾ƒå¤æ‚ï¼Œå°†åœ¨ä¸‹æ–‡è§£é‡Š Chain ISTIO_OUTPUT (1 references) pkts bytes target prot opt in out source destination 0 0 RETURN all -- any lo 127.0.0.6 anywhere #è§„åˆ™1 0 0 ISTIO_IN_REDIRECT all -- any lo anywhere !localhost owner UID match 1337 #è§„åˆ™2 0 0 RETURN all -- any lo anywhere anywhere ! owner UID match 1337 #è§„åˆ™3 15 900 RETURN all -- any any anywhere anywhere owner UID match 1337 #è§„åˆ™4 0 0 ISTIO_IN_REDIRECT all -- any lo anywhere !localhost owner GID match 1337 #è§„åˆ™5 0 0 RETURN all -- any lo anywhere anywhere ! owner GID match 1337 #è§„åˆ™6 0 0 RETURN all -- any any anywhere anywhere owner GID match 1337 #è§„åˆ™7 0 0 RETURN all -- any any anywhere localhost #è§„åˆ™8 0 0 ISTIO_REDIRECT all -- any any anywhere anywhere #è§„åˆ™9 # ISTIO_REDIRECT é“¾ï¼šå°†æ‰€æœ‰æµé‡é‡å®šå‘åˆ° Envoy ä»£ç†çš„ 15001 ç«¯å£ã€‚ Chain ISTIO_REDIRECT (1 references) pkts bytes target prot opt in out source destination 0 0 REDIRECT tcp -- any any anywhere anywhere redir ports 15001 è¿™é‡Œç€é‡éœ€è¦è§£é‡Šçš„æ˜¯ ISTIO_OUTPUT é“¾ä¸­çš„ 9 æ¡è§„åˆ™ï¼Œä¸ºäº†ä¾¿äºé˜…è¯»ï¼Œæˆ‘å°†ä»¥ä¸Šè§„åˆ™ä¸­çš„éƒ¨åˆ†å†…å®¹ä½¿ç”¨è¡¨æ ¼çš„å½¢å¼æ¥å±•ç¤ºå¦‚ä¸‹ï¼š è§„åˆ™ target in out source destination 1 RETURN any lo 127.0.0.6 anywhere 2 ISTIO_IN_REDIRECT any lo anywhere !localhost owner UID match 1337 3 RETURN any lo anywhere anywhere !owner UID match 1337 4 RETURN any any anywhere anywhere owner UID match 1337 5 ISTIO_IN_REDIRECT any lo anywhere !localhost owner GID match 1337 6 RETURN any lo anywhere anywhere !owner GID match 1337 7 RETURN any any anywhere anywhere owner GID match 1337 8 RETURN any any anywhere localhost 9 ISTIO_REDIRECT any any anywhere anywhere ä¸‹å›¾å±•ç¤ºäº† ISTIO_ROUTE è§„åˆ™çš„è¯¦ç»†æµç¨‹ã€‚ æˆ‘å°†æŒ‰ç…§è§„åˆ™çš„å‡ºç°é¡ºåºæ¥è§£é‡Šæ¯æ¡è§„åˆ™çš„ç›®çš„ã€å¯¹åº”æ–‡ç« å¼€å¤´å›¾ç¤ºä¸­çš„æ­¥éª¤åŠè¯¦æƒ…ã€‚å…¶ä¸­è§„åˆ™ 5ã€6ã€7 æ˜¯åˆ†åˆ«å¯¹è§„åˆ™ 2ã€3ã€4 çš„åº”ç”¨èŒƒå›´æ‰©å¤§ï¼ˆä» UID æ‰©å¤§ä¸º GIDï¼‰ï¼Œä½œç”¨æ˜¯ç±»ä¼¼çš„ï¼Œå°†åˆå¹¶è§£é‡Šã€‚æ³¨æ„ï¼Œå…¶ä¸­çš„è§„åˆ™æ˜¯æŒ‰é¡ºåºæ‰§è¡Œçš„ï¼Œä¹Ÿå°±æ˜¯è¯´æ’åºè¶Šé åçš„è§„åˆ™å°†ä½œä¸ºé»˜è®¤å€¼ã€‚å‡ºç«™ç½‘å¡ï¼ˆoutï¼‰ä¸º lo ï¼ˆæœ¬åœ°å›ç¯åœ°å€ï¼Œloopback æ¥å£ï¼‰æ—¶ï¼Œè¡¨ç¤ºæµé‡çš„ç›®çš„åœ°æ˜¯æœ¬åœ° Podï¼Œå¯¹äº Pod å‘å¤–éƒ¨å‘é€çš„æµé‡å°±ä¸ä¼šç»è¿‡è¿™ä¸ªæ¥å£ã€‚æ‰€æœ‰ review Pod çš„å‡ºç«™æµé‡åªé€‚ç”¨äºè§„åˆ™ 4ã€7ã€8ã€9ã€‚ è§„åˆ™ 1 ç›®çš„ï¼šé€ä¼  Envoy ä»£ç†å‘é€åˆ°æœ¬åœ°åº”ç”¨å®¹å™¨çš„æµé‡ï¼Œä½¿å…¶ç»•è¿‡ Envoy ä»£ç†ï¼Œç›´è¾¾åº”ç”¨å®¹å™¨ã€‚ å¯¹åº”å›¾ç¤ºä¸­çš„æ­¥éª¤ï¼š6 åˆ° 7ã€‚ è¯¦æƒ…ï¼šè¯¥è§„åˆ™ä½¿å¾—æ‰€æœ‰æ¥è‡ª 127.0.0.6ï¼ˆè¯¥ IP åœ°å€å°†åœ¨ä¸‹æ–‡è§£é‡Šï¼‰ çš„è¯·æ±‚ï¼Œè·³å‡ºè¯¥é“¾ï¼Œè¿”å› iptables çš„è°ƒç”¨ç‚¹ï¼ˆå³ OUTPUTï¼‰åç»§ç»­æ‰§è¡Œå…¶ä½™è·¯ç”±è§„åˆ™ï¼Œå³ POSTROUTING è§„åˆ™ï¼ŒæŠŠæµé‡å‘é€åˆ°ä»»æ„ç›®çš„åœ°å€ï¼Œå¦‚æœ¬åœ° Pod å†…çš„åº”ç”¨å®¹å™¨ã€‚å¦‚æœæ²¡æœ‰è¿™æ¡è§„åˆ™ï¼Œç”± Pod å†… Envoy ä»£ç†å‘å‡ºçš„å¯¹ Pod å†…å®¹å™¨è®¿é—®çš„æµé‡å°†ä¼šæ‰§è¡Œä¸‹ä¸€æ¡è§„åˆ™ï¼Œå³è§„åˆ™ 2ï¼Œæµé‡å°†å†æ¬¡è¿›å…¥åˆ°äº† Inbound Handler ä¸­ï¼Œä»è€Œå½¢æˆäº†æ­»å¾ªç¯ã€‚å°†è¿™æ¡è§„åˆ™æ”¾åœ¨ç¬¬ä¸€ä½å¯ä»¥é¿å…æµé‡åœ¨ Inbound Handler ä¸­æ­»å¾ªç¯çš„é—®é¢˜ã€‚ è§„åˆ™ 2ã€5 ç›®çš„ï¼šå¤„ç† Envoy ä»£ç†å‘å‡ºçš„ç«™å†…æµé‡ï¼ˆPod å†…éƒ¨çš„æµé‡ï¼‰ï¼Œä½†ä¸æ˜¯å¯¹ localhost çš„è¯·æ±‚ï¼Œé€šè¿‡åç»­è§„åˆ™å°†å…¶è½¬å‘ç»™ Envoy ä»£ç†çš„ Inbound Handlerã€‚è¯¥è§„åˆ™é€‚ç”¨äº Pod å¯¹è‡ªèº« IP åœ°å€è°ƒç”¨çš„åœºæ™¯ï¼Œå³ Pod å†…æœåŠ¡ä¹‹é—´çš„è®¿é—®ã€‚ è¯¦æƒ…ï¼šå¦‚æœæµé‡çš„ç›®çš„åœ°é localhostï¼Œä¸”æ•°æ®åŒ…æ˜¯ç”± 1337 UIDï¼ˆå³ istio-proxy ç”¨æˆ·ï¼ŒEnvoy ä»£ç†ï¼‰å‘å‡ºçš„ï¼Œæµé‡å°†è¢«ç»è¿‡ ISTIO_IN_REDIRECT æœ€ç»ˆè½¬å‘åˆ° Envoy çš„ Inbound Handlerã€‚ è§„åˆ™ 3ã€6 ç›®çš„ï¼šé€ä¼  Pod å†…","date":"2022-09-11","objectID":"/posts/fe0ba1/:5:0","tags":["istio","è½¬è½½"],"title":"Istio ä¸­çš„ Sidecar æ³¨å…¥ã€é€æ˜æµé‡åŠ«æŒåŠæµé‡è·¯ç”±è¿‡ç¨‹è¯¦è§£","uri":"/posts/fe0ba1/"},{"categories":["äº‘åŸç”Ÿ"],"content":"æµé‡è·¯ç”±è¿‡ç¨‹è¯¦è§£ é€šè¿‡ä¸Šæ–‡ï¼Œä½ å·²ç»äº†è§£äº† Istio æ˜¯å¦‚ä½•åœ¨ Pod ä¸­åšé€æ˜æµé‡åŠ«æŒçš„ï¼Œé‚£ä¹ˆæµé‡è¢«åŠ«æŒåˆ° Envoy ä»£ç†ä¸­ä¹‹åæ˜¯å¦‚ä½•è¢«å¤„ç†çš„å‘¢ï¼Ÿæµé‡è·¯ç”±åˆ†ä¸º Inbound å’Œ Outbound ä¸¤ä¸ªè¿‡ç¨‹ï¼Œä¸‹é¢å°†æ ¹æ®ä¸Šæ–‡ä¸­çš„ç¤ºä¾‹åŠ sidecar çš„é…ç½®ä¸ºè¯»è€…è¯¦ç»†åˆ†ææ­¤è¿‡ç¨‹ã€‚ ","date":"2022-09-11","objectID":"/posts/fe0ba1/:6:0","tags":["istio","è½¬è½½"],"title":"Istio ä¸­çš„ Sidecar æ³¨å…¥ã€é€æ˜æµé‡åŠ«æŒåŠæµé‡è·¯ç”±è¿‡ç¨‹è¯¦è§£","uri":"/posts/fe0ba1/"},{"categories":["äº‘åŸç”Ÿ"],"content":"ç†è§£ Inbound Handler Inbound Handler çš„ä½œç”¨æ˜¯å°† iptables æ‹¦æˆªåˆ°çš„ downstream çš„æµé‡è½¬å‘ç»™ Pod å†…çš„åº”ç”¨ç¨‹åºå®¹å™¨ã€‚åœ¨æˆ‘ä»¬çš„å®ä¾‹ä¸­ï¼Œå‡è®¾å…¶ä¸­ä¸€ä¸ª Pod çš„åå­—æ˜¯ reviews-v1-545db77b95-jkgv2ï¼Œè¿è¡Œ istioctl proxy-config listener reviews-v1-545db77b95-jkgv2 --port 15006 æŸ¥çœ‹è¯¥ Pod ä¸­ 15006 ç«¯å£ä¸Šçš„ç›‘å¬å™¨æƒ…å†µ ï¼Œä½ å°†çœ‹åˆ°ä¸‹é¢çš„è¾“å‡ºã€‚ ADDRESS PORT MATCH DESTINATION 0.0.0.0 15006 Addr: *:15006 Non-HTTP/Non-TCP 0.0.0.0 15006 Trans: tls; App: istio-http/1.0,istio-http/1.1,istio-h2; Addr: 0.0.0.0/0 InboundPassthroughClusterIpv4 0.0.0.0 15006 Trans: raw_buffer; App: http/1.1,h2c; Addr: 0.0.0.0/0 InboundPassthroughClusterIpv4 0.0.0.0 15006 Trans: tls; App: TCP TLS; Addr: 0.0.0.0/0 InboundPassthroughClusterIpv4 0.0.0.0 15006 Trans: raw_buffer; Addr: 0.0.0.0/0 InboundPassthroughClusterIpv4 0.0.0.0 15006 Trans: tls; Addr: 0.0.0.0/0 InboundPassthroughClusterIpv4 0.0.0.0 15006 Trans: tls; App: istio,istio-peer-exchange,istio-http/1.0,istio-http/1.1,istio-h2; Addr: *:9080 Cluster: inbound|9080|| 0.0.0.0 15006 Trans: raw_buffer; Addr: *:9080 Cluster: inbound|9080|| ä¸‹é¢åˆ—å‡ºäº†ä»¥ä¸Šè¾“å‡ºä¸­å„å­—æ®µçš„å«ä¹‰ï¼š ADDRESSï¼šä¸‹æ¸¸åœ°å€ PORTï¼šEnvoy ç›‘å¬å™¨ç›‘å¬çš„ç«¯å£ MATCHï¼šè¯·æ±‚ä½¿ç”¨çš„ä¼ è¾“åè®®æˆ–åŒ¹é…çš„ä¸‹æ¸¸åœ°å€ DESTINATIONï¼šè·¯ç”±ç›®çš„åœ° reviews Pod ä¸­çš„ Iptables å°†å…¥ç«™æµé‡åŠ«æŒåˆ° 15006 ç«¯å£ä¸Šï¼Œä»ä¸Šé¢çš„è¾“å‡ºæˆ‘ä»¬å¯ä»¥çœ‹åˆ° Envoy çš„ Inbound Handler åœ¨ 15006 ç«¯å£ä¸Šç›‘å¬ï¼Œå¯¹ç›®çš„åœ°ä¸ºä»»ä½• IP çš„ 9080 ç«¯å£çš„è¯·æ±‚å°†è·¯ç”±åˆ° inbound|9080|| Cluster ä¸Šã€‚ ä»è¯¥ Pod çš„ Listener åˆ—è¡¨çš„æœ€åä¸¤è¡Œä¸­å¯ä»¥çœ‹åˆ°ï¼Œ0.0.0.0:15006/TCP çš„ Listenerï¼ˆå…¶å®é™…åå­—æ˜¯ virtualInboundï¼‰ç›‘å¬æ‰€æœ‰çš„ Inbound æµé‡ï¼Œå…¶ä¸­åŒ…å«äº†åŒ¹é…è§„åˆ™ï¼Œæ¥è‡ªä»»æ„ IP çš„å¯¹ 9080 ç«¯å£çš„è®¿é—®æµé‡ï¼Œå°†ä¼šè·¯ç”±åˆ° inbound|9080|| Clusterï¼Œå¦‚æœä½ æƒ³ä»¥ Json æ ¼å¼æŸ¥çœ‹è¯¥ Listener çš„è¯¦ç»†é…ç½®ï¼Œå¯ä»¥æ‰§è¡Œ istioctl proxy-config listeners reviews-v1-545db77b95-jkgv2 --port 15006 -o json å‘½ä»¤ï¼Œä½ å°†è·å¾—ç±»ä¼¼ä¸‹é¢çš„è¾“å‡ºã€‚ [ /*çœç•¥éƒ¨åˆ†å†…å®¹*/ { \"name\": \"virtualInbound\", \"address\": { \"socketAddress\": { \"address\": \"0.0.0.0\", \"portValue\": 15006 } }, \"filterChains\": [ /*çœç•¥éƒ¨åˆ†å†…å®¹*/ { \"filterChainMatch\": { \"destinationPort\": 9080, \"transportProtocol\": \"tls\", \"applicationProtocols\": [ \"istio\", \"istio-peer-exchange\", \"istio-http/1.0\", \"istio-http/1.1\", \"istio-h2\" ] }, \"filters\": [ /*çœç•¥éƒ¨åˆ†å†…å®¹*/ { \"name\": \"envoy.filters.network.http_connection_manager\", \"typedConfig\": { \"@type\": \"type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager\", \"statPrefix\": \"inbound_0.0.0.0_9080\", \"routeConfig\": { \"name\": \"inbound|9080||\", \"virtualHosts\": [ { \"name\": \"inbound|http|9080\", \"domains\": [ \"*\" ], \"routes\": [ { \"name\": \"default\", \"match\": { \"prefix\": \"/\" }, \"route\": { \"cluster\": \"inbound|9080||\", \"timeout\": \"0s\", \"maxStreamDuration\": { \"maxStreamDuration\": \"0s\", \"grpcTimeoutHeaderMax\": \"0s\" } }, \"decorator\": { \"operation\": \"reviews.default.svc.cluster.local:9080/*\" } } ] } ], \"validateClusters\": false }, /*çœç•¥éƒ¨åˆ†å†…å®¹*/ } } ], /*çœç•¥éƒ¨åˆ†å†…å®¹*/ ], \"listenerFilters\": [ /*çœç•¥éƒ¨åˆ†å†…å®¹*/ ], \"listenerFiltersTimeout\": \"0s\", \"continueOnListenerFiltersTimeout\": true, \"trafficDirection\": \"INBOUND\" } ] æ—¢ç„¶ Inbound Handler çš„æµé‡ä¸­å°†æ¥è‡ªä»»æ„åœ°å€çš„å¯¹è¯¥ Pod 9080 ç«¯å£çš„æµé‡è·¯ç”±åˆ° inbound|9080|| Clusterï¼Œé‚£ä¹ˆæˆ‘ä»¬è¿è¡Œ istioctl pc cluster reviews-v1-545db77b95-jkgv2 --port 9080 --direction inbound -o json æŸ¥çœ‹ä¸‹è¯¥ Cluster é…ç½®ï¼Œä½ å°†è·å¾—ç±»ä¼¼ä¸‹é¢çš„è¾“å‡ºã€‚ [ { \"name\": \"inbound|9080||\", \"type\": \"ORIGINAL_DST\", \"connectTimeout\": \"10s\", \"lbPolicy\": \"CLUSTER_PROVIDED\", \"circuitBreakers\": { \"thresholds\": [ { \"maxConnections\": 4294967295, \"maxPendingRequests\": 4294967295, \"maxRequests\": 4294967295, \"maxRetries\": 4294967295, \"trackRemaining\": true } ] }, \"cleanupInterval\": \"60s\", \"upstreamBindConfig\": { \"sourceAddress\": { \"address\": \"127.0.0.6\", \"portValue\": 0 } }, \"metadata\": { \"filterMetadata\": { \"istio\": { \"services\": [ { \"host\": \"reviews.default.svc.cluster.local\", \"name\": \"reviews\", \"namespace\": \"default\" } ] } } } } ] æˆ‘ä»¬çœ‹å…¶ä¸­çš„ TYPE ä¸º ORIGINAL_DSTï¼Œå°†æµé‡å‘é€åˆ°åŸå§‹ç›®æ ‡åœ°å€ï¼ˆPod IPï¼‰ï¼Œå› ä¸ºåŸå§‹ç›®æ ‡åœ°å€å³å½“å‰ Podï¼Œä½ è¿˜åº”è¯¥æ³¨æ„åˆ° upstreamBindConfig.sourceAddress.address çš„å€¼è¢«æ”¹å†™ä¸ºäº† 127.0.0.6ï¼Œè€Œä¸”å¯¹äº Pod å†…æµé‡æ˜¯é€šè¿‡ lo ç½‘å¡å‘é€çš„ï¼Œè¿™åˆšå¥½å‘¼åº”äº†ä¸Šæ–‡ä¸­çš„ iptables ISTIO_OUTPUT é“¾ä¸­çš„ç¬¬ä¸€æ¡è§„åˆ™ï¼Œæ ¹æ®è¯¥è§„åˆ™ï¼Œæµé‡å°†è¢«é€ä¼ åˆ° Pod å†…çš„åº”ç”¨å®¹å™¨ã€‚ ","date":"2022-09-11","objectID":"/posts/fe0ba1/:6:1","tags":["istio","è½¬è½½"],"title":"Istio ä¸­çš„ Sidecar æ³¨å…¥ã€é€æ˜æµé‡åŠ«æŒåŠæµé‡è·¯ç”±è¿‡ç¨‹è¯¦è§£","uri":"/posts/fe0ba1/"},{"categories":["äº‘åŸç”Ÿ"],"content":"ç†è§£ Outbound Handler åœ¨æœ¬ç¤ºä¾‹ä¸­ reviews ä¼šå‘ ratings æœåŠ¡å‘é€ HTTP è¯·æ±‚ï¼Œè¯·æ±‚çš„åœ°å€æ˜¯ï¼šhttp://ratings.default.svc.cluster.local:9080/ï¼ŒOutbound Handler çš„ä½œç”¨æ˜¯å°† iptables æ‹¦æˆªåˆ°çš„æœ¬åœ°åº”ç”¨ç¨‹åºå‘å¤–å‘å‡ºçš„æµé‡ï¼Œç»ç”± Envoy ä»£ç†è·¯ç”±åˆ°ä¸Šæ¸¸ã€‚ Envoy ç›‘å¬åœ¨ 15001 ç«¯å£ä¸Šç›‘å¬æ‰€æœ‰ Outbound æµé‡ï¼ŒOutbound Handler å¤„ç†ï¼Œç„¶åç»è¿‡ virtualOutbound Listenerã€0.0.0.0_9080 Listenerï¼Œç„¶åé€šè¿‡ Route 9080 æ‰¾åˆ°ä¸Šæ¸¸çš„ clusterï¼Œè¿›è€Œé€šè¿‡ EDS æ‰¾åˆ° Endpoint æ‰§è¡Œè·¯ç”±åŠ¨ä½œã€‚ ratings.default.svc.cluster.local:9080 è·¯ç”± è¿è¡Œ istioctl proxy-config routes reviews-v1-545db77b95-jkgv2 --name 9080 -o json æŸ¥çœ‹ route é…ç½®ï¼Œå› ä¸º sidecar ä¼šæ ¹æ® HTTP header ä¸­çš„ domains æ¥åŒ¹é… VirtualHostï¼Œæ‰€ä»¥ä¸‹é¢åªåˆ—ä¸¾äº† ratings.default.svc.cluster.local:9080 è¿™ä¸€ä¸ª VirtualHostã€‚ [ { \"name\": \"9080\", \"virtualHosts\": [ { \"name\": \"ratings.default.svc.cluster.local:9080\", \"domains\": [ \"ratings.default.svc.cluster.local\", \"ratings.default.svc.cluster.local:9080\", \"ratings\", \"ratings:9080\", \"ratings.default.svc\", \"ratings.default.svc:9080\", \"ratings.default\", \"ratings.default:9080\", \"10.8.8.106\", \"10.8.8.106:9080\" ], \"routes\": [ { \"name\": \"default\", \"match\": { \"prefix\": \"/\" }, \"route\": { \"cluster\": \"outbound|9080||ratings.default.svc.cluster.local\", \"timeout\": \"0s\", \"retryPolicy\": { \"retryOn\": \"connect-failure,refused-stream,unavailable,cancelled,retriable-status-codes\", \"numRetries\": 2, \"retryHostPredicate\": [ { \"name\": \"envoy.retry_host_predicates.previous_hosts\" } ], \"hostSelectionRetryMaxAttempts\": \"5\", \"retriableStatusCodes\": [ 503 ] }, \"maxStreamDuration\": { \"maxStreamDuration\": \"0s\", \"grpcTimeoutHeaderMax\": \"0s\" } }, \"decorator\": { \"operation\": \"ratings.default.svc.cluster.local:9080/*\" } } ], \"includeRequestAttemptCount\": true }, /*çœç•¥éƒ¨åˆ†å†…å®¹*/ ], \"validateClusters\": false } ] ä»è¯¥ Virtual Host é…ç½®ä¸­å¯ä»¥çœ‹åˆ°å°†æµé‡è·¯ç”±åˆ°outbound|9080||ratings.default.svc.cluster.local é›†ç¾¤ã€‚ outbound|9080||ratings.default.svc.cluster.local é›†ç¾¤çš„ç«¯ç‚¹ è¿è¡Œ istioctl proxy-config endpoint reviews-v1-545db77b95-jkgv2 --port 9080 -o json --cluster \"outbound|9080||ratings.default.svc.cluster.local\" æŸ¥çœ‹é›†ç¾¤çš„ Endpoint é…ç½®ï¼Œç»“æœå¦‚ä¸‹ã€‚ [ { \"name\": \"outbound|9080||ratings.default.svc.cluster.local\", \"addedViaApi\": true, \"hostStatuses\": [ { \"address\": { \"socketAddress\": { \"address\": \"10.4.1.12\", \"portValue\": 9080 } }, \"stats\": [ { \"name\": \"cx_connect_fail\" }, { \"name\": \"cx_total\" }, { \"name\": \"rq_error\" }, { \"name\": \"rq_success\" }, { \"name\": \"rq_timeout\" }, { \"name\": \"rq_total\" }, { \"type\": \"GAUGE\", \"name\": \"cx_active\" }, { \"type\": \"GAUGE\", \"name\": \"rq_active\" } ], \"healthStatus\": { \"edsHealthStatus\": \"HEALTHY\" }, \"weight\": 1, \"locality\": { \"region\": \"us-west2\", \"zone\": \"us-west2-a\" } } ], \"circuitBreakers\": { \"thresholds\": [ { \"maxConnections\": 4294967295, \"maxPendingRequests\": 4294967295, \"maxRequests\": 4294967295, \"maxRetries\": 4294967295 }, { \"priority\": \"HIGH\", \"maxConnections\": 1024, \"maxPendingRequests\": 1024, \"maxRequests\": 1024, \"maxRetries\": 3 } ] }, \"observabilityName\": \"outbound|9080||ratings.default.svc.cluster.local\" } ] æˆ‘ä»¬çœ‹åˆ°ç«¯ç‚¹çš„åœ°å€æ˜¯ 10.4.1.12ã€‚å®é™…ä¸Šï¼ŒEndpoint å¯ä»¥æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªï¼Œsidecar å°†æ ¹æ®ä¸€å®šè§„åˆ™é€‰æ‹©é€‚å½“çš„ Endpoint æ¥è·¯ç”±ã€‚è‡³æ­¤ review Podæ‰¾åˆ°äº†å®ƒä¸Šæ¸¸æœåŠ¡ rating çš„ Endpointã€‚ ","date":"2022-09-11","objectID":"/posts/fe0ba1/:6:2","tags":["istio","è½¬è½½"],"title":"Istio ä¸­çš„ Sidecar æ³¨å…¥ã€é€æ˜æµé‡åŠ«æŒåŠæµé‡è·¯ç”±è¿‡ç¨‹è¯¦è§£","uri":"/posts/fe0ba1/"},{"categories":["äº‘åŸç”Ÿ"],"content":"å°ç»“ æœ¬æ–‡ä½¿ç”¨äº† Istio å®˜æ–¹æä¾›çš„ bookinfo ç¤ºä¾‹ï¼ŒæŒ‰å›¾ç´¢éª¥å¾—å¸¦é¢†è¯»è€…äº†è§£äº† sidecar æ³¨å…¥ã€iptables é€æ˜æµé‡åŠ«æŒåŠ sidecar ä¸­æµé‡è·¯ç”±èƒŒåçš„å®ç°ç»†èŠ‚ã€‚Sidecar æ¨¡å¼å’Œæµé‡é€æ˜åŠ«æŒæ˜¯ Istio æœåŠ¡ç½‘æ ¼çš„ç‰¹è‰²å’ŒåŸºç¡€åŠŸèƒ½ï¼Œç†è§£è¯¥åŠŸèƒ½çš„èƒŒåè¿‡ç¨‹åŠå®ç°ç»†èŠ‚ï¼Œå°†æœ‰åŠ©äºå¤§å®¶ç†è§£ Service Mesh çš„åŸç†å’Œ Istio Handbook åé¢ç« èŠ‚ä¸­çš„å†…å®¹ï¼Œå› æ­¤å¸Œæœ›è¯»è€…å¯ä»¥åœ¨è‡ªå·±çš„ç¯å¢ƒä¸­ä»å¤´æ¥è¯•éªŒä¸€éä»¥åŠ æ·±ç†è§£ã€‚ ä½¿ç”¨ iptables åšæµé‡åŠ«æŒåªæ˜¯ service mesh çš„æ•°æ®å¹³é¢ä¸­åšæµé‡åŠ«æŒçš„æ–¹å¼ä¹‹ä¸€ï¼Œè¿˜æœ‰æ›´å¤šçš„æµé‡åŠ«æŒæ–¹æ¡ˆï¼Œä¸‹é¢å¼•ç”¨è‡ª äº‘åŸç”Ÿç½‘ç»œä»£ç† MOSN å®˜ç½‘ä¸­ç»™å‡ºçš„æµé‡åŠ«æŒéƒ¨åˆ†çš„æè¿°ã€‚ ","date":"2022-09-11","objectID":"/posts/fe0ba1/:7:0","tags":["istio","è½¬è½½"],"title":"Istio ä¸­çš„ Sidecar æ³¨å…¥ã€é€æ˜æµé‡åŠ«æŒåŠæµé‡è·¯ç”±è¿‡ç¨‹è¯¦è§£","uri":"/posts/fe0ba1/"},{"categories":["äº‘åŸç”Ÿ"],"content":"ä½¿ç”¨ iptables åšæµé‡åŠ«æŒæ—¶å­˜åœ¨çš„é—®é¢˜ ç›®å‰ Istio ä½¿ç”¨ iptables å®ç°é€æ˜åŠ«æŒï¼Œä¸»è¦å­˜åœ¨ä»¥ä¸‹ä¸‰ä¸ªé—®é¢˜ï¼š éœ€è¦å€ŸåŠ©äº conntrack æ¨¡å—å®ç°è¿æ¥è·Ÿè¸ªï¼Œåœ¨è¿æ¥æ•°è¾ƒå¤šçš„æƒ…å†µä¸‹ï¼Œä¼šé€ æˆè¾ƒå¤§çš„æ¶ˆè€—ï¼ŒåŒæ—¶å¯èƒ½ä¼šé€ æˆ track è¡¨æ»¡çš„æƒ…å†µï¼Œä¸ºäº†é¿å…è¿™ä¸ªé—®é¢˜ï¼Œä¸šå†…æœ‰å…³é—­ conntrack çš„åšæ³•ã€‚ iptables å±äºå¸¸ç”¨æ¨¡å—ï¼Œå…¨å±€ç”Ÿæ•ˆï¼Œä¸èƒ½æ˜¾å¼çš„ç¦æ­¢ç›¸å…³è”çš„ä¿®æ”¹ï¼Œå¯ç®¡æ§æ€§æ¯”è¾ƒå·®ã€‚ iptables é‡å®šå‘æµé‡æœ¬è´¨ä¸Šæ˜¯é€šè¿‡ loopback äº¤æ¢æ•°æ®ï¼Œoutbond æµé‡å°†ä¸¤æ¬¡ç©¿è¶Šåè®®æ ˆï¼Œåœ¨å¤§å¹¶å‘åœºæ™¯ä¸‹ä¼šæŸå¤±è½¬å‘æ€§èƒ½ã€‚ ä¸Šè¿°å‡ ä¸ªé—®é¢˜å¹¶éåœ¨æ‰€æœ‰åœºæ™¯ä¸­éƒ½å­˜åœ¨ï¼Œæ¯”æ–¹è¯´æŸäº›åœºæ™¯ä¸‹ï¼Œè¿æ¥æ•°å¹¶ä¸å¤šï¼Œä¸” NAT è¡¨æœªè¢«ä½¿ç”¨åˆ°çš„æƒ…å†µä¸‹ï¼Œiptables æ˜¯ä¸€ä¸ªæ»¡è¶³è¦æ±‚çš„ç®€å•æ–¹æ¡ˆã€‚ä¸ºäº†é€‚é…æ›´åŠ å¹¿æ³›çš„åœºæ™¯ï¼Œé€æ˜åŠ«æŒéœ€è¦è§£å†³ä¸Šè¿°ä¸‰ä¸ªé—®é¢˜ã€‚ ","date":"2022-09-11","objectID":"/posts/fe0ba1/:7:1","tags":["istio","è½¬è½½"],"title":"Istio ä¸­çš„ Sidecar æ³¨å…¥ã€é€æ˜æµé‡åŠ«æŒåŠæµé‡è·¯ç”±è¿‡ç¨‹è¯¦è§£","uri":"/posts/fe0ba1/"},{"categories":["äº‘åŸç”Ÿ"],"content":"é€æ˜åŠ«æŒæ–¹æ¡ˆä¼˜åŒ– ä¸ºäº†ä¼˜åŒ– Istio ä¸­çš„é€æ˜æµé‡åŠ«æŒçš„æ€§èƒ½ï¼Œä¸šç•Œæå‡ºäº†ä»¥ä¸‹æ–¹æ¡ˆã€‚ ä½¿ç”¨ Merbridge å¼€æºé¡¹ç›®åˆ©ç”¨ eBPF åŠ«æŒæµé‡ Merbridge æ˜¯ç”± DaoCloud åœ¨ 2022 å¹´åˆå¼€æºçš„çš„ä¸€æ¬¾åˆ©ç”¨ eBPF åŠ é€Ÿ Istio æœåŠ¡ç½‘æ ¼çš„æ’ä»¶ã€‚ä½¿ç”¨ Merbridge å¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šä¼˜åŒ–æ•°æ®å¹³é¢çš„ç½‘ç»œæ€§èƒ½ã€‚ Merbridge åˆ©ç”¨ eBPF çš„ sockops å’Œ redir èƒ½åŠ›ï¼Œå¯ä»¥ç›´æ¥å°†æ•°æ®åŒ…ä» inbound socket ä¼ è¾“åˆ° outbound socketã€‚eBPF æä¾›äº† bpf_msg_redirect_hash å‡½æ•°å¯ä»¥ç›´æ¥è½¬å‘åº”ç”¨ç¨‹åºçš„æ•°æ®åŒ…ã€‚ è¯¦è§ Istio æœåŠ¡ç½‘æ ¼ â€”â€” äº‘åŸç”Ÿåº”ç”¨ç½‘ç»œæ„å»ºæŒ‡å—ã€‚ ä½¿ç”¨ tproxy å¤„ç† inbound æµé‡ tproxy å¯ä»¥ç”¨äº inbound æµé‡çš„é‡å®šå‘ï¼Œä¸”æ— éœ€æ”¹å˜æŠ¥æ–‡ä¸­çš„ç›®çš„ IP/ç«¯å£ï¼Œä¸éœ€è¦æ‰§è¡Œè¿æ¥è·Ÿè¸ªï¼Œä¸ä¼šå‡ºç° conntrack æ¨¡å—åˆ›å»ºå¤§é‡è¿æ¥çš„é—®é¢˜ã€‚å—é™äºå†…æ ¸ç‰ˆæœ¬ï¼Œtproxy åº”ç”¨äº outbound å­˜åœ¨ä¸€å®šç¼ºé™·ã€‚ç›®å‰ Istio æ”¯æŒé€šè¿‡ tproxy å¤„ç† inbound æµé‡ã€‚ ä½¿ç”¨ hook connect å¤„ç† outbound æµé‡ ä¸ºäº†é€‚é…æ›´å¤šåº”ç”¨åœºæ™¯ï¼Œoutbound æ–¹å‘é€šè¿‡ hook connect æ¥å®ç°ï¼Œå®ç°åŸç†å¦‚ä¸‹ï¼š hook-connect åŸç†ç¤ºæ„å›¾ æ— è®ºé‡‡ç”¨å“ªç§é€æ˜åŠ«æŒæ–¹æ¡ˆï¼Œå‡éœ€è¦è§£å†³è·å–çœŸå®ç›®çš„ IP/ç«¯å£çš„é—®é¢˜ï¼Œä½¿ç”¨ iptables æ–¹æ¡ˆé€šè¿‡ getsockopt æ–¹å¼è·å–ï¼Œtproxy å¯ä»¥ç›´æ¥è¯»å–ç›®çš„åœ°å€ï¼Œé€šè¿‡ä¿®æ”¹è°ƒç”¨æ¥å£ï¼Œhook connect æ–¹æ¡ˆè¯»å–æ–¹å¼ç±»ä¼¼äº tproxyã€‚ å®ç°é€æ˜åŠ«æŒåï¼Œåœ¨å†…æ ¸ç‰ˆæœ¬æ»¡è¶³è¦æ±‚ï¼ˆ4.16ä»¥ä¸Šï¼‰çš„å‰æä¸‹ï¼Œé€šè¿‡ sockmap å¯ä»¥ç¼©çŸ­æŠ¥æ–‡ç©¿è¶Šè·¯å¾„ï¼Œè¿›è€Œæ”¹å–„ outbound æ–¹å‘çš„è½¬å‘æ€§èƒ½ã€‚ ","date":"2022-09-11","objectID":"/posts/fe0ba1/:7:2","tags":["istio","è½¬è½½"],"title":"Istio ä¸­çš„ Sidecar æ³¨å…¥ã€é€æ˜æµé‡åŠ«æŒåŠæµé‡è·¯ç”±è¿‡ç¨‹è¯¦è§£","uri":"/posts/fe0ba1/"},{"categories":["äº‘åŸç”Ÿ"],"content":"æ›´æ–°è¯´æ˜ ä¸‹é¢æ˜¯æœ¬æ–‡çš„å‡ æ¬¡æ›´æ–°è¯´æ˜ã€‚ 2020 å¹´ 4 æœˆ 27 æ—¥ï¼Œç¬¬ä¸€ç‰ˆï¼ŒåŸºäº Istio 1.5 æœ¬æ–‡çš„ç¬¬ä¸€ç‰ˆï¼ŒåŸºäº Istio 1.5 åˆ›ä½œï¼Œåœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘æ›¾å†™è¿‡åŸºäº Istio 1.1 ç‰ˆæœ¬çš„ç†è§£ Istio Service Mesh ä¸­ Envoy ä»£ç† Sidecar æ³¨å…¥åŠæµé‡åŠ«æŒï¼Œä¸ºäº†æ›´ç»†è‡´çš„ç†è§£ Istio ä¸­é€æ˜æµé‡åŠ«æŒçš„å…¨è¿‡ç¨‹ï¼Œä¸“é—¨åˆ›ä½œæœ¬æ–‡ã€‚ 2022 å¹´ 1 æœˆ 17 æ—¥ï¼Œç¬¬äºŒç‰ˆï¼ŒåŸºäº Istio 1.11 æœ¬æ–‡ç¬¬ä¸€ç‰ˆå‘å¸ƒåï¼Œåœ¨ç¤¾åŒºé‡Œè·å¾—äº†æ¯”è¾ƒå¤§çš„åå“ï¼Œæ”¶åˆ°äº†å¾ˆå¤šè¯»è€…çš„è¯„è®ºå’Œç•™è¨€ã€‚åŸºäºè¿™äº›è¯„è®ºï¼Œæˆ‘ä¹Ÿå‘ç°äº†ç¬¬ä¸€ç‰ˆä¸­çš„å¾ˆå¤šé”™è¯¯ï¼Œåœ¨åŠ ä¸Š Istio ç‰ˆæœ¬å‘å¸ƒé¢‘ç¹ï¼Œåœ¨è¿‘ä¸¤å¹´çš„æ—¶é—´å†…ï¼ŒIstio å·²ç»ä½œå‡ºäº†ä¼—å¤šæ›´æ–°ï¼Œå…¶ä¸­ä¸ä¹é‡å¤§æ›´æ–°ã€‚å› æ­¤ç¬”è€…æ’°å†™äº†æœ¬æ–‡çš„ç¬¬äºŒç‰ˆï¼Œä¿®æ”¹äº†ä¹‹å‰ç‰ˆæœ¬ä¸­çš„çº°æ¼å¹¶æ ¹æ®æ—¶ä¸‹ Istio çš„æœ€æ–°ç‰ˆæœ¬æ›´æ–°äº†æœ¬æ–‡ã€‚ Istio 1.11 ä¸ Istio 1.1 ä¸­çš„ sidecar æ³¨å…¥å’Œæµé‡åŠ«æŒç¯èŠ‚æœ€å¤§çš„å˜åŒ–æ˜¯ï¼š iptables æ”¹ç”¨å‘½ä»¤è¡Œå·¥å…·ï¼Œä¸å†ä½¿ç”¨ shell è„šæœ¬ã€‚ sidecar inbound å’Œ outbound åˆ†åˆ«æŒ‡å®šäº†ç«¯å£ï¼Œè€Œä¹‹å‰æ˜¯ä½¿ç”¨åŒä¸€ä¸ªç«¯å£ï¼ˆ15001ï¼‰ã€‚ 2022 å¹´ 4 æœˆ 24ï¼Œç¬¬ä¸‰ç‰ˆï¼ŒåŸºäº Istio 1.13 è¿™ä¸ªç‰ˆæœ¬çš„æ–‡ç« ä¸»è¦æ˜¯æ ¹æ®å½“æ—¶ Istio çš„æœ€æ–°ç‰ˆæœ¬æ›´æ–°äº†æ–‡ç« çš„éƒ¨åˆ†å†…å®¹ï¼Œå¹¶é‡æ–°æ’ç‰ˆï¼Œå¢åŠ æ›´æ–°è¯´æ˜ã€‚ Istio 1.13 ç›¸æ¯” Istio 1.11 çš„å˜åŒ–æ˜¯ istioctl proxy-config å‘½ä»¤çš„è¾“å‡ºæœ‰äº†è¾ƒå¤§å˜åŒ–ã€‚ 2022 å¹´ 5 æœˆ 6 æ—¥ï¼Œç¬¬å››ç‰ˆï¼ŒåŸºäº Istio 1.13 ä¿®æ”¹äº†å¯¹ ISTIO_ROUTE iptables è§„åˆ™ 2ã€5 çš„è§£é‡Š åœ¨ç¤ºæ„å›¾ä¸­å¢åŠ äº†è·¯å¾„ 16 2022 å¹´ 5 æœˆ 12 æ—¥ï¼Œç¬¬äº”ç‰ˆï¼ŒåŸºäº Istio 1.13 å°† iptables è¯´æ˜å’Œ sidecar æ³¨å…¥ã€init å®¹å™¨éƒ¨åˆ†ç‹¬ç«‹æˆäº†ä¸¤ç¯‡å•ç‹¬çš„åšå®¢ï¼Œä»¥ç¼©å‡åšå®¢çš„ç¯‡å¹…ï¼Œè§ Istio æ•°æ®å¹³é¢ Pod å¯åŠ¨è¿‡ç¨‹è¯¦è§£å’Œç†è§£ iptablesã€‚ ","date":"2022-09-11","objectID":"/posts/fe0ba1/:8:0","tags":["istio","è½¬è½½"],"title":"Istio ä¸­çš„ Sidecar æ³¨å…¥ã€é€æ˜æµé‡åŠ«æŒåŠæµé‡è·¯ç”±è¿‡ç¨‹è¯¦è§£","uri":"/posts/fe0ba1/"},{"categories":["äº‘åŸç”Ÿ"],"content":"å‚è€ƒ é˜…è¯»åŸæ–‡ Debugging Envoy and Istiod - istio.io æ­å¼€ Istio Sidecar æ³¨å…¥æ¨¡å‹çš„ç¥ç§˜é¢çº± - istio.io MOSN ä½œä¸º Sidecar ä½¿ç”¨æ—¶çš„æµé‡åŠ«æŒæ–¹æ¡ˆ - mosn.io ","date":"2022-09-11","objectID":"/posts/fe0ba1/:9:0","tags":["istio","è½¬è½½"],"title":"Istio ä¸­çš„ Sidecar æ³¨å…¥ã€é€æ˜æµé‡åŠ«æŒåŠæµé‡è·¯ç”±è¿‡ç¨‹è¯¦è§£","uri":"/posts/fe0ba1/"},{"categories":["VSCode"],"content":"æ‰“å¼€setting.json \"[markdown]\": { \"editor.quickSuggestions\": true } ","date":"2022-09-11","objectID":"/posts/4faa15/:0:1","tags":["vscode","snippets"],"title":"VSCode é…ç½®Markdownæ¨¡æ¿","uri":"/posts/4faa15/"},{"categories":["VSCode"],"content":"é…ç½®æ¨¡æ¿ Ctrl + Shift + P è¾“å…¥snippet ç‚¹å‡»é¦–é€‰é¡¹ï¼šé…ç½®ç”¨æˆ·ä»£ç ç‰‡ç‰‡æ®µ é€‰æ‹©markdown.json ","date":"2022-09-11","objectID":"/posts/4faa15/:0:2","tags":["vscode","snippets"],"title":"VSCode é…ç½®Markdownæ¨¡æ¿","uri":"/posts/4faa15/"},{"categories":["VSCode"],"content":"ç¼–å†™æ¨¡æ¿ { // Place your snippets for markdown here. Each snippet is defined under a snippet name and has a prefix, body and // description. The prefix is what is used to trigger the snippet and the body will be expanded and inserted. Possible variables are: // $1, $2 for tab stops, $0 for the final cursor position, and ${1:label}, ${2:another} for placeholders. Placeholders with the // same ids are connected. // Example: // \"Print to console\": { // \"prefix\": \"log\", // \"body\": [ // \"console.log('$1');\", // \"$2\" // ], // \"description\": \"Log output to console\" // } \"blog meta template\": { \"prefix\": \"meta\", \"body\": [ \"---\", \"title: ${TM_FILENAME_BASE}\", \"slug: ${RANDOM_HEX}\", \"date: ${CURRENT_YEAR}-${CURRENT_MONTH}-${CURRENT_DATE}T${CURRENT_HOUR}:${CURRENT_MINUTE}:${CURRENT_SECOND}+08:00\", \"draft: false\", \"author: kbsonlong\", \"authorEmail: kbsonlong@gmail.com\", \"tags: [${1}]\", \"categories: [${2}]\", \"featuredImage: https://imgapi.cn/api.php?zd=zsy\u0026fl=fengjing\u0026random=${RANDOM}\", \"---\" ] }, \"last modifier time\": { \"prefix\": \"last\", \"body\": \"${CURRENT_YEAR}-${CURRENT_MONTH}-${CURRENT_DATE}T${CURRENT_HOUR}:${CURRENT_MINUTE}:${CURRENT_SECOND}+08:00\" }, \"more themplate\" :{ \"prefix\": \"more\", \"body\": \"\u003c!--more--\u003e\", \"description\": \"æ–‡ç« æ‘˜è¦æ‰‹åŠ¨åˆ†å‰²\" } } ","date":"2022-09-11","objectID":"/posts/4faa15/:0:3","tags":["vscode","snippets"],"title":"VSCode é…ç½®Markdownæ¨¡æ¿","uri":"/posts/4faa15/"},{"categories":["VSCode"],"content":"å¸¸ç”¨å˜é‡ TM_SELECTED_TEXT å½“å‰é€‰å®šçš„æ–‡æœ¬æˆ–ç©ºå­—ç¬¦ä¸² TM_CURRENT_LINE å½“å‰è¡Œçš„å†…å®¹ TM_CURRENT_WORD å…‰æ ‡ä¸‹çš„å•è¯çš„å†…å®¹æˆ–ç©ºå­—ç¬¦ä¸² TM_LINE_INDEX åŸºäºé›¶ç´¢å¼•çš„è¡Œå· TM_LINE_NUMBER åŸºäºä¸€ç´¢å¼•çš„è¡Œå· TM_FILENAME å½“å‰æ–‡æ¡£çš„æ–‡ä»¶å TM_FILENAME_BASE å½“å‰æ–‡æ¡£çš„æ–‡ä»¶åï¼ˆä¸å«åç¼€å) TM_DIRECTORY å½“å‰æ–‡æ¡£çš„ç›®å½• RELATIVE_FILEPATH å½“å‰æ–‡ä»¶çš„ç›¸å¯¹ç›®å½• TM_FILEPATH å½“å‰æ–‡æ¡£çš„å®Œæ•´æ–‡ä»¶è·¯å¾„ CLIPBOARD å‰ªåˆ‡æ¿é‡Œçš„å†…å®¹ CURRENT_YEAR å½“å‰å¹´(å››ä½æ•°) CURRENT_MONTH å½“å‰æœˆ CURRENT_DATE å½“å‰æ—¥ CURRENT_DAY_NAME_SHORT å½“å¤©çš„çŸ­åç§°ï¼ˆâ€™Monâ€™ï¼‰ CURRENT_HOUR å½“å‰å°æ—¶ CURRENT_MINUTE å½“å‰åˆ†é’Ÿ CURRENT_SECOND å½“å‰ç§’ æ’å…¥éšæœºå€¼ RANDOM 6ä½éšæœº10è¿›åˆ¶æ•° RANDOM_HEX 6ä½16è¿›åˆ¶æ•° UUID ä¸€ä¸ªç‰ˆæœ¬4çš„UUID /** 286055 f570d8 0a831688-a7f1-4668-9964-f6100114792c */ BLOCK_COMMENT_START å—æ³¨é‡Šå¼€å§‹æ ‡è¯†,å¦‚ PHP /* æˆ– HTML \u003c!-- BLOCK_COMMENT_END å—æ³¨é‡Šç»“æŸæ ‡è¯†,å¦‚ PHP */ æˆ– HTML --\u003e LINE_COMMENT è¡Œæ³¨é‡Šï¼Œå¦‚ï¼š PHP // æˆ– HTML \u003c!-- --\u003e ","date":"2022-09-11","objectID":"/posts/4faa15/:0:4","tags":["vscode","snippets"],"title":"VSCode é…ç½®Markdownæ¨¡æ¿","uri":"/posts/4faa15/"},{"categories":["äº‘åŸç”Ÿ"],"content":"å‡†å¤‡å·¥ä½œ S2Iè‡ªå®šä¹‰é•œåƒæ„å»ºå™¨ â— assembleï¼ˆå¿…éœ€ï¼‰ï¼šä»æºä»£ç æ„å»ºåº”ç”¨ç¨‹åºåˆ¶å“çš„è„šæœ¬ assembleã€‚ â— runï¼ˆå¿…éœ€ï¼‰ï¼šç”¨äºè¿è¡Œåº”ç”¨ç¨‹åºçš„è„šæœ¬ã€‚ â— save-artifactsï¼ˆå¯é€‰ï¼‰ï¼šç®¡ç†å¢é‡æ„å»ºè¿‡ç¨‹ä¸­çš„æ‰€æœ‰ä¾èµ–ã€‚ â— usageï¼ˆå¯é€‰ï¼‰ï¼šæä¾›è¯´æ˜çš„è„šæœ¬ã€‚ â— test ï¼ˆå¯é€‰ï¼‰ï¼šç”¨äºæµ‹è¯•çš„è„šæœ¬ã€‚ ","date":"2022-09-11","objectID":"/posts/d83d7d/:0:1","tags":["kubesphere","operator"],"title":"S2Iè‡ªå®šä¹‰æ„å»ºå™¨å’Œæ¨¡æ¿","uri":"/posts/d83d7d/"},{"categories":["äº‘åŸç”Ÿ"],"content":"åˆ›å»ºé•œåƒæ„å»ºå™¨ å‡†å¤‡S2Iç›®å½• å®‰è£…s2i wget https://github.com/openshift/source-to-image/releases/download/v1.2.04/source-to-image-v1.1.14-874754de-linux-386.tar.gz tar -xvf source-to-image-v1.1.14-874754de-linux-386.tar.gz ls s2i source-to-image-v1.1.14-874754de-linux-386.tar.gz sti cp s2i /usr/local/bin åˆå§‹åŒ–é•œåƒæ„å»ºå™¨ s2i create java-ubuntu22 java-ubuntu22 cd java-ubuntu22 ç›®å½•ç»“æ„åˆå§‹åŒ– . â”œâ”€â”€ Dockerfile â”œâ”€â”€ Makefile â”œâ”€â”€ README.md â”œâ”€â”€ prometheus-config.yml â”œâ”€â”€ s2i â”‚ â””â”€â”€ bin â”‚ â”œâ”€â”€ assemble â”‚ â”œâ”€â”€ run â”‚ â”œâ”€â”€ save-artifacts â”‚ â””â”€â”€ usage â””â”€â”€ test â”œâ”€â”€ run â””â”€â”€ test-app â”œâ”€â”€ b2i-jar-java8.jar ## é»˜è®¤ä¸å­˜åœ¨ â””â”€â”€ index.html 4 directories, 11 files ","date":"2022-09-11","objectID":"/posts/d83d7d/:0:2","tags":["kubesphere","operator"],"title":"S2Iè‡ªå®šä¹‰æ„å»ºå™¨å’Œæ¨¡æ¿","uri":"/posts/d83d7d/"},{"categories":["äº‘åŸç”Ÿ"],"content":"ä¿®æ”¹Dockerfile # java-ubuntu22 FROM ubuntu:22.04 # TODO: Put the maintainer name in the image metadata # LABEL maintainer=\"Your Name \u003cyour@email.com\u003e\" # TODO: Rename the builder environment variable to inform users about application you provide them # ENV BUILDER_VERSION 1.0 # TODO: Set labels used in OpenShift to describe the builder image LABEL io.k8s.description=\"Java 8 web application\" \\ io.k8s.display-name=\"Java 8 Web\" \\ io.openshift.expose-services=\"8080:http\" \\ io.openshift.tags=\"builder,java,web\" \\ # this label tells s2i where to find its mandatory scripts # (run, assemble, save-artifacts) io.openshift.s2i.scripts-url=\"image:///usr/libexec/s2i\" # TODO: Install required packages here: # RUN yum install -y ... \u0026\u0026 yum clean all -y RUN apt-get update \u0026\u0026 apt-get install -y \\ curl \\ wget \\ openjdk-8-jdk \u0026\u0026 \\ rm -rf /var/lib/apt/lists WORKDIR /opt # TODO (optional): Copy the builder files into /opt/app-root # COPY ./\u003cbuilder_folder\u003e/ /opt/app-root/ # TODO: Copy the S2I scripts to /usr/libexec/s2i, since openshift/base-centos7 image # sets io.openshift.s2i.scripts-url label that way, or update that label COPY ./s2i/bin/ /usr/libexec/s2i # TODO: Drop the root user and make the content of /opt/app-root owned by user 1001 # RUN chown -R 1001:1001 /opt/app-root RUN chgrp -R 0 /usr/libexec/s2i \\ \u0026\u0026 chmod -R u=rwx,go=rx /usr/libexec/s2i \u0026\u0026 \\ chgrp -R 0 /opt \\ \u0026\u0026 chmod -R u=rwx,go=rx /opt \u0026\u0026 \\ chown -R 1001:1001 /opt \u0026\u0026 \\ chown -R 1001:1001 /usr/libexec/s2i/assemble RUN mkdir -p /opt/prometheus/etc \\ \u0026\u0026 curl https://repo1.maven.org/maven2/io/prometheus/jmx/jmx_prometheus_javaagent/0.17.0/jmx_prometheus_javaagent-0.17.0.jar \\ -o /opt/prometheus/jmx_prometheus_javaagent.jar COPY prometheus-config.yml /opt/prometheus/etc # This default user is created in the openshift/base-centos7 image USER 1001 # TODO: Set the default port for applications built using this image EXPOSE 8080 # TODO: Set the default CMD for the image CMD [\"/usr/libexec/s2i/usage\"] ","date":"2022-09-11","objectID":"/posts/d83d7d/:0:3","tags":["kubesphere","operator"],"title":"S2Iè‡ªå®šä¹‰æ„å»ºå™¨å’Œæ¨¡æ¿","uri":"/posts/d83d7d/"},{"categories":["äº‘åŸç”Ÿ"],"content":"ä¿®æ”¹S2Iè„šæœ¬ assemble #!/bin/bash -e # # S2I assemble script for the 'java-ubuntu22' image. # The 'assemble' script builds your application source so that it is ready to run. # # For more information refer to the documentation: # https://github.com/openshift/source-to-image/blob/master/docs/builder_image.md # # If the 'java-ubuntu22' assemble script is executed with the '-h' flag, print the usage. if [[ \"$1\" == \"-h\" ]]; then exec /usr/libexec/s2i/usage fi # Restore artifacts from the previous build (if they exist). # echo \"---\u003e Installing application...\" mkdir -p /opt/app ls /tmp/src/* mv /tmp/src/* /opt/app/ chmod +x /opt/app/*.jar é»˜è®¤æƒ…å†µä¸‹ï¼Œs2i buildå°†åº”ç”¨ç¨‹åºæºä»£ç æ”¾åœ¨/tmp/srcã€‚ä¸Šè¿°å‘½ä»¤å°†åº”ç”¨ç¨‹åºjaråŒ…å¤åˆ¶åˆ°/opt/app/ç›®å½•ä¸‹ run #!/bin/bash -e # # S2I run script for the 'java-ubuntu22' image. # The run script executes the server that runs your application. # # For more information see the documentation: # https://github.com/openshift/source-to-image/blob/master/docs/builder_image.md # PROMETHEUS_JMX_OPTS=\"-javaagent:/opt/prometheus/jmx_prometheus_javaagent.jar=${PROMETHEUS_JMX_PORT}:/opt/prometheus/etc/prometheus-config.yml\" # Always include jolokia-opts, which can be empty if switched off via env JAVA_OPTIONS=\"${JAVA_OPTIONS:+${JAVA_OPTIONS} }\" # Temporary options variable until the harmonization hawt-app PR #5 has been applied (hopefully) JVM_ARGS=\"${JVM_ARGS:+${JVM_ARGS} }${JAVA_OPTIONS} ${PROMETHEUS_JMX_OPTS}\" export JAVA_OPTIONS JVM_ARGS PROMETHEUS_JMX_OPTS exec java -jar ${JVM_ARGS} /opt/app/app.jar ","date":"2022-09-11","objectID":"/posts/d83d7d/:0:4","tags":["kubesphere","operator"],"title":"S2Iè‡ªå®šä¹‰æ„å»ºå™¨å’Œæ¨¡æ¿","uri":"/posts/d83d7d/"},{"categories":["äº‘åŸç”Ÿ"],"content":"æ„å»ºä¸è¿è¡Œ åˆ›å»ºé•œåƒæ„å»ºå™¨ make build ä½¿ç”¨é•œåƒæ„å»ºå™¨åˆ›å»ºåº”ç”¨ç¨‹åºé•œåƒ # s2i build ./test/test-app java-ubuntu22 sample-app ---\u003e Installing application... /tmp/src/b2i-jar-java8.jar /tmp/src/index.html Build completed successfully æŒ‰ç…§assembleè„šæœ¬å®šä¹‰çš„é€»è¾‘ï¼ŒS2Iä½¿ç”¨é•œåƒæ„å»ºå™¨ä½œä¸ºåŸºç¡€åˆ›å»ºåº”ç”¨ç¨‹åºé•œåƒï¼Œå¹¶ä»test/test-appç›®å½•æ³¨å…¥æºä»£ç ã€‚ æµ‹è¯•è¿è¡Œåº”ç”¨ç¨‹åºé•œåƒ # docker run -p 8080:8080 -p 12345:12345 -e PROMETHEUS_JMX_PORT=12345 sample-app . ____ _ __ _ _ /\\\\ / ___'_ __ _ _(_)_ __ __ _ \\ \\ \\ \\ ( ( )\\___ | '_ | '_| | '_ \\/ _` | \\ \\ \\ \\ \\\\/ ___)| |_)| | | | | || (_| | ) ) ) ) ' |____| .__|_| |_|_| |_\\__, | / / / / =========|_|==============|___/=/_/_/_/ :: Spring Boot :: (v1.4.1.BUILD-SNAPSHOT) 2022-07-28 07:51:48.829 INFO 1 --- [ main] io.kubesphere.devops.Application : Starting Application v0.0.1-SNAPSHOT on 322634c30cc2 with PID 1 (/opt/app/app.jar started by ? in /opt) 2022-07-28 07:51:48.839 INFO 1 --- [ main] io.kubesphere.devops.Application : No active profile set, falling back to default profiles: default 2022-07-28 07:51:48.906 INFO 1 --- [ main] ationConfigEmbeddedWebApplicationContext : Refreshing org.springframework.boot.context.embedded.AnnotationConfigEmbeddedWebApplicationContext@5ae50ce6: startup date [Thu Jul 28 07:51:48 GMT 2022]; root of context hierarchy 2022-07-28 07:51:49.694 INFO 1 --- [ main] s.b.c.e.t.TomcatEmbeddedServletContainer : Tomcat initialized with port(s): 8080 (http) 2022-07-28 07:51:49.700 INFO 1 --- [ main] o.apache.catalina.core.StandardService : Starting service Tomcat 2022-07-28 07:51:49.701 INFO 1 --- [ main] org.apache.catalina.core.StandardEngine : Starting Servlet Engine: Apache Tomcat/8.5.5 2022-07-28 07:51:49.749 INFO 1 --- [ost-startStop-1] o.a.c.c.C.[Tomcat].[localhost].[/] : Initializing Spring embedded WebApplicationContext 2022-07-28 07:51:49.749 INFO 1 --- [ost-startStop-1] o.s.web.context.ContextLoader : Root WebApplicationContext: initialization completed in 845 ms 2022-07-28 07:51:49.820 INFO 1 --- [ost-startStop-1] o.s.b.w.servlet.ServletRegistrationBean : Mapping servlet: 'dispatcherServlet' to [/] 2022-07-28 07:51:49.822 INFO 1 --- [ost-startStop-1] o.s.b.w.servlet.FilterRegistrationBean : Mapping filter: 'characterEncodingFilter' to: [/*] 2022-07-28 07:51:49.822 INFO 1 --- [ost-startStop-1] o.s.b.w.servlet.FilterRegistrationBean : Mapping filter: 'hiddenHttpMethodFilter' to: [/*] 2022-07-28 07:51:49.823 INFO 1 --- [ost-startStop-1] o.s.b.w.servlet.FilterRegistrationBean : Mapping filter: 'httpPutFormContentFilter' to: [/*] 2022-07-28 07:51:49.823 INFO 1 --- [ost-startStop-1] o.s.b.w.servlet.FilterRegistrationBean : Mapping filter: 'requestContextFilter' to: [/*] 2022-07-28 07:51:49.988 INFO 1 --- [ main] s.w.s.m.m.a.RequestMappingHandlerAdapter : Looking for @ControllerAdvice: org.springframework.boot.context.embedded.AnnotationConfigEmbeddedWebApplicationContext@5ae50ce6: startup date [Thu Jul 28 07:51:48 GMT 2022]; root of context hierarchy 2022-07-28 07:51:50.047 INFO 1 --- [ main] s.w.s.m.m.a.RequestMappingHandlerMapping : Mapped \"{[/]}\" onto public java.lang.String io.kubesphere.devops.HelloWorldController.sayHello() 2022-07-28 07:51:50.050 INFO 1 --- [ main] s.w.s.m.m.a.RequestMappingHandlerMapping : Mapped \"{[/error],produces=[text/html]}\" onto public org.springframework.web.servlet.ModelAndView org.springframework.boot.autoconfigure.web.BasicErrorController.errorHtml(javax.servlet.http.HttpServletRequest,javax.servlet.http.HttpServletResponse) 2022-07-28 07:51:50.050 INFO 1 --- [ main] s.w.s.m.m.a.RequestMappingHandlerMapping : Mapped \"{[/error]}\" onto public org.springframework.http.ResponseEntity\u003cjava.util.Map\u003cjava.lang.String, java.lang.Object\u003e\u003e org.springframework.boot.autoconfigure.web.BasicErrorController.error(javax.servlet.http.HttpServletRequest) 2022-07-28 07:51:50.063 INFO 1 --- [ main] o.s.w.s.handler.SimpleUrlHandlerMapping : Mapped URL path [/webjars/**] onto handler of type [class org.springframework.web.servlet.resource.ResourceHttpRequestHandler] 2022-07-28 07:51:50.063 INFO 1 --- [ main] o.s.w.s.handler.SimpleUrlHandlerMapping :","date":"2022-09-11","objectID":"/posts/d83d7d/:0:5","tags":["kubesphere","operator"],"title":"S2Iè‡ªå®šä¹‰æ„å»ºå™¨å’Œæ¨¡æ¿","uri":"/posts/d83d7d/"},{"categories":["äº‘åŸç”Ÿ"],"content":"è‡ªå®šä¹‰S2Iæ¨¡æ¿ apiVersion: devops.kubesphere.io/v1alpha1 kind: S2iBuilderTemplate metadata: labels: controller-tools.k8s.io: \"1.0\" builder-type.kubesphere.io/s2i: \"s2i\" name: java-ubuntu spec: containerInfo: - builderImage: java-ubuntu22 ## è‡ªå®šä¹‰çš„é•œåƒæ„å»ºå™¨é•œåƒ codeFramework: java # type of code framework defaultBaseImage: java-ubuntu22 # default Image Builder (can be replaced by a customized image) version: 0.0.1 # Builder template version description: \"æ¨¡æ¿æè¿°\" # Builder template description kubectl apply -f s2ibuildertemplate.yaml æ ‡ç­¾åç§° é€‰é¡¹ å®šä¹‰ builder-type.kubesphere.io/s2i â€œs2iâ€ æ¨¡æ¿ç±»å‹ä¸º S2Iï¼ŒåŸºäºåº”ç”¨ç¨‹åºæºä»£ç æ„å»ºé•œåƒã€‚ builder-type.kubesphere.io/b2i â€œb2iâ€ æ¨¡æ¿ç±»å‹ä¸º B2Iï¼ŒåŸºäºäºŒè¿›åˆ¶æ–‡ä»¶æˆ–å…¶ä»–åˆ¶å“æ„å»ºé•œåƒã€‚ binary-type.kubesphere.io â€œjarâ€,â€œwarâ€,â€œbinaryâ€ è¯¥ç±»å‹ä¸º B2I ç±»å‹çš„è¡¥å……ï¼Œåœ¨é€‰æ‹© B2I ç±»å‹æ—¶éœ€è¦ã€‚ä¾‹å¦‚ï¼Œå½“æä¾› Jar åŒ…æ—¶ï¼Œé€‰æ‹© â€œjarâ€ ç±»å‹ã€‚åœ¨ KubeSphere v2.1.1 åŠæ›´é«˜ç‰ˆæœ¬ï¼Œå…è®¸è‡ªå®šä¹‰ B2I æ¨¡æ¿ã€‚ å®˜æ–¹demo apiVersion: devops.kubesphere.io/v1alpha1 kind: S2iBuilderTemplate metadata: annotations: descriptionCN: Java åº”ç”¨çš„æ„å»ºå™¨æ¨¡ç‰ˆã€‚é€šè¿‡è¯¥æ¨¡ç‰ˆå¯æ„å»ºå‡ºç›´æ¥è¿è¡Œçš„åº”ç”¨é•œåƒã€‚ descriptionEN: This is a builder template for Java builds whose result can be run directly without any further application server.It's suited ideally for microservices with a flat classpath (including \"far jars\"). devops.kubesphere.io/s2i-template-url: https://github.com/kubesphere/s2i-java-container/blob/master/java/images helm.sh/hook: pre-install labels: binary-type.kubesphere.io: jar builder-type.kubesphere.io/b2i: b2i builder-type.kubesphere.io/s2i: s2i controller-tools.k8s.io: \"1.0\" name: java spec: codeFramework: java containerInfo: - buildVolumes: - s2i_java_cache:/tmp/artifacts builderImage: kubesphere/java-8-centos7:v3.2.0 runtimeArtifacts: - source: /deployments runtimeImage: kubesphere/java-8-runtime:v3.2.0 - buildVolumes: - s2i_java_cache:/tmp/artifacts builderImage: kubesphere/java-11-centos7:v3.2.0 runtimeArtifacts: - source: /deployments runtimeImage: kubesphere/java-11-runtime:v3.2.0 defaultBaseImage: kubesphere/java-8-centos7:v3.2.0 description: This is a builder template for Java builds whose result can be run directly without any further application server.It's suited ideally for microservices with a flat classpath (including \"far jars\") environment: - defaultValue: \"\" description: Arguments to use when calling Maven, replacing the default package hawt-app:build -DskipTests -e. Please be sure to run the hawt-app:build goal (when not already bound to the package execution phase), otherwise the startup scripts won't work. key: MAVEN_ARGS required: false type: string - defaultValue: \"\" description: Additional Maven arguments, useful for temporary adding arguments like -X or -am -pl . key: MAVEN_ARGS_APPEND required: false type: string - defaultValue: \"\" description: With Repositories you specify from which locations you want to download certain artifacts, such as dependencies and maven-plugins. key: MAVEN_MIRROR_URL required: false type: string - defaultValue: \"\" description: If set then the Maven repository is removed after the artifact is built. This is useful for keeping the created application image small, but prevents incremental builds. The default is false key: MAVEN_CLEAR_REPO required: false type: boolean - defaultValue: \"\" description: Path to target/ where the jar files are created for multi module builds. These are added to ${MAVEN_ARGS} key: ARTIFACT_DIR required: false type: string - defaultValue: \"\" description: Arguments to use when copying artifacts from the output dir to the application dir. Useful to specify which artifacts will be part of the image. It defaults to -r hawt-app/* when a hawt-app dir is found on the build directory, otherwise jar files only will be included (*.jar). key: ARTIFACT_COPY_ARGS required: false type: string - defaultValue: \"\" description: the directory where the application resides. All paths in your application are relative to this directory. By default it is the same directory where this startup script resides. key: JAVA_APP_DIR required: false type: string - defaultValue: \"\" description: directory holding the Java jar files as well a","date":"2022-09-11","objectID":"/posts/d83d7d/:0:6","tags":["kubesphere","operator"],"title":"S2Iè‡ªå®šä¹‰æ„å»ºå™¨å’Œæ¨¡æ¿","uri":"/posts/d83d7d/"},{"categories":["äº‘åŸç”Ÿ"],"content":"å‚è€ƒèµ„æ–™ s2i-base-container s2i-java-container s2i-java-runtimeImage ","date":"2022-09-11","objectID":"/posts/d83d7d/:0:7","tags":["kubesphere","operator"],"title":"S2Iè‡ªå®šä¹‰æ„å»ºå™¨å’Œæ¨¡æ¿","uri":"/posts/d83d7d/"},{"categories":["golang"],"content":"åˆå§‹åŒ–demoé¡¹ç›® mkdir -p gin-middleware-demo cd gin-middleware-demo go mod init github.com/kbsonlong/gin-middleware-demo middleware/middle.go package middleware import ( \"fmt\" \"time\" \"github.com/gin-gonic/gin\" ) func MdOne() gin.HandlerFunc { return func(c *gin.Context) { fmt.Println(\"å¼€å§‹æ‰§è¡Œç¬¬ä¸€ä¸ª gin ä¸­é—´ä»¶:\" + time.Now().String()) c.Next() fmt.Println(\"ç¬¬ä¸€ä¸ª gin ä¸­é—´ä»¶è¿”å›å†…å®¹:\" + time.Now().String()) } } func MdTwo() gin.HandlerFunc { return func(c *gin.Context) { fmt.Println(\"å¼€å§‹æ‰§è¡Œç¬¬äºŒä¸ª gin ä¸­é—´ä»¶:\" + time.Now().String()) c.Next() fmt.Println(\"ç¬¬äºŒä¸ª gin ä¸­é—´ä»¶è¿”å›å†…å®¹:\" + time.Now().String()) } } func MdThree() gin.HandlerFunc { return func(c *gin.Context) { fmt.Println(\"å¼€å§‹æ‰§è¡Œç¬¬ä¸‰ä¸ª gin ä¸­é—´ä»¶:\" + time.Now().String()) c.Next() fmt.Println(\"ç¬¬ä¸‰ä¸ª gin ä¸­é—´ä»¶è¿”å›å†…å®¹:\" + time.Now().String()) } } routers/router.go package routers import ( \"github.com/gin-gonic/gin\" \"github.com/kbsonlong/gin-middleware-demo/middleware\" ) func InitRouter() *gin.Engine { r := gin.New() r.Use(middleware.MdOne()) r.Use(middleware.MdTwo()) r.Use(middleware.MdThree()) gin.SetMode(\"debug\") r.GET(\"/\", func(ctx *gin.Context) { ctx.JSON(200, gin.H{ \"message\": \"test\", }) }) return r } main.go package main import ( \"github.com/kbsonlong/gin-middleware-demo/routers\" ) func main() { router := routers.InitRouter() router.Run() } ","date":"2022-09-11","objectID":"/posts/97ba92/:0:1","tags":["gin"],"title":"Ginä¸­é—´ä»¶æ‰§è¡Œé¡ºåº","uri":"/posts/97ba92/"},{"categories":["golang"],"content":"è¿è¡Œæµ‹è¯• go mod tidy go run main.go [GIN-debug] [WARNING] Running in \"debug\" mode. Switch to \"release\" mode in production. - using env: export GIN_MODE=release - using code: gin.SetMode(gin.ReleaseMode) [GIN-debug] GET / --\u003e github.com/kbsonlong/gin-middleware-demo/routers.InitRouter.func1 (4 handlers) [GIN-debug] [WARNING] You trusted all proxies, this is NOT safe. We recommend you to set a value. Please check https://pkg.go.dev/github.com/gin-gonic/gin#readme-don-t-trust-all-proxies for details. [GIN-debug] Environment variable PORT is undefined. Using port :8080 by default [GIN-debug] Listening and serving HTTP on :8080 å¦ä¸€ç»ˆç«¯æ‰§è¡Œ curl 127.0.0.1:8080 {\"message\":\"test\"} å¯ä»¥çœ‹åˆ°æ§åˆ¶å°è¾“å‡ºå†…å®¹ å¼€å§‹æ‰§è¡Œç¬¬ä¸€ä¸ª gin ä¸­é—´ä»¶:2022-07-08 17:18:57.499033 +0800 CST m=+3.029327751 å¼€å§‹æ‰§è¡Œç¬¬äºŒä¸ª gin ä¸­é—´ä»¶:2022-07-08 17:18:57.499215 +0800 CST m=+3.029509918 å¼€å§‹æ‰§è¡Œç¬¬ä¸‰ä¸ª gin ä¸­é—´ä»¶:2022-07-08 17:18:57.499218 +0800 CST m=+3.029513043 ç¬¬ä¸‰ä¸ª gin ä¸­é—´ä»¶è¿”å›å†…å®¹:2022-07-08 17:18:57.499295 +0800 CST m=+3.029589876 ç¬¬äºŒä¸ª gin ä¸­é—´ä»¶è¿”å›å†…å®¹:2022-07-08 17:18:57.499298 +0800 CST m=+3.029593335 ç¬¬ä¸€ä¸ª gin ä¸­é—´ä»¶è¿”å›å†…å®¹:2022-07-08 17:18:57.4993 +0800 CST m=+3.029594876 è°ƒæ•´ä¸­é—´ä»¶Useé¡ºåº ...... r.Use(middleware.MdOne()) r.Use(middleware.MdThree()) r.Use(middleware.MdTwo()) gin.SetMode(\"debug\") ...... ç¬¬äºŒä¸ªä¸­é—´ä»¶å’Œç¬¬ä¸‰ä¸ªä¸­é—´ä»¶é¡ºåºå¯¹è°ƒ å¼€å§‹æ‰§è¡Œç¬¬ä¸€ä¸ª gin ä¸­é—´ä»¶:2022-07-08 17:20:57.702026 +0800 CST m=+2.567931210 å¼€å§‹æ‰§è¡Œç¬¬ä¸‰ä¸ª gin ä¸­é—´ä»¶:2022-07-08 17:20:57.702215 +0800 CST m=+2.568120210 å¼€å§‹æ‰§è¡Œç¬¬äºŒä¸ª gin ä¸­é—´ä»¶:2022-07-08 17:20:57.702218 +0800 CST m=+2.568123543 ç¬¬äºŒä¸ª gin ä¸­é—´ä»¶è¿”å›å†…å®¹:2022-07-08 17:20:57.702305 +0800 CST m=+2.568210460 ç¬¬ä¸‰ä¸ª gin ä¸­é—´ä»¶è¿”å›å†…å®¹:2022-07-08 17:20:57.702308 +0800 CST m=+2.568214043 ç¬¬ä¸€ä¸ª gin ä¸­é—´ä»¶è¿”å›å†…å®¹:2022-07-08 17:20:57.702311 +0800 CST m=+2.568216293 å¯ä»¥çœ‹åˆ°ç¬¬ä¸‰ä¸ªä¸­é—´ä»¶åœ¨ç¬¬äºŒä¸ªä¸­é—´ä»¶ä¹‹å‰æ‰§è¡Œ æ³¨é‡Šç¬¬ä¸‰ä¸ªä¸­é—´ä»¶Next func MdThree() gin.HandlerFunc { return func(c *gin.Context) { fmt.Println(\"å¼€å§‹æ‰§è¡Œç¬¬ä¸‰ä¸ª gin ä¸­é—´ä»¶:\" + time.Now().String()) // c.Next() fmt.Println(\"ç¬¬ä¸‰ä¸ª gin ä¸­é—´ä»¶è¿”å›å†…å®¹:\" + time.Now().String()) } } å¼€å§‹æ‰§è¡Œç¬¬ä¸€ä¸ª gin ä¸­é—´ä»¶:2022-07-08 17:22:43.132983 +0800 CST m=+4.061931376 å¼€å§‹æ‰§è¡Œç¬¬ä¸‰ä¸ª gin ä¸­é—´ä»¶:2022-07-08 17:22:43.133126 +0800 CST m=+4.062074668 ç¬¬ä¸‰ä¸ª gin ä¸­é—´ä»¶è¿”å›å†…å®¹:2022-07-08 17:22:43.133128 +0800 CST m=+4.062076751 å¼€å§‹æ‰§è¡Œç¬¬äºŒä¸ª gin ä¸­é—´ä»¶:2022-07-08 17:22:43.13313 +0800 CST m=+4.062078210 ç¬¬äºŒä¸ª gin ä¸­é—´ä»¶è¿”å›å†…å®¹:2022-07-08 17:22:43.133203 +0800 CST m=+4.062151335 ç¬¬ä¸€ä¸ª gin ä¸­é—´ä»¶è¿”å›å†…å®¹:2022-07-08 17:22:43.133205 +0800 CST m=+4.062153460 ","date":"2022-09-11","objectID":"/posts/97ba92/:0:2","tags":["gin"],"title":"Ginä¸­é—´ä»¶æ‰§è¡Œé¡ºåº","uri":"/posts/97ba92/"},{"categories":["golang"],"content":"æ€»ç»“ Ginä¸­é—´ä»¶çš„è°ƒç”¨é¡ºåºä¸Useé¡ºåºæœ‰å…³ï¼Œä»£ç è¿è¡Œé¡ºåºå’ŒNextå‰åé¡ºåºæœ‰å…³ã€‚ Nextä¹‹å‰ä»£ç å…ˆè¿›å…ˆå‡º Nextä¹‹åä»£ç åè¿›å…ˆå‡º æ²¡æœ‰å¼•ç”¨Nextä»£ç ç›´æ¥è¿è¡Œ ","date":"2022-09-11","objectID":"/posts/97ba92/:0:3","tags":["gin"],"title":"Ginä¸­é—´ä»¶æ‰§è¡Œé¡ºåº","uri":"/posts/97ba92/"},{"categories":["äº‘åŸç”Ÿ","Istio"],"content":" Sidecar è‡ªåŠ¨æ³¨å…¥æœºåˆ¶æ˜¯å°† sidecar ä»£ç†è‡ªåŠ¨æ·»åŠ åˆ°ç”¨æˆ·åˆ›å»ºçš„ podã€‚ å®ƒä½¿ç”¨ MutatingWebhook æœºåˆ¶åœ¨ pod åˆ›å»ºçš„æ—¶å€™å°† sidecar çš„å®¹å™¨å’Œå·æ·»åŠ åˆ°æ¯ä¸ª pod çš„æ¨¡ç‰ˆé‡Œã€‚ ç”¨æˆ·å¯ä»¥é€šè¿‡ webhooks namespaceSelector æœºåˆ¶æ¥é™å®šéœ€è¦å¯åŠ¨è‡ªåŠ¨æ³¨å…¥çš„èŒƒå›´ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ³¨è§£çš„æ–¹å¼é’ˆå¯¹æ¯ä¸ª pod æ¥å•ç‹¬å¯ç”¨å’Œç¦ç”¨è‡ªåŠ¨æ³¨å…¥åŠŸèƒ½ã€‚ Sidecar æ˜¯å¦ä¼šè¢«è‡ªåŠ¨æ³¨å…¥å–å†³äºä¸‹é¢ 3 æ¡é…ç½®å’Œ 2 æ¡å®‰å…¨è§„åˆ™ï¼š é…ç½®: webhooks namespaceSelector é»˜è®¤ç­–ç•¥ policy pod çº§åˆ«çš„è¦†ç›–æ³¨è§£ å®‰å…¨è§„åˆ™: sidecar é»˜è®¤ä¸èƒ½è¢«æ³¨å…¥åˆ° kube-system å’Œ kube-public è¿™ä¸¤ä¸ª namespace sidecar ä¸èƒ½è¢«æ³¨å…¥åˆ°ä½¿ç”¨ host network ç½‘ç»œçš„ pod é‡Œ ä¸‹é¢çš„è¡¨æ ¼å±•ç¤ºäº†åŸºäºä¸Šè¿°ä¸‰ä¸ªé…ç½®æ¡ä»¶çš„æœ€ç»ˆæ³¨å…¥çŠ¶æ€ã€‚ä¸Šè¿°çš„å®‰å…¨è§„åˆ™ä¸ä¼šè¢«è¦†ç›–ã€‚ namespaceSelector åŒ¹é… é»˜è®¤ç­–ç•¥ sidecar.istio.io/inject æ³¨è§£ Sidecar æ˜¯å¦æ³¨å…¥ æ˜¯ enabled true (default) æ˜¯ æ˜¯ enabled false å¦ æ˜¯ disabled true æ˜¯ æ˜¯ disabled false (default) å¦ å¦ enabled true (default) å¦ å¦ enabled false å¦ å¦ disabled true å¦ å¦ disabled false (default) å¦ ä»¥ä¸‹å†…å®¹åŸºäºIstio 1.13.2ç‰ˆæœ¬ ","date":"2022-09-11","objectID":"/posts/dd0bd7/:0:0","tags":["istio","Sidecar"],"title":"æ·±å…¥Istioç³»åˆ—-Sidecarè‡ªåŠ¨æ³¨å…¥","uri":"/posts/dd0bd7/"},{"categories":["äº‘åŸç”Ÿ","Istio"],"content":"NewWehookæ–¹æ³• pkg/kube/inject/webhook.go func NewWebhook(p WebhookParameters) (*Webhook, error) { if p.Mux == nil { return nil, errors.New(\"expected mux to be passed, but was not passed\") } wh := \u0026Webhook{ watcher: p.Watcher, meshConfig: p.Env.Mesh(), env: p.Env, revision: p.Revision, } p.Watcher.SetHandler(wh.updateConfig) sidecarConfig, valuesConfig, err := p.Watcher.Get() if err != nil { return nil, err } wh.updateConfig(sidecarConfig, valuesConfig) //åˆå§‹åŒ–Webhookå®ä¾‹çš„æ—¶å€™æ³¨å†Œ/injectå¯¹åº”çš„å¤„ç†å™¨ p.Mux.HandleFunc(\"/inject\", wh.serveInject) p.Mux.HandleFunc(\"/inject/\", wh.serveInject) p.Env.Watcher.AddMeshHandler(func() { wh.mu.Lock() wh.meshConfig = p.Env.Mesh() wh.mu.Unlock() }) return wh, nil } ","date":"2022-09-11","objectID":"/posts/dd0bd7/:0:1","tags":["istio","Sidecar"],"title":"æ·±å…¥Istioç³»åˆ—-Sidecarè‡ªåŠ¨æ³¨å…¥","uri":"/posts/dd0bd7/"},{"categories":["äº‘åŸç”Ÿ","Istio"],"content":"serveInjectæ–¹æ³• pkg/kube/inject/webhook.go å¤§æ¦‚825-895è¡Œ func (wh *Webhook) serveInject(w http.ResponseWriter, r *http.Request) { totalInjections.Increment() var body []byte // è·å–è¯·æ±‚ä½“ if r.Body != nil { if data, err := kube.HTTPConfigReader(r); err == nil { body = data } else { http.Error(w, err.Error(), http.StatusBadRequest) return } } if len(body) == 0 { handleError(\"no body found\") http.Error(w, \"no body found\", http.StatusBadRequest) return } // verify the content type is accurate contentType := r.Header.Get(\"Content-Type\") if contentType != \"application/json\" { handleError(fmt.Sprintf(\"contentType=%s, expect application/json\", contentType)) http.Error(w, \"invalid Content-Type, want `application/json`\", http.StatusUnsupportedMediaType) return } path := \"\" if r.URL != nil { path = r.URL.Path } var reviewResponse *kube.AdmissionResponse var obj runtime.Object var ar *kube.AdmissionReview // è§£ç è¯·æ±‚ä½“ if out, _, err := deserializer.Decode(body, nil, obj); err != nil { handleError(fmt.Sprintf(\"Could not decode body: %v\", err)) reviewResponse = toAdmissionResponse(err) } else { log.Debugf(\"AdmissionRequest for path=%s\\n\", path) ar, err = kube.AdmissionReviewKubeToAdapter(out) if err != nil { handleError(fmt.Sprintf(\"Could not decode object: %v\", err)) } // è¿›å…¥injectæ–¹æ³•é€»è¾‘åˆ¤æ–­ reviewResponse = wh.inject(ar, path) } response := kube.AdmissionReview{} response.Response = reviewResponse var responseKube runtime.Object var apiVersion string if ar != nil { apiVersion = ar.APIVersion response.TypeMeta = ar.TypeMeta if response.Response != nil { if ar.Request != nil { response.Response.UID = ar.Request.UID } } } responseKube = kube.AdmissionReviewAdapterToKube(\u0026response, apiVersion) resp, err := json.Marshal(responseKube) if err != nil { log.Errorf(\"Could not encode response: %v\", err) http.Error(w, fmt.Sprintf(\"could not encode response: %v\", err), http.StatusInternalServerError) } if _, err := w.Write(resp); err != nil { log.Errorf(\"Could not write response: %v\", err) http.Error(w, fmt.Sprintf(\"could not write response: %v\", err), http.StatusInternalServerError) } } ","date":"2022-09-11","objectID":"/posts/dd0bd7/:0:2","tags":["istio","Sidecar"],"title":"æ·±å…¥Istioç³»åˆ—-Sidecarè‡ªåŠ¨æ³¨å…¥","uri":"/posts/dd0bd7/"},{"categories":["äº‘åŸç”Ÿ","Istio"],"content":"injectæ–¹æ³• pkg/kube/inject/webhook.go å¤§æ¦‚åœ¨748-823è¡Œ func (wh *Webhook) inject(ar *kube.AdmissionReview, path string) *kube.AdmissionResponse { req := ar.Request var pod corev1.Pod if err := json.Unmarshal(req.Object.Raw, \u0026pod); err != nil { handleError(fmt.Sprintf(\"Could not unmarshal raw object: %v %s\", err, string(req.Object.Raw))) return toAdmissionResponse(err) } // Managed fields is sometimes extremely large, leading to excessive CPU time on patch generation // It does not impact the injection output at all, so we can just remove it. pod.ManagedFields = nil // Deal with potential empty fields, e.g., when the pod is created by a deployment podName := potentialPodName(pod.ObjectMeta) if pod.ObjectMeta.Namespace == \"\" { pod.ObjectMeta.Namespace = req.Namespace } log.Infof(\"Sidecar injection request for %v/%v\", req.Namespace, podName) log.Debugf(\"Object: %v\", string(req.Object.Raw)) log.Debugf(\"OldObject: %v\", string(req.OldObject.Raw)) wh.mu.RLock() // Sicaderæ³¨å…¥åˆ¤æ–­é€»è¾‘ if !injectRequired(IgnoredNamespaces.UnsortedList(), wh.Config, \u0026pod.Spec, pod.ObjectMeta) { log.Infof(\"Skipping %s/%s due to policy check\", pod.ObjectMeta.Namespace, podName) totalSkippedInjections.Increment() wh.mu.RUnlock() return \u0026kube.AdmissionResponse{ Allowed: true, } } proxyConfig := mesh.DefaultProxyConfig() if wh.env.PushContext != nil \u0026\u0026 wh.env.PushContext.ProxyConfigs != nil { if generatedProxyConfig := wh.env.PushContext.ProxyConfigs.EffectiveProxyConfig( \u0026model.NodeMetadata{ Namespace: pod.Namespace, Labels: pod.Labels, Annotations: pod.Annotations, }, wh.meshConfig); generatedProxyConfig != nil { proxyConfig = *generatedProxyConfig } } deploy, typeMeta := kube.GetDeployMetaFromPod(\u0026pod) params := InjectionParameters{ pod: \u0026pod, deployMeta: deploy, typeMeta: typeMeta, templates: wh.Config.Templates, defaultTemplate: wh.Config.DefaultTemplates, aliases: wh.Config.Aliases, meshConfig: wh.meshConfig, proxyConfig: \u0026proxyConfig, valuesConfig: wh.valuesConfig, revision: wh.revision, injectedAnnotations: wh.Config.InjectedAnnotations, proxyEnvs: parseInjectEnvs(path), } wh.mu.RUnlock() patchBytes, err := injectPod(params) if err != nil { handleError(fmt.Sprintf(\"Pod injection failed: %v\", err)) return toAdmissionResponse(err) } reviewResponse := kube.AdmissionResponse{ Allowed: true, Patch: patchBytes, PatchType: func() *string { pt := \"JSONPatch\" return \u0026pt }(), } totalSuccessfulInjections.Increment() return \u0026reviewResponse } ","date":"2022-09-11","objectID":"/posts/dd0bd7/:0:3","tags":["istio","Sidecar"],"title":"æ·±å…¥Istioç³»åˆ—-Sidecarè‡ªåŠ¨æ³¨å…¥","uri":"/posts/dd0bd7/"},{"categories":["äº‘åŸç”Ÿ","Istio"],"content":"injectRequiredæ–¹æ³• pkg/kube/inject/inject.go å¤§æ¦‚åœ¨180-290è¡Œ func injectRequired(ignored []string, config *Config, podSpec *corev1.PodSpec, metadata metav1.ObjectMeta) bool { // nolint: lll // Skip injection when host networking is enabled. The problem is // that the iptables changes are assumed to be within the pod when, // in fact, they are changing the routing at the host level. This // often results in routing failures within a node which can // affect the network provider within the cluster causing // additional pod failures. // ä¸»æœºç½‘ç»œæ¨¡å¼ä¸æ³¨å…¥sicader if podSpec.HostNetwork { return false } // skip special kubernetes system namespaces // kube-systemã€kube-publicã€kube-node-leaseã€local-path-storageå››ä¸ªåç§°ç©ºé—´ä¸è¢«æ³¨å…¥sicader for _, namespace := range ignored { if metadata.Namespace == namespace { return false } } annos := metadata.GetAnnotations() var useDefault bool var inject bool // annotation æ˜¯å¦å¼€å¯æ³¨å…¥ `sidecar.istio.io/inject: \"true\"` objectSelector := annos[annotation.SidecarInject.Name] if lbl, labelPresent := metadata.GetLabels()[annotation.SidecarInject.Name]; labelPresent { // The label is the new API; if both are present we prefer the label objectSelector = lbl } switch strings.ToLower(objectSelector) { // http://yaml.org/type/bool.html case \"y\", \"yes\", \"true\", \"on\": inject = true case \"\": useDefault = true } // If an annotation is not explicitly given, check the LabelSelectors, starting with NeverInject // åˆ¤æ–­ configmap `istio-sidecar-injector` NeverInject åŒ¹é…æ ‡ç­¾é€‰æ‹©å™¨ if useDefault { for _, neverSelector := range config.NeverInjectSelector { selector, err := metav1.LabelSelectorAsSelector(\u0026neverSelector) if err != nil { log.Warnf(\"Invalid selector for NeverInjectSelector: %v (%v)\", neverSelector, err) } else if !selector.Empty() \u0026\u0026 selector.Matches(labels.Set(metadata.Labels)) { log.Debugf(\"Explicitly disabling injection for pod %s/%s due to pod labels matching NeverInjectSelector config map entry.\", metadata.Namespace, potentialPodName(metadata)) inject = false useDefault = false break } } } // If there's no annotation nor a NeverInjectSelector, check the AlwaysInject one // åˆ¤æ–­ configmap `istio-sidecar-injector` AlwaysInject åŒ¹é…æ ‡ç­¾é€‰æ‹©å™¨ if useDefault { for _, alwaysSelector := range config.AlwaysInjectSelector { selector, err := metav1.LabelSelectorAsSelector(\u0026alwaysSelector) if err != nil { log.Warnf(\"Invalid selector for AlwaysInjectSelector: %v (%v)\", alwaysSelector, err) } else if !selector.Empty() \u0026\u0026 selector.Matches(labels.Set(metadata.Labels)) { log.Debugf(\"Explicitly enabling injection for pod %s/%s due to pod labels matching AlwaysInjectSelector config map entry.\", metadata.Namespace, potentialPodName(metadata)) inject = true useDefault = false break } } } var required bool // åˆ¤æ–­ configmap `istio-sidecar-injector` é»˜è®¤ç­–ç•¥policy switch config.Policy { default: // InjectionPolicyOff log.Errorf(\"Illegal value for autoInject:%s, must be one of [%s,%s]. Auto injection disabled!\", config.Policy, InjectionPolicyDisabled, InjectionPolicyEnabled) required = false case InjectionPolicyDisabled: if useDefault { required = false } else { required = inject } case InjectionPolicyEnabled: if useDefault { required = true } else { required = inject } } if log.DebugEnabled() { // Build a log message for the annotations. annotationStr := \"\" for name := range AnnotationValidation { value, ok := annos[name] if !ok { value = \"(unset)\" } annotationStr += fmt.Sprintf(\"%s:%s \", name, value) } log.Debugf(\"Sidecar injection policy for %v/%v: namespacePolicy:%v useDefault:%v inject:%v required:%v %s\", metadata.Namespace, potentialPodName(metadata), config.Policy, useDefault, inject, required, annotationStr) } return required } ","date":"2022-09-11","objectID":"/posts/dd0bd7/:0:4","tags":["istio","Sidecar"],"title":"æ·±å…¥Istioç³»åˆ—-Sidecarè‡ªåŠ¨æ³¨å…¥","uri":"/posts/dd0bd7/"},{"categories":["äº‘åŸç”Ÿ"],"content":"å‹æµ‹å¤§çº² å‹æµ‹çš„å¿…è¦æ€§ å‹æµ‹éƒ¨ç½²æ¶æ„å›¾ ç¯å¢ƒå‡†å¤‡ ","date":"2022-09-11","objectID":"/posts/129682/:0:0","tags":["istio"],"title":"Istioæ€§èƒ½æµ‹è¯•","uri":"/posts/129682/"},{"categories":["äº‘åŸç”Ÿ"],"content":"éƒ¨ç½² Istio ","date":"2022-09-11","objectID":"/posts/129682/:1:0","tags":["istio"],"title":"Istioæ€§èƒ½æµ‹è¯•","uri":"/posts/129682/"},{"categories":["äº‘åŸç”Ÿ"],"content":"éƒ¨ç½²ç›‘æ§ç»„ä»¶ ","date":"2022-09-11","objectID":"/posts/129682/:2:0","tags":["istio"],"title":"Istioæ€§èƒ½æµ‹è¯•","uri":"/posts/129682/"},{"categories":["äº‘åŸç”Ÿ"],"content":"éƒ¨ç½²å‹æµ‹æœåŠ¡ ","date":"2022-09-11","objectID":"/posts/129682/:3:0","tags":["istio"],"title":"Istioæ€§èƒ½æµ‹è¯•","uri":"/posts/129682/"},{"categories":["äº‘åŸç”Ÿ"],"content":"Fortio v1ç‰ˆæœ¬ apiVersion: apps/v1 kind: Deployment metadata: name: fortio-server-l3 labels: app: fortio-server-l3 version: v1 spec: replicas: 1 selector: matchLabels: app: fortio-server-l3 template: metadata: labels: app: fortio-server-l3 version: v1 spec: containers: - name: fortio-server-l3 # åœ¨ä¸­å›½ï¼Œä½ å¯ä»¥ä½¿ç”¨ docker.mirrors.ustc.edu.cn/fortio/fortio:latest image: fortio/fortio:latest ports: - containerPort: 8080 name: http-port - containerPort: 8078 name: udp-port - containerPort: 8079 name: grpc-port - containerPort: 8081 name: https-port command: - fortio - server --- apiVersion: v1 kind: Service metadata: name: fortio-server-l3 spec: ports: - name: http-port port: 8080 protocol: TCP targetPort: 8080 - name: https-port port: 8081 protocol: TCP targetPort: 8081 - name: http2-grpc port: 8079 protocol: TCP targetPort: 8079 - name: udp-grpc port: 8078 protocol: UDP targetPort: 8078 selector: app: fortio-server-l3 type: NodePort --- apiVersion: apps/v1 kind: Deployment metadata: name: fortio-server-l2 labels: app: fortio-server-l2 version: v1 spec: replicas: 1 selector: matchLabels: app: fortio-server-l2 template: metadata: labels: app: fortio-server-l2 version: v1 spec: containers: - name: fortio-server-l2 # åœ¨ä¸­å›½ï¼Œä½ å¯ä»¥ä½¿ç”¨ docker.mirrors.ustc.edu.cn/fortio/fortio:latest image: fortio/fortio:latest ports: - containerPort: 8080 name: http-port - containerPort: 8072 name: http-m - containerPort: 8078 name: udp-port - containerPort: 8079 name: grpc-port - containerPort: 8081 name: https-port command: - fortio args: [\"server\", \"-P\", \"8072 fortio-server-l3:8080\"] --- apiVersion: v1 kind: Service metadata: name: fortio-server-l2 spec: ports: - name: http-m port: 8072 protocol: TCP targetPort: 8072 - name: http-port port: 8080 protocol: TCP targetPort: 8080 - name: https-port port: 8081 protocol: TCP targetPort: 8081 - name: http2-grpc port: 8079 protocol: TCP targetPort: 8079 - name: udp-grpc port: 8078 protocol: UDP targetPort: 8078 selector: app: fortio-server-l2 type: NodePort --- apiVersion: apps/v1 kind: Deployment metadata: name: fortio-server-l1 labels: app: fortio-server-l1 version: v1 spec: replicas: 1 selector: matchLabels: app: fortio-server-l1 template: metadata: labels: app: fortio-server-l1 version: v1 spec: containers: - name: fortio-server-l1 # åœ¨ä¸­å›½ï¼Œä½ å¯ä»¥ä½¿ç”¨ docker.mirrors.ustc.edu.cn/fortio/fortio:latest image: fortio/fortio:latest ports: - containerPort: 8080 name: http-port - containerPort: 8071 name: http-m - containerPort: 8078 name: udp-port - containerPort: 8079 name: grpc-port - containerPort: 8081 name: https-port command: - fortio args: [\"server\", \"-P\", \"8071 fortio-server-l2:8072\"] --- apiVersion: v1 kind: Service metadata: name: fortio-server-l1 spec: ports: - name: http-m port: 8071 protocol: TCP targetPort: 8071 - name: http-port port: 8080 protocol: TCP targetPort: 8080 - name: https-port port: 8081 protocol: TCP targetPort: 8081 - name: http2-grpc port: 8079 protocol: TCP targetPort: 8079 - name: udp-grpc port: 8078 protocol: UDP targetPort: 8078 selector: app: fortio-server-l1 type: NodePort ","date":"2022-09-11","objectID":"/posts/129682/:3:1","tags":["istio"],"title":"Istioæ€§èƒ½æµ‹è¯•","uri":"/posts/129682/"},{"categories":["äº‘åŸç”Ÿ"],"content":"Fortio v2ç‰ˆæœ¬ apiVersion: apps/v1 kind: Deployment metadata: name: fortio-server-l3 labels: app: fortio-server-l3 version: v1 spec: replicas: 1 selector: matchLabels: app: fortio-server-l3 template: metadata: labels: app: fortio-server-l3 version: v1 spec: containers: - name: fortio-server-l3 # åœ¨ä¸­å›½ï¼Œä½ å¯ä»¥ä½¿ç”¨ docker.mirrors.ustc.edu.cn/fortio/fortio:latest image: fortio/fortio:latest ports: - containerPort: 8080 name: http-port - containerPort: 8078 name: udp-port - containerPort: 8079 name: grpc-port - containerPort: 8081 name: https-port command: - fortio - server --- apiVersion: v1 kind: Service metadata: name: fortio-server-l3 spec: ports: - name: http-port port: 8080 protocol: TCP targetPort: 8080 - name: https-port port: 8081 protocol: TCP targetPort: 8081 - name: http2-grpc port: 8079 protocol: TCP targetPort: 8079 - name: udp-grpc port: 8078 protocol: UDP targetPort: 8078 selector: app: fortio-server-l3 type: NodePort --- apiVersion: apps/v1 kind: Deployment metadata: name: fortio-server-l2 labels: app: fortio-server-l2 version: v1 spec: replicas: 1 selector: matchLabels: app: fortio-server-l2 template: metadata: labels: app: fortio-server-l2 version: v1 spec: containers: - name: fortio-server-l2 # åœ¨ä¸­å›½ï¼Œä½ å¯ä»¥ä½¿ç”¨ docker.mirrors.ustc.edu.cn/fortio/fortio:latest image: fortio/fortio:latest ports: - containerPort: 8080 name: http-port - containerPort: 8072 name: http-m - containerPort: 8078 name: udp-port - containerPort: 8079 name: grpc-port - containerPort: 8081 name: https-port command: - fortio args: [\"server\", \"-P\", \"8072 fortio-server-l3:8080\"] --- apiVersion: v1 kind: Service metadata: name: fortio-server-l2 spec: ports: - name: http-m port: 8072 protocol: TCP targetPort: 8072 - name: http-port port: 8080 protocol: TCP targetPort: 8080 - name: https-port port: 8081 protocol: TCP targetPort: 8081 - name: http2-grpc port: 8079 protocol: TCP targetPort: 8079 - name: udp-grpc port: 8078 protocol: UDP targetPort: 8078 selector: app: fortio-server-l2 type: NodePort --- apiVersion: apps/v1 kind: Deployment metadata: name: fortio-server-l1 labels: app: fortio-server-l1 version: v1 spec: replicas: 1 selector: matchLabels: app: fortio-server-l1 template: metadata: labels: app: fortio-server-l1 version: v1 spec: containers: - name: fortio-server-l1 # åœ¨ä¸­å›½ï¼Œä½ å¯ä»¥ä½¿ç”¨ docker.mirrors.ustc.edu.cn/fortio/fortio:latest image: fortio/fortio:latest ports: - containerPort: 8080 name: http-port - containerPort: 8071 name: http-m - containerPort: 8078 name: udp-port - containerPort: 8079 name: grpc-port - containerPort: 8081 name: https-port command: - fortio args: [\"server\", \"-P\", \"8071 fortio-server-l2:8072\"] --- apiVersion: v1 kind: Service metadata: name: fortio-server-l1 spec: ports: - name: http-m port: 8071 protocol: TCP targetPort: 8071 - name: http-port port: 8080 protocol: TCP targetPort: 8080 - name: https-port port: 8081 protocol: TCP targetPort: 8081 - name: http2-grpc port: 8079 protocol: TCP targetPort: 8079 - name: udp-grpc port: 8078 protocol: UDP targetPort: 8078 selector: app: fortio-server-l1 type: NodePort apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: fortio-server-l1 spec: hosts: - fortio-server-l1 http: - route: - destination: host: fortio-server-l1 subset: v1 weight: 10 - destination: host: fortio-server-l1 subset: v2 weight: 90 --- apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: fortio-server-l2 spec: hosts: - fortio-server-l2 http: - route: - destination: host: fortio-server-l2 subset: v1 weight: 0 - destination: host: fortio-server-l2 subset: v2 weight: 100 --- apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: fortio-server-l1 spec: host: fortio-server-l1 subsets: - name: v1 labels: version: v1 - name: v2 labels: version: v2 --- apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: fortio-server-l2 spec: host: fortio-server-l2 subsets: - name: v1 labels: version: v1 - name: v2 labels: version: v2 ","date":"2022-09-11","objectID":"/posts/129682/:3:2","tags":["istio"],"title":"Istioæ€§èƒ½æµ‹è¯•","uri":"/posts/129682/"},{"categories":["äº‘åŸç”Ÿ"],"content":"éƒ¨ç½²å‹æµ‹å·¥å…· apiVersion: apps/v1 kind: Deployment metadata: name: fortio-client labels: app: fortio-client version: v2 spec: replicas: 1 selector: matchLabels: app: fortio-client template: metadata: labels: app: fortio-client version: v2 spec: containers: - name: fortio-client image: fortio/fortio:latest ports: - containerPort: 8080 name: http-port - containerPort: 8078 name: udp-port - containerPort: 8079 name: grpc-port - containerPort: 8081 name: https-port command: - fortio - server --- apiVersion: v1 kind: Service metadata: name: fortio-client spec: ports: - name: http-port port: 8080 protocol: TCP targetPort: 8080 - name: https-port port: 8081 protocol: TCP targetPort: 8081 - name: http2-grpc port: 8079 protocol: TCP targetPort: 8079 - name: udp-grpc port: 8078 protocol: UDP targetPort: 8078 selector: app: fortio-client type: NodePort æ€§èƒ½å‹æµ‹ å‹æµ‹æŠ¥å‘Š ç”»çº¢çº¿éƒ¨åˆ† min: æœ€å°å“åº”æ—¶é—´2.97ms average: å¹³å‡å“åº”æ—¶é—´11.286ms P50: 50%çš„è¯·æ±‚å“åº”æ—¶é—´åœ¨10.18mså†… P75: 75%çš„è¯·æ±‚å“åº”æ—¶é—´åœ¨13.48mså†… P90: 90%çš„è¯·æ±‚å“åº”æ—¶é—´åœ¨17.13mså†… P99: 99%çš„è¯·æ±‚å“åº”æ—¶é—´åœ¨29.89mså†… P99.9: 99.9%çš„è¯·æ±‚å“åº”æ—¶é—´åœ¨80.91mså†… max: æœ€å¤§å“åº”æ—¶é—´324.597ms å‚è€ƒèµ„æ–™ è®°ä¸€æ¬¡ Istio å†²åˆºè°ƒä¼˜ ä½ çš„ Istio Mesh æ€§èƒ½åŠæ ¼å— Istio æ€§èƒ½åŸºå‡†æµ‹è¯• æ€§èƒ½ç»˜å›¾ Istio æ€§èƒ½å’Œå¯æ‰©å±•æ€§ ","date":"2022-09-11","objectID":"/posts/129682/:4:0","tags":["istio"],"title":"Istioæ€§èƒ½æµ‹è¯•","uri":"/posts/129682/"},{"categories":["äº‘åŸç”Ÿ"],"content":"Helm å®‰è£… ","date":"2022-09-11","objectID":"/posts/bf667a/:1:0","tags":["istio"],"title":"Istioéƒ¨ç½²å®æˆ˜","uri":"/posts/bf667a/"},{"categories":["äº‘åŸç”Ÿ"],"content":"å®‰è£…åŸºç¡€èµ„æº helm template istio-base manifests/charts/base \\ -n istio-system \\ --set base.enableCRDTemplates=true --- # Source: base/templates/reader-serviceaccount.yaml # This service account aggregates reader permissions for the revisions in a given cluster # Should be used for remote secret creation. apiVersion: v1 kind: ServiceAccount metadata: name: istio-reader-service-account namespace: istio-system labels: app: istio-reader release: istio-base --- # Source: base/templates/serviceaccount.yaml # -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- # DO NOT EDIT! # THIS IS A LEGACY CHART HERE FOR BACKCOMPAT # UPDATED CHART AT manifests/charts/istio-control/istio-discovery # -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=- apiVersion: v1 kind: ServiceAccount metadata: name: istiod-service-account namespace: istio-system labels: app: istiod release: istio-base --- # Source: base/templates/crds.yaml # DO NOT EDIT - Generated by Cue OpenAPI generator based on Istio APIs. apiVersion: apiextensions.k8s.io/v1 kind: CustomResourceDefinition metadata: annotations: \"helm.sh/resource-policy\": keep labels: app: istio-pilot chart: istio heritage: Tiller release: istio name: wasmplugins.extensions.istio.io spec: group: extensions.istio.io names: categories: - istio-io - extensions-istio-io kind: WasmPlugin listKind: WasmPluginList plural: wasmplugins singular: wasmplugin scope: Namespaced versions: - additionalPrinterColumns: - description: 'CreationTimestamp is a timestamp representing the server time when this object was created. It is not guaranteed to be set in happens-before order across separate operations. Clients may not set this value. It is represented in RFC3339 form and is in UTC. Populated by the system. Read-only. Null for lists. More info: https://git.k8s.io/community/contributors/devel/api-conventions.md#metadata' jsonPath: .metadata.creationTimestamp name: Age type: date name: v1alpha1 schema: openAPIV3Schema: properties: spec: description: 'Extend the functionality provided by the Istio proxy through WebAssembly filters. See more details at: https://istio.io/docs/reference/config/proxy_extensions/wasm-plugin.html' properties: imagePullPolicy: description: The pull behaviour to be applied when fetching an OCI image. enum: - UNSPECIFIED_POLICY - IfNotPresent - Always type: string imagePullSecret: description: Credentials to use for OCI image pulling. type: string phase: description: Determines where in the filter chain this `WasmPlugin` is to be injected. enum: - UNSPECIFIED_PHASE - AUTHN - AUTHZ - STATS type: string pluginConfig: description: The configuration that will be passed on to the plugin. type: object x-kubernetes-preserve-unknown-fields: true pluginName: type: string priority: description: Determines ordering of `WasmPlugins` in the same `phase`. nullable: true type: integer selector: properties: matchLabels: additionalProperties: type: string type: object type: object sha256: description: SHA256 checksum that will be used to verify Wasm module or OCI container. type: string url: description: URL of a Wasm module or OCI container. type: string verificationKey: type: string type: object status: type: object x-kubernetes-preserve-unknown-fields: true type: object served: true storage: true subresources: status: {} --- # Source: base/templates/crds.yaml apiVersion: apiextensions.k8s.io/v1 kind: CustomResourceDefinition metadata: annotations: \"helm.sh/resource-policy\": keep labels: app: istio-pilot chart: istio heritage: Tiller release: istio name: destinationrules.networking.istio.io spec: group: networking.istio.io names: categories: - istio-io - networking-istio-io kind: DestinationRule listKind: DestinationRuleList plural: destinationrules shortNames: - dr singular: destinationrule scope: Namespaced versions: - additionalPrinterColumns: - description: The name of a service from the service registry jsonPath: .spec.host name: Host type: string - description: 'CreationTimestamp is a timestamp representing the server time when this ob","date":"2022-09-11","objectID":"/posts/bf667a/:1:1","tags":["istio"],"title":"Istioéƒ¨ç½²å®æˆ˜","uri":"/posts/bf667a/"},{"categories":["äº‘åŸç”Ÿ"],"content":"å®‰è£…Istiod helm template istiod manifests/charts/istio-control/istio-discovery \\ --set global.hub=\"registry.cn-hangzhou.aliyuncs.com/seam\" \\ --set global.tag=\"1.13.4\" \\ --set pilot.image=\"istio-pilot\" \\ --set meshConfig.trustDomain=\"alongparty.cn\" \\ --set global.proxy.clusterDomain=\"alongparty.cn\" \\ --set global.proxy.resources.limits.cpu=\"2000m\" \\ --set global.proxy.resources.limits.memory=\"4096Mi\" \\ --set pilot.resources.limits.cpu=\"2000m\" \\ --set pilot.resources.limits.memory=\"4096Mi\" \\ -n istio-system ","date":"2022-09-11","objectID":"/posts/bf667a/:1:2","tags":["istio"],"title":"Istioéƒ¨ç½²å®æˆ˜","uri":"/posts/bf667a/"},{"categories":["äº‘åŸç”Ÿ"],"content":"å®‰è£…IngressGateway helm template istio-ingress manifests/charts/gateways/istio-ingress \\ --set global.hub=\"registry.cn-hangzhou.aliyuncs.com/seam\" \\ --set global.tag=\"1.13.4\" \\ --set global.proxy.image=\"istio-proxyv2\" \\ --set meshConfig.trustDomain=\"alongparty.cn\" \\ --set global.proxy.clusterDomain=\"alongparty.cn\" \\ -n istio-system ","date":"2022-09-11","objectID":"/posts/bf667a/:1:3","tags":["istio"],"title":"Istioéƒ¨ç½²å®æˆ˜","uri":"/posts/bf667a/"},{"categories":["äº‘åŸç”Ÿ"],"content":"å®‰è£…EgressGateway helm template istio-egress manifests/charts/gateways/istio-egress \\ --set global.hub=\"registry.cn-hangzhou.aliyuncs.com/seam\" \\ --set global.tag=\"1.13.4\" \\ --set global.proxy.image=\"istio-proxyv2\" \\ --set meshConfig.trustDomain=\"alongparty.cn\" \\ --set global.proxy.clusterDomain=\"alongparty.cn\" \\ -n istio-system ","date":"2022-09-11","objectID":"/posts/bf667a/:1:4","tags":["istio"],"title":"Istioéƒ¨ç½²å®æˆ˜","uri":"/posts/bf667a/"},{"categories":["äº‘åŸç”Ÿ"],"content":"Istio-operatorå®‰è£… ","date":"2022-09-11","objectID":"/posts/bf667a/:2:0","tags":["istio"],"title":"Istioéƒ¨ç½²å®æˆ˜","uri":"/posts/bf667a/"},{"categories":["äº‘åŸç”Ÿ"],"content":"åˆ›å»º istio-operator åç§°ç©ºé—´ kubectl apply -f - \u003c\u003cEOF --- apiVersion: v1 kind: Namespace metadata: name: istio-operator EOF ","date":"2022-09-11","objectID":"/posts/bf667a/:2:1","tags":["istio"],"title":"Istioéƒ¨ç½²å®æˆ˜","uri":"/posts/bf667a/"},{"categories":["äº‘åŸç”Ÿ"],"content":"éƒ¨ç½² Istio-operator kubectl apply -f - \u003c\u003cEOF --- # Source: istio-operator/templates/service_account.yaml apiVersion: v1 kind: ServiceAccount metadata: namespace: istio-operator name: istio-operator --- # Source: istio-operator/templates/crds.yaml # SYNC WITH manifests/charts/base/files apiVersion: apiextensions.k8s.io/v1 kind: CustomResourceDefinition metadata: name: istiooperators.install.istio.io labels: release: istio spec: conversion: strategy: None group: install.istio.io names: kind: IstioOperator listKind: IstioOperatorList plural: istiooperators singular: istiooperator shortNames: - iop - io scope: Namespaced versions: - additionalPrinterColumns: - description: Istio control plane revision jsonPath: .spec.revision name: Revision type: string - description: IOP current state jsonPath: .status.status name: Status type: string - description: 'CreationTimestamp is a timestamp representing the server time when this object was created. It is not guaranteed to be set in happens-before order across separate operations. Clients may not set this value. It is represented in RFC3339 form and is in UTC. Populated by the system. Read-only. Null for lists. More info: https://git.k8s.io/community/contributors/devel/api-conventions.md#metadata' jsonPath: .metadata.creationTimestamp name: Age type: date name: v1alpha1 subresources: status: {} schema: openAPIV3Schema: type: object x-kubernetes-preserve-unknown-fields: true served: true storage: true --- # Source: istio-operator/templates/clusterrole.yaml apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: creationTimestamp: null name: istio-operator rules: # istio groups - apiGroups: - authentication.istio.io resources: - '*' verbs: - '*' - apiGroups: - config.istio.io resources: - '*' verbs: - '*' - apiGroups: - install.istio.io resources: - '*' verbs: - '*' - apiGroups: - networking.istio.io resources: - '*' verbs: - '*' - apiGroups: - security.istio.io resources: - '*' verbs: - '*' # k8s groups - apiGroups: - admissionregistration.k8s.io resources: - mutatingwebhookconfigurations - validatingwebhookconfigurations verbs: - '*' - apiGroups: - apiextensions.k8s.io resources: - customresourcedefinitions.apiextensions.k8s.io - customresourcedefinitions verbs: - '*' - apiGroups: - apps - extensions resources: - daemonsets - deployments - deployments/finalizers - replicasets verbs: - '*' - apiGroups: - autoscaling resources: - horizontalpodautoscalers verbs: - '*' - apiGroups: - monitoring.coreos.com resources: - servicemonitors verbs: - get - create - update - apiGroups: - policy resources: - poddisruptionbudgets verbs: - '*' - apiGroups: - rbac.authorization.k8s.io resources: - clusterrolebindings - clusterroles - roles - rolebindings verbs: - '*' - apiGroups: - coordination.k8s.io resources: - leases verbs: - get - create - update - apiGroups: - \"\" resources: - configmaps - endpoints - events - namespaces - pods - pods/proxy - pods/portforward - persistentvolumeclaims - secrets - services - serviceaccounts verbs: - '*' --- # Source: istio-operator/templates/clusterrole_binding.yaml kind: ClusterRoleBinding apiVersion: rbac.authorization.k8s.io/v1 metadata: name: istio-operator subjects: - kind: ServiceAccount name: istio-operator namespace: istio-operator roleRef: kind: ClusterRole name: istio-operator apiGroup: rbac.authorization.k8s.io --- # Source: istio-operator/templates/service.yaml apiVersion: v1 kind: Service metadata: namespace: istio-operator labels: name: istio-operator name: istio-operator spec: ports: - name: http-metrics port: 8383 targetPort: 8383 protocol: TCP selector: name: istio-operator --- # Source: istio-operator/templates/deployment.yaml apiVersion: apps/v1 kind: Deployment metadata: namespace: istio-operator name: istio-operator spec: replicas: 1 revisionHistoryLimit: 10 selector: matchLabels: name: istio-operator template: metadata: labels: name: istio-operator spec: serviceAccountName: istio-operator containers: - name: istio-operator image: docker","date":"2022-09-11","objectID":"/posts/bf667a/:2:2","tags":["istio"],"title":"Istioéƒ¨ç½²å®æˆ˜","uri":"/posts/bf667a/"},{"categories":["äº‘åŸç”Ÿ"],"content":"åˆ›å»º istio-system åç§°ç©ºé—´ kubectl apply -f - \u003c\u003cEOF --- apiVersion: v1 kind: Namespace metadata: name: istio-system EOF ","date":"2022-09-11","objectID":"/posts/bf667a/:2:3","tags":["istio"],"title":"Istioéƒ¨ç½²å®æˆ˜","uri":"/posts/bf667a/"},{"categories":["äº‘åŸç”Ÿ"],"content":"ä½¿ç”¨demoé…ç½®é¡¹å®‰è£…istioç»„ä»¶ kubectl apply -f - \u003c\u003cEOF apiVersion: install.istio.io/v1alpha1 kind: IstioOperator metadata: namespace: istio-system name: istiocontrolplane spec: profile: demo EOF ","date":"2022-09-11","objectID":"/posts/bf667a/:2:4","tags":["istio"],"title":"Istioéƒ¨ç½²å®æˆ˜","uri":"/posts/bf667a/"},{"categories":["äº‘åŸç”Ÿ"],"content":"æ›´æ–°IstioOperator kubectl apply -f - \u003c\u003cEOF apiVersion: install.istio.io/v1alpha1 kind: IstioOperator metadata: namespace: istio-system name: istiocontrolplane spec: profile: default EOF ","date":"2022-09-11","objectID":"/posts/bf667a/:2:5","tags":["istio"],"title":"Istioéƒ¨ç½²å®æˆ˜","uri":"/posts/bf667a/"},{"categories":["äº‘åŸç”Ÿ"],"content":"å¯ç”¨ istio-egressgateway ç»„ä»¶å¹¶å¢åŠ  pilot çš„èµ„æºè¦æ±‚å’ŒHPA kubectl apply -f - \u003c\u003cEOF apiVersion: install.istio.io/v1alpha1 kind: IstioOperator metadata: namespace: istio-system name: istiocontrolplane spec: profile: default components: pilot: k8s: resources: requests: cpu: 1000m # override from default 500m memory: 4096Mi # ... default 2048Mi hpaSpec: maxReplicas: 10 # ... default 5 minReplicas: 2 # ... default 1 egressGateways: - name: istio-egressgateway enabled: true EOF operator æ¸²æŸ“é¡ºåº ","date":"2022-09-11","objectID":"/posts/bf667a/:2:6","tags":["istio"],"title":"Istioéƒ¨ç½²å®æˆ˜","uri":"/posts/bf667a/"},{"categories":null,"content":"ä¿®æ”¹è®¤è¯æ–¹å¼ # vim /etc/ocserv/ocserv.conf auth = \"plain[passwd=/etc/ocserv/ocpasswd,otp=/etc/ocserv/ocserv.otp]\" ","date":"2022-09-11","objectID":"/posts/e96811/:0:1","tags":null,"title":"openconnectåŒå› ç´ è®¤è¯","uri":"/posts/e96811/"},{"categories":null,"content":"é…ç½®pam echo \"auth requisite pam_oath.so debug usersfile=/etc/ocserv/ocserv.otp window=20\" \u003e\u003e /etc/pam.d/ocserv ","date":"2022-09-11","objectID":"/posts/e96811/:0:2","tags":null,"title":"openconnectåŒå› ç´ è®¤è¯","uri":"/posts/e96811/"},{"categories":null,"content":"åˆ›å»ºç”¨æˆ·OTP username=\"zengshenglong\" company=\"Company\" site_name=\"Site\" key=$(head -c 16 /dev/urandom |xxd -c 256 -ps) echo \"HOTP/T30 ${username} - ${key}\" \u003e\u003e/etc/ocserv/ocserv.otp oathtool --totp -w 5 $key secret=$(echo 0x${key}|xxd -r -c 256|base32) echo \"otpauth://hotp/${username}@${site_name}?secret=${secret}\u0026issuer=${company}\" | qrencode -o - -t UTF8 echo \"https://www.google.com/chart?chs=200x200\u0026chld=M|0\u0026cht=qr\u0026chl=otpauth://hotp/${username}@${site_name}?secret=$(echo ${secret}|cut -d = -f 1)\u0026issuer=${company}\" ","date":"2022-09-11","objectID":"/posts/e96811/:0:3","tags":null,"title":"openconnectåŒå› ç´ è®¤è¯","uri":"/posts/e96811/"},{"categories":null,"content":"å®Œæ•´é…ç½® auth = \"plain[passwd=/etc/ocserv/ocpasswd,otp=/etc/ocserv/ocserv.otp]\" tcp-port = 443 udp-port = 443 run-as-user = nobody run-as-group = daemon socket-file = /var/run/ocserv-socket server-cert = /etc/letsencrypt/live/myvpn.alongparty.cn/fullchain.pem server-key = /etc/letsencrypt/live/myvpn.alongparty.cn/privkey.pem isolate-workers = false banner = \"Welcome PCI DSS environment, please proceed with caution ! !\" pre-login-banner = \"You will enter the PCI DSS environment, please proceed with caution ! !\" max-clients = 16 max-same-clients = 2 rate-limit-ms = 100 server-stats-reset-time = 604800 keepalive = 32400 dpd = 90 mobile-dpd = 1800 switch-to-tcp-timeout = 25 try-mtu-discovery = true cert-user-oid = 0.9.2342.19200300.100.1.1 tls-priorities = \"NORMAL:%SERVER_PRECEDENCE:%COMPAT:-VERS-SSL3.0:-VERS-TLS1.0:-VERS-TLS1.1\" auth-timeout = 240 min-reauth-time = 300 max-ban-score = 80 ban-reset-time = 1200 cookie-timeout = 300 deny-roaming = false rekey-time = 172800 rekey-method = ssl use-occtl = true pid-file = /var/run/ocserv.pid device = vpns predictable-ips = true default-domain = example.com ipv4-network = 10.255.255.0 ipv4-netmask = 255.255.255.0 tunnel-all-dns = true dns = 8.8.8.8 dns = 4.2.2.4 dns = 2001:4860:4860::8888 dns = 2001:4860:4860::8844 ping-leases = false config-per-group = /etc/ocserv/group default-group-config = /etc/ocserv/group/default default-select-group = default auto-select-group = false cisco-client-compat = true dtls-legacy = true ","date":"2022-09-11","objectID":"/posts/e96811/:0:4","tags":null,"title":"openconnectåŒå› ç´ è®¤è¯","uri":"/posts/e96811/"},{"categories":null,"content":"1.é¦–å…ˆæ·»åŠ ä¸¤ä¸ªå¸¦åˆ†ç»„çš„ç”¨æˆ· ocpasswd -c /etc/ocserv/ocpasswd -g gruop1 user1 ocpasswd -c /etc/ocserv/ocpasswd -g gruop2 user2 ","date":"2022-09-11","objectID":"/posts/bf9138/:0:1","tags":null,"title":"openconnectè®¾ç½®ç”¨æˆ·ç»„å®ç°å¤šè·¯ç”±","uri":"/posts/bf9138/"},{"categories":null,"content":"2.æ·»åŠ åˆ›å»ºè·¯ç”±è¡¨ç»„ mkdir /etc/ocserv/group echo -e \"route = 10.10.0.0/255.255.255.0\" \u003e\u003e /etc/ocserv/group/group1 echo -e \"no-route = 211.80.0.0/255.240.0.0\" \u003e\u003e /etc/ocserv/group/group2 ä»¥ä¸Šè¿ä¸ªè·¯ç”±è¡¨æ˜¯æ¼”ç¤ºgroup1å’Œgroup2éšä¾¿å†™çš„ è¯·è‡ªè¡Œæ·»åŠ è·¯ç”±è§„åˆ™ æ­¤å¤–è·¯ç”±è¡¨é‡Œè¿˜å¯ä»¥å†™DNS çŸ­çº¿æ—¶é—´çš„å‚æ•° ","date":"2022-09-11","objectID":"/posts/bf9138/:0:2","tags":null,"title":"openconnectè®¾ç½®ç”¨æˆ·ç»„å®ç°å¤šè·¯ç”±","uri":"/posts/bf9138/"},{"categories":null,"content":"3.æ·»åŠ æ–°çš„é…ç½®åˆ°ocserv.conf config-per-group = /etc/ocserv/group/ default-group-config = /etc/ocserv/group/group1 #å¦‚æœåˆ›å»ºç”¨æˆ·çš„æ—¶å€™ä¸åˆ†ç»„ group1å°±æ˜¯é»˜è®¤åˆ†ç»„ ç”¨çš„å°±æ˜¯group1çš„è·¯ç”±è¡¨ default-select-group = group1 #å¦‚æœåˆ›å»ºç”¨æˆ·çš„æ—¶å€™ä¸åˆ†ç»„ group1å°±æ˜¯é»˜è®¤åˆ†ç»„ ç”¨çš„å°±æ˜¯group1çš„è·¯ç”±è¡¨ auto-select-group = false ","date":"2022-09-11","objectID":"/posts/bf9138/:0:3","tags":null,"title":"openconnectè®¾ç½®ç”¨æˆ·ç»„å®ç°å¤šè·¯ç”±","uri":"/posts/bf9138/"},{"categories":null,"content":"4.å®Œæ•´é…ç½® auth = \"plain[/etc/ocserv/ocpasswd]\" tcp-port = 443 udp-port = 443 run-as-user = nobody run-as-group = daemon socket-file = /var/run/ocserv-socket server-cert = /etc/letsencrypt/live/myvpn.alongparty.cn/fullchain.pem server-key = /etc/letsencrypt/live/myvpn.alongparty.cn/privkey.pem isolate-workers = false max-clients = 16 max-same-clients = 2 rate-limit-ms = 100 server-stats-reset-time = 604800 keepalive = 32400 dpd = 90 mobile-dpd = 1800 switch-to-tcp-timeout = 25 try-mtu-discovery = true cert-user-oid = 0.9.2342.19200300.100.1.1 tls-priorities = \"NORMAL:%SERVER_PRECEDENCE:%COMPAT:-VERS-SSL3.0:-VERS-TLS1.0:-VERS-TLS1.1\" auth-timeout = 240 min-reauth-time = 300 max-ban-score = 80 ban-reset-time = 1200 cookie-timeout = 300 deny-roaming = false rekey-time = 172800 rekey-method = ssl use-occtl = true pid-file = /var/run/ocserv.pid device = vpns predictable-ips = true default-domain = example.com ipv4-network = 10.255.255.0 ipv4-netmask = 255.255.255.0 tunnel-all-dns = true dns = 8.8.8.8 dns = 4.2.2.4 dns = 2001:4860:4860::8888 dns = 2001:4860:4860::8844 ping-leases = false config-per-group = /etc/ocserv/group/ default-group-config = /etc/ocserv/group/default default-select-group = default auto-select-group = false cisco-client-compat = true dtls-legacy = true # cat /etc/ocserv/group/default route = 10.48.16.124/32 # cat /etc/ocserv/ocpasswd sysop01:sysop:$5$R7HQXGtZ1MpB.N82$iNf5viGa/XT/qLjfpFhPNqlvdEyw5KKaKZvK2jIVEG4 ","date":"2022-09-11","objectID":"/posts/bf9138/:0:4","tags":null,"title":"openconnectè®¾ç½®ç”¨æˆ·ç»„å®ç°å¤šè·¯ç”±","uri":"/posts/bf9138/"},{"categories":null,"content":"Iâ€™m kbsonlong, a full-time full-stack freelance SRE ğŸ‘¨â€ğŸ’»ğŸš€ ğŸ”­ Iâ€™m currently working on Joyy ğŸŒ± Iâ€™m currently learning Vueã€Golang and Istio. â“ âš¡ ","date":"2022-09-11","objectID":"/about/:0:1","tags":null,"title":"å…³äº","uri":"/about/"},{"categories":null,"content":"æ­£åœ¨å­¦ä¹  ","date":"2022-09-11","objectID":"/about/:1:0","tags":null,"title":"å…³äº","uri":"/about/"},{"categories":null,"content":"Service Mesh ","date":"2022-09-11","objectID":"/about/:1:1","tags":null,"title":"å…³äº","uri":"/about/"},{"categories":null,"content":"Vue ","date":"2022-09-11","objectID":"/about/:1:2","tags":null,"title":"å…³äº","uri":"/about/"},{"categories":null,"content":"Go ","date":"2022-09-11","objectID":"/about/:1:3","tags":null,"title":"å…³äº","uri":"/about/"},{"categories":null,"content":"æ±‡ç¼–å’Œå·¥å…·: ğŸ›  ","date":"2022-09-11","objectID":"/about/:2:0","tags":null,"title":"å…³äº","uri":"/about/"},{"categories":null,"content":"Frontend ","date":"2022-09-11","objectID":"/about/:2:1","tags":null,"title":"å…³äº","uri":"/about/"},{"categories":null,"content":"Backend ","date":"2022-09-11","objectID":"/about/:2:2","tags":null,"title":"å…³äº","uri":"/about/"},{"categories":null,"content":"DevOps ","date":"2022-09-11","objectID":"/about/:2:3","tags":null,"title":"å…³äº","uri":"/about/"},{"categories":null,"content":"Github Stats ","date":"2022-09-11","objectID":"/about/:3:0","tags":null,"title":"å…³äº","uri":"/about/"},{"categories":null,"content":"kbsonlong's friends","date":"2022-09-10","objectID":"/friends/","tags":null,"title":"å‹é“¾","uri":"/friends/"},{"categories":null,"content":"å‹é“¾äº¤æ¢ - nickname: èœ·ç¼©çš„èœ—ç‰› avatar: https://raw.githubusercontent.com/kbsonlong/picgo-imgs/master/images/20220524130401.png url: https://www.alongparty.cn description: è¿ç»´è‡ªåŠ¨åŒ– Notice å¦‚æœæ‚¨æƒ³äº¤æ¢é“¾æ¥ï¼Œè¯·ä»¥ä¸Šè¿°æ ¼å¼å‘è¡¨è¯„è®ºã€‚ ï¼ˆä»…é™ä¸ªäººéå•†ä¸šåšå®¢/ç½‘ç«™ï¼‰ ç½‘ç«™æ•…éšœã€åœæ­¢ç»´æŠ¤å’Œä¸å½“å†…å®¹å¯èƒ½ä¼šè¢«å–æ¶ˆé“¾æ¥ï¼ ä¸å°Šé‡ä»–äººåŠ³åŠ¨æˆæœã€æ— æºè½¬è½½ã€æ¶æ„è¡Œä¸ºçš„ç½‘ç«™ï¼Œè¯·å‹¿å‰æ¥äº¤æµã€‚ ","date":"2022-09-10","objectID":"/friends/:1:0","tags":null,"title":"å‹é“¾","uri":"/friends/"},{"categories":["äº‘åŸç”Ÿ"],"content":"æœ¬æ–‡å°†ä¸ºä½ è®²è§£ï¼š Istio ä¸­ sidecar è‡ªåŠ¨æ³¨å…¥è¿‡ç¨‹ Istio ä¸­çš„ init å®¹å™¨å¯åŠ¨è¿‡ç¨‹ å¯ç”¨äº† Sidecar è‡ªåŠ¨æ³¨å…¥çš„ Pod çš„å¯åŠ¨æµç¨‹ ä¸‹å›¾ä¸­å±•ç¤ºäº† Istio æ•°æ®å¹³é¢ä¸­çš„ Pod å¯åŠ¨å®Œåçš„ç»„ä»¶ã€‚ ","date":"2022-09-10","objectID":"/posts/dc5625/:0:0","tags":["istio","è½¬è½½"],"title":"Istio æ•°æ®å¹³é¢Podå¯åŠ¨è¿‡ç¨‹è¯¦è§£","uri":"/posts/dc5625/"},{"categories":["äº‘åŸç”Ÿ"],"content":"Istio ä¸­çš„ sidecar æ³¨å…¥ Istio ä¸­æä¾›äº†ä»¥ä¸‹ä¸¤ç§ sidecar æ³¨å…¥æ–¹å¼ï¼š ä½¿ç”¨ istioctl æ‰‹åŠ¨æ³¨å…¥ã€‚ åŸºäº Kubernetes çš„ çªå˜ webhook å‡†å…¥æ§åˆ¶å™¨ï¼ˆmutating webhook addmission controller çš„è‡ªåŠ¨ sidecar æ³¨å…¥æ–¹å¼ã€‚ ä¸è®ºæ˜¯æ‰‹åŠ¨æ³¨å…¥è¿˜æ˜¯è‡ªåŠ¨æ³¨å…¥ï¼Œsidecar çš„æ³¨å…¥è¿‡ç¨‹éƒ½éœ€è¦éµå¾ªå¦‚ä¸‹æ­¥éª¤ï¼š Kubernetes éœ€è¦äº†è§£å¾…æ³¨å…¥çš„ sidecar æ‰€è¿æ¥çš„ Istio é›†ç¾¤åŠå…¶é…ç½®ï¼› Kubernetes éœ€è¦äº†è§£å¾…æ³¨å…¥çš„ sidecar å®¹å™¨æœ¬èº«çš„é…ç½®ï¼Œå¦‚é•œåƒåœ°å€ã€å¯åŠ¨å‚æ•°ç­‰ï¼› Kubernetes æ ¹æ® sidecar æ³¨å…¥æ¨¡æ¿å’Œä»¥ä¸Šé…ç½®å¡«å…… sidecar çš„é…ç½®å‚æ•°ï¼Œå°†ä»¥ä¸Šé…ç½®æ³¨å…¥åˆ°åº”ç”¨å®¹å™¨çš„ä¸€ä¾§ï¼› ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å¯ä»¥æ‰‹åŠ¨æ³¨å…¥ sidecarã€‚ istioctl kube-inject -f ${YAML_FILE} | kuebectl apply -f - è¯¥å‘½ä»¤ä¼šä½¿ç”¨ Istio å†…ç½®çš„ sidecar é…ç½®æ¥æ³¨å…¥ï¼Œä¸‹é¢ä½¿ç”¨ Istioè¯¦ç»†é…ç½®è¯·å‚è€ƒ Istio å®˜ç½‘ã€‚ æ³¨å…¥å®Œæˆåæ‚¨å°†çœ‹åˆ° Istio ä¸ºåŸæœ‰ pod template æ³¨å…¥äº† initContainer åŠ sidecar proxyç›¸å…³çš„é…ç½®ã€‚ ","date":"2022-09-10","objectID":"/posts/dc5625/:1:0","tags":["istio","è½¬è½½"],"title":"Istio æ•°æ®å¹³é¢Podå¯åŠ¨è¿‡ç¨‹è¯¦è§£","uri":"/posts/dc5625/"},{"categories":["äº‘åŸç”Ÿ"],"content":"Init å®¹å™¨ Init å®¹å™¨æ˜¯ä¸€ç§ä¸“ç”¨å®¹å™¨ï¼Œå®ƒåœ¨åº”ç”¨ç¨‹åºå®¹å™¨å¯åŠ¨ä¹‹å‰è¿è¡Œï¼Œç”¨æ¥åŒ…å«ä¸€äº›åº”ç”¨é•œåƒä¸­ä¸å­˜åœ¨çš„å®ç”¨å·¥å…·æˆ–å®‰è£…è„šæœ¬ã€‚ ä¸€ä¸ª Pod ä¸­å¯ä»¥æŒ‡å®šå¤šä¸ª Init å®¹å™¨ï¼Œå¦‚æœæŒ‡å®šäº†å¤šä¸ªï¼Œé‚£ä¹ˆ Init å®¹å™¨å°†ä¼šæŒ‰é¡ºåºä¾æ¬¡è¿è¡Œã€‚åªæœ‰å½“å‰é¢çš„ Init å®¹å™¨å¿…é¡»è¿è¡ŒæˆåŠŸåï¼Œæ‰å¯ä»¥è¿è¡Œä¸‹ä¸€ä¸ª Init å®¹å™¨ã€‚å½“æ‰€æœ‰çš„ Init å®¹å™¨è¿è¡Œå®Œæˆåï¼ŒKubernetes æ‰åˆå§‹åŒ– Pod å’Œè¿è¡Œåº”ç”¨å®¹å™¨ã€‚ Init å®¹å™¨ä½¿ç”¨ Linux Namespaceï¼Œæ‰€ä»¥ç›¸å¯¹åº”ç”¨ç¨‹åºå®¹å™¨æ¥è¯´å…·æœ‰ä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿè§†å›¾ã€‚å› æ­¤ï¼Œå®ƒä»¬èƒ½å¤Ÿå…·æœ‰è®¿é—® Secret çš„æƒé™ï¼Œè€Œåº”ç”¨ç¨‹åºå®¹å™¨åˆ™ä¸èƒ½ã€‚ åœ¨ Pod å¯åŠ¨è¿‡ç¨‹ä¸­ï¼ŒInit å®¹å™¨ä¼šæŒ‰é¡ºåºåœ¨ç½‘ç»œå’Œæ•°æ®å·åˆå§‹åŒ–ä¹‹åå¯åŠ¨ã€‚æ¯ä¸ªå®¹å™¨å¿…é¡»åœ¨ä¸‹ä¸€ä¸ªå®¹å™¨å¯åŠ¨ä¹‹å‰æˆåŠŸé€€å‡ºã€‚å¦‚æœç”±äºè¿è¡Œæ—¶æˆ–å¤±è´¥é€€å‡ºï¼Œå°†å¯¼è‡´å®¹å™¨å¯åŠ¨å¤±è´¥ï¼Œå®ƒä¼šæ ¹æ® Pod çš„ restartPolicy æŒ‡å®šçš„ç­–ç•¥è¿›è¡Œé‡è¯•ã€‚ç„¶è€Œï¼Œå¦‚æœ Pod çš„ restartPolicy è®¾ç½®ä¸º Alwaysï¼ŒInit å®¹å™¨å¤±è´¥æ—¶ä¼šä½¿ç”¨ RestartPolicy ç­–ç•¥ã€‚ åœ¨æ‰€æœ‰çš„ Init å®¹å™¨æ²¡æœ‰æˆåŠŸä¹‹å‰ï¼ŒPod å°†ä¸ä¼šå˜æˆ Ready çŠ¶æ€ã€‚Init å®¹å™¨çš„ç«¯å£å°†ä¸ä¼šåœ¨ Serviceä¸­è¿›è¡Œèšé›†ã€‚ æ­£åœ¨åˆå§‹åŒ–ä¸­çš„ Pod å¤„äº Pending çŠ¶æ€ï¼Œä½†åº”è¯¥ä¼šå°† Initializing çŠ¶æ€è®¾ç½®ä¸º trueã€‚Init å®¹å™¨è¿è¡Œå®Œæˆä»¥åå°±ä¼šè‡ªåŠ¨ç»ˆæ­¢ã€‚ å…³äº Init å®¹å™¨çš„è¯¦ç»†ä¿¡æ¯è¯·å‚è€ƒ Init å®¹å™¨ - Kubernetes ä¸­æ–‡æŒ‡å—/äº‘åŸç”Ÿåº”ç”¨æ¶æ„å®è·µæ‰‹å†Œã€‚ ","date":"2022-09-10","objectID":"/posts/dc5625/:1:1","tags":["istio","è½¬è½½"],"title":"Istio æ•°æ®å¹³é¢Podå¯åŠ¨è¿‡ç¨‹è¯¦è§£","uri":"/posts/dc5625/"},{"categories":["äº‘åŸç”Ÿ"],"content":"Init å®¹å™¨è§£æ Istio åœ¨ pod ä¸­æ³¨å…¥çš„ Init å®¹å™¨åä¸º istio-initï¼Œæˆ‘ä»¬åœ¨ä¸Šé¢ Istio æ³¨å…¥å®Œæˆåçš„ YAML æ–‡ä»¶ä¸­çœ‹åˆ°äº†è¯¥å®¹å™¨çš„å¯åŠ¨å‘½ä»¤æ˜¯ï¼š istio-iptables -p 15001 -z 15006 -u 1337 -m REDIRECT -i '*' -x \"\" -b '*' -d 15090,15020 æˆ‘ä»¬å†æ£€æŸ¥ä¸‹è¯¥å®¹å™¨çš„ Dockerfile çœ‹çœ‹ ENTRYPOINT æ˜¯æ€ä¹ˆç¡®å®šå¯åŠ¨æ—¶æ‰§è¡Œçš„å‘½ä»¤ã€‚ # å‰é¢çš„å†…å®¹çœç•¥ # The pilot-agent will bootstrap Envoy. ENTRYPOINT [\"/usr/local/bin/pilot-agent\"] æˆ‘ä»¬çœ‹åˆ° istio-init å®¹å™¨çš„å…¥å£æ˜¯ /usr/local/bin/istio-iptables å‘½ä»¤è¡Œï¼Œè¯¥å‘½ä»¤è¡Œå·¥å…·çš„ä»£ç çš„ä½ç½®åœ¨ Istio æºç ä»“åº“çš„ tools/istio-iptables ç›®å½•ã€‚ æ³¨æ„ï¼šåœ¨ Istio 1.1 ç‰ˆæœ¬æ—¶è¿˜æ˜¯ä½¿ç”¨ isito-iptables.sh å‘½ä»¤è¡Œæ¥æ“ä½œ IPtablesã€‚ ","date":"2022-09-10","objectID":"/posts/dc5625/:2:0","tags":["istio","è½¬è½½"],"title":"Istio æ•°æ®å¹³é¢Podå¯åŠ¨è¿‡ç¨‹è¯¦è§£","uri":"/posts/dc5625/"},{"categories":["äº‘åŸç”Ÿ"],"content":"Init å®¹å™¨å¯åŠ¨å…¥å£ Init å®¹å™¨çš„å¯åŠ¨å…¥å£æ˜¯ istio-iptables å‘½ä»¤è¡Œï¼Œè¯¥å‘½ä»¤è¡Œå·¥å…·çš„ç”¨æ³•å¦‚ä¸‹ï¼š $ istio-iptables [flags] -p: æŒ‡å®šé‡å®šå‘æ‰€æœ‰ TCP æµé‡çš„ sidecar ç«¯å£ï¼ˆé»˜è®¤ä¸º $ENVOY_PORT = 15001ï¼‰ -m: æŒ‡å®šå…¥ç«™è¿æ¥é‡å®šå‘åˆ° sidecar çš„æ¨¡å¼ï¼Œâ€œREDIRECTâ€ æˆ– â€œTPROXYâ€ï¼ˆé»˜è®¤ä¸º $ISTIO_INBOUND_INTERCEPTION_MODE) -b: é€—å·åˆ†éš”çš„å…¥ç«™ç«¯å£åˆ—è¡¨ï¼Œå…¶æµé‡å°†é‡å®šå‘åˆ° Envoyï¼ˆå¯é€‰ï¼‰ã€‚ä½¿ç”¨é€šé…ç¬¦ â€œ*â€ è¡¨ç¤ºé‡å®šå‘æ‰€æœ‰ç«¯å£ã€‚ä¸ºç©ºæ—¶è¡¨ç¤ºç¦ç”¨æ‰€æœ‰å…¥ç«™é‡å®šå‘ï¼ˆé»˜è®¤ä¸º $ISTIO_INBOUND_PORTSï¼‰ -d: æŒ‡å®šè¦ä»é‡å®šå‘åˆ° sidecar ä¸­æ’é™¤çš„å…¥ç«™ç«¯å£åˆ—è¡¨ï¼ˆå¯é€‰ï¼‰ï¼Œä»¥é€—å·æ ¼å¼åˆ†éš”ã€‚ä½¿ç”¨é€šé…ç¬¦â€œ*â€ è¡¨ç¤ºé‡å®šå‘æ‰€æœ‰å…¥ç«™æµé‡ï¼ˆé»˜è®¤ä¸º $ISTIO_LOCAL_EXCLUDE_PORTSï¼‰ -oï¼šé€—å·åˆ†éš”çš„å‡ºç«™ç«¯å£åˆ—è¡¨ï¼Œä¸åŒ…æ‹¬é‡å®šå‘åˆ° Envoy çš„ç«¯å£ã€‚ -i: æŒ‡å®šé‡å®šå‘åˆ° sidecar çš„ IP åœ°å€èŒƒå›´ï¼ˆå¯é€‰ï¼‰ï¼Œä»¥é€—å·åˆ†éš”çš„ CIDR æ ¼å¼åˆ—è¡¨ã€‚ä½¿ç”¨é€šé…ç¬¦ â€œ*â€ è¡¨ç¤ºé‡å®šå‘æ‰€æœ‰å‡ºç«™æµé‡ã€‚ç©ºåˆ—è¡¨å°†ç¦ç”¨æ‰€æœ‰å‡ºç«™é‡å®šå‘ï¼ˆé»˜è®¤ä¸º $ISTIO_SERVICE_CIDRï¼‰ -x: æŒ‡å®šå°†ä»é‡å®šå‘ä¸­æ’é™¤çš„ IP åœ°å€èŒƒå›´ï¼Œä»¥é€—å·åˆ†éš”çš„ CIDR æ ¼å¼åˆ—è¡¨ã€‚ä½¿ç”¨é€šé…ç¬¦ â€œ*â€ è¡¨ç¤ºé‡å®šå‘æ‰€æœ‰å‡ºç«™æµé‡ï¼ˆé»˜è®¤ä¸º $ISTIO_SERVICE_EXCLUDE_CIDRï¼‰ã€‚ -kï¼šé€—å·åˆ†éš”çš„è™šæ‹Ÿæ¥å£åˆ—è¡¨ï¼Œå…¶å…¥ç«™æµé‡ï¼ˆæ¥è‡ªè™šæ‹Ÿæœºçš„ï¼‰å°†è¢«è§†ä¸ºå‡ºç«™æµé‡ã€‚ -gï¼šæŒ‡å®šä¸åº”ç”¨é‡å®šå‘çš„ç”¨æˆ·çš„ GIDã€‚(é»˜è®¤å€¼ä¸ -u param ç›¸åŒ) -uï¼šæŒ‡å®šä¸åº”ç”¨é‡å®šå‘çš„ç”¨æˆ·çš„ UIDã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œè¿™æ˜¯ä»£ç†å®¹å™¨çš„ UIDï¼ˆé»˜è®¤å€¼æ˜¯ 1337ï¼Œå³ istio-proxy çš„ UIDï¼‰ã€‚ -z: æ‰€æœ‰è¿›å…¥ pod/VM çš„ TCP æµé‡åº”è¢«é‡å®šå‘åˆ°çš„ç«¯å£ï¼ˆé»˜è®¤ $INBOUND_CAPTURE_PORT = 15006ï¼‰ã€‚ ä»¥ä¸Šä¼ å…¥çš„å‚æ•°éƒ½ä¼šé‡æ–°ç»„è£…æˆ iptables è§„åˆ™ï¼Œå…³äºè¯¥å‘½ä»¤çš„è¯¦ç»†ç”¨æ³•è¯·è®¿é—® tools/istio-iptables/pkg/cmd/root.goã€‚ è¯¥å®¹å™¨å­˜åœ¨çš„æ„ä¹‰å°±æ˜¯è®© sidecar ä»£ç†å¯ä»¥æ‹¦æˆªæ‰€æœ‰çš„è¿›å‡º pod çš„æµé‡ï¼Œ15090 ç«¯å£ï¼ˆMixer ä½¿ç”¨ï¼‰å’Œ 15092 ç«¯å£ï¼ˆIngress Gatewayï¼‰é™¤å¤–çš„æ‰€æœ‰å…¥ç«™ï¼ˆinboundï¼‰æµé‡é‡å®šå‘åˆ° 15006 ç«¯å£ï¼ˆsidecarï¼‰ï¼Œå†æ‹¦æˆªåº”ç”¨å®¹å™¨çš„å‡ºç«™ï¼ˆoutboundï¼‰æµé‡ç»è¿‡ sidecar å¤„ç†ï¼ˆé€šè¿‡ 15001 ç«¯å£ç›‘å¬ï¼‰åå†å‡ºç«™ã€‚å…³äº Istio ä¸­ç«¯å£ç”¨é€”è¯·å‚è€ƒ Istio å®˜æ–¹æ–‡æ¡£ã€‚ å‘½ä»¤è§£æ è¿™æ¡å¯åŠ¨å‘½ä»¤çš„ä½œç”¨æ˜¯ï¼š å°†åº”ç”¨å®¹å™¨çš„æ‰€æœ‰æµé‡éƒ½è½¬å‘åˆ° sidecar çš„ 15006 ç«¯å£ã€‚ ä½¿ç”¨ istio-proxy ç”¨æˆ·èº«ä»½è¿è¡Œï¼Œ UID ä¸º 1337ï¼Œå³ sidecar æ‰€å¤„çš„ç”¨æˆ·ç©ºé—´ï¼Œè¿™ä¹Ÿæ˜¯ istio-proxy å®¹å™¨é»˜è®¤ä½¿ç”¨çš„ç”¨æˆ·ï¼Œè§ YAML é…ç½®ä¸­çš„ runAsUser å­—æ®µã€‚ ä½¿ç”¨é»˜è®¤çš„ REDIRECT æ¨¡å¼æ¥é‡å®šå‘æµé‡ã€‚ å°†æ‰€æœ‰å‡ºç«™æµé‡éƒ½é‡å®šå‘åˆ° sidecar ä»£ç†ï¼ˆé€šè¿‡ 15001 ç«¯å£ï¼‰ã€‚ å› ä¸º Init å®¹å™¨åˆå§‹åŒ–å®Œæ¯•åå°±ä¼šè‡ªåŠ¨ç»ˆæ­¢ï¼Œå› ä¸ºæˆ‘ä»¬æ— æ³•ç™»é™†åˆ°å®¹å™¨ä¸­æŸ¥çœ‹ iptables ä¿¡æ¯ï¼Œä½†æ˜¯ Init å®¹å™¨åˆå§‹åŒ–ç»“æœä¼šä¿ç•™åˆ°åº”ç”¨å®¹å™¨å’Œ sidecar å®¹å™¨ä¸­ã€‚ ","date":"2022-09-10","objectID":"/posts/dc5625/:2:1","tags":["istio","è½¬è½½"],"title":"Istio æ•°æ®å¹³é¢Podå¯åŠ¨è¿‡ç¨‹è¯¦è§£","uri":"/posts/dc5625/"},{"categories":["äº‘åŸç”Ÿ"],"content":"Pod å¯åŠ¨æµç¨‹ å¯ç”¨äº† Sidecar è‡ªåŠ¨æ³¨å…¥çš„ Pod å¯åŠ¨æµç¨‹å¦‚ä¸‹ï¼š Init å®¹å™¨å…ˆå¯åŠ¨ï¼Œå‘ Pod ä¸­æ³¨å…¥ iptables è§„åˆ™ï¼Œè¿›è¡Œé€æ˜æµé‡æ‹¦æˆªã€‚ éšåï¼ŒKubernetes ä¼šæ ¹æ® Pod Spec ä¸­å®¹å™¨çš„å£°æ˜é¡ºåºä¾æ¬¡å¯åŠ¨å®¹å™¨ï¼Œä½†è¿™æ˜¯éé˜»å¡çš„ï¼Œæ— æ³•ä¿è¯ç¬¬ä¸€ä¸ªå®¹å™¨å¯åŠ¨å®Œæˆåæ‰å¯åŠ¨ä¸‹ä¸€ä¸ªã€‚istio-proxy å®¹å™¨å¯åŠ¨æ—¶ï¼Œpilot-agent å°†ä½œä¸º PID 1 å·è¿›ç¨‹ï¼Œå®ƒæ˜¯ Linux ç”¨æˆ·ç©ºé—´çš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼Œè´Ÿè´£æ‹‰èµ·å…¶ä»–è¿›ç¨‹å’Œå¤„ç†åƒµå°¸è¿›ç¨‹ã€‚pilot-agent å°†ç”Ÿæˆ Envoy bootstrap é…ç½®å¹¶æ‹‰èµ· envoy è¿›ç¨‹ï¼›åº”ç”¨å®¹å™¨å‡ ä¹è·Ÿ istio-proxy å®¹å™¨åŒæ—¶å¯åŠ¨ï¼Œä¸ºäº†é˜²æ­¢ Pod å†…çš„å®¹å™¨åœ¨è¿˜æ²¡å¯åŠ¨å¥½çš„æƒ…å†µè€Œæ¥æ”¶åˆ°å¤–ç•Œæµé‡ï¼Œè¿™æ—¶å€™å°±ç»ªæ¢é’ˆå°±æ´¾ä¸Šç”¨åœºäº†ã€‚Kubernetes ä¼šåœ¨ istio-proxy å®¹å™¨çš„ 15021 ç«¯å£è¿›è¡Œå°±ç»ªæ£€æŸ¥ï¼Œç›´åˆ° isito-proxy å¯åŠ¨å®Œæˆå kubelet æ‰ä¼šå°†æµé‡è·¯ç”±åˆ° Pod å†…ã€‚ åœ¨ Pod å¯åŠ¨å®Œæˆåï¼Œpilot-agent å°†å˜ä¸ºå®ˆæŠ¤è¿›ç¨‹ç›‘è§†ç³»ç»Ÿå…¶ä»–è¿›ç¨‹ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œè¯¥è¿›ç¨‹è¿˜ä¸º Envoy æä¾› Bootstrap é…ç½®ã€è¯ä¹¦ã€å¥åº·æ£€æŸ¥ã€é…ç½®çƒ­åŠ è½½ã€èº«ä»½æ”¯æŒåŠè¿›ç¨‹ç”Ÿå‘½å‘¨æœŸç®¡ç†ç­‰ã€‚ ","date":"2022-09-10","objectID":"/posts/dc5625/:3:0","tags":["istio","è½¬è½½"],"title":"Istio æ•°æ®å¹³é¢Podå¯åŠ¨è¿‡ç¨‹è¯¦è§£","uri":"/posts/dc5625/"},{"categories":["äº‘åŸç”Ÿ"],"content":"Pod å†…å®¹å™¨å¯åŠ¨é¡ºåºé—®é¢˜ åœ¨ Pod å¯åŠ¨çš„è¿‡ç¨‹ä¸­å­˜åœ¨å®¹å™¨å¯åŠ¨é¡ºåºé—®é¢˜ï¼Œå‡è®¾ä¸‹é¢è¿™ç§æƒ…å†µï¼Œåº”ç”¨å®¹å™¨å…ˆå¯åŠ¨ï¼Œè¯·æ±‚å…¶ä»–æœåŠ¡ï¼Œè¿™æ—¶å€™ istio-proxy å®¹å™¨è¿˜æ²¡å¯åŠ¨å®Œæˆï¼Œé‚£ä¹ˆè¯¥è¯·æ±‚å°†ä¼šå¤±è´¥ï¼Œå¦‚æœä½ çš„åº”ç”¨çš„å¥å£®æ€§ä¸è¶³ï¼Œç”šè‡³å¯èƒ½å¯¼è‡´åº”ç”¨å®¹å™¨å´©æºƒï¼Œè¿›è€Œ Pod é‡å¯ã€‚å¯¹äºè¿™ç§æƒ…å†µçš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼š ä¿®æ”¹åº”ç”¨ç¨‹åºï¼Œå¢åŠ è¶…æ—¶é‡è¯•ã€‚ å¢åŠ åº”ç”¨å®¹å™¨ä¸­è¿›ç¨‹çš„å¯åŠ¨å»¶è¿Ÿï¼Œæ¯”å¦‚å¢åŠ  sleep æ—¶é—´ã€‚ åœ¨åº”ç”¨å®¹å™¨ä¸­å¢åŠ ä¸€ä¸ª postStart é…ç½®ï¼Œæ£€æµ‹åº”ç”¨è¿›ç¨‹æ˜¯å¦å¯åŠ¨å®Œæˆï¼Œåªæœ‰å½“æ£€æµ‹æˆåŠŸæ—¶ï¼ŒKubernetes æ‰ä¼šå°† Pod çš„çŠ¶æ€æ ‡è®°ä¸º Runningã€‚ ","date":"2022-09-10","objectID":"/posts/dc5625/:4:0","tags":["istio","è½¬è½½"],"title":"Istio æ•°æ®å¹³é¢Podå¯åŠ¨è¿‡ç¨‹è¯¦è§£","uri":"/posts/dc5625/"},{"categories":["äº‘åŸç”Ÿ"],"content":"æ€»ç»“ è¿™ç¯‡æ–‡ç« å¸¦é¢†å¤§å®¶äº†è§£äº† Istio æ•°æ®å¹³é¢ä¸­çš„ Pod å¯åŠ¨è¿‡ç¨‹ï¼Œè¿˜æœ‰å› ä¸º Pod å†…å®¹å™¨å¯åŠ¨é¡ºåºå¸¦æ¥çš„é—®é¢˜ã€‚ ","date":"2022-09-10","objectID":"/posts/dc5625/:5:0","tags":["istio","è½¬è½½"],"title":"Istio æ•°æ®å¹³é¢Podå¯åŠ¨è¿‡ç¨‹è¯¦è§£","uri":"/posts/dc5625/"},{"categories":["äº‘åŸç”Ÿ"],"content":"å‚è€ƒ é˜…è¯»åŸæ–‡ istio å¸¸è§é—®é¢˜: Sidecar å¯åŠ¨é¡ºåºé—®é¢˜ - imroc.cc ","date":"2022-09-10","objectID":"/posts/dc5625/:6:0","tags":["istio","è½¬è½½"],"title":"Istio æ•°æ®å¹³é¢Podå¯åŠ¨è¿‡ç¨‹è¯¦è§£","uri":"/posts/dc5625/"},{"categories":["äº‘åŸç”Ÿ"],"content":"iptables ä½œä¸º Linux å†…æ ¸ä¸­çš„é‡è¦åŠŸèƒ½ï¼Œæœ‰ç€å¹¿æ³›çš„åº”ç”¨ï¼Œåœ¨ Istio ä¸­é»˜è®¤å°±æ˜¯åˆ©ç”¨ iptables åšé€æ˜æµé‡åŠ«æŒçš„ã€‚ç†è§£ iptablesï¼Œå¯¹äºæˆ‘ä»¬ç†è§£ Istio çš„è¿ä½œæœ‰ååˆ†é‡è¦çš„ä½œç”¨ã€‚æœ¬æ–‡å°†ä¸ºå¤§å®¶ç®€å•ä»‹ç»ä¸‹ iptblesã€‚ ","date":"2022-09-10","objectID":"/posts/b7e1eb/:0:0","tags":["istio","iptable","è½¬è½½"],"title":"ç†è§£Iptable","uri":"/posts/b7e1eb/"},{"categories":["äº‘åŸç”Ÿ"],"content":"iptables ç®€ä»‹ iptables æ˜¯ Linux å†…æ ¸ä¸­çš„é˜²ç«å¢™è½¯ä»¶ netfilter çš„ç®¡ç†å·¥å…·ï¼Œä½äºç”¨æˆ·ç©ºé—´ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ netfilter çš„ä¸€éƒ¨åˆ†ã€‚Netfilter ä½äºå†…æ ¸ç©ºé—´ï¼Œä¸ä»…æœ‰ç½‘ç»œåœ°å€è½¬æ¢çš„åŠŸèƒ½ï¼Œä¹Ÿå…·å¤‡æ•°æ®åŒ…å†…å®¹ä¿®æ”¹ã€ä»¥åŠæ•°æ®åŒ…è¿‡æ»¤ç­‰é˜²ç«å¢™åŠŸèƒ½ã€‚ åœ¨äº†è§£ Init å®¹å™¨åˆå§‹åŒ–çš„ iptables ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸‹ iptables å’Œè§„åˆ™é…ç½®ã€‚ ä¸‹å›¾å±•ç¤ºäº† iptables è°ƒç”¨é“¾ã€‚ ","date":"2022-09-10","objectID":"/posts/b7e1eb/:1:0","tags":["istio","iptable","è½¬è½½"],"title":"ç†è§£Iptable","uri":"/posts/b7e1eb/"},{"categories":["äº‘åŸç”Ÿ"],"content":"iptables ä¸­çš„è¡¨ Init å®¹å™¨ä¸­ä½¿ç”¨çš„çš„ iptables ç‰ˆæœ¬æ˜¯ v1.6.0ï¼Œå…±åŒ…å« 5 å¼ è¡¨ï¼š raw ç”¨äºé…ç½®æ•°æ®åŒ…ï¼Œraw ä¸­çš„æ•°æ®åŒ…ä¸ä¼šè¢«ç³»ç»Ÿè·Ÿè¸ªã€‚ filter æ˜¯ç”¨äºå­˜æ”¾æ‰€æœ‰ä¸é˜²ç«å¢™ç›¸å…³æ“ä½œçš„é»˜è®¤è¡¨ã€‚ nat ç”¨äº ç½‘ç»œåœ°å€è½¬æ¢ï¼ˆä¾‹å¦‚ï¼šç«¯å£è½¬å‘ï¼‰ã€‚ mangle ç”¨äºå¯¹ç‰¹å®šæ•°æ®åŒ…çš„ä¿®æ”¹ï¼ˆå‚è€ƒæŸåæ•°æ®åŒ…ï¼‰ã€‚ security ç”¨äºå¼ºåˆ¶è®¿é—®æ§åˆ¶ ç½‘ç»œè§„åˆ™ã€‚ æ³¨ï¼šåœ¨æœ¬ç¤ºä¾‹ä¸­åªç”¨åˆ°äº† nat è¡¨ã€‚ ä¸åŒçš„è¡¨ä¸­çš„å…·æœ‰çš„é“¾ç±»å‹å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š è§„åˆ™åç§° raw filter nat mangle security PREROUTING âœ“ âœ“ âœ“ INPUT âœ“ âœ“ âœ“ OUTPUT âœ“ âœ“ âœ“ âœ“ âœ“ POSTROUTING âœ“ âœ“ FORWARD âœ“ âœ“ âœ“ ","date":"2022-09-10","objectID":"/posts/b7e1eb/:2:0","tags":["istio","iptable","è½¬è½½"],"title":"ç†è§£Iptable","uri":"/posts/b7e1eb/"},{"categories":["äº‘åŸç”Ÿ"],"content":"ç†è§£ iptables è§„åˆ™ æŸ¥çœ‹ istio-proxy å®¹å™¨ä¸­çš„é»˜è®¤çš„ iptables è§„åˆ™ï¼Œé»˜è®¤æŸ¥çœ‹çš„æ˜¯ filter è¡¨ä¸­çš„è§„åˆ™ã€‚ $ iptables -L -v Chain INPUT (policy ACCEPT 350K packets, 63M bytes) pkts bytes target prot opt in out source destination Chain FORWARD (policy ACCEPT 0 packets, 0 bytes) pkts bytes target prot opt in out source destination Chain OUTPUT (policy ACCEPT 18M packets, 1916M bytes) pkts bytes target prot opt in out source destination æˆ‘ä»¬çœ‹åˆ°ä¸‰ä¸ªé»˜è®¤çš„é“¾ï¼Œåˆ†åˆ«æ˜¯ INPUTã€FORWARD å’Œ OUTPUTï¼Œæ¯ä¸ªé“¾ä¸­çš„ç¬¬ä¸€è¡Œè¾“å‡ºè¡¨ç¤ºé“¾åç§°ï¼ˆåœ¨æœ¬ä¾‹ä¸­ä¸ºINPUT/FORWARD/OUTPUTï¼‰ï¼Œåè·Ÿé»˜è®¤ç­–ç•¥ï¼ˆACCEPTï¼‰ã€‚ æ¯æ¡é“¾ä¸­éƒ½å¯ä»¥æ·»åŠ å¤šæ¡è§„åˆ™ï¼Œè§„åˆ™æ˜¯æŒ‰ç…§é¡ºåºä»å‰åˆ°åæ‰§è¡Œçš„ã€‚æˆ‘ä»¬æ¥çœ‹ä¸‹è§„åˆ™çš„è¡¨å¤´å®šä¹‰ã€‚ pktsï¼šå¤„ç†è¿‡çš„åŒ¹é…çš„æŠ¥æ–‡æ•°é‡ bytesï¼šç´¯è®¡å¤„ç†çš„æŠ¥æ–‡å¤§å°ï¼ˆå­—èŠ‚æ•°ï¼‰ targetï¼šå¦‚æœæŠ¥æ–‡ä¸è§„åˆ™åŒ¹é…ï¼ŒæŒ‡å®šç›®æ ‡å°±ä¼šè¢«æ‰§è¡Œã€‚ protï¼šåè®®ï¼Œä¾‹å¦‚ tdpã€udpã€icmp å’Œ allã€‚ optï¼šå¾ˆå°‘ä½¿ç”¨ï¼Œè¿™ä¸€åˆ—ç”¨äºæ˜¾ç¤º IP é€‰é¡¹ã€‚ inï¼šå…¥ç«™ç½‘å¡ã€‚ outï¼šå‡ºç«™ç½‘å¡ã€‚ sourceï¼šæµé‡çš„æº IP åœ°å€æˆ–å­ç½‘ï¼Œæˆ–è€…æ˜¯ anywhereã€‚ destinationï¼šæµé‡çš„ç›®çš„åœ° IP åœ°å€æˆ–å­ç½‘ï¼Œæˆ–è€…æ˜¯ anywhereã€‚ è¿˜æœ‰ä¸€åˆ—æ²¡æœ‰è¡¨å¤´ï¼Œæ˜¾ç¤ºåœ¨æœ€åï¼Œè¡¨ç¤ºè§„åˆ™çš„é€‰é¡¹ï¼Œä½œä¸ºè§„åˆ™çš„æ‰©å±•åŒ¹é…æ¡ä»¶ï¼Œç”¨æ¥è¡¥å……å‰é¢çš„å‡ åˆ—ä¸­çš„é…ç½®ã€‚protã€optã€inã€outã€source å’Œ destination å’Œæ˜¾ç¤ºåœ¨ destination åé¢çš„æ²¡æœ‰è¡¨å¤´çš„ä¸€åˆ—æ‰©å±•æ¡ä»¶å…±åŒç»„æˆåŒ¹é…è§„åˆ™ã€‚å½“æµé‡åŒ¹é…è¿™äº›è§„åˆ™åå°±ä¼šæ‰§è¡Œ targetã€‚ target æ”¯æŒçš„ç±»å‹ target ç±»å‹åŒ…æ‹¬ ACCEPTã€REJECTã€DROPã€LOG ã€SNATã€MASQUERADEã€DNATã€REDIRECTã€RETURN æˆ–è€…è·³è½¬åˆ°å…¶ä»–è§„åˆ™ç­‰ã€‚åªè¦æ‰§è¡Œåˆ°æŸä¸€æ¡é“¾ä¸­åªæœ‰æŒ‰ç…§é¡ºåºæœ‰ä¸€æ¡è§„åˆ™åŒ¹é…åå°±å¯ä»¥ç¡®å®šæŠ¥æ–‡çš„å»å‘äº†ï¼Œé™¤äº† RETURN ç±»å‹ï¼Œç±»ä¼¼ç¼–ç¨‹è¯­è¨€ä¸­çš„ return è¯­å¥ï¼Œè¿”å›åˆ°å®ƒçš„è°ƒç”¨ç‚¹ï¼Œç»§ç»­æ‰§è¡Œä¸‹ä¸€æ¡è§„åˆ™ã€‚target æ”¯æŒçš„é…ç½®è¯¦è§£è¯·å‚è€ƒ iptables è¯¦è§£ï¼ˆ1ï¼‰ï¼šiptables æ¦‚å¿µã€‚ ","date":"2022-09-10","objectID":"/posts/b7e1eb/:3:0","tags":["istio","iptable","è½¬è½½"],"title":"ç†è§£Iptable","uri":"/posts/b7e1eb/"},{"categories":["äº‘åŸç”Ÿ"],"content":"æ€»ç»“ ä»¥ä¸Šå°±æ˜¯å¯¹ iptables çš„ç®€è¦ä»‹ç»ï¼Œä½ å·²ç»äº†è§£äº† iptables æ˜¯æ€æ ·è¿è¡Œçš„ï¼Œè§„åˆ™é“¾åŠå…¶æ‰§è¡Œé¡ºåºã€‚ ","date":"2022-09-10","objectID":"/posts/b7e1eb/:4:0","tags":["istio","iptable","è½¬è½½"],"title":"ç†è§£Iptable","uri":"/posts/b7e1eb/"},{"categories":["äº‘åŸç”Ÿ"],"content":"å‚è€ƒ é˜…è¯»åŸæ–‡ ","date":"2022-09-10","objectID":"/posts/b7e1eb/:5:0","tags":["istio","iptable","è½¬è½½"],"title":"ç†è§£Iptable","uri":"/posts/b7e1eb/"},{"categories":null,"content":"è·å–ä»“åº“ä¿¡æ¯ curl --request GET \\ --url \"https://api.github.com/repos/kbsonlong/kubernetes-guide\" \\ --header \"Accept: application/vnd.github.v3+json\" \\ --header \"Authorization: Bearer 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\" ","date":"2022-08-11","objectID":"/posts/5d7029/:0:1","tags":null,"title":"GitHub Apiæ¥å£","uri":"/posts/5d7029/"},{"categories":null,"content":"åˆ é™¤ä»“åº“ ","date":"2022-08-11","objectID":"/posts/5d7029/:0:2","tags":null,"title":"GitHub Apiæ¥å£","uri":"/posts/5d7029/"},{"categories":null,"content":"Ingress èµ„æºæ˜¯ Kubernetes ä¼—å¤šæˆåŠŸæ•…äº‹ä¹‹ä¸€ã€‚å®ƒåˆ›å»ºäº†ä¸€ä¸ªä¸åŒçš„ Ingress æ§åˆ¶å™¨ç”Ÿæ€ç³»ç»Ÿï¼Œè¿™äº›æ§åˆ¶å™¨ä»¥æ ‡å‡†åŒ–å’Œä¸€è‡´çš„æ–¹å¼åœ¨æˆåƒä¸Šä¸‡çš„é›†ç¾¤ä¸­ä½¿ç”¨ã€‚è¿™ç§æ ‡å‡†åŒ–å¸®åŠ©ç”¨æˆ·é‡‡ç”¨ Kubernetesã€‚ç„¶è€Œï¼Œåœ¨ Ingress åˆ›å»º 5 å¹´åï¼Œæœ‰è¿¹è±¡è¡¨æ˜ï¼Œåˆ†è£‚ä¸ºä¸åŒä½†æƒŠäººç›¸ä¼¼çš„ CRD å’Œè¶…è½½çš„æ³¨é‡Šã€‚ä½¿ Ingress æ™®åŠçš„å¯ç§»æ¤æ€§åŒæ ·ä¹Ÿé™åˆ¶äº†å®ƒçš„æœªæ¥ã€‚ åœ¨ 2019 å¹´åœ£åœ°äºšå“¥ Kubecon å¤§ä¼šä¸Šï¼Œä¸€ç¾¤çƒ­æƒ…çš„è´¡çŒ®è€…èšé›†åœ¨ä¸€èµ·è®¨è®º Ingress çš„æ¼”å˜ã€‚è®¨è®ºè”“å»¶åˆ°äº†è¡—å¯¹é¢çš„é…’åº—å¤§å…ï¼Œç»“æœå°±æ˜¯åæ¥è¢«ç§°ä¸º Gateway API çš„ä¸œè¥¿ã€‚è¿™ä¸€è®¨è®ºæ˜¯åŸºäºä»¥ä¸‹å‡ ä¸ªå…³é”®å‡è®¾ï¼š ä½œä¸ºè·¯ç”±åŒ¹é…ã€æµé‡ç®¡ç†å’ŒæœåŠ¡æš´éœ²åŸºç¡€çš„ API æ ‡å‡†å·²ç»å•†å“åŒ–ï¼Œä½œä¸ºè‡ªå®šä¹‰ API å¯¹å…¶å®ç°è€…å’Œç”¨æˆ·å‡ ä¹æ²¡æœ‰æä¾›ä»€ä¹ˆä»·å€¼ å¯ä»¥é€šè¿‡å…±åŒçš„æ ¸å¿ƒ API èµ„æºæ¥è¡¨ç¤º L4/L7 è·¯ç”±å’Œæµé‡ç®¡ç† ä»¥ä¸€ç§ä¸ç‰ºç‰²æ ¸å¿ƒ API çš„ç”¨æˆ·ä½“éªŒçš„æ–¹å¼ï¼Œä¸ºæ›´å¤æ‚çš„åŠŸèƒ½æä¾›å¯æ‰©å±•æ€§æ˜¯å¯èƒ½çš„ ","date":"2022-07-29","objectID":"/posts/%E9%80%9A%E8%BF%87gateway-api%E4%B8%8D%E6%96%AD%E6%BC%94%E5%8F%98%E7%9A%84kubernetes%E7%BD%91%E7%BB%9C/:0:0","tags":null,"title":"é€šè¿‡Gateway APIä¸æ–­æ¼”å˜çš„Kubernetesç½‘ç»œ","uri":"/posts/%E9%80%9A%E8%BF%87gateway-api%E4%B8%8D%E6%96%AD%E6%BC%94%E5%8F%98%E7%9A%84kubernetes%E7%BD%91%E7%BB%9C/"},{"categories":null,"content":"å¼•å…¥ Gateway API è¿™å°±å¼•å‡ºäº†å…è®¸ Gateway API åœ¨ Ingress åŸºç¡€ä¸Šæ”¹è¿›çš„è®¾è®¡åŸåˆ™ï¼š è¡¨è¾¾èƒ½åŠ›â€”â€”é™¤äº† HTTP ä¸»æœº/è·¯å¾„åŒ¹é…å’Œ TLS ä¹‹å¤–ï¼ŒGateway API è¿˜å¯ä»¥è¡¨è¾¾ HTTP å¤´æ“ä½œã€æµé‡åŠ æƒå’Œé•œåƒã€TCP/UDP è·¯ç”±ä»¥åŠå…¶ä»–åªèƒ½åœ¨ Ingress ä¸­é€šè¿‡è‡ªå®šä¹‰æ³¨é‡Šæ‰èƒ½å®ç°çš„åŠŸèƒ½ã€‚ é¢å‘è§’è‰²çš„è®¾è®¡â€”â€”API èµ„æºæ¨¡å‹åæ˜ äº†åœ¨è·¯ç”±å’Œ Kubernetes æœåŠ¡ç½‘ç»œä¸­å¸¸è§çš„èŒè´£åˆ†ç¦»ã€‚ å¯æ‰©å±•æ€§â€”â€”èµ„æºå…è®¸åœ¨ API çš„ä¸åŒå±‚ä¸Šé™„åŠ ä»»æ„çš„é…ç½®ã€‚è¿™ä½¿å¾—åœ¨æœ€åˆé€‚çš„åœ°æ–¹å¯ä»¥è¿›è¡Œç»†ç²’åº¦å®šåˆ¶ã€‚ çµæ´»çš„ä¸€è‡´æ€§â€”â€”Gateway API å®šä¹‰äº†ä¸åŒçš„ä¸€è‡´æ€§çº§åˆ«â€”â€”æ ¸å¿ƒï¼ˆå¼ºåˆ¶æ”¯æŒï¼‰ã€æ‰©å±•ï¼ˆå¦‚æœæ”¯æŒåˆ™å¯ç§»æ¤ï¼‰å’Œè‡ªå®šä¹‰ï¼ˆæ²¡æœ‰å¯ç§»æ¤æ€§ä¿è¯ï¼‰ï¼Œç»Ÿç§°ä¸ºçµæ´»çš„ä¸€è‡´æ€§[1]ã€‚è¿™ä¿ƒè¿›äº†ä¸€ä¸ªé«˜åº¦å¯ç§»æ¤çš„æ ¸å¿ƒ APIï¼ˆå¦‚ Ingressï¼‰ï¼Œå®ƒä»ç„¶ä¸ºç½‘å…³æ§åˆ¶å™¨å®ç°è€…æä¾›çµæ´»æ€§ã€‚ ","date":"2022-07-29","objectID":"/posts/%E9%80%9A%E8%BF%87gateway-api%E4%B8%8D%E6%96%AD%E6%BC%94%E5%8F%98%E7%9A%84kubernetes%E7%BD%91%E7%BB%9C/:1:0","tags":null,"title":"é€šè¿‡Gateway APIä¸æ–­æ¼”å˜çš„Kubernetesç½‘ç»œ","uri":"/posts/%E9%80%9A%E8%BF%87gateway-api%E4%B8%8D%E6%96%AD%E6%BC%94%E5%8F%98%E7%9A%84kubernetes%E7%BD%91%E7%BB%9C/"},{"categories":null,"content":"Gateway API æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Ÿ Gateway API å¼•å…¥äº†ä¸€äº›æ–°çš„èµ„æºç±»å‹ï¼š GatewayClasses æ˜¯é›†ç¾¤èŒƒå›´çš„èµ„æºï¼Œä½œä¸ºæ¨¡æ¿æ¥æ˜¾å¼å®šä¹‰ä»å®ƒä»¬æ´¾ç”Ÿçš„ Gateways çš„è¡Œä¸ºã€‚è¿™åœ¨æ¦‚å¿µä¸Šç±»ä¼¼äº StorageClassesï¼Œä½†ç”¨äºè”ç½‘æ•°æ®å¹³é¢ã€‚ Gateways æ˜¯ GatewayClasses çš„éƒ¨ç½²å®ä¾‹ã€‚å®ƒä»¬æ˜¯æ‰§è¡Œè·¯ç”±çš„æ•°æ®å¹³é¢çš„é€»è¾‘è¡¨ç¤ºï¼Œå¯ä»¥æ˜¯é›†ç¾¤å†…ä»£ç†ã€ç¡¬ä»¶ LB æˆ–äº‘ LBã€‚ è·¯ç”±ä¸æ˜¯å•ä¸€çš„èµ„æºï¼Œè€Œæ˜¯ä»£è¡¨è®¸å¤šä¸åŒåè®®ç‰¹å®šçš„ Route èµ„æºã€‚HTTPRoute å…·æœ‰åŒ¹é…ã€è¿‡æ»¤å’Œè·¯ç”±è§„åˆ™ï¼Œè¿™äº›è§„åˆ™åº”ç”¨äºèƒ½å¤Ÿå¤„ç† HTTP å’Œ HTTPS æµé‡çš„ Gatewaysã€‚ç±»ä¼¼åœ°ï¼ŒTCPRoutesã€UDPRoutes å’Œ TLSRoutes ä¹Ÿå…·æœ‰ç‰¹å®šäºåè®®çš„è¯­ä¹‰ã€‚æ­¤æ¨¡å‹è¿˜å…è®¸ Gateway API å°†æ¥å¢é‡åœ°æ‰©å±•å…¶åè®®æ”¯æŒã€‚ ","date":"2022-07-29","objectID":"/posts/%E9%80%9A%E8%BF%87gateway-api%E4%B8%8D%E6%96%AD%E6%BC%94%E5%8F%98%E7%9A%84kubernetes%E7%BD%91%E7%BB%9C/:1:1","tags":null,"title":"é€šè¿‡Gateway APIä¸æ–­æ¼”å˜çš„Kubernetesç½‘ç»œ","uri":"/posts/%E9%80%9A%E8%BF%87gateway-api%E4%B8%8D%E6%96%AD%E6%BC%94%E5%8F%98%E7%9A%84kubernetes%E7%BD%91%E7%BB%9C/"},{"categories":null,"content":"ç½‘å…³æ§åˆ¶å™¨å®ç° å¥½æ¶ˆæ¯æ˜¯ï¼Œå°½ç®¡ Gateway æ˜¯åœ¨Alpha[2]é˜¶æ®µï¼Œä½†å·²ç»æœ‰å‡ ä¸ªä½ å¯ä»¥è¿è¡Œçš„Gateway æ§åˆ¶å™¨å®ç°[3]ã€‚ç”±äºå®ƒæ˜¯ä¸€ä¸ªæ ‡å‡†åŒ–çš„è§„èŒƒï¼Œä¸‹é¢çš„ç¤ºä¾‹å¯ä»¥åœ¨å®ƒä»¬ä¸­çš„ä»»ä½•ä¸€ä¸ªä¸Šè¿è¡Œï¼Œå¹¶ä¸”åº”è¯¥ä»¥å®Œå…¨ç›¸åŒçš„æ–¹å¼å·¥ä½œã€‚æŸ¥çœ‹å…¥é—¨æ‰‹å†Œ[4]ï¼Œäº†è§£å¦‚ä½•å®‰è£…å’Œä½¿ç”¨è¿™äº›ç½‘å…³æ§åˆ¶å™¨ä¹‹ä¸€ã€‚ ","date":"2022-07-29","objectID":"/posts/%E9%80%9A%E8%BF%87gateway-api%E4%B8%8D%E6%96%AD%E6%BC%94%E5%8F%98%E7%9A%84kubernetes%E7%BD%91%E7%BB%9C/:1:2","tags":null,"title":"é€šè¿‡Gateway APIä¸æ–­æ¼”å˜çš„Kubernetesç½‘ç»œ","uri":"/posts/%E9%80%9A%E8%BF%87gateway-api%E4%B8%8D%E6%96%AD%E6%BC%94%E5%8F%98%E7%9A%84kubernetes%E7%BD%91%E7%BB%9C/"},{"categories":null,"content":"Gateway API ä¾‹å­ åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°†æ¼”ç¤ºä¸åŒ API èµ„æºä¹‹é—´çš„å…³ç³»ï¼Œå¹¶å¸¦ä½ æµè§ˆä¸€ä¸ªå¸¸è§çš„ç”¨ä¾‹ï¼š å›¢é˜Ÿ foo å°†ä»–ä»¬çš„åº”ç”¨éƒ¨ç½²åœ¨ foo å‘½åç©ºé—´ä¸­ã€‚ä»–ä»¬éœ€è¦æ§åˆ¶åº”ç”¨ç¨‹åºä¸åŒé¡µé¢çš„è·¯ç”±é€»è¾‘ã€‚ å›¢é˜Ÿ bar è¿è¡Œåœ¨ bar å‘½åç©ºé—´ä¸­ã€‚ä»–ä»¬å¸Œæœ›èƒ½å¤Ÿå¯¹ä»–ä»¬çš„åº”ç”¨è¿›è¡Œè“ç»¿å‘å¸ƒä»¥é™ä½é£é™©ã€‚ å¹³å°å›¢é˜Ÿè´Ÿè´£ç®¡ç† Kubernetes é›†ç¾¤ä¸­æ‰€æœ‰åº”ç”¨çš„è´Ÿè½½å‡è¡¡å™¨å’Œç½‘ç»œå®‰å…¨ã€‚ ä¸‹é¢çš„ foo-route å¯¹ foo å‘½åç©ºé—´ä¸­çš„å„ç§æœåŠ¡è¿›è¡Œè·¯å¾„åŒ¹é…ï¼Œå¹¶ä¸”è¿˜æœ‰ä¸€ä¸ªåˆ° 404 æœåŠ¡å™¨çš„é»˜è®¤è·¯ç”±ã€‚è¿™å°†åˆ†åˆ«é€šè¿‡ foo.example.com/login å’Œ foo.example.com/home æš´éœ² foo-auth å’Œ foo-home æœåŠ¡ï¼š kind:Â HTTPRoute apiVersion:Â networking.x-k8s.io/v1alpha1 metadata: name:Â foo-route namespace:Â foo labels: gateway:Â external-https-prod spec: hostnames: -Â \"foo.example.com\" rules: -Â matches: -Â path: type:Â Prefix value:Â /login forwardTo: -Â serviceName:Â foo-auth port:Â 8080 -Â matches: -Â path: type:Â Prefix value:Â /home forwardTo: -Â serviceName:Â foo-home port:Â 8080 -Â matches: -Â path: type:Â Prefix value:Â / forwardTo: -Â serviceName:Â foo-404 port:Â 8080 bar å›¢é˜Ÿåœ¨åŒä¸€ä¸ª Kubernetes é›†ç¾¤çš„ bar å‘½åç©ºé—´ä¸­æ“ä½œï¼Œä¹Ÿå¸Œæœ›å°†ä»–ä»¬çš„åº”ç”¨ç¨‹åºæš´éœ²ç»™äº’è”ç½‘ï¼Œä½†ä»–ä»¬ä¹Ÿå¸Œæœ›æ§åˆ¶è‡ªå·±çš„ç°åº¦å’Œè“ç»¿å‘å¸ƒã€‚ä¸‹é¢çš„ HTTPRoute è¢«é…ç½®ä¸ºä»¥ä¸‹è¡Œä¸ºï¼š bar.example.com çš„æµé‡ï¼š å°† 90%çš„æµé‡å‘é€åˆ° bar-v1 å°† 10%çš„æµé‡å‘é€ç»™ bar-v2 å¯¹äºä½¿ç”¨ HTTP å¤´ env:canary åˆ° bar.example.com çš„æµé‡ï¼š å°†æ‰€æœ‰æµé‡å‘é€åˆ° bar-v2 kind:Â HTTPRoute apiVersion:Â networking.x-k8s.io/v1alpha1 metadata: name:Â bar-route namespace:Â bar labels: gateway:Â external-https-prod spec: hostnames: -Â \"bar.example.com\" rules: -Â forwardTo: -Â serviceName:Â bar-v1 port:Â 8080 weight:Â 90 -Â serviceName:Â bar-v2 port:Â 8080 weight:Â 10 -Â matches: -Â headers: values: env:Â canary forwardTo: -Â serviceName:Â bar-v2 port:Â 8080 ","date":"2022-07-29","objectID":"/posts/%E9%80%9A%E8%BF%87gateway-api%E4%B8%8D%E6%96%AD%E6%BC%94%E5%8F%98%E7%9A%84kubernetes%E7%BD%91%E7%BB%9C/:2:0","tags":null,"title":"é€šè¿‡Gateway APIä¸æ–­æ¼”å˜çš„Kubernetesç½‘ç»œ","uri":"/posts/%E9%80%9A%E8%BF%87gateway-api%E4%B8%8D%E6%96%AD%E6%BC%94%E5%8F%98%E7%9A%84kubernetes%E7%BD%91%E7%BB%9C/"},{"categories":null,"content":"è·¯ç”±å’Œç½‘å…³ç»‘å®š å› æ­¤ï¼Œæˆ‘ä»¬æœ‰ä¸¤ä¸ªåŒ¹é…çš„ HTTPRoutesï¼Œå¹¶å°†æµé‡è·¯ç”±åˆ°ä¸åŒçš„æœåŠ¡ã€‚ä½ å¯èƒ½æƒ³çŸ¥é“ï¼Œåœ¨å“ªé‡Œå¯ä»¥è®¿é—®è¿™äº›æœåŠ¡ï¼Ÿå®ƒä»¬é€šè¿‡å“ªäº›ç½‘ç»œæˆ– IP æš´éœ²ï¼Ÿ è·¯ç”±å¦‚ä½•å‘å®¢æˆ·ç«¯æš´éœ²ç”±è·¯ç”±ç»‘å®š[5]æ¥ç®¡ç†ï¼Œè¯¥ç»‘å®šæè¿°äº†è·¯ç”±å’Œç½‘å…³ä¹‹é—´å¦‚ä½•åˆ›å»ºåŒå‘å…³ç³»ã€‚å½“ Routes è¢«ç»‘å®šåˆ°ä¸€ä¸ª Gateway æ—¶ï¼Œè¿™æ„å‘³ç€å®ƒä»¬çš„é›†åˆè·¯ç”±è§„åˆ™è¢«é…ç½®åœ¨åº•å±‚çš„è´Ÿè½½å‡è¡¡å™¨æˆ–ä»£ç†ä¸Šï¼Œå¹¶ä¸”è·¯ç”±å¯ä»¥é€šè¿‡ç½‘å…³è®¿é—®ã€‚å› æ­¤ï¼Œç½‘å…³æ˜¯å¯ä»¥é€šè¿‡è·¯ç”±é…ç½®çš„ç½‘ç»œæ•°æ®å¹³é¢çš„é€»è¾‘è¡¨ç¤ºã€‚ ","date":"2022-07-29","objectID":"/posts/%E9%80%9A%E8%BF%87gateway-api%E4%B8%8D%E6%96%AD%E6%BC%94%E5%8F%98%E7%9A%84kubernetes%E7%BD%91%E7%BB%9C/:2:1","tags":null,"title":"é€šè¿‡Gateway APIä¸æ–­æ¼”å˜çš„Kubernetesç½‘ç»œ","uri":"/posts/%E9%80%9A%E8%BF%87gateway-api%E4%B8%8D%E6%96%AD%E6%BC%94%E5%8F%98%E7%9A%84kubernetes%E7%BD%91%E7%BB%9C/"},{"categories":null,"content":"è¡Œæ”¿å§”æ‰˜ Gateway å’Œ Route èµ„æºä¹‹é—´çš„åˆ†ç¦»å…è®¸é›†ç¾¤ç®¡ç†å‘˜å°†ä¸€äº›è·¯ç”±é…ç½®å§”æ´¾ç»™å„ä¸ªå›¢é˜Ÿï¼ŒåŒæ—¶ä»ç„¶ä¿æŒé›†ä¸­æ§åˆ¶ã€‚ä»¥ä¸‹ç½‘å…³èµ„æºåœ¨ç«¯å£ 443 ä¸Šæš´éœ² HTTPSï¼Œå¹¶ä½¿ç”¨ç”±é›†ç¾¤ç®¡ç†å‘˜æ§åˆ¶çš„è¯ä¹¦ç»ˆæ­¢ç«¯å£ä¸Šçš„æ‰€æœ‰é€šä¿¡æµã€‚ kind:Â Gateway apiVersion:Â networking.x-k8s.io/v1alpha1 metadata: name:Â prod-web spec: gatewayClassName:Â acme-lb listeners: -Â protocol:Â HTTPS port:Â 443 routes: kind:Â HTTPRoute selector: matchLabels: gateway:Â external-https-prod namespaces: from:Â All tls: certificateRef: name:Â admin-controlled-cert ä¸‹é¢çš„ HTTPRoute å±•ç¤ºäº† Route å¦‚ä½•é€šè¿‡å®ƒçš„ kindï¼ˆHTTPRouteï¼‰å’Œèµ„æºæ ‡ç­¾ï¼ˆgateway=external-https-prodï¼‰æ¥ç¡®ä¿å®ƒåŒ¹é…ç½‘å…³çš„é€‰æ‹©å™¨ã€‚ #Â MatchesÂ theÂ requiredÂ kindÂ selectorÂ onÂ theÂ Gateway kind:Â HTTPRoute apiVersion:Â networking.x-k8s.io/v1alpha1 metadata: name:Â foo-route namespace:Â foo-ns labels: #Â MatchesÂ theÂ requiredÂ labelÂ selectorÂ onÂ theÂ Gateway gateway:Â external-https-prod ... ","date":"2022-07-29","objectID":"/posts/%E9%80%9A%E8%BF%87gateway-api%E4%B8%8D%E6%96%AD%E6%BC%94%E5%8F%98%E7%9A%84kubernetes%E7%BD%91%E7%BB%9C/:2:2","tags":null,"title":"é€šè¿‡Gateway APIä¸æ–­æ¼”å˜çš„Kubernetesç½‘ç»œ","uri":"/posts/%E9%80%9A%E8%BF%87gateway-api%E4%B8%8D%E6%96%AD%E6%BC%94%E5%8F%98%E7%9A%84kubernetes%E7%BD%91%E7%BB%9C/"},{"categories":null,"content":"é¢å‘è§’è‰²çš„è®¾è®¡ å½“ä½ å°†å®ƒä»¬æ”¾åœ¨ä¸€èµ·æ—¶ï¼Œä½ å°±æ‹¥æœ‰äº†ä¸€ä¸ªå¯ä»¥è¢«å¤šä¸ªå›¢é˜Ÿå®‰å…¨åœ°å…±äº«çš„è´Ÿè½½å¹³è¡¡åŸºç¡€è®¾æ–½ã€‚Gateway API ä¸ä»…æ˜¯ç”¨äºé«˜çº§è·¯ç”±çš„æ›´å…·è¡¨ç°åŠ›çš„ APIï¼Œè€Œä¸”æ˜¯é¢å‘è§’è‰²çš„ APIï¼Œä¸“ä¸ºå¤šç§Ÿæˆ·åŸºç¡€è®¾æ–½è®¾è®¡ã€‚å®ƒçš„å¯æ‰©å±•æ€§ç¡®ä¿äº†å®ƒå°†åœ¨ä¿æŒå¯ç§»æ¤æ€§çš„åŒæ—¶ä¸ºæœªæ¥çš„ç”¨ä¾‹å‘å±•ã€‚æœ€ç»ˆï¼Œè¿™äº›ç‰¹æ€§å°†å…è®¸ Gateway API é€‚åº”ä¸åŒçš„ç»„ç»‡æ¨¡å‹å’Œå®ç°ï¼Œç›´åˆ°æœªæ¥ã€‚ ","date":"2022-07-29","objectID":"/posts/%E9%80%9A%E8%BF%87gateway-api%E4%B8%8D%E6%96%AD%E6%BC%94%E5%8F%98%E7%9A%84kubernetes%E7%BD%91%E7%BB%9C/:2:3","tags":null,"title":"é€šè¿‡Gateway APIä¸æ–­æ¼”å˜çš„Kubernetesç½‘ç»œ","uri":"/posts/%E9%80%9A%E8%BF%87gateway-api%E4%B8%8D%E6%96%AD%E6%BC%94%E5%8F%98%E7%9A%84kubernetes%E7%BD%91%E7%BB%9C/"},{"categories":null,"content":"å°è¯•ä¸€ä¸‹ï¼Œå¹¶å‚ä¸å…¶ä¸­ æœ‰è®¸å¤šèµ„æºå¯ä»¥æŸ¥çœ‹ä»¥äº†è§£æ›´å¤šã€‚ æŸ¥çœ‹å…¥é—¨æ‰‹å†Œï¼Œçœ‹çœ‹å¯ä»¥è§£å†³å“ªäº›ç”¨ä¾‹ã€‚ å°è¯•ä½¿ç”¨ç°æœ‰çš„ç½‘å…³æ§åˆ¶å™¨ä¹‹ä¸€ æˆ–è€…å‚ä¸[6]å¹¶å¸®åŠ©è®¾è®¡å’Œå½±å“ Kubernetes æœåŠ¡ç½‘ç»œçš„æœªæ¥ï¼ ","date":"2022-07-29","objectID":"/posts/%E9%80%9A%E8%BF%87gateway-api%E4%B8%8D%E6%96%AD%E6%BC%94%E5%8F%98%E7%9A%84kubernetes%E7%BD%91%E7%BB%9C/:2:4","tags":null,"title":"é€šè¿‡Gateway APIä¸æ–­æ¼”å˜çš„Kubernetesç½‘ç»œ","uri":"/posts/%E9%80%9A%E8%BF%87gateway-api%E4%B8%8D%E6%96%AD%E6%BC%94%E5%8F%98%E7%9A%84kubernetes%E7%BD%91%E7%BB%9C/"},{"categories":null,"content":"å‚è€ƒèµ„æ–™ [1] çµæ´»çš„ä¸€è‡´æ€§: https://gateway-api.sigs.k8s.io/concepts/guidelines/#conformance [2] Alpha: https://github.com/kubernetes-sigs/gateway-api/releases [3] Gateway æ§åˆ¶å™¨å®ç°: https://gateway-api.sigs.k8s.io/references/implementations/ [4] å…¥é—¨æ‰‹å†Œ: https://gateway-api.sigs.k8s.io/guides/getting-started/ [5] è·¯ç”±ç»‘å®š: https://gateway-api.sigs.k8s.io/concepts/api-overview/#route-binding [6] å‚ä¸: https://gateway-api.sigs.k8s.io/contributing/community/ ","date":"2022-07-29","objectID":"/posts/%E9%80%9A%E8%BF%87gateway-api%E4%B8%8D%E6%96%AD%E6%BC%94%E5%8F%98%E7%9A%84kubernetes%E7%BD%91%E7%BB%9C/:2:5","tags":null,"title":"é€šè¿‡Gateway APIä¸æ–­æ¼”å˜çš„Kubernetesç½‘ç»œ","uri":"/posts/%E9%80%9A%E8%BF%87gateway-api%E4%B8%8D%E6%96%AD%E6%BC%94%E5%8F%98%E7%9A%84kubernetes%E7%BD%91%E7%BB%9C/"},{"categories":["äº‘åŸç”Ÿ"],"content":"å®‰è£…kubebuilder brew install kubebuilder kubebuilder version ","date":"2022-07-21","objectID":"/posts/da6323/:0:1","tags":["kubebuilder","operator"],"title":"kubebuilderå¼€å‘operator","uri":"/posts/da6323/"},{"categories":["äº‘åŸç”Ÿ"],"content":"åˆ›å»ºé¡¹ç›®ç›®å½• mkdir custom-controllers cd custom-controllers go mod init controllers.alongparty.cn ","date":"2022-07-21","objectID":"/posts/da6323/:0:2","tags":["kubebuilder","operator"],"title":"kubebuilderå¼€å‘operator","uri":"/posts/da6323/"},{"categories":["äº‘åŸç”Ÿ"],"content":"kubebuilderåˆå§‹åŒ–é¡¹ç›® kubebuilder init --domain controller.alongparty.cn --license apache2 --owner \"kbsonlong\" kubebuilder create api --group controller --version v1 --kind Application make ","date":"2022-07-21","objectID":"/posts/da6323/:0:3","tags":["kubebuilder","operator"],"title":"kubebuilderå¼€å‘operator","uri":"/posts/da6323/"},{"categories":["äº‘åŸç”Ÿ"],"content":"å‚è€ƒèµ„æ–™ ä½¿ç”¨kubebuilderå¼€å‘operatorè¯¦è§£ KubeBuilder ç®€æ˜æ•™ç¨‹ ","date":"2022-07-21","objectID":"/posts/da6323/:0:4","tags":["kubebuilder","operator"],"title":"kubebuilderå¼€å‘operator","uri":"/posts/da6323/"},{"categories":null,"content":"å®‰è£…ocserv apt-get install ocserv -y ","date":"2022-07-21","objectID":"/posts/90ef46/:0:1","tags":null,"title":"ocservéƒ¨ç½²","uri":"/posts/90ef46/"},{"categories":null,"content":"ç”³è¯·å…è´¹è¯ä¹¦ ä¿®æ”¹dnsæŒ‡å‘æœåŠ¡å™¨ ç”Ÿæˆè¯ä¹¦ certbot certonly --standalone --preferred-challenges http --agree-tos --email kbsonlong@gmail.com -d myvpn.alongparty.cn # ç»­ç­¾è¯ä¹¦ certbot renew --quiet --no-self-upgrade ","date":"2022-07-21","objectID":"/posts/90ef46/:0:2","tags":null,"title":"ocservéƒ¨ç½²","uri":"/posts/90ef46/"},{"categories":null,"content":"ä¿®æ”¹é…ç½® auth = \"plain[/etc/ocserv/ocpasswd]\" tcp-port = 443 udp-port = 443 run-as-user = nobody run-as-group = daemon socket-file = /var/run/ocserv-socket server-cert = /etc/letsencrypt/live/myvpn.alongparty.cn/fullchain.pem server-key = /etc/letsencrypt/live/myvpn.alongparty.cn/privkey.pem isolate-workers = false max-clients = 16 max-same-clients = 2 rate-limit-ms = 100 server-stats-reset-time = 604800 keepalive = 32400 dpd = 90 mobile-dpd = 1800 switch-to-tcp-timeout = 25 try-mtu-discovery = true cert-user-oid = 0.9.2342.19200300.100.1.1 tls-priorities = \"NORMAL:%SERVER_PRECEDENCE:%COMPAT:-VERS-SSL3.0:-VERS-TLS1.0:-VERS-TLS1.1\" auth-timeout = 240 min-reauth-time = 300 max-ban-score = 80 ban-reset-time = 1200 cookie-timeout = 300 deny-roaming = false rekey-time = 172800 rekey-method = ssl use-occtl = true pid-file = /var/run/ocserv.pid device = vpns predictable-ips = true default-domain = example.com ipv4-network = 10.255.255.0 ipv4-netmask = 255.255.255.0 tunnel-all-dns = true dns = 8.8.8.8 dns = 4.2.2.4 dns = 2001:4860:4860::8888 dns = 2001:4860:4860::8844 ping-leases = false cisco-client-compat = true dtls-legacy = true ","date":"2022-07-21","objectID":"/posts/90ef46/:0:3","tags":null,"title":"ocservéƒ¨ç½²","uri":"/posts/90ef46/"},{"categories":["äº‘åŸç”Ÿ"],"content":"1é™æµ ","date":"2022-05-23","objectID":"/posts/istio%E9%98%B2%E6%95%85%E9%9A%9C%E5%88%A9%E5%99%A8/:0:0","tags":["istio","è½¬è½½"],"title":"Istioé˜²æ•…éšœåˆ©å™¨","uri":"/posts/istio%E9%98%B2%E6%95%85%E9%9A%9C%E5%88%A9%E5%99%A8/"},{"categories":["äº‘åŸç”Ÿ"],"content":"1.1ä»€ä¹ˆæ˜¯é™æµ â€‹ ä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚æˆ‘ä»¬æœ‰ä¸ªæ¡¶ï¼Œæ¡¶é‡Œæœ‰ä¸¤ä¸ªå¼€å…³ï¼Œä¸€ä¸ªå¾€å¤–å‡ºæ°´ï¼Œä¸€ä¸ªç½‘å†…æ³¨æ°´ï¼Œå½“å‡ºæ°´çš„é€Ÿåº¦æ…¢äºæ³¨æ°´çš„é€Ÿåº¦æ—¶ï¼Œåˆ°ä¸€å®šæ—¶é—´æ°´å°±ä¼šä»æ¡¶é‡Œæº¢å‡ºã€‚å¦‚æœæˆ‘ä»¬é™åˆ¶æ³¨æ°´é€Ÿç‡ï¼Œå°±å¯ä»¥é˜²æ­¢æ°´ä»æ¡¶é‡Œæº¢å‡ºï¼Œè¿™å°±æ˜¯é™æµã€‚ â€‹ å…·ä½“åˆ°è½¯ä»¶å±‚é¢ï¼Œæˆ‘ä»¬æŠŠè¯·æ±‚é€Ÿç‡çœ‹åšæ˜¯æ³¨æ°´ï¼ŒæŠŠç³»ç»Ÿcpuï¼Œå†…å­˜ç­‰èµ„æºçœ‹åšæ˜¯æ”¾æ°´ï¼Œå½“è¯·æ±‚é€Ÿç‡è¿‡å¿«ï¼Œæ¶ˆè€—å¤ªå¤šèµ„æºæ—¶ç³»ç»Ÿå°±å¯èƒ½å´©æºƒã€‚è½¯ä»¶é™æµå°±æ˜¯é™åˆ¶tpsæˆ–qpsæŒ‡æ ‡ï¼Œä»¥è¾¾åˆ°ä¿æŠ¤ç³»ç»Ÿçš„ç›®çš„ï¼Œè™½ç„¶å¯èƒ½éƒ¨åˆ†ç”¨æˆ·æ— æ³•æœåŠ¡ï¼Œä½†æ˜¯ç³»ç»Ÿæ•´ä½“è¿˜æ˜¯å¥åº·çš„ï¼Œè¿˜å¯ä»¥å¯¹å¤–éƒ¨æä¾›æœåŠ¡ï¼Œä¸æ˜¯æ•´ä½“æŒ‚æ‰ã€‚ ","date":"2022-05-23","objectID":"/posts/istio%E9%98%B2%E6%95%85%E9%9A%9C%E5%88%A9%E5%99%A8/:1:0","tags":["istio","è½¬è½½"],"title":"Istioé˜²æ•…éšœåˆ©å™¨","uri":"/posts/istio%E9%98%B2%E6%95%85%E9%9A%9C%E5%88%A9%E5%99%A8/"},{"categories":["äº‘åŸç”Ÿ"],"content":"1.2é™æµç®—æ³• 1.2.1æ¼æ¡¶ç®—æ³• å°±åƒä¸€ä¸ªæ¼æ–—ä»¥ä¸‹ï¼Œä¸‹é¢å°ï¼Œä¸Šé¢å¤§ã€‚æ¼æ¡¶æµå‡ºçš„é€Ÿç‡è¢«é™åˆ¶åœ¨æ¯”è¾ƒå°çš„èŒƒå›´ï¼Œå½“æ¼æ¡¶æ»¡æ—¶ï¼Œæ¼æ¡¶å°±ä¼šæº¢å‡ºï¼Œè¿›æ¥çš„è¯·æ±‚å°±ä¼šè¢«æŠ›å¼ƒæ‰ã€‚ç‰¹åˆ«æ˜¯åº”å¯¹çªå‘æµé‡ï¼Œæ¼æ¡¶çš„é€Ÿç‡æ˜¯æ’å®šçš„ï¼Œè¿™æ ·å¯ä»¥æœ‰æ•ˆé˜²æ­¢åº”çªå‘æµé‡å¯¼è‡´ç³»ç»Ÿå´©æºƒã€‚ ","date":"2022-05-23","objectID":"/posts/istio%E9%98%B2%E6%95%85%E9%9A%9C%E5%88%A9%E5%99%A8/:2:0","tags":["istio","è½¬è½½"],"title":"Istioé˜²æ•…éšœåˆ©å™¨","uri":"/posts/istio%E9%98%B2%E6%95%85%E9%9A%9C%E5%88%A9%E5%99%A8/"},{"categories":["äº‘åŸç”Ÿ"],"content":"1.2.2ä»¤ç‰Œæ¡¶ç®—æ³• ä»¤ç‰Œæ¡¶ç®—æ³•çš„åŸç†ï¼Œå…³é”®åœ¨ä»¤ç‰Œï¼Œå®ƒæ˜¯æŒ‡å¾€æ¡¶é‡Œä»¥ä¸€ä¸ªä¸å˜çš„é€Ÿç‡æ”¾å…¥ä»¤ç‰Œï¼Œå½“æœ‰è¯·æ±‚æ—¶ï¼Œå¦‚æœæ¡¶é‡Œæœ‰ä»¤ç‰Œï¼Œè¯·æ±‚å°±æ¶ˆè´¹ä¸€ä¸ªä»¤ç‰Œï¼Œè¯·æ±‚ç»§ç»­è¿›è¡Œï¼›å½“è¯·æ±‚åˆ°æ¥ï¼Œæ¡¶é‡Œæ²¡æœ‰ä»¤ç‰Œæ—¶ï¼Œè¯·æ±‚å°±ä¼šè¢«æŠ›å¼ƒæ‰ï¼Œæ‹’ç»æœåŠ¡ï¼›å½“æ¡¶é‡Œçš„ä»¤ç‰Œæ»¡æ—¶ï¼Œä»¤ç‰Œå°±ä¼šè¢«æŠ›å¼ƒæ‰ã€‚ ","date":"2022-05-23","objectID":"/posts/istio%E9%98%B2%E6%95%85%E9%9A%9C%E5%88%A9%E5%99%A8/:2:1","tags":["istio","è½¬è½½"],"title":"Istioé˜²æ•…éšœåˆ©å™¨","uri":"/posts/istio%E9%98%B2%E6%95%85%E9%9A%9C%E5%88%A9%E5%99%A8/"},{"categories":["äº‘åŸç”Ÿ"],"content":"1.2.3è®¡æ•°å™¨ç®—æ³• è®¡æ•°å™¨ç®—æ³•æ˜¯æŒ‡ä¸€æ®µæ—¶é—´è®¾ç½®ä¸€ä¸ªè®¡æ•°å™¨ï¼Œå½“æœ‰è¯·æ±‚æ—¶è®¡æ•°å™¨å°±åŠ ä¸€ï¼Œè¯·æ±‚ç»§ç»­è¿›è¡Œï¼›åœ¨æŠ€æœ¯å™¨æ—¶é—´èŒƒå›´å†…ï¼Œå½“è®¡æ•°å™¨æ•°å€¼è¶…è¿‡æŒ‡å®šå€¼ï¼Œè¯·æ±‚å°±è¢«æ‹’ç»ï¼›å½“æ—¶é—´èŒƒå›´ç»“æŸï¼Œå°±é‡ç½®è®¡æ•°å™¨ã€‚æŠ€æœ¯å™¨ç®—æ³•æœ‰ä¸ªç¼ºé™·ï¼Œå°±æ˜¯å¦‚æœè®¡æ•°å™¨æ—¶é—´æ˜¯1åˆ†é’Ÿï¼Œå½“å‰1ç§’æ¥äº†å¤§é‡è¯·æ±‚ï¼Œè®²æŠ€æœ¯å™¨ç”¨å®Œäº†ï¼Œåç»­59ç§’æ—¶é—´å°±æ²¡æ³•æä¾›æœåŠ¡ã€‚ ","date":"2022-05-23","objectID":"/posts/istio%E9%98%B2%E6%95%85%E9%9A%9C%E5%88%A9%E5%99%A8/:2:2","tags":["istio","è½¬è½½"],"title":"Istioé˜²æ•…éšœåˆ©å™¨","uri":"/posts/istio%E9%98%B2%E6%95%85%E9%9A%9C%E5%88%A9%E5%99%A8/"},{"categories":["äº‘åŸç”Ÿ"],"content":"1.2å®æ“ ","date":"2022-05-23","objectID":"/posts/istio%E9%98%B2%E6%95%85%E9%9A%9C%E5%88%A9%E5%99%A8/:3:0","tags":["istio","è½¬è½½"],"title":"Istioé˜²æ•…éšœåˆ©å™¨","uri":"/posts/istio%E9%98%B2%E6%95%85%E9%9A%9C%E5%88%A9%E5%99%A8/"},{"categories":["äº‘åŸç”Ÿ"],"content":"1.2.1 http 1.2.1.1å•é›†ç¾¤ istioéƒ¨ç½²å’Œbookinfoå®ä¾‹éƒ¨ç½²å¤§å®¶è‡ªè¡Œå®Œæˆï¼Œéƒ½çœ‹è¿™ç§æ·±åº¦çš„æ–‡ç« äº†è¿™ä¸ªåº”è¯¥ä¸æ˜¯äº‹ã€‚ 1.2.1.1.1é›†ç¾¤å†…æœåŠ¡é™æµ 1.2.1.1.1.1æœ¬åœ°é™æµ cat \u003c\u003cEOF \u003e envoyfilter-local-rate-limit.yaml apiVersion: networking.istio.io/v1alpha3 kind: EnvoyFilter metadata: name: filter-local-ratelimit-svc spec: workloadSelector: labels: app: productpage configPatches: - applyTo: HTTP_FILTER match: listener: filterChain: filter: name: \"envoy.filters.network.http_connection_manager\" patch: operation: INSERT_BEFORE value: name: envoy.filters.http.local_ratelimit typed_config: \"@type\": type.googleapis.com/udpa.type.v1.TypedStruct type_url: type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit value: stat_prefix: http_local_rate_limiter token_bucket: max_tokens: 10 tokens_per_fill: 10 fill_interval: 60s filter_enabled: runtime_key: local_rate_limit_enabled default_value: numerator: 100 denominator: HUNDRED filter_enforced: runtime_key: local_rate_limit_enforced default_value: numerator: 100 denominator: HUNDRED response_headers_to_add: - append: false header: key: x-local-rate-limit value: 'true' EOF kubectl apply -f envoyfilter-local-rate-limit.yaml -n istio è¯´æ˜ï¼šæœ¬åœ°é™æµéœ€è¦é€šè¿‡EnvoyFilteræ¥å®ç°ï¼Œä»–ä¸ä¼šè¯·æ±‚å¤–éƒ¨æœåŠ¡ï¼Œåœ¨envoyå†…éƒ¨å®ç°æ”¯æŒï¼Œæ˜¯ä¸€ä¸ªä»¤ç‰Œæ¡¶çš„ç®—æ³•ã€‚http filterçš„åç§°å¿…é¡»æ˜¯envoy.filters.http.local_ratelimitï¼Œtypeå’Œtypeurlæ˜¯å›ºå®šçš„ï¼Œstat_prefixå¯ä»¥éšä¾¿æ”¹ï¼Œè¡¨ç¤ºç”Ÿæˆstatçš„æŒ‡æ ‡å‰ç¼€ã€‚token_bucketé…ç½®ä»¤ç‰Œæ¡¶ï¼Œmax_tokensè¡¨ç¤ºæœ€å¤§ä»¤ç‰Œæ•°é‡ï¼Œtokens_per_fillè¡¨ç¤ºæ¯æ¬¡å¡«å……çš„ä»¤ç‰Œæ•°é‡ï¼Œfill_intervalè¡¨ç¤ºå¡«å……ä»¤ç‰Œçš„é—´éš”ã€‚filter_enabledè¡¨ç¤ºå¯ç”¨ä½†ä¸æ˜¯å¼ºåˆ¶ï¼Œfilter_enforcedè¡¨ç¤ºå¼ºåˆ¶ï¼Œå¯ä»¥é…ç½®ç™¾åˆ†æ¯”ã€‚response_headers_to_addä¿®æ”¹å“åº”å¤´ä¿¡æ¯ï¼Œappendä¸ºfalseè¡¨ç¤ºä¿®æ”¹ï¼Œtrueè¡¨ç¤ºæ·»åŠ ã€‚runtime_key è¿è¡Œæ—¶çš„keyï¼Œå…·ä½“æœ‰å•¥ç”¨ä¸æ¸…æ¥šã€‚ æ‰§è¡Œå‹æµ‹ï¼š [root@node01 45]# go-stress-testing -c 10 -n 10000 -u http://192.168.229.134:30945/productpage å¼€å§‹å¯åŠ¨ å¹¶å‘æ•°:10 è¯·æ±‚æ•°:10000 è¯·æ±‚å‚æ•°: request: form:http url:http://192.168.229.134:30945/productpage method:GET headers:map[] data: verify:statusCode timeout:30s debug:false â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€ è€—æ—¶â”‚ å¹¶å‘æ•°â”‚ æˆåŠŸæ•°â”‚ å¤±è´¥æ•°â”‚ qps â”‚æœ€é•¿è€—æ—¶â”‚æœ€çŸ­è€—æ—¶â”‚å¹³å‡è€—æ—¶â”‚ä¸‹è½½å­—èŠ‚â”‚å­—èŠ‚æ¯ç§’â”‚ é”™è¯¯ç  â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€ 1sâ”‚ 7â”‚ 2â”‚ 761â”‚ 2.94â”‚ 124.68â”‚ 1.98â”‚ 3406.97â”‚ 21,476â”‚ 21,470â”‚200:2;429:761 2sâ”‚ 10â”‚ 5â”‚ 1636â”‚ 2.55â”‚ 1788.46â”‚ 1.98â”‚ 3928.11â”‚ 52,771â”‚ 26,383â”‚200:5;429:1636 3sâ”‚ 10â”‚ 5â”‚ 2962â”‚ 1.70â”‚ 1788.46â”‚ 1.04â”‚ 5871.68â”‚ 76,639â”‚ 25,545â”‚200:5;429:2962 4sâ”‚ 10â”‚ 5â”‚ 4459â”‚ 1.28â”‚ 1788.46â”‚ 1.04â”‚ 7810.78â”‚ 103,585â”‚ 25,896â”‚200:5;429:4459 429 Too Many Requests (å¤ªå¤šè¯·æ±‚) å½“ä½ éœ€è¦é™åˆ¶å®¢æˆ·ç«¯è¯·æ±‚æŸä¸ªæœåŠ¡çš„æ•°é‡ï¼Œä¹Ÿå°±æ˜¯é™åˆ¶è¯·æ±‚é€Ÿåº¦æ—¶ï¼Œè¯¥çŠ¶æ€ç å°±ä¼šéå¸¸æœ‰ç”¨ æ¸…ç†ï¼š kubectl delete envoyfilter filter-local-ratelimit-svc -n istio 1.2.1.1.1.2å…¨å±€é™æµ éƒ¨ç½²ratelimit 1åˆ›å»ºcm cat \u003c\u003c EOF \u003e ratelimit-config.yaml apiVersion: v1 kind: ConfigMap metadata: name: ratelimit-config data: config.yaml: | domain: productpage-ratelimit descriptors: - key: PATH value: \"/productpage\" rate_limit: unit: minute requests_per_unit: 1 - key: PATH rate_limit: unit: minute requests_per_unit: 100 EOF kubectl apply -f ratelimit-config.yaml -n istio è¯´æ˜: è¿™ä¸ªconfigmapæ˜¯é™é€ŸæœåŠ¡ç”¨åˆ°çš„é…ç½®æ–‡ä»¶ï¼Œä»–æ˜¯envoy v3ç‰ˆæœ¬çš„é™é€Ÿæ ¼å¼ã€‚domainæ˜¯åŸŸåï¼Œä»–ä¼šåœ¨envoyfilterä¸­è¢«å¼•ç”¨ï¼Œdescriptorsçš„PATH,è¡¨ç¤ºè¯·æ±‚çš„è·¯å¾„å¯ä»¥æœ‰å¤šä¸ªå€¼ï¼Œrate_limité…ç½®é™é€Ÿé…é¢ï¼Œè¿™é‡Œproductpageé…äº†1åˆ†é’Ÿ1ä¸ªè¯·æ±‚ï¼Œå…¶ä»–urlæ˜¯1åˆ†é’Ÿ100ä¸ªè¯·æ±‚ 2åˆ›å»ºé™é€ŸæœåŠ¡deployment cat \u003c\u003c EOF \u003e ratelimit-deploy.yaml apiVersion: v1 kind: Service metadata: name: redis labels: app: redis spec: ports: - name: redis port: 6379 selector: app: redis --- apiVersion: apps/v1 kind: Deployment metadata: name: redis spec: replicas: 1 selector: matchLabels: app: redis template: metadata: labels: app: redis spec: containers: - image: redis:alpine imagePullPolicy: Always name: redis ports: - name: redis containerPort: 6379 restartPolicy: Always serviceAccountName: \"\" --- apiVersion: v1 kind: Service metadata: name: ratelimit labels: app: ratelimit spec: ports: - name: http-port port: 8080 targetPort: 8080 protocol: TCP - name: grpc-port port: 8081 targetPort: 8081 protocol: TCP - name: http-debug port: 6070 targetPort: 6070 protocol: TCP selector: app: ratelimit --- apiVersion: apps/v1 kind: Deployment metadata: name: ratelimit spec: replicas: 1 selector: matchLabels: app: ratelimit strategy: type: Recreate template: metadata: labe","date":"2022-05-23","objectID":"/posts/istio%E9%98%B2%E6%95%85%E9%9A%9C%E5%88%A9%E5%99%A8/:3:1","tags":["istio","è½¬è½½"],"title":"Istioé˜²æ•…éšœåˆ©å™¨","uri":"/posts/istio%E9%98%B2%E6%95%85%E9%9A%9C%E5%88%A9%E5%99%A8/"},{"categories":["hugo"],"content":"åˆ›å»ºGithub Actionsæµæ°´çº¿ mkdir -p .github/workflows/ touch hugo.yaml å‘å¸ƒåˆ°æœ¬ä»“åº“ name: GitHub Pages Deploy Local REPOSITORY on: push: branches: - master # Set a branch to deploy pull_request: jobs: deploy: runs-on: ubuntu-20.04 concurrency: group: ${{ github.workflow }}-${{ github.ref }} steps: - uses: actions/checkout@v3 with: submodules: true # Fetch Hugo themes (true OR recursive) fetch-depth: 1 # Fetch all history for .GitInfo and .Lastmod - name: Setup Hugo uses: peaceiris/actions-hugo@v2 with: hugo-version: '0.91.2' extended: true - name: Build run: hugo --minify - name: Deploy uses: peaceiris/actions-gh-pages@v3 with: github_token: ${{ secrets.GITHUB_TOKEN }} publish_dir: ./public å‘å¸ƒåˆ°å¦å¤–ä»“åº“ name: CI #è‡ªåŠ¨åŒ–çš„åç§° on: push: # pushçš„æ—¶å€™è§¦å‘ branches: # é‚£äº›åˆ†æ”¯éœ€è¦è§¦å‘ - master jobs: deploy: runs-on: ubuntu-20.04 steps: - uses: actions/checkout@v2 with: submodules: true # Fetch Hugo themes (true OR recursive) fetch-depth: 1 # Fetch all history for .GitInfo and .Lastmod - name: Setup Hugo uses: peaceiris/actions-hugo@v2 with: hugo-version: 'latest' extended: true - name: Build run: hugo --minify - name: Deploy uses: peaceiris/actions-gh-pages@v3 with: personal_token: ${{ secrets.EXTERNAL_REPOSITORY_TOKEN }} publish_dir: ./public external_repository: kbsonlong/devops.alongparty.cn æ³¨æ„: å‘å¸ƒåˆ°æœ¬ä»“åº“github_tokenä¸éœ€è¦æ‰‹åŠ¨åˆ›å»ºGITHUB_TOKEN, å‘å¸ƒåˆ°å…¶ä»–ä»“åº“personal_tokenéœ€è¦æå‰åˆ›å»ºå¹¶é…ç½®secretå˜é‡ åˆ›å»ºSSHè¯ä¹¦ ssh-keygen -t rsa -b 4096 -C \"$(git config user.email)\" -f gh-pages -N \"\" é…ç½®SSHå…¬é’¥ é…ç½®SSHç§é’¥ ä½¿ç”¨SSHç§é’¥å‘å¸ƒ name: CI #è‡ªåŠ¨åŒ–çš„åç§° on: push: # pushçš„æ—¶å€™è§¦å‘ branches: # é‚£äº›åˆ†æ”¯éœ€è¦è§¦å‘ - master jobs: deploy: runs-on: ubuntu-20.04 steps: - uses: actions/checkout@v2 with: submodules: true # Fetch Hugo themes (true OR recursive) fetch-depth: 1 # Fetch all history for .GitInfo and .Lastmod - name: Setup Hugo uses: peaceiris/actions-hugo@v2 with: hugo-version: 'latest' extended: true - name: Build run: hugo --minify - name: Deploy with PRIVATE KEY uses: peaceiris/actions-gh-pages@v3 with: cname: devops.alongparty.cn env: ACTIONS_DEPLOY_KEY: ${{ secrets.HUGO_DEPLOY_PRIVATE_KEY }} EXTERNAL_REPOSITORY: kbsonlong/devops.alongparty.cn PUBLISH_BRANCH: gh-pages PUBLISH_DIR: ./public æ³¨æ„: éƒ¨ç½²åˆ°å¦å¤–ä»“åº“æ—¶sshç§é’¥é…ç½®åœ¨æºä»“åº“, sshå…¬é’¥é…ç½®åœ¨ç›®æ ‡ä»“åº“æˆ–è€…å…¨å±€ ","date":"2022-05-23","objectID":"/posts/github-actions%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2hugo%E5%8D%9A%E5%AE%A2/:0:1","tags":["github actions"],"title":"Github Actionsè‡ªåŠ¨éƒ¨ç½²hugoåšå®¢","uri":"/posts/github-actions%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2hugo%E5%8D%9A%E5%AE%A2/"},{"categories":["hugo"],"content":"åˆ›å»ºGITHUB Personal TOKEN ","date":"2022-05-23","objectID":"/posts/github-actions%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2hugo%E5%8D%9A%E5%AE%A2/:0:2","tags":["github actions"],"title":"Github Actionsè‡ªåŠ¨éƒ¨ç½²hugoåšå®¢","uri":"/posts/github-actions%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2hugo%E5%8D%9A%E5%AE%A2/"},{"categories":["hugo"],"content":"åˆ›å»ºä»“åº“Secretså˜é‡ ","date":"2022-05-23","objectID":"/posts/github-actions%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2hugo%E5%8D%9A%E5%AE%A2/:0:3","tags":["github actions"],"title":"Github Actionsè‡ªåŠ¨éƒ¨ç½²hugoåšå®¢","uri":"/posts/github-actions%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2hugo%E5%8D%9A%E5%AE%A2/"},{"categories":["hugo"],"content":"Github Pageé…ç½®è‡ªå®šä¹‰åŸŸå echo \"\u003cè‡ªå®šä¹‰åŸŸå\u003e\" \u003estatic/CNAME ","date":"2022-05-23","objectID":"/posts/github-actions%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2hugo%E5%8D%9A%E5%AE%A2/:0:4","tags":["github actions"],"title":"Github Actionsè‡ªåŠ¨éƒ¨ç½²hugoåšå®¢","uri":"/posts/github-actions%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2hugo%E5%8D%9A%E5%AE%A2/"},{"categories":["hugo"],"content":"Deployæ—¶è¿‡æ»¤é™æ€æ–‡ä»¶ - name: Deploy uses: peaceiris/actions-gh-pages@v3 with: personal_token: ${{ secrets.EXTERNAL_REPOSITORY_TOKEN }} external_repository: kbsonlong/devops.alongparty.cn publish_branch: gh-pages # default: gh-pages publish_dir: ./public exclude_assets: './algolia.json,./*/*.md' # æ”¯æŒæ­£åˆ™è¿‡æ»¤,åŸºäºç¼–è¯‘åçš„é™æ€æ–‡ä»¶,æ ¹ç›®å½•publish_dir user_name: 'github-actions[bot]' user_email: 'github-actions[bot]@users.noreply.github.com' commit_message: ${{ github.event.head_commit.message }} tag_name: ${{ steps.prepare_tag.outputs.deploy_tag_name }} tag_message: 'Deployment ${{ steps.prepare_tag.outputs.tag_name }}' ","date":"2022-05-23","objectID":"/posts/github-actions%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2hugo%E5%8D%9A%E5%AE%A2/:0:5","tags":["github actions"],"title":"Github Actionsè‡ªåŠ¨éƒ¨ç½²hugoåšå®¢","uri":"/posts/github-actions%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2hugo%E5%8D%9A%E5%AE%A2/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"rebaseåˆ†æ”¯åˆå¹¶ ","date":"2020-11-18","objectID":"/posts/git%E5%8F%98%E5%9F%BA%E5%90%88%E5%B9%B6/:0:0","tags":["Git"],"title":"Gitå˜åŸºåˆå¹¶","uri":"/posts/git%E5%8F%98%E5%9F%BA%E5%90%88%E5%B9%B6/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"è¯´æ˜ ä»¥ä¸‹ v2 æ˜¯æŸä¸ªéœ€æ±‚çš„å¼€å‘åˆ†æ”¯ï¼Œ devæ˜¯æ€»çš„å¼€å‘åˆ†æ”¯ï¼Œv2 æ˜¯åŸºäºdevåˆ†æ”¯ç­¾å‡ºçš„ã€‚ å½“å®Œæˆv2çš„å¼€å‘åï¼Œéœ€è¦æŠŠä»£ç åˆå¹¶åˆ°devï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨rebaseè¿›è¡Œåˆå¹¶ï¼š # é¦–å…ˆå°† v2 pushåˆ°è¿œç¨‹ä»“åº“ git add . git commit -m 'xxx' git push origin v2 # åˆ‡æ¢åˆ° dev æ‹‰å–æœ€æ–°ä»£ç  git checkout dev git pull origin dev # åˆ‡æ¢åˆ° v2 git checkout v2 git rebase dev # å°† v2 çš„æ‰€æœ‰[commit] å˜åŸºåˆ°(åº”ç”¨åˆ°) dev # åˆ‡æ¢åˆ° dev git checkout dev git merge v2 # å°† devåˆ†æ”¯ å¿«è¿›åˆå¹¶ ï¼ˆæ­¤æ—¶ (HEAD -\u003e dev, v2) [commit] ä¸¤ä¸ªåˆ†æ”¯æŒ‡å‘åŒä¸€ä¸ªæäº¤ï¼‰ # æŸ¥çœ‹ åŸv2çš„[commit]è®°å½• æ˜¯å¦åœ¨devåˆ†æ”¯çš„æœ€å‰é¢ï¼ˆå˜åŸºæˆåŠŸä¼šæŠŠv2çš„æäº¤è®°å½•åº”ç”¨åˆ°devåˆ†æ”¯çš„æœ€å‰é¢ï¼‰ git log # å¦‚æœåˆ°è¿™ä¸€æ­¥å‘ç°æœ‰é—®é¢˜ï¼Œå°è¯•ä½¿ç”¨ git --abortä¸­æ­¢å˜åŸºï¼Œå¦‚æœè¿˜æ˜¯æœ‰é—®é¢˜çš„å¯ä»¥åœ¨devåˆ†æ”¯ä¸Šä½¿ç”¨ã€Šåæ‚”è¯ã€‹æ“ä½œï¼Œ å†åˆ°v2åˆ†æ”¯ä¸Šä½¿ç”¨ã€Šåæ‚”è¯ã€‹æ“ä½œï¼Œå³å¯ä½¿ä¸¤ä¸ªåˆ†æ”¯éƒ½å›é€€åˆ° rebaseå˜åŸº ä¹‹å‰çš„çŠ¶æ€ # è¯•è¿è¡Œé¡¹ç›®æ˜¯å¦æœ‰é—®é¢˜ yarn start git status # æŸ¥çœ‹çŠ¶æ€æ˜¯å¦æœ‰é—®é¢˜ git push origin dev # æ¨é€åˆ°è¿œç¨‹ä»“åº“çš„ dev ","date":"2020-11-18","objectID":"/posts/git%E5%8F%98%E5%9F%BA%E5%90%88%E5%B9%B6/:1:0","tags":["Git"],"title":"Gitå˜åŸºåˆå¹¶","uri":"/posts/git%E5%8F%98%E5%9F%BA%E5%90%88%E5%B9%B6/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"å˜åŸºè¦éµå®ˆçš„å‡†åˆ™ å‡ ä¸ªäººåŒæ—¶åœ¨ä¸€ä¸ªåˆ†æ”¯ä¸Šè¿›è¡Œå¼€å‘å’Œæäº¤æ—¶ï¼Œä½ ä¸è¦ä¸­é€”æ‰§è¡Œå˜åŸºï¼Œåªæœ‰åœ¨å¤§å®¶éƒ½å®Œæˆå·¥ä½œä¹‹åæ‰å¯ä»¥æ‰§è¡Œå˜åŸºã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%8F%98%E5%9F%BA%E5%90%88%E5%B9%B6/:1:1","tags":["Git"],"title":"Gitå˜åŸºåˆå¹¶","uri":"/posts/git%E5%8F%98%E5%9F%BA%E5%90%88%E5%B9%B6/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"å˜åŸºçš„å®è´¨ å˜åŸºæ“ä½œçš„å®è´¨æ˜¯ä¸¢å¼ƒä¸€äº›ç°æœ‰çš„æäº¤ï¼Œç„¶åç›¸åº”åœ°æ–°å»ºä¸€äº›å†…å®¹ä¸€æ ·ä½†å®é™…ä¸Šä¸åŒçš„æäº¤ã€‚ å› æ­¤ï¼Œå˜åŸºæ“ä½œè¿‡åçš„åˆ†æ”¯å°†ä¸è¦å†ä½¿ç”¨ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%8F%98%E5%9F%BA%E5%90%88%E5%B9%B6/:1:2","tags":["Git"],"title":"Gitå˜åŸºåˆå¹¶","uri":"/posts/git%E5%8F%98%E5%9F%BA%E5%90%88%E5%B9%B6/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"åæ‚”è¯ # æŸ¥çœ‹HEADæŒ‡é’ˆå˜åŠ¨è®°å½• git reflog # è®°å½•ç¤ºä¾‹(å½“å‰åˆ†æ”¯æ˜¯v2): 07c398f (HEAD -\u003e v2, master) HEAD@{0}: checkout: moving from master to v2 07c398f (HEAD -\u003e v2, master) HEAD@{1}: rebase (finish): returning to refs/heads/master 07c398f (HEAD -\u003e v2, master) HEAD@{2}: rebase (start): checkout v2 15a97d8 HEAD@{3}: reset: moving to 15a97d8 07c398f (HEAD -\u003e v2, master) HEAD@{4}: merge v2: Fast-forward 15a97d8 HEAD@{5}: checkout: moving from v2 to master 07c398f (HEAD -\u003e v2, master) HEAD@{6}: rebase (finish): returning to refs/heads/v2 07c398f (HEAD -\u003e v2, master) HEAD@{7}: rebase (pick): C 15a97d8 HEAD@{8}: rebase (start): checkout master # é¦–æ¬¡rebase d278ecd HEAD@{9}: checkout: moving from master to v2 # rebaseå‰çš„çŠ¶æ€ 15a97d8 HEAD@{10}: commit: D # å¯è§ï¼Œç¤ºä¾‹ä¸­æœ€åˆçš„ rebase æ“ä½œæ˜¯ HEAD@{8}ï¼Œæƒ³å›é€€åˆ°å˜åŸºå‰çš„çŠ¶æ€éœ€è®©æŒ‡é’ˆæŒ‡å‘ HEAD@{9} git reset --hard d278ecd # é‡ç½®å½“å‰åˆ†æ”¯çš„HEADä¸ºæŒ‡å®š[commit]ï¼ŒåŒæ—¶é‡ç½®æš‚å­˜åŒºå’Œå·¥ä½œåŒºï¼Œä¸æŒ‡å®š[commit]ä¸€è‡´ # æ­¤æ—¶æ‰“å° log æŸ¥çœ‹æ˜¯å¦å›åˆ°ä¹‹å‰çš„çŠ¶æ€ git log æ³¨æ„ï¼šæ­¤æ“ä½œåªèƒ½å›é€€å½“å‰çš„åˆ†æ”¯ï¼Œå¦‚å…¶ä»–åˆ†æ”¯ä¹Ÿè¦å›é€€ï¼Œéœ€è¦åˆ‡æ¢åˆ°è¯¥åˆ†æ”¯å¹¶æ‰§è¡Œä¸Šé¢æ“ä½œã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%8F%98%E5%9F%BA%E5%90%88%E5%B9%B6/:2:0","tags":["Git"],"title":"Gitå˜åŸºåˆå¹¶","uri":"/posts/git%E5%8F%98%E5%9F%BA%E5%90%88%E5%B9%B6/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"å¼€å‘æœŸé—´çš„rebaseæ“ä½œ ","date":"2020-11-18","objectID":"/posts/git%E5%8F%98%E5%9F%BA%E5%90%88%E5%B9%B6/:3:0","tags":["Git"],"title":"Gitå˜åŸºåˆå¹¶","uri":"/posts/git%E5%8F%98%E5%9F%BA%E5%90%88%E5%B9%B6/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"èƒŒæ™¯ æœ‰ä¸¤ä¸ªåˆ†æ”¯ï¼š dev *v2 2.4-dev æ˜¯åŸºäºdevåˆ‡å‡ºæ¥çš„ã€‚ æäº¤è®°å½•å¦‚ä¸‹ï¼š dev a - b - c v2 å¼€å‘æœŸé—´ï¼Œä¸¤ä¸ªåˆ†æ”¯åŒæ—¶æœ‰æ–°çš„commit ï¼š dev a - b - c - d - e \\ - f - g v2 å½“å‰ä½ æ­£åœ¨v2è¿›è¡Œå¼€å‘ï¼Œdevä¹ŸåŒæ—¶è¿›è¡Œå¼€å‘ï¼Œå¹¶æœ‰é‡å¤§çš„æ”¹å˜ï¼Œä½ éœ€è¦æŠŠdevçš„æäº¤åŒæ­¥åˆ°v2ã€‚ éœ€æ±‚ï¼š æŠŠdevä¸­æ–°çš„æäº¤åŒæ­¥åˆ°v2ï¼Œä¸”ä¸èƒ½å½±å“devåˆ†æ”¯ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%8F%98%E5%9F%BA%E5%90%88%E5%B9%B6/:3:1","tags":["Git"],"title":"Gitå˜åŸºåˆå¹¶","uri":"/posts/git%E5%8F%98%E5%9F%BA%E5%90%88%E5%B9%B6/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"æ“ä½œæ­¥éª¤ åŸºäºæœ€æ–°çš„ dev åˆ‡ä¸€ä¸ªæ–°çš„åˆ†æ”¯ dev-copy dev-copy å’Œ dev ä¸¤è€…çš„ commit ID ä¸€è‡´ã€‚ åœ¨dev-copyä¸­æ‰§è¡Œrebaseï¼Œå°† dev-copy çš„æäº¤å˜åŸºåˆ° v2 git rebase v2 # å°† dev-copy çš„æäº¤[commit] å˜åŸºåˆ°(åº”ç”¨åˆ°) v2 åˆ é™¤åŸv2åˆ†æ”¯ï¼Œå°†dev-copyåˆ†æ”¯åæ”¹ä¸ºv2 # å½“å‰åœ¨ dev-copy åˆ†æ”¯ git branch -d v2 # åˆ é™¤åˆ†æ”¯ git branch -m dev-copy v2 # é‡å‘½å ","date":"2020-11-18","objectID":"/posts/git%E5%8F%98%E5%9F%BA%E5%90%88%E5%B9%B6/:3:2","tags":["Git"],"title":"Gitå˜åŸºåˆå¹¶","uri":"/posts/git%E5%8F%98%E5%9F%BA%E5%90%88%E5%B9%B6/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"git cherry-pick æ¥æºï¼šã€Šgit cherry-pick æ•™ç¨‹ã€‹ ç”¨äºå°†å•ä¸ªæˆ–å‡ ä¸ª[commit]å¤åˆ¶åˆ°å¦ä¸€ä¸ªåˆ†æ”¯ã€‚ åŸºæœ¬åº”ç”¨ git cherry-pick \u003ccommitHash\u003e # å°†commitHashåº”ç”¨äºå½“å‰åˆ†æ”¯ ä¸Šé¢å‘½ä»¤å°±ä¼šå°†æŒ‡å®šçš„æäº¤commitHashï¼Œåº”ç”¨äºå½“å‰åˆ†æ”¯ã€‚è¿™ä¼šåœ¨å½“å‰åˆ†æ”¯äº§ç”Ÿä¸€ä¸ªæ–°çš„æäº¤ï¼Œå½“ç„¶å®ƒä»¬çš„å“ˆå¸Œå€¼ä¼šä¸ä¸€æ ·ã€‚ git cherry-pickå‘½ä»¤çš„å‚æ•°ï¼Œä¸ä¸€å®šæ˜¯æäº¤çš„å“ˆå¸Œå€¼ï¼Œåˆ†æ”¯åä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œè¡¨ç¤ºè½¬ç§»è¯¥åˆ†æ”¯çš„æœ€æ–°æäº¤ã€‚ è½¬ç§»å¤šä¸ªæäº¤ Cherry pick æ”¯æŒä¸€æ¬¡è½¬ç§»å¤šä¸ªæäº¤ã€‚ git cherry-pick \u003cHashA\u003e \u003cHashB\u003e # Aå’ŒBæäº¤ ä¸Šé¢çš„å‘½ä»¤å°† A å’Œ B ä¸¤ä¸ªæäº¤åº”ç”¨åˆ°å½“å‰åˆ†æ”¯ã€‚è¿™ä¼šåœ¨å½“å‰åˆ†æ”¯ç”Ÿæˆä¸¤ä¸ªå¯¹åº”çš„æ–°æäº¤ã€‚ å¦‚æœæƒ³è¦è½¬ç§»ä¸€ç³»åˆ—çš„è¿ç»­æäº¤ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ç®€ä¾¿è¯­æ³•ã€‚ git cherry-pick A..B # Aåˆ°Bæäº¤ï¼Œä¸åŒ…å«A ä¸Šé¢çš„å‘½ä»¤å¯ä»¥è½¬ç§»ä» A åˆ° B çš„æ‰€æœ‰æäº¤ã€‚å®ƒä»¬å¿…é¡»æŒ‰ç…§æ­£ç¡®çš„é¡ºåºæ”¾ç½®ï¼šæäº¤ A å¿…é¡»æ—©äºæäº¤ Bï¼Œå¦åˆ™å‘½ä»¤å°†å¤±è´¥ï¼Œä½†ä¸ä¼šæŠ¥é”™ã€‚ æ³¨æ„ï¼Œä½¿ç”¨ä¸Šé¢çš„å‘½ä»¤ï¼Œæäº¤ A å°†ä¸ä¼šåŒ…å«åœ¨ Cherry pick ä¸­ã€‚å¦‚æœè¦åŒ…å«æäº¤ Aï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„è¯­æ³•ã€‚ git cherry-pick A^..B # Aåˆ°Bæäº¤ï¼ŒåŒ…å«A ","date":"2020-11-18","objectID":"/posts/git%E5%8F%98%E5%9F%BA%E5%90%88%E5%B9%B6/:3:3","tags":["Git"],"title":"Gitå˜åŸºåˆå¹¶","uri":"/posts/git%E5%8F%98%E5%9F%BA%E5%90%88%E5%B9%B6/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"Gitåˆ†æ”¯-å˜åŸº åœ¨ Git ä¸­æ•´åˆæ¥è‡ªä¸åŒåˆ†æ”¯çš„ä¿®æ”¹ä¸»è¦æœ‰ä¸¤ç§æ–¹æ³•ï¼šmerge ä»¥åŠ rebaseã€‚ åœ¨æœ¬èŠ‚ä¸­æˆ‘ä»¬å°†å­¦ä¹ ä»€ä¹ˆæ˜¯â€œå˜åŸºâ€ï¼Œæ€æ ·ä½¿ç”¨â€œå˜åŸºâ€ï¼Œå¹¶å°†å±•ç¤ºè¯¥æ“ä½œçš„æƒŠè‰³ä¹‹å¤„ï¼Œä»¥åŠæŒ‡å‡ºåœ¨ä½•ç§æƒ…å†µä¸‹ä½ åº”é¿å…ä½¿ç”¨å®ƒã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%88%86%E6%94%AF-%E5%8F%98%E5%9F%BA/:0:0","tags":["Git"],"title":"Gitåˆ†æ”¯-å˜åŸº","uri":"/posts/git%E5%88%86%E6%94%AF-%E5%8F%98%E5%9F%BA/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"å˜åŸºçš„åŸºæœ¬æ“ä½œ è¯·å›é¡¾ä¹‹å‰åœ¨ åˆ†æ”¯çš„åˆå¹¶ ä¸­çš„ä¸€ä¸ªä¾‹å­ï¼Œä½ ä¼šçœ‹åˆ°å¼€å‘ä»»åŠ¡åˆ†å‰åˆ°ä¸¤ä¸ªä¸åŒåˆ†æ”¯ï¼Œåˆå„è‡ªæäº¤äº†æ›´æ–°ã€‚ å›¾0. åˆ†å‰çš„æäº¤å†å² â–² ä¹‹å‰ä»‹ç»è¿‡ï¼Œæ•´åˆåˆ†æ”¯æœ€å®¹æ˜“çš„æ–¹æ³•æ˜¯ merge å‘½ä»¤ã€‚ å®ƒä¼šæŠŠä¸¤ä¸ªåˆ†æ”¯çš„æœ€æ–°å¿«ç…§ï¼ˆC3 å’Œ C4ï¼‰ä»¥åŠäºŒè€…æœ€è¿‘çš„å…±åŒç¥–å…ˆï¼ˆC2ï¼‰è¿›è¡Œä¸‰æ–¹åˆå¹¶ï¼Œåˆå¹¶çš„ç»“æœæ˜¯ç”Ÿæˆä¸€ä¸ªæ–°çš„å¿«ç…§ï¼ˆå¹¶æäº¤ï¼‰ã€‚ å›¾1. é€šè¿‡åˆå¹¶æ“ä½œæ¥æ•´åˆåˆ†å‰çš„å†å² â–² ","date":"2020-11-18","objectID":"/posts/git%E5%88%86%E6%94%AF-%E5%8F%98%E5%9F%BA/:1:0","tags":["Git"],"title":"Gitåˆ†æ”¯-å˜åŸº","uri":"/posts/git%E5%88%86%E6%94%AF-%E5%8F%98%E5%9F%BA/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"æ¦‚å¿µ å˜åŸºå°±æ˜¯ï¼šå°†æŸä¸€åˆ†æ”¯ä¸Šçš„æ‰€æœ‰ä¿®æ”¹å¤åˆ¶åˆ°å¦ä¸€åˆ†æ”¯ä¸Š é™¤äº†mergeï¼Œè¿˜æœ‰ä¸€ç§æ–¹æ³•ï¼šä½ å¯ä»¥æå–åœ¨ C4 ä¸­å¼•å…¥çš„è¡¥ä¸å’Œä¿®æ”¹ï¼Œç„¶ååœ¨ C3 çš„åŸºç¡€ä¸Šåº”ç”¨ä¸€æ¬¡ã€‚ åœ¨ Git ä¸­ï¼Œè¿™ç§æ“ä½œå°±å«åš å˜åŸºï¼ˆrebaseï¼‰ã€‚ ä½ å¯ä»¥ä½¿ç”¨ rebase å‘½ä»¤å°†æäº¤åˆ°æŸä¸€åˆ†æ”¯ä¸Šçš„æ‰€æœ‰ä¿®æ”¹éƒ½ç§»åˆ°å¦ä¸€åˆ†æ”¯ä¸Šï¼Œå°±å¥½åƒâ€œé‡æ–°æ’­æ”¾â€ä¸€æ ·ã€‚ åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œä½ å¯ä»¥æ£€å‡º experiment åˆ†æ”¯ï¼Œç„¶åå°†å®ƒå˜åŸºåˆ° master åˆ†æ”¯ä¸Šï¼š $ git checkout experiment $ git rebase master # å°†experimentä¸Šçš„ä¿®æ”¹å˜åŸºåˆ°masteråˆ†æ”¯ä¸Šï¼ˆå°†experimentçš„æäº¤ç§»åŠ¨åˆ°masterä¸Šã€‚ï¼‰ First, rewinding head to replay your work on top of it... Applying: added staged command å®ƒçš„åŸç†æ˜¯é¦–å…ˆæ‰¾åˆ°è¿™ä¸¤ä¸ªåˆ†æ”¯ï¼ˆå³å½“å‰åˆ†æ”¯ experimentã€å˜åŸºæ“ä½œçš„ç›®æ ‡åŸºåº•åˆ†æ”¯ masterï¼‰ çš„æœ€è¿‘å…±åŒç¥–å…ˆ C2ï¼Œç„¶åå¯¹æ¯”å½“å‰åˆ†æ”¯ç›¸å¯¹äºè¯¥ç¥–å…ˆçš„å†æ¬¡æäº¤ï¼Œæå–ç›¸åº”çš„ä¿®æ”¹å¹¶å­˜ä¸ºä¸´æ—¶æ–‡ä»¶ï¼Œ ç„¶åå°†å½“å‰åˆ†æ”¯æŒ‡å‘ç›®æ ‡åŸºåº• C3, æœ€åä»¥æ­¤å°†ä¹‹å‰å¦å­˜ä¸ºä¸´æ—¶æ–‡ä»¶çš„ä¿®æ”¹ä¾åºåº”ç”¨ã€‚ ï¼ˆè¯‘æ³¨ï¼šå†™æ˜äº† commit idï¼Œä»¥ä¾¿ç†è§£ï¼Œä¸‹åŒï¼‰ ","date":"2020-11-18","objectID":"/posts/git%E5%88%86%E6%94%AF-%E5%8F%98%E5%9F%BA/:1:1","tags":["Git"],"title":"Gitåˆ†æ”¯-å˜åŸº","uri":"/posts/git%E5%88%86%E6%94%AF-%E5%8F%98%E5%9F%BA/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"åŸç† æ‰¾åˆ°å½“å‰åˆ†æ”¯å’Œç›®æ ‡åˆ†æ”¯çš„æœ€è¿‘å…±åŒç¥–å…ˆ å¯¹æ¯”å½“å‰åˆ†æ”¯ç›¸å¯¹äºè¯¥å…±åŒç¥–å…ˆçš„å†æ¬¡æäº¤ æå–ç›¸åº”çš„ä¿®æ”¹å¹¶å­˜ä¸ºä¸´æ—¶æ–‡ä»¶ å°†å½“å‰åˆ†æ”¯æŒ‡å‘ç›®æ ‡åˆ†æ”¯ å°†ä¹‹å‰ä¸´æ—¶æ–‡ä»¶çš„ä¿®æ”¹ä¾åºåº”ç”¨ å›¾2.å°† C4 ä¸­çš„ä¿®æ”¹å˜åŸºåˆ° C3 ä¸Š â–² ç°åœ¨å›åˆ° master åˆ†æ”¯ï¼Œè¿›è¡Œä¸€æ¬¡å¿«è¿›åˆå¹¶ã€‚ $ git checkout master $ git merge experiment å›¾3.master åˆ†æ”¯çš„å¿«è¿›åˆå¹¶ â–² ","date":"2020-11-18","objectID":"/posts/git%E5%88%86%E6%94%AF-%E5%8F%98%E5%9F%BA/:1:2","tags":["Git"],"title":"Gitåˆ†æ”¯-å˜åŸº","uri":"/posts/git%E5%88%86%E6%94%AF-%E5%8F%98%E5%9F%BA/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"æ­¥éª¤ å…ˆæ£€å‡ºæºåˆ†æ”¯ï¼Œå°†æºåˆ†æ”¯çš„ä¿®æ”¹å˜åŸºåˆ°ç›®æ ‡åˆ†æ”¯ã€‚åˆ‡å›ç›®æ ‡åˆ†æ”¯ï¼Œè¿›è¡Œä¸€æ¬¡å¿«è¿›åˆå¹¶ # ç¤ºæ„ï¼š git checkout \u003cæºåˆ†æ”¯\u003e git (æºåˆ†æ”¯çš„ä¿®æ”¹)rebase(åˆ°) \u003cç›®æ ‡åˆ†æ”¯\u003e git checkout \u003cç›®æ ‡åˆ†æ”¯\u003e git merge \u003cæºåˆ†æ”¯\u003e æ­¤æ—¶ï¼ŒC4' æŒ‡å‘çš„å¿«ç…§å°±å’Œ the merge example ä¸­ C5 æŒ‡å‘çš„å¿«ç…§ä¸€æ¨¡ä¸€æ ·äº†ã€‚ è¿™ä¸¤ç§æ•´åˆæ–¹æ³•çš„æœ€ç»ˆç»“æœæ²¡æœ‰ä»»ä½•åŒºåˆ«ï¼Œä½†æ˜¯ å˜åŸºä½¿å¾—æäº¤å†å²æ›´åŠ æ•´æ´ã€‚ ä½ åœ¨æŸ¥çœ‹ä¸€ä¸ªç»è¿‡å˜åŸºçš„åˆ†æ”¯çš„å†å²è®°å½•æ—¶ä¼šå‘ç°ï¼Œå°½ç®¡å®é™…çš„å¼€å‘å·¥ä½œæ˜¯å¹¶è¡Œçš„ï¼Œ ä½†å®ƒä»¬çœ‹ä¸Šå»å°±åƒæ˜¯ä¸²è¡Œçš„ä¸€æ ·ï¼Œæäº¤å†å²æ˜¯ä¸€æ¡ç›´çº¿æ²¡æœ‰åˆ†å‰ã€‚ ä¸€èˆ¬æˆ‘ä»¬è¿™æ ·åšçš„ç›®çš„æ˜¯ä¸ºäº†ç¡®ä¿åœ¨å‘è¿œç¨‹åˆ†æ”¯æ¨é€æ—¶èƒ½ä¿æŒæäº¤å†å²çš„æ•´æ´â€”â€”ä¾‹å¦‚å‘æŸä¸ªå…¶ä»–äººç»´æŠ¤çš„é¡¹ç›®è´¡çŒ®ä»£ç æ—¶ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ é¦–å…ˆåœ¨è‡ªå·±çš„åˆ†æ”¯é‡Œè¿›è¡Œå¼€å‘ï¼Œå½“å¼€å‘å®Œæˆæ—¶ä½ éœ€è¦å…ˆå°†ä½ çš„ä»£ç å˜åŸºåˆ° origin/master ä¸Šï¼Œç„¶åå†å‘ä¸»é¡¹ç›®æäº¤ä¿®æ”¹ã€‚ è¿™æ ·çš„è¯ï¼Œè¯¥é¡¹ç›®çš„ç»´æŠ¤è€…å°±ä¸å†éœ€è¦è¿›è¡Œæ•´åˆå·¥ä½œï¼Œåªéœ€è¦å¿«è¿›åˆå¹¶ä¾¿å¯ã€‚ è¯·æ³¨æ„ï¼Œæ— è®ºæ˜¯é€šè¿‡å˜åŸºï¼Œè¿˜æ˜¯é€šè¿‡ä¸‰æ–¹åˆå¹¶ï¼Œæ•´åˆçš„æœ€ç»ˆç»“æœæ‰€æŒ‡å‘çš„å¿«ç…§å§‹ç»ˆæ˜¯ä¸€æ ·çš„ï¼Œåªä¸è¿‡æäº¤å†å²ä¸åŒç½¢äº†ã€‚ å˜åŸºæ˜¯å°†ä¸€ç³»åˆ—æäº¤æŒ‰ç…§åŸæœ‰æ¬¡åºä¾æ¬¡åº”ç”¨åˆ°å¦ä¸€åˆ†æ”¯ä¸Šï¼Œè€Œåˆå¹¶æ˜¯æŠŠæœ€ç»ˆç»“æœåˆåœ¨ä¸€èµ·ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%88%86%E6%94%AF-%E5%8F%98%E5%9F%BA/:1:3","tags":["Git"],"title":"Gitåˆ†æ”¯-å˜åŸº","uri":"/posts/git%E5%88%86%E6%94%AF-%E5%8F%98%E5%9F%BA/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"ä¼˜ç‚¹ å˜åŸºçš„ä¼˜ç‚¹ï¼š ä½¿æäº¤è®°å½•æ›´åŠ æ•´æ´ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%88%86%E6%94%AF-%E5%8F%98%E5%9F%BA/:1:4","tags":["Git"],"title":"Gitåˆ†æ”¯-å˜åŸº","uri":"/posts/git%E5%88%86%E6%94%AF-%E5%8F%98%E5%9F%BA/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"æ›´æœ‰è¶£çš„å˜åŸºä¾‹å­ åœ¨å¯¹ä¸¤ä¸ªåˆ†æ”¯è¿›è¡Œå˜åŸºæ—¶ï¼Œæ‰€ç”Ÿæˆçš„â€œé‡æ”¾â€å¹¶ä¸ä¸€å®šè¦åœ¨ç›®æ ‡åˆ†æ”¯ä¸Šåº”ç”¨ï¼Œä½ ä¹Ÿå¯ä»¥æŒ‡å®šå¦å¤–çš„ä¸€ä¸ªåˆ†æ”¯è¿›è¡Œåº”ç”¨ã€‚ å°±åƒ ä»ä¸€ä¸ªä¸»é¢˜åˆ†æ”¯é‡Œå†åˆ†å‡ºä¸€ä¸ªä¸»é¢˜åˆ†æ”¯çš„æäº¤å†å² ä¸­çš„ä¾‹å­é‚£æ ·ã€‚ ä½ åˆ›å»ºäº†ä¸€ä¸ªä¸»é¢˜åˆ†æ”¯ serverï¼Œä¸ºæœåŠ¡ç«¯æ·»åŠ äº†ä¸€äº›åŠŸèƒ½ï¼Œæäº¤äº† C3 å’Œ C4ã€‚ ç„¶åä» C3 ä¸Šåˆ›å»ºäº†ä¸»é¢˜åˆ†æ”¯ clientï¼Œä¸ºå®¢æˆ·ç«¯æ·»åŠ äº†ä¸€äº›åŠŸèƒ½ï¼Œæäº¤äº† C8 å’Œ C9ã€‚ æœ€åï¼Œä½ å›åˆ° server åˆ†æ”¯ï¼Œåˆæäº¤äº† C10ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%88%86%E6%94%AF-%E5%8F%98%E5%9F%BA/:2:0","tags":["Git"],"title":"Gitåˆ†æ”¯-å˜åŸº","uri":"/posts/git%E5%88%86%E6%94%AF-%E5%8F%98%E5%9F%BA/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"æ›´æœ‰è¶£çš„å˜åŸºä¾‹å­ åœ¨å¯¹ä¸¤ä¸ªåˆ†æ”¯è¿›è¡Œå˜åŸºæ—¶ï¼Œæ‰€ç”Ÿæˆçš„â€œé‡æ”¾â€å¹¶ä¸ä¸€å®šè¦åœ¨ç›®æ ‡åˆ†æ”¯ä¸Šåº”ç”¨ï¼Œä½ ä¹Ÿå¯ä»¥æŒ‡å®šå¦å¤–çš„ä¸€ä¸ªåˆ†æ”¯è¿›è¡Œåº”ç”¨ã€‚ å°±åƒ ä»ä¸€ä¸ªä¸»é¢˜åˆ†æ”¯é‡Œå†åˆ†å‡ºä¸€ä¸ªä¸»é¢˜åˆ†æ”¯çš„æäº¤å†å² ä¸­çš„ä¾‹å­é‚£æ ·ã€‚ ä½ åˆ›å»ºäº†ä¸€ä¸ªä¸»é¢˜åˆ†æ”¯ serverï¼Œä¸ºæœåŠ¡ç«¯æ·»åŠ äº†ä¸€äº›åŠŸèƒ½ï¼Œæäº¤äº† C3 å’Œ C4ã€‚ ç„¶åä» C3 ä¸Šåˆ›å»ºäº†ä¸»é¢˜åˆ†æ”¯ clientï¼Œä¸ºå®¢æˆ·ç«¯æ·»åŠ äº†ä¸€äº›åŠŸèƒ½ï¼Œæäº¤äº† C8 å’Œ C9ã€‚ æœ€åï¼Œä½ å›åˆ° server åˆ†æ”¯ï¼Œåˆæäº¤äº† C10ã€‚ å›¾4.ä»ä¸€ä¸ªä¸»é¢˜åˆ†æ”¯é‡Œå†åˆ†å‡ºä¸€ä¸ªä¸»é¢˜åˆ†æ”¯çš„æäº¤å†å² â–² å‡è®¾ä½ å¸Œæœ›å°† client ä¸­çš„ä¿®æ”¹åˆå¹¶åˆ°ä¸»åˆ†æ”¯å¹¶å‘å¸ƒï¼Œä½†æš‚æ—¶å¹¶ä¸æƒ³åˆå¹¶ server ä¸­çš„ä¿®æ”¹ï¼Œ å› ä¸ºå®ƒä»¬è¿˜éœ€è¦ç»è¿‡æ›´å…¨é¢çš„æµ‹è¯•ã€‚è¿™æ—¶ï¼Œä½ å°±å¯ä»¥ä½¿ç”¨ git rebase å‘½ä»¤çš„ --onto é€‰é¡¹ï¼Œ é€‰ä¸­åœ¨ client åˆ†æ”¯é‡Œä½†ä¸åœ¨ server åˆ†æ”¯é‡Œçš„ä¿®æ”¹ï¼ˆå³ C8 å’Œ C9ï¼‰ï¼Œå°†å®ƒä»¬åœ¨ master åˆ†æ”¯ä¸Šé‡æ”¾ï¼š $ git rebase --onto master server client ä»¥ä¸Šå‘½ä»¤çš„æ„æ€æ˜¯ï¼šâ€œå–å‡º client åˆ†æ”¯ï¼Œæ‰¾å‡ºå®ƒä» server åˆ†æ”¯åˆ†æ­§ä¹‹åçš„è¡¥ä¸ï¼Œ ç„¶åæŠŠè¿™äº›è¡¥ä¸åœ¨ master åˆ†æ”¯ä¸Šé‡æ”¾ä¸€éï¼Œè®© client çœ‹èµ·æ¥åƒç›´æ¥åŸºäº master ä¿®æ”¹ä¸€æ ·â€ã€‚è¿™ç†è§£èµ·æ¥æœ‰ä¸€ç‚¹å¤æ‚ï¼Œä¸è¿‡æ•ˆæœéå¸¸é…·ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%88%86%E6%94%AF-%E5%8F%98%E5%9F%BA/:2:1","tags":["Git"],"title":"Gitåˆ†æ”¯-å˜åŸº","uri":"/posts/git%E5%88%86%E6%94%AF-%E5%8F%98%E5%9F%BA/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"â€“ontoé€‰é¡¹ é€‰ä¸­Cåˆ†æ”¯ä¸­çš„ä½†ä¸åœ¨Båˆ†æ”¯é‡Œçš„ä¿®æ”¹ï¼Œåº”ç”¨åˆ°Aåˆ†æ”¯ã€‚ å›¾5.æˆªå–ä¸»é¢˜åˆ†æ”¯ä¸Šçš„å¦ä¸€ä¸ªä¸»é¢˜åˆ†æ”¯ï¼Œç„¶åå˜åŸºåˆ°å…¶ä»–åˆ†æ”¯ â–² ç°åœ¨å¯ä»¥å¿«è¿›åˆå¹¶ master åˆ†æ”¯äº†ã€‚ï¼ˆå¦‚å›¾ å¿«è¿›åˆå¹¶ master åˆ†æ”¯ï¼Œä½¿ä¹‹åŒ…å«æ¥è‡ª client åˆ†æ”¯çš„ä¿®æ”¹ï¼‰ï¼š $ git checkout master $ git merge client å›¾6.å¿«è¿›åˆå¹¶ `master` åˆ†æ”¯ï¼Œä½¿ä¹‹åŒ…å«æ¥è‡ª `client` åˆ†æ”¯çš„ä¿®æ”¹ â–² ","date":"2020-11-18","objectID":"/posts/git%E5%88%86%E6%94%AF-%E5%8F%98%E5%9F%BA/:2:2","tags":["Git"],"title":"Gitåˆ†æ”¯-å˜åŸº","uri":"/posts/git%E5%88%86%E6%94%AF-%E5%8F%98%E5%9F%BA/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"çœå»å…ˆåˆ‡æ¢åˆ°æºåˆ†æ”¯çš„æ­¥éª¤ git rebase \u003cç›®æ ‡(å½“å‰)åˆ†æ”¯\u003e \u003cæºåˆ†æ”¯\u003e # å°†æºåˆ†æ”¯å˜åŸºåˆ°ç›®æ ‡åˆ†æ”¯ã€‚æ‰§è¡Œæ­¤å‘½ä»¤åä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°æºåˆ†æ”¯ git checkout \u003cç›®æ ‡åˆ†æ”¯\u003e git merge \u003cæºåˆ†æ”¯\u003e æ³¨æ„ï¼šä½¿ç”¨è¿™ä¸ªæ–¹æ³•è¦ç¡®ä¿æºåˆ†æ”¯ä¸Šçš„ä»£ç æ˜¯æœ€æ–°çš„ã€‚ æ¥ä¸‹æ¥ä½ å†³å®šå°† server åˆ†æ”¯ä¸­çš„ä¿®æ”¹ä¹Ÿæ•´åˆè¿›æ¥ã€‚ ä½¿ç”¨ git rebase \u003cbasebranch\u003e \u003ctopicbranch\u003e å‘½ä»¤å¯ä»¥ç›´æ¥å°†ä¸»é¢˜åˆ†æ”¯ ï¼ˆå³æœ¬ä¾‹ä¸­çš„ serverï¼‰å˜åŸºåˆ°ç›®æ ‡åˆ†æ”¯ï¼ˆå³ masterï¼‰ä¸Šã€‚ è¿™æ ·åšèƒ½çœå»ä½ å…ˆåˆ‡æ¢åˆ° server åˆ†æ”¯ï¼Œå†å¯¹å…¶æ‰§è¡Œå˜åŸºå‘½ä»¤çš„å¤šä¸ªæ­¥éª¤ã€‚ $ git rebase master server å¦‚å›¾ å°† server ä¸­çš„ä¿®æ”¹å˜åŸºåˆ° master ä¸Š æ‰€ç¤ºï¼Œserver ä¸­çš„ä»£ç è¢«â€œç»­â€åˆ°äº† master åé¢ã€‚ å›¾7.å°† `server` ä¸­çš„ä¿®æ”¹å˜åŸºåˆ° `master` ä¸Š â–² ç„¶åå°±å¯ä»¥å¿«è¿›åˆå¹¶ä¸»åˆ†æ”¯ master äº†ï¼š $ git checkout master $ git merge server è‡³æ­¤ï¼Œclient å’Œ server åˆ†æ”¯ä¸­çš„ä¿®æ”¹éƒ½å·²ç»æ•´åˆåˆ°ä¸»åˆ†æ”¯é‡Œäº†ï¼Œ ä½ å¯ä»¥åˆ é™¤è¿™ä¸¤ä¸ªåˆ†æ”¯ï¼Œæœ€ç»ˆæäº¤å†å²ä¼šå˜æˆå›¾ æœ€ç»ˆçš„æäº¤å†å² ä¸­çš„æ ·å­ï¼š $ git branch -d client $ git branch -d server å›¾8. æœ€ç»ˆçš„æäº¤å†å² â–² ","date":"2020-11-18","objectID":"/posts/git%E5%88%86%E6%94%AF-%E5%8F%98%E5%9F%BA/:2:3","tags":["Git"],"title":"Gitåˆ†æ”¯-å˜åŸº","uri":"/posts/git%E5%88%86%E6%94%AF-%E5%8F%98%E5%9F%BA/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"å˜åŸºçš„é£é™© ","date":"2020-11-18","objectID":"/posts/git%E5%88%86%E6%94%AF-%E5%8F%98%E5%9F%BA/:3:0","tags":["Git"],"title":"Gitåˆ†æ”¯-å˜åŸº","uri":"/posts/git%E5%88%86%E6%94%AF-%E5%8F%98%E5%9F%BA/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"é‡‘ç§‘ç‰å¾‹ å‘ƒï¼Œå¥‡å¦™çš„å˜åŸºä¹Ÿå¹¶éå®Œç¾æ— ç¼ºï¼Œè¦ç”¨å®ƒå¾—éµå®ˆä¸€æ¡å‡†åˆ™ï¼š å¦‚æœæäº¤å­˜åœ¨äºä½ çš„ä»“åº“ä¹‹å¤–ï¼Œè€Œåˆ«äººå¯èƒ½åŸºäºè¿™äº›æäº¤è¿›è¡Œå¼€å‘ï¼Œé‚£ä¹ˆä¸è¦æ‰§è¡Œå˜åŸºã€‚ å¦‚æœä½ éµå¾ªè¿™æ¡é‡‘ç§‘ç‰å¾‹ï¼Œå°±ä¸ä¼šå‡ºå·®é”™ã€‚ å¦åˆ™ï¼Œäººæ°‘ç¾¤ä¼—ä¼šä»‡æ¨ä½ ï¼Œä½ çš„æœ‹å‹å’Œå®¶äººä¹Ÿä¼šå˜²ç¬‘ä½ ï¼Œå”¾å¼ƒä½ ã€‚ ::: tip ä¾‹å¦‚ï¼šå‡ ä¸ªäººåŒæ—¶åœ¨ä¸€ä¸ªä¸»é¢˜åˆ†æ”¯ä¸Šè¿›è¡Œå¼€å‘å’Œæäº¤æ—¶ï¼Œä½ ä¸è¦ä¸­é€”æ‰§è¡Œå˜åŸºï¼Œåªæœ‰åœ¨å¤§å®¶éƒ½å®Œæˆå·¥ä½œä¹‹åæ‰å¯ä»¥æ‰§è¡Œå˜åŸºã€‚ ::: ","date":"2020-11-18","objectID":"/posts/git%E5%88%86%E6%94%AF-%E5%8F%98%E5%9F%BA/:3:1","tags":["Git"],"title":"Gitåˆ†æ”¯-å˜åŸº","uri":"/posts/git%E5%88%86%E6%94%AF-%E5%8F%98%E5%9F%BA/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"å˜åŸºçš„å®è´¨ å˜åŸºæ“ä½œçš„å®è´¨æ˜¯ä¸¢å¼ƒä¸€äº›ç°æœ‰çš„æäº¤ï¼Œç„¶åç›¸åº”åœ°æ–°å»ºä¸€äº›å†…å®¹ä¸€æ ·ä½†å®é™…ä¸Šä¸åŒçš„æäº¤ã€‚ å¦‚æœä½ å·²ç»å°†æäº¤æ¨é€è‡³æŸä¸ªä»“åº“ï¼Œè€Œå…¶ä»–äººä¹Ÿå·²ç»ä»è¯¥ä»“åº“æ‹‰å–æäº¤å¹¶è¿›è¡Œäº†åç»­å·¥ä½œï¼Œæ­¤æ—¶ï¼Œå¦‚æœä½ ç”¨ git rebase å‘½ä»¤é‡æ–°æ•´ç†äº†æäº¤å¹¶å†æ¬¡æ¨é€ï¼Œä½ çš„åŒä¼´å› æ­¤å°†ä¸å¾—ä¸å†æ¬¡å°†ä»–ä»¬æ‰‹å¤´çš„å·¥ä½œä¸ä½ çš„æäº¤è¿›è¡Œæ•´åˆï¼Œå¦‚æœæ¥ä¸‹æ¥ä½ è¿˜è¦æ‹‰å–å¹¶æ•´åˆä»–ä»¬ä¿®æ”¹è¿‡çš„æäº¤ï¼Œäº‹æƒ…å°±ä¼šå˜å¾—ä¸€å›¢ç³Ÿã€‚ è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªåœ¨å…¬å¼€çš„ä»“åº“ä¸Šæ‰§è¡Œå˜åŸºæ“ä½œæ‰€å¸¦æ¥çš„é—®é¢˜ã€‚ å‡è®¾ä½ ä»ä¸€ä¸ªä¸­å¤®æœåŠ¡å™¨å…‹éš†ç„¶ååœ¨å®ƒçš„åŸºç¡€ä¸Šè¿›è¡Œäº†ä¸€äº›å¼€å‘ã€‚ ä½ çš„æäº¤å†å²å¦‚å›¾æ‰€ç¤ºï¼š å›¾9. å…‹éš†ä¸€ä¸ªä»“åº“ï¼Œç„¶ååœ¨å®ƒçš„åŸºç¡€ä¸Šè¿›è¡Œäº†ä¸€äº›å¼€å‘ â–² ç„¶åï¼ŒæŸäººåˆå‘ä¸­å¤®æœåŠ¡å™¨æäº¤äº†ä¸€äº›ä¿®æ”¹ï¼Œå…¶ä¸­è¿˜åŒ…æ‹¬ä¸€æ¬¡åˆå¹¶ã€‚ ä½ æŠ“å–äº†è¿™äº›åœ¨è¿œç¨‹åˆ†æ”¯ä¸Šçš„ä¿®æ”¹ï¼Œå¹¶å°†å…¶åˆå¹¶åˆ°ä½ æœ¬åœ°çš„å¼€å‘åˆ†æ”¯ï¼Œç„¶åä½ çš„æäº¤å†å²å°±ä¼šå˜æˆè¿™æ ·ï¼š å›¾10. æŠ“å–åˆ«äººçš„æäº¤ï¼Œåˆå¹¶åˆ°è‡ªå·±çš„å¼€å‘åˆ†æ”¯ â–² æ¥ä¸‹æ¥ï¼Œè¿™ä¸ªäººåˆå†³å®šæŠŠåˆå¹¶æ“ä½œå›æ»šï¼Œæ”¹ç”¨å˜åŸºï¼›ç»§è€Œåˆç”¨ git push --force å‘½ä»¤è¦†ç›–äº†æœåŠ¡å™¨ä¸Šçš„æäº¤å†å²ã€‚ ä¹‹åä½ ä»æœåŠ¡å™¨æŠ“å–æ›´æ–°ï¼Œä¼šå‘ç°å¤šå‡ºæ¥ä¸€äº›æ–°çš„æäº¤ã€‚ å›¾11. æœ‰äººæ¨é€äº†ç»è¿‡å˜åŸºçš„æäº¤ï¼Œå¹¶ä¸¢å¼ƒäº†ä½ çš„æœ¬åœ°å¼€å‘æ‰€åŸºäºçš„ä¸€äº›æäº¤ â–² ç»“æœå°±æ˜¯ä½ ä»¬ä¸¤äººçš„å¤„å¢ƒéƒ½ååˆ†å°´å°¬ã€‚ å¦‚æœä½ æ‰§è¡Œ git pull å‘½ä»¤ï¼Œä½ å°†åˆå¹¶æ¥è‡ªä¸¤æ¡æäº¤å†å²çš„å†…å®¹ï¼Œç”Ÿæˆä¸€ä¸ªæ–°çš„åˆå¹¶æäº¤ï¼Œæœ€ç»ˆä»“åº“ä¼šå¦‚å›¾æ‰€ç¤ºï¼š å›¾12. ä½ å°†ç›¸åŒçš„å†…å®¹åˆåˆå¹¶äº†ä¸€æ¬¡ï¼Œç”Ÿæˆäº†ä¸€ä¸ªæ–°çš„æäº¤ â–² æ­¤æ—¶å¦‚æœä½ æ‰§è¡Œ git log å‘½ä»¤ï¼Œä½ ä¼šå‘ç°æœ‰ä¸¤ä¸ªæäº¤çš„ä½œè€…ã€æ—¥æœŸã€æ—¥å¿—å±…ç„¶æ˜¯ä¸€æ ·çš„ï¼Œè¿™ä¼šä»¤äººæ„Ÿåˆ°æ··ä¹±ã€‚ æ­¤å¤–ï¼Œå¦‚æœä½ å°†è¿™ä¸€å †åˆæ¨é€åˆ°æœåŠ¡å™¨ä¸Šï¼Œä½ å®é™…ä¸Šæ˜¯å°†é‚£äº›å·²ç»è¢«å˜åŸºæŠ›å¼ƒçš„æäº¤åˆæ‰¾äº†å›æ¥ï¼Œè¿™ä¼šä»¤äººæ„Ÿåˆ°æ›´åŠ æ··ä¹±ã€‚ å¾ˆæ˜æ˜¾å¯¹æ–¹å¹¶ä¸æƒ³åœ¨æäº¤å†å²ä¸­çœ‹åˆ° C4 å’Œ C6ï¼Œå› ä¸ºä¹‹å‰å°±æ˜¯ä»–æŠŠè¿™ä¸¤ä¸ªæäº¤é€šè¿‡å˜åŸºä¸¢å¼ƒçš„ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%88%86%E6%94%AF-%E5%8F%98%E5%9F%BA/:3:2","tags":["Git"],"title":"Gitåˆ†æ”¯-å˜åŸº","uri":"/posts/git%E5%88%86%E6%94%AF-%E5%8F%98%E5%9F%BA/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"ç”¨å˜åŸºè§£å†³å˜åŸº å¦‚æœä½  çœŸçš„ é­é‡äº†ç±»ä¼¼çš„å¤„å¢ƒï¼ŒGit è¿˜æœ‰ä¸€äº›é«˜çº§é­”æ³•å¯ä»¥å¸®åˆ°ä½ ã€‚ å¦‚æœå›¢é˜Ÿä¸­çš„æŸäººå¼ºåˆ¶æ¨é€å¹¶è¦†ç›–äº†ä¸€äº›ä½ æ‰€åŸºäºçš„æäº¤ï¼Œä½ éœ€è¦åšçš„å°±æ˜¯æ£€æŸ¥ä½ åšäº†å“ªäº›ä¿®æ”¹ï¼Œä»¥åŠä»–ä»¬è¦†ç›–äº†å“ªäº›ä¿®æ”¹ã€‚ å®é™…ä¸Šï¼ŒGit é™¤äº†å¯¹æ•´ä¸ªæäº¤è®¡ç®— SHA-1 æ ¡éªŒå’Œä»¥å¤–ï¼Œä¹Ÿå¯¹æœ¬æ¬¡æäº¤æ‰€å¼•å…¥çš„ä¿®æ”¹è®¡ç®—äº†æ ¡éªŒå’Œâ€”â€”å³ â€œpatch-idâ€ã€‚ å¦‚æœä½ æ‹‰å–è¢«è¦†ç›–è¿‡çš„æ›´æ–°å¹¶å°†ä½ æ‰‹å¤´çš„å·¥ä½œåŸºäºæ­¤è¿›è¡Œå˜åŸºçš„è¯ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ Git éƒ½èƒ½æˆåŠŸåˆ†è¾¨å‡ºå“ªäº›æ˜¯ä½ çš„ä¿®æ”¹ï¼Œå¹¶æŠŠå®ƒä»¬åº”ç”¨åˆ°æ–°åˆ†æ”¯ä¸Šã€‚ ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœé‡åˆ°å‰é¢æåˆ°çš„ æœ‰äººæ¨é€äº†ç»è¿‡å˜åŸºçš„æäº¤ï¼Œå¹¶ä¸¢å¼ƒäº†ä½ çš„æœ¬åœ°å¼€å‘æ‰€åŸºäºçš„ä¸€äº›æäº¤ é‚£ç§æƒ…å¢ƒï¼Œå¦‚æœæˆ‘ä»¬ä¸æ˜¯æ‰§è¡Œåˆå¹¶ï¼Œè€Œæ˜¯æ‰§è¡Œ git rebase teamone/master, Git å°†ä¼šï¼š æ£€æŸ¥å“ªäº›æäº¤æ˜¯æˆ‘ä»¬çš„åˆ†æ”¯ä¸Šç‹¬æœ‰çš„ï¼ˆC2ï¼ŒC3ï¼ŒC4ï¼ŒC6ï¼ŒC7ï¼‰ æ£€æŸ¥å…¶ä¸­å“ªäº›æäº¤ä¸æ˜¯åˆå¹¶æ“ä½œçš„ç»“æœï¼ˆC2ï¼ŒC3ï¼ŒC4ï¼‰ æ£€æŸ¥å“ªäº›æäº¤åœ¨å¯¹æ–¹è¦†ç›–æ›´æ–°æ—¶å¹¶æ²¡æœ‰è¢«çº³å…¥ç›®æ ‡åˆ†æ”¯ï¼ˆåªæœ‰ C2 å’Œ C3ï¼Œå› ä¸º C4 å…¶å®å°±æ˜¯ C4â€™ï¼‰ æŠŠæŸ¥åˆ°çš„è¿™äº›æäº¤åº”ç”¨åœ¨ teamone/master ä¸Šé¢ ä»è€Œæˆ‘ä»¬å°†å¾—åˆ°ä¸ ä½ å°†ç›¸åŒçš„å†…å®¹åˆåˆå¹¶äº†ä¸€æ¬¡ï¼Œç”Ÿæˆäº†ä¸€ä¸ªæ–°çš„æäº¤ ä¸­ä¸åŒçš„ç»“æœï¼Œå¦‚å›¾ åœ¨ä¸€ä¸ªè¢«å˜åŸºç„¶åå¼ºåˆ¶æ¨é€çš„åˆ†æ”¯ä¸Šå†æ¬¡æ‰§è¡Œå˜åŸº æ‰€ç¤ºã€‚ å›¾13. åœ¨ä¸€ä¸ªè¢«å˜åŸºç„¶åå¼ºåˆ¶æ¨é€çš„åˆ†æ”¯ä¸Šå†æ¬¡æ‰§è¡Œå˜åŸº â–² è¦æƒ³ä¸Šè¿°æ–¹æ¡ˆæœ‰æ•ˆï¼Œè¿˜éœ€è¦å¯¹æ–¹åœ¨å˜åŸºæ—¶ç¡®ä¿ C4' å’Œ C4 æ˜¯å‡ ä¹ä¸€æ ·çš„ã€‚ å¦åˆ™å˜åŸºæ“ä½œå°†æ— æ³•è¯†åˆ«ï¼Œå¹¶æ–°å»ºå¦ä¸€ä¸ªç±»ä¼¼ C4 çš„è¡¥ä¸ï¼ˆè€Œè¿™ä¸ªè¡¥ä¸å¾ˆå¯èƒ½æ— æ³•æ•´æ´çš„æ•´åˆå…¥å†å²ï¼Œå› ä¸ºè¡¥ä¸ä¸­çš„ä¿®æ”¹å·²ç»å­˜åœ¨äºæŸä¸ªåœ°æ–¹äº†ï¼‰ã€‚ åœ¨æœ¬ä¾‹ä¸­å¦ä¸€ç§ç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨ git pull --rebase å‘½ä»¤è€Œä¸æ˜¯ç›´æ¥ git pullã€‚ åˆæˆ–è€…ä½ å¯ä»¥è‡ªå·±æ‰‹åŠ¨å®Œæˆè¿™ä¸ªè¿‡ç¨‹ï¼Œå…ˆ git fetchï¼Œå† git rebase teamone/masterã€‚ å¦‚æœä½ ä¹ æƒ¯ä½¿ç”¨ git pull ï¼ŒåŒæ—¶åˆå¸Œæœ›é»˜è®¤ä½¿ç”¨é€‰é¡¹ --rebaseï¼Œä½ å¯ä»¥æ‰§è¡Œè¿™æ¡è¯­å¥ git config --global pull.rebase true æ¥æ›´æ”¹ pull.rebase çš„é»˜è®¤é…ç½®ã€‚ å¦‚æœä½ åªå¯¹ä¸ä¼šç¦»å¼€ä½ ç”µè„‘çš„æäº¤æ‰§è¡Œå˜åŸºï¼Œé‚£å°±ä¸ä¼šæœ‰äº‹ã€‚ å¦‚æœä½ å¯¹å·²ç»æ¨é€è¿‡çš„æäº¤æ‰§è¡Œå˜åŸºï¼Œä½†åˆ«äººæ²¡æœ‰åŸºäºå®ƒçš„æäº¤ï¼Œé‚£ä¹ˆä¹Ÿä¸ä¼šæœ‰äº‹ã€‚ å¦‚æœä½ å¯¹å·²ç»æ¨é€è‡³å…±ç”¨ä»“åº“çš„æäº¤ä¸Šæ‰§è¡Œå˜åŸºå‘½ä»¤ï¼Œå¹¶å› æ­¤ä¸¢å¤±äº†ä¸€äº›åˆ«äººçš„å¼€å‘æ‰€åŸºäºçš„æäº¤ï¼Œ é‚£ä½ å°±æœ‰å¤§éº»çƒ¦äº†ï¼Œä½ çš„åŒäº‹ä¹Ÿä¼šå› æ­¤é„™è§†ä½ ã€‚ å¦‚æœä½ æˆ–ä½ çš„åŒäº‹åœ¨æŸäº›æƒ…å½¢ä¸‹å†³æ„è¦è¿™ä¹ˆåšï¼Œè¯·ä¸€å®šè¦é€šçŸ¥æ¯ä¸ªäººæ‰§è¡Œ git pull --rebase å‘½ä»¤ï¼Œè¿™æ ·å°½ç®¡ä¸èƒ½é¿å…ä¼¤ç—›ï¼Œä½†èƒ½æœ‰æ‰€ç¼“è§£ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%88%86%E6%94%AF-%E5%8F%98%E5%9F%BA/:4:0","tags":["Git"],"title":"Gitåˆ†æ”¯-å˜åŸº","uri":"/posts/git%E5%88%86%E6%94%AF-%E5%8F%98%E5%9F%BA/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"å˜åŸº vs. åˆå¹¶ è‡³æ­¤ï¼Œä½ å·²åœ¨å®æˆ˜ä¸­å­¦ä¹ äº†å˜åŸºå’Œåˆå¹¶çš„ç”¨æ³•ï¼Œä½ ä¸€å®šä¼šæƒ³é—®ï¼Œåˆ°åº•å“ªç§æ–¹å¼æ›´å¥½ã€‚ åœ¨å›ç­”è¿™ä¸ªé—®é¢˜ä¹‹å‰ï¼Œè®©æˆ‘ä»¬é€€åä¸€æ­¥ï¼Œæƒ³è®¨è®ºä¸€ä¸‹æäº¤å†å²åˆ°åº•æ„å‘³ç€ä»€ä¹ˆã€‚ æœ‰ä¸€ç§è§‚ç‚¹è®¤ä¸ºï¼Œä»“åº“çš„æäº¤å†å²å³æ˜¯ è®°å½•å®é™…å‘ç”Ÿè¿‡ä»€ä¹ˆã€‚ å®ƒæ˜¯é’ˆå¯¹å†å²çš„æ–‡æ¡£ï¼Œæœ¬èº«å°±æœ‰ä»·å€¼ï¼Œä¸èƒ½ä¹±æ”¹ã€‚ ä»è¿™ä¸ªè§’åº¦çœ‹æ¥ï¼Œæ”¹å˜æäº¤å†å²æ˜¯ä¸€ç§äºµæ¸ï¼Œä½ ä½¿ç”¨ è°è¨€ æ©ç›–äº†å®é™…å‘ç”Ÿè¿‡çš„äº‹æƒ…ã€‚ å¦‚æœç”±åˆå¹¶äº§ç”Ÿçš„æäº¤å†å²æ˜¯ä¸€å›¢ç³Ÿæ€ä¹ˆåŠï¼Ÿ æ—¢ç„¶äº‹å®å°±æ˜¯å¦‚æ­¤ï¼Œé‚£ä¹ˆè¿™äº›ç—•è¿¹å°±åº”è¯¥è¢«ä¿ç•™ä¸‹æ¥ï¼Œè®©åäººèƒ½å¤ŸæŸ¥é˜…ã€‚ å¦ä¸€ç§è§‚ç‚¹åˆ™æ­£å¥½ç›¸åï¼Œä»–ä»¬è®¤ä¸ºæäº¤å†å²æ˜¯ é¡¹ç›®è¿‡ç¨‹ä¸­å‘ç”Ÿçš„äº‹ã€‚ æ²¡äººä¼šå‡ºç‰ˆä¸€æœ¬ä¹¦çš„ç¬¬ä¸€ç‰ˆè‰ç¨¿ï¼Œè½¯ä»¶ç»´æŠ¤æ‰‹å†Œä¹Ÿæ˜¯éœ€è¦åå¤ä¿®è®¢æ‰èƒ½æ–¹ä¾¿ä½¿ç”¨ã€‚ æŒè¿™ä¸€è§‚ç‚¹çš„äººä¼šä½¿ç”¨ rebase åŠ filter-branch ç­‰å·¥å…·æ¥ç¼–å†™æ•…äº‹ï¼Œæ€ä¹ˆæ–¹ä¾¿åæ¥çš„è¯»è€…å°±æ€ä¹ˆå†™ã€‚ ç°åœ¨ï¼Œè®©æˆ‘ä»¬å›åˆ°ä¹‹å‰çš„é—®é¢˜ä¸Šæ¥ï¼Œåˆ°åº•åˆå¹¶è¿˜æ˜¯å˜åŸºå¥½ï¼Ÿå¸Œæœ›ä½ èƒ½æ˜ç™½ï¼Œè¿™å¹¶æ²¡æœ‰ä¸€ä¸ªç®€å•çš„ç­”æ¡ˆã€‚ Git æ˜¯ä¸€ä¸ªéå¸¸å¼ºå¤§çš„å·¥å…·ï¼Œå®ƒå…è®¸ä½ å¯¹æäº¤å†å²åšè®¸å¤šäº‹æƒ…ï¼Œä½†æ¯ä¸ªå›¢é˜Ÿã€æ¯ä¸ªé¡¹ç›®å¯¹æ­¤çš„éœ€æ±‚å¹¶ä¸ç›¸åŒã€‚ æ—¢ç„¶ä½ å·²ç»åˆ†åˆ«å­¦ä¹ äº†ä¸¤è€…çš„ç”¨æ³•ï¼Œç›¸ä¿¡ä½ èƒ½å¤Ÿæ ¹æ®å®é™…æƒ…å†µä½œå‡ºæ˜æ™ºçš„é€‰æ‹©ã€‚ æ€»çš„åŸåˆ™æ˜¯ï¼Œåªå¯¹å°šæœªæ¨é€æˆ–åˆ†äº«ç»™åˆ«äººçš„æœ¬åœ°ä¿®æ”¹æ‰§è¡Œå˜åŸºæ“ä½œæ¸…ç†å†å²ï¼Œ ä»ä¸å¯¹å·²æ¨é€è‡³åˆ«å¤„çš„æäº¤æ‰§è¡Œå˜åŸºæ“ä½œï¼Œè¿™æ ·ï¼Œä½ æ‰èƒ½äº«å—åˆ°ä¸¤ç§æ–¹å¼å¸¦æ¥çš„ä¾¿åˆ©ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%88%86%E6%94%AF-%E5%8F%98%E5%9F%BA/:5:0","tags":["Git"],"title":"Gitåˆ†æ”¯-å˜åŸº","uri":"/posts/git%E5%88%86%E6%94%AF-%E5%8F%98%E5%9F%BA/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"Gitåˆ†æ”¯-åˆ†æ”¯åŸç† Git å¤„ç†åˆ†æ”¯çš„æ–¹å¼å¯è°“æ˜¯éš¾ä»¥ç½®ä¿¡çš„è½»é‡ï¼Œåˆ›å»ºæ–°åˆ†æ”¯è¿™ä¸€æ“ä½œå‡ ä¹èƒ½åœ¨ç¬é—´å®Œæˆï¼Œå¹¶ä¸”åœ¨ä¸åŒåˆ†æ”¯ä¹‹é—´çš„åˆ‡æ¢æ“ä½œä¹Ÿæ˜¯ä¸€æ ·ä¾¿æ·ã€‚ ä¸è®¸å¤šå…¶å®ƒç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿä¸åŒï¼ŒGit é¼“åŠ±åœ¨å·¥ä½œæµç¨‹ä¸­é¢‘ç¹åœ°ä½¿ç”¨åˆ†æ”¯ä¸åˆå¹¶ï¼Œå“ªæ€•ä¸€å¤©ä¹‹å†…è¿›è¡Œè®¸å¤šæ¬¡ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%88%86%E6%94%AF-%E5%88%86%E6%94%AF%E5%8E%9F%E7%90%86/:0:0","tags":["Git"],"title":"Gitåˆ†æ”¯-åˆ†æ”¯åŸç†","uri":"/posts/git%E5%88%86%E6%94%AF-%E5%88%86%E6%94%AF%E5%8E%9F%E7%90%86/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"é¦–æ¬¡æäº¤ åœ¨è¿›è¡Œæäº¤æ“ä½œæ—¶ï¼ŒGit ä¼šä¿å­˜ä¸€ä¸ªæäº¤å¯¹è±¡ï¼ˆcommit objectï¼‰ã€‚ å‡è®¾ç°åœ¨æœ‰ä¸€ä¸ªå·¥ä½œç›®å½•ï¼Œé‡Œé¢åŒ…å«äº†ä¸‰ä¸ªå°†è¦è¢«æš‚å­˜å’Œæäº¤çš„æ–‡ä»¶ã€‚ æš‚å­˜æ“ä½œä¼šä¸ºæ¯ä¸€ä¸ªæ–‡ä»¶è®¡ç®—æ ¡éªŒå’Œï¼ˆä½¿ç”¨ SHA-1 å“ˆå¸Œç®—æ³•ï¼‰ï¼Œç„¶åä¼šæŠŠå½“å‰ç‰ˆæœ¬çš„æ–‡ä»¶å¿«ç…§ä¿å­˜åˆ° Git ä»“åº“ä¸­ ï¼ˆGit ä½¿ç”¨ blob å¯¹è±¡æ¥ä¿å­˜å®ƒä»¬ï¼‰ï¼Œæœ€ç»ˆå°†æ ¡éªŒå’ŒåŠ å…¥åˆ°æš‚å­˜åŒºåŸŸç­‰å¾…æäº¤ï¼š $ git add README test.rb LICENSE $ git commit -m 'The initial commit of my project' å½“ä½¿ç”¨ git commit è¿›è¡Œæäº¤æ“ä½œæ—¶ï¼ŒGit ä¼šå…ˆè®¡ç®—æ¯ä¸€ä¸ªå­ç›®å½•ï¼ˆæœ¬ä¾‹ä¸­åªæœ‰é¡¹ç›®æ ¹ç›®å½•ï¼‰çš„æ ¡éªŒå’Œï¼Œ ç„¶ååœ¨ Git ä»“åº“ä¸­è¿™äº›æ ¡éªŒå’Œä¿å­˜ä¸ºæ ‘å¯¹è±¡ã€‚éšåï¼ŒGit ä¾¿ä¼šåˆ›å»ºä¸€ä¸ªæäº¤å¯¹è±¡ï¼Œ å®ƒé™¤äº†åŒ…å«ä¸Šé¢æåˆ°çš„é‚£äº›ä¿¡æ¯å¤–ï¼Œè¿˜åŒ…å«æŒ‡å‘è¿™ä¸ªæ ‘å¯¹è±¡ï¼ˆé¡¹ç›®æ ¹ç›®å½•ï¼‰çš„æŒ‡é’ˆã€‚ å¦‚æ­¤ä¸€æ¥ï¼ŒGit å°±å¯ä»¥åœ¨éœ€è¦çš„æ—¶å€™é‡ç°æ­¤æ¬¡ä¿å­˜çš„å¿«ç…§ã€‚ ç°åœ¨ï¼ŒGit ä»“åº“ä¸­æœ‰äº”ä¸ªå¯¹è±¡ï¼šä¸‰ä¸ª blob å¯¹è±¡ï¼ˆä¿å­˜ç€æ–‡ä»¶å¿«ç…§ï¼‰ã€ä¸€ä¸ª æ ‘å¯¹è±¡ ï¼ˆè®°å½•ç€ç›®å½•ç»“æ„å’Œ blob å¯¹è±¡ç´¢å¼•ï¼‰ä»¥åŠä¸€ä¸ª æäº¤å¯¹è±¡ï¼ˆåŒ…å«ç€æŒ‡å‘å‰è¿°æ ‘å¯¹è±¡çš„æŒ‡é’ˆå’Œæ‰€æœ‰æäº¤ä¿¡æ¯ï¼‰ã€‚ å›¾1. é¦–æ¬¡æäº¤å¯¹è±¡åŠå…¶æ ‘ç»“æ„ â–² å°ç»“ï¼š git add åŠ å…¥æš‚å­˜æ“ä½œï¼Œä¼šä¸ºæ¯ä¸ªæ–‡ä»¶åˆ›å»ºè®¡ç®—æ ¡éªŒå’Œï¼Œä»¥åŠæ¯ä¸ªæ–‡ä»¶å¯¹åº”çš„æ–‡ä»¶å¿«ç…§ï¼ˆblobå¯¹è±¡ï¼‰ã€‚ git commit æäº¤æ“ä½œï¼Œè®¡ç®—å­ç›®å½•æˆ–è·Ÿç›®å½•çš„æ ¡éªŒå’Œ ä¿å­˜ä¸ºæ ‘å¯¹è±¡ã€‚éšåï¼Œåˆ›å»ºä¸€ä¸ªæäº¤å¯¹è±¡ï¼ŒåŒ…å«ç€æŒ‡å‘æ ‘å¯¹è±¡çš„æŒ‡é’ˆå’Œæ‰€æœ‰æäº¤ä¿¡æ¯ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%88%86%E6%94%AF-%E5%88%86%E6%94%AF%E5%8E%9F%E7%90%86/:0:1","tags":["Git"],"title":"Gitåˆ†æ”¯-åˆ†æ”¯åŸç†","uri":"/posts/git%E5%88%86%E6%94%AF-%E5%88%86%E6%94%AF%E5%8E%9F%E7%90%86/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"å†æ¬¡æäº¤ åšäº›ä¿®æ”¹åå†æ¬¡æäº¤ï¼Œé‚£ä¹ˆè¿™æ¬¡äº§ç”Ÿçš„æäº¤å¯¹è±¡ä¼šåŒ…å«ä¸€ä¸ªæŒ‡å‘ä¸Šæ¬¡æäº¤å¯¹è±¡ï¼ˆçˆ¶å¯¹è±¡ï¼‰çš„æŒ‡é’ˆã€‚ å›¾2. æäº¤å¯¹è±¡åŠå…¶çˆ¶å¯¹è±¡ â–² ","date":"2020-11-18","objectID":"/posts/git%E5%88%86%E6%94%AF-%E5%88%86%E6%94%AF%E5%8E%9F%E7%90%86/:0:2","tags":["Git"],"title":"Gitåˆ†æ”¯-åˆ†æ”¯åŸç†","uri":"/posts/git%E5%88%86%E6%94%AF-%E5%88%86%E6%94%AF%E5%8E%9F%E7%90%86/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"Git çš„åˆ†æ”¯ Git çš„åˆ†æ”¯ï¼Œå…¶å®æœ¬è´¨ä¸Šä»…ä»…æ˜¯æŒ‡å‘æäº¤å¯¹è±¡çš„å¯å˜æŒ‡é’ˆã€‚ Git çš„é»˜è®¤åˆ†æ”¯åå­—æ˜¯ masterã€‚ åœ¨å¤šæ¬¡æäº¤æ“ä½œä¹‹åï¼Œä½ å…¶å®å·²ç»æœ‰ä¸€ä¸ªæŒ‡å‘æœ€åé‚£ä¸ªæäº¤å¯¹è±¡çš„ master åˆ†æ”¯ã€‚ master åˆ†æ”¯æŒ‡é’ˆä¼šåœ¨æ¯æ¬¡æäº¤æ—¶è‡ªåŠ¨å‘å‰ç§»åŠ¨ã€‚ Git çš„ master åˆ†æ”¯å¹¶ä¸æ˜¯ä¸€ä¸ªç‰¹æ®Šåˆ†æ”¯ã€‚ å®ƒå°±è·Ÿå…¶å®ƒåˆ†æ”¯å®Œå…¨æ²¡æœ‰åŒºåˆ«ã€‚ å›¾3. åˆ†æ”¯åŠå…¶æäº¤å†å² â–² ","date":"2020-11-18","objectID":"/posts/git%E5%88%86%E6%94%AF-%E5%88%86%E6%94%AF%E5%8E%9F%E7%90%86/:0:3","tags":["Git"],"title":"Gitåˆ†æ”¯-åˆ†æ”¯åŸç†","uri":"/posts/git%E5%88%86%E6%94%AF-%E5%88%86%E6%94%AF%E5%8E%9F%E7%90%86/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"åˆ›å»ºåˆ†æ”¯ Git æ˜¯æ€ä¹ˆåˆ›å»ºæ–°åˆ†æ”¯çš„å‘¢ï¼Ÿ å¾ˆç®€å•ï¼Œå®ƒåªæ˜¯ä¸ºä½ åˆ›å»ºäº†ä¸€ä¸ªå¯ä»¥ç§»åŠ¨çš„æ–°çš„æŒ‡é’ˆã€‚ æ¯”å¦‚ï¼Œåˆ›å»ºä¸€ä¸ª testing åˆ†æ”¯ï¼Œ ä½ éœ€è¦ä½¿ç”¨ git branch å‘½ä»¤ï¼š $ git branch testing è¿™ä¼šåœ¨å½“å‰æ‰€åœ¨çš„æäº¤å¯¹è±¡ä¸Šåˆ›å»ºä¸€ä¸ªæŒ‡é’ˆã€‚ å›¾4. ä¸¤ä¸ªæŒ‡å‘ç›¸åŒæäº¤å†å²çš„åˆ†æ”¯ â–² ","date":"2020-11-18","objectID":"/posts/git%E5%88%86%E6%94%AF-%E5%88%86%E6%94%AF%E5%8E%9F%E7%90%86/:0:4","tags":["Git"],"title":"Gitåˆ†æ”¯-åˆ†æ”¯åŸç†","uri":"/posts/git%E5%88%86%E6%94%AF-%E5%88%86%E6%94%AF%E5%8E%9F%E7%90%86/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"å½“å‰åˆ†æ”¯çš„æŒ‡é’ˆ Git æ˜¯æ€ä¹ˆçŸ¥é“å½“å‰åœ¨å“ªä¸€ä¸ªåˆ†æ”¯ä¸Šå‘¢ï¼Ÿ å¾ˆç®€å•ï¼Œå®ƒæœ‰ä¸€ä¸ªåä¸º HEAD çš„ç‰¹æ®ŠæŒ‡é’ˆï¼ŒæŒ‡å‘å½“å‰æ‰€åœ¨çš„æœ¬åœ°åˆ†æ”¯ï¼ˆè¯‘æ³¨ï¼šå°† HEAD æƒ³è±¡ä¸ºå½“å‰åˆ†æ”¯çš„åˆ«åï¼‰ã€‚ åœ¨æœ¬ä¾‹ä¸­ï¼Œä½ ä»ç„¶åœ¨ master åˆ†æ”¯ä¸Šã€‚ å› ä¸º git branch å‘½ä»¤ä»…ä»… åˆ›å»º ä¸€ä¸ªæ–°åˆ†æ”¯ï¼Œå¹¶ä¸ä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°æ–°åˆ†æ”¯ä¸­å»ã€‚ å›¾5. HEAD æŒ‡å‘å½“å‰æ‰€åœ¨çš„åˆ†æ”¯ â–² ","date":"2020-11-18","objectID":"/posts/git%E5%88%86%E6%94%AF-%E5%88%86%E6%94%AF%E5%8E%9F%E7%90%86/:0:5","tags":["Git"],"title":"Gitåˆ†æ”¯-åˆ†æ”¯åŸç†","uri":"/posts/git%E5%88%86%E6%94%AF-%E5%88%86%E6%94%AF%E5%8E%9F%E7%90%86/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"æŸ¥çœ‹å½“å‰æ‰€åœ¨åˆ†æ”¯ ä½ å¯ä»¥ç®€å•åœ°ä½¿ç”¨ git log å‘½ä»¤æŸ¥çœ‹å„ä¸ªåˆ†æ”¯å½“å‰æ‰€æŒ‡çš„å¯¹è±¡ã€‚ æä¾›è¿™ä¸€åŠŸèƒ½çš„å‚æ•°æ˜¯ --decorateã€‚ $ git log --oneline --decorate f30ab (HEAD -\u003e master, testing) add feature # f30abæäº¤å¯¹è±¡ (HEADå½“å‰æ‰€åœ¨åˆ†æ”¯ -\u003e masteråˆ†æ”¯ï¼Œtesting åˆ†æ”¯) 34ac2 Fixed bug # 34ac2 æäº¤å¯¹è±¡ 98ca9 The initial commit of my project # 98ca9 æäº¤å¯¹è±¡ æ­£å¦‚ä½ æ‰€è§ï¼Œå½“å‰ master å’Œ testing åˆ†æ”¯å‡æŒ‡å‘æ ¡éªŒå’Œä»¥ f30ab å¼€å¤´çš„æäº¤å¯¹è±¡ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%88%86%E6%94%AF-%E5%88%86%E6%94%AF%E5%8E%9F%E7%90%86/:0:6","tags":["Git"],"title":"Gitåˆ†æ”¯-åˆ†æ”¯åŸç†","uri":"/posts/git%E5%88%86%E6%94%AF-%E5%88%86%E6%94%AF%E5%8E%9F%E7%90%86/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"åˆ†æ”¯åˆ‡æ¢ $ git checkout testing # git checkout \u003cåˆ†æ”¯å\u003e è¿™æ · HEAD å°±æŒ‡å‘ testing åˆ†æ”¯äº†ã€‚ å›¾6. HEAD æŒ‡å‘å½“å‰æ‰€åœ¨çš„åˆ†æ”¯ â–² é‚£ä¹ˆï¼Œè¿™æ ·çš„å®ç°æ–¹å¼ä¼šç»™æˆ‘ä»¬å¸¦æ¥ä»€ä¹ˆå¥½å¤„å‘¢ï¼Ÿ ç°åœ¨ä¸å¦¨å†æäº¤ä¸€æ¬¡ï¼š $ vim test.rb $ git commit -a -m 'made a change' å›¾7. HEAD åˆ†æ”¯éšç€æäº¤æ“ä½œè‡ªåŠ¨å‘å‰ç§»åŠ¨ â–² å¦‚å›¾æ‰€ç¤ºï¼Œä½ çš„ testing åˆ†æ”¯å‘å‰ç§»åŠ¨äº†ï¼Œä½†æ˜¯ master åˆ†æ”¯å´æ²¡æœ‰ï¼Œå®ƒä»ç„¶æŒ‡å‘è¿è¡Œ git checkout æ—¶æ‰€æŒ‡çš„å¯¹è±¡ã€‚ è¿™å°±æœ‰æ„æ€äº†ï¼Œç°åœ¨æˆ‘ä»¬åˆ‡æ¢å› master åˆ†æ”¯çœ‹çœ‹ï¼š $ git checkout master å›¾8. æ£€å‡ºæ—¶ HEAD éšä¹‹ç§»åŠ¨ â–² è¿™æ¡å‘½ä»¤åšäº†ä¸¤ä»¶äº‹ã€‚ ä¸€æ˜¯ä½¿ HEAD æŒ‡å› master åˆ†æ”¯ï¼ŒäºŒæ˜¯å°†å·¥ä½œç›®å½•æ¢å¤æˆ master åˆ†æ”¯æ‰€æŒ‡å‘çš„å¿«ç…§å†…å®¹ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œä½ ç°åœ¨åšä¿®æ”¹çš„è¯ï¼Œé¡¹ç›®å°†å§‹äºä¸€ä¸ªè¾ƒæ—§çš„ç‰ˆæœ¬ã€‚ æœ¬è´¨ä¸Šæ¥è®²ï¼Œè¿™å°±æ˜¯å¿½ç•¥ testing åˆ†æ”¯æ‰€åšçš„ä¿®æ”¹ï¼Œä»¥ä¾¿äºå‘å¦ä¸€ä¸ªæ–¹å‘è¿›è¡Œå¼€å‘ã€‚ æˆ‘ä»¬ä¸å¦¨å†ç¨å¾®åšäº›ä¿®æ”¹å¹¶æäº¤ï¼š $ vim test.rb $ git commit -a -m 'made other changes' ç°åœ¨ï¼Œè¿™ä¸ªé¡¹ç›®çš„æäº¤å†å²å·²ç»äº§ç”Ÿäº†åˆ†å‰ï¼ˆå‚è§ é¡¹ç›®åˆ†å‰å†å²ï¼‰ã€‚ å› ä¸ºåˆšæ‰ä½ åˆ›å»ºäº†ä¸€ä¸ªæ–°åˆ†æ”¯ï¼Œå¹¶åˆ‡æ¢è¿‡å»è¿›è¡Œäº†ä¸€äº›å·¥ä½œï¼Œéšååˆåˆ‡æ¢å› master åˆ†æ”¯è¿›è¡Œäº†å¦å¤–ä¸€äº›å·¥ä½œã€‚ ä¸Šè¿°ä¸¤æ¬¡æ”¹åŠ¨é’ˆå¯¹çš„æ˜¯ä¸åŒåˆ†æ”¯ï¼šä½ å¯ä»¥åœ¨ä¸åŒåˆ†æ”¯é—´ä¸æ–­åœ°æ¥å›åˆ‡æ¢å’Œå·¥ä½œï¼Œå¹¶åœ¨æ—¶æœºæˆç†Ÿæ—¶å°†å®ƒä»¬åˆå¹¶èµ·æ¥ã€‚ è€Œæ‰€æœ‰è¿™äº›å·¥ä½œï¼Œä½ éœ€è¦çš„å‘½ä»¤åªæœ‰ branchã€checkout å’Œ commitã€‚ å›¾9. é¡¹ç›®åˆ†å‰å†å² â–² ä½ å¯ä»¥ç®€å•åœ°ä½¿ç”¨ git log å‘½ä»¤æŸ¥çœ‹åˆ†å‰å†å²ã€‚ è¿è¡Œ git log --oneline --decorate --graph --all ï¼Œå®ƒä¼šè¾“å‡ºä½ çš„æäº¤å†å²ã€å„ä¸ªåˆ†æ”¯çš„æŒ‡å‘ä»¥åŠé¡¹ç›®çš„åˆ†æ”¯åˆ†å‰æƒ…å†µã€‚ $ git log --oneline --decorate --graph --all * c2b9e (HEAD, master) made other changes | * 87ab2 (testing) made a change |/ * f30ab add feature * 34ac2 fixed bug * 98ca9 initial commit of my project ç”±äº Git çš„åˆ†æ”¯å®è´¨ä¸Šä»…æ˜¯åŒ…å«æ‰€æŒ‡å¯¹è±¡æ ¡éªŒå’Œï¼ˆé•¿åº¦ä¸º 40 çš„ SHA-1 å€¼å­—ç¬¦ä¸²ï¼‰çš„æ–‡ä»¶ï¼Œæ‰€ä»¥å®ƒçš„åˆ›å»ºå’Œé”€æ¯éƒ½å¼‚å¸¸é«˜æ•ˆã€‚ åˆ›å»ºä¸€ä¸ªæ–°åˆ†æ”¯å°±ç›¸å½“äºå¾€ä¸€ä¸ªæ–‡ä»¶ä¸­å†™å…¥ 41 ä¸ªå­—èŠ‚ï¼ˆ40 ä¸ªå­—ç¬¦å’Œ 1 ä¸ªæ¢è¡Œç¬¦ï¼‰ï¼Œå¦‚æ­¤çš„ç®€å•èƒ½ä¸å¿«å—ï¼Ÿ è¿™ä¸è¿‡å»å¤§å¤šæ•°ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿå½¢æˆäº†é²œæ˜çš„å¯¹æ¯”ï¼Œå®ƒä»¬åœ¨åˆ›å»ºåˆ†æ”¯æ—¶ï¼Œå°†æ‰€æœ‰çš„é¡¹ç›®æ–‡ä»¶éƒ½å¤åˆ¶ä¸€éï¼Œå¹¶ä¿å­˜åˆ°ä¸€ä¸ªç‰¹å®šçš„ç›®å½•ã€‚ å®Œæˆè¿™æ ·ç¹ççš„è¿‡ç¨‹é€šå¸¸éœ€è¦å¥½å‡ ç§’é’Ÿï¼Œæœ‰æ—¶ç”šè‡³éœ€è¦å¥½å‡ åˆ†é’Ÿã€‚æ‰€éœ€æ—¶é—´çš„é•¿çŸ­ï¼Œå®Œå…¨å–å†³äºé¡¹ç›®çš„è§„æ¨¡ã€‚ è€Œåœ¨ Git ä¸­ï¼Œä»»ä½•è§„æ¨¡çš„é¡¹ç›®éƒ½èƒ½åœ¨ç¬é—´åˆ›å»ºæ–°åˆ†æ”¯ã€‚ åŒæ—¶ï¼Œç”±äºæ¯æ¬¡æäº¤éƒ½ä¼šè®°å½•çˆ¶å¯¹è±¡ï¼Œæ‰€ä»¥å¯»æ‰¾æ°å½“çš„åˆå¹¶åŸºç¡€ï¼ˆè¯‘æ³¨ï¼šå³å…±åŒç¥–å…ˆï¼‰ä¹Ÿæ˜¯åŒæ ·çš„ç®€å•å’Œé«˜æ•ˆã€‚ è¿™äº›é«˜æ•ˆçš„ç‰¹æ€§ä½¿å¾— Git é¼“åŠ±å¼€å‘äººå‘˜é¢‘ç¹åœ°åˆ›å»ºå’Œä½¿ç”¨åˆ†æ”¯ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%88%86%E6%94%AF-%E5%88%86%E6%94%AF%E5%8E%9F%E7%90%86/:0:7","tags":["Git"],"title":"Gitåˆ†æ”¯-åˆ†æ”¯åŸç†","uri":"/posts/git%E5%88%86%E6%94%AF-%E5%88%86%E6%94%AF%E5%8E%9F%E7%90%86/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"åˆ›å»ºåˆ†æ”¯åŒæ—¶åˆ‡æ¢ é€šå¸¸æˆ‘ä»¬ä¼šåœ¨åˆ›å»ºä¸€ä¸ªæ–°åˆ†æ”¯åç«‹å³åˆ‡æ¢è¿‡å»ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š git checkout -b \u003cnewbranchname\u003e ","date":"2020-11-18","objectID":"/posts/git%E5%88%86%E6%94%AF-%E5%88%86%E6%94%AF%E5%8E%9F%E7%90%86/:0:8","tags":["Git"],"title":"Gitåˆ†æ”¯-åˆ†æ”¯åŸç†","uri":"/posts/git%E5%88%86%E6%94%AF-%E5%88%86%E6%94%AF%E5%8E%9F%E7%90%86/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"Gitåˆ†æ”¯-è¿œç¨‹åˆ†æ”¯ è¿œç¨‹å¼•ç”¨æ˜¯å¯¹è¿œç¨‹ä»“åº“çš„å¼•ç”¨ï¼ˆæŒ‡é’ˆï¼‰ï¼ŒåŒ…æ‹¬åˆ†æ”¯ã€æ ‡ç­¾ç­‰ç­‰ã€‚ è¿œç¨‹åˆ†æ”¯æœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘è¿œç¨‹åœ°å€ ","date":"2020-11-18","objectID":"/posts/git%E5%88%86%E6%94%AF-%E8%BF%9C%E7%A8%8B%E5%88%86%E6%94%AF/:0:0","tags":["Git"],"title":"Gitåˆ†æ”¯-è¿œç¨‹åˆ†æ”¯","uri":"/posts/git%E5%88%86%E6%94%AF-%E8%BF%9C%E7%A8%8B%E5%88%86%E6%94%AF/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"æŸ¥çœ‹è¿œç¨‹å¼•ç”¨åˆ—è¡¨ä¸ä¿¡æ¯ git ls-remote \u003cremote\u003e # è¿œç¨‹å¼•ç”¨çš„å®Œæ•´åˆ—è¡¨ git remote show \u003cremote\u003e # è¿œç¨‹åˆ†æ”¯çš„æ›´å¤šä¿¡æ¯ ä¸Šé¢ä¸¤è¡Œå‘½ä»¤æ¯”è¾ƒå°‘ç”¨ï¼Œæ›´å¸¸è§çš„åšæ³•æ˜¯åˆ©ç”¨è¿œç¨‹è·Ÿè¸ªåˆ†æ”¯ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%88%86%E6%94%AF-%E8%BF%9C%E7%A8%8B%E5%88%86%E6%94%AF/:0:1","tags":["Git"],"title":"Gitåˆ†æ”¯-è¿œç¨‹åˆ†æ”¯","uri":"/posts/git%E5%88%86%E6%94%AF-%E8%BF%9C%E7%A8%8B%E5%88%86%E6%94%AF/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"è¿œç¨‹è·Ÿè¸ªåˆ†æ”¯ è¿œç¨‹è·Ÿè¸ªåˆ†æ”¯æ˜¯è¿œç¨‹åˆ†æ”¯çŠ¶æ€çš„å¼•ç”¨ã€‚å®ƒä»¬æ˜¯ä½ æ— æ³•ç§»åŠ¨çš„æœ¬åœ°å¼•ç”¨ã€‚ä¸€æ—¦ä½ è¿›è¡Œäº†ç½‘ç»œé€šä¿¡ï¼Œ Git å°±ä¼šä¸ºä½ ç§»åŠ¨å®ƒä»¬ä»¥ç²¾ç¡®åæ˜ è¿œç¨‹ä»“åº“çš„çŠ¶æ€ã€‚è¯·å°†å®ƒä»¬çœ‹åšä¹¦ç­¾ï¼Œ è¿™æ ·å¯ä»¥æé†’ä½ è¯¥åˆ†æ”¯åœ¨è¿œç¨‹ä»“åº“ä¸­çš„ä½ç½®å°±æ˜¯ä½ æœ€åä¸€æ¬¡è¿æ¥åˆ°å®ƒä»¬çš„ä½ç½®ã€‚ å®ƒä»¬ä»¥ \u003cremote\u003e/\u003cbranch\u003e çš„å½¢å¼å‘½åã€‚ ä¾‹å¦‚ï¼Œå¦‚æœä½ æƒ³è¦æŸ¥çœ‹æœ€åä¸€æ¬¡ä¸è¿œç¨‹ä»“åº“ origin é€šä¿¡æ—¶ master åˆ†æ”¯çš„çŠ¶æ€ï¼Œä½ å¯ä»¥æŸ¥çœ‹ origin/master åˆ†æ”¯ã€‚ ä½ ä¸åŒäº‹åˆä½œè§£å†³ä¸€ä¸ªé—®é¢˜å¹¶ä¸”ä»–ä»¬æ¨é€äº†ä¸€ä¸ª iss53 åˆ†æ”¯ï¼Œä½ å¯èƒ½æœ‰è‡ªå·±çš„æœ¬åœ° iss53 åˆ†æ”¯ï¼Œ ç„¶è€Œåœ¨æœåŠ¡å™¨ä¸Šçš„åˆ†æ”¯ä¼šä»¥ origin/iss53 æ¥è¡¨ç¤ºã€‚ è¿™å¯èƒ½æœ‰ä¸€ç‚¹å„¿éš¾ä»¥ç†è§£ï¼Œè®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ã€‚ å‡è®¾ä½ çš„ç½‘ç»œé‡Œæœ‰ä¸€ä¸ªåœ¨ git.ourcompany.com çš„ Git æœåŠ¡å™¨ã€‚ å¦‚æœä½ ä»è¿™é‡Œå…‹éš†ï¼ŒGit çš„ clone å‘½ä»¤ä¼šä¸ºä½ è‡ªåŠ¨å°†å…¶å‘½åä¸º originï¼Œæ‹‰å–å®ƒçš„æ‰€æœ‰æ•°æ®ï¼Œ åˆ›å»ºä¸€ä¸ªæŒ‡å‘å®ƒçš„ master åˆ†æ”¯çš„æŒ‡é’ˆï¼Œå¹¶ä¸”åœ¨æœ¬åœ°å°†å…¶å‘½åä¸º origin/masterã€‚ Git ä¹Ÿä¼šç»™ä½ ä¸€ä¸ªä¸ origin çš„ master åˆ†æ”¯åœ¨æŒ‡å‘åŒä¸€ä¸ªåœ°æ–¹çš„æœ¬åœ° master åˆ†æ”¯ï¼Œè¿™æ ·ä½ å°±æœ‰å·¥ä½œçš„åŸºç¡€ã€‚ ç¬”è®°ï¼šä»è¿œç¨‹å…‹éš†ä¸‹æ¥çš„ä»“åº“æœ‰ä¸€ä¸ªå«origin/masterçš„è¿œç¨‹è·Ÿè¸ªåˆ†æ”¯ å’Œ ä¸€ä¸ªæœ¬åœ°çš„masteråˆ†æ”¯ ç¬”è®°ï¼šâ€œoriginâ€ å¹¶æ— ç‰¹æ®Šå«ä¹‰è¿œç¨‹ä»“åº“åå­— â€œoriginâ€ ä¸åˆ†æ”¯åå­— â€œmasterâ€ ä¸€æ ·ï¼Œåœ¨ Git ä¸­å¹¶æ²¡æœ‰ä»»ä½•ç‰¹åˆ«çš„å«ä¹‰ä¸€æ ·ã€‚ åŒæ—¶ â€œmasterâ€ æ˜¯å½“ä½ è¿è¡Œ git init æ—¶é»˜è®¤çš„èµ·å§‹åˆ†æ”¯åå­—ï¼ŒåŸå› ä»…ä»…æ˜¯å®ƒçš„å¹¿æ³›ä½¿ç”¨ï¼Œ â€œoriginâ€ æ˜¯å½“ä½ è¿è¡Œ git clone æ—¶é»˜è®¤çš„è¿œç¨‹ä»“åº“åå­—ã€‚ å¦‚æœä½ è¿è¡Œ git clone -o booyahï¼Œé‚£ä¹ˆä½ é»˜è®¤çš„è¿œç¨‹åˆ†æ”¯åå­—å°†ä¼šæ˜¯ booyah/masterã€‚ å›¾1. å…‹éš†ä¹‹åçš„æœåŠ¡å™¨ä¸æœ¬åœ°ä»“åº“ â–² å¦‚æœä½ åœ¨æœ¬åœ°çš„ master åˆ†æ”¯åšäº†ä¸€äº›å·¥ä½œï¼Œåœ¨åŒä¸€æ®µæ—¶é—´å†…æœ‰å…¶ä»–äººæ¨é€æäº¤åˆ° git.ourcompany.com å¹¶ä¸”æ›´æ–°äº†å®ƒçš„ master åˆ†æ”¯ï¼Œè¿™å°±æ˜¯è¯´ä½ ä»¬çš„æäº¤å†å²å·²èµ°å‘ä¸åŒçš„æ–¹å‘ã€‚ å³ä¾¿è¿™æ ·ï¼Œåªè¦ä½ ä¿æŒä¸ä¸ origin æœåŠ¡å™¨è¿æ¥ï¼ˆå¹¶æ‹‰å–æ•°æ®ï¼‰ï¼Œä½ çš„ origin/master æŒ‡é’ˆå°±ä¸ä¼šç§»åŠ¨ã€‚ å›¾2. æœ¬åœ°ä¸è¿œç¨‹çš„å·¥ä½œå¯ä»¥åˆ†å‰ â–² å¦‚æœè¦ä¸ç»™å®šçš„è¿œç¨‹ä»“åº“åŒæ­¥æ•°æ®ï¼Œè¿è¡Œ git fetch \u003cremote\u003e å‘½ä»¤ï¼ˆåœ¨æœ¬ä¾‹ä¸­ä¸º git fetch originï¼‰ã€‚ è¿™ä¸ªå‘½ä»¤æŸ¥æ‰¾ â€œoriginâ€ æ˜¯å“ªä¸€ä¸ªæœåŠ¡å™¨ï¼ˆåœ¨æœ¬ä¾‹ä¸­ï¼Œå®ƒæ˜¯ git.ourcompany.comï¼‰ï¼Œ ä»ä¸­æŠ“å–æœ¬åœ°æ²¡æœ‰çš„æ•°æ®ï¼Œå¹¶ä¸”æ›´æ–°æœ¬åœ°æ•°æ®åº“ï¼Œç§»åŠ¨ origin/master æŒ‡é’ˆåˆ°æ›´æ–°ä¹‹åçš„ä½ç½®ã€‚ å›¾3. git fetch æ›´æ–°ä½ çš„è¿œç¨‹è·Ÿè¸ªåˆ†æ”¯ â–² ç¬”è®°: æœ¬åœ°çš„ master åˆ†æ”¯ å¯èƒ½ å’Œ è¿œç¨‹è·Ÿè¸ªåˆ†æ”¯ origin/master åˆ†å‰ ä¸ºäº†æ¼”ç¤ºæœ‰å¤šä¸ªè¿œç¨‹ä»“åº“ä¸è¿œç¨‹åˆ†æ”¯çš„æƒ…å†µï¼Œæˆ‘ä»¬å‡å®šä½ æœ‰å¦ä¸€ä¸ªå†…éƒ¨ Git æœåŠ¡å™¨ï¼Œä»…æœåŠ¡äºä½ çš„æŸä¸ªæ•æ·å¼€å‘å›¢é˜Ÿã€‚ è¿™ä¸ªæœåŠ¡å™¨ä½äº git.team1.ourcompany.comã€‚ ä½ å¯ä»¥è¿è¡Œ git remote add å‘½ä»¤æ·»åŠ ä¸€ä¸ªæ–°çš„è¿œç¨‹ä»“åº“å¼•ç”¨åˆ°å½“å‰çš„é¡¹ç›®ï¼Œè¿™ä¸ªå‘½ä»¤æˆ‘ä»¬ä¼šåœ¨ Git åŸºç¡€ ä¸­è¯¦ç»†è¯´æ˜ã€‚ å°†è¿™ä¸ªè¿œç¨‹ä»“åº“å‘½åä¸º teamoneï¼Œå°†å…¶ä½œä¸ºå®Œæ•´ URL çš„ç¼©å†™ã€‚è¿œç¨‹ä»“åº“åæœ¬è´¨ä¸Šæ˜¯è¿œç¨‹URLçš„ç¼©å†™ å›¾4. æ·»åŠ å¦ä¸€ä¸ªè¿œç¨‹ä»“åº“ â–² ç°åœ¨ï¼Œå¯ä»¥è¿è¡Œ git fetch teamone æ¥æŠ“å–è¿œç¨‹ä»“åº“ teamone æœ‰è€Œæœ¬åœ°æ²¡æœ‰çš„æ•°æ®ã€‚ å› ä¸ºé‚£å°æœåŠ¡å™¨ä¸Šç°æœ‰çš„æ•°æ®æ˜¯ origin æœåŠ¡å™¨ä¸Šçš„ä¸€ä¸ªå­é›†ï¼Œ æ‰€ä»¥ Git å¹¶ä¸ä¼šæŠ“å–æ•°æ®è€Œæ˜¯ä¼šè®¾ç½®è¿œç¨‹è·Ÿè¸ªåˆ†æ”¯ teamone/master æŒ‡å‘ teamone çš„ master åˆ†æ”¯ã€‚ å›¾5. è¿œç¨‹è·Ÿè¸ªåˆ†æ”¯ teamone/master â–² ","date":"2020-11-18","objectID":"/posts/git%E5%88%86%E6%94%AF-%E8%BF%9C%E7%A8%8B%E5%88%86%E6%94%AF/:0:2","tags":["Git"],"title":"Gitåˆ†æ”¯-è¿œç¨‹åˆ†æ”¯","uri":"/posts/git%E5%88%86%E6%94%AF-%E8%BF%9C%E7%A8%8B%E5%88%86%E6%94%AF/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"æ¨é€ å½“ä½ æƒ³è¦å…¬å¼€åˆ†äº«ä¸€ä¸ªåˆ†æ”¯æ—¶ï¼Œéœ€è¦å°†å…¶æ¨é€åˆ°æœ‰å†™å…¥æƒé™çš„è¿œç¨‹ä»“åº“ä¸Šã€‚ æœ¬åœ°çš„åˆ†æ”¯å¹¶ä¸ä¼šè‡ªåŠ¨ä¸è¿œç¨‹ä»“åº“åŒæ­¥â€”â€”ä½ å¿…é¡»æ˜¾å¼åœ°æ¨é€æƒ³è¦åˆ†äº«çš„åˆ†æ”¯ã€‚ è¿™æ ·ï¼Œä½ å°±å¯ä»¥æŠŠä¸æ„¿æ„åˆ†äº«çš„å†…å®¹æ”¾åˆ°ç§äººåˆ†æ”¯ä¸Šï¼Œè€Œå°†éœ€è¦å’Œåˆ«äººåä½œçš„å†…å®¹æ¨é€åˆ°å…¬å¼€åˆ†æ”¯ã€‚ å¦‚æœå¸Œæœ›å’Œåˆ«äººä¸€èµ·åœ¨åä¸º serverfix çš„åˆ†æ”¯ä¸Šå·¥ä½œï¼Œä½ å¯ä»¥åƒæ¨é€ç¬¬ä¸€ä¸ªåˆ†æ”¯é‚£æ ·æ¨é€å®ƒã€‚ è¿è¡Œ git push \u003cremote\u003e \u003cbranch\u003e: $ git push origin serverfix Counting objects: 24, done. Delta compression using up to 8 threads. Compressing objects: 100% (15/15), done. Writing objects: 100% (24/24), 1.91 KiB | 0 bytes/s, done. Total 24 (delta 2), reused 0 (delta 0) To https://github.com/schacon/simplegit * [new branch] serverfix -\u003e serverfix è¿™é‡Œæœ‰äº›å·¥ä½œè¢«ç®€åŒ–äº†ã€‚ Git è‡ªåŠ¨å°† serverfix åˆ†æ”¯åå­—å±•å¼€ä¸º refs/heads/serverfix:refs/heads/serverfixï¼Œ é‚£æ„å‘³ç€ï¼Œâ€œæ¨é€æœ¬åœ°çš„ serverfix åˆ†æ”¯æ¥æ›´æ–°è¿œç¨‹ä»“åº“ä¸Šçš„ serverfix åˆ†æ”¯ã€‚â€ æˆ‘ä»¬å°†ä¼šè¯¦ç»†å­¦ä¹  Git å†…éƒ¨åŸç† çš„ refs/heads/ éƒ¨åˆ†ï¼Œ ä½†æ˜¯ç°åœ¨å¯ä»¥å…ˆæŠŠå®ƒæ”¾åœ¨å„¿ã€‚ä½ ä¹Ÿå¯ä»¥è¿è¡Œ git push origin serverfix:serverfixï¼Œ å®ƒä¼šåšåŒæ ·çš„äº‹â€”â€”ä¹Ÿå°±æ˜¯è¯´â€œæ¨é€æœ¬åœ°çš„ serverfix åˆ†æ”¯ï¼Œå°†å…¶ä½œä¸ºè¿œç¨‹ä»“åº“çš„ serverfix åˆ†æ”¯â€ å¯ä»¥é€šè¿‡è¿™ç§æ ¼å¼æ¥æ¨é€æœ¬åœ°åˆ†æ”¯åˆ°ä¸€ä¸ªå‘½åä¸ç›¸åŒçš„è¿œç¨‹åˆ†æ”¯ã€‚ é‡å‘½åè¿œç¨‹ä»“åº“ä¸Šçš„åˆ†æ”¯å å¦‚æœå¹¶ä¸æƒ³è®©è¿œç¨‹ä»“åº“ä¸Šçš„åˆ†æ”¯å«åš serverfixï¼Œå¯ä»¥è¿è¡Œ git push origin serverfix:awesomebranch æ¥å°†æœ¬åœ°çš„ serverfix åˆ†æ”¯æ¨é€åˆ°è¿œç¨‹ä»“åº“ä¸Šçš„ awesomebranch åˆ†æ”¯ã€‚ Note å¦‚ä½•é¿å…æ¯æ¬¡è¾“å…¥å¯†ç å¦‚æœä½ æ­£åœ¨ä½¿ç”¨ HTTPS URL æ¥æ¨é€ï¼ŒGit æœåŠ¡å™¨ä¼šè¯¢é—®ç”¨æˆ·åä¸å¯†ç ã€‚ é»˜è®¤æƒ…å†µä¸‹å®ƒä¼šåœ¨ç»ˆç«¯ä¸­æç¤ºæœåŠ¡å™¨æ˜¯å¦å…è®¸ä½ è¿›è¡Œæ¨é€ã€‚å¦‚æœä¸æƒ³åœ¨æ¯ä¸€æ¬¡æ¨é€æ—¶éƒ½è¾“å…¥ç”¨æˆ·åä¸å¯†ç ï¼Œä½ å¯ä»¥è®¾ç½®ä¸€ä¸ª â€œcredential cacheâ€ã€‚ æœ€ç®€å•çš„æ–¹å¼å°±æ˜¯å°†å…¶ä¿å­˜åœ¨å†…å­˜ä¸­å‡ åˆ†é’Ÿï¼Œå¯ä»¥ç®€å•åœ°è¿è¡Œ git config --global credential.helper cache æ¥è®¾ç½®å®ƒã€‚æƒ³è¦äº†è§£æ›´å¤šå…³äºä¸åŒéªŒè¯ç¼“å­˜çš„å¯ç”¨é€‰é¡¹ï¼ŒæŸ¥çœ‹ å‡­è¯å­˜å‚¨ã€‚ ä¸‹ä¸€æ¬¡å…¶ä»–åä½œè€…ä»æœåŠ¡å™¨ä¸ŠæŠ“å–æ•°æ®æ—¶ï¼Œä»–ä»¬ä¼šåœ¨æœ¬åœ°ç”Ÿæˆä¸€ä¸ªè¿œç¨‹åˆ†æ”¯ origin/serverfixï¼ŒæŒ‡å‘æœåŠ¡å™¨çš„ serverfix åˆ†æ”¯çš„å¼•ç”¨ï¼š $ git fetch origin remote: Counting objects: 7, done. remote: Compressing objects: 100% (2/2), done. remote: Total 3 (delta 0), reused 3 (delta 0) Unpacking objects: 100% (3/3), done. From https://github.com/schacon/simplegit * [new branch] serverfix -\u003e origin/serverfix è¦ç‰¹åˆ«æ³¨æ„çš„ä¸€ç‚¹æ˜¯å½“æŠ“å–åˆ°æ–°çš„è¿œç¨‹è·Ÿè¸ªåˆ†æ”¯æ—¶ï¼Œæœ¬åœ°ä¸ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä»½å¯ç¼–è¾‘çš„å‰¯æœ¬ï¼ˆæ‹·è´ï¼‰ã€‚ æ¢ä¸€å¥è¯è¯´ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œä¸ä¼šæœ‰ä¸€ä¸ªæ–°çš„ serverfix åˆ†æ”¯â€”â€”åªæœ‰ä¸€ä¸ªä¸å¯ä»¥ä¿®æ”¹çš„ origin/serverfix æŒ‡é’ˆã€‚ å¯ä»¥è¿è¡Œ git merge origin/serverfix å°†è¿™äº›å·¥ä½œåˆå¹¶åˆ°å½“å‰æ‰€åœ¨çš„åˆ†æ”¯ã€‚ å¦‚æœæƒ³è¦åœ¨è‡ªå·±çš„ serverfix åˆ†æ”¯ä¸Šå·¥ä½œï¼Œå¯ä»¥å°†å…¶å»ºç«‹åœ¨è¿œç¨‹è·Ÿè¸ªåˆ†æ”¯ä¹‹ä¸Šï¼š $ git checkout -b serverfix origin/serverfix Branch serverfix set up to track remote branch serverfix from origin. Switched to a new branch 'serverfix' è¿™ä¼šç»™ä½ ä¸€ä¸ªç”¨äºå·¥ä½œçš„æœ¬åœ°åˆ†æ”¯ï¼Œå¹¶ä¸”èµ·ç‚¹ä½äº origin/serverfixã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%88%86%E6%94%AF-%E8%BF%9C%E7%A8%8B%E5%88%86%E6%94%AF/:0:3","tags":["Git"],"title":"Gitåˆ†æ”¯-è¿œç¨‹åˆ†æ”¯","uri":"/posts/git%E5%88%86%E6%94%AF-%E8%BF%9C%E7%A8%8B%E5%88%86%E6%94%AF/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"è·Ÿè¸ªåˆ†æ”¯ ä»ä¸€ä¸ªè¿œç¨‹è·Ÿè¸ªåˆ†æ”¯æ£€å‡ºä¸€ä¸ªæœ¬åœ°åˆ†æ”¯ä¼šè‡ªåŠ¨åˆ›å»ºæ‰€è°“çš„â€œè·Ÿè¸ªåˆ†æ”¯â€ï¼ˆå®ƒè·Ÿè¸ªçš„åˆ†æ”¯å«åšâ€œä¸Šæ¸¸åˆ†æ”¯â€ï¼‰ã€‚ è·Ÿè¸ªåˆ†æ”¯æ˜¯ä¸è¿œç¨‹åˆ†æ”¯æœ‰ç›´æ¥å…³ç³»çš„æœ¬åœ°åˆ†æ”¯ã€‚ å¦‚æœåœ¨ä¸€ä¸ªè·Ÿè¸ªåˆ†æ”¯ä¸Šè¾“å…¥ git pullï¼ŒGit èƒ½è‡ªåŠ¨åœ°è¯†åˆ«å»å“ªä¸ªæœåŠ¡å™¨ä¸ŠæŠ“å–ã€åˆå¹¶åˆ°å“ªä¸ªåˆ†æ”¯ã€‚ å½“å…‹éš†ä¸€ä¸ªä»“åº“æ—¶ï¼Œå®ƒé€šå¸¸ä¼šè‡ªåŠ¨åœ°åˆ›å»ºä¸€ä¸ªè·Ÿè¸ª origin/master çš„ master åˆ†æ”¯ã€‚ ç„¶è€Œï¼Œå¦‚æœä½ æ„¿æ„çš„è¯å¯ä»¥è®¾ç½®å…¶ä»–çš„è·Ÿè¸ªåˆ†æ”¯ï¼Œæˆ–æ˜¯ä¸€ä¸ªåœ¨å…¶ä»–è¿œç¨‹ä»“åº“ä¸Šçš„è·Ÿè¸ªåˆ†æ”¯ï¼Œåˆæˆ–è€…ä¸è·Ÿè¸ª master åˆ†æ”¯ã€‚ æœ€ç®€å•çš„å®ä¾‹å°±æ˜¯åƒä¹‹å‰çœ‹åˆ°çš„é‚£æ ·ï¼Œè¿è¡Œ git checkout -b \u003cbranch\u003e \u003cremote\u003e/\u003cbranch\u003eã€‚ è¿™æ˜¯ä¸€ä¸ªååˆ†å¸¸ç”¨çš„æ“ä½œæ‰€ä»¥ Git æä¾›äº† --track å¿«æ·æ–¹å¼ï¼š $ git checkout --track origin/serverfix Branch serverfix set up to track remote branch serverfix from origin. Switched to a new branch 'serverfix' ç”±äºè¿™ä¸ªæ“ä½œå¤ªå¸¸ç”¨äº†ï¼Œè¯¥æ·å¾„æœ¬èº«è¿˜æœ‰ä¸€ä¸ªæ·å¾„ã€‚ å¦‚æœä½ å°è¯•æ£€å‡ºçš„åˆ†æ”¯ (a) ä¸å­˜åœ¨ä¸” (b) åˆšå¥½åªæœ‰ä¸€ä¸ªåå­—ä¸ä¹‹åŒ¹é…çš„è¿œç¨‹åˆ†æ”¯ï¼Œé‚£ä¹ˆ Git å°±ä¼šä¸ºä½ åˆ›å»ºä¸€ä¸ªè·Ÿè¸ªåˆ†æ”¯ï¼š $ git checkout serverfix Branch serverfix set up to track remote branch serverfix from origin. Switched to a new branch 'serverfix' å¦‚æœæƒ³è¦å°†æœ¬åœ°åˆ†æ”¯ä¸è¿œç¨‹åˆ†æ”¯è®¾ç½®ä¸ºä¸åŒçš„åå­—ï¼Œä½ å¯ä»¥è½»æ¾åœ°ä½¿ç”¨ä¸Šä¸€ä¸ªå‘½ä»¤å¢åŠ ä¸€ä¸ªä¸åŒåå­—çš„æœ¬åœ°åˆ†æ”¯ï¼š $ git checkout -b sf origin/serverfix Branch sf set up to track remote branch serverfix from origin. Switched to a new branch 'sf' ç°åœ¨ï¼Œæœ¬åœ°åˆ†æ”¯ sf ä¼šè‡ªåŠ¨ä» origin/serverfix æ‹‰å–ã€‚ è®¾ç½®å·²æœ‰çš„æœ¬åœ°åˆ†æ”¯è·Ÿè¸ªä¸€ä¸ªåˆšåˆšæ‹‰å–ä¸‹æ¥çš„è¿œç¨‹åˆ†æ”¯ï¼Œæˆ–è€…æƒ³è¦ä¿®æ”¹æ­£åœ¨è·Ÿè¸ªçš„ä¸Šæ¸¸åˆ†æ”¯ï¼Œ ä½ å¯ä»¥åœ¨ä»»æ„æ—¶é—´ä½¿ç”¨ -u æˆ– --set-upstream-to é€‰é¡¹è¿è¡Œ git branch æ¥æ˜¾å¼åœ°è®¾ç½®ã€‚ $ git branch -u origin/serverfix Branch serverfix set up to track remote branch serverfix from origin. Note ä¸Šæ¸¸å¿«æ·æ–¹å¼å½“è®¾ç½®å¥½è·Ÿè¸ªåˆ†æ”¯åï¼Œå¯ä»¥é€šè¿‡ç®€å†™ @{upstream} æˆ– @{u} æ¥å¼•ç”¨å®ƒçš„ä¸Šæ¸¸åˆ†æ”¯ã€‚ æ‰€ä»¥åœ¨ master åˆ†æ”¯æ—¶å¹¶ä¸”å®ƒæ­£åœ¨è·Ÿè¸ª origin/master æ—¶ï¼Œå¦‚æœæ„¿æ„çš„è¯å¯ä»¥ä½¿ç”¨ git merge @{u} æ¥å–ä»£ git merge origin/masterã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%88%86%E6%94%AF-%E8%BF%9C%E7%A8%8B%E5%88%86%E6%94%AF/:0:4","tags":["Git"],"title":"Gitåˆ†æ”¯-è¿œç¨‹åˆ†æ”¯","uri":"/posts/git%E5%88%86%E6%94%AF-%E8%BF%9C%E7%A8%8B%E5%88%86%E6%94%AF/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"æŸ¥çœ‹è·Ÿè¸ªåˆ†æ”¯ å¦‚æœæƒ³è¦æŸ¥çœ‹è®¾ç½®çš„æ‰€æœ‰è·Ÿè¸ªåˆ†æ”¯ï¼Œå¯ä»¥ä½¿ç”¨ git branch çš„ -vv é€‰é¡¹ã€‚ è¿™ä¼šå°†æ‰€æœ‰çš„æœ¬åœ°åˆ†æ”¯åˆ—å‡ºæ¥å¹¶ä¸”åŒ…å«æ›´å¤šçš„ä¿¡æ¯ï¼Œå¦‚æ¯ä¸€ä¸ªåˆ†æ”¯æ­£åœ¨è·Ÿè¸ªå“ªä¸ªè¿œç¨‹åˆ†æ”¯ä¸æœ¬åœ°åˆ†æ”¯æ˜¯å¦æ˜¯é¢†å…ˆã€è½åæˆ–æ˜¯éƒ½æœ‰ã€‚ $ git branch -vv iss53 7e424c3 [origin/iss53: ahead 2] forgot the brackets master 1ae2a45 [origin/master] deploying index fix * serverfix f8674d9 [teamone/server-fix-good: ahead 3, behind 1] this should do it testing 5ea463a trying something new è¿™é‡Œå¯ä»¥çœ‹åˆ° iss53 åˆ†æ”¯æ­£åœ¨è·Ÿè¸ª origin/iss53 å¹¶ä¸” â€œaheadâ€ æ˜¯ 2ï¼Œæ„å‘³ç€æœ¬åœ°æœ‰ä¸¤ä¸ªæäº¤è¿˜æ²¡æœ‰æ¨é€åˆ°æœåŠ¡å™¨ä¸Šã€‚ ä¹Ÿèƒ½çœ‹åˆ° master åˆ†æ”¯æ­£åœ¨è·Ÿè¸ª origin/master åˆ†æ”¯å¹¶ä¸”æ˜¯æœ€æ–°çš„ã€‚ æ¥ä¸‹æ¥å¯ä»¥çœ‹åˆ° serverfix åˆ†æ”¯æ­£åœ¨è·Ÿè¸ª teamone æœåŠ¡å™¨ä¸Šçš„ server-fix-good åˆ†æ”¯å¹¶ä¸”é¢†å…ˆ 3 è½å 1ï¼Œ æ„å‘³ç€æœåŠ¡å™¨ä¸Šæœ‰ä¸€æ¬¡æäº¤è¿˜æ²¡æœ‰åˆå¹¶å…¥åŒæ—¶æœ¬åœ°æœ‰ä¸‰æ¬¡æäº¤è¿˜æ²¡æœ‰æ¨é€ã€‚ æœ€åçœ‹åˆ° testing åˆ†æ”¯å¹¶æ²¡æœ‰è·Ÿè¸ªä»»ä½•è¿œç¨‹åˆ†æ”¯ã€‚ éœ€è¦é‡ç‚¹æ³¨æ„çš„ä¸€ç‚¹æ˜¯è¿™äº›æ•°å­—çš„å€¼æ¥è‡ªäºä½ ä»æ¯ä¸ªæœåŠ¡å™¨ä¸Šæœ€åä¸€æ¬¡æŠ“å–çš„æ•°æ®ã€‚ è¿™ä¸ªå‘½ä»¤å¹¶æ²¡æœ‰è¿æ¥æœåŠ¡å™¨ï¼Œå®ƒåªä¼šå‘Šè¯‰ä½ å…³äºæœ¬åœ°ç¼“å­˜çš„æœåŠ¡å™¨æ•°æ®ã€‚ å¦‚æœæƒ³è¦ç»Ÿè®¡æœ€æ–°çš„é¢†å…ˆä¸è½åæ•°å­—ï¼Œéœ€è¦åœ¨è¿è¡Œæ­¤å‘½ä»¤å‰æŠ“å–æ‰€æœ‰çš„è¿œç¨‹ä»“åº“ã€‚ å¯ä»¥åƒè¿™æ ·åšï¼š $ git fetch --all; git branch -vv ","date":"2020-11-18","objectID":"/posts/git%E5%88%86%E6%94%AF-%E8%BF%9C%E7%A8%8B%E5%88%86%E6%94%AF/:0:5","tags":["Git"],"title":"Gitåˆ†æ”¯-è¿œç¨‹åˆ†æ”¯","uri":"/posts/git%E5%88%86%E6%94%AF-%E8%BF%9C%E7%A8%8B%E5%88%86%E6%94%AF/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"æ‹‰å– å½“ git fetch å‘½ä»¤ä»æœåŠ¡å™¨ä¸ŠæŠ“å–æœ¬åœ°æ²¡æœ‰çš„æ•°æ®æ—¶ï¼Œå®ƒå¹¶ä¸ä¼šä¿®æ”¹å·¥ä½œç›®å½•ä¸­çš„å†…å®¹ã€‚ å®ƒåªä¼šè·å–æ•°æ®ç„¶åè®©ä½ è‡ªå·±åˆå¹¶ã€‚ ç„¶è€Œï¼Œæœ‰ä¸€ä¸ªå‘½ä»¤å«ä½œ git pull åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹å®ƒçš„å«ä¹‰æ˜¯ä¸€ä¸ª git fetch ç´§æ¥ç€ä¸€ä¸ª git merge å‘½ä»¤ã€‚ å¦‚æœæœ‰ä¸€ä¸ªåƒä¹‹å‰ç« èŠ‚ä¸­æ¼”ç¤ºçš„è®¾ç½®å¥½çš„è·Ÿè¸ªåˆ†æ”¯ï¼Œä¸ç®¡å®ƒæ˜¯æ˜¾å¼åœ°è®¾ç½®è¿˜æ˜¯é€šè¿‡ clone æˆ– checkout å‘½ä»¤ä¸ºä½ åˆ›å»ºçš„ï¼Œgit pull éƒ½ä¼šæŸ¥æ‰¾å½“å‰åˆ†æ”¯æ‰€è·Ÿè¸ªçš„æœåŠ¡å™¨ä¸åˆ†æ”¯ï¼Œ ä»æœåŠ¡å™¨ä¸ŠæŠ“å–æ•°æ®ç„¶åå°è¯•åˆå¹¶å…¥é‚£ä¸ªè¿œç¨‹åˆ†æ”¯ã€‚ ç”±äº git pull çš„é­”æ³•ç»å¸¸ä»¤äººå›°æƒ‘æ‰€ä»¥é€šå¸¸å•ç‹¬æ˜¾å¼åœ°ä½¿ç”¨ fetch ä¸ merge å‘½ä»¤ä¼šæ›´å¥½ä¸€äº›ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%88%86%E6%94%AF-%E8%BF%9C%E7%A8%8B%E5%88%86%E6%94%AF/:0:6","tags":["Git"],"title":"Gitåˆ†æ”¯-è¿œç¨‹åˆ†æ”¯","uri":"/posts/git%E5%88%86%E6%94%AF-%E8%BF%9C%E7%A8%8B%E5%88%86%E6%94%AF/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"åˆ é™¤è¿œç¨‹åˆ†æ”¯ å‡è®¾ä½ å·²ç»é€šè¿‡è¿œç¨‹åˆ†æ”¯åšå®Œæ‰€æœ‰çš„å·¥ä½œäº†â€”â€”ä¹Ÿå°±æ˜¯è¯´ä½ å’Œä½ çš„åä½œè€…å·²ç»å®Œæˆäº†ä¸€ä¸ªç‰¹æ€§ï¼Œ å¹¶ä¸”å°†å…¶åˆå¹¶åˆ°äº†è¿œç¨‹ä»“åº“çš„ master åˆ†æ”¯ï¼ˆæˆ–ä»»ä½•å…¶ä»–ç¨³å®šä»£ç åˆ†æ”¯ï¼‰ã€‚ å¯ä»¥è¿è¡Œå¸¦æœ‰ --delete é€‰é¡¹çš„ git push å‘½ä»¤æ¥åˆ é™¤ä¸€ä¸ªè¿œç¨‹åˆ†æ”¯ã€‚ å¦‚æœæƒ³è¦ä»æœåŠ¡å™¨ä¸Šåˆ é™¤ serverfix åˆ†æ”¯ï¼Œè¿è¡Œä¸‹é¢çš„å‘½ä»¤ï¼š $ git push origin --delete serverfix To https://github.com/schacon/simplegit - [deleted] serverfix åŸºæœ¬ä¸Šè¿™ä¸ªå‘½ä»¤åšçš„åªæ˜¯ä»æœåŠ¡å™¨ä¸Šç§»é™¤è¿™ä¸ªæŒ‡é’ˆã€‚ Git æœåŠ¡å™¨é€šå¸¸ä¼šä¿ç•™æ•°æ®ä¸€æ®µæ—¶é—´ç›´åˆ°åƒåœ¾å›æ”¶è¿è¡Œï¼Œæ‰€ä»¥å¦‚æœä¸å°å¿ƒåˆ é™¤æ‰äº†ï¼Œé€šå¸¸æ˜¯å¾ˆå®¹æ˜“æ¢å¤çš„ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%88%86%E6%94%AF-%E8%BF%9C%E7%A8%8B%E5%88%86%E6%94%AF/:0:7","tags":["Git"],"title":"Gitåˆ†æ”¯-è¿œç¨‹åˆ†æ”¯","uri":"/posts/git%E5%88%86%E6%94%AF-%E8%BF%9C%E7%A8%8B%E5%88%86%E6%94%AF/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"Gitåˆ†æ”¯çš„æ–°å»ºä¸åˆå¹¶-åˆ†æ”¯æ“ä½œ æ–‡æ¡£ï¼šGit åˆ†æ”¯ - åˆ†æ”¯çš„æ–°å»ºä¸åˆå¹¶ ","date":"2020-11-18","objectID":"/posts/git%E5%88%86%E6%94%AF%E7%9A%84%E6%96%B0%E5%BB%BA%E4%B8%8E%E5%90%88%E5%B9%B6-%E5%88%86%E6%94%AF%E6%93%8D%E4%BD%9C/:0:0","tags":["Git"],"title":"Gitåˆ†æ”¯çš„æ–°å»ºä¸åˆå¹¶-åˆ†æ”¯æ“ä½œ","uri":"/posts/git%E5%88%86%E6%94%AF%E7%9A%84%E6%96%B0%E5%BB%BA%E4%B8%8E%E5%90%88%E5%B9%B6-%E5%88%86%E6%94%AF%E6%93%8D%E4%BD%9C/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"åˆ›å»ºåˆ†æ”¯å¹¶åˆ‡æ¢ æ­¤æ—¶æœ‰ä¸€ä¸ªéœ€æ±‚éœ€è¦åœ¨æ–°çš„åˆ†æ”¯iss53ä¸Šå·¥ä½œï¼š $ git checkout -b iss53 # bè¡¨ç¤ºbranch å®ƒæ˜¯ä¸‹é¢ä¸¤æ¡å‘½ä»¤çš„ç®€å†™ï¼š $ git branch iss53 $ git checkout iss53 ","date":"2020-11-18","objectID":"/posts/git%E5%88%86%E6%94%AF%E7%9A%84%E6%96%B0%E5%BB%BA%E4%B8%8E%E5%90%88%E5%B9%B6-%E5%88%86%E6%94%AF%E6%93%8D%E4%BD%9C/:0:1","tags":["Git"],"title":"Gitåˆ†æ”¯çš„æ–°å»ºä¸åˆå¹¶-åˆ†æ”¯æ“ä½œ","uri":"/posts/git%E5%88%86%E6%94%AF%E7%9A%84%E6%96%B0%E5%BB%BA%E4%B8%8E%E5%90%88%E5%B9%B6-%E5%88%86%E6%94%AF%E6%93%8D%E4%BD%9C/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"åˆ‡æ¢åˆ†æ”¯ çªç„¶æœ‰ä¸€ä¸ªç´§æ€¥é—®é¢˜è¦è§£å†³ï¼Œéœ€è¦åœ¨åŸæ¥çš„masteråˆ†æ”¯è¿›è¡Œä¿®å¤ï¼š $ git checkout master åœ¨åˆ‡æ¢åˆ°masterä¹‹å‰ï¼Œéœ€è¦iss53åˆ†æ”¯ä¿æŒå¥½ä¸€ä¸ªå¹²å‡€çš„çŠ¶æ€ï¼ˆä¿®æ”¹éƒ½å·²æäº¤ï¼‰ã€‚ æ³¨æ„ï¼šåˆ‡æ¢åˆ†æ”¯Git ä¼šé‡ç½®ä½ çš„å·¥ä½œç›®å½•ã€‚ checkout ä¸­æ–‡å«ä¹‰ â€œæ£€å‡ºâ€ï¼Œcheckout \u003cbranch\u003e æ£€å‡ºåˆ†æ”¯ =\u003e æ£€å‡ºæŒ‡å®šåˆ†æ”¯çš„ä»£ç  =\u003e é‡ç½®å·¥ä½œç›®å½•å¹¶åˆ‡æ¢åˆ†æ”¯ã€‚ æ¥ä¸‹æ¥ï¼Œä½ è¦ä¿®å¤è¿™ä¸ªç´§æ€¥é—®é¢˜ã€‚ å»ºç«‹ä¸€ä¸ª hotfix åˆ†æ”¯ï¼Œåœ¨è¯¥åˆ†æ”¯ä¸Šå·¥ä½œç›´åˆ°é—®é¢˜è§£å†³ï¼š $ git checkout -b hotfix # ä¸­é—´è¿‡ç¨‹åœ¨hotfixä¸Šä¿®æ”¹äº†ä»£ç å¹¶æäº¤ $ echo 'test' \u003e ./hotfix.txt $ git add . $ git commit -m 'fixed' ","date":"2020-11-18","objectID":"/posts/git%E5%88%86%E6%94%AF%E7%9A%84%E6%96%B0%E5%BB%BA%E4%B8%8E%E5%90%88%E5%B9%B6-%E5%88%86%E6%94%AF%E6%93%8D%E4%BD%9C/:0:2","tags":["Git"],"title":"Gitåˆ†æ”¯çš„æ–°å»ºä¸åˆå¹¶-åˆ†æ”¯æ“ä½œ","uri":"/posts/git%E5%88%86%E6%94%AF%E7%9A%84%E6%96%B0%E5%BB%BA%E4%B8%8E%E5%90%88%E5%B9%B6-%E5%88%86%E6%94%AF%E6%93%8D%E4%BD%9C/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"åˆå¹¶åˆ†æ”¯ $ git checkout master # é¦–å…ˆåˆ‡å›masteråˆ†æ”¯ $ git merge hotfix # æŠŠ hotfix åˆ†æ”¯åˆå¹¶è¿‡æ¥ ","date":"2020-11-18","objectID":"/posts/git%E5%88%86%E6%94%AF%E7%9A%84%E6%96%B0%E5%BB%BA%E4%B8%8E%E5%90%88%E5%B9%B6-%E5%88%86%E6%94%AF%E6%93%8D%E4%BD%9C/:0:3","tags":["Git"],"title":"Gitåˆ†æ”¯çš„æ–°å»ºä¸åˆå¹¶-åˆ†æ”¯æ“ä½œ","uri":"/posts/git%E5%88%86%E6%94%AF%E7%9A%84%E6%96%B0%E5%BB%BA%E4%B8%8E%E5%90%88%E5%B9%B6-%E5%88%86%E6%94%AF%E6%93%8D%E4%BD%9C/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"åˆ é™¤åˆ†æ”¯ $ git branch -d hotfix # dè¡¨ç¤ºdelete # ç„¶ååˆ‡å›iss53ç»§ç»­å·¥ä½œ $ git checkout iss53 æ³¨æ„åˆ é™¤åˆ†æ”¯æ˜¯åœ¨ branch å‘½ä»¤ä¸Š ","date":"2020-11-18","objectID":"/posts/git%E5%88%86%E6%94%AF%E7%9A%84%E6%96%B0%E5%BB%BA%E4%B8%8E%E5%90%88%E5%B9%B6-%E5%88%86%E6%94%AF%E6%93%8D%E4%BD%9C/:0:4","tags":["Git"],"title":"Gitåˆ†æ”¯çš„æ–°å»ºä¸åˆå¹¶-åˆ†æ”¯æ“ä½œ","uri":"/posts/git%E5%88%86%E6%94%AF%E7%9A%84%E6%96%B0%E5%BB%BA%E4%B8%8E%E5%90%88%E5%B9%B6-%E5%88%86%E6%94%AF%E6%93%8D%E4%BD%9C/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"å¤šæ¬¡æäº¤ä¹‹ååˆå¹¶åˆ†æ”¯ å‡è®¾ä½ å·²ç»ä¿®æ­£äº† #53 é—®é¢˜ï¼Œæ‰“ç®—åˆå¹¶åˆ°masteråˆ†æ”¯ï¼š $ git checkout master $ git merga iss53 è¿™çœ‹ä¼¼å’Œä¹‹å‰çš„åˆå¹¶åŒºåˆ«ä¸å¤§ã€‚æ­¤æ—¶ä½ çš„å¼€å‘å†å²ä»ä¸€ä¸ªæ›´æ—©çš„åœ°æ–¹å¼€å§‹åˆ†å‰å¼€æ¥ï¼ˆdivergedï¼‰ã€‚ å› ä¸ºï¼Œmaster åˆ†æ”¯æ‰€åœ¨æäº¤å¹¶ä¸æ˜¯ iss53 åˆ†æ”¯æ‰€åœ¨æäº¤çš„ç›´æ¥ç¥–å…ˆï¼ŒGit ä¸å¾—ä¸åšä¸€äº›é¢å¤–çš„å·¥ä½œã€‚ å‡ºç°è¿™ç§æƒ…å†µçš„æ—¶å€™ï¼ŒGit ä¼šä½¿ç”¨ä¸¤ä¸ªåˆ†æ”¯çš„æœ«ç«¯æ‰€æŒ‡çš„å¿«ç…§ä»¥åŠè¿™ä¸¤ä¸ªåˆ†æ”¯çš„å…¬å…±ç¥–å…ˆï¼Œåšä¸€ä¸ªç®€å•çš„ä¸‰æ–¹åˆå¹¶ã€‚ å’Œä¹‹å‰å°†åˆ†æ”¯æŒ‡é’ˆå‘å‰æ¨è¿›æ‰€ä¸åŒçš„æ˜¯ï¼ŒGit å°†æ­¤æ¬¡ä¸‰æ–¹åˆå¹¶çš„ç»“æœåšäº†ä¸€ä¸ªæ–°çš„å¿«ç…§å¹¶ä¸”è‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ–°çš„æäº¤æŒ‡å‘å®ƒã€‚ è¿™ä¸ªè¢«ç§°ä½œä¸€æ¬¡åˆå¹¶æäº¤ï¼Œå®ƒçš„ç‰¹åˆ«ä¹‹å¤„åœ¨äºä»–æœ‰ä¸æ­¢ä¸€ä¸ªçˆ¶æäº¤ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%88%86%E6%94%AF%E7%9A%84%E6%96%B0%E5%BB%BA%E4%B8%8E%E5%90%88%E5%B9%B6-%E5%88%86%E6%94%AF%E6%93%8D%E4%BD%9C/:0:5","tags":["Git"],"title":"Gitåˆ†æ”¯çš„æ–°å»ºä¸åˆå¹¶-åˆ†æ”¯æ“ä½œ","uri":"/posts/git%E5%88%86%E6%94%AF%E7%9A%84%E6%96%B0%E5%BB%BA%E4%B8%8E%E5%90%88%E5%B9%B6-%E5%88%86%E6%94%AF%E6%93%8D%E4%BD%9C/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"é‡åˆ°å†²çªæ—¶çš„åˆ†æ”¯åˆå¹¶ å¦‚æœä½ åœ¨ä¸¤ä¸ªä¸åŒçš„åˆ†æ”¯ä¸­ï¼Œå¯¹åŒä¸€ä¸ªæ–‡ä»¶çš„åŒä¸€ä¸ªéƒ¨åˆ†è¿›è¡Œäº†ä¸åŒçš„ä¿®æ”¹ï¼ŒGit å°±æ²¡æ³•å¹²å‡€çš„åˆå¹¶å®ƒä»¬ï¼Œå°±äº§ç”Ÿäº†å†²çªã€‚ åˆå¹¶è¿‡ç¨‹ä¸­å‡ºç°CONFLICTæå‡ï¼Œè¡¨ç¤ºæœ‰å†²çª $ git merge iss53 Auto-merging index.html CONFLICT (content): Merge conflict in index.html Automatic merge failed; fix conflicts and then commit the result. ä½¿ç”¨git statusæŸ¥çœ‹æœªåˆå¹¶çŠ¶æ€ã€‚ ä»»ä½•å› åŒ…å«åˆå¹¶å†²çªè€Œæœ‰å¾…è§£å†³çš„æ–‡ä»¶ï¼Œéƒ½ä¼šä»¥æœªåˆå¹¶çŠ¶æ€æ ‡è¯†å‡ºæ¥ã€‚ Git ä¼šåœ¨æœ‰å†²çªçš„æ–‡ä»¶ä¸­åŠ å…¥æ ‡å‡†çš„å†²çªè§£å†³æ ‡è®°ï¼Œè¿™æ ·ä½ å¯ä»¥æ‰“å¼€è¿™äº›åŒ…å«å†²çªçš„æ–‡ä»¶ç„¶åæ‰‹åŠ¨è§£å†³å†²çªã€‚ å‡ºç°å†²çªçš„æ–‡ä»¶ä¼šåŒ…å«ä¸€äº›ç‰¹æ®ŠåŒºæ®µï¼Œçœ‹èµ·æ¥åƒä¸‹é¢è¿™ä¸ªæ ·å­ï¼š \u003c\u003c\u003c\u003c\u003c\u003c\u003c HEAD:index.html \u003cdiv id=\"footer\"\u003econtact : email.support@github.com\u003c/div\u003e ======= \u003cdiv id=\"footer\"\u003e please contact us at support@github.com \u003c/div\u003e \u003e\u003e\u003e\u003e\u003e\u003e\u003e iss53:index.html ä½ éœ€è¦æ‰‹åŠ¨è§£å†³å†²çªï¼Œè§£å†³äº†æ‰€æœ‰æ–‡ä»¶é‡Œçš„å†²çªä¹‹åï¼Œå¯¹æ¯ä¸ªæ–‡ä»¶ä½¿ç”¨ git add å‘½ä»¤æ¥å°†å…¶æ ‡è®°ä¸ºå†²çªå·²è§£å†³ã€‚ ä¸€æ—¦æš‚å­˜è¿™äº›åŸæœ¬æœ‰å†²çªçš„æ–‡ä»¶ï¼ŒGit å°±ä¼šå°†å®ƒä»¬æ ‡è®°ä¸ºå†²çªå·²è§£å†³ã€‚ å¦‚æœä½ å¯¹ç»“æœæ„Ÿåˆ°æ»¡æ„ï¼Œå¹¶ä¸”ç¡®å®šä¹‹å‰æœ‰å†²çªçš„çš„æ–‡ä»¶éƒ½å·²ç»æš‚å­˜äº†ï¼Œè¿™æ—¶ä½ å¯ä»¥è¾“å…¥ git commit æ¥å®Œæˆåˆå¹¶æäº¤ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%88%86%E6%94%AF%E7%9A%84%E6%96%B0%E5%BB%BA%E4%B8%8E%E5%90%88%E5%B9%B6-%E5%88%86%E6%94%AF%E6%93%8D%E4%BD%9C/:0:6","tags":["Git"],"title":"Gitåˆ†æ”¯çš„æ–°å»ºä¸åˆå¹¶-åˆ†æ”¯æ“ä½œ","uri":"/posts/git%E5%88%86%E6%94%AF%E7%9A%84%E6%96%B0%E5%BB%BA%E4%B8%8E%E5%90%88%E5%B9%B6-%E5%88%86%E6%94%AF%E6%93%8D%E4%BD%9C/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"Gitåˆ†æ”¯ç®¡ç†-æŸ¥çœ‹åˆ†æ”¯ ","date":"2020-11-18","objectID":"/posts/git%E5%88%86%E6%94%AF%E7%AE%A1%E7%90%86-%E6%9F%A5%E7%9C%8B%E5%88%86%E6%94%AF/:0:0","tags":["Git"],"title":"Gitåˆ†æ”¯ç®¡ç†-æŸ¥çœ‹åˆ†æ”¯","uri":"/posts/git%E5%88%86%E6%94%AF%E7%AE%A1%E7%90%86-%E6%9F%A5%E7%9C%8B%E5%88%86%E6%94%AF/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"æŸ¥çœ‹åˆ†æ”¯ $ git branch iss53 * master # å¸¦æ˜Ÿå·*è¡¨ç¤ºå½“å‰æ‰€åœ¨åˆ†æ”¯ testing git branch å‘½ä»¤ä¸åªæ˜¯å¯ä»¥åˆ›å»ºä¸åˆ é™¤åˆ†æ”¯ã€‚ å¦‚æœä¸åŠ ä»»ä½•å‚æ•°è¿è¡Œå®ƒï¼Œä¼šå¾—åˆ°å½“å‰æ‰€æœ‰åˆ†æ”¯çš„ä¸€ä¸ªåˆ—è¡¨ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%88%86%E6%94%AF%E7%AE%A1%E7%90%86-%E6%9F%A5%E7%9C%8B%E5%88%86%E6%94%AF/:0:1","tags":["Git"],"title":"Gitåˆ†æ”¯ç®¡ç†-æŸ¥çœ‹åˆ†æ”¯","uri":"/posts/git%E5%88%86%E6%94%AF%E7%AE%A1%E7%90%86-%E6%9F%A5%E7%9C%8B%E5%88%86%E6%94%AF/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"æŸ¥çœ‹æ¯ä¸ªåˆ†æ”¯çš„æœ€åæäº¤ $ git branch -v iss53 93b412c fix javascript issue * master 7a98805 Merge branch 'iss53' testing 782fd34 test ","date":"2020-11-18","objectID":"/posts/git%E5%88%86%E6%94%AF%E7%AE%A1%E7%90%86-%E6%9F%A5%E7%9C%8B%E5%88%86%E6%94%AF/:0:2","tags":["Git"],"title":"Gitåˆ†æ”¯ç®¡ç†-æŸ¥çœ‹åˆ†æ”¯","uri":"/posts/git%E5%88%86%E6%94%AF%E7%AE%A1%E7%90%86-%E6%9F%A5%E7%9C%8B%E5%88%86%E6%94%AF/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"æŸ¥çœ‹å·²(æœª)åˆå¹¶çš„åˆ†æ”¯ --merged ä¸ --no-merged è¿™ä¸¤ä¸ªé€‰é¡¹å¯ä»¥æŸ¥çœ‹å“ªäº›åˆ†æ”¯å·²ç»åˆå¹¶æˆ–æœªåˆå¹¶åˆ° å½“å‰ åˆ†æ”¯ã€‚ $ git branch --merged # æŸ¥çœ‹å·²åˆå¹¶åˆ†æ”¯åˆ—è¡¨ iss53 * master ä¸Šé¢åˆ—è¡¨ä¸­åˆ†æ”¯åå­—å‰æ²¡æœ‰ * å·çš„åˆ†æ”¯é€šå¸¸å¯ä»¥ä½¿ç”¨ git branch -d åˆ é™¤æ‰ï¼› $ git branch --no-merged # æŸ¥çœ‹æœªåˆå¹¶çš„åˆ†æ”¯åˆ—è¡¨ testing ä¸Šé¢æ˜¾ç¤ºæœªåˆå¹¶çš„åˆ†æ”¯ï¼Œå°è¯•ä½¿ç”¨ git branch -d å‘½ä»¤åˆ é™¤å®ƒæ—¶ä¼šå¤±è´¥ï¼š $ git branch -d testing error: The branch 'testing' is not fully merged. If you are sure you want to delete it, run 'git branch -D testing'. å¼ºåˆ¶åˆ é™¤æœªåˆå¹¶çš„åˆ†æ”¯: $ git branch -D testing æŸ¥çœ‹æŒ‡å®šåˆ†æ”¯çš„å·²(æœª)åˆå¹¶çš„åˆ†æ”¯ ä¸Šé¢æè¿°çš„é€‰é¡¹ --merged å’Œ --no-merged ä¼šåœ¨æ²¡æœ‰ç»™å®šæäº¤æˆ–åˆ†æ”¯åä½œä¸ºå‚æ•°æ—¶ï¼Œ åˆ†åˆ«åˆ—å‡ºå·²åˆå¹¶æˆ–æœªåˆå¹¶åˆ° å½“å‰ åˆ†æ”¯çš„åˆ†æ”¯ã€‚ ä½ æ€»æ˜¯å¯ä»¥æä¾›ä¸€ä¸ªé™„åŠ çš„å‚æ•°æ¥æŸ¥çœ‹å…¶å®ƒåˆ†æ”¯çš„åˆå¹¶çŠ¶æ€è€Œä¸å¿…æ£€å‡ºå®ƒä»¬ã€‚ ä¾‹å¦‚ï¼Œå°šæœªåˆå¹¶åˆ° testing åˆ†æ”¯çš„æœ‰å“ªäº›ï¼Ÿ $ git branch --no-merged testing topicA featureB ","date":"2020-11-18","objectID":"/posts/git%E5%88%86%E6%94%AF%E7%AE%A1%E7%90%86-%E6%9F%A5%E7%9C%8B%E5%88%86%E6%94%AF/:0:3","tags":["Git"],"title":"Gitåˆ†æ”¯ç®¡ç†-æŸ¥çœ‹åˆ†æ”¯","uri":"/posts/git%E5%88%86%E6%94%AF%E7%AE%A1%E7%90%86-%E6%9F%A5%E7%9C%8B%E5%88%86%E6%94%AF/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"Gitåˆ†æ”¯å¼€å‘å·¥ä½œæµ æ–‡æ¡£ï¼šGitåˆ†æ”¯å¼€å‘å·¥ä½œæµ ","date":"2020-11-18","objectID":"/posts/git%E5%88%86%E6%94%AF%E5%BC%80%E5%8F%91%E5%B7%A5%E4%BD%9C%E6%B5%81/:0:0","tags":["Git"],"title":"Gitåˆ†æ”¯å¼€å‘å·¥ä½œæµ","uri":"/posts/git%E5%88%86%E6%94%AF%E5%BC%80%E5%8F%91%E5%B7%A5%E4%BD%9C%E6%B5%81/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"é•¿æœŸåˆ†æ”¯ å› ä¸º Git ä½¿ç”¨ç®€å•çš„ä¸‰æ–¹åˆå¹¶ï¼Œæ‰€ä»¥å°±ç®—åœ¨ä¸€æ®µè¾ƒé•¿çš„æ—¶é—´å†…ï¼Œåå¤æŠŠä¸€ä¸ªåˆ†æ”¯åˆå¹¶å…¥å¦ä¸€ä¸ªåˆ†æ”¯ï¼Œä¹Ÿä¸æ˜¯ä»€ä¹ˆéš¾äº‹ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨æ•´ä¸ªé¡¹ç›®å¼€å‘å‘¨æœŸçš„ä¸åŒé˜¶æ®µï¼Œä½ å¯ä»¥åŒæ—¶æ‹¥æœ‰å¤šä¸ªå¼€æ”¾çš„åˆ†æ”¯ï¼›ä½ å¯ä»¥å®šæœŸåœ°æŠŠæŸäº›ä¸»é¢˜åˆ†æ”¯åˆå¹¶å…¥å…¶ä»–åˆ†æ”¯ä¸­ã€‚ è®¸å¤šä½¿ç”¨ Git çš„å¼€å‘è€…éƒ½å–œæ¬¢ä½¿ç”¨è¿™ç§æ–¹å¼æ¥å·¥ä½œï¼Œæ¯”å¦‚åªåœ¨ master åˆ†æ”¯ä¸Šä¿ç•™å®Œå…¨ç¨³å®šçš„ä»£ç ï¼Œå¼€å‘è¿‡ç¨‹åœ¨devåˆ†æ”¯ï¼Œå¼€å‘å®Œæˆåå¹¶å…¥teståˆ†æ”¯è¿›è¡Œæµ‹è¯•ï¼Œé€šè¿‡æµ‹è¯•çš„ç¨³å®šä»£ç æ‰å¹¶å…¥masteråˆ†æ”¯ä¸­ã€‚ devå’Œteståˆ†æ”¯ä¸éœ€è¦ä¿æŒç»å¯¹ç¨³å®šï¼Œä½†åœ¨testé€šè¿‡æµ‹è¯•è¾¾åˆ°ç¨³å®šçŠ¶æ€ï¼Œå°±å¯ä»¥è¢«åˆå¹¶å…¥masteråˆ†æ”¯ã€‚ äº‹å®ä¸Šæˆ‘ä»¬åˆšæ‰è®¨è®ºçš„ï¼Œæ˜¯éšç€ä½ çš„æäº¤è€Œä¸æ–­å³ç§»çš„æŒ‡é’ˆã€‚ ç¨³å®šåˆ†æ”¯(master)çš„æŒ‡é’ˆæ€»æ˜¯åœ¨æäº¤å†å²ä¸­è½åä¸€å¤§æˆªï¼Œè€Œå‰æ²¿åˆ†æ”¯(devæˆ–test)çš„æŒ‡é’ˆå¾€å¾€æ¯”è¾ƒé å‰ã€‚ ä½ å¯ä»¥ç”¨è¿™ç§æ–¹æ³•ç»´æŠ¤ä¸åŒå±‚æ¬¡çš„ç¨³å®šæ€§ã€‚ ä¸€äº›å¤§å‹é¡¹ç›®è¿˜æœ‰ä¸€ä¸ª proposedï¼ˆå»ºè®®ï¼‰ æˆ– pu: proposed updatesï¼ˆå»ºè®®æ›´æ–°ï¼‰åˆ†æ”¯ï¼Œå®ƒå¯èƒ½å› åŒ…å«ä¸€äº›ä¸æˆç†Ÿçš„å†…å®¹è€Œä¸èƒ½è¿›å…¥master åˆ†æ”¯ã€‚ è¿™ä¹ˆåšçš„ç›®çš„æ˜¯ä½¿ä½ çš„åˆ†æ”¯å…·æœ‰ä¸åŒçº§åˆ«çš„ç¨³å®šæ€§ï¼›å½“å®ƒä»¬å…·æœ‰ä¸€å®šç¨‹åº¦çš„ç¨³å®šæ€§åï¼Œå†æŠŠå®ƒä»¬åˆå¹¶å…¥å…·æœ‰æ›´é«˜çº§åˆ«ç¨³å®šæ€§çš„åˆ†æ”¯ä¸­ã€‚ å†æ¬¡å¼ºè°ƒä¸€ä¸‹ï¼Œä½¿ç”¨å¤šä¸ªé•¿æœŸåˆ†æ”¯çš„æ–¹æ³•å¹¶éå¿…è¦ï¼Œä½†æ˜¯è¿™ä¹ˆåšé€šå¸¸å¾ˆæœ‰å¸®åŠ©ï¼Œå°¤å…¶æ˜¯å½“ä½ åœ¨ä¸€ä¸ªéå¸¸åºå¤§æˆ–è€…å¤æ‚çš„é¡¹ç›®ä¸­å·¥ä½œæ—¶ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%88%86%E6%94%AF%E5%BC%80%E5%8F%91%E5%B7%A5%E4%BD%9C%E6%B5%81/:0:1","tags":["Git"],"title":"Gitåˆ†æ”¯å¼€å‘å·¥ä½œæµ","uri":"/posts/git%E5%88%86%E6%94%AF%E5%BC%80%E5%8F%91%E5%B7%A5%E4%BD%9C%E6%B5%81/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"ä¸»é¢˜åˆ†æ”¯ (çŸ­æœŸåˆ†æ”¯) ä¸»é¢˜åˆ†æ”¯å¯¹ä»»ä½•è§„æ¨¡çš„é¡¹ç›®éƒ½é€‚ç”¨ã€‚ ä¸»é¢˜åˆ†æ”¯æ˜¯ä¸€ç§çŸ­æœŸåˆ†æ”¯ï¼Œå®ƒè¢«ç”¨æ¥å®ç°å•ä¸€ç‰¹æ€§æˆ–å…¶ç›¸å…³å·¥ä½œã€‚ ä½ å·²ç»åœ¨ä¸Šä¸€èŠ‚ä¸­ä½ åˆ›å»ºçš„ iss53 å’Œ hotfix ä¸»é¢˜åˆ†æ”¯ä¸­çœ‹åˆ°è¿‡è¿™ç§ç”¨æ³•ã€‚ ä½ åœ¨ä¸Šä¸€èŠ‚ç”¨åˆ°çš„ä¸»é¢˜åˆ†æ”¯ï¼ˆiss53 å’Œ hotfix åˆ†æ”¯ï¼‰ä¸­æäº¤äº†ä¸€äº›æ›´æ–°ï¼Œå¹¶ä¸”åœ¨å®ƒä»¬åˆå¹¶å…¥ä¸»å¹²åˆ†æ”¯ä¹‹åï¼Œä½ åˆåˆ é™¤äº†å®ƒä»¬ã€‚ è¿™é¡¹æŠ€æœ¯èƒ½ä½¿ä½ å¿«é€Ÿå¹¶ä¸”å®Œæ•´åœ°è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ˆcontext-switchï¼‰â€”â€”å› ä¸ºä½ çš„å·¥ä½œè¢«åˆ†æ•£åˆ°ä¸åŒçš„æµæ°´çº¿ä¸­ï¼Œåœ¨ä¸åŒçš„æµæ°´çº¿ä¸­æ¯ä¸ªåˆ†æ”¯éƒ½ä»…ä¸å…¶ç›®æ ‡ç‰¹æ€§ç›¸å…³ï¼Œå› æ­¤ï¼Œåœ¨åšä»£ç å®¡æŸ¥ä¹‹ç±»çš„å·¥ä½œçš„æ—¶å€™å°±èƒ½æ›´åŠ å®¹æ˜“åœ°çœ‹å‡ºä½ åšäº†å“ªäº›æ”¹åŠ¨ã€‚ ä½ å¯ä»¥æŠŠåšå‡ºçš„æ”¹åŠ¨åœ¨ä¸»é¢˜åˆ†æ”¯ä¸­ä¿ç•™å‡ åˆ†é’Ÿã€å‡ å¤©ç”šè‡³å‡ ä¸ªæœˆï¼Œç­‰å®ƒä»¬æˆç†Ÿä¹‹åå†åˆå¹¶ï¼Œè€Œä¸ç”¨åœ¨ä¹å®ƒä»¬å»ºç«‹çš„é¡ºåºæˆ–å·¥ä½œè¿›åº¦ã€‚ è€ƒè™‘è¿™æ ·ä¸€ä¸ªä¾‹å­ï¼Œä½ åœ¨ master åˆ†æ”¯ä¸Šå·¥ä½œåˆ° C1ï¼Œè¿™æ—¶ä¸ºäº†è§£å†³ä¸€ä¸ªé—®é¢˜è€Œæ–°å»º iss91 åˆ†æ”¯ï¼Œåœ¨ iss91 åˆ†æ”¯ä¸Šå·¥ä½œåˆ° C4ï¼Œç„¶è€Œå¯¹äºé‚£ä¸ªé—®é¢˜ä½ åˆæœ‰äº†æ–°çš„æƒ³æ³•ï¼Œäºæ˜¯ä½ å†æ–°å»ºä¸€ä¸ª iss91v2 åˆ†æ”¯è¯•å›¾ç”¨å¦ä¸€ç§æ–¹æ³•è§£å†³é‚£ä¸ªé—®é¢˜ï¼Œæ¥ç€ä½ å›åˆ° master åˆ†æ”¯å·¥ä½œäº†ä¸€ä¼šå„¿ï¼Œä½ åˆå†’å‡ºäº†ä¸€ä¸ªä¸å¤ªç¡®å®šçš„æƒ³æ³•ï¼Œä½ ä¾¿åœ¨ C10 çš„æ—¶å€™æ–°å»ºä¸€ä¸ª dumbidea åˆ†æ”¯ï¼Œå¹¶åœ¨ä¸Šé¢åšäº›å®éªŒã€‚ ä½ çš„æäº¤å†å²çœ‹èµ·æ¥åƒä¸‹é¢è¿™ä¸ªæ ·å­ï¼š å›¾1. æ‹¥æœ‰å¤šä¸ªä¸»é¢˜åˆ†æ”¯çš„æäº¤å†å² â–² ç°åœ¨ï¼Œæˆ‘ä»¬å‡è®¾ä¸¤ä»¶äº‹æƒ…ï¼šä½ å†³å®šä½¿ç”¨ç¬¬äºŒä¸ªæ–¹æ¡ˆæ¥è§£å†³é‚£ä¸ªé—®é¢˜ï¼Œå³ä½¿ç”¨åœ¨ iss91v2 åˆ†æ”¯ä¸­æ–¹æ¡ˆã€‚ å¦å¤–ï¼Œä½ å°† dumbidea åˆ†æ”¯æ‹¿ç»™ä½ çš„åŒäº‹çœ‹è¿‡ä¹‹åï¼Œç»“æœå‘ç°è¿™æ˜¯ä¸ªæƒŠäººä¹‹ä¸¾ã€‚ è¿™æ—¶ä½ å¯ä»¥æŠ›å¼ƒ iss91 åˆ†æ”¯ï¼ˆå³ä¸¢å¼ƒ C5 å’Œ C6 æäº¤ï¼‰ï¼Œç„¶åæŠŠå¦å¤–ä¸¤ä¸ªåˆ†æ”¯åˆå¹¶å…¥ä¸»å¹²åˆ†æ”¯ã€‚ æœ€ç»ˆä½ çš„æäº¤å†å²çœ‹èµ·æ¥åƒä¸‹é¢è¿™ä¸ªæ ·å­ï¼š å›¾2. åˆå¹¶äº† dumbidea å’Œ iss91v2 åˆ†æ”¯ä¹‹åçš„æäº¤å†å² â–² æˆ‘ä»¬å°†ä¼šåœ¨ åˆ†å¸ƒå¼ Git ä¸­å‘ä½ æ­ç¤ºæ›´å¤šæœ‰å…³åˆ†æ”¯å·¥ä½œæµçš„ç»†èŠ‚ï¼Œ å› æ­¤ï¼Œè¯·ç¡®ä¿ä½ é˜…è¯»å®Œé‚£ä¸ªç« èŠ‚ä¹‹åï¼Œå†æ¥å†³å®šä½ çš„ä¸‹ä¸ªé¡¹ç›®è¦ä½¿ç”¨ä»€ä¹ˆæ ·çš„åˆ†æ”¯ç­–ç•¥ï¼ˆbranching schemeï¼‰ã€‚ è¯·ç‰¢è®°ï¼Œå½“ä½ åšè¿™ä¹ˆå¤šæ“ä½œçš„æ—¶å€™ï¼Œè¿™äº›åˆ†æ”¯å…¨éƒ¨éƒ½å­˜äºæœ¬åœ°ã€‚ å½“ä½ æ–°å»ºå’Œåˆå¹¶åˆ†æ”¯çš„æ—¶å€™ï¼Œæ‰€æœ‰è¿™ä¸€åˆ‡éƒ½åªå‘ç”Ÿåœ¨ä½ æœ¬åœ°çš„ Git ç‰ˆæœ¬åº“ä¸­ â€”â€” æ²¡æœ‰ä¸æœåŠ¡å™¨å‘ç”Ÿäº¤äº’ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%88%86%E6%94%AF%E5%BC%80%E5%8F%91%E5%B7%A5%E4%BD%9C%E6%B5%81/:0:2","tags":["Git"],"title":"Gitåˆ†æ”¯å¼€å‘å·¥ä½œæµ","uri":"/posts/git%E5%88%86%E6%94%AF%E5%BC%80%E5%8F%91%E5%B7%A5%E4%BD%9C%E6%B5%81/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"Gitå·¥å…·-æŸ¥çœ‹ä¿®è®¢ç‰ˆæœ¬ Git èƒ½å¤Ÿä»¥å¤šç§æ–¹å¼æ¥æŒ‡å®šå•ä¸ªæäº¤ã€ä¸€ç»„æäº¤ã€æˆ–è€…ä¸€å®šèŒƒå›´å†…çš„æäº¤ã€‚ äº†è§£å®ƒä»¬å¹¶ä¸æ˜¯å¿…éœ€çš„ï¼Œä½†æ˜¯äº†è§£ä¸€ä¸‹æ€»æ²¡åå¤„ã€‚ ä¿®è®¢ç‰ˆæœ¬æŒ‡çš„æ˜¯ï¼šæäº¤ ","date":"2020-11-18","objectID":"/posts/git%E5%B7%A5%E5%85%B7-%E6%9F%A5%E7%9C%8B%E4%BF%AE%E8%AE%A2%E7%89%88%E6%9C%AC/:0:0","tags":["Git"],"title":"Gitå·¥å…·-æŸ¥çœ‹ä¿®è®¢ç‰ˆæœ¬","uri":"/posts/git%E5%B7%A5%E5%85%B7-%E6%9F%A5%E7%9C%8B%E4%BF%AE%E8%AE%A2%E7%89%88%E6%9C%AC/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"å•ä¸ªä¿®è®¢ç‰ˆæœ¬ ä½ å¯ä»¥é€šè¿‡ä»»æ„ä¸€ä¸ªæäº¤çš„ 40 ä¸ªå­—ç¬¦çš„å®Œæ•´ SHA-1 æ•£åˆ—å€¼æ¥æŒ‡å®šå®ƒï¼Œ ä¸è¿‡è¿˜æœ‰å¾ˆå¤šæ›´äººæ€§åŒ–çš„æ–¹å¼æ¥åšåŒæ ·çš„äº‹æƒ…ã€‚æœ¬èŠ‚å°†ä¼šä»‹ç»è·å–å•ä¸ªæäº¤çš„å¤šç§æ–¹æ³•ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%B7%A5%E5%85%B7-%E6%9F%A5%E7%9C%8B%E4%BF%AE%E8%AE%A2%E7%89%88%E6%9C%AC/:1:0","tags":["Git"],"title":"Gitå·¥å…·-æŸ¥çœ‹ä¿®è®¢ç‰ˆæœ¬","uri":"/posts/git%E5%B7%A5%E5%85%B7-%E6%9F%A5%E7%9C%8B%E4%BF%AE%E8%AE%A2%E7%89%88%E6%9C%AC/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"ç®€çŸ­çš„ SHA-1 Git ååˆ†æ™ºèƒ½ï¼Œä½ åªéœ€è¦æä¾› SHA-1 çš„å‰å‡ ä¸ªå­—ç¬¦å°±å¯ä»¥è·å¾—å¯¹åº”çš„é‚£æ¬¡æäº¤ï¼Œ å½“ç„¶ä½ æä¾›çš„ SHA-1 å­—ç¬¦æ•°é‡ä¸å¾—å°‘äº 4 ä¸ªï¼Œå¹¶ä¸”æ²¡æœ‰æ­§ä¹‰â€”â€”ä¹Ÿå°±æ˜¯è¯´ï¼Œ å½“å‰å¯¹è±¡æ•°æ®åº“ä¸­æ²¡æœ‰å…¶å®ƒå¯¹è±¡ä»¥è¿™æ®µ SHA-1 å¼€å¤´ã€‚ ä¾‹å¦‚ï¼Œè¦æŸ¥çœ‹ä½ çŸ¥é“å…¶ä¸­æ·»åŠ äº†æŸä¸ªåŠŸèƒ½çš„æäº¤ï¼Œé¦–å…ˆè¿è¡Œ git log å‘½ä»¤æ¥å®šä½è¯¥æäº¤ï¼š $ git log commit 734713bc047d87bf7eac9674765ae793478c50d3 Author: Scott Chacon \u003cschacon@gmail.com\u003e Date: Fri Jan 2 18:32:33 2009 -0800 fixed refs handling, added gc auto, updated tests commit d921970aadf03b3cf0e71becdaab3147ba71cdef Merge: 1c002dd... 35cfb2b... Author: Scott Chacon \u003cschacon@gmail.com\u003e Date: Thu Dec 11 15:08:43 2008 -0800 Merge commit 'phedders/rdocs' commit 1c002dd4b536e7479fe34593e72e6c6c1819e53b Author: Scott Chacon \u003cschacon@gmail.com\u003e Date: Thu Dec 11 14:58:32 2008 -0800 added some blame and merge stuff ","date":"2020-11-18","objectID":"/posts/git%E5%B7%A5%E5%85%B7-%E6%9F%A5%E7%9C%8B%E4%BF%AE%E8%AE%A2%E7%89%88%E6%9C%AC/:2:0","tags":["Git"],"title":"Gitå·¥å…·-æŸ¥çœ‹ä¿®è®¢ç‰ˆæœ¬","uri":"/posts/git%E5%B7%A5%E5%85%B7-%E6%9F%A5%E7%9C%8B%E4%BF%AE%E8%AE%A2%E7%89%88%E6%9C%AC/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"æŸ¥çœ‹ç»™å®šSHA-1å€¼çš„æäº¤ åœ¨æœ¬ä¾‹ä¸­ï¼Œå‡è®¾ä½ æƒ³è¦çš„æäº¤å…¶ SHA-1 ä»¥ 1c002dd.... å¼€å¤´ï¼Œ é‚£ä¹ˆä½ å¯ä»¥ç”¨å¦‚ä¸‹å‡ ç§ git show çš„å˜ä½“æ¥æ£€è§†è¯¥æäº¤ï¼ˆå‡è®¾ç®€çŸ­çš„ç‰ˆæœ¬æ²¡æœ‰æ­§ä¹‰ï¼‰ï¼š $ git show 1c002dd4b536e7479fe34593e72e6c6c1819e53b $ git show 1c002dd4b536e7479f $ git show 1c002d Git å¯ä»¥ä¸º SHA-1 å€¼ç”Ÿæˆå‡ºç®€çŸ­ä¸”å”¯ä¸€çš„ç¼©å†™ã€‚ å¦‚æœä½ åœ¨ git log ååŠ ä¸Š --abbrev-commit å‚æ•°ï¼Œè¾“å‡ºç»“æœé‡Œå°±ä¼šæ˜¾ç¤ºç®€çŸ­ä¸”å”¯ä¸€çš„å€¼ï¼› é»˜è®¤ä½¿ç”¨ä¸ƒä¸ªå­—ç¬¦ï¼Œä¸è¿‡æœ‰æ—¶ä¸ºäº†é¿å… SHA-1 çš„æ­§ä¹‰ï¼Œä¼šå¢åŠ å­—ç¬¦æ•°ï¼š $ git log --abbrev-commit --pretty=oneline ca82a6d changed the version number 085bb3b removed unnecessary test code a11bef0 first commit é€šå¸¸ 8 åˆ° 10 ä¸ªå­—ç¬¦å°±å·²ç»è¶³å¤Ÿåœ¨ä¸€ä¸ªé¡¹ç›®ä¸­é¿å… SHA-1 çš„æ­§ä¹‰ã€‚ ä¾‹å¦‚ï¼Œåˆ° 2019 å¹´ 2 æœˆä¸ºæ­¢ï¼ŒLinux å†…æ ¸è¿™ä¸ªç›¸å½“å¤§çš„ Git é¡¹ç›®ï¼Œ å…¶å¯¹è±¡æ•°æ®åº“ä¸­æœ‰è¶…è¿‡ 875,000 ä¸ªæäº¤ï¼ŒåŒ…å«ä¸ƒç™¾ä¸‡ä¸ªå¯¹è±¡ï¼Œä¹Ÿåªéœ€è¦å‰ 12 ä¸ªå­—ç¬¦å°±èƒ½ä¿è¯å”¯ä¸€æ€§ã€‚ Note å…³äº SHA-1 çš„ç®€çŸ­è¯´æ˜è®¸å¤šäººè§‰å¾—ä»–ä»¬çš„ä»“åº“é‡Œæœ‰å¯èƒ½å‡ºç°ä¸¤ä¸ªä¸åŒçš„å¯¹è±¡å…¶ SHA-1 å€¼ç›¸åŒã€‚ ç„¶åå‘¢ï¼Ÿå¦‚æœä½ çœŸçš„å‘ä»“åº“é‡Œæäº¤äº†ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒè·Ÿä¹‹å‰çš„æŸä¸ª ä¸åŒ å¯¹è±¡çš„ SHA-1 å€¼ç›¸åŒï¼Œ Git ä¼šå‘ç°è¯¥å¯¹è±¡çš„æ•£åˆ—å€¼å·²ç»å­˜åœ¨äºä»“åº“é‡Œäº†ï¼Œäºæ˜¯å°±ä¼šè®¤ä¸ºè¯¥å¯¹è±¡è¢«å†™å…¥ï¼Œç„¶åç›´æ¥ä½¿ç”¨å®ƒã€‚ å¦‚æœä¹‹åä½ æƒ³æ£€å‡ºé‚£ä¸ªå¯¹è±¡æ—¶ï¼Œä½ å°†å¾—åˆ°å…ˆå‰é‚£ä¸ªå¯¹è±¡çš„æ•°æ®ã€‚ä½†æ˜¯è¿™ç§æƒ…å†µå‘ç”Ÿçš„æ¦‚ç‡ååˆ†æ¸ºå°ã€‚ SHA-1 æ‘˜è¦é•¿åº¦æ˜¯ 20 å­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯ 160 ä½ã€‚ 2^80 ä¸ªéšæœºå“ˆå¸Œå¯¹è±¡æ‰æœ‰ 50% çš„æ¦‚ç‡å‡ºç°ä¸€æ¬¡å†²çª ï¼ˆè®¡ç®—å†²çªæœºç‡çš„å…¬å¼æ˜¯ p = (n(n-1)/2) * (1/2^160)) ï¼‰ã€‚ 2^80 æ˜¯ 1.2 x 10^24ï¼Œä¹Ÿå°±æ˜¯ä¸€äº¿äº¿äº¿ï¼Œè¿™æ˜¯åœ°çƒä¸Šæ²™ç²’æ€»æ•°çš„ 1200 å€ã€‚ä¸¾ä¾‹è¯´ä¸€ä¸‹æ€æ ·æ‰èƒ½äº§ç”Ÿä¸€æ¬¡ SHA-1 å†²çªã€‚ å¦‚æœåœ°çƒä¸Š 65 äº¿ä¸ªäººç±»éƒ½åœ¨ç¼–ç¨‹ï¼Œæ¯äººæ¯ç§’éƒ½åœ¨äº§ç”Ÿç­‰ä»·äºæ•´ä¸ª Linux å†…æ ¸å†å²ï¼ˆ650 ä¸‡ä¸ª Git å¯¹è±¡ï¼‰çš„ä»£ç ï¼Œ å¹¶å°†ä¹‹æäº¤åˆ°ä¸€ä¸ªå·¨å¤§çš„ Git ä»“åº“é‡Œé¢ï¼Œè¿™æ ·æŒç»­ä¸¤å¹´çš„æ—¶é—´æ‰ä¼šäº§ç”Ÿè¶³å¤Ÿçš„å¯¹è±¡ï¼Œ ä½¿å…¶æ‹¥æœ‰ 50% çš„æ¦‚ç‡äº§ç”Ÿä¸€æ¬¡ SHA-1 å¯¹è±¡å†²çªï¼Œ è¿™æ¯”ä½ ç¼–ç¨‹å›¢é˜Ÿçš„æˆå‘˜åŒä¸€ä¸ªæ™šä¸Šåœ¨äº’ä¸ç›¸å¹²çš„æ„å¤–ä¸­è¢«ç‹¼è¢­å‡»å¹¶æ€æ­»çš„æœºç‡è¿˜è¦å°ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%B7%A5%E5%85%B7-%E6%9F%A5%E7%9C%8B%E4%BF%AE%E8%AE%A2%E7%89%88%E6%9C%AC/:2:1","tags":["Git"],"title":"Gitå·¥å…·-æŸ¥çœ‹ä¿®è®¢ç‰ˆæœ¬","uri":"/posts/git%E5%B7%A5%E5%85%B7-%E6%9F%A5%E7%9C%8B%E4%BF%AE%E8%AE%A2%E7%89%88%E6%9C%AC/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"åˆ†æ”¯å¼•ç”¨ å¼•ç”¨ç‰¹å®šæäº¤çš„ä¸€ç§ç›´æ¥æ–¹æ³•æ˜¯ï¼Œè‹¥å®ƒæ˜¯ä¸€ä¸ªåˆ†æ”¯çš„é¡¶ç«¯çš„æäº¤ï¼Œ é‚£ä¹ˆå¯ä»¥åœ¨ä»»ä½•éœ€è¦å¼•ç”¨è¯¥æäº¤çš„ Git å‘½ä»¤ä¸­ç›´æ¥ä½¿ç”¨è¯¥åˆ†æ”¯çš„åç§°ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%B7%A5%E5%85%B7-%E6%9F%A5%E7%9C%8B%E4%BF%AE%E8%AE%A2%E7%89%88%E6%9C%AC/:3:0","tags":["Git"],"title":"Gitå·¥å…·-æŸ¥çœ‹ä¿®è®¢ç‰ˆæœ¬","uri":"/posts/git%E5%B7%A5%E5%85%B7-%E6%9F%A5%E7%9C%8B%E4%BF%AE%E8%AE%A2%E7%89%88%E6%9C%AC/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"æŸ¥çœ‹æœ€åä¸€æ¬¡æäº¤ ä¾‹å¦‚ï¼Œä½ æƒ³è¦æŸ¥çœ‹ä¸€ä¸ªåˆ†æ”¯çš„æœ€åä¸€æ¬¡æäº¤çš„å¯¹è±¡ï¼Œå‡è®¾ topic1 åˆ†æ”¯æŒ‡å‘æäº¤ ca82a6d... ï¼Œ é‚£ä¹ˆä»¥ä¸‹çš„å‘½ä»¤æ˜¯ç­‰ä»·çš„ï¼š $ git show ca82a6dff817ec66f44342007202690a93763949 $ git show topic1 # topic1æ˜¯åˆ†æ”¯å å¦‚æœä½ æƒ³çŸ¥é“æŸä¸ªåˆ†æ”¯æŒ‡å‘å“ªä¸ªç‰¹å®šçš„ SHA-1ï¼Œæˆ–è€…æƒ³çœ‹ä»»ä½•ä¸€ä¸ªä¾‹å­ä¸­è¢«ç®€å†™çš„ SHA-1ï¼Œ ä½ å¯ä»¥ä½¿ç”¨ä¸€ä¸ªå«åš rev-parse çš„ Git æ¢æµ‹å·¥å…·ã€‚ ä½ å¯ä»¥åœ¨ Git å†…éƒ¨åŸç† ä¸­æŸ¥çœ‹æ›´å¤šå…³äºæ¢æµ‹å·¥å…·çš„ä¿¡æ¯ã€‚ ç®€å•æ¥è¯´ï¼Œrev-parse æ˜¯ä¸ºäº†åº•å±‚æ“ä½œè€Œä¸æ˜¯æ—¥å¸¸æ“ä½œè®¾è®¡çš„ã€‚ ä¸è¿‡ï¼Œæœ‰æ—¶ä½ æƒ³çœ‹ Git ç°åœ¨åˆ°åº•å¤„äºä»€ä¹ˆçŠ¶æ€æ—¶ï¼Œå®ƒå¯èƒ½ä¼šå¾ˆæœ‰ç”¨ã€‚ ä½ å¯ä»¥åœ¨ä½ çš„åˆ†æ”¯ä¸Šæ‰§è¡Œ rev-parse $ git rev-parse topic1 ca82a6dff817ec66f44342007202690a93763949 ","date":"2020-11-18","objectID":"/posts/git%E5%B7%A5%E5%85%B7-%E6%9F%A5%E7%9C%8B%E4%BF%AE%E8%AE%A2%E7%89%88%E6%9C%AC/:3:1","tags":["Git"],"title":"Gitå·¥å…·-æŸ¥çœ‹ä¿®è®¢ç‰ˆæœ¬","uri":"/posts/git%E5%B7%A5%E5%85%B7-%E6%9F%A5%E7%9C%8B%E4%BF%AE%E8%AE%A2%E7%89%88%E6%9C%AC/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"å¼•ç”¨æ—¥å¿— ","date":"2020-11-18","objectID":"/posts/git%E5%B7%A5%E5%85%B7-%E6%9F%A5%E7%9C%8B%E4%BF%AE%E8%AE%A2%E7%89%88%E6%9C%AC/:4:0","tags":["Git"],"title":"Gitå·¥å…·-æŸ¥çœ‹ä¿®è®¢ç‰ˆæœ¬","uri":"/posts/git%E5%B7%A5%E5%85%B7-%E6%9F%A5%E7%9C%8B%E4%BF%AE%E8%AE%A2%E7%89%88%E6%9C%AC/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"HEADçš„æŒ‡å‘å†å² å½“ä½ åœ¨å·¥ä½œæ—¶ï¼Œ Git ä¼šåœ¨åå°ä¿å­˜ä¸€ä¸ªå¼•ç”¨æ—¥å¿—ï¼ˆreflogï¼‰ï¼Œ å¼•ç”¨æ—¥å¿—è®°å½•äº†æœ€è¿‘å‡ ä¸ªæœˆä½ çš„ HEAD å’Œåˆ†æ”¯å¼•ç”¨æ‰€æŒ‡å‘çš„å†å²ã€‚ ä½ å¯ä»¥ä½¿ç”¨ git reflog æ¥æŸ¥çœ‹å¼•ç”¨æ—¥å¿— $ git reflog 734713b HEAD@{0}: commit: fixed refs handling, added gc auto, updated d921970 HEAD@{1}: merge phedders/rdocs: Merge made by the 'recursive' strategy. 1c002dd HEAD@{2}: commit: added some blame and merge stuff 1c36188 HEAD@{3}: rebase -i (squash): updating HEAD 95df984 HEAD@{4}: commit: # This is a combination of two commits. 1c36188 HEAD@{5}: rebase -i (squash): updating HEAD 7e05da5 HEAD@{6}: rebase -i (pick): updating HEAD æ¯å½“ä½ çš„ HEAD æ‰€æŒ‡å‘çš„ä½ç½®å‘ç”Ÿäº†å˜åŒ–ï¼ŒGit å°±ä¼šå°†è¿™ä¸ªä¿¡æ¯å­˜å‚¨åˆ°å¼•ç”¨æ—¥å¿—è¿™ä¸ªå†å²è®°å½•é‡Œã€‚ ä½ ä¹Ÿå¯ä»¥é€šè¿‡ reflog æ•°æ®æ¥è·å–ä¹‹å‰çš„æäº¤å†å²ã€‚ å¦‚æœä½ æƒ³æŸ¥çœ‹ä»“åº“ä¸­ HEAD åœ¨äº”æ¬¡å‰çš„æ‰€æŒ‡å‘çš„æäº¤ï¼Œä½ å¯ä»¥ä½¿ç”¨ @{n} æ¥å¼•ç”¨ reflog ä¸­è¾“å‡ºçš„æäº¤è®°å½•ã€‚ $ git show HEAD@{5} ä½ åŒæ ·å¯ä»¥ä½¿ç”¨è¿™ä¸ªè¯­æ³•æ¥æŸ¥çœ‹æŸä¸ªåˆ†æ”¯åœ¨ä¸€å®šæ—¶é—´å‰çš„ä½ç½®ã€‚ ä¾‹å¦‚ï¼ŒæŸ¥çœ‹ä½ çš„ master åˆ†æ”¯åœ¨æ˜¨å¤©çš„æ—¶å€™æŒ‡å‘äº†å“ªä¸ªæäº¤ï¼Œä½ å¯ä»¥è¾“å…¥ $ git show master@{yesterday} å°±ä¼šæ˜¾ç¤ºæ˜¨å¤© master åˆ†æ”¯çš„é¡¶ç«¯æŒ‡å‘äº†å“ªä¸ªæäº¤ã€‚ è¿™ä¸ªæ–¹æ³•åªå¯¹è¿˜åœ¨ä½ å¼•ç”¨æ—¥å¿—é‡Œçš„æ•°æ®æœ‰ç”¨ï¼Œæ‰€ä»¥ä¸èƒ½ç”¨æ¥æŸ¥å¥½å‡ ä¸ªæœˆä¹‹å‰çš„æäº¤ã€‚ å¯ä»¥è¿è¡Œ git log -g æ¥æŸ¥çœ‹ç±»ä¼¼äº git log è¾“å‡ºæ ¼å¼çš„å¼•ç”¨æ—¥å¿—ä¿¡æ¯ï¼š $ git log -g master commit 734713bc047d87bf7eac9674765ae793478c50d3 Reflog: master@{0} (Scott Chacon \u003cschacon@gmail.com\u003e) Reflog message: commit: fixed refs handling, added gc auto, updated Author: Scott Chacon \u003cschacon@gmail.com\u003e Date: Fri Jan 2 18:32:33 2009 -0800 fixed refs handling, added gc auto, updated tests commit d921970aadf03b3cf0e71becdaab3147ba71cdef Reflog: master@{1} (Scott Chacon \u003cschacon@gmail.com\u003e) Reflog message: merge phedders/rdocs: Merge made by recursive. Author: Scott Chacon \u003cschacon@gmail.com\u003e Date: Thu Dec 11 15:08:43 2008 -0800 Merge commit 'phedders/rdocs' å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¼•ç”¨æ—¥å¿—åªå­˜åœ¨äºæœ¬åœ°ä»“åº“ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªè®°å½•ä½ åœ¨ è‡ªå·± çš„ä»“åº“é‡Œåšè¿‡ä»€ä¹ˆçš„æ—¥å¿—ã€‚ å…¶ä»–äººæ‹·è´çš„ä»“åº“é‡Œçš„å¼•ç”¨æ—¥å¿—ä¸ä¼šå’Œä½ çš„ç›¸åŒï¼Œè€Œä½ æ–°å…‹éš†ä¸€ä¸ªä»“åº“çš„æ—¶å€™ï¼Œå¼•ç”¨æ—¥å¿—æ˜¯ç©ºçš„ï¼Œå› ä¸ºä½ åœ¨ä»“åº“é‡Œè¿˜æ²¡æœ‰æ“ä½œã€‚ git show HEAD@{2.months.ago} è¿™æ¡å‘½ä»¤åªæœ‰åœ¨ä½ å…‹éš†äº†ä¸€ä¸ªé¡¹ç›®è‡³å°‘ä¸¤ä¸ªæœˆæ—¶æ‰ä¼šæ˜¾ç¤ºåŒ¹é…çš„æäº¤â€”â€” å¦‚æœä½ åˆšåˆšå…‹éš†äº†ä»“åº“ï¼Œé‚£ä¹ˆå®ƒå°†ä¸ä¼šæœ‰ä»»ä½•ç»“æœè¿”å›ã€‚ Tip å°†å¼•ç”¨æ—¥å¿—æƒ³ä½œ Git ç‰ˆçš„ shell å†å²è®°å½•å¦‚æœä½ æœ‰ UNIX æˆ–è€… Linux çš„èƒŒæ™¯ï¼Œä¸å¦¨å°†å¼•ç”¨æ—¥å¿—æƒ³ä½œ Git ç‰ˆçš„ shell å†å²è®°å½•ï¼Œ é‡ç‚¹åœ¨äºä»…ä¸ä½ å’Œä½ çš„ä¼šè¯ç›¸å…³ï¼Œè€Œä¸ä»–äººæ— å…³ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%B7%A5%E5%85%B7-%E6%9F%A5%E7%9C%8B%E4%BF%AE%E8%AE%A2%E7%89%88%E6%9C%AC/:4:1","tags":["Git"],"title":"Gitå·¥å…·-æŸ¥çœ‹ä¿®è®¢ç‰ˆæœ¬","uri":"/posts/git%E5%B7%A5%E5%85%B7-%E6%9F%A5%E7%9C%8B%E4%BF%AE%E8%AE%A2%E7%89%88%E6%9C%AC/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"ç¥–å…ˆå¼•ç”¨ ç¥–å…ˆå¼•ç”¨æ˜¯å¦ä¸€ç§æŒ‡æ˜ä¸€ä¸ªæäº¤çš„æ–¹å¼ã€‚ å¦‚æœä½ åœ¨å¼•ç”¨çš„å°¾éƒ¨åŠ ä¸Šä¸€ä¸ª ^ï¼ˆè„±å­—ç¬¦ï¼‰ï¼Œ Git ä¼šå°†å…¶è§£æä¸ºè¯¥å¼•ç”¨çš„ä¸Šä¸€ä¸ªæäº¤ã€‚ å‡è®¾ä½ çš„æäº¤å†å²æ˜¯ï¼š $ git log --pretty=format:'%h %s' --graph * 734713b fixed refs handling, added gc auto, updated tests * d921970 Merge commit 'phedders/rdocs' |\\ | * 35cfb2b Some rdoc changes * | 1c002dd added some blame and merge stuff |/ * 1c36188 ignore *.gem * 9b29157 add open3_detach to gemspec file list ä½ å¯ä»¥ä½¿ç”¨ HEAD^ æ¥æŸ¥çœ‹ä¸Šä¸€ä¸ªæäº¤ï¼Œä¹Ÿå°±æ˜¯ â€œHEAD çš„çˆ¶æäº¤â€ï¼š $ git show HEAD^ commit d921970aadf03b3cf0e71becdaab3147ba71cdef Merge: 1c002dd... 35cfb2b... Author: Scott Chacon \u003cschacon@gmail.com\u003e Date: Thu Dec 11 15:08:43 2008 -0800 Merge commit 'phedders/rdocs' Note åœ¨ Windows ä¸Šè½¬ä¹‰è„±å­—ç¬¦åœ¨ Windows çš„ cmd.exe ä¸­ï¼Œ^ æ˜¯ä¸€ä¸ªç‰¹æ®Šå­—ç¬¦ï¼Œå› æ­¤éœ€è¦åŒºåˆ«å¯¹å¾…ã€‚ ä½ å¯ä»¥åŒå†™å®ƒæˆ–è€…å°†æäº¤å¼•ç”¨æ”¾åœ¨å¼•å·ä¸­ï¼š$ git show HEAD^ # åœ¨ Windows ä¸Šæ— æ³•å·¥ä½œ $ git show HEAD^^ # å¯ä»¥ $ git show \"HEAD^\" # å¯ä»¥ ä½ ä¹Ÿå¯ä»¥åœ¨ ^ åé¢æ·»åŠ ä¸€ä¸ªæ•°å­—æ¥æŒ‡æ˜æƒ³è¦ å“ªä¸€ä¸ª çˆ¶æäº¤â€”â€”ä¾‹å¦‚ d921970^2 ä»£è¡¨ â€œd921970 çš„ç¬¬äºŒçˆ¶æäº¤â€ è¿™ä¸ªè¯­æ³•åªé€‚ç”¨äºåˆå¹¶çš„æäº¤ï¼Œå› ä¸ºåˆå¹¶æäº¤ä¼šæœ‰å¤šä¸ªçˆ¶æäº¤ã€‚ åˆå¹¶æäº¤çš„ç¬¬ä¸€çˆ¶æäº¤æ˜¯ä½ åˆå¹¶æ—¶æ‰€åœ¨åˆ†æ”¯ï¼ˆé€šå¸¸ä¸º masterï¼‰ï¼Œè€Œç¬¬äºŒçˆ¶æäº¤æ˜¯ä½ æ‰€åˆå¹¶çš„åˆ†æ”¯ï¼ˆä¾‹å¦‚ topicï¼‰ï¼š $ git show d921970^ commit 1c002dd4b536e7479fe34593e72e6c6c1819e53b Author: Scott Chacon \u003cschacon@gmail.com\u003e Date: Thu Dec 11 14:58:32 2008 -0800 added some blame and merge stuff $ git show d921970^2 commit 35cfb2b795a55793d7cc56a6cc2060b4bb732548 Author: Paul Hedderly \u003cpaul+git@mjr.org\u003e Date: Wed Dec 10 22:22:03 2008 +0000 Some rdoc changes å¦ä¸€ç§æŒ‡æ˜ç¥–å…ˆæäº¤çš„æ–¹æ³•æ˜¯ ~ï¼ˆæ³¢æµªå·ï¼‰ã€‚ åŒæ ·æ˜¯æŒ‡å‘ç¬¬ä¸€çˆ¶æäº¤ï¼Œå› æ­¤ HEAD~ å’Œ HEAD^ æ˜¯ç­‰ä»·çš„ã€‚ è€ŒåŒºåˆ«åœ¨äºä½ åœ¨åé¢åŠ æ•°å­—çš„æ—¶å€™ã€‚ HEAD~2 ä»£è¡¨â€œç¬¬ä¸€çˆ¶æäº¤çš„ç¬¬ä¸€çˆ¶æäº¤â€ï¼Œä¹Ÿå°±æ˜¯â€œç¥–çˆ¶æäº¤â€â€”â€”Git ä¼šæ ¹æ®ä½ æŒ‡å®šçš„æ¬¡æ•°è·å–å¯¹åº”çš„ç¬¬ä¸€çˆ¶æäº¤ã€‚ ä¾‹å¦‚ï¼Œåœ¨ä¹‹å‰çš„åˆ—å‡ºçš„æäº¤å†å²ä¸­ï¼ŒHEAD~3 å°±æ˜¯ $ git show HEAD~3 commit 1c3618887afb5fbcbea25b7c013f4e2114448b8d Author: Tom Preston-Werner \u003ctom@mojombo.com\u003e Date: Fri Nov 7 13:47:59 2008 -0500 ignore *.gem ä¹Ÿå¯ä»¥å†™æˆ HEAD~~~ï¼Œä¹Ÿæ˜¯ç¬¬ä¸€çˆ¶æäº¤çš„ç¬¬ä¸€çˆ¶æäº¤çš„ç¬¬ä¸€çˆ¶æäº¤ï¼š $ git show HEAD~~~ commit 1c3618887afb5fbcbea25b7c013f4e2114448b8d Author: Tom Preston-Werner \u003ctom@mojombo.com\u003e Date: Fri Nov 7 13:47:59 2008 -0500 ignore *.gem ä½ ä¹Ÿå¯ä»¥ç»„åˆä½¿ç”¨è¿™ä¸¤ä¸ªè¯­æ³•â€”â€”ä½ å¯ä»¥é€šè¿‡ HEAD~3^2 æ¥å–å¾—ä¹‹å‰å¼•ç”¨çš„ç¬¬äºŒçˆ¶æäº¤ï¼ˆå‡è®¾å®ƒæ˜¯ä¸€ä¸ªåˆå¹¶æäº¤ï¼‰ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%B7%A5%E5%85%B7-%E6%9F%A5%E7%9C%8B%E4%BF%AE%E8%AE%A2%E7%89%88%E6%9C%AC/:5:0","tags":["Git"],"title":"Gitå·¥å…·-æŸ¥çœ‹ä¿®è®¢ç‰ˆæœ¬","uri":"/posts/git%E5%B7%A5%E5%85%B7-%E6%9F%A5%E7%9C%8B%E4%BF%AE%E8%AE%A2%E7%89%88%E6%9C%AC/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"æäº¤åŒºé—´ ä½ å·²ç»å­¦ä¼šå¦‚ä½•å•æ¬¡çš„æäº¤ï¼Œç°åœ¨æ¥çœ‹çœ‹å¦‚ä½•æŒ‡æ˜ä¸€å®šåŒºé—´çš„æäº¤ã€‚ å½“ä½ æœ‰å¾ˆå¤šåˆ†æ”¯æ—¶ï¼Œè¿™å¯¹ç®¡ç†ä½ çš„åˆ†æ”¯æ—¶ååˆ†æœ‰ç”¨ï¼Œ ä½ å¯ä»¥ç”¨æäº¤åŒºé—´æ¥è§£å†³â€œè¿™ä¸ªåˆ†æ”¯è¿˜æœ‰å“ªäº›æäº¤å°šæœªåˆå¹¶åˆ°ä¸»åˆ†æ”¯ï¼Ÿâ€çš„é—®é¢˜ ","date":"2020-11-18","objectID":"/posts/git%E5%B7%A5%E5%85%B7-%E6%9F%A5%E7%9C%8B%E4%BF%AE%E8%AE%A2%E7%89%88%E6%9C%AC/:6:0","tags":["Git"],"title":"Gitå·¥å…·-æŸ¥çœ‹ä¿®è®¢ç‰ˆæœ¬","uri":"/posts/git%E5%B7%A5%E5%85%B7-%E6%9F%A5%E7%9C%8B%E4%BF%AE%E8%AE%A2%E7%89%88%E6%9C%AC/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"åŒç‚¹ æœ€å¸¸ç”¨çš„æŒ‡æ˜æäº¤åŒºé—´è¯­æ³•æ˜¯åŒç‚¹ã€‚ è¿™ç§è¯­æ³•å¯ä»¥è®© Git é€‰å‡ºåœ¨ä¸€ä¸ªåˆ†æ”¯ä¸­è€Œä¸åœ¨å¦ä¸€ä¸ªåˆ†æ”¯ä¸­çš„æäº¤ã€‚ ä¾‹å¦‚ï¼Œä½ æœ‰å¦‚ä¸‹çš„æäº¤å†å² Example history for range selection. Figure 137. Example history for range selection. ä½ æƒ³è¦æŸ¥çœ‹ experiment åˆ†æ”¯ä¸­è¿˜æœ‰å“ªäº›æäº¤å°šæœªè¢«åˆå¹¶å…¥ master åˆ†æ”¯ã€‚ ä½ å¯ä»¥ä½¿ç”¨ master..experiment æ¥è®© Git æ˜¾ç¤ºè¿™äº›æäº¤ã€‚ä¹Ÿå°±æ˜¯â€œåœ¨ experiment åˆ†æ”¯ä¸­è€Œä¸åœ¨ master åˆ†æ”¯ä¸­çš„æäº¤â€ã€‚ ä¸ºäº†ä½¿ä¾‹å­ç®€å•æ˜äº†ï¼Œæˆ‘ä½¿ç”¨äº†ç¤ºæ„å›¾ä¸­æäº¤å¯¹è±¡çš„å­—æ¯æ¥ä»£æ›¿çœŸå®æ—¥å¿—çš„è¾“å‡ºï¼Œæ‰€ä»¥ä¼šæ˜¾ç¤ºï¼š $ git log master..experiment D C åè¿‡æ¥ï¼Œå¦‚æœä½ æƒ³æŸ¥çœ‹åœ¨ master åˆ†æ”¯ä¸­è€Œä¸åœ¨ experiment åˆ†æ”¯ä¸­çš„æäº¤ï¼Œä½ åªè¦äº¤æ¢åˆ†æ”¯åå³å¯ã€‚ experiment..master ä¼šæ˜¾ç¤ºåœ¨ master åˆ†æ”¯ä¸­è€Œä¸åœ¨ experiment åˆ†æ”¯ä¸­çš„æäº¤ï¼š $ git log experiment..master F E æŸ¥çœ‹å³å°†æ¨é€åˆ°è¿œç«¯çš„å†…å®¹ è¿™å¯ä»¥è®©ä½ ä¿æŒ experiment åˆ†æ”¯è·Ÿéšæœ€æ–°çš„è¿›åº¦ä»¥åŠæŸ¥çœ‹ä½ å³å°†åˆå¹¶çš„å†…å®¹ã€‚ å¦ä¸€ä¸ªå¸¸ç”¨çš„åœºæ™¯æ˜¯æŸ¥çœ‹ä½ å³å°†æ¨é€åˆ°è¿œç«¯çš„å†…å®¹ï¼š $ git log origin/master..HEAD è¿™ä¸ªå‘½ä»¤ä¼šè¾“å‡ºåœ¨ä½ å½“å‰åˆ†æ”¯ä¸­è€Œä¸åœ¨è¿œç¨‹ origin ä¸­çš„æäº¤ã€‚ å¦‚æœä½ æ‰§è¡Œ git push å¹¶ä¸”ä½ çš„å½“å‰åˆ†æ”¯æ­£åœ¨è·Ÿè¸ª origin/masterï¼Œç”± git log origin/master..HEAD æ‰€è¾“å‡ºçš„æäº¤å°±æ˜¯ä¼šè¢«ä¼ è¾“åˆ°è¿œç«¯æœåŠ¡å™¨çš„æäº¤ã€‚å¦‚æœä½ ç•™ç©ºäº†å…¶ä¸­çš„ä¸€è¾¹ï¼Œ Git ä¼šé»˜è®¤ä¸º HEADã€‚ ä¾‹å¦‚ï¼Œ git log origin/master.. å°†ä¼šè¾“å‡ºä¸ä¹‹å‰ä¾‹å­ç›¸åŒçš„ç»“æœ â€”â€” Git ä½¿ç”¨ HEAD æ¥ä»£æ›¿ç•™ç©ºçš„ä¸€è¾¹ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%B7%A5%E5%85%B7-%E6%9F%A5%E7%9C%8B%E4%BF%AE%E8%AE%A2%E7%89%88%E6%9C%AC/:6:1","tags":["Git"],"title":"Gitå·¥å…·-æŸ¥çœ‹ä¿®è®¢ç‰ˆæœ¬","uri":"/posts/git%E5%B7%A5%E5%85%B7-%E6%9F%A5%E7%9C%8B%E4%BF%AE%E8%AE%A2%E7%89%88%E6%9C%AC/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"å¤šç‚¹ åŒç‚¹è¯­æ³•å¾ˆå¥½ç”¨ï¼Œä½†æœ‰æ—¶å€™ä½ å¯èƒ½éœ€è¦ä¸¤ä¸ªä»¥ä¸Šçš„åˆ†æ”¯æ‰èƒ½ç¡®å®šä½ æ‰€éœ€è¦çš„ä¿®è®¢ï¼Œ æ¯”å¦‚æŸ¥çœ‹å“ªäº›æäº¤æ˜¯è¢«åŒ…å«åœ¨æŸäº›åˆ†æ”¯ä¸­çš„ä¸€ä¸ªï¼Œä½†æ˜¯ä¸åœ¨ä½ å½“å‰çš„åˆ†æ”¯ä¸Šã€‚ Git å…è®¸ä½ åœ¨ä»»æ„å¼•ç”¨å‰åŠ ä¸Š ^ å­—ç¬¦æˆ–è€… --not æ¥æŒ‡æ˜ä½ ä¸å¸Œæœ›æäº¤è¢«åŒ…å«å…¶ä¸­çš„åˆ†æ”¯ã€‚ å› æ­¤ä¸‹åˆ—ä¸‰ä¸ªå‘½ä»¤æ˜¯ç­‰ä»·çš„ï¼š $ git log refA..refB $ git log ^refA refB $ git log refB --not refA è¿™ä¸ªè¯­æ³•å¾ˆå¥½ç”¨ï¼Œå› ä¸ºä½ å¯ä»¥åœ¨æŸ¥è¯¢ä¸­æŒ‡å®šè¶…è¿‡ä¸¤ä¸ªçš„å¼•ç”¨ï¼Œè¿™æ˜¯åŒç‚¹è¯­æ³•æ— æ³•å®ç°çš„ã€‚ æ¯”å¦‚ï¼Œä½ æƒ³æŸ¥çœ‹æ‰€æœ‰è¢« refA æˆ– refB åŒ…å«çš„ä½†æ˜¯ä¸è¢« refC åŒ…å«çš„æäº¤ï¼Œä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»»æ„ä¸€ä¸ªå‘½ä»¤ï¼š $ git log refA refB ^refC $ git log refA refB --not refC è¿™å°±æ„æˆäº†ä¸€ä¸ªååˆ†å¼ºå¤§çš„ä¿®è®¢æŸ¥è¯¢ç³»ç»Ÿï¼Œä½ å¯ä»¥é€šè¿‡å®ƒæ¥æŸ¥çœ‹ä½ çš„åˆ†æ”¯é‡ŒåŒ…å«äº†å“ªäº›ä¸œè¥¿ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%B7%A5%E5%85%B7-%E6%9F%A5%E7%9C%8B%E4%BF%AE%E8%AE%A2%E7%89%88%E6%9C%AC/:6:2","tags":["Git"],"title":"Gitå·¥å…·-æŸ¥çœ‹ä¿®è®¢ç‰ˆæœ¬","uri":"/posts/git%E5%B7%A5%E5%85%B7-%E6%9F%A5%E7%9C%8B%E4%BF%AE%E8%AE%A2%E7%89%88%E6%9C%AC/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"ä¸‰ç‚¹ æœ€åä¸€ç§ä¸»è¦çš„åŒºé—´é€‰æ‹©è¯­æ³•æ˜¯ä¸‰ç‚¹ï¼Œè¿™ä¸ªè¯­æ³•å¯ä»¥é€‰æ‹©å‡ºè¢«ä¸¤ä¸ªå¼•ç”¨ ä¹‹ä¸€ åŒ…å«ä½†åˆä¸è¢«ä¸¤è€…åŒæ—¶åŒ…å«çš„æäº¤ã€‚ å†çœ‹çœ‹ä¹‹å‰åŒç‚¹ä¾‹å­ä¸­çš„æäº¤å†å²ã€‚ å¦‚æœä½ æƒ³çœ‹ master æˆ–è€… experiment ä¸­åŒ…å«çš„ä½†ä¸æ˜¯ä¸¤è€…å…±æœ‰çš„æäº¤ï¼Œä½ å¯ä»¥æ‰§è¡Œï¼š $ git log master...experiment F E D C è¿™å’Œé€šå¸¸ log æŒ‰æ—¥æœŸæ’åºçš„è¾“å‡ºä¸€æ ·ï¼Œä»…ä»…ç»™å‡ºäº†4ä¸ªæäº¤çš„ä¿¡æ¯ã€‚ è¿™ç§æƒ…å½¢ä¸‹ï¼Œlog å‘½ä»¤çš„ä¸€ä¸ªå¸¸ç”¨å‚æ•°æ˜¯ --left-rightï¼Œå®ƒä¼šæ˜¾ç¤ºæ¯ä¸ªæäº¤åˆ°åº•å¤„äºå“ªä¸€ä¾§çš„åˆ†æ”¯ã€‚ è¿™ä¼šè®©è¾“å‡ºæ•°æ®æ›´åŠ æ¸…æ™°ã€‚ $ git log --left-right master...experiment \u003c F \u003c E \u003e D \u003e C æœ‰äº†è¿™äº›å·¥å…·ï¼Œä½ å°±å¯ä»¥ååˆ†æ–¹ä¾¿åœ°æŸ¥çœ‹ä½  Git ä»“åº“ä¸­çš„æäº¤ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%B7%A5%E5%85%B7-%E6%9F%A5%E7%9C%8B%E4%BF%AE%E8%AE%A2%E7%89%88%E6%9C%AC/:6:3","tags":["Git"],"title":"Gitå·¥å…·-æŸ¥çœ‹ä¿®è®¢ç‰ˆæœ¬","uri":"/posts/git%E5%B7%A5%E5%85%B7-%E6%9F%A5%E7%9C%8B%E4%BF%AE%E8%AE%A2%E7%89%88%E6%9C%AC/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"Gitå·¥å…·-äº¤äº’å¼æš‚å­˜ æœ¬èŠ‚ä¸­çš„å‡ ä¸ªäº¤äº’å¼ Git å‘½ä»¤å¯ä»¥å¸®åŠ©ä½ å°†æ–‡ä»¶çš„ç‰¹å®šéƒ¨åˆ†ç»„åˆæˆæäº¤ã€‚ å½“ä½ åœ¨ä¿®æ”¹äº†å¤§é‡æ–‡ä»¶åï¼Œå¸Œæœ›è¿™äº›æ”¹åŠ¨èƒ½æ‹†åˆ†ä¸ºè‹¥å¹²æäº¤è€Œä¸æ˜¯æ··æ‚åœ¨ä¸€èµ·æˆä¸ºä¸€ä¸ªæäº¤æ—¶ï¼Œè¿™å‡ ä¸ªå·¥å…·ä¼šéå¸¸æœ‰ç”¨ã€‚ é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå¯ä»¥ç¡®ä¿æäº¤æ˜¯é€»è¾‘ä¸Šç‹¬ç«‹çš„å˜æ›´é›†ï¼ŒåŒæ—¶ä¹Ÿä¼šä½¿å…¶ä»–å¼€å‘è€…åœ¨ä¸ä½ å·¥ä½œæ—¶å¾ˆå®¹æ˜“åœ°å®¡æ ¸ã€‚ å¦‚æœè¿è¡Œ git add æ—¶ä½¿ç”¨ -i æˆ–è€… --interactive é€‰é¡¹ï¼ŒGit å°†ä¼šè¿›å…¥ä¸€ä¸ªäº¤äº’å¼ç»ˆç«¯æ¨¡å¼ï¼Œæ˜¾ç¤ºç±»ä¼¼ä¸‹é¢çš„ä¸œè¥¿ï¼š $ git add -i staged unstaged path 1: unchanged +0/-1 TODO 2: unchanged +1/-1 index.html 3: unchanged +5/-1 lib/simplegit.rb *** Commands *** 1: [s]tatus 2: [u]pdate 3: [r]evert 4: [a]dd untracked 5: [p]atch 6: [d]iff 7: [q]uit 8: [h]elp What now\u003e å¯ä»¥çœ‹åˆ°è¿™ä¸ªå‘½ä»¤ä»¥å’Œå¹³æ—¶éå¸¸ä¸åŒçš„è§†å›¾æ˜¾ç¤ºäº†æš‚å­˜åŒºâ€”â€”åŸºæœ¬ä¸Šä¸ git status æ˜¯ç›¸åŒçš„ä¿¡æ¯ï¼Œä½†æ˜¯æ›´ç®€æ˜æ‰¼è¦ä¸€äº›ã€‚ å®ƒå°†æš‚å­˜çš„ä¿®æ”¹åˆ—åœ¨å·¦ä¾§ï¼Œæœªæš‚å­˜çš„ä¿®æ”¹åˆ—åœ¨å³ä¾§ã€‚ åœ¨è¿™å—åŒºåŸŸåæ˜¯â€œCommandsâ€å‘½ä»¤åŒºåŸŸã€‚ åœ¨è¿™é‡Œä½ å¯ä»¥åšä¸€äº›å·¥ä½œï¼ŒåŒ…æ‹¬æš‚å­˜æ–‡ä»¶ã€å–æ¶ˆæš‚å­˜æ–‡ä»¶ã€æš‚å­˜æ–‡ä»¶çš„ä¸€éƒ¨åˆ†ã€æ·»åŠ æœªè¢«è¿½è¸ªçš„æ–‡ä»¶ã€æ˜¾ç¤ºæš‚å­˜å†…å®¹çš„åŒºåˆ«ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%B7%A5%E5%85%B7-%E4%BA%A4%E4%BA%92%E5%BC%8F%E6%9A%82%E5%AD%98/:0:0","tags":["Git"],"title":"Gitå·¥å…·-äº¤äº’å¼æš‚å­˜","uri":"/posts/git%E5%B7%A5%E5%85%B7-%E4%BA%A4%E4%BA%92%E5%BC%8F%E6%9A%82%E5%AD%98/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"æš‚å­˜ä¸å–æ¶ˆæš‚å­˜æ–‡ä»¶ å¦‚æœåœ¨ What now\u003e æç¤ºç¬¦åé”®å…¥ u æˆ– 2ï¼ˆæ›´æ–°ï¼‰ï¼Œå®ƒä¼šé—®ä½ æƒ³è¦æš‚å­˜å“ªä¸ªæ–‡ä»¶ï¼š What now\u003e u staged unstaged path 1: unchanged +0/-1 TODO 2: unchanged +1/-1 index.html 3: unchanged +5/-1 lib/simplegit.rb Update\u003e\u003e è¦æš‚å­˜ TODO å’Œ index.html æ–‡ä»¶ï¼Œå¯ä»¥è¾“å…¥æ•°å­—ï¼š Update\u003e\u003e 1,2 staged unstaged path * 1: unchanged +0/-1 TODO * 2: unchanged +1/-1 index.html 3: unchanged +5/-1 lib/simplegit.rb Update\u003e\u003e æ¯ä¸ªæ–‡ä»¶å‰é¢çš„ * æ„å‘³ç€é€‰ä¸­çš„æ–‡ä»¶å°†ä¼šè¢«æš‚å­˜ã€‚ å¦‚æœåœ¨ Update\u003e\u003e æç¤ºç¬¦åä¸è¾“å…¥ä»»ä½•ä¸œè¥¿å¹¶ç›´æ¥æŒ‰å›è½¦ï¼ŒGit å°†ä¼šæš‚å­˜ä¹‹å‰é€‰æ‹©çš„æ–‡ä»¶ï¼š Update\u003e\u003e updated 2 paths *** Commands *** 1: [s]tatus 2: [u]pdate 3: [r]evert 4: [a]dd untracked 5: [p]atch 6: [d]iff 7: [q]uit 8: [h]elp What now\u003e s staged unstaged path 1: +0/-1 nothing TODO 2: +1/-1 nothing index.html 3: unchanged +5/-1 lib/simplegit.rb ç°åœ¨å¯ä»¥çœ‹åˆ° TODO ä¸ index.html æ–‡ä»¶å·²ç»è¢«æš‚å­˜è€Œ simplegit.rb æ–‡ä»¶è¿˜æœªè¢«æš‚å­˜ã€‚ å¦‚æœè¿™æ—¶æƒ³è¦å–æ¶ˆæš‚å­˜ TODO æ–‡ä»¶ï¼Œä½¿ç”¨ r æˆ– 3ï¼ˆæ’¤æ¶ˆï¼‰é€‰é¡¹ï¼š *** Commands *** 1: [s]tatus 2: [u]pdate 3: [r]evert 4: [a]dd untracked 5: [p]atch 6: [d]iff 7: [q]uit 8: [h]elp What now\u003e r staged unstaged path 1: +0/-1 nothing TODO 2: +1/-1 nothing index.html 3: unchanged +5/-1 lib/simplegit.rb Revert\u003e\u003e 1 staged unstaged path * 1: +0/-1 nothing TODO 2: +1/-1 nothing index.html 3: unchanged +5/-1 lib/simplegit.rb Revert\u003e\u003e [enter] reverted one path å†æ¬¡æŸ¥çœ‹ Git çŠ¶æ€ï¼Œå¯ä»¥çœ‹åˆ°å·²ç»å–æ¶ˆæš‚å­˜ TODO æ–‡ä»¶ï¼š *** Commands *** 1: [s]tatus 2: [u]pdate 3: [r]evert 4: [a]dd untracked 5: [p]atch 6: [d]iff 7: [q]uit 8: [h]elp What now\u003e s staged unstaged path 1: unchanged +0/-1 TODO 2: +1/-1 nothing index.html 3: unchanged +5/-1 lib/simplegit.rb å¦‚æœæƒ³è¦æŸ¥çœ‹å·²æš‚å­˜å†…å®¹çš„åŒºåˆ«ï¼Œå¯ä»¥ä½¿ç”¨ d æˆ– 6ï¼ˆåŒºåˆ«ï¼‰å‘½ä»¤ã€‚ å®ƒä¼šæ˜¾ç¤ºæš‚å­˜æ–‡ä»¶çš„ä¸€ä¸ªåˆ—è¡¨ï¼Œå¯ä»¥ä»ä¸­é€‰æ‹©æƒ³è¦æŸ¥çœ‹çš„æš‚å­˜åŒºåˆ«ã€‚ è¿™è·Ÿä½ åœ¨å‘½ä»¤è¡ŒæŒ‡å®š git diff --cached éå¸¸ç›¸ä¼¼ï¼š *** Commands *** 1: [s]tatus 2: [u]pdate 3: [r]evert 4: [a]dd untracked 5: [p]atch 6: [d]iff 7: [q]uit 8: [h]elp What now\u003e d staged unstaged path 1: +1/-1 nothing index.html Review diff\u003e\u003e 1 diff --git a/index.html b/index.html index 4d07108..4335f49 100644 --- a/index.html +++ b/index.html @@ -16,7 +16,7 @@ Date Finder \u003cp id=\"out\"\u003e...\u003c/p\u003e -\u003cdiv id=\"footer\"\u003econtact : support@github.com\u003c/div\u003e +\u003cdiv id=\"footer\"\u003econtact : email.support@github.com\u003c/div\u003e \u003cscript type=\"text/javascript\"\u003e é€šè¿‡è¿™äº›åŸºæœ¬å‘½ä»¤ï¼Œå¯ä»¥ä½¿ç”¨äº¤äº’å¼æ·»åŠ æ¨¡å¼æ¥è½»æ¾åœ°å¤„ç†æš‚å­˜åŒºã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%B7%A5%E5%85%B7-%E4%BA%A4%E4%BA%92%E5%BC%8F%E6%9A%82%E5%AD%98/:1:0","tags":["Git"],"title":"Gitå·¥å…·-äº¤äº’å¼æš‚å­˜","uri":"/posts/git%E5%B7%A5%E5%85%B7-%E4%BA%A4%E4%BA%92%E5%BC%8F%E6%9A%82%E5%AD%98/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"æš‚å­˜è¡¥ä¸ Git ä¹Ÿå¯ä»¥æš‚å­˜æ–‡ä»¶çš„ç‰¹å®šéƒ¨åˆ†ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœåœ¨ simplegit.rb æ–‡ä»¶ä¸­åšäº†ä¸¤å¤„ä¿®æ”¹ï¼Œä½†åªæƒ³è¦æš‚å­˜å…¶ä¸­çš„ä¸€ä¸ªè€Œä¸æ˜¯å¦ä¸€ä¸ªï¼ŒGit ä¼šå¸®ä½ è½»æ¾åœ°å®Œæˆã€‚ åœ¨å’Œä¸Šä¸€èŠ‚ä¸€æ ·çš„äº¤äº’å¼æç¤ºç¬¦ä¸­ï¼Œè¾“å…¥ p æˆ– 5ï¼ˆè¡¥ä¸ï¼‰ã€‚ Git ä¼šè¯¢é—®ä½ æƒ³è¦éƒ¨åˆ†æš‚å­˜å“ªäº›æ–‡ä»¶ï¼›ç„¶åï¼Œå¯¹å·²é€‰æ‹©æ–‡ä»¶çš„æ¯ä¸€ä¸ªéƒ¨åˆ†ï¼Œå®ƒéƒ½ä¼šä¸€ä¸ªä¸ªåœ°æ˜¾ç¤ºæ–‡ä»¶åŒºåˆ«å¹¶è¯¢é—®ä½ æ˜¯å¦æƒ³è¦æš‚å­˜å®ƒä»¬ï¼š diff --git a/lib/simplegit.rb b/lib/simplegit.rb index dd5ecc4..57399e0 100644 --- a/lib/simplegit.rb +++ b/lib/simplegit.rb @@ -22,7 +22,7 @@ class SimpleGit end def log(treeish = 'master') - command(\"git log -n 25 #{treeish}\") + command(\"git log -n 30 #{treeish}\") end def blame(path) Stage this hunk [y,n,a,d,/,j,J,g,e,?]? è¿™æ—¶æœ‰å¾ˆå¤šé€‰é¡¹ã€‚ è¾“å…¥ ? æ˜¾ç¤ºæ‰€æœ‰å¯ä»¥ä½¿ç”¨çš„å‘½ä»¤åˆ—è¡¨ï¼š Stage this hunk [y,n,a,d,/,j,J,g,e,?]? ? y - stage this hunk n - do not stage this hunk a - stage this and all the remaining hunks in the file d - do not stage this hunk nor any of the remaining hunks in the file g - select a hunk to go to / - search for a hunk matching the given regex j - leave this hunk undecided, see next undecided hunk J - leave this hunk undecided, see next hunk k - leave this hunk undecided, see previous undecided hunk K - leave this hunk undecided, see previous hunk s - split the current hunk into smaller hunks e - manually edit the current hunk ? - print help é€šå¸¸æƒ…å†µä¸‹å¯ä»¥è¾“å…¥ y æˆ– n æ¥é€‰æ‹©æ˜¯å¦è¦æš‚å­˜æ¯ä¸€ä¸ªåŒºå—ï¼Œ å½“ç„¶ï¼Œæš‚å­˜ç‰¹å®šæ–‡ä»¶ä¸­çš„æ‰€æœ‰éƒ¨åˆ†æˆ–ä¸ºä¹‹åçš„é€‰æ‹©è·³è¿‡ä¸€ä¸ªåŒºå—ä¹Ÿæ˜¯éå¸¸æœ‰ç”¨çš„ã€‚ å¦‚æœä½ åªæš‚å­˜æ–‡ä»¶çš„ä¸€éƒ¨åˆ†ï¼ŒçŠ¶æ€è¾“å‡ºå¯èƒ½ä¼šåƒä¸‹é¢è¿™æ ·ï¼š What now\u003e 1 staged unstaged path 1: unchanged +0/-1 TODO 2: +1/-1 nothing index.html 3: +1/-1 +4/-0 lib/simplegit.rb simplegit.rb æ–‡ä»¶çš„çŠ¶æ€å¾ˆæœ‰è¶£ã€‚ å®ƒæ˜¾ç¤ºå‡ºè‹¥å¹²è¡Œè¢«æš‚å­˜ä¸è‹¥å¹²è¡Œæœªè¢«æš‚å­˜ã€‚ å·²ç»éƒ¨åˆ†åœ°æš‚å­˜äº†è¿™ä¸ªæ–‡ä»¶ã€‚ åœ¨è¿™æ—¶ï¼Œå¯ä»¥é€€å‡ºäº¤äº’å¼æ·»åŠ è„šæœ¬å¹¶ä¸”è¿è¡Œ git commit æ¥æäº¤éƒ¨åˆ†æš‚å­˜çš„æ–‡ä»¶ã€‚ ä¹Ÿå¯ä»¥ä¸å¿…åœ¨äº¤äº’å¼æ·»åŠ æ¨¡å¼ä¸­åšéƒ¨åˆ†æ–‡ä»¶æš‚å­˜â€”â€”å¯ä»¥åœ¨å‘½ä»¤è¡Œä¸­ä½¿ç”¨ git add -p æˆ– git add --patch æ¥å¯åŠ¨åŒæ ·çš„è„šæœ¬ã€‚ æ›´è¿›ä¸€æ­¥åœ°ï¼Œå¯ä»¥ä½¿ç”¨ git reset --patch å‘½ä»¤çš„è¡¥ä¸æ¨¡å¼æ¥éƒ¨åˆ†é‡ç½®æ–‡ä»¶ï¼Œ é€šè¿‡ git checkout --patch å‘½ä»¤æ¥éƒ¨åˆ†æ£€å‡ºæ–‡ä»¶ä¸ git stash save --patch å‘½ä»¤æ¥éƒ¨åˆ†æš‚å­˜æ–‡ä»¶ã€‚ æˆ‘ä»¬å°†ä¼šåœ¨æ¥è§¦è¿™äº›å‘½ä»¤çš„é«˜çº§ä½¿ç”¨æ–¹æ³•æ—¶äº†è§£æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%B7%A5%E5%85%B7-%E4%BA%A4%E4%BA%92%E5%BC%8F%E6%9A%82%E5%AD%98/:2:0","tags":["Git"],"title":"Gitå·¥å…·-äº¤äº’å¼æš‚å­˜","uri":"/posts/git%E5%B7%A5%E5%85%B7-%E4%BA%A4%E4%BA%92%E5%BC%8F%E6%9A%82%E5%AD%98/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"Git å·¥å…· - é‡å†™å†å² è®¸å¤šæ—¶å€™ï¼Œåœ¨ä½¿ç”¨ Git æ—¶ï¼Œä½ å¯èƒ½æƒ³è¦ä¿®è®¢æäº¤å†å²ã€‚ Git å¾ˆæ£’çš„ä¸€ç‚¹æ˜¯å®ƒå…è®¸ä½ åœ¨æœ€åæ—¶åˆ»åšå†³å®šã€‚ ä½ å¯ä»¥åœ¨å°†æš‚å­˜åŒºå†…å®¹æäº¤å‰å†³å®šå“ªäº›æ–‡ä»¶è¿›å…¥æäº¤ï¼Œå¯ä»¥é€šè¿‡ git stash æ¥å†³å®šä¸ä¸æŸäº›å†…å®¹å·¥ä½œï¼Œ ä¹Ÿå¯ä»¥é‡å†™å·²ç»å‘ç”Ÿçš„æäº¤å°±åƒå®ƒä»¬ä»¥å¦ä¸€ç§æ–¹å¼å‘ç”Ÿçš„ä¸€æ ·ã€‚ è¿™å¯èƒ½æ¶‰åŠæ”¹å˜æäº¤çš„é¡ºåºï¼Œæ”¹å˜æäº¤ä¸­çš„ä¿¡æ¯æˆ–ä¿®æ”¹æ–‡ä»¶ï¼Œå°†æäº¤å‹ç¼©æˆ–æ˜¯æ‹†åˆ†ï¼Œ æˆ–å®Œå…¨åœ°ç§»é™¤æäº¤â€”â€”åœ¨å°†ä½ çš„å·¥ä½œæˆæœä¸ä»–äººå…±äº«ä¹‹å‰ã€‚ åœ¨æœ¬èŠ‚ä¸­ï¼Œä½ å¯ä»¥å­¦åˆ°å¦‚ä½•å®Œæˆè¿™äº›å·¥ä½œï¼Œè¿™æ ·åœ¨ä¸ä»–äººåˆ†äº«ä½ çš„å·¥ä½œæˆæœæ—¶ä½ çš„æäº¤å†å²å°†å¦‚ä½ æ‰€æ„¿åœ°å±•ç¤ºå‡ºæ¥ã€‚ Note åœ¨æ»¡æ„ä¹‹å‰ä¸è¦æ¨é€ä½ çš„å·¥ä½œGit çš„åŸºæœ¬åŸåˆ™ä¹‹ä¸€æ˜¯ï¼Œç”±äºå…‹éš†ä¸­æœ‰å¾ˆå¤šå·¥ä½œæ˜¯æœ¬åœ°çš„ï¼Œå› æ­¤ä½ å¯ä»¥ åœ¨æœ¬åœ° éšä¾¿é‡å†™å†å²è®°å½•ã€‚ ç„¶è€Œä¸€æ—¦æ¨é€äº†ä½ çš„å·¥ä½œï¼Œé‚£å°±å®Œå…¨æ˜¯å¦ä¸€å›äº‹äº†ï¼Œé™¤éä½ æœ‰å……åˆ†çš„ç†ç”±è¿›è¡Œæ›´æ”¹ï¼Œå¦åˆ™åº”è¯¥å°†æ¨é€çš„å·¥ä½œè§†ä¸ºæœ€ç»ˆç»“æœã€‚ ç®€è€Œè¨€ä¹‹ï¼Œåœ¨å¯¹å®ƒæ„Ÿåˆ°æ»¡æ„å¹¶å‡†å¤‡ä¸ä»–äººåˆ†äº«ä¹‹å‰ï¼Œåº”å½“é¿å…æ¨é€ä½ çš„å·¥ä½œã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E5%86%99%E5%8E%86%E5%8F%B2/:0:0","tags":["Git"],"title":"Gitå·¥å…·-é‡å†™å†å²","uri":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E5%86%99%E5%8E%86%E5%8F%B2/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"ä¿®æ”¹æœ€åä¸€æ¬¡æäº¤ ä¿®æ”¹ä½ æœ€è¿‘ä¸€æ¬¡æäº¤å¯èƒ½æ˜¯æ‰€æœ‰ä¿®æ”¹å†å²æäº¤çš„æ“ä½œä¸­æœ€å¸¸è§çš„ä¸€ä¸ªã€‚ å¯¹äºä½ çš„æœ€è¿‘ä¸€æ¬¡æäº¤ï¼Œä½ å¾€å¾€æƒ³åšä¸¤ä»¶äº‹æƒ…ï¼šç®€å•åœ°ä¿®æ”¹æäº¤ä¿¡æ¯ï¼Œ æˆ–è€…é€šè¿‡æ·»åŠ ã€ç§»é™¤æˆ–ä¿®æ”¹æ–‡ä»¶æ¥æ›´æ”¹æäº¤å®é™…çš„å†…å®¹ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E5%86%99%E5%8E%86%E5%8F%B2/:1:0","tags":["Git"],"title":"Gitå·¥å…·-é‡å†™å†å²","uri":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E5%86%99%E5%8E%86%E5%8F%B2/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"ä¿®æ”¹æäº¤ä¿¡æ¯ å¦‚æœï¼Œä½ åªæ˜¯æƒ³ä¿®æ”¹æœ€è¿‘ä¸€æ¬¡æäº¤çš„æäº¤ä¿¡æ¯ï¼Œé‚£ä¹ˆå¾ˆç®€å•ï¼š $ git commit --amend ä¸Šé¢è¿™æ¡å‘½ä»¤ä¼šå°†æœ€åä¸€æ¬¡çš„æäº¤ä¿¡æ¯è½½å…¥åˆ°ç¼–è¾‘å™¨ä¸­ä¾›ä½ ä¿®æ”¹ã€‚ å½“ä¿å­˜å¹¶å…³é—­ç¼–è¾‘å™¨åï¼Œç¼–è¾‘å™¨ä¼šå°†æ›´æ–°åçš„æäº¤ä¿¡æ¯å†™å…¥æ–°æäº¤ä¸­ï¼Œå®ƒä¼šæˆä¸ºæ–°çš„æœ€åä¸€æ¬¡æäº¤ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E5%86%99%E5%8E%86%E5%8F%B2/:1:1","tags":["Git"],"title":"Gitå·¥å…·-é‡å†™å†å²","uri":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E5%86%99%E5%8E%86%E5%8F%B2/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"ä¿®æ”¹å®é™…å†…å®¹ å¦ä¸€æ–¹é¢ï¼Œå¦‚æœä½ æƒ³è¦ä¿®æ”¹æœ€åä¸€æ¬¡æäº¤çš„å®é™…å†…å®¹ï¼Œé‚£ä¹ˆæµç¨‹å¾ˆç›¸ä¼¼ï¼šé¦–å…ˆä½œå‡ºä½ æƒ³è¦è¡¥ä¸Šçš„ä¿®æ”¹ï¼Œ æš‚å­˜å®ƒä»¬ï¼Œç„¶åç”¨ git commit --amend ä»¥æ–°çš„æ”¹è¿›åçš„æäº¤æ¥ æ›¿æ¢ æ‰æ—§æœ‰çš„æœ€åä¸€æ¬¡æäº¤ï¼Œ ä½¿ç”¨è¿™ä¸ªæŠ€å·§çš„æ—¶å€™éœ€è¦å°å¿ƒï¼Œå› ä¸ºä¿®æ­£ä¼šæ”¹å˜æäº¤çš„ SHA-1 æ ¡éªŒå’Œã€‚ å®ƒç±»ä¼¼äºä¸€ä¸ªå°çš„å˜åŸºâ€”â€”å¦‚æœå·²ç»æ¨é€äº†æœ€åä¸€æ¬¡æäº¤å°±ä¸è¦ä¿®æ­£å®ƒã€‚ Tip ä¿®è¡¥åçš„æäº¤å¯èƒ½éœ€è¦ä¿®è¡¥æäº¤ä¿¡æ¯å½“ä½ åœ¨ä¿®è¡¥ä¸€æ¬¡æäº¤æ—¶ï¼Œå¯ä»¥åŒæ—¶ä¿®æ”¹æäº¤ä¿¡æ¯å’Œæäº¤å†…å®¹ã€‚ å¦‚æœä½ ä¿®è¡¥äº†æäº¤çš„å†…å®¹ï¼Œé‚£ä¹ˆå‡ ä¹è‚¯å®šè¦æ›´æ–°æäº¤æ¶ˆæ¯ä»¥åæ˜ ä¿®æ”¹åçš„å†…å®¹ã€‚å¦ä¸€æ–¹é¢ï¼Œå¦‚æœä½ çš„ä¿®è¡¥æ˜¯çç¢çš„ï¼ˆå¦‚ä¿®æ”¹äº†ä¸€ä¸ªç¬”è¯¯æˆ–æ·»åŠ äº†ä¸€ä¸ªå¿˜è®°æš‚å­˜çš„æ–‡ä»¶ï¼‰ï¼Œ é‚£ä¹ˆä¹‹å‰çš„æäº¤ä¿¡æ¯ä¸å¿…ä¿®æ”¹ï¼Œä½ åªéœ€ä½œå‡ºæ›´æ”¹ï¼Œæš‚å­˜å®ƒä»¬ï¼Œç„¶åé€šè¿‡ä»¥ä¸‹å‘½ä»¤é¿å…ä¸å¿…è¦çš„ç¼–è¾‘å™¨ç¯èŠ‚å³å¯ï¼š$ git commit --amend --no-edit ","date":"2020-11-18","objectID":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E5%86%99%E5%8E%86%E5%8F%B2/:1:2","tags":["Git"],"title":"Gitå·¥å…·-é‡å†™å†å²","uri":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E5%86%99%E5%8E%86%E5%8F%B2/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"ä¿®æ”¹å¤šä¸ªæäº¤ä¿¡æ¯ ä¸ºäº†ä¿®æ”¹åœ¨æäº¤å†å²ä¸­è¾ƒè¿œçš„æäº¤ï¼Œå¿…é¡»ä½¿ç”¨æ›´å¤æ‚çš„å·¥å…·ã€‚ Git æ²¡æœ‰ä¸€ä¸ªæ”¹å˜å†å²å·¥å…·ï¼Œä½†æ˜¯å¯ä»¥ä½¿ç”¨å˜åŸºå·¥å…·æ¥å˜åŸºä¸€ç³»åˆ—æäº¤ï¼ŒåŸºäºå®ƒä»¬åŸæ¥çš„ HEAD è€Œä¸æ˜¯å°†å…¶ç§»åŠ¨åˆ°å¦ä¸€ä¸ªæ–°çš„ä¸Šé¢ã€‚ é€šè¿‡äº¤äº’å¼å˜åŸºå·¥å…·ï¼Œå¯ä»¥åœ¨ä»»ä½•æƒ³è¦ä¿®æ”¹çš„æäº¤ååœæ­¢ï¼Œç„¶åä¿®æ”¹ä¿¡æ¯ã€æ·»åŠ æ–‡ä»¶æˆ–åšä»»ä½•æƒ³åšçš„äº‹æƒ…ã€‚ å¯ä»¥é€šè¿‡ç»™ git rebase å¢åŠ  -i é€‰é¡¹æ¥äº¤äº’å¼åœ°è¿è¡Œå˜åŸºã€‚ å¿…é¡»æŒ‡å®šæƒ³è¦é‡å†™å¤šä¹…è¿œçš„å†å²ï¼Œè¿™å¯ä»¥é€šè¿‡å‘Šè¯‰å‘½ä»¤å°†è¦å˜åŸºåˆ°çš„æäº¤æ¥åšåˆ°ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœæƒ³è¦ä¿®æ”¹æœ€è¿‘ä¸‰æ¬¡æäº¤ä¿¡æ¯ï¼Œæˆ–è€…é‚£ç»„æäº¤ä¸­çš„ä»»æ„ä¸€ä¸ªæäº¤ä¿¡æ¯ï¼Œ å°†æƒ³è¦ä¿®æ”¹çš„æœ€è¿‘ä¸€æ¬¡æäº¤çš„çˆ¶æäº¤ä½œä¸ºå‚æ•°ä¼ é€’ç»™ git rebase -i å‘½ä»¤ï¼Œå³ HEAD~2^ æˆ– HEAD~3ã€‚ è®°ä½ ~3 å¯èƒ½æ¯”è¾ƒå®¹æ˜“ï¼Œå› ä¸ºä½ æ­£å°è¯•ä¿®æ”¹æœ€åä¸‰æ¬¡æäº¤ï¼›ä½†æ˜¯æ³¨æ„å®é™…ä¸ŠæŒ‡å®šäº†ä»¥å‰çš„å››æ¬¡æäº¤ï¼Œå³æƒ³è¦ä¿®æ”¹æäº¤çš„çˆ¶æäº¤ï¼š $ git rebase -i HEAD~3 å†æ¬¡è®°ä½è¿™æ˜¯ä¸€ä¸ªå˜åŸºå‘½ä»¤â€”â€”åœ¨ HEAD~3..HEAD èŒƒå›´å†…çš„æ¯ä¸€ä¸ªä¿®æ”¹äº†æäº¤ä¿¡æ¯çš„æäº¤åŠå…¶ æ‰€æœ‰åè£” éƒ½ä¼šè¢«é‡å†™ã€‚ ä¸è¦æ¶‰åŠä»»ä½•å·²ç»æ¨é€åˆ°ä¸­å¤®æœåŠ¡å™¨çš„æäº¤â€”â€”è¿™æ ·åšä¼šäº§ç”Ÿä¸€æ¬¡å˜æ›´çš„ä¸¤ä¸ªç‰ˆæœ¬ï¼Œå› è€Œä½¿ä»–äººå›°æƒ‘ã€‚ è¿è¡Œè¿™ä¸ªå‘½ä»¤ä¼šåœ¨æ–‡æœ¬ç¼–è¾‘å™¨ä¸Šç»™ä½ ä¸€ä¸ªæäº¤çš„åˆ—è¡¨ï¼Œçœ‹èµ·æ¥åƒä¸‹é¢è¿™æ ·ï¼š pick f7f3f6d changed my name a bit pick 310154e updated README formatting and added blame pick a5f4a0d added cat-file # Rebase 710f0f8..a5f4a0d onto 710f0f8 # # Commands: # p, pick \u003ccommit\u003e = use commit # r, reword \u003ccommit\u003e = use commit, but edit the commit message # e, edit \u003ccommit\u003e = use commit, but stop for amending # s, squash \u003ccommit\u003e = use commit, but meld into previous commit # f, fixup \u003ccommit\u003e = like \"squash\", but discard this commit's log message # x, exec \u003ccommand\u003e = run command (the rest of the line) using shell # b, break = stop here (continue rebase later with 'git rebase --continue') # d, drop \u003ccommit\u003e = remove commit # l, label \u003clabel\u003e = label current HEAD with a name # t, reset \u003clabel\u003e = reset HEAD to a label # m, merge [-C \u003ccommit\u003e | -c \u003ccommit\u003e] \u003clabel\u003e [# \u003coneline\u003e] # . create a merge commit using the original merge commit's # . message (or the oneline, if no original merge commit was # . specified). Use -c \u003ccommit\u003e to reword the commit message. # # These lines can be re-ordered; they are executed from top to bottom. # # If you remove a line here THAT COMMIT WILL BE LOST. # # However, if you remove everything, the rebase will be aborted. # # Note that empty commits are commented out éœ€è¦é‡ç‚¹æ³¨æ„çš„æ˜¯ç›¸å¯¹äºæ­£å¸¸ä½¿ç”¨çš„ log å‘½ä»¤ï¼Œè¿™äº›æäº¤æ˜¾ç¤ºçš„é¡ºåºæ˜¯ç›¸åçš„ã€‚ è¿è¡Œä¸€æ¬¡ log å‘½ä»¤ï¼Œä¼šçœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„ä¸œè¥¿ï¼š $ git log --pretty=format:\"%h %s\" HEAD~3..HEAD a5f4a0d added cat-file 310154e updated README formatting and added blame f7f3f6d changed my name a bit æ³¨æ„å…¶ä¸­çš„ååºæ˜¾ç¤ºã€‚ äº¤äº’å¼å˜åŸºç»™ä½ ä¸€ä¸ªå®ƒå°†ä¼šè¿è¡Œçš„è„šæœ¬ã€‚ å®ƒå°†ä¼šä»ä½ åœ¨å‘½ä»¤è¡Œä¸­æŒ‡å®šçš„æäº¤ï¼ˆHEAD~3ï¼‰å¼€å§‹ï¼Œä»ä¸Šåˆ°ä¸‹çš„ä¾æ¬¡é‡æ¼”æ¯ä¸€ä¸ªæäº¤å¼•å…¥çš„ä¿®æ”¹ã€‚ å®ƒå°†æœ€æ—§çš„è€Œä¸æ˜¯æœ€æ–°çš„åˆ—åœ¨ä¸Šé¢ï¼Œå› ä¸ºé‚£ä¼šæ˜¯ç¬¬ä¸€ä¸ªå°†è¦é‡æ¼”çš„ã€‚ ä½ éœ€è¦ä¿®æ”¹è„šæœ¬æ¥è®©å®ƒåœç•™åœ¨ä½ æƒ³ä¿®æ”¹çš„å˜æ›´ä¸Šã€‚ è¦è¾¾åˆ°è¿™ä¸ªç›®çš„ï¼Œä½ åªè¦å°†ä½ æƒ³ä¿®æ”¹çš„æ¯ä¸€æ¬¡æäº¤å‰é¢çš„ â€˜pickâ€™ æ”¹ä¸º â€˜editâ€™ã€‚ ä¾‹å¦‚ï¼Œåªæƒ³ä¿®æ”¹ç¬¬ä¸‰æ¬¡æäº¤ä¿¡æ¯ï¼Œå¯ä»¥åƒä¸‹é¢è¿™æ ·ä¿®æ”¹æ–‡ä»¶ï¼š edit f7f3f6d changed my name a bit pick 310154e updated README formatting and added blame pick a5f4a0d added cat-file å½“ä¿å­˜å¹¶é€€å‡ºç¼–è¾‘å™¨æ—¶ï¼ŒGit å°†ä½ å¸¦å›åˆ°åˆ—è¡¨ä¸­çš„æœ€åä¸€æ¬¡æäº¤ï¼ŒæŠŠä½ é€å›å‘½ä»¤è¡Œå¹¶æç¤ºä»¥ä¸‹ä¿¡æ¯ï¼š $ git rebase -i HEAD~3 Stopped at f7f3f6d... changed my name a bit You can amend the commit now, with git commit --amend Once you're satisfied with your changes, run git rebase --continue è¿™äº›æŒ‡ä»¤å‡†ç¡®åœ°å‘Šè¯‰ä½ è¯¥åšä»€ä¹ˆã€‚ è¾“å…¥ $ git commit --amend ä¿®æ”¹æäº¤ä¿¡æ¯ï¼Œç„¶åé€€å‡ºç¼–è¾‘å™¨ã€‚ ç„¶åï¼Œè¿è¡Œ $ git rebase --continue è¿™ä¸ªå‘½ä»¤å°†ä¼šè‡ªåŠ¨åœ°åº”ç”¨å¦å¤–ä¸¤ä¸ªæäº¤ï¼Œç„¶åå°±å®Œæˆäº†ã€‚ å¦‚æœéœ€è¦å°†ä¸æ­¢ä¸€å¤„çš„ pick æ”¹ä¸º editï¼Œéœ€è¦åœ¨æ¯ä¸€ä¸ªä¿®æ”¹ä¸º edit çš„æäº¤ä¸Šé‡å¤è¿™äº›æ­¥éª¤ã€‚ æ¯ä¸€æ¬¡ï¼ŒGit å°†ä¼šåœæ­¢ï¼Œè®©ä½ ä¿®æ­£æäº¤ï¼Œç„¶åç»§ç»­ç›´åˆ°å®Œæˆã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E5%86%99%E5%8E%86%E5%8F%B2/:2:0","tags":["Git"],"title":"Gitå·¥å…·-é‡å†™å†å²","uri":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E5%86%99%E5%8E%86%E5%8F%B2/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"é‡æ–°æ’åºæäº¤ ä¹Ÿå¯ä»¥ä½¿ç”¨äº¤äº’å¼å˜åŸºæ¥é‡æ–°æ’åºæˆ–å®Œå…¨ç§»é™¤æäº¤ã€‚ å¦‚æœæƒ³è¦ç§»é™¤ â€œadded cat-fileâ€ æäº¤ç„¶åä¿®æ”¹å¦å¤–ä¸¤ä¸ªæäº¤å¼•å…¥çš„é¡ºåºï¼Œå¯ä»¥å°†å˜åŸºè„šæœ¬ä»è¿™æ ·ï¼š pick f7f3f6d changed my name a bit pick 310154e updated README formatting and added blame pick a5f4a0d added cat-file æ”¹ä¸ºè¿™æ ·ï¼š pick 310154e updated README formatting and added blame pick f7f3f6d changed my name a bit å½“ä¿å­˜å¹¶é€€å‡ºç¼–è¾‘å™¨æ—¶ï¼ŒGit å°†ä½ çš„åˆ†æ”¯å¸¦å›è¿™äº›æäº¤çš„çˆ¶æäº¤ï¼Œåº”ç”¨ 310154e ç„¶ååº”ç”¨ f7f3f6dï¼Œæœ€ååœæ­¢ã€‚ äº‹å®ä¿®æ”¹äº†é‚£äº›æäº¤çš„é¡ºåºå¹¶å®Œå…¨åœ°ç§»é™¤äº† â€œadded cat-fileâ€ æäº¤ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E5%86%99%E5%8E%86%E5%8F%B2/:3:0","tags":["Git"],"title":"Gitå·¥å…·-é‡å†™å†å²","uri":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E5%86%99%E5%8E%86%E5%8F%B2/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"å‹ç¼©æäº¤ é€šè¿‡äº¤äº’å¼å˜åŸºå·¥å…·ï¼Œä¹Ÿå¯ä»¥å°†ä¸€è¿ä¸²æäº¤å‹ç¼©æˆä¸€ä¸ªå•ç‹¬çš„æäº¤ã€‚ åœ¨å˜åŸºä¿¡æ¯ä¸­è„šæœ¬ç»™å‡ºäº†æœ‰ç”¨çš„æŒ‡ä»¤ï¼š # # Commands: # p, pick \u003ccommit\u003e = use commit # r, reword \u003ccommit\u003e = use commit, but edit the commit message # e, edit \u003ccommit\u003e = use commit, but stop for amending # s, squash \u003ccommit\u003e = use commit, but meld into previous commit # f, fixup \u003ccommit\u003e = like \"squash\", but discard this commit's log message # x, exec \u003ccommand\u003e = run command (the rest of the line) using shell # b, break = stop here (continue rebase later with 'git rebase --continue') # d, drop \u003ccommit\u003e = remove commit # l, label \u003clabel\u003e = label current HEAD with a name # t, reset \u003clabel\u003e = reset HEAD to a label # m, merge [-C \u003ccommit\u003e | -c \u003ccommit\u003e] \u003clabel\u003e [# \u003coneline\u003e] # . create a merge commit using the original merge commit's # . message (or the oneline, if no original merge commit was # . specified). Use -c \u003ccommit\u003e to reword the commit message. # # These lines can be re-ordered; they are executed from top to bottom. # # If you remove a line here THAT COMMIT WILL BE LOST. # # However, if you remove everything, the rebase will be aborted. # # Note that empty commits are commented out å¦‚æœï¼ŒæŒ‡å®š â€œsquashâ€ è€Œä¸æ˜¯ â€œpickâ€ æˆ– â€œeditâ€ï¼ŒGit å°†åº”ç”¨ä¸¤è€…çš„ä¿®æ”¹å¹¶åˆå¹¶æäº¤ä¿¡æ¯åœ¨ä¸€èµ·ã€‚ æ‰€ä»¥ï¼Œå¦‚æœæƒ³è¦è¿™ä¸‰æ¬¡æäº¤å˜ä¸ºä¸€ä¸ªæäº¤ï¼Œå¯ä»¥è¿™æ ·ä¿®æ”¹è„šæœ¬ï¼š pick f7f3f6d changed my name a bit squash 310154e updated README formatting and added blame squash a5f4a0d added cat-file å½“ä¿å­˜å¹¶é€€å‡ºç¼–è¾‘å™¨æ—¶ï¼ŒGit åº”ç”¨æ‰€æœ‰çš„ä¸‰æ¬¡ä¿®æ”¹ç„¶åå°†ä½ æ”¾åˆ°ç¼–è¾‘å™¨ä¸­æ¥åˆå¹¶ä¸‰æ¬¡æäº¤ä¿¡æ¯ï¼š # This is a combination of 3 commits. # The first commit's message is: changed my name a bit # This is the 2nd commit message: updated README formatting and added blame # This is the 3rd commit message: added cat-file å½“ä½ ä¿å­˜ä¹‹åï¼Œä½ å°±æ‹¥æœ‰äº†ä¸€ä¸ªåŒ…å«å‰ä¸‰æ¬¡æäº¤çš„å…¨éƒ¨å˜æ›´çš„æäº¤ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E5%86%99%E5%8E%86%E5%8F%B2/:4:0","tags":["Git"],"title":"Gitå·¥å…·-é‡å†™å†å²","uri":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E5%86%99%E5%8E%86%E5%8F%B2/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"æ‹†åˆ†æäº¤ æ‹†åˆ†ä¸€ä¸ªæäº¤ä¼šæ’¤æ¶ˆè¿™ä¸ªæäº¤ï¼Œç„¶åå¤šæ¬¡åœ°éƒ¨åˆ†åœ°æš‚å­˜ä¸æäº¤ç›´åˆ°å®Œæˆä½ æ‰€éœ€æ¬¡æ•°çš„æäº¤ã€‚ ä¾‹å¦‚ï¼Œå‡è®¾æƒ³è¦æ‹†åˆ†ä¸‰æ¬¡æäº¤çš„ä¸­é—´é‚£æ¬¡æäº¤ã€‚ æƒ³è¦å°†å®ƒæ‹†åˆ†ä¸ºä¸¤æ¬¡æäº¤ï¼šç¬¬ä¸€ä¸ª â€œupdated README formattingâ€ï¼Œç¬¬äºŒä¸ª â€œadded blameâ€ æ¥ä»£æ›¿åŸæ¥çš„ â€œupdated README formatting and added blameâ€ã€‚ å¯ä»¥é€šè¿‡ä¿®æ”¹ rebase -i çš„è„šæœ¬æ¥åšåˆ°è¿™ç‚¹ï¼Œå°†è¦æ‹†åˆ†çš„æäº¤çš„æŒ‡ä»¤ä¿®æ”¹ä¸º â€œeditâ€ï¼š pick f7f3f6d changed my name a bit edit 310154e updated README formatting and added blame pick a5f4a0d added cat-file ç„¶åï¼Œå½“è„šæœ¬å¸¦ä½ è¿›å…¥åˆ°å‘½ä»¤è¡Œæ—¶ï¼Œé‡ç½®é‚£ä¸ªæäº¤ï¼Œæ‹¿åˆ°è¢«é‡ç½®çš„ä¿®æ”¹ï¼Œä»ä¸­åˆ›å»ºå‡ æ¬¡æäº¤ã€‚ å½“ä¿å­˜å¹¶é€€å‡ºç¼–è¾‘å™¨æ—¶ï¼ŒGit å¸¦ä½ åˆ°åˆ—è¡¨ä¸­ç¬¬ä¸€ä¸ªæäº¤çš„çˆ¶æäº¤ï¼Œåº”ç”¨ç¬¬ä¸€ä¸ªæäº¤ï¼ˆf7f3f6dï¼‰ï¼Œ åº”ç”¨ç¬¬äºŒä¸ªæäº¤ï¼ˆ310154eï¼‰ï¼Œç„¶åè®©ä½ è¿›å…¥å‘½ä»¤è¡Œã€‚ é‚£é‡Œï¼Œå¯ä»¥é€šè¿‡ git reset HEAD^ åšä¸€æ¬¡é’ˆå¯¹é‚£ä¸ªæäº¤çš„æ··åˆé‡ç½®ï¼Œå®é™…ä¸Šå°†ä¼šæ’¤æ¶ˆé‚£æ¬¡æäº¤å¹¶å°†ä¿®æ”¹çš„æ–‡ä»¶å–æ¶ˆæš‚å­˜ã€‚ ç°åœ¨å¯ä»¥æš‚å­˜å¹¶æäº¤æ–‡ä»¶ç›´åˆ°æœ‰å‡ ä¸ªæäº¤ï¼Œç„¶åå½“å®Œæˆæ—¶è¿è¡Œ git rebase --continueï¼š $ git reset HEAD^ $ git add README $ git commit -m 'updated README formatting' $ git add lib/simplegit.rb $ git commit -m 'added blame' $ git rebase --continue Git åœ¨è„šæœ¬ä¸­åº”ç”¨æœ€åä¸€æ¬¡æäº¤ï¼ˆa5f4a0dï¼‰ï¼Œå†å²è®°å½•çœ‹èµ·æ¥åƒè¿™æ ·ï¼š $ git log -4 --pretty=format:\"%h %s\" 1c002dd added cat-file 9b29157 added blame 35cfb2b updated README formatting f3cc40e changed my name a bit å†æ¬¡å¼ºè°ƒï¼Œè¿™äº›æ”¹åŠ¨äº†æ‰€æœ‰åœ¨åˆ—è¡¨ä¸­çš„æäº¤çš„ SHA-1 æ ¡éªŒå’Œï¼Œæ‰€ä»¥è¦ç¡®ä¿åˆ—è¡¨ä¸­çš„æäº¤è¿˜æ²¡æœ‰æ¨é€åˆ°å…±äº«ä»“åº“ä¸­ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E5%86%99%E5%8E%86%E5%8F%B2/:5:0","tags":["Git"],"title":"Gitå·¥å…·-é‡å†™å†å²","uri":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E5%86%99%E5%8E%86%E5%8F%B2/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"æ ¸æ­¦å™¨çº§é€‰é¡¹ï¼šfilter-branch æœ‰å¦ä¸€ä¸ªå†å²æ”¹å†™çš„é€‰é¡¹ï¼Œå¦‚æœæƒ³è¦é€šè¿‡è„šæœ¬çš„æ–¹å¼æ”¹å†™å¤§é‡æäº¤çš„è¯å¯ä»¥ä½¿ç”¨å®ƒâ€”â€”ä¾‹å¦‚ï¼Œå…¨å±€ä¿®æ”¹ä½ çš„é‚®ç®±åœ°å€æˆ–ä»æ¯ä¸€ä¸ªæäº¤ä¸­ç§»é™¤ä¸€ä¸ªæ–‡ä»¶ã€‚ è¿™ä¸ªå‘½ä»¤æ˜¯ filter-branchï¼Œå®ƒå¯ä»¥æ”¹å†™å†å²ä¸­å¤§é‡çš„æäº¤ï¼Œé™¤éä½ çš„é¡¹ç›®è¿˜æ²¡æœ‰å…¬å¼€å¹¶ä¸”å…¶ä»–äººæ²¡æœ‰åŸºäºè¦æ”¹å†™çš„å·¥ä½œçš„æäº¤åšçš„å·¥ä½œï¼Œå¦åˆ™ä½ ä¸åº”å½“ä½¿ç”¨å®ƒã€‚ ç„¶è€Œï¼Œå®ƒå¯ä»¥å¾ˆæœ‰ç”¨ã€‚ ä½ å°†ä¼šå­¦ä¹ åˆ°å‡ ä¸ªå¸¸ç”¨çš„ç”¨é€”ï¼Œè¿™æ ·å°±å¾—åˆ°äº†å®ƒé€‚åˆä½¿ç”¨åœ°æ–¹çš„æƒ³æ³•ã€‚ Caution git filter-branch æœ‰å¾ˆå¤šé™·é˜±ï¼Œä¸å†æ¨èä½¿ç”¨å®ƒæ¥é‡å†™å†å²ã€‚ è¯·è€ƒè™‘ä½¿ç”¨ git-filter-repoï¼Œå®ƒæ˜¯ä¸€ä¸ª Python è„šæœ¬ï¼Œç›¸æ¯”å¤§å¤šæ•°ä½¿ç”¨ filter-branch çš„åº”ç”¨æ¥è¯´ï¼Œå®ƒåšå¾—è¦æ›´å¥½ã€‚å®ƒçš„æ–‡æ¡£å’Œæºç å¯è®¿é—® https://github.com/newren/git-filter-repo è·å–ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E5%86%99%E5%8E%86%E5%8F%B2/:6:0","tags":["Git"],"title":"Gitå·¥å…·-é‡å†™å†å²","uri":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E5%86%99%E5%8E%86%E5%8F%B2/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"ä»æ¯ä¸€ä¸ªæäº¤ä¸­ç§»é™¤ä¸€ä¸ªæ–‡ä»¶ è¿™ç»å¸¸å‘ç”Ÿã€‚ æœ‰äººç²—å¿ƒåœ°é€šè¿‡ git add . æäº¤äº†ä¸€ä¸ªå·¨å¤§çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä½ æƒ³è¦ä»æ‰€æœ‰åœ°æ–¹åˆ é™¤ã€‚ å¯èƒ½å¶ç„¶åœ°æäº¤äº†ä¸€ä¸ªåŒ…æ‹¬ä¸€ä¸ªå¯†ç çš„æ–‡ä»¶ï¼Œç„¶è€Œä½ æƒ³è¦å¼€æºé¡¹ç›®ã€‚ filter-branch æ˜¯ä¸€ä¸ªå¯èƒ½ä¼šç”¨æ¥æ“¦æ´—æ•´ä¸ªæäº¤å†å²çš„å·¥å…·ã€‚ ä¸ºäº†ä»æ•´ä¸ªæäº¤å†å²ä¸­ç§»é™¤ä¸€ä¸ªå«åš passwords.txt çš„æ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ --tree-filter é€‰é¡¹ç»™ filter-branchï¼š $ git filter-branch --tree-filter 'rm -f passwords.txt' HEAD Rewrite 6b9b3cf04e7c5686a9cb838c3f36a8cb6a0fc2bd (21/21) Ref 'refs/heads/master' was rewritten --tree-filter é€‰é¡¹åœ¨æ£€å‡ºé¡¹ç›®çš„æ¯ä¸€ä¸ªæäº¤åè¿è¡ŒæŒ‡å®šçš„å‘½ä»¤ç„¶åé‡æ–°æäº¤ç»“æœã€‚ åœ¨æœ¬ä¾‹ä¸­ï¼Œä½ ä»æ¯ä¸€ä¸ªå¿«ç…§ä¸­ç§»é™¤äº†ä¸€ä¸ªå«ä½œ passwords.txt çš„æ–‡ä»¶ï¼Œæ— è®ºå®ƒæ˜¯å¦å­˜åœ¨ã€‚ å¦‚æœæƒ³è¦ç§»é™¤æ‰€æœ‰å¶ç„¶æäº¤çš„ç¼–è¾‘å™¨å¤‡ä»½æ–‡ä»¶ï¼Œå¯ä»¥è¿è¡Œç±»ä¼¼ git filter-branch --tree-filter 'rm -f *~' HEAD çš„å‘½ä»¤ã€‚ æœ€åå°†å¯ä»¥çœ‹åˆ° Git é‡å†™æ ‘ä¸æäº¤ç„¶åç§»åŠ¨åˆ†æ”¯æŒ‡é’ˆã€‚ é€šå¸¸ä¸€ä¸ªå¥½çš„æƒ³æ³•æ˜¯åœ¨ä¸€ä¸ªæµ‹è¯•åˆ†æ”¯ä¸­åšè¿™ä»¶äº‹ï¼Œç„¶åå½“ä½ å†³å®šæœ€ç»ˆç»“æœæ˜¯çœŸæ­£æƒ³è¦çš„ï¼Œå¯ä»¥ç¡¬é‡ç½® master åˆ†æ”¯ã€‚ ä¸ºäº†è®© filter-branch åœ¨æ‰€æœ‰åˆ†æ”¯ä¸Šè¿è¡Œï¼Œå¯ä»¥ç»™å‘½ä»¤ä¼ é€’ --all é€‰é¡¹ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E5%86%99%E5%8E%86%E5%8F%B2/:6:1","tags":["Git"],"title":"Gitå·¥å…·-é‡å†™å†å²","uri":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E5%86%99%E5%8E%86%E5%8F%B2/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"ä½¿ä¸€ä¸ªå­ç›®å½•åšä¸ºæ–°çš„æ ¹ç›®å½• å‡è®¾å·²ç»ä»å¦ä¸€ä¸ªæºä»£ç æ§åˆ¶ç³»ç»Ÿä¸­å¯¼å…¥ï¼Œå¹¶ä¸”æœ‰å‡ ä¸ªæ²¡æ„ä¹‰çš„å­ç›®å½•ï¼ˆtrunkã€tags ç­‰ç­‰ï¼‰ã€‚ å¦‚æœæƒ³è¦è®© trunk å­ç›®å½•ä½œä¸ºæ¯ä¸€ä¸ªæäº¤çš„æ–°çš„é¡¹ç›®æ ¹ç›®å½•ï¼Œfilter-branch ä¹Ÿå¯ä»¥å¸®åŠ©ä½ é‚£ä¹ˆåšï¼š $ git filter-branch --subdirectory-filter trunk HEAD Rewrite 856f0bf61e41a27326cdae8f09fe708d679f596f (12/12) Ref 'refs/heads/master' was rewritten ç°åœ¨æ–°é¡¹ç›®æ ¹ç›®å½•æ˜¯ trunk å­ç›®å½•äº†ã€‚ Git ä¼šè‡ªåŠ¨ç§»é™¤æ‰€æœ‰ä¸å½±å“å­ç›®å½•çš„æäº¤ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E5%86%99%E5%8E%86%E5%8F%B2/:6:2","tags":["Git"],"title":"Gitå·¥å…·-é‡å†™å†å²","uri":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E5%86%99%E5%8E%86%E5%8F%B2/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"å…¨å±€ä¿®æ”¹é‚®ç®±åœ°å€ å¦ä¸€ä¸ªå¸¸è§çš„æƒ…å½¢æ˜¯åœ¨ä½ å¼€å§‹å·¥ä½œæ—¶å¿˜è®°è¿è¡Œ git config æ¥è®¾ç½®ä½ çš„åå­—ä¸é‚®ç®±åœ°å€ï¼Œ æˆ–è€…ä½ æƒ³è¦å¼€æºä¸€ä¸ªé¡¹ç›®å¹¶ä¸”ä¿®æ”¹æ‰€æœ‰ä½ çš„å·¥ä½œé‚®ç®±åœ°å€ä¸ºä½ çš„ä¸ªäººé‚®ç®±åœ°å€ã€‚ ä»»ä½•æƒ…å½¢ä¸‹ï¼Œä½ ä¹Ÿå¯ä»¥é€šè¿‡ filter-branch æ¥ä¸€æ¬¡æ€§ä¿®æ”¹å¤šä¸ªæäº¤ä¸­çš„é‚®ç®±åœ°å€ã€‚ éœ€è¦å°å¿ƒçš„æ˜¯åªä¿®æ”¹ä½ è‡ªå·±çš„é‚®ç®±åœ°å€ï¼Œæ‰€ä»¥ä½ ä½¿ç”¨ --commit-filterï¼š $ git filter-branch --commit-filter ' if [ \"$GIT_AUTHOR_EMAIL\" = \"schacon@localhost\" ]; then GIT_AUTHOR_NAME=\"Scott Chacon\"; GIT_AUTHOR_EMAIL=\"schacon@example.com\"; git commit-tree \"$@\"; else git commit-tree \"$@\"; fi' HEAD è¿™ä¼šéå†å¹¶é‡å†™æ¯ä¸€ä¸ªæäº¤æ¥åŒ…å«ä½ çš„æ–°é‚®ç®±åœ°å€ã€‚ å› ä¸ºæäº¤åŒ…å«äº†å®ƒä»¬çˆ¶æäº¤çš„ SHA-1 æ ¡éªŒå’Œï¼Œè¿™ä¸ªå‘½ä»¤ä¼šä¿®æ”¹ä½ çš„å†å²ä¸­çš„æ¯ä¸€ä¸ªæäº¤çš„ SHA-1 æ ¡éªŒå’Œï¼Œ è€Œä¸ä»…ä»…åªæ˜¯é‚£äº›åŒ¹é…é‚®ç®±åœ°å€çš„æäº¤ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E5%86%99%E5%8E%86%E5%8F%B2/:6:3","tags":["Git"],"title":"Gitå·¥å…·-é‡å†™å†å²","uri":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E5%86%99%E5%8E%86%E5%8F%B2/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"Git å·¥å…· - é‡ç½®æ­å¯† åœ¨ç»§ç»­äº†è§£æ›´ä¸“ä¸šçš„å·¥å…·å‰ï¼Œæˆ‘ä»¬å…ˆæ¢è®¨ä¸€ä¸‹ Git çš„ reset å’Œ checkout å‘½ä»¤ã€‚ åœ¨åˆé‡çš„ Git å‘½ä»¤ä¸­ï¼Œè¿™ä¸¤ä¸ªæ˜¯æœ€è®©äººå›°æƒ‘çš„ã€‚ å®ƒä»¬èƒ½åšå¾ˆå¤šäº‹æƒ…ï¼Œæ‰€ä»¥çœ‹èµ·æ¥æˆ‘ä»¬å¾ˆéš¾çœŸæ­£åœ°ç†è§£å¹¶æ°å½“åœ°è¿ç”¨å®ƒä»¬ã€‚ é’ˆå¯¹è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å…ˆæ¥åšä¸€ä¸ªç®€å•çš„æ¯”å–»ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E7%BD%AE%E6%8F%AD%E5%AF%86/:0:0","tags":["Git"],"title":"Gitå·¥å…·-é‡ç½®æ­å¯†","uri":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E7%BD%AE%E6%8F%AD%E5%AF%86/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"ä¸‰æ£µæ ‘ ç†è§£ reset å’Œ checkout çš„æœ€ç®€æ–¹æ³•ï¼Œå°±æ˜¯ä»¥ Git çš„æ€ç»´æ¡†æ¶ï¼ˆå°†å…¶ä½œä¸ºå†…å®¹ç®¡ç†å™¨ï¼‰æ¥ç®¡ç†ä¸‰æ£µä¸åŒçš„æ ‘ã€‚ â€œæ ‘â€ åœ¨æˆ‘ä»¬è¿™é‡Œçš„å®é™…æ„æ€æ˜¯ â€œæ–‡ä»¶çš„é›†åˆâ€ï¼Œè€Œä¸æ˜¯æŒ‡ç‰¹å®šçš„æ•°æ®ç»“æ„ã€‚ ï¼ˆåœ¨æŸäº›æƒ…å†µä¸‹ç´¢å¼•çœ‹èµ·æ¥å¹¶ä¸åƒä¸€æ£µæ ‘ï¼Œä¸è¿‡æˆ‘ä»¬ç°åœ¨çš„ç›®çš„æ˜¯ç”¨ç®€å•çš„æ–¹å¼æ€è€ƒå®ƒã€‚ï¼‰ Git ä½œä¸ºä¸€ä¸ªç³»ç»Ÿï¼Œæ˜¯ä»¥å®ƒçš„ä¸€èˆ¬æ“ä½œæ¥ç®¡ç†å¹¶æ“çºµè¿™ä¸‰æ£µæ ‘çš„ï¼š æ ‘ ç”¨é€” HEAD ä¸Šä¸€æ¬¡æäº¤çš„å¿«ç…§ï¼Œä¸‹ä¸€æ¬¡æäº¤çš„çˆ¶ç»“ç‚¹ Index é¢„æœŸçš„ä¸‹ä¸€æ¬¡æäº¤çš„å¿«ç…§ Working Directory æ²™ç›’ ","date":"2020-11-18","objectID":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E7%BD%AE%E6%8F%AD%E5%AF%86/:1:0","tags":["Git"],"title":"Gitå·¥å…·-é‡ç½®æ­å¯†","uri":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E7%BD%AE%E6%8F%AD%E5%AF%86/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"HEAD HEAD æ˜¯å½“å‰åˆ†æ”¯å¼•ç”¨çš„æŒ‡é’ˆï¼Œå®ƒæ€»æ˜¯æŒ‡å‘è¯¥åˆ†æ”¯ä¸Šçš„æœ€åä¸€æ¬¡æäº¤ã€‚ è¿™è¡¨ç¤º HEAD å°†æ˜¯ä¸‹ä¸€æ¬¡æäº¤çš„çˆ¶ç»“ç‚¹ã€‚ é€šå¸¸ï¼Œç†è§£ HEAD çš„æœ€ç®€æ–¹å¼ï¼Œå°±æ˜¯å°†å®ƒçœ‹åš è¯¥åˆ†æ”¯ä¸Šçš„æœ€åä¸€æ¬¡æäº¤ çš„å¿«ç…§ã€‚ å…¶å®ï¼ŒæŸ¥çœ‹å¿«ç…§çš„æ ·å­å¾ˆå®¹æ˜“ã€‚ ä¸‹ä¾‹å°±æ˜¾ç¤ºäº† HEAD å¿«ç…§å®é™…çš„ç›®å½•åˆ—è¡¨ï¼Œä»¥åŠå…¶ä¸­æ¯ä¸ªæ–‡ä»¶çš„ SHA-1 æ ¡éªŒå’Œï¼š $ git cat-file -p HEAD tree cfda3bf379e4f8dba8717dee55aab78aef7f4daf author Scott Chacon 1301511835 -0700 committer Scott Chacon 1301511835 -0700 initial commit $ git ls-tree -r HEAD 100644 blob a906cb2a4a904a152... README 100644 blob 8f94139338f9404f2... Rakefile 040000 tree 99f1a6d12cb4b6f19... lib Git çš„ cat-file å’Œ ls-tree æ˜¯åº•å±‚å‘½ä»¤ï¼Œå®ƒä»¬ä¸€èˆ¬ç”¨äºåº•å±‚å·¥ä½œï¼Œåœ¨æ—¥å¸¸å·¥ä½œä¸­å¹¶ä¸ä½¿ç”¨ã€‚ ä¸è¿‡å®ƒä»¬èƒ½å¸®åŠ©æˆ‘ä»¬äº†è§£åˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E7%BD%AE%E6%8F%AD%E5%AF%86/:1:1","tags":["Git"],"title":"Gitå·¥å…·-é‡ç½®æ­å¯†","uri":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E7%BD%AE%E6%8F%AD%E5%AF%86/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"ç´¢å¼• ç´¢å¼•æ˜¯ä½ çš„ é¢„æœŸçš„ä¸‹ä¸€æ¬¡æäº¤ã€‚ æˆ‘ä»¬ä¹Ÿä¼šå°†è¿™ä¸ªæ¦‚å¿µå¼•ç”¨ä¸º Git çš„â€œæš‚å­˜åŒºâ€ï¼Œè¿™å°±æ˜¯å½“ä½ è¿è¡Œ git commit æ—¶ Git çœ‹èµ·æ¥çš„æ ·å­ã€‚ Git å°†ä¸Šä¸€æ¬¡æ£€å‡ºåˆ°å·¥ä½œç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶å¡«å……åˆ°ç´¢å¼•åŒºï¼Œå®ƒä»¬çœ‹èµ·æ¥å°±åƒæœ€åˆè¢«æ£€å‡ºæ—¶çš„æ ·å­ã€‚ ä¹‹åä½ ä¼šå°†å…¶ä¸­ä¸€äº›æ–‡ä»¶æ›¿æ¢ä¸ºæ–°ç‰ˆæœ¬ï¼Œæ¥ç€é€šè¿‡ git commit å°†å®ƒä»¬è½¬æ¢ä¸ºæ ‘æ¥ç”¨ä½œæ–°çš„æäº¤ã€‚ $ git ls-files -s 100644 a906cb2a4a904a152e80877d4088654daad0c859 0 README 100644 8f94139338f9404f26296befa88755fc2598c289 0 Rakefile 100644 47c6340d6459e05787f644c2447d2595f5d3a54b 0 lib/simplegit.rb å†è¯´ä¸€æ¬¡ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œåˆç”¨åˆ°äº† git ls-files è¿™ä¸ªå¹•åçš„å‘½ä»¤ï¼Œå®ƒä¼šæ˜¾ç¤ºå‡ºç´¢å¼•å½“å‰çš„æ ·å­ã€‚ ç¡®åˆ‡æ¥è¯´ï¼Œç´¢å¼•åœ¨æŠ€æœ¯ä¸Šå¹¶éæ ‘ç»“æ„ï¼Œå®ƒå…¶å®æ˜¯ä»¥æ‰å¹³çš„æ¸…å•å®ç°çš„ã€‚ä¸è¿‡å¯¹æˆ‘ä»¬è€Œè¨€ï¼ŒæŠŠå®ƒå½“åšæ ‘å°±å¤Ÿäº†ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E7%BD%AE%E6%8F%AD%E5%AF%86/:1:2","tags":["Git"],"title":"Gitå·¥å…·-é‡ç½®æ­å¯†","uri":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E7%BD%AE%E6%8F%AD%E5%AF%86/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"å·¥ä½œç›®å½• æœ€åï¼Œä½ å°±æœ‰äº†è‡ªå·±çš„ å·¥ä½œç›®å½•ï¼ˆé€šå¸¸ä¹Ÿå« å·¥ä½œåŒºï¼‰ã€‚ å¦å¤–ä¸¤æ£µæ ‘ä»¥ä¸€ç§é«˜æ•ˆä½†å¹¶ä¸ç›´è§‚çš„æ–¹å¼ï¼Œå°†å®ƒä»¬çš„å†…å®¹å­˜å‚¨åœ¨ .git æ–‡ä»¶å¤¹ä¸­ã€‚ å·¥ä½œç›®å½•ä¼šå°†å®ƒä»¬è§£åŒ…ä¸ºå®é™…çš„æ–‡ä»¶ä»¥ä¾¿ç¼–è¾‘ã€‚ ä½ å¯ä»¥æŠŠå·¥ä½œç›®å½•å½“åš æ²™ç›’ã€‚åœ¨ä½ å°†ä¿®æ”¹æäº¤åˆ°æš‚å­˜åŒºå¹¶è®°å½•åˆ°å†å²ä¹‹å‰ï¼Œå¯ä»¥éšæ„æ›´æ”¹ã€‚ $ tree . â”œâ”€â”€ README â”œâ”€â”€ Rakefile â””â”€â”€ lib â””â”€â”€ simplegit.rb 1 directory, 3 files ","date":"2020-11-18","objectID":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E7%BD%AE%E6%8F%AD%E5%AF%86/:1:3","tags":["Git"],"title":"Gitå·¥å…·-é‡ç½®æ­å¯†","uri":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E7%BD%AE%E6%8F%AD%E5%AF%86/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"å·¥ä½œæµç¨‹ ç»å…¸çš„ Git å·¥ä½œæµç¨‹æ˜¯é€šè¿‡æ“çºµè¿™ä¸‰ä¸ªåŒºåŸŸæ¥ä»¥æ›´åŠ è¿ç»­çš„çŠ¶æ€è®°å½•é¡¹ç›®å¿«ç…§çš„ã€‚ è®©æˆ‘ä»¬æ¥å¯è§†åŒ–è¿™ä¸ªè¿‡ç¨‹ï¼šå‡è®¾æˆ‘ä»¬è¿›å…¥åˆ°ä¸€ä¸ªæ–°ç›®å½•ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªæ–‡ä»¶ã€‚ æˆ‘ä»¬ç§°å…¶ä¸ºè¯¥æ–‡ä»¶çš„ v1 ç‰ˆæœ¬ï¼Œå°†å®ƒæ ‡è®°ä¸ºè“è‰²ã€‚ ç°åœ¨è¿è¡Œ git initï¼Œè¿™ä¼šåˆ›å»ºä¸€ä¸ª Git ä»“åº“ï¼Œå…¶ä¸­çš„ HEAD å¼•ç”¨æŒ‡å‘æœªåˆ›å»ºçš„ master åˆ†æ”¯ã€‚ æ­¤æ—¶ï¼Œåªæœ‰å·¥ä½œç›®å½•æœ‰å†…å®¹ã€‚ ç°åœ¨æˆ‘ä»¬æƒ³è¦æäº¤è¿™ä¸ªæ–‡ä»¶ï¼Œæ‰€ä»¥ç”¨ git add æ¥è·å–å·¥ä½œç›®å½•ä¸­çš„å†…å®¹ï¼Œå¹¶å°†å…¶å¤åˆ¶åˆ°ç´¢å¼•ä¸­ã€‚ æ¥ç€è¿è¡Œ git commitï¼Œå®ƒä¼šå–å¾—ç´¢å¼•ä¸­çš„å†…å®¹å¹¶å°†å®ƒä¿å­˜ä¸ºä¸€ä¸ªæ°¸ä¹…çš„å¿«ç…§ï¼Œ ç„¶ååˆ›å»ºä¸€ä¸ªæŒ‡å‘è¯¥å¿«ç…§çš„æäº¤å¯¹è±¡ï¼Œæœ€åæ›´æ–° master æ¥æŒ‡å‘æœ¬æ¬¡æäº¤ã€‚ æ­¤æ—¶å¦‚æœæˆ‘ä»¬è¿è¡Œ git statusï¼Œä¼šå‘ç°æ²¡æœ‰ä»»ä½•æ”¹åŠ¨ï¼Œå› ä¸ºç°åœ¨ä¸‰æ£µæ ‘å®Œå…¨ç›¸åŒã€‚ ç°åœ¨æˆ‘ä»¬æƒ³è¦å¯¹æ–‡ä»¶è¿›è¡Œä¿®æ”¹ç„¶åæäº¤å®ƒã€‚ æˆ‘ä»¬å°†ä¼šç»å†åŒæ ·çš„è¿‡ç¨‹ï¼›é¦–å…ˆåœ¨å·¥ä½œç›®å½•ä¸­ä¿®æ”¹æ–‡ä»¶ã€‚ æˆ‘ä»¬ç§°å…¶ä¸ºè¯¥æ–‡ä»¶çš„ v2 ç‰ˆæœ¬ï¼Œå¹¶å°†å®ƒæ ‡è®°ä¸ºçº¢è‰²ã€‚ å¦‚æœç°åœ¨è¿è¡Œ git statusï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°æ–‡ä»¶æ˜¾ç¤ºåœ¨ â€œChanges not staged for commitâ€ ä¸‹é¢å¹¶è¢«æ ‡è®°ä¸ºçº¢è‰²ï¼Œå› ä¸ºè¯¥æ¡ç›®åœ¨ç´¢å¼•ä¸å·¥ä½œç›®å½•ä¹‹é—´å­˜åœ¨ä¸åŒã€‚ æ¥ç€æˆ‘ä»¬è¿è¡Œ git add æ¥å°†å®ƒæš‚å­˜åˆ°ç´¢å¼•ä¸­ã€‚ æ­¤æ—¶ï¼Œç”±äºç´¢å¼•å’Œ HEAD ä¸åŒï¼Œè‹¥è¿è¡Œ git status çš„è¯å°±ä¼šçœ‹åˆ° â€œChanges to be committedâ€ ä¸‹çš„è¯¥æ–‡ä»¶å˜ä¸ºç»¿è‰² â€”â€”ä¹Ÿå°±æ˜¯è¯´ï¼Œç°åœ¨é¢„æœŸçš„ä¸‹ä¸€æ¬¡æäº¤ä¸ä¸Šä¸€æ¬¡æäº¤ä¸åŒã€‚ æœ€åï¼Œæˆ‘ä»¬è¿è¡Œ git commit æ¥å®Œæˆæäº¤ã€‚ ç°åœ¨è¿è¡Œ git status ä¼šæ²¡æœ‰è¾“å‡ºï¼Œå› ä¸ºä¸‰æ£µæ ‘åˆå˜å¾—ç›¸åŒäº†ã€‚ åˆ‡æ¢åˆ†æ”¯æˆ–å…‹éš†çš„è¿‡ç¨‹ä¹Ÿç±»ä¼¼ã€‚ å½“æ£€å‡ºä¸€ä¸ªåˆ†æ”¯æ—¶ï¼Œå®ƒä¼šä¿®æ”¹ HEAD æŒ‡å‘æ–°çš„åˆ†æ”¯å¼•ç”¨ï¼Œå°† ç´¢å¼• å¡«å……ä¸ºè¯¥æ¬¡æäº¤çš„å¿«ç…§ï¼Œ ç„¶åå°† ç´¢å¼• çš„å†…å®¹å¤åˆ¶åˆ° å·¥ä½œç›®å½• ä¸­ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E7%BD%AE%E6%8F%AD%E5%AF%86/:2:0","tags":["Git"],"title":"Gitå·¥å…·-é‡ç½®æ­å¯†","uri":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E7%BD%AE%E6%8F%AD%E5%AF%86/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"é‡ç½®çš„ä½œç”¨ åœ¨ä»¥ä¸‹æƒ…æ™¯ä¸­è§‚å¯Ÿ reset å‘½ä»¤ä¼šæ›´æœ‰æ„ä¹‰ã€‚ ä¸ºäº†æ¼”ç¤ºè¿™äº›ä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬å†æ¬¡ä¿®æ”¹äº† file.txt æ–‡ä»¶å¹¶ç¬¬ä¸‰æ¬¡æäº¤å®ƒã€‚ ç°åœ¨çš„å†å²çœ‹èµ·æ¥æ˜¯è¿™æ ·çš„ï¼š è®©æˆ‘ä»¬è·Ÿç€ reset çœ‹çœ‹å®ƒéƒ½åšäº†ä»€ä¹ˆã€‚ å®ƒä»¥ä¸€ç§ç®€å•å¯é¢„è§çš„æ–¹å¼ç›´æ¥æ“çºµè¿™ä¸‰æ£µæ ‘ã€‚ å®ƒåšäº†ä¸‰ä¸ªåŸºæœ¬æ“ä½œã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E7%BD%AE%E6%8F%AD%E5%AF%86/:3:0","tags":["Git"],"title":"Gitå·¥å…·-é‡ç½®æ­å¯†","uri":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E7%BD%AE%E6%8F%AD%E5%AF%86/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"ç¬¬ 1 æ­¥ï¼šç§»åŠ¨ HEAD reset åšçš„ç¬¬ä¸€ä»¶äº‹æ˜¯ç§»åŠ¨ HEAD çš„æŒ‡å‘ã€‚ è¿™ä¸æ”¹å˜ HEAD è‡ªèº«ä¸åŒï¼ˆcheckout æ‰€åšçš„ï¼‰ï¼›reset ç§»åŠ¨ HEAD æŒ‡å‘çš„åˆ†æ”¯ã€‚ è¿™æ„å‘³ç€å¦‚æœ HEAD è®¾ç½®ä¸º master åˆ†æ”¯ï¼ˆä¾‹å¦‚ï¼Œä½ æ­£åœ¨ master åˆ†æ”¯ä¸Šï¼‰ï¼Œ è¿è¡Œ git reset 9e5e6a4 å°†ä¼šä½¿ master æŒ‡å‘ 9e5e6a4ã€‚ æ— è®ºä½ è°ƒç”¨äº†ä½•ç§å½¢å¼çš„å¸¦æœ‰ä¸€ä¸ªæäº¤çš„ resetï¼Œå®ƒé¦–å…ˆéƒ½ä¼šå°è¯•è¿™æ ·åšã€‚ ä½¿ç”¨ reset --softï¼Œå®ƒå°†ä»…ä»…åœåœ¨é‚£å„¿ã€‚ ç°åœ¨çœ‹ä¸€çœ¼ä¸Šå›¾ï¼Œç†è§£ä¸€ä¸‹å‘ç”Ÿçš„äº‹æƒ…ï¼šå®ƒæœ¬è´¨ä¸Šæ˜¯æ’¤é”€äº†ä¸Šä¸€æ¬¡ git commit å‘½ä»¤ã€‚ å½“ä½ åœ¨è¿è¡Œ git commit æ—¶ï¼ŒGit ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æäº¤ï¼Œå¹¶ç§»åŠ¨ HEAD æ‰€æŒ‡å‘çš„åˆ†æ”¯æ¥ä½¿å…¶æŒ‡å‘è¯¥æäº¤ã€‚ å½“ä½ å°†å®ƒ reset å› HEAD~ï¼ˆHEAD çš„çˆ¶ç»“ç‚¹ï¼‰æ—¶ï¼Œå…¶å®å°±æ˜¯æŠŠè¯¥åˆ†æ”¯ç§»åŠ¨å›åŸæ¥çš„ä½ç½®ï¼Œè€Œä¸ä¼šæ”¹å˜ç´¢å¼•å’Œå·¥ä½œç›®å½•ã€‚ ç°åœ¨ä½ å¯ä»¥æ›´æ–°ç´¢å¼•å¹¶å†æ¬¡è¿è¡Œ git commit æ¥å®Œæˆ git commit --amend æ‰€è¦åšçš„äº‹æƒ…äº†ï¼ˆè§ ä¿®æ”¹æœ€åä¸€æ¬¡æäº¤ï¼‰ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E7%BD%AE%E6%8F%AD%E5%AF%86/:3:1","tags":["Git"],"title":"Gitå·¥å…·-é‡ç½®æ­å¯†","uri":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E7%BD%AE%E6%8F%AD%E5%AF%86/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"ç¬¬ 2 æ­¥ï¼šæ›´æ–°ç´¢å¼•ï¼ˆâ€“mixedï¼‰ æ³¨æ„ï¼Œå¦‚æœä½ ç°åœ¨è¿è¡Œ git status çš„è¯ï¼Œå°±ä¼šçœ‹åˆ°æ–°çš„ HEAD å’Œä»¥ç»¿è‰²æ ‡å‡ºçš„å®ƒå’Œç´¢å¼•ä¹‹é—´çš„åŒºåˆ«ã€‚ æ¥ä¸‹æ¥ï¼Œreset ä¼šç”¨ HEAD æŒ‡å‘çš„å½“å‰å¿«ç…§çš„å†…å®¹æ¥æ›´æ–°ç´¢å¼•ã€‚ å¦‚æœæŒ‡å®š --mixed é€‰é¡¹ï¼Œreset å°†ä¼šåœ¨è¿™æ—¶åœæ­¢ã€‚ è¿™ä¹Ÿæ˜¯é»˜è®¤è¡Œä¸ºï¼Œæ‰€ä»¥å¦‚æœæ²¡æœ‰æŒ‡å®šä»»ä½•é€‰é¡¹ï¼ˆåœ¨æœ¬ä¾‹ä¸­åªæ˜¯ git reset HEAD~ï¼‰ï¼Œè¿™å°±æ˜¯å‘½ä»¤å°†ä¼šåœæ­¢çš„åœ°æ–¹ã€‚ ç°åœ¨å†çœ‹ä¸€çœ¼ä¸Šå›¾ï¼Œç†è§£ä¸€ä¸‹å‘ç”Ÿçš„äº‹æƒ…ï¼šå®ƒä¾ç„¶ä¼šæ’¤é”€ä¸€ä¸Šæ¬¡ æäº¤ï¼Œä½†è¿˜ä¼š å–æ¶ˆæš‚å­˜ æ‰€æœ‰çš„ä¸œè¥¿ã€‚ äºæ˜¯ï¼Œæˆ‘ä»¬å›æ»šåˆ°äº†æ‰€æœ‰ git add å’Œ git commit çš„å‘½ä»¤æ‰§è¡Œä¹‹å‰ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E7%BD%AE%E6%8F%AD%E5%AF%86/:3:2","tags":["Git"],"title":"Gitå·¥å…·-é‡ç½®æ­å¯†","uri":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E7%BD%AE%E6%8F%AD%E5%AF%86/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"ç¬¬ 3 æ­¥ï¼šæ›´æ–°å·¥ä½œç›®å½•ï¼ˆâ€“hardï¼‰ reset è¦åšçš„çš„ç¬¬ä¸‰ä»¶äº‹æƒ…å°±æ˜¯è®©å·¥ä½œç›®å½•çœ‹èµ·æ¥åƒç´¢å¼•ã€‚ å¦‚æœä½¿ç”¨ --hard é€‰é¡¹ï¼Œå®ƒå°†ä¼šç»§ç»­è¿™ä¸€æ­¥ã€‚ ç°åœ¨è®©æˆ‘ä»¬å›æƒ³ä¸€ä¸‹åˆšæ‰å‘ç”Ÿçš„äº‹æƒ…ã€‚ ä½ æ’¤é”€äº†æœ€åçš„æäº¤ã€git add å’Œ git commit å‘½ä»¤ ä»¥åŠ å·¥ä½œç›®å½•ä¸­çš„æ‰€æœ‰å·¥ä½œã€‚ å¿…é¡»æ³¨æ„ï¼Œ--hard æ ‡è®°æ˜¯ reset å‘½ä»¤å”¯ä¸€çš„å±é™©ç”¨æ³•ï¼Œå®ƒä¹Ÿæ˜¯ Git ä¼šçœŸæ­£åœ°é”€æ¯æ•°æ®çš„ä»…æœ‰çš„å‡ ä¸ªæ“ä½œä¹‹ä¸€ã€‚ å…¶ä»–ä»»ä½•å½¢å¼çš„ reset è°ƒç”¨éƒ½å¯ä»¥è½»æ¾æ’¤æ¶ˆï¼Œä½†æ˜¯ --hard é€‰é¡¹ä¸èƒ½ï¼Œå› ä¸ºå®ƒå¼ºåˆ¶è¦†ç›–äº†å·¥ä½œç›®å½•ä¸­çš„æ–‡ä»¶ã€‚ åœ¨è¿™ç§ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çš„ Git æ•°æ®åº“ä¸­çš„ä¸€ä¸ªæäº¤å†…è¿˜ç•™æœ‰è¯¥æ–‡ä»¶çš„ v3 ç‰ˆæœ¬ï¼Œ æˆ‘ä»¬å¯ä»¥é€šè¿‡ reflog æ¥æ‰¾å›å®ƒã€‚ä½†æ˜¯è‹¥è¯¥æ–‡ä»¶è¿˜æœªæäº¤ï¼ŒGit ä»ä¼šè¦†ç›–å®ƒä»è€Œå¯¼è‡´æ— æ³•æ¢å¤ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E7%BD%AE%E6%8F%AD%E5%AF%86/:3:3","tags":["Git"],"title":"Gitå·¥å…·-é‡ç½®æ­å¯†","uri":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E7%BD%AE%E6%8F%AD%E5%AF%86/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"å›é¡¾ reset å‘½ä»¤ä¼šä»¥ç‰¹å®šçš„é¡ºåºé‡å†™è¿™ä¸‰æ£µæ ‘ï¼Œåœ¨ä½ æŒ‡å®šä»¥ä¸‹é€‰é¡¹æ—¶åœæ­¢ï¼š ç§»åŠ¨ HEAD åˆ†æ”¯çš„æŒ‡å‘ ï¼ˆè‹¥æŒ‡å®šäº† --softï¼Œåˆ™åˆ°æ­¤åœæ­¢ï¼‰ ä½¿ç´¢å¼•çœ‹èµ·æ¥åƒ HEAD ï¼ˆè‹¥æœªæŒ‡å®š --hardï¼Œåˆ™åˆ°æ­¤åœæ­¢ï¼‰ ä½¿å·¥ä½œç›®å½•çœ‹èµ·æ¥åƒç´¢å¼• ","date":"2020-11-18","objectID":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E7%BD%AE%E6%8F%AD%E5%AF%86/:3:4","tags":["Git"],"title":"Gitå·¥å…·-é‡ç½®æ­å¯†","uri":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E7%BD%AE%E6%8F%AD%E5%AF%86/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"é€šè¿‡è·¯å¾„æ¥é‡ç½® å‰é¢è®²è¿°äº† reset åŸºæœ¬å½¢å¼çš„è¡Œä¸ºï¼Œä¸è¿‡ä½ è¿˜å¯ä»¥ç»™å®ƒæä¾›ä¸€ä¸ªä½œç”¨è·¯å¾„ã€‚ è‹¥æŒ‡å®šäº†ä¸€ä¸ªè·¯å¾„ï¼Œreset å°†ä¼šè·³è¿‡ç¬¬ 1 æ­¥ï¼Œå¹¶ä¸”å°†å®ƒçš„ä½œç”¨èŒƒå›´é™å®šä¸ºæŒ‡å®šçš„æ–‡ä»¶æˆ–æ–‡ä»¶é›†åˆã€‚ è¿™æ ·åšè‡ªç„¶æœ‰å®ƒçš„é“ç†ï¼Œå› ä¸º HEAD åªæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œä½ æ— æ³•è®©å®ƒåŒæ—¶æŒ‡å‘ä¸¤ä¸ªæäº¤ä¸­å„è‡ªçš„ä¸€éƒ¨åˆ†ã€‚ ä¸è¿‡ç´¢å¼•å’Œå·¥ä½œç›®å½• å¯ä»¥éƒ¨åˆ†æ›´æ–°ï¼Œæ‰€ä»¥é‡ç½®ä¼šç»§ç»­è¿›è¡Œç¬¬ 2ã€3 æ­¥ã€‚ ç°åœ¨ï¼Œå‡å¦‚æˆ‘ä»¬è¿è¡Œ git reset file.txt ï¼ˆè¿™å…¶å®æ˜¯ git reset --mixed HEAD file.txt çš„ç®€å†™å½¢å¼ï¼Œå› ä¸ºä½ æ—¢æ²¡æœ‰æŒ‡å®šä¸€ä¸ªæäº¤çš„ SHA-1 æˆ–åˆ†æ”¯ï¼Œä¹Ÿæ²¡æœ‰æŒ‡å®š --soft æˆ– --hardï¼‰ï¼Œå®ƒä¼šï¼š ç§»åŠ¨ HEAD åˆ†æ”¯çš„æŒ‡å‘ ï¼ˆå·²è·³è¿‡ï¼‰ è®©ç´¢å¼•çœ‹èµ·æ¥åƒ HEAD ï¼ˆåˆ°æ­¤å¤„åœæ­¢ï¼‰ æ‰€ä»¥å®ƒæœ¬è´¨ä¸Šåªæ˜¯å°† file.txt ä» HEAD å¤åˆ¶åˆ°ç´¢å¼•ä¸­ã€‚ å®ƒè¿˜æœ‰ å–æ¶ˆæš‚å­˜æ–‡ä»¶ çš„å®é™…æ•ˆæœã€‚ å¦‚æœæˆ‘ä»¬æŸ¥çœ‹è¯¥å‘½ä»¤çš„ç¤ºæ„å›¾ï¼Œç„¶åå†æƒ³æƒ³ git add æ‰€åšçš„äº‹ï¼Œå°±ä¼šå‘ç°å®ƒä»¬æ­£å¥½ç›¸åã€‚ è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ git status å‘½ä»¤çš„è¾“å‡ºä¼šå»ºè®®è¿è¡Œæ­¤å‘½ä»¤æ¥å–æ¶ˆæš‚å­˜ä¸€ä¸ªæ–‡ä»¶ã€‚ ï¼ˆæŸ¥çœ‹ å–æ¶ˆæš‚å­˜çš„æ–‡ä»¶ æ¥äº†è§£æ›´å¤šã€‚ï¼‰ æˆ‘ä»¬å¯ä»¥ä¸è®© Git ä» HEAD æ‹‰å–æ•°æ®ï¼Œè€Œæ˜¯é€šè¿‡å…·ä½“æŒ‡å®šä¸€ä¸ªæäº¤æ¥æ‹‰å–è¯¥æ–‡ä»¶çš„å¯¹åº”ç‰ˆæœ¬ã€‚ æˆ‘ä»¬åªéœ€è¿è¡Œç±»ä¼¼äº git reset eb43bf file.txt çš„å‘½ä»¤å³å¯ã€‚ å®ƒå…¶å®åšäº†åŒæ ·çš„äº‹æƒ…ï¼Œä¹Ÿå°±æ˜¯æŠŠå·¥ä½œç›®å½•ä¸­çš„æ–‡ä»¶æ¢å¤åˆ° v1 ç‰ˆæœ¬ï¼Œè¿è¡Œ git add æ·»åŠ å®ƒï¼Œ ç„¶åå†å°†å®ƒæ¢å¤åˆ° v3 ç‰ˆæœ¬ï¼ˆåªæ˜¯ä¸ç”¨çœŸçš„è¿‡ä¸€éè¿™äº›æ­¥éª¤ï¼‰ã€‚ å¦‚æœæˆ‘ä»¬ç°åœ¨è¿è¡Œ git commitï¼Œå®ƒå°±ä¼šè®°å½•ä¸€æ¡â€œå°†è¯¥æ–‡ä»¶æ¢å¤åˆ° v1 ç‰ˆæœ¬â€çš„æ›´æ”¹ï¼Œ å°½ç®¡æˆ‘ä»¬å¹¶æœªåœ¨å·¥ä½œç›®å½•ä¸­çœŸæ­£åœ°å†æ¬¡æ‹¥æœ‰å®ƒã€‚ è¿˜æœ‰ä¸€ç‚¹åŒ git add ä¸€æ ·ï¼Œå°±æ˜¯ reset å‘½ä»¤ä¹Ÿå¯ä»¥æ¥å—ä¸€ä¸ª --patch é€‰é¡¹æ¥ä¸€å—ä¸€å—åœ°å–æ¶ˆæš‚å­˜çš„å†…å®¹ã€‚ è¿™æ ·ä½ å°±å¯ä»¥æ ¹æ®é€‰æ‹©æ¥å–æ¶ˆæš‚å­˜æˆ–æ¢å¤å†…å®¹äº†ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E7%BD%AE%E6%8F%AD%E5%AF%86/:4:0","tags":["Git"],"title":"Gitå·¥å…·-é‡ç½®æ­å¯†","uri":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E7%BD%AE%E6%8F%AD%E5%AF%86/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"å‹ç¼© æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•åˆ©ç”¨è¿™ç§æ–°çš„åŠŸèƒ½æ¥åšä¸€äº›æœ‰è¶£çš„äº‹æƒ…â€”â€”å‹ç¼©æäº¤ã€‚ å‡è®¾ä½ çš„ä¸€ç³»åˆ—æäº¤ä¿¡æ¯ä¸­æœ‰ â€œoops.â€â€œWIPâ€ å’Œ â€œforgot this fileâ€ï¼Œ èªæ˜çš„ä½ å°±èƒ½ä½¿ç”¨ reset æ¥è½»æ¾å¿«é€Ÿåœ°å°†å®ƒä»¬å‹ç¼©æˆå•ä¸ªæäº¤ï¼Œä¹Ÿæ˜¾å‡ºä½ çš„èªæ˜ã€‚ ï¼ˆå‹ç¼©æäº¤ å±•ç¤ºäº†å¦ä¸€ç§æ–¹å¼ï¼Œä¸è¿‡åœ¨æœ¬ä¾‹ä¸­ç”¨ reset æ›´ç®€å•ã€‚ï¼‰ å‡è®¾ä½ æœ‰ä¸€ä¸ªé¡¹ç›®ï¼Œç¬¬ä¸€æ¬¡æäº¤ä¸­æœ‰ä¸€ä¸ªæ–‡ä»¶ï¼Œç¬¬äºŒæ¬¡æäº¤å¢åŠ äº†ä¸€ä¸ªæ–°çš„æ–‡ä»¶å¹¶ä¿®æ”¹äº†ç¬¬ä¸€ä¸ªæ–‡ä»¶ï¼Œç¬¬ä¸‰æ¬¡æäº¤å†æ¬¡ä¿®æ”¹äº†ç¬¬ä¸€ä¸ªæ–‡ä»¶ã€‚ ç”±äºç¬¬äºŒæ¬¡æäº¤æ˜¯ä¸€ä¸ªæœªå®Œæˆçš„å·¥ä½œï¼Œå› æ­¤ä½ æƒ³è¦å‹ç¼©å®ƒã€‚ é‚£ä¹ˆå¯ä»¥è¿è¡Œ git reset --soft HEAD~2 æ¥å°† HEAD åˆ†æ”¯ç§»åŠ¨åˆ°ä¸€ä¸ªæ—§ä¸€ç‚¹çš„æäº¤ä¸Šï¼ˆå³ä½ æƒ³è¦ä¿ç•™çš„æœ€è¿‘çš„æäº¤ï¼‰ï¼š ç„¶ååªéœ€å†æ¬¡è¿è¡Œ git commitï¼š ç°åœ¨ä½ å¯ä»¥æŸ¥çœ‹å¯åˆ°è¾¾çš„å†å²ï¼Œå³å°†ä¼šæ¨é€çš„å†å²ï¼Œç°åœ¨çœ‹èµ·æ¥æœ‰ä¸ª v1 ç‰ˆ file-a.txt çš„æäº¤ï¼Œ æ¥ç€ç¬¬äºŒä¸ªæäº¤å°† file-a.txt ä¿®æ”¹æˆäº† v3 ç‰ˆå¹¶å¢åŠ äº† file-b.txtã€‚ åŒ…å« v2 ç‰ˆæœ¬çš„æ–‡ä»¶å·²ç»ä¸åœ¨å†å²ä¸­äº†ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E7%BD%AE%E6%8F%AD%E5%AF%86/:5:0","tags":["Git"],"title":"Gitå·¥å…·-é‡ç½®æ­å¯†","uri":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E7%BD%AE%E6%8F%AD%E5%AF%86/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"æ£€å‡º æœ€åï¼Œä½ å¤§æ¦‚è¿˜æƒ³çŸ¥é“ checkout å’Œ reset ä¹‹é—´çš„åŒºåˆ«ã€‚ å’Œ reset ä¸€æ ·ï¼Œcheckout ä¹Ÿæ“çºµä¸‰æ£µæ ‘ï¼Œä¸è¿‡å®ƒæœ‰ä¸€ç‚¹ä¸åŒï¼Œè¿™å–å†³äºä½ æ˜¯å¦ä¼ ç»™è¯¥å‘½ä»¤ä¸€ä¸ªæ–‡ä»¶è·¯å¾„ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E7%BD%AE%E6%8F%AD%E5%AF%86/:6:0","tags":["Git"],"title":"Gitå·¥å…·-é‡ç½®æ­å¯†","uri":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E7%BD%AE%E6%8F%AD%E5%AF%86/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"ä¸å¸¦è·¯å¾„ è¿è¡Œ git checkout [branch] ä¸è¿è¡Œ git reset --hard [branch] éå¸¸ç›¸ä¼¼ï¼Œå®ƒä¼šæ›´æ–°æ‰€æœ‰ä¸‰æ£µæ ‘ä½¿å…¶çœ‹èµ·æ¥åƒ [branch]ï¼Œä¸è¿‡æœ‰ä¸¤ç‚¹é‡è¦çš„åŒºåˆ«ã€‚ é¦–å…ˆä¸åŒäº reset --hardï¼Œcheckout å¯¹å·¥ä½œç›®å½•æ˜¯å®‰å…¨çš„ï¼Œå®ƒä¼šé€šè¿‡æ£€æŸ¥æ¥ç¡®ä¿ä¸ä¼šå°†å·²æ›´æ”¹çš„æ–‡ä»¶å¼„ä¸¢ã€‚ å…¶å®å®ƒè¿˜æ›´èªæ˜ä¸€äº›ã€‚å®ƒä¼šåœ¨å·¥ä½œç›®å½•ä¸­å…ˆè¯•ç€ç®€å•åˆå¹¶ä¸€ä¸‹ï¼Œè¿™æ ·æ‰€æœ‰_è¿˜æœªä¿®æ”¹è¿‡çš„_æ–‡ä»¶éƒ½ä¼šè¢«æ›´æ–°ã€‚ è€Œ reset --hard åˆ™ä¼šä¸åšæ£€æŸ¥å°±å…¨é¢åœ°æ›¿æ¢æ‰€æœ‰ä¸œè¥¿ã€‚ ç¬¬äºŒä¸ªé‡è¦çš„åŒºåˆ«æ˜¯ checkout å¦‚ä½•æ›´æ–° HEADã€‚ reset ä¼šç§»åŠ¨ HEAD åˆ†æ”¯çš„æŒ‡å‘ï¼Œè€Œ checkout åªä¼šç§»åŠ¨ HEAD è‡ªèº«æ¥æŒ‡å‘å¦ä¸€ä¸ªåˆ†æ”¯ã€‚ ä¾‹å¦‚ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ master å’Œ develop åˆ†æ”¯ï¼Œå®ƒä»¬åˆ†åˆ«æŒ‡å‘ä¸åŒçš„æäº¤ï¼›æˆ‘ä»¬ç°åœ¨åœ¨ develop ä¸Šï¼ˆæ‰€ä»¥ HEAD æŒ‡å‘å®ƒï¼‰ã€‚ å¦‚æœæˆ‘ä»¬è¿è¡Œ git reset masterï¼Œé‚£ä¹ˆ develop è‡ªèº«ç°åœ¨ä¼šå’Œ master æŒ‡å‘åŒä¸€ä¸ªæäº¤ã€‚ è€Œå¦‚æœæˆ‘ä»¬è¿è¡Œ git checkout master çš„è¯ï¼Œdevelop ä¸ä¼šç§»åŠ¨ï¼ŒHEAD è‡ªèº«ä¼šç§»åŠ¨ã€‚ ç°åœ¨ HEAD å°†ä¼šæŒ‡å‘ masterã€‚ æ‰€ä»¥ï¼Œè™½ç„¶åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹æˆ‘ä»¬éƒ½ç§»åŠ¨ HEAD ä½¿å…¶æŒ‡å‘äº†æäº¤ Aï¼Œä½†_åšæ³•_æ˜¯éå¸¸ä¸åŒçš„ã€‚ reset ä¼šç§»åŠ¨ HEAD åˆ†æ”¯çš„æŒ‡å‘ï¼Œè€Œ checkout åˆ™ç§»åŠ¨ HEAD è‡ªèº«ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E7%BD%AE%E6%8F%AD%E5%AF%86/:6:1","tags":["Git"],"title":"Gitå·¥å…·-é‡ç½®æ­å¯†","uri":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E7%BD%AE%E6%8F%AD%E5%AF%86/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"å¸¦è·¯å¾„ è¿è¡Œ checkout çš„å¦ä¸€ç§æ–¹å¼å°±æ˜¯æŒ‡å®šä¸€ä¸ªæ–‡ä»¶è·¯å¾„ï¼Œè¿™ä¼šåƒ reset ä¸€æ ·ä¸ä¼šç§»åŠ¨ HEADã€‚ å®ƒå°±åƒ git reset [branch] file é‚£æ ·ç”¨è¯¥æ¬¡æäº¤ä¸­çš„é‚£ä¸ªæ–‡ä»¶æ¥æ›´æ–°ç´¢å¼•ï¼Œä½†æ˜¯å®ƒä¹Ÿä¼šè¦†ç›–å·¥ä½œç›®å½•ä¸­å¯¹åº”çš„æ–‡ä»¶ã€‚ å®ƒå°±åƒæ˜¯ git reset --hard [branch] fileï¼ˆå¦‚æœ reset å…è®¸ä½ è¿™æ ·è¿è¡Œçš„è¯ï¼‰ï¼Œ è¿™æ ·å¯¹å·¥ä½œç›®å½•å¹¶ä¸å®‰å…¨ï¼Œå®ƒä¹Ÿä¸ä¼šç§»åŠ¨ HEADã€‚ æ­¤å¤–ï¼ŒåŒ git reset å’Œ git add ä¸€æ ·ï¼Œcheckout ä¹Ÿæ¥å—ä¸€ä¸ª --patch é€‰é¡¹ï¼Œå…è®¸ä½ æ ¹æ®é€‰æ‹©ä¸€å—ä¸€å—åœ°æ¢å¤æ–‡ä»¶å†…å®¹ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E7%BD%AE%E6%8F%AD%E5%AF%86/:6:2","tags":["Git"],"title":"Gitå·¥å…·-é‡ç½®æ­å¯†","uri":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E7%BD%AE%E6%8F%AD%E5%AF%86/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"æ€»ç»“ å¸Œæœ›ä½ ç°åœ¨ç†Ÿæ‚‰å¹¶ç†è§£äº† reset å‘½ä»¤ï¼Œä¸è¿‡å…³äºå®ƒå’Œ checkout ä¹‹é—´çš„åŒºåˆ«ï¼Œä½ å¯èƒ½è¿˜æ˜¯ä¼šæœ‰ç‚¹å›°æƒ‘ï¼Œæ¯•ç«Ÿä¸å¤ªå¯èƒ½è®°ä½ä¸åŒè°ƒç”¨çš„æ‰€æœ‰è§„åˆ™ã€‚ ä¸‹é¢çš„é€ŸæŸ¥è¡¨åˆ—å‡ºäº†å‘½ä»¤å¯¹æ ‘çš„å½±å“ã€‚ â€œHEADâ€ ä¸€åˆ—ä¸­çš„ â€œREFâ€ è¡¨ç¤ºè¯¥å‘½ä»¤ç§»åŠ¨äº† HEAD æŒ‡å‘çš„åˆ†æ”¯å¼•ç”¨ï¼Œè€Œ â€œHEADâ€ åˆ™è¡¨ç¤ºåªç§»åŠ¨äº† HEAD è‡ªèº«ã€‚ ç‰¹åˆ«æ³¨æ„ WD Safe? ä¸€åˆ—â€”â€”å¦‚æœå®ƒæ ‡è®°ä¸º NOï¼Œé‚£ä¹ˆè¿è¡Œè¯¥å‘½ä»¤ä¹‹å‰è¯·è€ƒè™‘ä¸€ä¸‹ã€‚ HEAD Index Workdir WD Safe? Commit Level reset --soft [commit] REF NO NO YES reset [commit] REF YES NO YES reset --hard [commit] REF YES YES NO checkout \u003ccommit\u003e HEAD YES YES YES File Level reset [commit] \u003cpaths\u003e NO YES NO YES checkout [commit] \u003cpaths\u003e NO YES YES NO ","date":"2020-11-18","objectID":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E7%BD%AE%E6%8F%AD%E5%AF%86/:7:0","tags":["Git"],"title":"Gitå·¥å…·-é‡ç½®æ­å¯†","uri":"/posts/git%E5%B7%A5%E5%85%B7-%E9%87%8D%E7%BD%AE%E6%8F%AD%E5%AF%86/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"GitåŸºç¡€ä¸å‘½ä»¤ å®˜æ–¹æ–‡æ¡£ï¼ˆä¸­æ–‡ï¼‰ï¼šhttps://git-scm.com/book/zh/v2 æœ¬æ–‡æ¡£æ˜¯æ ¹æ®å®˜æ–¹æ–‡æ¡£æ¥ç¼–å†™çš„ï¼Œä»¥å®˜æ–¹æ–‡æ¡£ä¸ºå‡†ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/:0:0","tags":["Git"],"title":"GitåŸºç¡€ä¸å‘½ä»¤","uri":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"GitåŸºç¡€ ","date":"2020-11-18","objectID":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/:1:0","tags":["Git"],"title":"GitåŸºç¡€ä¸å‘½ä»¤","uri":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"å…¨å±€é…ç½® git config --global user.name 'your name' git config --global user.email 'xxx@xx.com' è‡ªæŠ¥å®¶é—¨ ","date":"2020-11-18","objectID":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/:1:1","tags":["Git"],"title":"GitåŸºç¡€ä¸å‘½ä»¤","uri":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"æ£€æŸ¥é…ç½®ä¿¡æ¯ git config --list ","date":"2020-11-18","objectID":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/:1:2","tags":["Git"],"title":"GitåŸºç¡€ä¸å‘½ä»¤","uri":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"è·å–å¸®åŠ© # è·å–å…¨å±€å¸®åŠ©æ‰‹å†Œ git help # è·å–ç‰¹å®šå‘½ä»¤çš„è¯¦ç»†ç‰ˆå¸®åŠ©æ‰‹å†Œ (ä¸¤ä¸ªå‘½ä»¤æ˜¯ç­‰ä»·çš„) git help \u003cæŸä¸ªå‘½ä»¤\u003e git \u003cæŸä¸ªå‘½ä»¤\u003e --help # ä¸¤ä¸ªæ¨ªæ  # è·å–ç‰¹å®šå‘½ä»¤çš„ç®€æ˜ç‰ˆå¸®åŠ©æ‰‹å†Œ git \u003cæŸä¸ªå‘½ä»¤\u003e -h # ä¸€ä¸ªæ¨ªæ  ","date":"2020-11-18","objectID":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/:1:3","tags":["Git"],"title":"GitåŸºç¡€ä¸å‘½ä»¤","uri":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"åˆå§‹åŒ–ä»“åº“ # æœ¬åœ°ç›®å½•åˆå§‹åŒ–ä»“åº“ git init å¦‚æœä½ æ˜¯ä»è¿œç¨‹ä»“åº“cloneçš„é¡¹ç›®ï¼Œåˆ™è¯¥é¡¹ç›®æ˜¯å·²ç»åˆå§‹åŒ–å¥½çš„gitä»“åº“ ","date":"2020-11-18","objectID":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/:1:4","tags":["Git"],"title":"GitåŸºç¡€ä¸å‘½ä»¤","uri":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"å…‹éš†è¿œç¨‹ä»“åº“ # å…‹éš† git clone \u003curl\u003e # å…‹éš†åŒæ—¶ä¿®æ”¹ç›®å½•å git clone \u003curl\u003e \u003cname\u003e åˆæ¬¡å…‹éš†æŸä¸ªä»“åº“çš„æ—¶å€™ï¼Œå·¥ä½œç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶éƒ½å±äºå·²è·Ÿè¸ªæ–‡ä»¶ï¼Œå¹¶å¤„äºæœªä¿®æ”¹çŠ¶æ€ï¼Œå› ä¸º Git åˆšåˆšæ£€å‡ºäº†å®ƒä»¬ï¼Œ è€Œä½ å°šæœªç¼–è¾‘è¿‡å®ƒä»¬ ","date":"2020-11-18","objectID":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/:1:5","tags":["Git"],"title":"GitåŸºç¡€ä¸å‘½ä»¤","uri":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"æ£€æŸ¥æ–‡ä»¶çŠ¶æ€ # æŸ¥çœ‹è¯¦ç»†çŠ¶æ€è¯´æ˜ git status # æŸ¥çœ‹ç®€æ˜çŠ¶æ€è¯´æ˜ git status -s # -s æˆ– --short M README # å·²ä¿®æ”¹ï¼Œä½†æœªæš‚å­˜ ï¼ˆMçš„ä½ç½®é å³ï¼Œçº¢è‰²ï¼‰ MM Rakefile # å·²ä¿®æ”¹ï¼Œæš‚å­˜ååˆä½œäº†ä¿®æ”¹ï¼ˆæœ‰æš‚å­˜å’Œæœªæš‚å­˜ï¼‰ A lib/git.rb # æ–°æ·»åŠ åˆ°æš‚å­˜åŒºï¼Œæœªæäº¤ M lib/simplegit.rb # å·²ä¿®æ”¹ï¼Œå·²æš‚å­˜ ï¼ˆMçš„ä½ç½®é å·¦ï¼Œç»¿è‰²ï¼‰ ?? LICENSE.txt # æ–°æ·»åŠ ï¼Œæœªè·Ÿè¸ª gitç›®å½•ä¸­çš„æ–‡ä»¶çŠ¶æ€åŒ…å«ï¼šæ˜¯å¦è·Ÿè¸ªã€æ˜¯å¦ä¿®æ”¹ã€æ˜¯å¦å·²å­˜å…¥æš‚å­˜åŒº å‚æ•°çš„ä¸€ä¸ªæ¨ªæ è¡¨ç¤ºç¼©å†™ï¼Œä¸¤ä¸ªæ¨ªæ è¡¨ç¤ºå…¨ç§°ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/:1:6","tags":["Git"],"title":"GitåŸºç¡€ä¸å‘½ä»¤","uri":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"åŠ å…¥æš‚å­˜åŒº (è·Ÿè¸ªæ–‡ä»¶) # æ–‡ä»¶åŠ å…¥æš‚å­˜åŒºï¼ˆè·Ÿè¸ªæŒ‡å®šæ–‡ä»¶) git add \u003cfiles\u003e git add å‘½ä»¤ä½¿ç”¨æ–‡ä»¶æˆ–ç›®å½•çš„è·¯å¾„ä½œä¸ºå‚æ•°ï¼›å¦‚æœå‚æ•°æ˜¯ç›®å½•çš„è·¯å¾„ï¼Œè¯¥å‘½ä»¤å°†é€’å½’åœ°è·Ÿè¸ªè¯¥ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ã€‚ add å‘½ä»¤æ˜¯å°†æ–‡ä»¶åŠ å…¥åˆ°æš‚å­˜åŒºï¼Œcommit å‘½ä»¤çš„æäº¤åˆ°æœ¬åœ°ä»“åº“ï¼Œpush å‘½ä»¤æ˜¯æ¨é€åˆ°è¿œç¨‹ä»“åº“ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/:1:7","tags":["Git"],"title":"GitåŸºç¡€ä¸å‘½ä»¤","uri":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"å¿½ç•¥æ–‡ä»¶ æ·»åŠ ä¸€ä¸ªåä¸º .gitignore çš„æ–‡ä»¶ï¼Œåˆ—å‡ºè¦å¿½ç•¥çš„æ–‡ä»¶çš„æ¨¡å¼ *.[oa] # å¿½ç•¥ä»¥ .o æˆ– .a ç»“å°¾çš„æ–‡ä»¶ï¼ˆä¸€èˆ¬è¿™ç±»æ–‡ä»¶æ˜¯ç¼–è¯‘è¿‡ç¨‹å‡ºç°ï¼‰ *~ # å¿½ç•¥ä»¥ ~ ç»“å°¾çš„æ–‡ä»¶ï¼ˆä¸€èˆ¬æ˜¯æ–‡æœ¬ç¼–è¾‘è½¯ä»¶ä¿å­˜çš„å‰¯æœ¬ï¼‰ æ–‡ä»¶ .gitignore çš„æ ¼å¼è§„èŒƒå¦‚ä¸‹ï¼š æ‰€æœ‰ç©ºè¡Œæˆ–è€…ä»¥ # å¼€å¤´çš„è¡Œéƒ½ä¼šè¢« Git å¿½ç•¥ï¼ˆæ³¨é‡Šç¬¦å·ï¼‰ã€‚ å¯ä»¥ä½¿ç”¨æ ‡å‡†çš„ glob æ¨¡å¼åŒ¹é…ï¼Œå®ƒä¼šé€’å½’åœ°åº”ç”¨åœ¨æ•´ä¸ªå·¥ä½œåŒºä¸­ã€‚ glob æ¨¡å¼æ˜¯æŒ‡ shell æ‰€ä½¿ç”¨çš„ç®€åŒ–äº†çš„æ­£åˆ™è¡¨è¾¾å¼ åŒ¹é…æ¨¡å¼å¯ä»¥ä»¥ï¼ˆ/ï¼‰å¼€å¤´é˜²æ­¢é€’å½’ã€‚ åŒ¹é…æ¨¡å¼å¯ä»¥ä»¥ï¼ˆ/ï¼‰ç»“å°¾æŒ‡å®šç›®å½•ã€‚ è¦å¿½ç•¥æŒ‡å®šæ¨¡å¼ä»¥å¤–çš„æ–‡ä»¶æˆ–ç›®å½•ï¼Œå¯ä»¥åœ¨æ¨¡å¼å‰åŠ ä¸Šå¹å·ï¼ˆ!ï¼‰å–åã€‚ æ˜Ÿå·ï¼ˆ*ï¼‰åŒ¹é…é›¶ä¸ªæˆ–å¤šä¸ªä»»æ„å­—ç¬¦ [abc] åŒ¹é…ä»»ä½•ä¸€ä¸ªåˆ—åœ¨æ–¹æ‹¬å·ä¸­çš„å­—ç¬¦ ï¼ˆè¿™ä¸ªä¾‹å­è¦ä¹ˆåŒ¹é…ä¸€ä¸ª aï¼Œè¦ä¹ˆåŒ¹é…ä¸€ä¸ª bï¼Œè¦ä¹ˆåŒ¹é…ä¸€ä¸ª cï¼‰ é—®å·ï¼ˆ?ï¼‰åªåŒ¹é…ä¸€ä¸ªä»»æ„å­—ç¬¦ [0-9] è¡¨ç¤ºåŒ¹é…æ‰€æœ‰ 0 åˆ° 9 çš„æ•°å­—ã€‚åœ¨æ–¹æ‹¬å·ä¸­ä½¿ç”¨çŸ­åˆ’çº¿åˆ†éš”ä¸¤ä¸ªå­—ç¬¦ï¼Œ è¡¨ç¤ºæ‰€æœ‰åœ¨è¿™ä¸¤ä¸ªå­—ç¬¦èŒƒå›´å†…çš„éƒ½å¯ä»¥åŒ¹é… ä½¿ç”¨ä¸¤ä¸ªæ˜Ÿå·ï¼ˆ**ï¼‰è¡¨ç¤ºåŒ¹é…ä»»æ„ä¸­é—´ç›®å½•ï¼Œæ¯”å¦‚ a/**/z å¯ä»¥åŒ¹é… a/z ã€ a/b/z æˆ– a/b/c/z ç­‰ã€‚ # å¿½ç•¥æ‰€æœ‰çš„ .a æ–‡ä»¶ *.a # ä½†è·Ÿè¸ªæ‰€æœ‰çš„ lib.aï¼Œå³ä¾¿ä½ åœ¨å‰é¢å¿½ç•¥äº† .a æ–‡ä»¶ !lib.a # åªå¿½ç•¥å½“å‰ç›®å½•ä¸‹çš„ TODO æ–‡ä»¶ï¼Œè€Œä¸å¿½ç•¥ subdir/TODO /TODO # å¿½ç•¥ä»»ä½•ç›®å½•ä¸‹åä¸º build çš„æ–‡ä»¶å¤¹ build/ # å¿½ç•¥ doc/notes.txtï¼Œä½†ä¸å¿½ç•¥ doc/server/arch.txt doc/*.txt # å¿½ç•¥ doc/ ç›®å½•åŠå…¶æ‰€æœ‰å­ç›®å½•ä¸‹çš„ .pdf æ–‡ä»¶ doc/**/*.pdf GitHub æœ‰ä¸€ä¸ªååˆ†è¯¦ç»†çš„é’ˆå¯¹æ•°åç§é¡¹ç›®åŠè¯­è¨€çš„ .gitignore æ–‡ä»¶åˆ—è¡¨ï¼Œ ä½ å¯ä»¥åœ¨ https://github.com/github/gitignore æ‰¾åˆ°å®ƒã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/:1:8","tags":["Git"],"title":"GitåŸºç¡€ä¸å‘½ä»¤","uri":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"æŸ¥çœ‹ä¿®æ”¹çš„å…·ä½“å†…å®¹ git diff # æ¯”è¾ƒä¿®æ”¹ä¹‹åè¿˜æ²¡æœ‰æš‚å­˜èµ·æ¥çš„å˜åŒ–å†…å®¹ã€‚ git diff --staged # æŸ¥çœ‹å·²æš‚å­˜çš„å°†è¦æ·»åŠ åˆ°ä¸‹æ¬¡æäº¤é‡Œçš„å†…å®¹ git status åªèƒ½æŸ¥çœ‹æ–‡ä»¶å˜åŠ¨çš„çŠ¶æ€ï¼Œå¹¶ä¸èƒ½æŸ¥çœ‹å…·ä½“ä¿®æ”¹äº†å“ªäº›å†…å®¹ã€‚ä½¿ç”¨git diffå¯ä»¥çœ‹åˆ°å…·ä½“å˜åŠ¨çš„å†…å®¹ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/:1:9","tags":["Git"],"title":"GitåŸºç¡€ä¸å‘½ä»¤","uri":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"æäº¤æ›´æ–° git commit # æœªå¸¦å‚æ•°çš„ä¼šæ‰“å¼€é»˜è®¤æ–‡æœ¬ç¼–è¾‘å™¨è®©ä½ è¾“å…¥æäº¤è¯´æ˜ git commit -m 'æäº¤è¯´æ˜' # å¸¦-må‚æ•°ç›´æ¥è¾“å…¥æäº¤è¯´æ˜ ä½¿ç”¨git commitæäº¤æ›´æ–°ï¼Œåœ¨æ­¤ä¹‹å‰ï¼ŒåŠ¡å¿…ç¡®è®¤æ‰€æœ‰å˜åŠ¨å·²ç»è¢«git addæ·»åŠ åˆ°æš‚å­˜åŒºã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/:1:10","tags":["Git"],"title":"GitåŸºç¡€ä¸å‘½ä»¤","uri":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"è·³è¿‡ä½¿ç”¨æš‚å­˜åŒºåŸŸ git commit -a -m 'æäº¤è¯´æ˜' æ·»åŠ -aé€‰é¡¹å¯ä»¥è·³è¿‡git add æ­¥éª¤ï¼ŒæŠŠå·²ç»è·Ÿè¸ªè¿‡çš„æ–‡ä»¶ä¸€å¹¶æäº¤ã€‚ æ³¨æ„ï¼šè¿™ä¸ªæ“ä½œæ— æ³•æäº¤æœªè·Ÿè¸ªçš„æ–‡ä»¶ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/:1:11","tags":["Git"],"title":"GitåŸºç¡€ä¸å‘½ä»¤","uri":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"Git åŸºç¡€ - æŸ¥çœ‹æäº¤å†å² git log ä¸ä¼ å…¥ä»»ä½•å‚æ•°çš„é»˜è®¤æƒ…å†µä¸‹ï¼Œgit log ä¼šæŒ‰æ—¶é—´å…ˆåé¡ºåºåˆ—å‡ºæ‰€æœ‰çš„æäº¤ï¼Œæœ€è¿‘çš„æ›´æ–°æ’åœ¨æœ€ä¸Šé¢ã€‚ æ­¤å‘½ä»¤æ‰“å°çš„æ•°æ®ä¸­æœ‰ä¸€é¡¹æ˜¯ä¸€é•¿ä¸²çš„ SHA-1 æ ¡éªŒç ã€‚ å¸¦å…¥-pæˆ–--patch æŸ¥çœ‹æäº¤çš„å…·ä½“å·®å¼‚ï¼š git log -p -2 # -pæ˜¾ç¤ºå·®å¼‚ -2æ˜¾ç¤ºæœ€è¿‘çš„æäº¤æ¬¡æ•° --stat æ˜¾ç¤ºæ¯æ¬¡æäº¤çš„å·®å¼‚ç»Ÿè®¡ git log --stat --pretty è¿™ä¸ªé€‰é¡¹å¯ä»¥ä½¿ç”¨ä¸åŒäºé»˜è®¤æ ¼å¼çš„æ–¹å¼å±•ç¤ºæäº¤å†å² è¿™ä¸ªé€‰é¡¹æœ‰ä¸€äº›å†…å»ºçš„å­é€‰é¡¹ä¾›ä½ ä½¿ç”¨ã€‚ æ¯”å¦‚ oneline ä¼šå°†æ¯ä¸ªæäº¤æ”¾åœ¨ä¸€è¡Œæ˜¾ç¤ºï¼Œåœ¨æµè§ˆå¤§é‡çš„æäº¤æ—¶éå¸¸æœ‰ç”¨ã€‚ å¦å¤–è¿˜æœ‰ shortï¼Œfull å’Œ fuller é€‰é¡¹ï¼Œå®ƒä»¬å±•ç¤ºä¿¡æ¯çš„æ ¼å¼åŸºæœ¬ä¸€è‡´ï¼Œä½†æ˜¯è¯¦å°½ç¨‹åº¦ä¸ä¸€ï¼š $ git log --pretty=oneline ca82a6dff817ec66f44342007202690a93763949 changed the version number 085bb3bcb608e1e8451d4b2432f8ecbe6306e7e7 removed unnecessary test a11bef06a3f659402fe7563abf99ad00de2209e6 first commit æœ€æœ‰æ„æ€çš„æ˜¯ format ï¼Œå¯ä»¥å®šåˆ¶è®°å½•çš„æ˜¾ç¤ºæ ¼å¼ã€‚ è¿™æ ·çš„è¾“å‡ºå¯¹åæœŸæå–åˆ†ææ ¼å¤–æœ‰ç”¨â€”â€”å› ä¸ºä½ çŸ¥é“è¾“å‡ºçš„æ ¼å¼ä¸ä¼šéšç€ Git çš„æ›´æ–°è€Œå‘ç”Ÿæ”¹å˜ï¼š $ git log --pretty=format:\"%h - %an, %ar : %s\" ca82a6d - Scott Chacon, 6 years ago : changed the version number 085bb3b - Scott Chacon, 6 years ago : removed unnecessary test a11bef0 - Scott Chacon, 6 years ago : first commit git log --pretty=format å¸¸ç”¨çš„é€‰é¡¹ åˆ—å‡ºäº† format æ¥å—çš„å¸¸ç”¨æ ¼å¼å ä½ç¬¦çš„å†™æ³•åŠå…¶ä»£è¡¨çš„æ„ä¹‰ã€‚ å½“ oneline æˆ– format ä¸å¦ä¸€ä¸ª log é€‰é¡¹ --graph ç»“åˆä½¿ç”¨æ—¶å°¤å…¶æœ‰ç”¨ã€‚ è¿™ä¸ªé€‰é¡¹æ·»åŠ äº†ä¸€äº› ASCII å­—ç¬¦ä¸²æ¥å½¢è±¡åœ°å±•ç¤ºä½ çš„åˆ†æ”¯ã€åˆå¹¶å†å²ï¼š $ git log --pretty=format:\"%h %s\" --graph * 2d3acf9 ignore errors from SIGCHLD on trap * 5e3ee11 Merge branch 'master' of git://github.com/dustin/grit |\\ | * 420eac9 Added a method for getting the current branch. * | 30e367c timeout code and tests * | 5a09431 add timeout protection to grit * | e1193f8 support for heads with slashes in them |/ * d6016bc require time for xmlschema * 11d191e Merge branch 'defunkt' into local ","date":"2020-11-18","objectID":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/:2:0","tags":["Git"],"title":"GitåŸºç¡€ä¸å‘½ä»¤","uri":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"Git åŸºç¡€ - æ’¤æ¶ˆæ“ä½œ ä½ æäº¤åå‘ç°å¿˜è®°äº†æš‚å­˜æŸäº›éœ€è¦çš„ä¿®æ”¹ï¼Œå¯ä»¥åƒä¸‹é¢è¿™æ ·æ“ä½œï¼š $ git commit -m 'initial commit' $ git add forgotten_file $ git commit --amend # é‡æ–°æäº¤ï¼Œä¸”åªæœ‰ä¸€æ¬¡æäº¤è®°å½• æœ€ç»ˆä½ åªä¼šæœ‰ä¸€ä¸ªæäº¤â€”â€”ç¬¬äºŒæ¬¡æäº¤å°†ä»£æ›¿ç¬¬ä¸€æ¬¡æäº¤çš„ç»“æœã€‚ æ›´å¤šæ’¤é”€æ“ä½œè¯·äº†è§£ resetå‘½ä»¤ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/:3:0","tags":["Git"],"title":"GitåŸºç¡€ä¸å‘½ä»¤","uri":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"Git åŸºç¡€ - è¿œç¨‹ä»“åº“çš„ä½¿ç”¨ ","date":"2020-11-18","objectID":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/:4:0","tags":["Git"],"title":"GitåŸºç¡€ä¸å‘½ä»¤","uri":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"æŸ¥çœ‹è¿œç¨‹ä»“åº“ git remote # ä»…æ˜¾ç¤ºè¿œç¨‹ä»“åº“çš„åç§° git remote -v # æ˜¾ç¤ºè¿œç¨‹ä»“åº“çš„åç§° + åœ°å€ ","date":"2020-11-18","objectID":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/:4:1","tags":["Git"],"title":"GitåŸºç¡€ä¸å‘½ä»¤","uri":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"æ·»åŠ è¿œç¨‹ä»“åº“ git remote add \u003cè¿œç¨‹ä»“åº“å\u003e \u003curl\u003e ","date":"2020-11-18","objectID":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/:4:2","tags":["Git"],"title":"GitåŸºç¡€ä¸å‘½ä»¤","uri":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"ä»è¿œç¨‹ä»“åº“ä¸­æŠ“å–ä¸æ‹‰å– å°±å¦‚åˆšæ‰æ‰€è§ï¼Œä»è¿œç¨‹ä»“åº“ä¸­è·å¾—æ•°æ®ï¼Œå¯ä»¥æ‰§è¡Œï¼š git fetch \u003cremote\u003e è¿™ä¸ªå‘½ä»¤ä¼šè®¿é—®è¿œç¨‹ä»“åº“ï¼Œä»ä¸­æ‹‰å–æ‰€æœ‰ä½ è¿˜æ²¡æœ‰çš„æ•°æ®ã€‚ æ‰§è¡Œå®Œæˆåï¼Œä½ å°†ä¼šæ‹¥æœ‰é‚£ä¸ªè¿œç¨‹ä»“åº“ä¸­æ‰€æœ‰åˆ†æ”¯çš„å¼•ç”¨ï¼Œå¯ä»¥éšæ—¶åˆå¹¶æˆ–æŸ¥çœ‹ã€‚ æ³¨æ„ï¼š git fetch å‘½ä»¤åªä¼šå°†æ•°æ®ä¸‹è½½åˆ°ä½ çš„æœ¬åœ°ä»“åº“â€”â€”å®ƒå¹¶ä¸ä¼šè‡ªåŠ¨åˆå¹¶æˆ–ä¿®æ”¹ä½ å½“å‰çš„å·¥ä½œã€‚ å½“å‡†å¤‡å¥½æ—¶ä½ å¿…é¡»æ‰‹åŠ¨å°†å…¶åˆå¹¶å…¥ä½ çš„å·¥ä½œã€‚ git pull ç”¨ git pull å‘½ä»¤æ¥è‡ªåŠ¨æŠ“å–ååˆå¹¶è¯¥è¿œç¨‹åˆ†æ”¯åˆ°å½“å‰åˆ†æ”¯ã€‚ è¿™æˆ–è®¸æ˜¯ä¸ªæ›´åŠ ç®€å•èˆ’æœçš„å·¥ä½œæµç¨‹ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œgit clone å‘½ä»¤ä¼šè‡ªåŠ¨è®¾ç½®æœ¬åœ° master åˆ†æ”¯è·Ÿè¸ªå…‹éš†çš„è¿œç¨‹ä»“åº“çš„ master åˆ†æ”¯ï¼ˆæˆ–å…¶å®ƒåå­—çš„é»˜è®¤åˆ†æ”¯ï¼‰ã€‚ è¿è¡Œ git pull é€šå¸¸ä¼šä»æœ€åˆå…‹éš†çš„æœåŠ¡å™¨ä¸ŠæŠ“å–æ•°æ®å¹¶è‡ªåŠ¨å°è¯•åˆå¹¶åˆ°å½“å‰æ‰€åœ¨çš„åˆ†æ”¯ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/:4:3","tags":["Git"],"title":"GitåŸºç¡€ä¸å‘½ä»¤","uri":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"æ¨é€åˆ°è¿œç¨‹ä»“åº“ git push \u003cremote\u003e \u003cbranch\u003e # git push origin master ","date":"2020-11-18","objectID":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/:4:4","tags":["Git"],"title":"GitåŸºç¡€ä¸å‘½ä»¤","uri":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"æŸ¥çœ‹æŸä¸ªè¿œç¨‹ä»“åº“ git remote show \u003cremote\u003e # git remote show origin æŸ¥çœ‹è¿œç¨‹ä»“åº“çš„è¯¦ç»†ä¿¡æ¯ã€‚è¿™ä¸ªå‘½ä»¤åˆ—å‡ºäº†å½“ä½ åœ¨ç‰¹å®šçš„åˆ†æ”¯ä¸Šæ‰§è¡Œ git push ä¼šè‡ªåŠ¨åœ°æ¨é€åˆ°å“ªä¸€ä¸ªè¿œç¨‹åˆ†æ”¯ ","date":"2020-11-18","objectID":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/:4:5","tags":["Git"],"title":"GitåŸºç¡€ä¸å‘½ä»¤","uri":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"è¿œç¨‹ä»“åº“çš„é‡å‘½åä¸ç§»é™¤ git remote rename \u003cåŸå\u003e \u003cæ–°å\u003e # é‡å‘½å git remote remove paul \u003cremote\u003e# ç§»é™¤è¿œç¨‹ä»“åº“ ","date":"2020-11-18","objectID":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/:4:6","tags":["Git"],"title":"GitåŸºç¡€ä¸å‘½ä»¤","uri":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"Git åŸºç¡€ - æ‰“æ ‡ç­¾ ","date":"2020-11-18","objectID":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/:5:0","tags":["Git"],"title":"GitåŸºç¡€ä¸å‘½ä»¤","uri":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"åˆ—å‡ºæ ‡ç­¾ git tag # å®Œæ•´æ ‡ç­¾åˆ—è¡¨ git tag -l \"v2.0*\" # åªæ˜¾ç¤ºåŒ…å« v2.0 çš„æ ‡ç­¾ã€‚ æ³¨æ„åŠ æ˜Ÿå·(*) -l æˆ– --list éƒ½å¯ä»¥ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/:5:1","tags":["Git"],"title":"GitåŸºç¡€ä¸å‘½ä»¤","uri":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"åˆ›å»ºæ ‡ç­¾ Git æ”¯æŒä¸¤ç§æ ‡ç­¾ï¼šè½»é‡æ ‡ç­¾ï¼ˆlightweightï¼‰ä¸é™„æ³¨æ ‡ç­¾ï¼ˆannotatedï¼‰ã€‚ è½»é‡æ ‡ç­¾å¾ˆåƒä¸€ä¸ªä¸ä¼šæ”¹å˜çš„åˆ†æ”¯â€”â€”å®ƒåªæ˜¯æŸä¸ªç‰¹å®šæäº¤çš„å¼•ç”¨ã€‚ è€Œé™„æ³¨æ ‡ç­¾æ˜¯å­˜å‚¨åœ¨ Git æ•°æ®åº“ä¸­çš„ä¸€ä¸ªå®Œæ•´å¯¹è±¡ï¼Œ å®ƒä»¬æ˜¯å¯ä»¥è¢«æ ¡éªŒçš„ï¼Œå…¶ä¸­åŒ…å«æ‰“æ ‡ç­¾è€…çš„åå­—ã€ç”µå­é‚®ä»¶åœ°å€ã€æ—¥æœŸæ—¶é—´ï¼Œ æ­¤å¤–è¿˜æœ‰ä¸€ä¸ªæ ‡ç­¾ä¿¡æ¯ï¼Œå¹¶ä¸”å¯ä»¥ä½¿ç”¨ GNU Privacy Guard ï¼ˆGPGï¼‰ç­¾åå¹¶éªŒè¯ã€‚ é€šå¸¸ä¼šå»ºè®®åˆ›å»ºé™„æ³¨æ ‡ç­¾ï¼Œè¿™æ ·ä½ å¯ä»¥æ‹¥æœ‰ä»¥ä¸Šæ‰€æœ‰ä¿¡æ¯ã€‚ä½†æ˜¯å¦‚æœä½ åªæ˜¯æƒ³ç”¨ä¸€ä¸ªä¸´æ—¶çš„æ ‡ç­¾ï¼Œ æˆ–è€…å› ä¸ºæŸäº›åŸå› ä¸æƒ³è¦ä¿å­˜è¿™äº›ä¿¡æ¯ï¼Œé‚£ä¹ˆä¹Ÿå¯ä»¥ç”¨è½»é‡æ ‡ç­¾ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/:5:2","tags":["Git"],"title":"GitåŸºç¡€ä¸å‘½ä»¤","uri":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"é™„æ³¨æ ‡ç­¾ git tag -a v1.4 -m \"my version 1.4\" # -aè¡¨ç¤ºaddï¼Œ -m è¡¨ç¤ºé™„ä»¶ä¿¡æ¯ é€šè¿‡ä½¿ç”¨ git show å‘½ä»¤å¯ä»¥çœ‹åˆ°æ ‡ç­¾ä¿¡æ¯å’Œä¸ä¹‹å¯¹åº”çš„æäº¤ä¿¡æ¯ï¼š git show v1.4 ","date":"2020-11-18","objectID":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/:5:3","tags":["Git"],"title":"GitåŸºç¡€ä¸å‘½ä»¤","uri":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"è½»é‡æ ‡ç­¾ è½»é‡æ ‡ç­¾æœ¬è´¨ä¸Šæ˜¯å°†æäº¤æ ¡éªŒå’Œå­˜å‚¨åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­â€”â€”æ²¡æœ‰ä¿å­˜ä»»ä½•å…¶ä»–ä¿¡æ¯ã€‚ åˆ›å»ºè½»é‡æ ‡ç­¾ï¼Œä¸éœ€è¦ä½¿ç”¨ -aã€-s æˆ– -m é€‰é¡¹ï¼Œåªéœ€è¦æä¾›æ ‡ç­¾åå­—ï¼š git tag v1.4-lw # ä¸éœ€è¦æ·»åŠ é€‰é¡¹ è¿™æ—¶ï¼Œå¦‚æœåœ¨æ ‡ç­¾ä¸Šè¿è¡Œ git showï¼Œä½ ä¸ä¼šçœ‹åˆ°é¢å¤–çš„æ ‡ç­¾ä¿¡æ¯ã€‚ å‘½ä»¤åªä¼šæ˜¾ç¤ºå‡ºæäº¤ä¿¡æ¯ï¼š $ git show v1.4-lw commit ca82a6dff817ec66f44342007202690a93763949 Author: Scott Chacon \u003cschacon@gee-mail.com\u003e Date: Mon Mar 17 21:52:11 2008 -0700 ","date":"2020-11-18","objectID":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/:5:4","tags":["Git"],"title":"GitåŸºç¡€ä¸å‘½ä»¤","uri":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"åæœŸæ‰“æ ‡ç­¾ ä½ ä¹Ÿå¯ä»¥å¯¹è¿‡å»çš„æäº¤æ‰“æ ‡ç­¾ã€‚ å‡è®¾æäº¤å†å²æ˜¯è¿™æ ·çš„ï¼š $ git log --pretty=oneline 166ae0c4d3f420721acbb115cc33848dfcc2121a started write support 9fceb02d0ae598e95dc970b74767f19372d61af8 updated rakefile 8a5cbc430f1a9c3d00faaeffd07798508422908a updated readme ç°åœ¨ï¼Œå‡è®¾åœ¨ v1.2 æ—¶ä½ å¿˜è®°ç»™é¡¹ç›®æ‰“æ ‡ç­¾ï¼Œä¹Ÿå°±æ˜¯åœ¨ â€œupdated rakefileâ€ æäº¤ã€‚ ä½ å¯ä»¥åœ¨ä¹‹åè¡¥ä¸Šæ ‡ç­¾ã€‚ è¦åœ¨é‚£ä¸ªæäº¤ä¸Šæ‰“æ ‡ç­¾ï¼Œä½ éœ€è¦åœ¨å‘½ä»¤çš„æœ«å°¾æŒ‡å®šæäº¤çš„æ ¡éªŒå’Œï¼ˆæˆ–éƒ¨åˆ†æ ¡éªŒå’Œï¼‰ï¼š $ git tag -a v1.2 9fceb02 # æ‰“çš„æ ‡ç­¾å±äºé™„æ³¨æ ‡ç­¾ ","date":"2020-11-18","objectID":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/:5:5","tags":["Git"],"title":"GitåŸºç¡€ä¸å‘½ä»¤","uri":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"å…±äº«æ ‡ç­¾ git push å‘½ä»¤å¹¶ä¸ä¼šä¼ é€æ ‡ç­¾åˆ°è¿œç¨‹ä»“åº“æœåŠ¡å™¨ä¸Šã€‚ åœ¨åˆ›å»ºå®Œæ ‡ç­¾åä½ å¿…é¡»æ˜¾å¼åœ°æ¨é€æ ‡ç­¾åˆ°å…±äº«æœåŠ¡å™¨ä¸Šã€‚ è¿™ä¸ªè¿‡ç¨‹å°±åƒå…±äº«è¿œç¨‹åˆ†æ”¯ä¸€æ ·â€”â€”ä½ å¯ä»¥è¿è¡Œ git push origin \u003ctagname\u003eã€‚ git push origin v1.5 # æ˜¾å¼åœ°æ¨é€æ ‡ç­¾åˆ°è¿œç¨‹ä»“åº“ git push origin --tags # ä¸€æ¬¡æ€§æ¨é€æ‰€æœ‰ä¸åœ¨è¿œç¨‹ä»“åº“ä¸Šçš„æ ‡ç­¾ ç°åœ¨ï¼Œå½“å…¶ä»–äººä»ä»“åº“ä¸­å…‹éš†æˆ–æ‹‰å–ï¼Œä»–ä»¬ä¹Ÿèƒ½å¾—åˆ°ä½ çš„é‚£äº›æ ‡ç­¾ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/:5:6","tags":["Git"],"title":"GitåŸºç¡€ä¸å‘½ä»¤","uri":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"åˆ é™¤æ ‡ç­¾ è¦åˆ é™¤æ‰ä½ æœ¬åœ°ä»“åº“ä¸Šçš„æ ‡ç­¾ï¼Œå¯ä»¥ä½¿ç”¨å‘½ä»¤ git tag -d \u003ctagname\u003eã€‚ ä¾‹å¦‚ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ é™¤ä¸€ä¸ªè½»é‡æ ‡ç­¾ï¼š $ git tag -d v1.4-lw Deleted tag 'v1.4-lw' (was e7d5add) æ³¨æ„ä¸Šè¿°å‘½ä»¤å¹¶ä¸ä¼šä»ä»»ä½•è¿œç¨‹ä»“åº“ä¸­ç§»é™¤è¿™ä¸ªæ ‡ç­¾ï¼Œä½ å¿…é¡»ç”¨ git push \u003cremote\u003e :refs/tags/\u003ctagname\u003e æ¥æ›´æ–°ä½ çš„è¿œç¨‹ä»“åº“ï¼š ç¬¬ä¸€ç§å˜ä½“æ˜¯ git push \u003cremote\u003e :refs/tags/\u003ctagname\u003e ï¼š $ git push origin :refs/tags/v1.4-lw To /git@github.com:schacon/simplegit.git - [deleted] v1.4-lw ä¸Šé¢è¿™ç§æ“ä½œçš„å«ä¹‰æ˜¯ï¼Œå°†å†’å·å‰é¢çš„ç©ºå€¼æ¨é€åˆ°è¿œç¨‹æ ‡ç­¾åï¼Œä»è€Œé«˜æ•ˆåœ°åˆ é™¤å®ƒã€‚ ç¬¬äºŒç§æ›´ç›´è§‚çš„åˆ é™¤è¿œç¨‹æ ‡ç­¾çš„æ–¹å¼æ˜¯ï¼š $ git push origin --delete \u003ctagname\u003e ","date":"2020-11-18","objectID":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/:5:7","tags":["Git"],"title":"GitåŸºç¡€ä¸å‘½ä»¤","uri":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"æ£€å‡ºæ ‡ç­¾ å¦‚æœä½ æƒ³æŸ¥çœ‹æŸä¸ªæ ‡ç­¾æ‰€æŒ‡å‘çš„æ–‡ä»¶ç‰ˆæœ¬ï¼Œå¯ä»¥ä½¿ç”¨ git checkout å‘½ä»¤ï¼Œ è™½ç„¶è¿™ä¼šä½¿ä½ çš„ä»“åº“å¤„äºâ€œåˆ†ç¦»å¤´æŒ‡é’ˆï¼ˆdetached HEADï¼‰â€çš„çŠ¶æ€â€”â€”è¿™ä¸ªçŠ¶æ€æœ‰äº›ä¸å¥½çš„å‰¯ä½œç”¨ï¼š $ git checkout 2.0.0 Note: checking out '2.0.0'. You are in 'detached HEAD' state. You can look around, make experimental changes and commit them, and you can discard any commits you make in this state without impacting any branches by performing another checkout. If you want to create a new branch to retain commits you create, you may do so (now or later) by using -b with the checkout command again. Example: git checkout -b \u003cnew-branch\u003e HEAD is now at 99ada87... Merge pull request #89 from schacon/appendix-final $ git checkout 2.0-beta-0.1 Previous HEAD position was 99ada87... Merge pull request #89 from schacon/appendix-final HEAD is now at df3f601... add atlas.json and cover image åœ¨â€œåˆ†ç¦»å¤´æŒ‡é’ˆâ€çŠ¶æ€ä¸‹ï¼Œå¦‚æœä½ åšäº†æŸäº›æ›´æ”¹ç„¶åæäº¤å®ƒä»¬ï¼Œæ ‡ç­¾ä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼Œ ä½†ä½ çš„æ–°æäº¤å°†ä¸å±äºä»»ä½•åˆ†æ”¯ï¼Œå¹¶ä¸”å°†æ— æ³•è®¿é—®ï¼Œé™¤éé€šè¿‡ç¡®åˆ‡çš„æäº¤å“ˆå¸Œæ‰èƒ½è®¿é—®ã€‚ å› æ­¤ï¼Œå¦‚æœä½ éœ€è¦è¿›è¡Œæ›´æ”¹ï¼Œæ¯”å¦‚ä½ è¦ä¿®å¤æ—§ç‰ˆæœ¬ä¸­çš„é”™è¯¯ï¼Œé‚£ä¹ˆé€šå¸¸éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°åˆ†æ”¯ï¼š $ git checkout -b version2 v2.0.0 Switched to a new branch 'version2' å¦‚æœåœ¨è¿™ä¹‹ååˆè¿›è¡Œäº†ä¸€æ¬¡æäº¤ï¼Œversion2 åˆ†æ”¯å°±ä¼šå› ä¸ºè¿™ä¸ªæ”¹åŠ¨å‘å‰ç§»åŠ¨ï¼Œ æ­¤æ—¶å®ƒå°±ä¼šå’Œ v2.0.0 æ ‡ç­¾ç¨å¾®æœ‰äº›ä¸åŒï¼Œè¿™æ—¶å°±è¦å½“å¿ƒäº†ã€‚ ","date":"2020-11-18","objectID":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/:5:8","tags":["Git"],"title":"GitåŸºç¡€ä¸å‘½ä»¤","uri":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"Git å‘½ä»¤åˆ«å Git å¹¶ä¸ä¼šåœ¨ä½ è¾“å…¥éƒ¨åˆ†å‘½ä»¤æ—¶è‡ªåŠ¨æ¨æ–­å‡ºä½ æƒ³è¦çš„å‘½ä»¤ã€‚ å¦‚æœä¸æƒ³æ¯æ¬¡éƒ½è¾“å…¥å®Œæ•´çš„ Git å‘½ä»¤ï¼Œå¯ä»¥é€šè¿‡ git config æ–‡ä»¶æ¥è½»æ¾åœ°ä¸ºæ¯ä¸€ä¸ªå‘½ä»¤è®¾ç½®ä¸€ä¸ªåˆ«åã€‚ è¿™é‡Œæœ‰ä¸€äº›ä¾‹å­ä½ å¯ä»¥è¯•è¯•ï¼š $ git config --global alias.co checkout $ git config --global alias.br branch $ git config --global alias.ci commit $ git config --global alias.st status è¿™æ„å‘³ç€ï¼Œå½“è¦è¾“å…¥ git commit æ—¶ï¼Œåªéœ€è¦è¾“å…¥ git ciã€‚ åœ¨åˆ›å»ºä½ è®¤ä¸ºåº”è¯¥å­˜åœ¨çš„å‘½ä»¤æ—¶è¿™ä¸ªæŠ€æœ¯ä¼šå¾ˆæœ‰ç”¨ã€‚ ä¾‹å¦‚ï¼Œä¸ºäº†è§£å†³å–æ¶ˆæš‚å­˜æ–‡ä»¶çš„æ˜“ç”¨æ€§é—®é¢˜ï¼Œå¯ä»¥å‘ Git ä¸­æ·»åŠ ä½ è‡ªå·±çš„å–æ¶ˆæš‚å­˜åˆ«åï¼š $ git config --global alias.unstage 'reset HEAD --' è¿™ä¼šä½¿ä¸‹é¢çš„ä¸¤ä¸ªå‘½ä»¤ç­‰ä»·ï¼š $ git unstage fileA $ git reset HEAD -- fileA è¿™æ ·çœ‹èµ·æ¥æ›´æ¸…æ¥šä¸€äº›ã€‚ é€šå¸¸ä¹Ÿä¼šæ·»åŠ ä¸€ä¸ª last å‘½ä»¤ï¼Œåƒè¿™æ ·ï¼š $ git config --global alias.last 'log -1 HEAD' è¿™æ ·ï¼Œå¯ä»¥è½»æ¾åœ°çœ‹åˆ°æœ€åä¸€æ¬¡æäº¤ï¼š $ git last commit 66938dae3329c7aebe598c2246a8e6af90d04646 Author: Josh Goebel \u003cdreamer3@example.com\u003e Date: Tue Aug 26 19:48:51 2008 +0800 test for current head Signed-off-by: Scott Chacon \u003cschacon@example.com\u003e å¯ä»¥çœ‹å‡ºï¼ŒGit åªæ˜¯ç®€å•åœ°å°†åˆ«åæ›¿æ¢ä¸ºå¯¹åº”çš„å‘½ä»¤ã€‚ ç„¶è€Œï¼Œä½ å¯èƒ½æƒ³è¦æ‰§è¡Œå¤–éƒ¨å‘½ä»¤ï¼Œè€Œä¸æ˜¯ä¸€ä¸ª Git å­å‘½ä»¤ã€‚ å¦‚æœæ˜¯é‚£æ ·çš„è¯ï¼Œå¯ä»¥åœ¨å‘½ä»¤å‰é¢åŠ å…¥ ! ç¬¦å·ã€‚ å¦‚æœä½ è‡ªå·±è¦å†™ä¸€äº›ä¸ Git ä»“åº“åä½œçš„å·¥å…·çš„è¯ï¼Œé‚£ä¼šå¾ˆæœ‰ç”¨ã€‚ æˆ‘ä»¬ç°åœ¨æ¼”ç¤ºå°† git visual å®šä¹‰ä¸º gitk çš„åˆ«åï¼š $ git config --global alias.visual '!gitk' ","date":"2020-11-18","objectID":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/:6:0","tags":["Git"],"title":"GitåŸºç¡€ä¸å‘½ä»¤","uri":"/posts/git%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%91%BD%E4%BB%A4/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"å¸¸ç”¨Gitå‘½ä»¤æ¸…å• ä¸€èˆ¬æ¥è¯´ï¼Œæ—¥å¸¸ä½¿ç”¨åªè¦è®°ä½ä¸‹å›¾6ä¸ªå‘½ä»¤ï¼Œå°±å¯ä»¥äº†ã€‚ä½†æ˜¯ç†Ÿç»ƒä½¿ç”¨ï¼Œææ€•è¦è®°ä½60ï½100ä¸ªå‘½ä»¤ã€‚ ä¸‹é¢æ˜¯æˆ‘æ•´ç†çš„å¸¸ç”¨ Git å‘½ä»¤æ¸…å•ã€‚å‡ ä¸ªä¸“ç”¨åè¯çš„è¯‘åå¦‚ä¸‹ã€‚ Workspaceï¼šå·¥ä½œåŒº Index / Stageï¼šæš‚å­˜åŒº Repositoryï¼šä»“åº“åŒºï¼ˆæˆ–æœ¬åœ°ä»“åº“ï¼‰ Remoteï¼šè¿œç¨‹ä»“åº“ ","date":"2020-11-18","objectID":"/posts/%E5%B8%B8%E7%94%A8git%E5%91%BD%E4%BB%A4%E6%B8%85%E5%8D%95/:0:0","tags":["Git"],"title":"å¸¸ç”¨Gitå‘½ä»¤æ¸…å•","uri":"/posts/%E5%B8%B8%E7%94%A8git%E5%91%BD%E4%BB%A4%E6%B8%85%E5%8D%95/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"ä¸€ã€æ–°å»ºä»£ç åº“ # åœ¨å½“å‰ç›®å½•æ–°å»ºä¸€ä¸ªGitä»£ç åº“ $ git init # æ–°å»ºä¸€ä¸ªç›®å½•ï¼Œå°†å…¶åˆå§‹åŒ–ä¸ºGitä»£ç åº“ $ git init [project-name] # ä¸‹è½½ä¸€ä¸ªé¡¹ç›®å’Œå®ƒçš„æ•´ä¸ªä»£ç å†å² $ git clone [url] ","date":"2020-11-18","objectID":"/posts/%E5%B8%B8%E7%94%A8git%E5%91%BD%E4%BB%A4%E6%B8%85%E5%8D%95/:1:0","tags":["Git"],"title":"å¸¸ç”¨Gitå‘½ä»¤æ¸…å•","uri":"/posts/%E5%B8%B8%E7%94%A8git%E5%91%BD%E4%BB%A4%E6%B8%85%E5%8D%95/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"äºŒã€é…ç½® Gitçš„è®¾ç½®æ–‡ä»¶ä¸º.gitconfigï¼Œå®ƒå¯ä»¥åœ¨ç”¨æˆ·ä¸»ç›®å½•ä¸‹ï¼ˆå…¨å±€é…ç½®ï¼‰ï¼Œä¹Ÿå¯ä»¥åœ¨é¡¹ç›®ç›®å½•ä¸‹ï¼ˆé¡¹ç›®é…ç½®ï¼‰ã€‚ # æ˜¾ç¤ºå½“å‰çš„Gité…ç½® $ git config --list # ç¼–è¾‘Gité…ç½®æ–‡ä»¶ $ git config -e [--global] # è®¾ç½®æäº¤ä»£ç æ—¶çš„ç”¨æˆ·ä¿¡æ¯ $ git config [--global] user.name \"[name]\" $ git config [--global] user.email \"[email address]\" ","date":"2020-11-18","objectID":"/posts/%E5%B8%B8%E7%94%A8git%E5%91%BD%E4%BB%A4%E6%B8%85%E5%8D%95/:2:0","tags":["Git"],"title":"å¸¸ç”¨Gitå‘½ä»¤æ¸…å•","uri":"/posts/%E5%B8%B8%E7%94%A8git%E5%91%BD%E4%BB%A4%E6%B8%85%E5%8D%95/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"ä¸‰ã€å¢åŠ /åˆ é™¤æ–‡ä»¶ # æ·»åŠ æŒ‡å®šæ–‡ä»¶åˆ°æš‚å­˜åŒº $ git add [file1] [file2] ... # æ·»åŠ æŒ‡å®šç›®å½•åˆ°æš‚å­˜åŒºï¼ŒåŒ…æ‹¬å­ç›®å½• $ git add [dir] # æ·»åŠ å½“å‰ç›®å½•çš„æ‰€æœ‰æ–‡ä»¶åˆ°æš‚å­˜åŒº $ git add . # æ·»åŠ æ¯ä¸ªå˜åŒ–å‰ï¼Œéƒ½ä¼šè¦æ±‚ç¡®è®¤ # å¯¹äºåŒä¸€ä¸ªæ–‡ä»¶çš„å¤šå¤„å˜åŒ–ï¼Œå¯ä»¥å®ç°åˆ†æ¬¡æäº¤ $ git add -p # åˆ é™¤å·¥ä½œåŒºæ–‡ä»¶ï¼Œå¹¶ä¸”å°†è¿™æ¬¡åˆ é™¤æ”¾å…¥æš‚å­˜åŒº $ git rm [file1] [file2] ... # åœæ­¢è¿½è¸ªæŒ‡å®šæ–‡ä»¶ï¼Œä½†è¯¥æ–‡ä»¶ä¼šä¿ç•™åœ¨å·¥ä½œåŒº $ git rm --cached [file] # æ”¹åæ–‡ä»¶ï¼Œå¹¶ä¸”å°†è¿™ä¸ªæ”¹åæ”¾å…¥æš‚å­˜åŒº $ git mv [file-original] [file-renamed] ","date":"2020-11-18","objectID":"/posts/%E5%B8%B8%E7%94%A8git%E5%91%BD%E4%BB%A4%E6%B8%85%E5%8D%95/:3:0","tags":["Git"],"title":"å¸¸ç”¨Gitå‘½ä»¤æ¸…å•","uri":"/posts/%E5%B8%B8%E7%94%A8git%E5%91%BD%E4%BB%A4%E6%B8%85%E5%8D%95/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"å››ã€ä»£ç æäº¤ # æäº¤æš‚å­˜åŒºåˆ°ä»“åº“åŒº $ git commit -m [message] # æäº¤æš‚å­˜åŒºçš„æŒ‡å®šæ–‡ä»¶åˆ°ä»“åº“åŒº $ git commit [file1] [file2] ... -m [message] # æäº¤å·¥ä½œåŒºè‡ªä¸Šæ¬¡commitä¹‹åçš„å˜åŒ–ï¼Œç›´æ¥åˆ°ä»“åº“åŒº $ git commit -a # æäº¤æ—¶æ˜¾ç¤ºæ‰€æœ‰diffä¿¡æ¯ $ git commit -v # ä½¿ç”¨ä¸€æ¬¡æ–°çš„commitï¼Œæ›¿ä»£ä¸Šä¸€æ¬¡æäº¤ # å¦‚æœä»£ç æ²¡æœ‰ä»»ä½•æ–°å˜åŒ–ï¼Œåˆ™ç”¨æ¥æ”¹å†™ä¸Šä¸€æ¬¡commitçš„æäº¤ä¿¡æ¯ $ git commit --amend -m [message] # é‡åšä¸Šä¸€æ¬¡commitï¼Œå¹¶åŒ…æ‹¬æŒ‡å®šæ–‡ä»¶çš„æ–°å˜åŒ– $ git commit --amend [file1] [file2] ... ","date":"2020-11-18","objectID":"/posts/%E5%B8%B8%E7%94%A8git%E5%91%BD%E4%BB%A4%E6%B8%85%E5%8D%95/:4:0","tags":["Git"],"title":"å¸¸ç”¨Gitå‘½ä»¤æ¸…å•","uri":"/posts/%E5%B8%B8%E7%94%A8git%E5%91%BD%E4%BB%A4%E6%B8%85%E5%8D%95/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"äº”ã€åˆ†æ”¯ # åˆ—å‡ºæ‰€æœ‰æœ¬åœ°åˆ†æ”¯ $ git branch # åˆ—å‡ºæ‰€æœ‰è¿œç¨‹åˆ†æ”¯ $ git branch -r # åˆ—å‡ºæ‰€æœ‰æœ¬åœ°åˆ†æ”¯å’Œè¿œç¨‹åˆ†æ”¯ $ git branch -a # æ–°å»ºä¸€ä¸ªåˆ†æ”¯ï¼Œä½†ä¾ç„¶åœç•™åœ¨å½“å‰åˆ†æ”¯ $ git branch [branch-name] # æ–°å»ºä¸€ä¸ªåˆ†æ”¯ï¼Œå¹¶åˆ‡æ¢åˆ°è¯¥åˆ†æ”¯ $ git checkout -b [branch] # æ–°å»ºä¸€ä¸ªåˆ†æ”¯ï¼ŒæŒ‡å‘æŒ‡å®šcommit $ git branch [branch] [commit] # æ–°å»ºä¸€ä¸ªåˆ†æ”¯ï¼Œä¸æŒ‡å®šçš„è¿œç¨‹åˆ†æ”¯å»ºç«‹è¿½è¸ªå…³ç³» $ git branch --track [branch] [remote-branch] # åˆ‡æ¢åˆ°æŒ‡å®šåˆ†æ”¯ï¼Œå¹¶æ›´æ–°å·¥ä½œåŒº $ git checkout [branch-name] # åˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªåˆ†æ”¯ $ git checkout - # å»ºç«‹è¿½è¸ªå…³ç³»ï¼Œåœ¨ç°æœ‰åˆ†æ”¯ä¸æŒ‡å®šçš„è¿œç¨‹åˆ†æ”¯ä¹‹é—´ $ git branch --set-upstream [branch] [remote-branch] # åˆå¹¶æŒ‡å®šåˆ†æ”¯åˆ°å½“å‰åˆ†æ”¯ $ git merge [branch] # é€‰æ‹©ä¸€ä¸ªcommitï¼Œåˆå¹¶è¿›å½“å‰åˆ†æ”¯ $ git cherry-pick [commit] # åˆ é™¤åˆ†æ”¯ $ git branch -d [branch-name] # åˆ é™¤è¿œç¨‹åˆ†æ”¯ $ git push origin --delete [branch-name] $ git branch -dr [remote/branch] ","date":"2020-11-18","objectID":"/posts/%E5%B8%B8%E7%94%A8git%E5%91%BD%E4%BB%A4%E6%B8%85%E5%8D%95/:5:0","tags":["Git"],"title":"å¸¸ç”¨Gitå‘½ä»¤æ¸…å•","uri":"/posts/%E5%B8%B8%E7%94%A8git%E5%91%BD%E4%BB%A4%E6%B8%85%E5%8D%95/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"å…­ã€æ ‡ç­¾ # åˆ—å‡ºæ‰€æœ‰tag $ git tag # æ–°å»ºä¸€ä¸ªtagåœ¨å½“å‰commit $ git tag [tag] # æ–°å»ºä¸€ä¸ªtagåœ¨æŒ‡å®šcommit $ git tag [tag] [commit] # åˆ é™¤æœ¬åœ°tag $ git tag -d [tag] # åˆ é™¤è¿œç¨‹tag $ git push origin :refs/tags/[tagName] # æŸ¥çœ‹tagä¿¡æ¯ $ git show [tag] # æäº¤æŒ‡å®štag $ git push [remote] [tag] # æäº¤æ‰€æœ‰tag $ git push [remote] --tags # æ–°å»ºä¸€ä¸ªåˆ†æ”¯ï¼ŒæŒ‡å‘æŸä¸ªtag $ git checkout -b [branch] [tag] ","date":"2020-11-18","objectID":"/posts/%E5%B8%B8%E7%94%A8git%E5%91%BD%E4%BB%A4%E6%B8%85%E5%8D%95/:6:0","tags":["Git"],"title":"å¸¸ç”¨Gitå‘½ä»¤æ¸…å•","uri":"/posts/%E5%B8%B8%E7%94%A8git%E5%91%BD%E4%BB%A4%E6%B8%85%E5%8D%95/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"ä¸ƒã€æŸ¥çœ‹ä¿¡æ¯ # æ˜¾ç¤ºæœ‰å˜æ›´çš„æ–‡ä»¶ $ git status # æ˜¾ç¤ºå½“å‰åˆ†æ”¯çš„ç‰ˆæœ¬å†å² $ git log # æ˜¾ç¤ºcommitå†å²ï¼Œä»¥åŠæ¯æ¬¡commitå‘ç”Ÿå˜æ›´çš„æ–‡ä»¶ $ git log --stat # æœç´¢æäº¤å†å²ï¼Œæ ¹æ®å…³é”®è¯ $ git log -S [keyword] # æ˜¾ç¤ºæŸä¸ªcommitä¹‹åçš„æ‰€æœ‰å˜åŠ¨ï¼Œæ¯ä¸ªcommitå æ®ä¸€è¡Œ $ git log [tag] HEAD --pretty=format:%s # æ˜¾ç¤ºæŸä¸ªcommitä¹‹åçš„æ‰€æœ‰å˜åŠ¨ï¼Œå…¶\"æäº¤è¯´æ˜\"å¿…é¡»ç¬¦åˆæœç´¢æ¡ä»¶ $ git log [tag] HEAD --grep feature # æ˜¾ç¤ºæŸä¸ªæ–‡ä»¶çš„ç‰ˆæœ¬å†å²ï¼ŒåŒ…æ‹¬æ–‡ä»¶æ”¹å $ git log --follow [file] $ git whatchanged [file] # æ˜¾ç¤ºæŒ‡å®šæ–‡ä»¶ç›¸å…³çš„æ¯ä¸€æ¬¡diff $ git log -p [file] # æ˜¾ç¤ºè¿‡å»5æ¬¡æäº¤ $ git log -5 --pretty --oneline # æ˜¾ç¤ºæ‰€æœ‰æäº¤è¿‡çš„ç”¨æˆ·ï¼ŒæŒ‰æäº¤æ¬¡æ•°æ’åº $ git shortlog -sn # æ˜¾ç¤ºæŒ‡å®šæ–‡ä»¶æ˜¯ä»€ä¹ˆäººåœ¨ä»€ä¹ˆæ—¶é—´ä¿®æ”¹è¿‡ $ git blame [file] # æ˜¾ç¤ºæš‚å­˜åŒºå’Œå·¥ä½œåŒºçš„å·®å¼‚ $ git diff # æ˜¾ç¤ºæš‚å­˜åŒºå’Œä¸Šä¸€ä¸ªcommitçš„å·®å¼‚ $ git diff --cached [file] # æ˜¾ç¤ºå·¥ä½œåŒºä¸å½“å‰åˆ†æ”¯æœ€æ–°commitä¹‹é—´çš„å·®å¼‚ $ git diff HEAD # æ˜¾ç¤ºä¸¤æ¬¡æäº¤ä¹‹é—´çš„å·®å¼‚ $ git diff [first-branch]...[second-branch] # æ˜¾ç¤ºä»Šå¤©ä½ å†™äº†å¤šå°‘è¡Œä»£ç  $ git diff --shortstat \"@{0 day ago}\" # æ˜¾ç¤ºæŸæ¬¡æäº¤çš„å…ƒæ•°æ®å’Œå†…å®¹å˜åŒ– $ git show [commit] # æ˜¾ç¤ºæŸæ¬¡æäº¤å‘ç”Ÿå˜åŒ–çš„æ–‡ä»¶ $ git show --name-only [commit] # æ˜¾ç¤ºæŸæ¬¡æäº¤æ—¶ï¼ŒæŸä¸ªæ–‡ä»¶çš„å†…å®¹ $ git show [commit]:[filename] # æ˜¾ç¤ºå½“å‰åˆ†æ”¯çš„æœ€è¿‘å‡ æ¬¡æäº¤ $ git reflog ","date":"2020-11-18","objectID":"/posts/%E5%B8%B8%E7%94%A8git%E5%91%BD%E4%BB%A4%E6%B8%85%E5%8D%95/:7:0","tags":["Git"],"title":"å¸¸ç”¨Gitå‘½ä»¤æ¸…å•","uri":"/posts/%E5%B8%B8%E7%94%A8git%E5%91%BD%E4%BB%A4%E6%B8%85%E5%8D%95/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"å…«ã€è¿œç¨‹åŒæ­¥ # ä¸‹è½½è¿œç¨‹ä»“åº“çš„æ‰€æœ‰å˜åŠ¨ $ git fetch [remote] # æ˜¾ç¤ºæ‰€æœ‰è¿œç¨‹ä»“åº“ $ git remote -v # æ˜¾ç¤ºæŸä¸ªè¿œç¨‹ä»“åº“çš„ä¿¡æ¯ $ git remote show [remote] # å¢åŠ ä¸€ä¸ªæ–°çš„è¿œç¨‹ä»“åº“ï¼Œå¹¶å‘½å $ git remote add [shortname] [url] # å–å›è¿œç¨‹ä»“åº“çš„å˜åŒ–ï¼Œå¹¶ä¸æœ¬åœ°åˆ†æ”¯åˆå¹¶ $ git pull [remote] [branch] # ä¸Šä¼ æœ¬åœ°æŒ‡å®šåˆ†æ”¯åˆ°è¿œç¨‹ä»“åº“ $ git push [remote] [branch] # å¼ºè¡Œæ¨é€å½“å‰åˆ†æ”¯åˆ°è¿œç¨‹ä»“åº“ï¼Œå³ä½¿æœ‰å†²çª $ git push [remote] --force # æ¨é€æ‰€æœ‰åˆ†æ”¯åˆ°è¿œç¨‹ä»“åº“ $ git push [remote] --all ","date":"2020-11-18","objectID":"/posts/%E5%B8%B8%E7%94%A8git%E5%91%BD%E4%BB%A4%E6%B8%85%E5%8D%95/:8:0","tags":["Git"],"title":"å¸¸ç”¨Gitå‘½ä»¤æ¸…å•","uri":"/posts/%E5%B8%B8%E7%94%A8git%E5%91%BD%E4%BB%A4%E6%B8%85%E5%8D%95/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"ä¹ã€æ’¤é”€ # æ¢å¤æš‚å­˜åŒºçš„æŒ‡å®šæ–‡ä»¶åˆ°å·¥ä½œåŒº $ git checkout [file] # æ¢å¤æŸä¸ªcommitçš„æŒ‡å®šæ–‡ä»¶åˆ°æš‚å­˜åŒºå’Œå·¥ä½œåŒº $ git checkout [commit] [file] # æ¢å¤æš‚å­˜åŒºçš„æ‰€æœ‰æ–‡ä»¶åˆ°å·¥ä½œåŒº $ git checkout . # é‡ç½®æš‚å­˜åŒºçš„æŒ‡å®šæ–‡ä»¶ï¼Œä¸ä¸Šä¸€æ¬¡commitä¿æŒä¸€è‡´ï¼Œä½†å·¥ä½œåŒºä¸å˜ $ git reset [file] # é‡ç½®æš‚å­˜åŒºä¸å·¥ä½œåŒºï¼Œä¸ä¸Šä¸€æ¬¡commitä¿æŒä¸€è‡´ $ git reset --hard # é‡ç½®å½“å‰åˆ†æ”¯çš„æŒ‡é’ˆä¸ºæŒ‡å®šcommitï¼ŒåŒæ—¶é‡ç½®æš‚å­˜åŒºï¼Œä½†å·¥ä½œåŒºä¸å˜ $ git reset [commit] # é‡ç½®å½“å‰åˆ†æ”¯çš„HEADä¸ºæŒ‡å®šcommitï¼ŒåŒæ—¶é‡ç½®æš‚å­˜åŒºå’Œå·¥ä½œåŒºï¼Œä¸æŒ‡å®šcommitä¸€è‡´ $ git reset --hard [commit] # é‡ç½®å½“å‰HEADä¸ºæŒ‡å®šcommitï¼Œä½†ä¿æŒæš‚å­˜åŒºå’Œå·¥ä½œåŒºä¸å˜ $ git reset --keep [commit] # æ–°å»ºä¸€ä¸ªcommitï¼Œç”¨æ¥æ’¤é”€æŒ‡å®šcommit # åè€…çš„æ‰€æœ‰å˜åŒ–éƒ½å°†è¢«å‰è€…æŠµæ¶ˆï¼Œå¹¶ä¸”åº”ç”¨åˆ°å½“å‰åˆ†æ”¯ $ git revert [commit] # æš‚æ—¶å°†æœªæäº¤çš„å˜åŒ–ç§»é™¤ï¼Œç¨åå†ç§»å…¥ $ git stash $ git stash pop ","date":"2020-11-18","objectID":"/posts/%E5%B8%B8%E7%94%A8git%E5%91%BD%E4%BB%A4%E6%B8%85%E5%8D%95/:9:0","tags":["Git"],"title":"å¸¸ç”¨Gitå‘½ä»¤æ¸…å•","uri":"/posts/%E5%B8%B8%E7%94%A8git%E5%91%BD%E4%BB%A4%E6%B8%85%E5%8D%95/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"åã€å¸¸ç”¨æ“ä½œç»„åˆ ","date":"2020-11-18","objectID":"/posts/%E5%B8%B8%E7%94%A8git%E5%91%BD%E4%BB%A4%E6%B8%85%E5%8D%95/:10:0","tags":["Git"],"title":"å¸¸ç”¨Gitå‘½ä»¤æ¸…å•","uri":"/posts/%E5%B8%B8%E7%94%A8git%E5%91%BD%E4%BB%A4%E6%B8%85%E5%8D%95/"},{"categories":["ã€ŠGitã€‹å­¦ä¹ ç¬”è®°"],"content":"1. ä¿®æ”¹æœ¬åœ°åˆ†æ”¯åå’Œè¿œç¨‹åˆ†æ”¯å git branch -m old_branch new_branch # é‡å‘½åæœ¬åœ°åˆ†æ”¯ git push origin :old_branch # åˆ é™¤è¿œç¨‹æ—§åˆ†æ”¯ï¼ˆåˆ†æ”¯åå‰æœ‰å†’å·ï¼‰ git push --set-upstream origin new_branch # æ¨é€æ–°çš„åˆ†æ”¯ï¼Œå¹¶è®¾ç½®æœ¬åœ°åˆ†æ”¯è·Ÿè¸ªæ–°çš„è¿œç¨‹åˆ†æ”¯ ç›¸å…³æ–‡ç« ï¼š ã€Šå¦‚ä½•æ’¤é”€ Git æ“ä½œï¼Ÿã€‹ ã€Šgit cherry-pick æ•™ç¨‹ã€‹ å¤åˆ¶æŸåˆ†æ”¯ä¸Šçš„éƒ¨åˆ†æäº¤åˆ°å¦ä¸€ä¸ªåˆ†æ”¯ä¸Šï¼ˆç›¸å¯¹äºå¯ä»¥é€‰æ‹©æŒ‡å®šæäº¤çš„ rebase æ“ä½œï¼‰ã€‚ å‘½ä»¤æ¸…å•æ¥æºï¼šhttps://www.ruanyifeng.com/blog/2015/12/git-cheat-sheet.html ","date":"2020-11-18","objectID":"/posts/%E5%B8%B8%E7%94%A8git%E5%91%BD%E4%BB%A4%E6%B8%85%E5%8D%95/:10:1","tags":["Git"],"title":"å¸¸ç”¨Gitå‘½ä»¤æ¸…å•","uri":"/posts/%E5%B8%B8%E7%94%A8git%E5%91%BD%E4%BB%A4%E6%B8%85%E5%8D%95/"},{"categories":null,"content":"ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬éƒ¨ç½²çš„ POD æ˜¯é€šè¿‡é›†ç¾¤è‡ªåŠ¨è°ƒåº¦é€‰æ‹©æŸä¸ªèŠ‚ç‚¹çš„ï¼Œé»˜è®¤æƒ…å†µä¸‹è°ƒåº¦å™¨è€ƒè™‘çš„æ˜¯èµ„æºè¶³å¤Ÿï¼Œå¹¶ä¸”è´Ÿè½½å°½é‡å¹³å‡ï¼Œä½†æ˜¯æœ‰çš„æ—¶å€™æˆ‘ä»¬éœ€è¦èƒ½å¤Ÿæ›´åŠ ç»†ç²’åº¦çš„å»æ§åˆ¶ POD çš„è°ƒåº¦ï¼Œæ¯”å¦‚æˆ‘ä»¬å†…éƒ¨çš„ä¸€äº›æœåŠ¡ gitlab ä¹‹ç±»çš„ä¹Ÿæ˜¯è·‘åœ¨Kubernetesé›†ç¾¤ä¸Šçš„ï¼Œæˆ‘ä»¬å°±ä¸å¸Œæœ›å¯¹å¤–çš„ä¸€äº›æœåŠ¡å’Œå†…éƒ¨çš„æœåŠ¡è·‘åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šäº†ï¼Œå®³æ€•å†…éƒ¨æœåŠ¡å¯¹å¤–éƒ¨çš„æœåŠ¡äº§ç”Ÿå½±å“ï¼›æœ‰çš„æ—¶å€™å‘¢æˆ‘ä»¬ä¸¤ä¸ªæœåŠ¡ç›´æ¥äº¤æµæ¯”è¾ƒé¢‘ç¹ï¼Œåˆå¸Œæœ›èƒ½å¤Ÿå°†è¿™ä¸¤ä¸ªæœåŠ¡çš„ POD è°ƒåº¦åˆ°åŒæ ·çš„èŠ‚ç‚¹ä¸Šã€‚è¿™å°±éœ€è¦ç”¨åˆ° Kubernetes é‡Œé¢çš„ä¸€ä¸ªæ¦‚å¿µï¼šäº²å’Œæ€§ï¼Œäº²å’Œæ€§ä¸»è¦åˆ†ä¸ºä¸¤ç±»ï¼šnodeAffinityå’ŒpodAffinityã€‚ ","date":"2018-03-08","objectID":"/posts/understand-kubernetes-affinity/:0:0","tags":["kubernetes","affinity","è°ƒåº¦"],"title":"ç†è§£ Kubernetes çš„äº²å’Œæ€§è°ƒåº¦","uri":"/posts/understand-kubernetes-affinity/"},{"categories":null,"content":"nodeSelector æˆ‘ä»¬çŸ¥é“labelæ˜¯kubernetesä¸­ä¸€ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µï¼Œç”¨æˆ·å¯ä»¥éå¸¸çµæ´»çš„åˆ©ç”¨ label æ¥ç®¡ç†é›†ç¾¤ä¸­çš„èµ„æºï¼Œæ¯”å¦‚æœ€å¸¸è§çš„ä¸€ä¸ªå°±æ˜¯ service é€šè¿‡åŒ¹é… label å»é€‰æ‹© POD çš„ã€‚è€Œ POD çš„è°ƒåº¦ä¹Ÿå¯ä»¥æ ¹æ®èŠ‚ç‚¹çš„ label è¿›è¡Œç‰¹å®šçš„éƒ¨ç½²ã€‚ æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤æŸ¥çœ‹æˆ‘ä»¬çš„ node çš„ labelï¼š $ kubectl get nodes --show-labels NAME STATUS ROLES AGE VERSION LABELS 192.168.1.140 Ready \u003cnone\u003e 42d v1.8.1 beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=192.168.1.140 192.168.1.161 Ready \u003cnone\u003e 118d v1.8.1 beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/cluster-service=true,kubernetes.io/hostname=192.168.1.161 192.168.1.170 Ready \u003cnone\u003e 118d v1.8.1 beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/cluster-service=true,kubernetes.io/hostname=192.168.1.170 192.168.1.172 Ready \u003cnone\u003e 114d v1.8.1 beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/cluster-service=true,kubernetes.io/hostname=192.168.1.172 ç°åœ¨æˆ‘ä»¬å…ˆç»™èŠ‚ç‚¹192.168.1.140å¢åŠ ä¸€ä¸ªsource=qikqiakçš„æ ‡ç­¾ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š $ kubectl label nodes 192.168.1.140 source=qikqiak node \"192.168.1.140\" labeled æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸Šé¢çš„--show-labelså‚æ•°å¯ä»¥æŸ¥çœ‹ä¸Šè¿°æ ‡ç­¾æ˜¯å¦ç”Ÿæ•ˆã€‚å½“ node è¢«æ‰“ä¸Šäº†ç›¸å…³æ ‡ç­¾åï¼Œåœ¨è°ƒåº¦çš„æ—¶å€™å°±å¯ä»¥ä½¿ç”¨è¿™äº›æ ‡ç­¾äº†ï¼Œåªéœ€è¦åœ¨ POD çš„ spec å­—æ®µä¸­æ·»åŠ nodeSelectorå­—æ®µï¼Œé‡Œé¢æ˜¯æˆ‘ä»¬éœ€è¦è¢«è°ƒåº¦çš„èŠ‚ç‚¹çš„ labelã€‚ä¾‹å¦‚ï¼Œä¸‹é¢æ˜¯æˆ‘ä»¬ä¹‹å‰çš„ä¸€ä¸ªé»˜è®¤çš„ busybox POD çš„ YAML æ–‡ä»¶ï¼š apiVersion: v1 kind: Pod metadata: labels: app: busybox-pod name: test-busybox spec: containers: - command: - sleep - \"3600\" image: busybox imagePullPolicy: Always name: test-busybox ç„¶åæˆ‘éœ€è¦è®©ä¸Šé¢çš„ POD è¢«è°ƒåº¦åˆ°140çš„èŠ‚ç‚¹ä¸Šï¼Œé‚£ä¹ˆæœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯å»åŒ¹é…140ä¸Šé¢çš„ labelï¼Œå¦‚ä¸‹ï¼š apiVersion: v1 kind: Pod metadata: labels: app: busybox-pod name: test-busybox spec: containers: - command: - sleep - \"3600\" image: busybox imagePullPolicy: Always name: test-busybox nodeSelector: source: qikqiak ç„¶åæˆ‘ä»¬å¯ä»¥é€šè¿‡ describe å‘½ä»¤æŸ¥çœ‹è°ƒåº¦ç»“æœï¼š $ kubectl describe pod test-busybox ...... Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal Scheduled 49s default-scheduler Successfully assigned test-busybox to 192.168.1.140 Normal SuccessfulMountVolume 49s kubelet, 192.168.1.140 MountVolume.SetUp succeeded for volume \"default-token-hmpbz\" Normal Pulling 49s kubelet, 192.168.1.140 pulling image \"busybox\" Normal Pulled 41s kubelet, 192.168.1.140 Successfully pulled image \"busybox\" Normal Created 41s kubelet, 192.168.1.140 Created container Normal Started 41s kubelet, 192.168.1.140 Started container æˆ‘ä»¬å¯ä»¥çœ‹åˆ° Events ä¸‹é¢çš„ä¿¡æ¯ï¼Œä¸Šé¢çš„ POD è¢«æ­£ç¡®çš„è°ƒåº¦åˆ°äº†140èŠ‚ç‚¹ã€‚é€šè¿‡ä¸Šé¢çš„ä¾‹å­æˆ‘ä»¬å¯ä»¥æ„Ÿå—åˆ°nodeSelectorçš„æ–¹å¼æ¯”è¾ƒç›´è§‚ï¼Œä½†æ˜¯è¿˜å¤Ÿçµæ´»ï¼Œæ§åˆ¶ç²’åº¦åå¤§ï¼Œä¸‹é¢æˆ‘ä»¬å†çœ‹å¦å¤–ä¸€ç§æ›´åŠ çµæ´»çš„æ–¹å¼ï¼šnodeAffinityã€‚ ","date":"2018-03-08","objectID":"/posts/understand-kubernetes-affinity/:1:0","tags":["kubernetes","affinity","è°ƒåº¦"],"title":"ç†è§£ Kubernetes çš„äº²å’Œæ€§è°ƒåº¦","uri":"/posts/understand-kubernetes-affinity/"},{"categories":null,"content":"nodeAffinity nodeAffinityå°±æ˜¯èŠ‚ç‚¹äº²å’Œæ€§ï¼Œç›¸å¯¹åº”çš„æ˜¯Anti-Affinityï¼Œå°±æ˜¯åäº²å’Œæ€§ï¼Œè¿™ç§æ–¹æ³•æ¯”ä¸Šé¢çš„nodeSelectoræ›´åŠ çµæ´»ï¼Œå®ƒå¯ä»¥è¿›è¡Œä¸€äº›ç®€å•çš„é€»è¾‘ç»„åˆäº†ï¼Œä¸åªæ˜¯ç®€å•çš„ç›¸ç­‰åŒ¹é…ã€‚ è°ƒåº¦å¯ä»¥åˆ†æˆè½¯ç­–ç•¥å’Œç¡¬ç­–ç•¥ä¸¤ç§æ–¹å¼ï¼Œè½¯ç­–ç•¥å°±æ˜¯å¦‚æœä½ æ²¡æœ‰æ»¡è¶³è°ƒåº¦è¦æ±‚çš„èŠ‚ç‚¹çš„è¯ï¼ŒPOD å°±ä¼šå¿½ç•¥è¿™æ¡è§„åˆ™ï¼Œç»§ç»­å®Œæˆè°ƒåº¦è¿‡ç¨‹ï¼Œè¯´ç™½äº†å°±æ˜¯æ»¡è¶³æ¡ä»¶æœ€å¥½äº†ï¼Œæ²¡æœ‰çš„è¯ä¹Ÿæ— æ‰€è°“äº†çš„ç­–ç•¥ï¼›è€Œç¡¬ç­–ç•¥å°±æ¯”è¾ƒå¼ºç¡¬äº†ï¼Œå¦‚æœæ²¡æœ‰æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹çš„è¯ï¼Œå°±ä¸æ–­é‡è¯•ç›´åˆ°æ»¡è¶³æ¡ä»¶ä¸ºæ­¢ï¼Œç®€å•è¯´å°±æ˜¯ä½ å¿…é¡»æ»¡è¶³æˆ‘çš„è¦æ±‚ï¼Œä¸ç„¶æˆ‘å°±ä¸å¹²çš„ç­–ç•¥ã€‚ nodeAffinityå°±æœ‰ä¸¤ä¸Šé¢ä¸¤ç§ç­–ç•¥ï¼špreferredDuringSchedulingIgnoredDuringExecutionå’ŒrequiredDuringSchedulingIgnoredDuringExecutionï¼Œå‰é¢çš„å°±æ˜¯è½¯ç­–ç•¥ï¼Œåé¢çš„å°±æ˜¯ç¡¬ç­–ç•¥ã€‚ å¦‚ä¸‹ä¾‹å­ï¼šï¼ˆtest-node-affinity.yamlï¼‰ apiVersion: v1 kind: Pod metadata: name: with-node-affinity labels: app: node-affinity-pod spec: containers: - name: with-node-affinity image: nginx affinity: nodeAffinity: requiredDuringSchedulingIgnoredDuringExecution: nodeSelectorTerms: - matchExpressions: - key: kubernetes.io/hostname operator: NotIn values: - 192.168.1.140 - 192.168.1.161 preferredDuringSchedulingIgnoredDuringExecution: - weight: 1 preference: matchExpressions: - key: source operator: In values: - qikqiak ä¸Šé¢è¿™ä¸ª POD é¦–å…ˆæ˜¯è¦æ±‚ POD ä¸èƒ½è¿è¡Œåœ¨140å’Œ161ä¸¤ä¸ªèŠ‚ç‚¹ä¸Šï¼Œå¦‚æœæœ‰ä¸ªèŠ‚ç‚¹æ»¡è¶³source=qikqiakçš„è¯å°±ä¼˜å…ˆè°ƒåº¦åˆ°è¿™ä¸ªèŠ‚ç‚¹ä¸Šï¼ŒåŒæ ·çš„æˆ‘ä»¬å¯ä»¥ä½¿ç”¨descirbeå‘½ä»¤æŸ¥çœ‹å…·ä½“çš„è°ƒåº¦æƒ…å†µæ˜¯å¦æ»¡è¶³æˆ‘ä»¬çš„è¦æ±‚ã€‚è¿™é‡Œçš„åŒ¹é…é€»è¾‘æ˜¯ label çš„å€¼åœ¨æŸä¸ªåˆ—è¡¨ä¸­ï¼Œç°åœ¨Kubernetesæä¾›çš„æ“ä½œç¬¦æœ‰ä¸‹é¢çš„å‡ ç§ï¼š Inï¼šlabel çš„å€¼åœ¨æŸä¸ªåˆ—è¡¨ä¸­ NotInï¼šlabel çš„å€¼ä¸åœ¨æŸä¸ªåˆ—è¡¨ä¸­ Gtï¼šlabel çš„å€¼å¤§äºæŸä¸ªå€¼ Ltï¼šlabel çš„å€¼å°äºæŸä¸ªå€¼ Existsï¼šæŸä¸ª label å­˜åœ¨ DoesNotExistï¼šæŸä¸ª label ä¸å­˜åœ¨ å¦‚æœnodeSelectorTermsä¸‹é¢æœ‰å¤šä¸ªé€‰é¡¹çš„è¯ï¼Œæ»¡è¶³ä»»ä½•ä¸€ä¸ªæ¡ä»¶å°±å¯ä»¥äº†ï¼›å¦‚æœmatchExpressionsæœ‰å¤šä¸ªé€‰é¡¹çš„è¯ï¼Œåˆ™å¿…é¡»åŒæ—¶æ»¡è¶³è¿™äº›æ¡ä»¶æ‰èƒ½æ­£å¸¸è°ƒåº¦ PODã€‚ ","date":"2018-03-08","objectID":"/posts/understand-kubernetes-affinity/:2:0","tags":["kubernetes","affinity","è°ƒåº¦"],"title":"ç†è§£ Kubernetes çš„äº²å’Œæ€§è°ƒåº¦","uri":"/posts/understand-kubernetes-affinity/"},{"categories":null,"content":"podAffinity ä¸Šé¢ä¸¤ç§æ–¹å¼éƒ½æ˜¯è®© POD å»é€‰æ‹©èŠ‚ç‚¹çš„ï¼Œæœ‰çš„æ—¶å€™æˆ‘ä»¬ä¹Ÿå¸Œæœ›èƒ½å¤Ÿæ ¹æ® POD ä¹‹é—´çš„å…³ç³»è¿›è¡Œè°ƒåº¦ï¼ŒKubernetesåœ¨1.4ç‰ˆæœ¬å¼•å…¥çš„podAffinityæ¦‚å¿µå°±å¯ä»¥å®ç°æˆ‘ä»¬è¿™ä¸ªéœ€æ±‚ã€‚ å’ŒnodeAffinityç±»ä¼¼ï¼ŒpodAffinityä¹Ÿæœ‰requiredDuringSchedulingIgnoredDuringExecutionå’Œ preferredDuringSchedulingIgnoredDuringExecutionä¸¤ç§è°ƒåº¦ç­–ç•¥ï¼Œå”¯ä¸€ä¸åŒçš„æ˜¯å¦‚æœè¦ä½¿ç”¨äº’æ–¥æ€§ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨podAntiAffinityå­—æ®µã€‚ å¦‚ä¸‹ä¾‹å­ï¼Œæˆ‘ä»¬å¸Œæœ›with-pod-affinityå’Œbusybox-podèƒ½å¤Ÿå°±è¿‘éƒ¨ç½²ï¼Œè€Œä¸å¸Œæœ›å’Œnode-affinity-podéƒ¨ç½²åœ¨åŒä¸€ä¸ªæ‹“æ‰‘åŸŸä¸‹é¢ï¼šï¼ˆtest-pod-affinity.yamlï¼‰ apiVersion: v1 kind: Pod metadata: name: with-pod-affinity labels: app: pod-affinity-pod spec: containers: - name: with-pod-affinity image: nginx affinity: podAffinity: requiredDuringSchedulingIgnoredDuringExecution: - labelSelector: matchExpressions: - key: app operator: In values: - busybox-pod topologyKey: kubernetes.io/hostname podAntiAffinity: preferredDuringSchedulingIgnoredDuringExecution: - weight: 1 podAffinityTerm: labelSelector: matchExpressions: - key: app operator: In values: - node-affinity-pod topologyKey: kubernetes.io/hostname ä¸Šé¢è¿™ä¸ªä¾‹å­ä¸­çš„ POD éœ€è¦è°ƒåº¦åˆ°æŸä¸ªæŒ‡å®šçš„ä¸»æœºä¸Šï¼Œè‡³å°‘æœ‰ä¸€ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œäº†è¿™æ ·çš„ PODï¼šè¿™ä¸ª POD æœ‰ä¸€ä¸ªapp=busybox-podçš„ labelã€‚podAntiAffinityåˆ™æ˜¯å¸Œæœ›æœ€å¥½ä¸è¦è°ƒåº¦åˆ°è¿™æ ·çš„èŠ‚ç‚¹ï¼šè¿™ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œäº†æŸä¸ª PODï¼Œè€Œè¿™ä¸ª POD æœ‰app=node-affinity-podçš„ labelã€‚æ ¹æ®å‰é¢ä¸¤ä¸ª POD çš„å®šä¹‰ï¼Œæˆ‘ä»¬å¯ä»¥é¢„è§ä¸Šé¢è¿™ä¸ª POD åº”è¯¥ä¼šè¢«è°ƒåº¦åˆ°140çš„èŠ‚ç‚¹ä¸Šï¼Œå› ä¸ºbusybox-podè¢«è°ƒåº¦åˆ°äº†140èŠ‚ç‚¹ï¼Œè€Œnode-affinity-podè¢«è°ƒåº¦åˆ°äº†140ä»¥ä¸ºçš„èŠ‚ç‚¹ï¼Œæ­£å¥½æ»¡è¶³ä¸Šé¢çš„éœ€æ±‚ã€‚é€šè¿‡describeæŸ¥çœ‹ï¼š $ kubectl describe pod with-pod-affinity ...... Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal Scheduled 8s default-scheduler Successfully assigned with-pod-affinity to 192.168.1.140 Normal SuccessfulMountVolume 7s kubelet, 192.168.1.140 MountVolume.SetUp succeeded for volume \"default-token-lcl77\" Normal Pulling 7s kubelet, 192.168.1.140 pulling image \"nginx\" ä¸Šé¢çš„äº‹ä»¶ä¿¡æ¯ä¹ŸéªŒè¯äº†æˆ‘ä»¬çš„æƒ³æ³•ã€‚ åœ¨labelSelectorå’Œ topologyKeyçš„åŒçº§ï¼Œè¿˜å¯ä»¥å®šä¹‰ namespaces åˆ—è¡¨ï¼Œè¡¨ç¤ºåŒ¹é…å“ªäº› namespace é‡Œé¢çš„ podï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œä¼šåŒ¹é…å®šä¹‰çš„ pod æ‰€åœ¨çš„ namespaceï¼›å¦‚æœå®šä¹‰äº†è¿™ä¸ªå­—æ®µï¼Œä½†æ˜¯å®ƒçš„å€¼ä¸ºç©ºï¼Œåˆ™åŒ¹é…æ‰€æœ‰çš„ namespacesã€‚ æŸ¥çœ‹ä¸Šé¢æˆ‘ä»¬å®šä¹‰çš„3ä¸ª POD ç»“æœï¼š $ kubectl get po -o wide NAME READY STATUS RESTARTS AGE IP NODE test-busybox 1/1 Running 0 8m 172.30.95.18 192.168.1.140 with-node-affinity 1/1 Running 0 10m 172.30.81.25 192.168.1.172 with-pod-affinity 1/1 Running 0 8m 172.30.95.17 192.168.1.140 äº²å’Œæ€§/åäº²å’Œæ€§è°ƒåº¦ç­–ç•¥æ¯”è¾ƒå¦‚ä¸‹ï¼š è°ƒåº¦ç­–ç•¥ åŒ¹é…æ ‡ç­¾ æ“ä½œç¬¦ æ‹“æ‰‘åŸŸæ”¯æŒ è°ƒåº¦ç›®æ ‡ nodeAffinity ä¸»æœº In, NotIn, Exists, DoesNotExist, Gt, Lt å¦ æŒ‡å®šä¸»æœº podAffinity POD In, NotIn, Exists, DoesNotExist æ˜¯ PODä¸æŒ‡å®šPODåŒä¸€æ‹“æ‰‘åŸŸ podAnitAffinity POD In, NotIn, Exists, DoesNotExist æ˜¯ PODä¸æŒ‡å®šPODä¸åœ¨åŒä¸€æ‹“æ‰‘åŸŸ ","date":"2018-03-08","objectID":"/posts/understand-kubernetes-affinity/:3:0","tags":["kubernetes","affinity","è°ƒåº¦"],"title":"ç†è§£ Kubernetes çš„äº²å’Œæ€§è°ƒåº¦","uri":"/posts/understand-kubernetes-affinity/"},{"categories":null,"content":"æ±¡ç‚¹ï¼ˆTaintsï¼‰ä¸å®¹å¿ï¼ˆtolerationsï¼‰ å¯¹äºnodeAffinityæ— è®ºæ˜¯ç¡¬ç­–ç•¥è¿˜æ˜¯è½¯ç­–ç•¥æ–¹å¼ï¼Œéƒ½æ˜¯è°ƒåº¦ POD åˆ°é¢„æœŸèŠ‚ç‚¹ä¸Šï¼Œè€ŒTaintsæ°å¥½ä¸ä¹‹ç›¸åï¼Œå¦‚æœä¸€ä¸ªèŠ‚ç‚¹æ ‡è®°ä¸º Taints ï¼Œé™¤é POD ä¹Ÿè¢«æ ‡è¯†ä¸ºå¯ä»¥å®¹å¿æ±¡ç‚¹èŠ‚ç‚¹ï¼Œå¦åˆ™è¯¥ Taints èŠ‚ç‚¹ä¸ä¼šè¢«è°ƒåº¦podã€‚ æ¯”å¦‚ç”¨æˆ·å¸Œæœ›æŠŠ Master èŠ‚ç‚¹ä¿ç•™ç»™ Kubernetes ç³»ç»Ÿç»„ä»¶ä½¿ç”¨ï¼Œæˆ–è€…æŠŠä¸€ç»„å…·æœ‰ç‰¹æ®Šèµ„æºé¢„ç•™ç»™æŸäº› PODï¼Œåˆ™æ±¡ç‚¹å°±å¾ˆæœ‰ç”¨äº†ï¼ŒPOD ä¸ä¼šå†è¢«è°ƒåº¦åˆ° taint æ ‡è®°è¿‡çš„èŠ‚ç‚¹ã€‚taint æ ‡è®°èŠ‚ç‚¹ä¸¾ä¾‹å¦‚ä¸‹ï¼š $ kubectl taint nodes 192.168.1.40 key=value:NoSchedule node \"192.168.1.40\" tainted å¦‚æœä»ç„¶å¸Œæœ›æŸä¸ª POD è°ƒåº¦åˆ° taint èŠ‚ç‚¹ä¸Šï¼Œåˆ™å¿…é¡»åœ¨ Spec ä¸­åšå‡ºTolerationå®šä¹‰ï¼Œæ‰èƒ½è°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ï¼Œä¸¾ä¾‹å¦‚ä¸‹ï¼š tolerations: - key: \"key\" operator: \"Equal\" value: \"value\" effect: \"NoSchedule\" effect å…±æœ‰ä¸‰ä¸ªå¯é€‰é¡¹ï¼Œå¯æŒ‰å®é™…éœ€æ±‚è¿›è¡Œè®¾ç½®ï¼š NoScheduleï¼šPOD ä¸ä¼šè¢«è°ƒåº¦åˆ°æ ‡è®°ä¸º taints èŠ‚ç‚¹ã€‚ PreferNoScheduleï¼šNoSchedule çš„è½¯ç­–ç•¥ç‰ˆæœ¬ã€‚ NoExecuteï¼šè¯¥é€‰é¡¹æ„å‘³ç€ä¸€æ—¦ Taint ç”Ÿæ•ˆï¼Œå¦‚è¯¥èŠ‚ç‚¹å†…æ­£åœ¨è¿è¡Œçš„ POD æ²¡æœ‰å¯¹åº” Tolerate è®¾ç½®ï¼Œä¼šç›´æ¥è¢«é€å‡ºã€‚ ","date":"2018-03-08","objectID":"/posts/understand-kubernetes-affinity/:4:0","tags":["kubernetes","affinity","è°ƒåº¦"],"title":"ç†è§£ Kubernetes çš„äº²å’Œæ€§è°ƒåº¦","uri":"/posts/understand-kubernetes-affinity/"},{"categories":null,"content":"å‚è€ƒèµ„æ–™ https://kubernetes.io/docs/concepts/configuration/assign-pod-node/ https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/ https://coreos.com/fleet/docs/latest/affinity.html ","date":"2018-03-08","objectID":"/posts/understand-kubernetes-affinity/:5:0","tags":["kubernetes","affinity","è°ƒåº¦"],"title":"ç†è§£ Kubernetes çš„äº²å’Œæ€§è°ƒåº¦","uri":"/posts/understand-kubernetes-affinity/"},{"categories":null,"content":"ç¦»çº¿ - èœ·ç¼©çš„èœ—ç‰›","date":"0001-01-01","objectID":"/offline/","tags":null,"title":"","uri":"/offline/"},{"categories":null,"content":"Hey Welcome here ğŸ‘‹ ","date":"0001-01-01","objectID":"/offline/:1:0","tags":null,"title":"","uri":"/offline/"},{"categories":null,"content":"ç›®å‰æ­£åœ¨å­¦ä¹ Service Mesh ","date":"0001-01-01","objectID":"/offline/:2:0","tags":null,"title":"","uri":"/offline/"},{"categories":null,"content":"æ±‡ç¼–å’Œå·¥å…·: ğŸ›  Check for a detailed stats here :point_right: Sourcerer ","date":"0001-01-01","objectID":"/offline/:3:0","tags":null,"title":"","uri":"/offline/"},{"categories":null,"content":"ç»“æ„ä½“è½¬æ¢ YAML è½¬ GO (æ–°å¢): www.printlove.cn/tools/yaml2go JSON è½¬ GO: www.printlove.cn/tools/json2go SQL è½¬ GORM Model: www.printlove.cn/tools/sql2gorm SQL è½¬ entgo schema: printlove.cn/tools/sql2ent SQL è½¬ go-zero Model: printlove.cn/tools/sql2gozero ","date":"0001-01-01","objectID":"/posts/:0:1","tags":null,"title":"","uri":"/posts/"}]