<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>Sidecar 中的流量类型及 iptables 规则详解 - 蜷缩的蜗牛</title><meta name=author content="kbsonlong"><meta name=author-link content><meta name=description content="我在之前的一篇博客中讲解过 Istio 中 sidecar 的注入、使用 iptables 进行透明流量拦截及流量路由的详细过程，并以 Bookinfo 示例中的 productpage 服务访问 reviews 服务，和 reviews 服务访问 ratings 服务为例绘"><meta name=keywords content="sicader,转载"><meta itemprop=name content="Sidecar 中的流量类型及 iptables 规则详解"><meta itemprop=description content="我在之前的一篇博客中讲解过 Istio 中 sidecar 的注入、使用 iptables 进行透明流量拦截及流量路由的详细过程，并以 Bookinfo 示例中的 productpage 服务访问 reviews 服务，和 reviews 服务访问 ratings 服务为例绘"><meta itemprop=datePublished content="2022-09-11T14:56:39+08:00"><meta itemprop=dateModified content="2022-09-11T14:56:39+08:00"><meta itemprop=wordCount content="1341"><meta itemprop=image content="http://devops.alongparty.cn/logo_transparent.png"><meta itemprop=keywords content="sicader,转载,"><meta property="og:title" content="Sidecar 中的流量类型及 iptables 规则详解"><meta property="og:description" content="我在之前的一篇博客中讲解过 Istio 中 sidecar 的注入、使用 iptables 进行透明流量拦截及流量路由的详细过程，并以 Bookinfo 示例中的 productpage 服务访问 reviews 服务，和 reviews 服务访问 ratings 服务为例绘"><meta property="og:type" content="article"><meta property="og:url" content="http://devops.alongparty.cn/posts/61aaaf/"><meta property="og:image" content="http://devops.alongparty.cn/logo_transparent.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-09-11T14:56:39+08:00"><meta property="article:modified_time" content="2022-09-11T14:56:39+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://devops.alongparty.cn/logo_transparent.png"><meta name=twitter:title content="Sidecar 中的流量类型及 iptables 规则详解"><meta name=twitter:description content="我在之前的一篇博客中讲解过 Istio 中 sidecar 的注入、使用 iptables 进行透明流量拦截及流量路由的详细过程，并以 Bookinfo 示例中的 productpage 服务访问 reviews 服务，和 reviews 服务访问 ratings 服务为例绘"><meta name=application-name content="FixIt"><meta name=apple-mobile-web-app-title content="FixIt"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#252627"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=http://devops.alongparty.cn/posts/61aaaf/><link rel=prev href=http://devops.alongparty.cn/posts/fe0ba1/><link rel=next href=http://devops.alongparty.cn/posts/6be15f/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Sidecar 中的流量类型及 iptables 规则详解","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/devops.alongparty.cn\/posts\/61aaaf\/"},"genre":"posts","keywords":"sicader, 转载","wordcount":1341,"url":"http:\/\/devops.alongparty.cn\/posts\/61aaaf\/","datePublished":"2022-09-11T14:56:39+08:00","dateModified":"2022-09-11T14:56:39+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"kbsonlong"},"description":""}</script></head><body header-desktop=sticky header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper github-corner=right><div class=header-title><a href=/ title=蜷缩的蜗牛><img class="lazyload logo" src=/svg/loading.min.svg data-src=/logo_transparent.png data-srcset="/logo_transparent.png, /logo_transparent.png 1.5x, /logo_transparent.png 2x" data-sizes=auto alt=蜷缩的蜗牛 title=蜷缩的蜗牛><span class=header-title-text>蜷缩的蜗牛</span></a><span class=header-subtitle></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/posts/><i class='fa-solid fa-archive fa-fw fa-sm'></i> 文章</a></li><li class=menu-item><a class=menu-link href=/categories/><i class='fa-solid fa-th fa-fw fa-sm'></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class='fa-solid fa-tags fa-fw fa-sm'></i> 标签</a></li><li class=menu-item><a class=menu-link href=/friends/ title=友情链接><i class='fa-solid fa-users fa-fw fa-sm'></i> 友链</a></li><li class=menu-item><a class=menu-link href=/about/><i class='fa-solid fa-info-circle fa-fw fa-sm'></i> 关于</a></li><li class="menu-item d-none-desktop text-center"><a class=menu-link href=https://github.com/kbsonlong/ title=GitHub rel="noopener noreferrer" target=_blank><i class='fa-brands fa-github fa-fw'></i></a></li><li class="menu-item d-none-desktop text-center"><a class=menu-link href=/messages/><i class='fa-solid fa-messages'></i> 留言板</a></li><li class=menu-item><a class=menu-link href=/messages/ title=留言板>留言板</a></li><li class="menu-item delimiter"></li><li class="menu-item language"><span title=选择语言>简体中文<i class="dropdown-icon fa-solid fa-chevron-down"></i></span><ul class=sub-menu><li class=menu-item>没有更多翻译</li></ul></li><li class="menu-item search" id=search-desktop><input type=text placeholder="搜索文章标题或内容 ..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin"></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw"></i></li></ul></nav></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=蜷缩的蜗牛><img class="lazyload logo" src=/svg/loading.min.svg data-src=/logo_transparent.png data-srcset="/logo_transparent.png, /logo_transparent.png 1.5x, /logo_transparent.png 2x" data-sizes=auto alt=/logo_transparent.png title=/logo_transparent.png><span class=header-title-text>蜷缩的蜗牛</span></a><span class=header-subtitle></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="搜索文章标题或内容 ..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><a class=menu-link href=/posts/><i class='fa-solid fa-archive fa-fw fa-sm'></i> 文章</a></li><li class=menu-item><a class=menu-link href=/categories/><i class='fa-solid fa-th fa-fw fa-sm'></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class='fa-solid fa-tags fa-fw fa-sm'></i> 标签</a></li><li class=menu-item><a class=menu-link href=/friends/ title=友情链接><i class='fa-solid fa-users fa-fw fa-sm'></i> 友链</a></li><li class=menu-item><a class=menu-link href=/about/><i class='fa-solid fa-info-circle fa-fw fa-sm'></i> 关于</a></li><li class="menu-item d-none-desktop text-center"><a class=menu-link href=https://github.com/kbsonlong/ title=GitHub rel="noopener noreferrer" target=_blank><i class='fa-brands fa-github fa-fw'></i></a></li><li class="menu-item d-none-desktop text-center"><a class=menu-link href=/messages/><i class='fa-solid fa-messages'></i> 留言板</a></li><li class=menu-item><a class=menu-link href=/messages/ title=留言板>留言板</a></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw"></i></li><li class="menu-item language"><span title=选择语言>简体中文<i class="dropdown-icon fa-solid fa-chevron-down"></i></span>
<select class=language-select onchange="location=this.value"><option disabled>没有更多翻译</option></select></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=container page-style=normal><aside class=toc id=toc-auto><h2 class=toc-title>目录 <i class="toc-icon fa-solid fa-angle-down fa-fw"></i></h2><div class=toc-content id=toc-content-auto></div></aside><aside class=aside-custom></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>Sidecar 中的流量类型及 iptables 规则详解</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><img class="lazyload avatar" src=/svg/loading.min.svg data-src="https://gravatar.loli.net/avatar/598872715ec08296cf1e1806135cd518?s=32&d=mp" data-srcset="https://gravatar.loli.net/avatar/598872715ec08296cf1e1806135cd518?s=32&d=mp, https://gravatar.loli.net/avatar/598872715ec08296cf1e1806135cd518?s=32&d=mp 1.5x, https://gravatar.loli.net/avatar/598872715ec08296cf1e1806135cd518?s=32&d=mp 2x" data-sizes=auto alt=kbsonlong title=kbsonlong>&nbsp;kbsonlong</span></span>
<span class=post-category>收录于 <a href=/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/><i class="fa-regular fa-folder fa-fw"></i>&nbsp;云原生</a></span></div><div class=post-meta-line><span title="2022-09-11 14:56:39"><i class="fa-regular fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2022-09-11>2022-09-11</time>
</span>&nbsp;<i class="fa-solid fa-pencil-alt fa-fw"></i>&nbsp;约 1341 字&nbsp;
<i class="fa-regular fa-clock fa-fw"></i>&nbsp;预计阅读 3 分钟&nbsp;</div></div><div class=featured-image><img class=lazyload src=/svg/loading.min.svg data-src="https://imgapi.cn/api.php?zd=zsy&fl=fengjing&random=664184" data-srcset="https://imgapi.cn/api.php?zd=zsy&fl=fengjing&random=664184, https://imgapi.cn/api.php?zd=zsy&fl=fengjing&random=664184 1.5x, https://imgapi.cn/api.php?zd=zsy&fl=fengjing&random=664184 2x" data-sizes=auto alt="https://imgapi.cn/api.php?zd=zsy&fl=fengjing&random=664184" title="https://imgapi.cn/api.php?zd=zsy&fl=fengjing&random=664184"></div><div class="details toc" id=toc-static kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#istio_output-规则>ISTIO_OUTPUT 规则</a></li><li><a href=#sidecar-中的-iptables-流量路由>Sidecar 中的 iptables 流量路由</a></li><li><a href=#类型一remote-pod---local-pod>类型一：Remote Pod -> Local Pod</a></li><li><a href=#类型二local-pod---remote-pod>类型二：Local Pod -> Remote Pod</a></li><li><a href=#类型三prometheus---local-pod>类型三：Prometheus -> Local Pod</a></li><li><a href=#类型四local-pod---local-pod>类型四：Local Pod -> Local Pod</a></li><li><a href=#类型五envoy-内部的进程间-tcp-流量>类型五：Envoy 内部的进程间 TCP 流量</a></li><li><a href=#类型六sidecar-到-istiod-的流量>类型六：Sidecar 到 Istiod 的流量</a></li><li><a href=#总结>总结</a></li></ul></nav></div></div><div class=content id=content><p>我在<a href=/posts/fe0ba1/>之前的一篇博客中</a>讲解过 Istio 中 sidecar 的注入、使用 iptables 进行透明流量拦截及流量路由的详细过程，并以 Bookinfo 示例中的 <code>productpage</code> 服务访问 <code>reviews</code> 服务，和 <code>reviews</code> 服务访问 <code>ratings</code> 服务为例绘制了透明流量劫持示意图。在那个示意图中仅展示了 <code>reviews</code> pod 接收流量和对外访问的路由，实际上 sidecar 内的流量远不止于此。</p><h2 id=istio_output-规则>ISTIO_OUTPUT 规则</h2><p>在所有的 iptables 调用链中最复杂的一个是 <code>ISTIO_OUTPUT</code>，其中共有 9 条规则如下：</p><table><thead><tr><th><strong>Rule</strong></th><th><strong>target</strong></th><th><strong>in</strong></th><th><strong>out</strong></th><th><strong>source</strong></th><th><strong>destination</strong></th></tr></thead><tbody><tr><td>1</td><td>RETURN</td><td>any</td><td>lo</td><td>127.0.0.6</td><td>anywhere</td></tr><tr><td>2</td><td>ISTIO_IN_REDIRECT</td><td>any</td><td>lo</td><td>anywhere</td><td>!localhost owner UID match 1337</td></tr><tr><td>3</td><td>RETURN</td><td>any</td><td>lo</td><td>anywhere</td><td>anywhere !owner UID match 1337</td></tr><tr><td>4</td><td>RETURN</td><td>any</td><td>any</td><td>anywhere</td><td>anywhere owner UID match 1337</td></tr><tr><td>5</td><td>ISTIO_IN_REDIRECT</td><td>any</td><td>lo</td><td>anywhere</td><td>!localhost owner GID match 1337</td></tr><tr><td>6</td><td>RETURN</td><td>any</td><td>lo</td><td>anywhere</td><td>anywhere !owner GID match 1337</td></tr><tr><td>7</td><td>RETURN</td><td>any</td><td>any</td><td>anywhere</td><td>anywhere owner GID match 1337</td></tr><tr><td>8</td><td>RETURN</td><td>any</td><td>any</td><td>anywhere</td><td>localhost</td></tr><tr><td>9</td><td>ISTIO_REDIRECT</td><td>any</td><td>any</td><td>anywhere</td><td>anywhere</td></tr></tbody></table><p>本文将向你展示 Istio sidecar 中的六种流量类型及其 iptables 规则， 以示意图的形式带你一览其全貌，其中详细指出了路由具体使用的是 <code>ISTIO_OUTPUT</code> 中的哪一条规则。</p><h2 id=sidecar-中的-iptables-流量路由>Sidecar 中的 iptables 流量路由</h2><p>Sidecar 中的流量可以划分为以下几类：</p><ul><li>远程服务访问本地服务：Remote Pod -> Local Pod</li><li>本地服务访问远程服务：Local Pod -> Remote Pod</li><li>Prometheus 抓取本地服务的 metrics：Prometheus -> Local Pod</li><li>本地 Pod 服务间的流量：Local Pod -> Local Pod</li><li>Envoy 内部的进程间 TCP 流量</li><li>Sidecar 到 Istiod 的流量</li></ul><p>下面将依次解释每个场景下 Sidecar 内的 iptables 路由规则。</p><h2 id=类型一remote-pod---local-pod>类型一：Remote Pod -> Local Pod</h2><p>以下是远程服务、应用或客户端访问数据平面本地 Pod IP 的 iptables 规则。</p><p>Remote Pod -> <code>RREROUTING</code> -> <code>ISTIO_INBOUND</code> -> <code>ISTIO_IN_REDIRECT</code> -> Envoy 15006（Inbound）-> <code>OUTPUT</code> -> <strong><code>ISTIO_OUTPUT</code> RULE 1</strong> -> <code>POSTROUTING</code> -> Local Pod</p><p>我们看到流量只经过一次 Envoy 15006 Inbound 端口。这种场景下的 iptables 规则的示意图如下。</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913145739.png data-srcset="https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913145739.png, https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913145739.png 1.5x, https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913145739.png 2x" data-sizes=auto alt=https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913145739.png title=https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913145739.png></p><h2 id=类型二local-pod---remote-pod>类型二：Local Pod -> Remote Pod</h2><p>以下是本地 Pod IP 访问远程服务经过的 iptables 规则。</p><p>Local Pod-> <code>OUTPUT</code> -> <strong><code>ISTIO_OUTPUT</code> RULE 9</strong> -> ISTIO_REDIRECT -> Envoy 15001（Outbound）-> <code>OUTPUT</code> -> <strong><code>ISTIO_OUTPUT</code> RULE 4</strong> -> <code>POSTROUTING</code> -> Remote Pod</p><p>我们看到流量只经过 Envoy 15001 Outbound 端口。</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913145841.png data-srcset="https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913145841.png, https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913145841.png 1.5x, https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913145841.png 2x" data-sizes=auto alt=https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913145841.png title=https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913145841.png></p><p>以上两种场景中的流量都只经过一次 Envoy，因为该 Pod 中只有发出或接受请求一种场景发生。</p><h2 id=类型三prometheus---local-pod>类型三：Prometheus -> Local Pod</h2><p>Prometheus 抓取数据平面 metrics 的流量不会也无须经过 Envoy 代理。</p><p>这些流量通过的 iptables 规则如下。</p><p>Prometheus-> <code>RREROUTING</code> -> <code>ISTIO_INBOUND</code>（对目的地为 15002、15090 端口流量将转到 <code>INPUT</code>）-> <code>INPUT</code> -> Local Pod</p><p>这种场景下的 iptables 规则的示意图如下。</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913145903.png data-srcset="https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913145903.png, https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913145903.png 1.5x, https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913145903.png 2x" data-sizes=auto alt=https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913145903.png title=https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913145903.png></p><h2 id=类型四local-pod---local-pod>类型四：Local Pod -> Local Pod</h2><p>一个 Pod 可能同时存在两个或多个服务，如果 Local Pod 访问的服务也在该当前 Pod 上，流量会依次经过 Envoy 15001 和 Envoy 15006 端口最后到达本地 Pod 的服务端口上。</p><p>这些流量通过的 iptables 规则如下。</p><p>Local Pod-> <code>OUTPUT</code> -> <strong><code>ISTIO_OUTPUT</code> RULE 9</strong> -> <code>ISTIO_REDIRECT</code> -> Envoy 15001（Outbound）-> <code>OUTPUT</code> -> <strong><code>ISTIO_OUTPUT</code> RULE 2</strong> -> <code>ISTIO_IN_REDIRECT</code> -> Envoy 15006（Inbound）-> <code>OUTPUT</code> -> <strong><code>ISTIO_OUTPUT</code> RULE 1</strong> -> <code>POSTROUTING</code> -> Local Pod</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913145924.png data-srcset="https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913145924.png, https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913145924.png 1.5x, https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913145924.png 2x" data-sizes=auto alt=https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913145924.png title=https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913145924.png></p><h2 id=类型五envoy-内部的进程间-tcp-流量>类型五：Envoy 内部的进程间 TCP 流量</h2><p>Envoy 内部进程的 UID 和 GID 为 1337，它们之间的流量将使用 lo 网卡，使用 localhost 域名来通信。</p><p>这些流量通过的 iptables 规则如下。</p><p>Envoy 进程（Localhost） -> <code>OUTPUT</code> -> <strong><code>ISTIO_OUTPUT</code> RULE 8</strong> -> <code>POSTROUTING</code> -> Envoy 进程（Localhost）</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913145940.png data-srcset="https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913145940.png, https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913145940.png 1.5x, https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913145940.png 2x" data-sizes=auto alt=https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913145940.png title=https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913145940.png></p><h2 id=类型六sidecar-到-istiod-的流量>类型六：Sidecar 到 Istiod 的流量</h2><p>Sidecar 需要访问 Istiod 以同步配置，<code>pilot-agent</code> 进程会向 Istiod 发送请求，以同步配置。</p><p>这些流量通过的 iptables 规则如下。</p><p><code>pilot-agent</code> 进程 -> <code>OUTPUT</code> -> <strong><code>Istio_OUTPUT</code> RULE 9</strong> -> Envoy 15001 (Outbound Handler) -> OUTPUT -> <strong><code>ISTIO_OUTPUT</code> RULE 4</strong> -> <code>POSTROUTING</code> -> Istiod</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913150048.png data-srcset="https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913150048.png, https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913150048.png 1.5x, https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913150048.png 2x" data-sizes=auto alt=https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913150048.png title=https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913150048.png></p><h2 id=总结>总结</h2><p>Istio 注入在 Pod 内或虚拟机中安装的所有 sidecar 代理组成了服务网格的数据平面，也是 Istio 的主要工作负载所在地，通过 <a href=/posts/fe0ba1/>Istio 中的透明流量劫持</a> 及这篇博客，相信你一定对 sidecar 代理中的流量有了一个深刻的了解，但这还只是管中窥豹，略见一斑，在我的<a href=/posts/6be15f/>下一篇博客</a>中，我将带你了解 Envoy 中各个组件的端口及其功能，这样可以让我们对 Istio 中的流量有一个更全面的了解。</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="2022-09-11 14:56:39">更新于 2022-09-11</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a href=/posts/61aaaf/index.md title=阅读原始文档 class=link-to-markdown>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=http://devops.alongparty.cn/posts/61aaaf/ data-title="Sidecar 中的流量类型及 iptables 规则详解" data-hashtags=sicader,转载><i class="fa-brands fa-twitter fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=http://devops.alongparty.cn/posts/61aaaf/ data-hashtag=sicader><i class="fa-brands fa-facebook-square fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 WhatsApp" data-sharer=whatsapp data-url=http://devops.alongparty.cn/posts/61aaaf/ data-title="Sidecar 中的流量类型及 iptables 规则详解" data-web><i class="fa-brands fa-whatsapp fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=http://devops.alongparty.cn/posts/61aaaf/ data-title="Sidecar 中的流量类型及 iptables 规则详解"><i data-svg-src=/lib/simple-icons/icons/line.min.svg></i></a>
<a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=http://devops.alongparty.cn/posts/61aaaf/ data-title="Sidecar 中的流量类型及 iptables 规则详解" data-image="https://imgapi.cn/api.php?zd=zsy&fl=fengjing&random=664184"><i class="fa-brands fa-weibo fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 Myspace" data-sharer=myspace data-url=http://devops.alongparty.cn/posts/61aaaf/ data-title="Sidecar 中的流量类型及 iptables 规则详解" data-description><i data-svg-src=/lib/simple-icons/icons/myspace.min.svg></i></a>
<a href=javascript:void(0); title="分享到 Blogger" data-sharer=blogger data-url=http://devops.alongparty.cn/posts/61aaaf/ data-title="Sidecar 中的流量类型及 iptables 规则详解" data-description><i class="fa-brands fa-blogger fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 Evernote" data-sharer=evernote data-url=http://devops.alongparty.cn/posts/61aaaf/ data-title="Sidecar 中的流量类型及 iptables 规则详解"><i class="fa-brands fa-evernote fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw"></i>&nbsp;<a href=/tags/sicader/>sicader</a>,&nbsp;<a href=/tags/%E8%BD%AC%E8%BD%BD/>转载</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/fe0ba1/ class=prev rel=prev title="Istio 中的 Sidecar 注入、透明流量劫持及流量路由过程详解"><i class="fa-solid fa-angle-left fa-fw"></i>Istio 中的 Sidecar 注入、透明流量劫持及流量路由过程详解</a>
<a href=/posts/6be15f/ class=next rel=next title=Istio组件详解>Istio组件详解<i class="fa-solid fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=giscus><script src=https://giscus.app/client.js data-repo=kbsonlong/devops.alongparty.cn data-repo-id=R_kgDOHE7F-Q data-category=Announcements data-category-id=DIC_kwDOHE7F-c4CPP5J data-mapping=title data-theme=preferred_color_scheme data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-lang=zh-CN data-loading=lazy crossorigin=anonymous async defer></script><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app/ rel="external nofollow noopener noreferrer">giscus</a>.</noscript></div></div></article></main><footer class=footer><div class=footer-container><div class="footer-line copyright"><i class="fa-regular fa-copyright fa-fw"></i>
<span itemprop=copyrightYear>2018 - 2022</span><span class=author itemprop=copyrightHolder>
<a href=/>kbsonlong</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class="footer-line statistics"></div><div class="footer-line ibruce"><span id=busuanzi_container_site_uv title=总访客数><i class="fa-regular fa-user fa-fw"></i>&nbsp;<span id=busuanzi_value_site_uv><i class="fa fa-spinner fa-spin fa-fw"></i></span></span><span id=busuanzi_container_site_pv class=footer-divider title=总访问量><i class="fa-regular fa-eye fa-fw"></i>&nbsp;<span id=busuanzi_value_site_pv><i class="fa fa-spinner fa-spin fa-fw"></i></span></span></div><div class="footer-line beian"><span class="icp footer-divider"><a target=_blank href=https://beian.miit.gov.cn/>粤ICP备18122209号</a></span></div></div></footer></div><div class=widgets><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fa-solid fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fa-solid fa-comment fa-fw"></i></a></div><a href=https://github.com/kbsonlong title="在 GitHub 上查看源代码" target=_blank rel="external nofollow noopener noreferrer" class="github-corner right d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div id=mask></div></div><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/katex/copy-tex.min.css><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js defer></script><script type=text/javascript src=/lib/algoliasearch/algoliasearch-lite.umd.min.js defer></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js async defer></script><script type=text/javascript src=/lib/sharer/sharer.min.js async defer></script><script type=text/javascript src=/lib/katex/katex.min.js defer></script><script type=text/javascript src=/lib/katex/auto-render.min.js defer></script><script type=text/javascript src=/lib/katex/copy-tex.min.js defer></script><script type=text/javascript src=/lib/katex/mhchem.min.js defer></script><script type=text/javascript src=/lib/cookieconsent/cookieconsent.min.js defer></script><script type=text/javascript src=/lib/pangu/pangu.min.js defer></script><script type=text/javascript src=/lib/cell-watermark/watermark.min.js defer></script><script type=text/javascript src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async defer></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:10},comment:{giscus:{darkTheme:"dark",lightTheme:"light"}},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},enablePWA:!0,enablePangu:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"WFOR67TML1",algoliaIndex:"along",algoliaSearchKey:"ea1fe535f9a7ae353f3922489c829cc1",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"},watermark:{content:'\u003cimg class="fixit-icon" src="/favicon-16x16.png" alt="FixIt logo" /\u003e FixIt 主题',enable:!0,height:21,opacity:.0125}}</script><script type=text/javascript src=/js/theme.min.js defer></script><script type=text/javascript src=/js/_custom.min.js defer></script></body></html>