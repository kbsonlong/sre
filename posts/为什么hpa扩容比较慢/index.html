<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><meta http-equiv=X-UA-Compatible content="IE=edge, chrome=1"><title>为什么HPA扩容比较慢 - 蜷缩的蜗牛</title><meta name=author content="kbsonlong">
<meta name=author-link content><meta name=description content="分析hpa的工作原理，找到HPA扩容速度比较慢的原因。以及knative、keda这些项目如何解决扩容慢的问题，以及定时hpa、预测型hpa从其他角度解决HPA扩容慢问题"><meta name=keywords content="kubernetes,经验分享,技巧,hpa,HorizontalPodAutoscaler,Horizontal Pod Autoscaler,hpa算法"><meta itemprop=name content="为什么HPA扩容比较慢"><meta itemprop=description content="分析hpa的工作原理，找到HPA扩容速度比较慢的原因。以及knative、keda这些项目如何解决扩容慢的问题，以及定时hpa、预测型hpa从其他角度解决HPA扩容慢问题"><meta itemprop=wordCount content="19494"><meta itemprop=image content="https://kbsonlong.github.io/logo_transparent.png"><meta itemprop=keywords content="kubernetes,hpa,经验分享,技巧,"><meta property="og:title" content="为什么HPA扩容比较慢"><meta property="og:description" content="分析hpa的工作原理，找到HPA扩容速度比较慢的原因。以及knative、keda这些项目如何解决扩容慢的问题，以及定时hpa、预测型hpa从其他角度解决HPA扩容慢问题"><meta property="og:type" content="article"><meta property="og:url" content="https://kbsonlong.github.io/sre/posts/%E4%B8%BA%E4%BB%80%E4%B9%88hpa%E6%89%A9%E5%AE%B9%E6%AF%94%E8%BE%83%E6%85%A2/"><meta property="og:image" content="https://kbsonlong.github.io/logo_transparent.png"><meta property="article:section" content="posts"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://kbsonlong.github.io/logo_transparent.png"><meta name=twitter:title content="为什么HPA扩容比较慢"><meta name=twitter:description content="分析hpa的工作原理，找到HPA扩容速度比较慢的原因。以及knative、keda这些项目如何解决扩容慢的问题，以及定时hpa、预测型hpa从其他角度解决HPA扩容慢问题"><meta name=application-name content="FixIt"><meta name=apple-mobile-web-app-title content="FixIt"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#252627"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://kbsonlong.github.io/sre/posts/%E4%B8%BA%E4%BB%80%E4%B9%88hpa%E6%89%A9%E5%AE%B9%E6%AF%94%E8%BE%83%E6%85%A2/><link rel=next href=https://kbsonlong.github.io/sre/posts/><link rel=stylesheet href=/sre/lib/normalize/normalize.min.css><link rel=stylesheet href=/sre/css/style.min.css><link rel=stylesheet href=/sre/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/sre/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"为什么HPA扩容比较慢","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/kbsonlong.github.io\/sre\/posts\/%E4%B8%BA%E4%BB%80%E4%B9%88hpa%E6%89%A9%E5%AE%B9%E6%AF%94%E8%BE%83%E6%85%A2\/"},"genre":"posts","keywords":"kubernetes, hpa, 经验分享, 技巧","wordcount":19494,"url":"https:\/\/kbsonlong.github.io\/sre\/posts\/%E4%B8%BA%E4%BB%80%E4%B9%88hpa%E6%89%A9%E5%AE%B9%E6%AF%94%E8%BE%83%E6%85%A2\/","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"kbsonlong"},"description":"分析hpa的工作原理，找到HPA扩容速度比较慢的原因。以及knative、keda这些项目如何解决扩容慢的问题，以及定时hpa、预测型hpa从其他角度解决HPA扩容慢问题"}</script></head><body header-desktop=sticky header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper github-corner=right><div class=header-title><a href=/sre/ title=蜷缩的蜗牛><img class="lazyload logo" src=/sre/svg/loading.min.svg data-src=/logo_transparent.png data-srcset="/logo_transparent.png, /logo_transparent.png 1.5x, /logo_transparent.png 2x" data-sizes=auto alt=蜷缩的蜗牛 title=蜷缩的蜗牛><span class=header-title-text>蜷缩的蜗牛</span></a><span class=header-subtitle></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/sre/posts/><i class='fa-solid fa-archive fa-fw fa-sm'></i> 文章</a></li><li class=menu-item><a class=menu-link href=/sre/categories/><i class='fa-solid fa-th fa-fw fa-sm'></i> 分类</a></li><li class=menu-item><a class=menu-link href=/sre/tags/><i class='fa-solid fa-tags fa-fw fa-sm'></i> 标签</a></li><li class=menu-item><a class=menu-link href=/sre/friends/ title=友情链接><i class='fa-solid fa-users fa-fw fa-sm'></i> 友链</a></li><li class=menu-item><a class=menu-link href=/sre/about/><i class='fa-solid fa-info-circle fa-fw fa-sm'></i> 关于</a></li><li class="menu-item d-none-desktop text-center"><a class=menu-link href=https://github.com/kbsonlong/ title=GitHub rel="noopener noreferrer" target=_blank><i class='fa-brands fa-github fa-fw'></i></a></li><li class="menu-item d-none-desktop text-center"><a class=menu-link href=/sre/messages/><i class='fa-solid fa-messages'></i> 留言板</a></li><li class=menu-item><a class=menu-link href=/sre/messages/ title=留言板>留言板</a></li><li class="menu-item delimiter"></li><li class="menu-item language"><span title=选择语言>简体中文<i class="dropdown-icon fa-solid fa-chevron-down"></i></span><ul class=sub-menu><li class=menu-item>没有更多翻译</li></ul></li><li class="menu-item search" id=search-desktop><input type=text placeholder="搜索文章标题或内容 ..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw"></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw"></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin"></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw"></i></li></ul></nav></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/sre/ title=蜷缩的蜗牛><img class="lazyload logo" src=/sre/svg/loading.min.svg data-src=/logo_transparent.png data-srcset="/logo_transparent.png, /logo_transparent.png 1.5x, /logo_transparent.png 2x" data-sizes=auto alt=/logo_transparent.png title=/logo_transparent.png><span class=header-title-text>蜷缩的蜗牛</span></a><span class=header-subtitle></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="搜索文章标题或内容 ..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw"></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw"></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><a class=menu-link href=/sre/posts/><i class='fa-solid fa-archive fa-fw fa-sm'></i> 文章</a></li><li class=menu-item><a class=menu-link href=/sre/categories/><i class='fa-solid fa-th fa-fw fa-sm'></i> 分类</a></li><li class=menu-item><a class=menu-link href=/sre/tags/><i class='fa-solid fa-tags fa-fw fa-sm'></i> 标签</a></li><li class=menu-item><a class=menu-link href=/sre/friends/ title=友情链接><i class='fa-solid fa-users fa-fw fa-sm'></i> 友链</a></li><li class=menu-item><a class=menu-link href=/sre/about/><i class='fa-solid fa-info-circle fa-fw fa-sm'></i> 关于</a></li><li class="menu-item d-none-desktop text-center"><a class=menu-link href=https://github.com/kbsonlong/ title=GitHub rel="noopener noreferrer" target=_blank><i class='fa-brands fa-github fa-fw'></i></a></li><li class="menu-item d-none-desktop text-center"><a class=menu-link href=/sre/messages/><i class='fa-solid fa-messages'></i> 留言板</a></li><li class=menu-item><a class=menu-link href=/sre/messages/ title=留言板>留言板</a></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw"></i></li><li class="menu-item language"><span title=选择语言>简体中文<i class="dropdown-icon fa-solid fa-chevron-down"></i>
</span><select class=language-select onchange="location=this.value"><option disabled>没有更多翻译</option></select></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=container page-style=normal><aside class=toc id=toc-auto><h2 class=toc-title>目录 <i class="toc-icon fa-solid fa-angle-down fa-fw"></i></h2><div class=toc-content id=toc-content-auto></div></aside><aside class=aside-custom></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>为什么HPA扩容比较慢</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><img class="lazyload avatar" src=/sre/svg/loading.min.svg data-src="https://gravatar.loli.net/avatar/598872715ec08296cf1e1806135cd518?s=32&amp;d=mp" data-srcset="https://gravatar.loli.net/avatar/598872715ec08296cf1e1806135cd518?s=32&amp;d=mp, https://gravatar.loli.net/avatar/598872715ec08296cf1e1806135cd518?s=32&amp;d=mp 1.5x, https://gravatar.loli.net/avatar/598872715ec08296cf1e1806135cd518?s=32&amp;d=mp 2x" data-sizes=auto alt=kbsonlong title=kbsonlong>&nbsp;kbsonlong</span></span>
<span class=post-category>收录于 <a href=/sre/categories/kubernetes/><i class="fa-regular fa-folder fa-fw"></i>&nbsp;kubernetes</a></span></div><div class=post-meta-line><span title="0001-01-01 00:00:00"><i class="fa-regular fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=0001-01-01>0001-01-01</time>
</span>&nbsp;<i class="fa-solid fa-pencil-alt fa-fw"></i>&nbsp;约 19494 字&nbsp;
<i class="fa-regular fa-clock fa-fw"></i>&nbsp;预计阅读 39 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#扩容有多慢>扩容有多慢</a><ul><li><a href=#测试过程>测试过程</a></li><li><a href=#测试结果>测试结果</a></li><li><a href=#结果分析>结果分析</a></li></ul></li><li><a href=#为什么扩容慢>为什么扩容慢</a><ul><li><a href=#hpa扩容机制>HPA扩容机制</a></li><li><a href=#hpa计算流程>HPA计算流程</a><ul><li><a href=#监控数据获取>监控数据获取</a></li><li><a href=#副本数算法>副本数算法</a><ul><li><a href=#object类型的数据源>object类型的数据源</a></li><li><a href=#external类型的数据源>external类型的数据源</a></li><li><a href=#pod分类>pod分类</a></li><li><a href=#数据修复>数据修复</a></li><li><a href=#pods类型的数据源>Pods类型的数据源</a></li><li><a href=#resource类型的数据源且type为averagevalue>Resource类型的数据源且type为AverageValue</a></li><li><a href=#resource类型的数据源且type为averageutilization>Resource类型的数据源且type为AverageUtilization</a></li><li><a href=#containerresource类型的数据源且type为averagevalue>ContainerResource类型的数据源且type为AverageValue</a></li><li><a href=#containerresource类型的数据源且type为averageutilization>ContainerResource类型的数据源且type为AverageUtilization</a></li></ul></li></ul></li><li><a href=#扩缩容行为策略控制>扩缩容行为策略控制</a><ul><li><a href=#未设置specbehavior默认扩缩容行为>未设置spec.behavior（默认扩缩容行为）</a></li><li><a href=#设置了specbehavior>设置了spec.behavior</a></li></ul></li><li><a href=#扩容慢的原因>扩容慢的原因</a><ul><li><a href=#扩缩容的响应时间>扩缩容的响应时间</a></li><li><a href=#扩缩容的速度>扩缩容的速度</a></li><li><a href=#扩容的敏感度>扩容的敏感度</a></li><li><a href=#hpa-controller执行效率>HPA controller执行效率</a></li><li><a href=#应用ready时间>应用ready时间</a></li></ul></li></ul></li><li><a href=#解决方案>解决方案</a><ul><li><a href=#缩短获取监控的链路长度>缩短获取监控的链路长度</a></li><li><a href=#缩短pod-ready时间>缩短pod ready时间</a></li><li><a href=#hpa-controller性能提升>HPA controller性能提升</a></li><li><a href=#设置合理的扩容行为策略>设置合理的扩容行为策略</a></li><li><a href=#设置合理的容忍度>设置合理的容忍度</a></li><li><a href=#预测式扩缩容或定时扩容>预测式扩缩容或定时扩容</a></li></ul></li><li><a href=#总结>总结</a></li><li><a href=#reference>Reference</a></li></ul></nav></div></div><div class=content id=content><p>最近遇到业务活动期间遇到突发流量，由于pod资源使用飙升导致业务可用性降低的问题。这里面导致业务不可用的原因有很多，其中一个直接原因是流量来临时候资源使用飙升，而HPA没有及时的进行扩容。
这篇文章就是针对这个问题进行研究，主要从这三方面进行阐述：</p><ol><li>扩容有多慢</li><li>为什么扩容慢</li><li>有什么解决方案</li></ol><h2 id=扩容有多慢>扩容有多慢</h2><p>为了说明扩容有多慢，进行HPA扩容测试，记录每一时刻的副本数和pod的资源使用，对比流量增加时间和第一次副本数增加时间，粗略得出扩容的延迟。</p><p>hpa的数据源配置有"Object"、&ldquo;Pods&rdquo;、&ldquo;Resource&rdquo;、&ldquo;ContainerResource&rdquo;、&ldquo;External&rdquo;。为了测试简单这里只使用"Resource"进行测试，同时kubernetes版本为1.23。</p><p>测试方法：准备一个nginx deployment和service，然后对这个service进行压测，记录下每一时刻的副本数。</p><p>nginx deployment副本数为2，CPU的request为20m，hpa的目标设置为request的20%平均利用率。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:1.18</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>20m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>autoscaling/v2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>HorizontalPodAutoscaler  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>maxReplicas</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>metrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>resource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cpu</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>target</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>averageUtilization</span><span class=p>:</span><span class=w> </span><span class=m>20</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Utilization</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Resource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>minReplicas</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>scaleTargetRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ngx-service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>clusterIP</span><span class=p>:</span><span class=w> </span><span class=m>10.252.211.253</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>clusterIPs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=m>10.252.211.253</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>externalTrafficPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Cluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>internalTrafficPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Cluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ipFamilies</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>IPv4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ipFamilyPolicy</span><span class=p>:</span><span class=w> </span><span class=l>SingleStack</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>sessionAffinity</span><span class=p>:</span><span class=w> </span><span class=l>None</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>ClusterIP</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=测试过程>测试过程</h3><p>使用ab命令对cluster ip进行压测</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># date;ab -n 100000 -c 20 10.252.211.253/;date</span>
</span></span><span class=line><span class=cl>Thu Nov  <span class=m>2</span> 13:10:00 CST <span class=m>2023</span>
</span></span><span class=line><span class=cl>.....
</span></span><span class=line><span class=cl>Thu Nov  <span class=m>2</span> 13:10:11 CST <span class=m>2023</span>
</span></span></code></pre></td></tr></table></div></div><p>在另一个窗口记录pod metrics</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>#while :; do date; kubectl get pods.metrics.k8s.io  -l app=nginx;echo;sleep 1;done</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Thu Nov  <span class=m>2</span> 13:10:23 CST <span class=m>2023</span>
</span></span><span class=line><span class=cl>NAME                                CPU   MEMORY   WINDOW
</span></span><span class=line><span class=cl>nginx-deployment-596d9ffddd-6lrhv   <span class=m>0</span>     9604Ki   17.068s
</span></span><span class=line><span class=cl>nginx-deployment-596d9ffddd-w6cm2   <span class=m>0</span>     2060Ki   17.634s
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Thu Nov  <span class=m>2</span> 13:10:25 CST <span class=m>2023</span>
</span></span><span class=line><span class=cl>NAME                                CPU          MEMORY   WINDOW
</span></span><span class=line><span class=cl>nginx-deployment-596d9ffddd-6lrhv   505634152n   9548Ki   13.763s
</span></span><span class=line><span class=cl>nginx-deployment-596d9ffddd-w6cm2   523202787n   2060Ki   13.914s
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Thu Nov  <span class=m>2</span> 13:10:27 CST <span class=m>2023</span>
</span></span><span class=line><span class=cl>NAME                                CPU          MEMORY   WINDOW
</span></span><span class=line><span class=cl>nginx-deployment-596d9ffddd-6lrhv   505634152n   9548Ki   13.763s
</span></span><span class=line><span class=cl>nginx-deployment-596d9ffddd-w6cm2   523202787n   2060Ki   13.914s
</span></span></code></pre></td></tr></table></div></div><p>在另一个窗口记录副本数</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>#while :; do date;kubectl get deployments.apps  nginx-deployment ;sleep 1;echo;done
</span></span></code></pre></td></tr></table></div></div><p>在另一个窗口记录hpa资源变化</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl> kubectl get hpa nginx-deployment -o yaml -w 
</span></span></code></pre></td></tr></table></div></div><p>完整的测试记录在<a href=https://gist.github.com/wu0407/ebea8c0ee9ecbc15e94b3122f1a193dc target=_blank rel="external nofollow noopener noreferrer">https://gist.github.com/wu0407/ebea8c0ee9ecbc15e94b3122f1a193dc</a></p><h3 id=测试结果>测试结果</h3><ol><li>从13:10:00开始进行压测到13:10:11压测结束。</li><li>在13:10:26扩容2个副本，13:10:42扩容4个副本，13:10:57扩2个副本</li><li>在13:10:25 pod metrics资源观察到pods使用资源增加</li></ol><p><img class=lazyload src=/sre/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/wu0407/assets/img/image-20231105183318307.png data-srcset="https://cdn.jsdelivr.net/gh/wu0407/assets/img/image-20231105183318307.png, https://cdn.jsdelivr.net/gh/wu0407/assets/img/image-20231105183318307.png 1.5x, https://cdn.jsdelivr.net/gh/wu0407/assets/img/image-20231105183318307.png 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/wu0407/assets/img/image-20231105183318307.png title=replicas-result></p><h3 id=结果分析>结果分析</h3><p>由于pod的扩容阈值是CPU平均使用为4m，可以粗略的认为只要有请求，pod的CPU平均使用率就超过4.2m（这里要加<code>--horizontal-pod-autoscaler-tolerance</code>，默认为0.1），那么这个实验里的扩容延迟为26s。</p><p>扩容是分成3个阶段，而不是一下扩容到10个副本。</p><p>甚至在没有压测流量时候还进行扩容，hpa对象里的<code>status.currentMetrics</code>里资源使用为0，但是<code>desiredReplicas</code>和<code>currentReplicas</code>不相等。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>  </span><span class=nt>currentMetrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>resource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>current</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>averageUtilization</span><span class=p>:</span><span class=w> </span><span class=m>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>averageValue</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;0&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cpu</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Resource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>currentReplicas</span><span class=p>:</span><span class=w> </span><span class=m>8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>desiredReplicas</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>lastScaleTime</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2023-11-02T05:10:57Z&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=为什么扩容慢>为什么扩容慢</h2><p>为什么会出现上面扩容的行为呢？为什么会有扩容延迟？</p><p>为了回答上面问题，首先需要知道HPA的扩容机制和HPA的扩容算法。</p><h3 id=hpa扩容机制>HPA扩容机制</h3><p><code>horizontal pod autoscaler controller</code>是kube-controller-manager的一部分，的它通过访问apiserver获得各个类型的资源监控数据。而这些监控数据是metrics-server提供的，metrics-server作为Aggregated API Servers扩展<code>metrics.k8s.io</code> 组下的API。<code>custom.metrics.k8s.io</code>和<code>external.metrics.k8s.io</code> 组下的API是由prometheus-adapter作为Aggregated API Servers提供的。</p><p>下面是HPA的架构图</p><p><img class=lazyload src=/sre/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/wu0407/assets/img/hpa-archer.png data-srcset="https://cdn.jsdelivr.net/gh/wu0407/assets/img/hpa-archer.png, https://cdn.jsdelivr.net/gh/wu0407/assets/img/hpa-archer.png 1.5x, https://cdn.jsdelivr.net/gh/wu0407/assets/img/hpa-archer.png 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/wu0407/assets/img/hpa-archer.png title=hpa-architecture></p><p>图片来自：https://www.weave.works/blog/kubernetes-horizontal-pod-autoscaler-and-prometheus</p><h3 id=hpa计算流程>HPA计算流程</h3><p>horizontal pod autoscaler controller默认每隔15秒执行一个HPA对象的调谐，即每隔15秒根据监控数据计算期望的副本数。如果期望的副本数不等于当前的副本数，则进行扩缩容。</p><p>流程：</p><ol><li>访问apiserver获得监控数据</li><li>计算期望的副本数</li><li>扩缩容行为控制</li></ol><h4 id=监控数据获取>监控数据获取</h4><p>根据不同类型的数据源访问不同地址，这里就不展开了，详细可以看我的<a href=https://github.com/wu0407/kubernetes-code-analysis/blob/add-comment/pkg/controller/podautoscaler/horizontal.go target=_blank rel="external nofollow noopener noreferrer">HPA代码注释</a></p><h4 id=副本数算法>副本数算法</h4><p><strong>ratio</strong>为当前metric值与目标值的比值</p><p><strong>tolerance</strong>为<code>--horizontal-pod-autoscaler-tolerance</code>，它指定了扩缩时候容忍抖动的范围，默认值为0.1</p><p><strong>副本数</strong>为workload里scale资源的spec.replicas</p><p><strong>当前的副本数</strong>为scale资源里的status.replicas</p><p><strong>desiredReplicas</strong>为期望的副本数</p><h5 id=object类型的数据源>object类型的数据源</h5><ol><li>target类型是"Value"，<code>ratio = MetricValue/spec.metrics[*].object.target.value</code><ul><li>如果spec.replicas为0，则desiredReplicas为<code>ratio</code>向上取整。</li><li>spec.replicas大于0，如果ratio在<code>[1-tolerance, 1+tolerance]</code>范围内就不进行扩缩容，desiredReplicas为spec.replicas。否则desiredReplicas为<code>ratio*readyPodCount</code>向上取整</li></ul></li><li>target类型为"AverageValue"，<code>ratio = MetricValue / (spec.metrics[*].object.target.averageValue * status.replicas)</code><ul><li>如果ratio在<code>[1-tolerance, 1+tolerance]</code>范围内，不进行扩缩容，desiredReplicas为spec.replicas。</li><li>否则desiredReplicas为<code>MetricValue / spec.metrics[*].object.target.averageValue</code>向上取整</li></ul></li></ol><p><img class=lazyload src=/sre/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/wu0407/assets/img/hpa-object.jpg data-srcset="https://cdn.jsdelivr.net/gh/wu0407/assets/img/hpa-object.jpg, https://cdn.jsdelivr.net/gh/wu0407/assets/img/hpa-object.jpg 1.5x, https://cdn.jsdelivr.net/gh/wu0407/assets/img/hpa-object.jpg 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/wu0407/assets/img/hpa-object.jpg title=hpa-object></p><p><strong>readyPodCount</strong>为处于ready状态的pod的数量</p><h5 id=external类型的数据源>external类型的数据源</h5><ol><li>target类型是"Value"，<code>ratio = totalValue / spec.metrics[*].external.target.value</code><ul><li>如果spec.replicas为0，否则desiredReplicas为<code>ratio</code>向上取整</li><li>spec.replicas大于0，如果ratio在<code>[1-tolerance, 1+tolerance]</code>，则不进行扩缩容，desiredReplicas为spec.replicas。否则desiredReplicas为<code>ratio*readyPodCount</code>向上取整</li></ul></li><li>target类型是"AverageValue"，<code>ratio = totalValue / (spec.metrics[*].external.target.averageValue * status.replicas)</code><ul><li>如果ratio在<code>[1-tolerance, 1+tolerance]</code>，则不进行扩缩容，desiredReplicas为status.replicas。</li><li>否则desiredReplicas为<code>totalValue / spec.metrics[*].external.target.averageValue</code>向上取整</li></ul></li></ol><p><img class=lazyload src=/sre/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/wu0407/assets/img/hpa-external.webp data-srcset="https://cdn.jsdelivr.net/gh/wu0407/assets/img/hpa-external.webp, https://cdn.jsdelivr.net/gh/wu0407/assets/img/hpa-external.webp 1.5x, https://cdn.jsdelivr.net/gh/wu0407/assets/img/hpa-external.webp 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/wu0407/assets/img/hpa-external.webp title=hpa-external></p><h5 id=pod分类>pod分类</h5><p>因为pod的状态和pod是否有监控数据会影响副本数计算，所以要进行pod分类，对不同类型的pod进行不同的监控数据修复。</p><p><strong>cpuInitializationPeriod</strong>：为<code>--horizontal-pod-autoscaler-cpu-initialization-period</code>的值，默认为5分钟</p><p><strong>delayOfInitialReadinessStatus</strong>：为<code>--horizontal-pod-autoscaler-initial-readiness-delay</code>的值，默认为30s</p><p>根据pod状态和监控数据，对pod进行分类。分为"ready且有监控数据"、&ldquo;unreadyPods&rdquo;、&ldquo;ignoredPods&rdquo;、&ldquo;missingPods&rdquo;</p><p><strong>unreadyPods</strong>：</p><ul><li>pod的Phase为pending</li><li>resource、containerResource类型的数据源且为CPU资源监控的数据<ul><li>pod status没有type为Ready的condition或pod.Status.StartTime为nil（pod未被kubelet接管）</li><li>计算副本时间还未超过pod启动时间加<code>cpuInitializationPeriod</code>，且ready condition为false</li><li>计算副本时间还未超过pod启动时间加<code>cpuInitializationPeriod</code>，且为ready状态且metric的timestamp是在readyCondition.LastTransitionTime加metric.Window之前</li><li>计算副本时间已经超过pod启动时间加<code>cpuInitializationPeriod</code>，且ready condition为false，且readyCondition.LastTransitionTime在pod.Status.StartTime加<code>delayOfInitialReadinessStatus</code>时间内</li></ul></li></ul><p><strong>missingPods</strong>：没有监控数据的pod</p><p><strong>ignoredPods</strong>：pod被删除或pod的phase为"Failed"</p><h5 id=数据修复>数据修复</h5><p>上面两种类型的监控数据是聚合数据，即多个pod对应一个监控数据。而下面三种类型的监控数据不是聚合数据，即每个pod对应一个监控数据。如果pod异常和监控数据缺失都会导致计算出的副本数异常，为了避免过多的扩容和缩容，所以需要进行数据修复。</p><ul><li>根据ready pod数量和已有的监控数据，计算出副本数，根据这个副本数在不需要考虑tolerance下是否需要扩缩容。如果需要扩容，则没有监控数据pod的监控数据修正为0。需要缩容，则没有监控数据pod的监控数据修正为HPA对象里设置目标值。</li><li>需要扩容且存在unready pod，则unready pod的监控数据修复为0。（为了防止新生成的pod启动时候使用CPU很高，导致一直触发扩容）</li></ul><table><thead><tr><th></th><th>unreadyPods > 0</th><th>missingPods > 0</th><th>action</th></tr></thead><tbody><tr><td>scale up</td><td>true</td><td>true</td><td>fix unreadyPods and missingPods metrics value as 0</td></tr><tr><td>scale up</td><td>true</td><td>false</td><td>no action</td></tr><tr><td>scale up</td><td>false</td><td>true</td><td>fix missingPods metrics value as 0</td></tr><tr><td>scale up</td><td>false</td><td>false</td><td>no action</td></tr><tr><td>scale down</td><td>true</td><td>true</td><td>fix missingPods metrics as target value</td></tr><tr><td>scale down</td><td>true</td><td>false</td><td>no action</td></tr><tr><td>scale down</td><td>false</td><td>true</td><td>fix missingPods metrics as target value</td></tr><tr><td>scale down</td><td>false</td><td>false</td><td>no action</td></tr></tbody></table><h5 id=pods类型的数据源>Pods类型的数据源</h5><p><strong>readyMissingPodMetricsCount</strong>为所有pod metrics中移除<code>ignoredPods</code>和<code>unreadyPods</code>后的metrics数量。</p><p><strong>afterFixMetricsCount</strong>为数据修复之后pod的metric数量</p><ol><li>计算<code>ratio=metricsTotal /</code>
<code>(readyMissingPodMetricsCount * spec.metrics[*].pods.target.averageValue)</code>。</li><li>如果有<code>missingPods</code>且ratio小于1（缩容），则<code>missingPods</code>的监控数据修复为<code>spec.metrics[*].pods.target.averageValue</code>，<code>afterFixMetricsCount</code>重新包括了<code>missingPods</code>数量。</li><li>如果有<code>missingPods</code>且ratio大于等于1（扩容或不扩不缩），则<code>missingPods</code>的监控数据修复为0，<code>afterFixMetricsCount</code>重新包括了<code>missingPods</code>数量。如果有unreadyPods，则<code>unreadyPods</code>的监控数据修复为0。<code>afterFixMetricsCount</code>重新包括了<code>unreadyPods</code>数量。</li><li>如果没有<code>missingPods</code>且ratio大于<code>1+tolerance</code>（扩容）且存在<code>unreadyPods</code>，则<code>unreadyPods</code>的监控数据修复为0，<code>afterFixMetricsCount</code>重新包括了<code>missingPods</code>数量</li><li>如果没有<code>missingPods</code>且ratio大于<code>1+tolerance</code>（扩容）且不存在<code>unreadyPods</code>，则<code>desiredReplicas</code>为<code>ratio*readyPodCount</code>向上取整</li><li>如果没有<code>missingPods</code>且ratio在<code>[1-tolerance, 1+tolerance]</code>，则不进行扩缩容<code>desiredReplicas</code>为spec.replicas</li><li>如果没有<code>missingPods</code>且ratio小于<code>1-tolerance</code>，则进行缩容<code>desiredReplicas</code>为<code>ratio*readyPodCount</code>向上取整</li><li>重新计算新的ratio，<code>newRatio=afterFixMetricsTotal / (afterFixMetricsCount * spec.metrics[*].pods.target.averageValue</code></li><li>如果新的ratio在<code>[1-tolerance, 1+tolerance]</code>，则不进行扩缩容<code>desiredReplicas</code>为spec.replicas</li><li>如果新的ratio大于<code>1+tolerance</code>，且修复前的ratio小于1-tolerance，即修复之前是缩容且修复之后是扩容，则不进行扩缩容<code>desiredReplicas</code>为spec.replicas</li><li>如果新的ratio小于<code>1-tolerance</code>，且修复前的ratio大于<code>1+tolerance</code>，即修复之前是扩容且修复之后是缩容，则不进行扩缩容<code>desiredReplicas</code>为spec.replicas</li><li>计算新的副本数<code>ceil( afterFixMetricsTotal / spec.metrics[*].pods.target.averageValue)</code></li><li>如果新的ratio大于<code>1+tolerance</code>，且修复前的ratio大于<code>1+tolerance</code>，即修复之前是扩容且修复之后是扩容，且新的副本数小于spec.replicas，则不进行扩缩容<code>desiredReplicas</code>为spec.replicas</li><li>如果新的ratio小于<code>1-tolerance</code>，且修复前的ratio小于<code>1-tolerance</code>，即修复之前是缩容且修复之后是缩容，且新的副本数大于spec.replicas，则不进行扩缩容<code>desiredReplicas</code>为spec.replicas</li><li>剩余的情况，<code>desiredReplicas</code>为<code>ceil( afterFixMetricsTotal / spec.metrics[*].pods.target.averageValue)</code>向上取整</li></ol><p><img class=lazyload src=/sre/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/wu0407/assets/img/hpa-pods.jpg data-srcset="https://cdn.jsdelivr.net/gh/wu0407/assets/img/hpa-pods.jpg, https://cdn.jsdelivr.net/gh/wu0407/assets/img/hpa-pods.jpg 1.5x, https://cdn.jsdelivr.net/gh/wu0407/assets/img/hpa-pods.jpg 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/wu0407/assets/img/hpa-pods.jpg title="hpa-pods "></p><h5 id=resource类型的数据源且type为averagevalue>Resource类型的数据源且type为AverageValue</h5><p>这个跟<code>Pods类型</code>的基本一样，只是获取metrics数据的方法不一样，target value是<code>spec.metrics[*].resource.target.averageValue</code></p><p><strong>readyMissingPodMetricsCount</strong>为所有pod metrics中移除<code>ignoredPods</code>和<code>unreadyPods</code>后的metrics数量。</p><p><strong>afterFixMetricsCount</strong>为数据修复之后pod的metric数量</p><ol><li>计算<code>ratio=metricsTotal /</code>
<code>(readyMissingPodMetricsCount * spec.metrics[*].resource.target.averageValue)</code>。</li><li>如果有<code>missingPods</code>且ratio小于1（缩容），则<code>missingPods</code>的监控数据修复为<code>spec.metrics[*].resource.target.averageValue</code>，<code>afterFixMetricsCount</code>重新包括了<code>missingPods</code>数量。</li><li>如果有<code>missingPods</code>且ratio大于等于1（扩容或不扩不缩），则<code>missingPods</code>的监控数据修复为0，<code>afterFixMetricsCount</code>重新包括了<code>missingPods</code>数量。如果有unreadyPods，则<code>unreadyPods</code>的监控数据修复为0。<code>afterFixMetricsCount</code>重新包括了<code>unreadyPods</code>数量。</li><li>如果没有<code>missingPods</code>且ratio大于<code>1+tolerance</code>（扩容）且存在<code>unreadyPods</code>，则<code>unreadyPods</code>的监控数据修复为0，<code>afterFixMetricsCount</code>重新包括了<code>missingPods</code>数量</li><li>如果没有<code>missingPods</code>且ratio大于<code>1+tolerance</code>（扩容）且不存在<code>unreadyPods</code>，则<code>desiredReplicas</code>为<code>ratio*readyPodCount</code>向上取整</li><li>如果没有<code>missingPods</code>且ratio在<code>[1-tolerance, 1+tolerance]</code>，则不进行扩缩容<code>desiredReplicas</code>为spec.replicas</li><li>如果没有<code>missingPods</code>且ratio小于<code>1-tolerance</code>，则进行缩容<code>desiredReplicas</code>为<code>ratio*readyPodCount</code>向上取整</li><li>重新计算新的ratio，<code>newRatio=afterFixMetricsTotal / (afterFixMetricsCount * spec.metrics[*].resource.target.averageValue</code></li><li>如果新的ratio在<code>[1-tolerance, 1+tolerance]</code>，则不进行扩缩容<code>desiredReplicas</code>为spec.replicas</li><li>如果新的ratio大于<code>1+tolerance</code>，且修复前的ratio小于1-tolerance，即修复之前是缩容且修复之后是扩容，则不进行扩缩容<code>desiredReplicas</code>为spec.replicas</li><li>如果新的ratio小于<code>1-tolerance</code>，且修复前的ratio大于<code>1+tolerance</code>，即修复之前是扩容且修复之后是缩容，则不进行扩缩容<code>desiredReplicas</code>为spec.replicas</li><li>计算新的副本数<code>ceil( afterFixMetricsTotal / spec.metrics[*].resource.target.averageValue)</code></li><li>如果新的ratio大于<code>1+tolerance</code>，且修复前的ratio大于<code>1+tolerance</code>，即修复之前是扩容且修复之后是扩容，且新的副本数小于spec.replicas，则不进行扩缩容<code>desiredReplicas</code>为spec.replicas</li><li>如果新的ratio小于<code>1-tolerance</code>，且修复前的ratio小于<code>1-tolerance</code>，即修复之前是缩容且修复之后是缩容，且新的副本数大于spec.replicas，则不进行扩缩容<code>desiredReplicas</code>为spec.replicas</li><li>剩余的情况，<code>desiredReplicas</code>为<code>ceil( afterFixMetricsTotal / spec.metrics[*].resource.target.averageValue)</code>向上取整</li></ol><p><img class=lazyload src=/sre/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/wu0407/assets/img/hpa-resource-AverageValue.webp data-srcset="https://cdn.jsdelivr.net/gh/wu0407/assets/img/hpa-resource-AverageValue.webp, https://cdn.jsdelivr.net/gh/wu0407/assets/img/hpa-resource-AverageValue.webp 1.5x, https://cdn.jsdelivr.net/gh/wu0407/assets/img/hpa-resource-AverageValue.webp 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/wu0407/assets/img/hpa-resource-AverageValue.webp title=hpa-resource-AverageValue></p><h5 id=resource类型的数据源且type为averageutilization>Resource类型的数据源且type为AverageUtilization</h5><p>这里计算ratio发生了变化，<code>ratio = metricsTotal * 100 / (requestTotal * spec.metrics[*].resource.target.averageUtilization)</code></p><p>其中requestTotal为所有pod里的container资源的request总和</p><p><strong>readyMissingPodMetricsCount</strong>为所有pod metrics中移除<code>ignoredPods</code>和<code>unreadyPods</code>后的metrics数量。</p><p><strong>afterFixMetricsCount</strong>为数据修复之后pod的metric数量</p><ol><li>计算<code>ratio= metricsTotal * 100 / (requestTotal * spec.metrics[*].resource.target.averageUtilization)</code>。</li><li>如果有<code>missingPods</code>且ratio小于1（缩容），则<code>missingPods</code>的监控数据修复为<code>spec.metrics[*].resource.target.averageUtilization</code>，<code>afterFixMetricsCount</code>重新包括了<code>missingPods</code>数量。</li><li>如果有<code>missingPods</code>且ratio大于等于1（扩容或不扩不缩），则<code>missingPods</code>的监控数据修复为0，<code>afterFixMetricsCount</code>重新包括了<code>missingPods</code>数量。如果有<code>unreadyPods</code>，则<code>unreadyPods</code>的监控数据修复为0。<code>afterFixMetricsCount</code>重新包括了<code>unreadyPods</code>数量。</li><li>如果没有<code>missingPods</code>且ratio大于<code>1+tolerance</code>（扩容）且存在<code>unreadyPods</code>，则<code>unreadyPods</code>的监控数据修复为0，<code>afterFixMetricsCount</code>重新包括了<code>missingPods</code>数量</li><li>如果没有<code>missingPods</code>且ratio大于<code>1+tolerance</code>（扩容）且不存在<code>unreadyPods</code>，则<code>desiredReplicas</code>为<code>ratio*readyPodCount</code>向上取整</li><li>如果没有<code>missingPods</code>且ratio在<code>[1-tolerance, 1+tolerance]</code>，则不进行扩缩容<code>desiredReplicas</code>为spec.replicas</li><li>如果没有<code>missingPods</code>且ratio小于<code>1-tolerance</code>，则进行缩容<code>desiredReplicas</code>为<code>ratio*readyPodCount</code>向上取整</li><li>重新计算新的ratio，<code>newRatio=afterFixMetricsTotal * 100 / (requestTotal * spec.metrics[*].resource.target.averageUtilization</code></li><li>如果新的ratio在<code>[1-tolerance, 1+tolerance]</code>，则不进行扩缩容<code>desiredReplicas</code>为spec.replicas</li><li>如果新的ratio大于<code>1+tolerance</code>，且修复前的ratio小于1-tolerance，即修复之前是缩容且修复之后是扩容，则不进行扩缩容<code>desiredReplicas</code>为spec.replicas</li><li>如果新的ratio小于<code>1-tolerance</code>，且修复前的ratio大于<code>1+tolerance</code>，即修复之前是扩容且修复之后是缩容，则不进行扩缩容<code>desiredReplicas</code>为spec.replicas</li><li>计算新的副本数<code>ceil( afterFixMetricsTotal * newRatio)</code></li><li>如果新的ratio大于<code>1+tolerance</code>，且修复前的ratio大于<code>1+tolerance</code>，即修复之前是扩容且修复之后是扩容，且新的副本数小于spec.replicas，则不进行扩缩容<code>desiredReplicas</code>为spec.replicas</li><li>如果新的ratio小于<code>1-tolerance</code>，且修复前的ratio小于<code>1-tolerance</code>，即修复之前是缩容且修复之后是缩容，且新的副本数大于spec.replicas，则不进行扩缩容<code>desiredReplicas</code>为spec.replicas</li><li>剩余的情况，<code>desiredReplicas</code>为<code>ceil( afterFixMetricsCount * newRatio)</code>向上取整</li></ol><p><img class=lazyload src=/sre/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/wu0407/assets/img/hpa-resource-AverageUtilization.webp data-srcset="https://cdn.jsdelivr.net/gh/wu0407/assets/img/hpa-resource-AverageUtilization.webp, https://cdn.jsdelivr.net/gh/wu0407/assets/img/hpa-resource-AverageUtilization.webp 1.5x, https://cdn.jsdelivr.net/gh/wu0407/assets/img/hpa-resource-AverageUtilization.webp 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/wu0407/assets/img/hpa-resource-AverageUtilization.webp title=hpa-resource-AverageUtilization></p><h5 id=containerresource类型的数据源且type为averagevalue>ContainerResource类型的数据源且type为AverageValue</h5><p>这个跟"Resource类型的数据源且type为AverageValue"计算方式类似，只是metricsTotal是每个pod metrics里container（spec.metrics[*].containerResource.container）的metrics value。</p><p><strong>readyMissingPodMetricsCount</strong>为所有pod metrics中移除<code>ignoredPods</code>和<code>unreadyPods</code>后的metrics数量。</p><p><strong>afterFixMetricsCount</strong>为数据修复之后pod的metric数量</p><ol><li>计算<code>ratio=metricsTotal /</code>
<code>(readyMissingPodMetricsCount * spec.metrics[*].containerResource.target.averageValue)</code>。</li><li>如果有<code>missingPods</code>且ratio小于1（缩容），则<code>missingPods</code>的监控数据修复为<code>spec.metrics[*].containerResource.target.averageValue</code>，<code>afterFixMetricsCount</code>重新包括了<code>missingPods</code>数量。</li><li>如果有<code>missingPods</code>且ratio大于等于1（扩容或不扩不缩），则<code>missingPods</code>的监控数据修复为0，<code>afterFixMetricsCount</code>重新包括了<code>missingPods</code>数量。如果有unreadyPods，则<code>unreadyPods</code>的监控数据修复为0。<code>afterFixMetricsCount</code>重新包括了<code>unreadyPods</code>数量。</li><li>如果没有<code>missingPods</code>且ratio大于<code>1+tolerance</code>（扩容）且存在<code>unreadyPods</code>，则<code>unreadyPods</code>的监控数据修复为0，<code>afterFixMetricsCount</code>重新包括了<code>missingPods</code>数量</li><li>如果没有<code>missingPods</code>且ratio大于<code>1+tolerance</code>（扩容）且不存在<code>unreadyPods</code>，则<code>desiredReplicas</code>为<code>ratio*readyPodCount</code>向上取整</li><li>如果没有<code>missingPods</code>且ratio在<code>[1-tolerance, 1+tolerance]</code>，则不进行扩缩容<code>desiredReplicas</code>为spec.replicas</li><li>如果没有<code>missingPods</code>且ratio小于<code>1-tolerance</code>，则进行缩容<code>desiredReplicas</code>为<code>ratio*readyPodCount</code>向上取整</li><li>重新计算新的ratio，<code>newRatio=afterFixMetricsTotal / (afterFixMetricsCount * spec.metrics[*].containerResource.target.averageValue</code></li><li>如果新的ratio在<code>[1-tolerance, 1+tolerance]</code>，则不进行扩缩容<code>desiredReplicas</code>为spec.replicas</li><li>如果新的ratio大于<code>1+tolerance</code>，且修复前的ratio小于1-tolerance，即修复之前是缩容且修复之后是扩容，则不进行扩缩容<code>desiredReplicas</code>为spec.replicas</li><li>如果新的ratio小于<code>1-tolerance</code>，且修复前的ratio大于<code>1+tolerance</code>，即修复之前是扩容且修复之后是缩容，则不进行扩缩容<code>desiredReplicas</code>为spec.replicas</li><li>计算新的副本数<code>ceil( afterFixMetricsTotal / spec.metrics[*].containerResource.target.averageValue)</code></li><li>如果新的ratio大于<code>1+tolerance</code>，且修复前的ratio大于<code>1+tolerance</code>，即修复之前是扩容且修复之后是扩容，且新的副本数小于spec.replicas，则不进行扩缩容<code>desiredReplicas</code>为spec.replicas</li><li>如果新的ratio小于<code>1-tolerance</code>，且修复前的ratio小于<code>1-tolerance</code>，即修复之前是缩容且修复之后是缩容，且新的副本数大于spec.replicas，则不进行扩缩容<code>desiredReplicas</code>为spec.replicas</li><li>剩余的情况，<code>desiredReplicas</code>为<code>ceil( afterFixMetricsTotal / spec.metrics[*].containerResource.target.averageValue)</code>向上取整</li></ol><p><img class=lazyload src=/sre/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/wu0407/assets/img/hpa-ContainerResource-AverageValue.webp data-srcset="https://cdn.jsdelivr.net/gh/wu0407/assets/img/hpa-ContainerResource-AverageValue.webp, https://cdn.jsdelivr.net/gh/wu0407/assets/img/hpa-ContainerResource-AverageValue.webp 1.5x, https://cdn.jsdelivr.net/gh/wu0407/assets/img/hpa-ContainerResource-AverageValue.webp 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/wu0407/assets/img/hpa-ContainerResource-AverageValue.webp title=hpa-ContainerResource-AverageValue></p><h5 id=containerresource类型的数据源且type为averageutilization>ContainerResource类型的数据源且type为AverageUtilization</h5><p>这个跟"Resource类型的数据源且type为<code>AverageUtilization</code>&ldquo;计算流程类似。</p><p>这里的<code>totalRequest</code>为pod里的container（在<code>spec.metrics[*].containerResource.container</code>）的资源的request</p><p><strong>readyMissingPodMetricsCount</strong>为所有pod metrics中移除<code>ignoredPods</code>和<code>unreadyPods</code>后的metrics数量。</p><p><strong>afterFixMetricsCount</strong>为数据修复之后pod的metric数量</p><ol><li>计算<code>ratio= metricsTotal * 100 / (requestTotal * spec.metrics[*].containerResource.target.averageUtilization)</code>。</li><li>如果有<code>missingPods</code>且ratio小于1（缩容），则<code>missingPods</code>的监控数据修复为<code>spec.metrics[*].containerResource.target.averageUtilization</code>，<code>afterFixMetricsCount</code>重新包括了<code>missingPods</code>数量。</li><li>如果有<code>missingPods</code>且ratio大于等于1（扩容或不扩不缩），则<code>missingPods</code>的监控数据修复为0，<code>afterFixMetricsCount</code>重新包括了<code>missingPods</code>数量。如果有<code>unreadyPods</code>，则<code>unreadyPods</code>的监控数据修复为0。<code>afterFixMetricsCount</code>重新包括了<code>unreadyPods</code>数量。</li><li>如果没有<code>missingPods</code>且ratio大于<code>1+tolerance</code>（扩容）且存在<code>unreadyPods</code>，则<code>unreadyPods</code>的监控数据修复为0，<code>afterFixMetricsCount</code>重新包括了<code>missingPods</code>数量</li><li>如果没有<code>missingPods</code>且ratio大于<code>1+tolerance</code>（扩容）且不存在<code>unreadyPods</code>，则<code>desiredReplicas</code>为<code>ratio*readyPodCount</code>向上取整</li><li>如果没有<code>missingPods</code>且ratio在<code>[1-tolerance, 1+tolerance]</code>，则不进行扩缩容<code>desiredReplicas</code>为spec.replicas</li><li>如果没有<code>missingPods</code>且ratio小于<code>1-tolerance</code>，则进行缩容<code>desiredReplicas</code>为<code>ratio*readyPodCount</code>向上取整</li><li>重新计算新的ratio，<code>newRatio=afterFixMetricsTotal * 100 / (requestTotal * spec.metrics[*].containerResource.target.averageUtilization</code></li><li>如果新的ratio在<code>[1-tolerance, 1+tolerance]</code>，则不进行扩缩容<code>desiredReplicas</code>为spec.replicas</li><li>如果新的ratio大于<code>1+tolerance</code>，且修复前的ratio小于1-tolerance，即修复之前是缩容且修复之后是扩容，则不进行扩缩容<code>desiredReplicas</code>为spec.replicas</li><li>如果新的ratio小于<code>1-tolerance</code>，且修复前的ratio大于<code>1+tolerance</code>，即修复之前是扩容且修复之后是缩容，则不进行扩缩容<code>desiredReplicas</code>为spec.replicas</li><li>计算新的副本数<code>ceil( afterFixMetricsTotal * newRatio)</code></li><li>如果新的ratio大于<code>1+tolerance</code>，且修复前的ratio大于<code>1+tolerance</code>，即修复之前是扩容且修复之后是扩容，且新的副本数小于spec.replicas，则不进行扩缩容<code>desiredReplicas</code>为spec.replicas</li><li>如果新的ratio小于<code>1-tolerance</code>，且修复前的ratio小于<code>1-tolerance</code>，即修复之前是缩容且修复之后是缩容，且新的副本数大于spec.replicas，则不进行扩缩容<code>desiredReplicas</code>为spec.replicas</li><li>剩余的情况，<code>desiredReplicas</code>为<code>ceil( afterFixMetricsCount * newRatio)</code>向上取整</li></ol><p><img class=lazyload src=/sre/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/wu0407/assets/img/hpa-ContainerResource-AverageUtilization.webp data-srcset="https://cdn.jsdelivr.net/gh/wu0407/assets/img/hpa-ContainerResource-AverageUtilization.webp, https://cdn.jsdelivr.net/gh/wu0407/assets/img/hpa-ContainerResource-AverageUtilization.webp 1.5x, https://cdn.jsdelivr.net/gh/wu0407/assets/img/hpa-ContainerResource-AverageUtilization.webp 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/wu0407/assets/img/hpa-ContainerResource-AverageUtilization.webp title=hpa-ContainerResource-AverageUtilization></p><h3 id=扩缩容行为策略控制>扩缩容行为策略控制</h3><p>在上面的流程执行完会得到一个期望的副本数，但是这个副本数并不是HPA controller最终计算的副本数，它还需要经过扩缩容行为控制策略处理才能得到最终的副本数。</p><p>扩缩容行为策略是对控制扩缩容的速度进行限制，防止过快扩容和过快的缩容导致的不稳定的行为。</p><p>扩缩容行为控制分为两种，HPA对象里未设置了spec.behavior（默认扩缩容行为）和设置spec.behavior。</p><h4 id=未设置specbehavior默认扩缩容行为>未设置spec.behavior（默认扩缩容行为）</h4><p><strong>downscaleStabilisationWindow</strong>：为&ndash;horizontal-pod-autoscaler-downscale-stabilization的值，默认为5分钟</p><ol><li>将上面的流程执行的副本数和执行的时间记录到内存里</li><li>从内存中查找<code>downscaleStabilisationWindow</code>窗口内最大的副本数<code>stabilizedRecommendation</code></li><li>这个窗口内的最大扩容上限<code>scaleUpLimit</code>为<code>max(2*spec.replicas, 4)</code></li><li>对<code>stabilizedRecommendation</code>进行规整（大于上限等于上限，小于下限就等于下限），得出最终的副本数。上限为<code>min(scaleUpLimit, hpa.Spec.MaxReplicas)</code>，下限为<code>minReplicas</code>（默认为<code>hpa.Spec.minReplicas</code>，当<code>hpa.Spec.minReplicas</code>没有设置时候为1），即确保期望副本数在<code>[minReplicas, min(max(2*spec.replicas, 4), hpa.Spec.maxReplicas)]</code></li></ol><h4 id=设置了specbehavior>设置了spec.behavior</h4><p>在每次HPA controller进行扩缩容时侯，会将HPA对应的workload的副本数的变化量和扩缩容时间记录到内存中</p><ol><li><p>将上面流程<code>desiredReplicas</code>和执行时间记录到内存里</p></li><li><p>从<code>hpa.spec.behavior.scaleUp.stabilizationWindowSeconds</code>窗口中（包括<code>desiredReplicas</code>）查找最小副本数<code>upRecommendation</code></p></li><li><p>从<code>hpa.spec.behavior.scaleDown.stabilizationWindowSeconds</code>窗口中（包括<code>desiredReplicas</code>）查找最大副本数<code>downRecommendation</code></p></li><li><p>对<code>spec.replicas</code>进行规整得到稳定窗口得副本数<code>stabilizedRecommendation</code>，即如果<code>spec.replicas</code>大于<code>downRecommendation</code>，则<code>stabilizedRecommendation</code>为<code>downRecommendation</code>。如果<code>spec.replicas</code>小于<code>upRecommendation</code>，则<code>stabilizedRecommendation</code>为<code>upRecommendation</code>。即<code>stabilizedRecommendation</code>在<code>[upRecommendation, downRecommendation ]</code>，只有<code>spec.replicas</code>小于<code>hpa.spec.behavior.scaleUp.stabilizationWindowSeconds</code>窗口中的最小值才有可能扩容，只有<code>spec.replicas</code>大于<code>hpa.spec.behavior.scaleDown.stabilizationWindowSeconds</code>窗口中的最大值才有可能缩容。</p></li><li><p>在需要扩容情况下（<code>stabilizedRecommendation</code>大于<code>spec.replicas</code>）</p><ul><li><p><code>hpa.spec.behavior.scaleUp.selectPolicy</code>为Disabled，则不进行扩缩容最终副本数为spec.replicas</p></li><li><p><code>hpa.spec.behavior.scaleUp.selectPolicy</code>为Max，遍历<code>hpa.spec.behavior.scaleUp.policies</code>执行下面：</p><ul><li><p>从内存中查找在<code>policy.periodSeconds</code>这个策略窗口内的累计副本数变化量<code>replicasAddedInCurrentPeriod</code>，窗口开始时候的副本数<code>periodStartReplicas=spec.replicas - replicasAddedInCurrentPeriod</code>。</p></li><li><p>这个策略类型<code>policy.Type</code>为"Pods&rdquo;，则这个策略窗口内的副本数上限<code>policyLimit</code>为<code>periodStartReplicas + policy.Value</code></p></li><li><p>这个策略类型<code>policy.Type</code>为"Percent"，则这个策略窗口里的副本数上限<code>policyLimit</code>为<code>Ceil(periodStartReplicas * (1 + policy.Value/100))</code>向上取整</p><p>这个窗口内的最大扩容上限<code>scaleUpLimit</code>为所有策略里最大的副本数上限，即<code>scaleUpLimit=max(policyLimit1, policyLimit2....)</code></p></li></ul></li><li><p><code>hpa.spec.behavior.scaleUp.selectPolicy</code>为Min，遍历<code>hpa.spec.behavior.scaleUp.policies</code>执行下面：</p><ul><li><p>从内存中查找在<code>policy.periodSeconds</code>这个策略窗口内的累计副本数变化量<code>replicasAddedInCurrentPeriod</code>，窗口开始时候的副本数<code>periodStartReplicas=spec.replicas - replicasAddedInCurrentPeriod</code>。</p></li><li><p>这个策略类型<code>policy.Type</code>为"Pods"，则这个策略窗口内的副本数上限<code>policyLimit</code>为<code>periodStartReplicas + policy.Value</code></p></li><li><p>这个策略类型<code>policy.Type</code>为"Percent"，则这个策略窗口里的副本数上限<code>policyLimit</code>为<code>Ceil(periodStartReplicas * (1 - policy.Value/100))</code>向上取整</p><p>这个窗口内的最大扩容上限<code>scaleUpLimit</code>为所有策略里最小的副本数上限，即<code>scaleUpLimit=min(policyLimit1, policyLimit2....)</code></p></li></ul></li><li><p>最终的副本数为<code>min(stabilizedRecommendation, min(scaleUpLimit, hpa.Spec.maxReplicas))</code></p></li></ul></li><li><p>在需要缩容情况下（<code>stabilizedRecommendation</code>大于<code>spec.replicas</code>）</p><ul><li><p><code>hpa.spec.behavior.scaleDown.selectPolicy</code>为Disabled，则不进行扩缩容最终副本数为spec.replicas</p></li><li><p><code>hpa.spec.behavior.scaleDown.selectPolicy</code>为Max，遍历<code>hpa.spec.behavior.scaleUp.policies</code>执行下面：</p><ul><li><p>从内存中查找在<code>policy.periodSeconds</code>这个策略窗口内的累计副本数变化量<code>replicasAddedInCurrentPeriod</code>，窗口开始时候的副本数<code>periodStartReplicas=spec.replicas + replicasAddedInCurrentPeriod</code>。</p></li><li><p>这个策略类型<code>policy.Type</code>为"Pods"，则这个策略窗口内的副本数下限<code>policyLimit</code>为<code>periodStartReplicas - policy.Value</code></p></li><li><p>这个策略类型<code>policy.Type</code>为"Percent"，则这个策略窗口里的副本数下限<code>policyLimit</code>为<code>Ceil(periodStartReplicas * (1 - policy.Value/100))</code>向上取整</p><p>这个窗口内的最大扩容上限<code>scaleUpLimit</code>为所有策略里最大副本数上限，即<code>scaleUpLimit=max(policyLimit1, policyLimit2....)</code></p></li></ul></li><li><p><code>hpa.spec.behavior.scaleDown.selectPolicy</code>为Min，遍历<code>hpa.spec.behavior.scaleDown.policies</code>执行下面：</p><ul><li><p>从内存中查找在<code>policy.periodSeconds</code>这个策略窗口内的累计副本数变化量<code>replicasAddedInCurrentPeriod</code>，窗口开始时候的副本数<code>periodStartReplicas=spec.replicas + replicasAddedInCurrentPeriod</code>。</p></li><li><p>这个策略类型<code>policy.Type</code>为"Pods"，则这个策略窗口内的副本数下限<code>policyLimit</code>为<code>periodStartReplicas - policy.Value</code></p></li><li><p>这个策略类型<code>policy.Type</code>为"Percent"，则这个策略窗口里的副本数下限<code>policyLimit</code>为<code>Ceil(periodStartReplicas * (1 - policy.Value/100))</code>向上取整</p><p>这个窗口内的最大扩容上限<code>scaleUpLimit</code>为所有策略里最大副本数上限，即<code>scaleUpLimit=min(policyLimit1, policyLimit2....)</code></p></li></ul></li><li><p>最终的副本数为<code>max(stabilizedRecommendation, max(scaleUpLimit, hpa.Spec.maxReplicas))</code></p></li></ul></li></ol><h3 id=扩容慢的原因>扩容慢的原因</h3><p>扩容慢包含三个方面，一个是扩容的响应时间，另一个是每次扩容的副本数即扩容速度，还有扩容的敏感度。</p><h4 id=扩缩容的响应时间>扩缩容的响应时间</h4><p>由于metrics-server是周期性的收集kubelet上的监控信息，这个周期默认是15s。而kubelet里的cadvisor周期性的收集pod相关的监控信息，这个周期是30s。HPA controller每15秒执行一次HPA对象的workload副本数计算。</p><p>所以<code>resource</code>和<code>containerResource</code>数据源类型的扩容延迟的时间在[0, 60s]，即延迟最大为60s。</p><p>而其他类型的扩容延迟时间，还受监控组件（比如Prometheus、VictoriaMetrics）收集监控信息周期影响，所以延迟为[0, 15+监控收集周期]</p><h4 id=扩缩容的速度>扩缩容的速度</h4><p>了解了HPA controller计算副本数的流程，最终的副本数由监控数据和扩缩容行为控制决定。分析一下开头的测试结果，先看压测开始后第一次HPA资源的变化时候的status字段，这里给出了当前的监控的<code>averageUtilization</code>为2575，<code>averageValue</code>为515m。</p><p>根据这个数据我们看一下期望的副本数为<code>258 = ceil(spec.replicas * averageValue * 100 / request * target.averageUtilization) = ceil(2 * 515 * 100/20 * 20) </code>。</p><p>由于<code>hpa.spec.maxReplicas</code>为10，会将10保存到内存中。然后没有配置<code>hpa.spec.behavior</code>，所以这个窗口的扩容上限为<code>4=max(2 * spec.replicas, 4)= max(4, 4)</code>，所以第一次最终的副本数为4。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>status</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>conditions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>lastTransitionTime</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2023-11-02T03:27:06Z&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>message</span><span class=p>:</span><span class=w> </span><span class=l>the HPA controller was able to update the target scale to 4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>reason</span><span class=p>:</span><span class=w> </span><span class=l>SucceededRescale</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>status</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;True&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>AbleToScale</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>lastTransitionTime</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2023-11-02T03:37:07Z&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>message</span><span class=p>:</span><span class=w> </span><span class=l>the HPA was able to successfully calculate a replica count from cpu resource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=l>utilization (percentage of request)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>reason</span><span class=p>:</span><span class=w> </span><span class=l>ValidMetricFound</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>status</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;True&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>ScalingActive</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>lastTransitionTime</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2023-11-02T05:01:38Z&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>message</span><span class=p>:</span><span class=w> </span><span class=l>the desired replica count is increasing faster than the maximum scale</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=l>rate</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>reason</span><span class=p>:</span><span class=w> </span><span class=l>ScaleUpLimit</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>status</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;True&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>ScalingLimited</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>currentMetrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>resource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>current</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>averageUtilization</span><span class=p>:</span><span class=w> </span><span class=m>2575</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>averageValue</span><span class=p>:</span><span class=w> </span><span class=l>515m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cpu</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Resource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>currentReplicas</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>desiredReplicas</span><span class=p>:</span><span class=w> </span><span class=m>4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>lastScaleTime</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2023-11-02T05:10:26Z&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>第二次HPA资源变化的status字段里的监控数据<code>averageUtilization</code>和<code>averageValue</code>都为0，由于最小副本数为1（没有配置<code>hpa.spec.minReplicas</code>，默认为0），所以期望副本数为1，然后保存到内存中。由于这个窗口内内存里最大的副本数为10，所以还是会进行扩容。所以最终副本数为<code>8=max(2 * spec.replicas, 4)= max(8, 4)</code>。后面第三次扩容类似，这里就不分析了。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>status</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>conditions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>lastTransitionTime</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2023-11-02T03:27:06Z&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>message</span><span class=p>:</span><span class=w> </span><span class=l>the HPA controller was able to update the target scale to 8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>reason</span><span class=p>:</span><span class=w> </span><span class=l>SucceededRescale</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>status</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;True&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>AbleToScale</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>lastTransitionTime</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2023-11-02T03:37:07Z&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>message</span><span class=p>:</span><span class=w> </span><span class=l>the HPA was able to successfully calculate a replica count from cpu resource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=l>utilization (percentage of request)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>reason</span><span class=p>:</span><span class=w> </span><span class=l>ValidMetricFound</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>status</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;True&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>ScalingActive</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>lastTransitionTime</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2023-11-02T05:01:38Z&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>message</span><span class=p>:</span><span class=w> </span><span class=l>the desired replica count is increasing faster than the maximum scale</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=l>rate</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>reason</span><span class=p>:</span><span class=w> </span><span class=l>ScaleUpLimit</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>status</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;True&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>ScalingLimited</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>currentMetrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>resource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>current</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>averageUtilization</span><span class=p>:</span><span class=w> </span><span class=m>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>averageValue</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;0&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cpu</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Resource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>currentReplicas</span><span class=p>:</span><span class=w> </span><span class=m>4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>desiredReplicas</span><span class=p>:</span><span class=w> </span><span class=m>8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>lastScaleTime</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2023-11-02T05:10:41Z&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=扩容的敏感度>扩容的敏感度</h4><p><code>--horizontal-pod-autoscaler-tolerance</code>参数决定了扩缩容时可以容忍的抖动范围。该参数旨在防止因监控数据波动而引发的意外扩缩容行为，但同时也可能导致扩缩容的敏感度降低。默认值为0.1，意味着可容忍10%的监控数据变化。</p><p>比如上面的例子里，只有pod的CPU平均使用率达到request的22%时候才会进行扩容。</p><h4 id=hpa-controller执行效率>HPA controller执行效率</h4><p>在1.23版本中HPA controller只启动一个goroutine来处理集群中所有HPA资源，在大量的HPA对象的集群中会有性能瓶颈，所以在1.26版本中增加<code>--concurrent-horizontal-pod-autoscaler-syncs</code>命令行选项支持配置goroutine数量<a href=https://github.com/kubernetes/kubernetes/pull/108501 target=_blank rel="external nofollow noopener noreferrer">PR#108501</a></p><h4 id=应用ready时间>应用ready时间</h4><p>由于存在unready pod监控数据修复问题（扩容时候数据修复为0），所以扩容的速度会变慢。</p><p>pod ready需要的时间越短扩缩容速度越快，而pod从启动到ready时间，取决于pod调度、kubelet响应pod调度完成、镜像下载、容器创建、应用启动、应用readiness。</p><img src=https://cdn.jsdelivr.net/gh/wu0407/assets/img/Constituents-of-lag-in-autoscaling.webp alt=Constituents-of-lag-in-autoscaling style=zoom:50%><p>图片来自：https://medium.com/expedia-group-tech/autoscaling-in-kubernetes-why-doesnt-the-horizontal-pod-autoscaler-work-for-me-5f0094694054</p><h2 id=解决方案>解决方案</h2><p>解决思路：</p><ol><li>缩短获取监控的链路长度</li><li>缩短pod ready时间（pod生成到pod ready每个环节都进行优化）</li><li>HPA controller性能提升</li><li>设置合理的扩容行为策略</li><li>设置合理的容忍度</li><li>预测式扩缩容或定时扩容</li></ol><h3 id=缩短获取监控的链路长度>缩短获取监控的链路长度</h3><p>除了kubernetes自身的HPA控制器进行水平扩缩容，还有<a href=https://knative.dev/ target=_blank rel="external nofollow noopener noreferrer">Knative</a>和<a href=https://keda.sh/ target=_blank rel="external nofollow noopener noreferrer">KEDA</a>项目也是进行水平扩缩容。</p><p>既然监控数据获取的链路过长导致扩缩容响应时间长，那么<a href=https://knative.dev/ target=_blank rel="external nofollow noopener noreferrer">Knative</a>就从简化链路长度来解决扩缩响应问题，支持基于qps和tps扩容，做到秒级弹性。</p><p>根据KEDA文档它的角色是取代<a href=https://github.com/kubernetes-sigs/prometheus-adapter target=_blank rel="external nofollow noopener noreferrer">Prometheus-adaptor</a>，提供external和custom metrics，即依然使用HPA机制，并没有解决链路长问题。而是支持事件驱动然扩缩容更灵敏，这个knative也有这个功能。</p><h3 id=缩短pod-ready时间>缩短pod ready时间</h3><p>这个话题就比较大了，包括镜像加速（<a href=https://github.com/dragonflyoss/Dragonfly2 target=_blank rel="external nofollow noopener noreferrer">dragonfly p2p</a>，预拉取、<a href=https://github.com/containerd/nydus-snapshotter target=_blank rel="external nofollow noopener noreferrer">containerd nydus</a>），容器运行时（<a href=https://github.com/containers/crun target=_blank rel="external nofollow noopener noreferrer">crun</a>、<a href=https://podman.io/ target=_blank rel="external nofollow noopener noreferrer">podman</a>、<a href=https://cri-o.io/ target=_blank rel="external nofollow noopener noreferrer">cri-o</a>），调度器性能优化，拓扑感知。</p><h3 id=hpa-controller性能提升>HPA controller性能提升</h3><p>使用1.26以上版本增加goroutine，当然不差钱的，有多好配置上多好配置。</p><h3 id=设置合理的扩容行为策略>设置合理的扩容行为策略</h3><p>如果不设置behavior字段，每次扩容的数量受限于<code>downscaleStabilisationWindow</code>窗口内最大的副本数和当前的副本数spec.replicas（最大扩容上限<code>scaleUpLimit</code>为<code>max(2*spec.replicas, 4)</code>）。</p><p>所以要在不设置behavior字段的情况下提高扩容速度，基本不可能。因为<code>downscaleStabilisationWindow</code>决定窗口内最大副本数的持续时间，它的作用的是防止突高随后突降导致副本数不稳定，而spec.replicas在HPA对象的调谐周期内是固定的。</p><p>既然behavior字段的配置影响扩缩容，那么合理的配置behavior字段能够提高扩缩容速度。</p><ol><li>增加扩容速度： 减小<code>hpa.spec.behavior.scaleUp.stabilizationWindowSeconds</code>（如果没有设置默认值为0）和增加<code>hpa.spec.behavior.scaleUp.policies[*].Value</code>和减小<code>hpa.spec.behavior.scaleUp.policies[*].PeriodSeconds</code></li><li>增加缩容速度：减小<code>hpa.spec.behavior.scaleDown.stabilizationWindowSeconds</code>（如果没有设置默认值为&ndash;horizontal-pod-autoscaler-downscale-stabilization值）和增加<code>hpa.spec.behavior.scaleDown.policies[*].Value</code>和减小<code>hpa.spec.behavior.scaleDown.policies[*].PeriodSeconds</code></li></ol><h3 id=设置合理的容忍度>设置合理的容忍度</h3><p>设置合理的<code>--horizontal-pod-autoscaler-tolerance</code>，它是一把双刃剑，如果调整不合理容易频繁的扩缩容行为。</p><h3 id=预测式扩缩容或定时扩容>预测式扩缩容或定时扩容</h3><p>换个思路，既然扩容慢不如提前扩容，像阿里云的<a href=https://help.aliyun.com/zh/ack/ack-managed-and-ack-dedicated/user-guide/ahpa-overview-1 target=_blank rel="external nofollow noopener noreferrer">AHPA</a>，蚂蚁金服的<a href=https://github.com/traas-stack/kapacity target=_blank rel="external nofollow noopener noreferrer">kapacity</a>。</p><p>基于历史流量进行预测式扩容，比如<a href=https://gocrane.io/docs/tutorials/using-effective-hpa-to-scaling-with-effectiveness/ target=_blank rel="external nofollow noopener noreferrer">crane的EHPA</a>，蚂蚁金服的<a href=https://github.com/traas-stack/kapacity target=_blank rel="external nofollow noopener noreferrer">kapacity</a>，阿里云的<a href=https://help.aliyun.com/zh/ack/ack-managed-and-ack-dedicated/user-guide/ahpa-overview-1 target=_blank rel="external nofollow noopener noreferrer">AHPA</a>。</p><h2 id=总结>总结</h2><p>由于监控数据获取链路过长和HPA controller性能问题导致的扩容延迟，而应用的ready时间长短和<code>hpa.spec.behavior</code>会影响扩容速度。</p><p>缩短pod ready时间，需要在pod生成到pod ready的每个环节进行优化。</p><p>knative从简化监控获取链路角度来解决扩容延迟问题，提前扩容角度解决问题有crane的EHPA和蚂蚁金服的kapacity。</p><h2 id=reference>Reference</h2><p><a href="https://www.youtube.com/watch?v=9UqBSpmGzCs&amp;list=PLj6h78yzYM2OJcjIuAsbbhXAaDrAnuKRB&amp;index=112" target=_blank rel="external nofollow noopener noreferrer">我们如何构建生产级HPA：从有效算法到无风险的自动扩展 | How We Build Production-Grade HPA: From Effective Algorithm to Risk-Free Autoscaling - Ziqiu Zhu & Yiru Guo, Ant Group</a></p><p><a href=https://medium.com/expedia-group-tech/autoscaling-in-kubernetes-why-doesnt-the-horizontal-pod-autoscaler-work-for-me-5f0094694054 target=_blank rel="external nofollow noopener noreferrer">Autoscaling in Kubernetes: Why doesn&rsquo;t the Horizontal Pod Autoscaler work for me?</a></p><p><a href=https://kubernetes.io/blog/2023/05/15/speed-up-pod-startup/ target=_blank rel="external nofollow noopener noreferrer">Kubernetes 1.27: updates on speeding up Pod startup</a></p><p><a href=https://midbai.com/post/why-hpa-scale-slowly/ target=_blank rel="external nofollow noopener noreferrer">为什么HPA扩容比较慢</a></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="0001-01-01 00:00:00">更新于 0001-01-01</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a href=/sre/posts/%E4%B8%BA%E4%BB%80%E4%B9%88hpa%E6%89%A9%E5%AE%B9%E6%AF%94%E8%BE%83%E6%85%A2/index.md title=阅读原始文档 class=link-to-markdown>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://kbsonlong.github.io/sre/posts/%E4%B8%BA%E4%BB%80%E4%B9%88hpa%E6%89%A9%E5%AE%B9%E6%AF%94%E8%BE%83%E6%85%A2/ data-title=为什么HPA扩容比较慢 data-hashtags=kubernetes,hpa,经验分享,技巧><i class="fa-brands fa-twitter fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://kbsonlong.github.io/sre/posts/%E4%B8%BA%E4%BB%80%E4%B9%88hpa%E6%89%A9%E5%AE%B9%E6%AF%94%E8%BE%83%E6%85%A2/ data-hashtag=kubernetes><i class="fa-brands fa-facebook-square fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 WhatsApp" data-sharer=whatsapp data-url=https://kbsonlong.github.io/sre/posts/%E4%B8%BA%E4%BB%80%E4%B9%88hpa%E6%89%A9%E5%AE%B9%E6%AF%94%E8%BE%83%E6%85%A2/ data-title=为什么HPA扩容比较慢 data-web><i class="fa-brands fa-whatsapp fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=https://kbsonlong.github.io/sre/posts/%E4%B8%BA%E4%BB%80%E4%B9%88hpa%E6%89%A9%E5%AE%B9%E6%AF%94%E8%BE%83%E6%85%A2/ data-title=为什么HPA扩容比较慢><i data-svg-src=/sre/lib/simple-icons/icons/line.min.svg></i></a>
<a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://kbsonlong.github.io/sre/posts/%E4%B8%BA%E4%BB%80%E4%B9%88hpa%E6%89%A9%E5%AE%B9%E6%AF%94%E8%BE%83%E6%85%A2/ data-title=为什么HPA扩容比较慢><i class="fa-brands fa-weibo fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 Myspace" data-sharer=myspace data-url=https://kbsonlong.github.io/sre/posts/%E4%B8%BA%E4%BB%80%E4%B9%88hpa%E6%89%A9%E5%AE%B9%E6%AF%94%E8%BE%83%E6%85%A2/ data-title=为什么HPA扩容比较慢 data-description=分析hpa的工作原理，找到HPA扩容速度比较慢的原因。以及knative、keda这些项目如何解决扩容慢的问题，以及定时hpa、预测型hpa从其他角度解决HPA扩容慢问题><i data-svg-src=/sre/lib/simple-icons/icons/myspace.min.svg></i></a>
<a href=javascript:void(0); title="分享到 Blogger" data-sharer=blogger data-url=https://kbsonlong.github.io/sre/posts/%E4%B8%BA%E4%BB%80%E4%B9%88hpa%E6%89%A9%E5%AE%B9%E6%AF%94%E8%BE%83%E6%85%A2/ data-title=为什么HPA扩容比较慢 data-description=分析hpa的工作原理，找到HPA扩容速度比较慢的原因。以及knative、keda这些项目如何解决扩容慢的问题，以及定时hpa、预测型hpa从其他角度解决HPA扩容慢问题><i class="fa-brands fa-blogger fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 Evernote" data-sharer=evernote data-url=https://kbsonlong.github.io/sre/posts/%E4%B8%BA%E4%BB%80%E4%B9%88hpa%E6%89%A9%E5%AE%B9%E6%AF%94%E8%BE%83%E6%85%A2/ data-title=为什么HPA扩容比较慢><i class="fa-brands fa-evernote fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw"></i>&nbsp;<a href=/sre/tags/kubernetes/>kubernetes</a>,&nbsp;<a href=/sre/tags/hpa/>hpa</a>,&nbsp;<a href=/sre/tags/%E7%BB%8F%E9%AA%8C%E5%88%86%E4%BA%AB/>经验分享</a>,&nbsp;<a href=/sre/tags/%E6%8A%80%E5%B7%A7/>技巧</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/sre/>主页</a></span></section></div><div class=post-nav><a href=/sre/posts/ class=next rel=next title><i class="fa-solid fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=giscus><script src=https://giscus.app/client.js data-repo=kbsonlong/devops.alongparty.cn data-repo-id=R_kgDOHE7F-Q data-category=Announcements data-category-id=DIC_kwDOHE7F-c4CPP5J data-mapping=title data-theme=preferred_color_scheme data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-lang=zh-CN data-loading=lazy crossorigin=anonymous async defer></script><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app/ rel="external nofollow noopener noreferrer">giscus</a>.</noscript></div></div></article></main><footer class=footer><div class=footer-container><div class="footer-line copyright"><i class="fa-regular fa-copyright fa-fw"></i>
<span itemprop=copyrightYear>2018 - 2024</span><span class=author itemprop=copyrightHolder>
<a href=/sre/>kbsonlong</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class="footer-line statistics"></div><div class="footer-line ibruce"><span id=busuanzi_container_site_uv title=总访客数><i class="fa-regular fa-user fa-fw"></i>&nbsp;<span id=busuanzi_value_site_uv><i class="fa fa-spinner fa-spin fa-fw"></i></span></span><span id=busuanzi_container_site_pv class=footer-divider title=总访问量><i class="fa-regular fa-eye fa-fw"></i>&nbsp;<span id=busuanzi_value_site_pv><i class="fa fa-spinner fa-spin fa-fw"></i></span></span></div><div class="footer-line beian"><span class="icp footer-divider"><a target=_blank href=https://beian.miit.gov.cn/>粤ICP备18122209号</a></span></div></div></footer></div><div class=widgets><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fa-solid fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fa-solid fa-comment fa-fw"></i></a></div><a href=https://github.com/kbsonlong title="在 GitHub 上查看源代码" target=_blank rel="external nofollow noopener noreferrer" class="github-corner right d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div id=mask></div></div><link rel=stylesheet href=/sre/lib/katex/katex.min.css><link rel=stylesheet href=/sre/lib/katex/copy-tex.min.css><link rel=stylesheet href=/sre/lib/cookieconsent/cookieconsent.min.css><script type=text/javascript src=/sre/lib/autocomplete/autocomplete.min.js defer></script><script type=text/javascript src=/sre/lib/algoliasearch/algoliasearch-lite.umd.min.js defer></script><script type=text/javascript src=/sre/lib/lazysizes/lazysizes.min.js async defer></script><script type=text/javascript src=/sre/lib/sharer/sharer.min.js async defer></script><script type=text/javascript src=/sre/lib/katex/katex.min.js defer></script><script type=text/javascript src=/sre/lib/katex/auto-render.min.js defer></script><script type=text/javascript src=/sre/lib/katex/copy-tex.min.js defer></script><script type=text/javascript src=/sre/lib/katex/mhchem.min.js defer></script><script type=text/javascript src=/sre/lib/cookieconsent/cookieconsent.min.js defer></script><script type=text/javascript src=/sre/lib/pangu/pangu.min.js defer></script><script type=text/javascript src=/sre/lib/cell-watermark/watermark.min.js defer></script><script type=text/javascript src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async defer></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:10},comment:{giscus:{darkTheme:"dark",lightTheme:"light"}},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},enablePWA:!0,enablePangu:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"WFOR67TML1",algoliaIndex:"along",algoliaSearchKey:"ea1fe535f9a7ae353f3922489c829cc1",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"},watermark:{appendto:".wrapper>main",colspacing:30,content:'<img class="fixit-icon" src="/favicon-16x16.png" alt="FixIt logo" /> FixIt 主题',enable:!0,fontfamily:"inherit",fontsize:.85,height:21,opacity:.0125,rotate:15,rowspacing:60,width:150}}</script><script type=text/javascript src=/sre/js/theme.min.js defer></script><script type=text/javascript src=/sre/js/_custom.min.js defer></script></body></html>