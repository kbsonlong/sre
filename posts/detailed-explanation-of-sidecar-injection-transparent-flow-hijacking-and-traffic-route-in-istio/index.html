<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><meta http-equiv=X-UA-Compatible content="IE=edge, chrome=1"><title>Istio 中的 Sidecar 注入、透明流量劫持及流量路由过程详解 - 蜷缩的蜗牛</title><meta name=author content="kbsonlong">
<meta name=author-link content><meta name=description content="本文最早是基于 Istio 1.11 撰写，之后随着 Istio 的版本陆续更新，最新更新时间为 2022 年 5 月 12 日，关于本文历史版本的更新说明请见文章最后。本文记录了详细的实践过"><meta name=keywords content='istio,转载'><meta itemprop=name content="Istio 中的 Sidecar 注入、透明流量劫持及流量路由过程详解"><meta itemprop=description content="本文最早是基于 Istio 1.11 撰写，之后随着 Istio 的版本陆续更新，最新更新时间为 2022 年 5 月 12 日，关于本文历史版本的更新说明请见文章最后。本文记录了详细的实践过"><meta itemprop=datePublished content="2022-09-11T14:26:02+08:00"><meta itemprop=dateModified content="2022-09-11T14:26:02+08:00"><meta itemprop=wordCount content="8634"><meta itemprop=image content="https://www.kbsonlong.com/sre/logo_transparent.png"><meta itemprop=keywords content="istio,转载,"><meta property="og:title" content="Istio 中的 Sidecar 注入、透明流量劫持及流量路由过程详解"><meta property="og:description" content="本文最早是基于 Istio 1.11 撰写，之后随着 Istio 的版本陆续更新，最新更新时间为 2022 年 5 月 12 日，关于本文历史版本的更新说明请见文章最后。本文记录了详细的实践过"><meta property="og:type" content="article"><meta property="og:url" content="https://www.kbsonlong.com/sre/posts/detailed-explanation-of-sidecar-injection-transparent-flow-hijacking-and-traffic-route-in-istio/"><meta property="og:image" content="https://www.kbsonlong.com/sre/logo_transparent.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-09-11T14:26:02+08:00"><meta property="article:modified_time" content="2022-09-11T14:26:02+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.kbsonlong.com/sre/logo_transparent.png"><meta name=twitter:title content="Istio 中的 Sidecar 注入、透明流量劫持及流量路由过程详解"><meta name=twitter:description content="本文最早是基于 Istio 1.11 撰写，之后随着 Istio 的版本陆续更新，最新更新时间为 2022 年 5 月 12 日，关于本文历史版本的更新说明请见文章最后。本文记录了详细的实践过"><meta name=application-name content="FixIt"><meta name=apple-mobile-web-app-title content="FixIt"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#252627"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://www.kbsonlong.com/sre/posts/detailed-explanation-of-sidecar-injection-transparent-flow-hijacking-and-traffic-route-in-istio/><link rel=prev href=https://www.kbsonlong.com/sre/posts/vscode-configuration-markdown-template/><link rel=next href=https://www.kbsonlong.com/sre/posts/detailed-explanation-of-traffic-types-in-sidecar-and-iptables/><link rel=stylesheet href=/sre/lib/normalize/normalize.min.css><link rel=stylesheet href=/sre/css/style.min.css><link rel=stylesheet href=/sre/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/sre/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Istio 中的 Sidecar 注入、透明流量劫持及流量路由过程详解","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/www.kbsonlong.com\/sre\/posts\/detailed-explanation-of-sidecar-injection-transparent-flow-hijacking-and-traffic-route-in-istio\/"},"genre":"posts","keywords":"istio, 转载","wordcount":8634,"url":"https:\/\/www.kbsonlong.com\/sre\/posts\/detailed-explanation-of-sidecar-injection-transparent-flow-hijacking-and-traffic-route-in-istio\/","datePublished":"2022-09-11T14:26:02+08:00","dateModified":"2022-09-11T14:26:02+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"kbsonlong"},"description":""}</script></head><body header-desktop=sticky header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper github-corner=right><div class=header-title><a href=/sre/ title=蜷缩的蜗牛><img class="lazyload logo" src=/sre/svg/loading.min.svg data-src=/sre/logo_transparent.png data-srcset="/sre/logo_transparent.png, /sre/logo_transparent.png 1.5x, /sre/logo_transparent.png 2x" data-sizes=auto alt=蜷缩的蜗牛 title=蜷缩的蜗牛><span class=header-title-text>蜷缩的蜗牛</span></a><span class=header-subtitle></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/sre/posts/><i class='fa-solid fa-archive fa-fw fa-sm'></i> 文章</a></li><li class=menu-item><a class=menu-link href=/sre/categories/><i class='fa-solid fa-th fa-fw fa-sm'></i> 分类</a></li><li class=menu-item><a class=menu-link href=/sre/tags/><i class='fa-solid fa-tags fa-fw fa-sm'></i> 标签</a></li><li class=menu-item><a class=menu-link href=/sre/friends/ title=友情链接><i class='fa-solid fa-users fa-fw fa-sm'></i> 友链</a></li><li class=menu-item><a class=menu-link href=/sre/about/><i class='fa-solid fa-info-circle fa-fw fa-sm'></i> 关于</a></li><li class="menu-item d-none-desktop text-center"><a class=menu-link href=https://github.com/kbsonlong/ title=GitHub rel="noopener noreferrer" target=_blank><i class='fa-brands fa-github fa-fw'></i></a></li><li class="menu-item d-none-desktop text-center"><a class=menu-link href=/sre/messages/><i class='fa-solid fa-messages'></i> 留言板</a></li><li class=menu-item><a class=menu-link href=/sre/messages/ title=留言板>留言板</a></li><li class="menu-item delimiter"></li><li class="menu-item language"><span title=选择语言>简体中文<i class="dropdown-icon fa-solid fa-chevron-down"></i></span><ul class=sub-menu><li class=menu-item>没有更多翻译</li></ul></li><li class="menu-item search" id=search-desktop><input type=text placeholder="搜索文章标题或内容 ..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw"></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw"></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin"></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw"></i></li></ul></nav></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/sre/ title=蜷缩的蜗牛><img class="lazyload logo" src=/sre/svg/loading.min.svg data-src=/sre/logo_transparent.png data-srcset="/sre/logo_transparent.png, /sre/logo_transparent.png 1.5x, /sre/logo_transparent.png 2x" data-sizes=auto alt=/sre/logo_transparent.png title=/sre/logo_transparent.png><span class=header-title-text>蜷缩的蜗牛</span></a><span class=header-subtitle></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="搜索文章标题或内容 ..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw"></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw"></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><a class=menu-link href=/sre/posts/><i class='fa-solid fa-archive fa-fw fa-sm'></i> 文章</a></li><li class=menu-item><a class=menu-link href=/sre/categories/><i class='fa-solid fa-th fa-fw fa-sm'></i> 分类</a></li><li class=menu-item><a class=menu-link href=/sre/tags/><i class='fa-solid fa-tags fa-fw fa-sm'></i> 标签</a></li><li class=menu-item><a class=menu-link href=/sre/friends/ title=友情链接><i class='fa-solid fa-users fa-fw fa-sm'></i> 友链</a></li><li class=menu-item><a class=menu-link href=/sre/about/><i class='fa-solid fa-info-circle fa-fw fa-sm'></i> 关于</a></li><li class="menu-item d-none-desktop text-center"><a class=menu-link href=https://github.com/kbsonlong/ title=GitHub rel="noopener noreferrer" target=_blank><i class='fa-brands fa-github fa-fw'></i></a></li><li class="menu-item d-none-desktop text-center"><a class=menu-link href=/sre/messages/><i class='fa-solid fa-messages'></i> 留言板</a></li><li class=menu-item><a class=menu-link href=/sre/messages/ title=留言板>留言板</a></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw"></i></li><li class="menu-item language"><span title=选择语言>简体中文<i class="dropdown-icon fa-solid fa-chevron-down"></i>
</span><select class=language-select onchange="location=this.value"><option disabled>没有更多翻译</option></select></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=container page-style=normal><aside class=toc id=toc-auto><h2 class=toc-title>目录 <i class="toc-icon fa-solid fa-angle-down fa-fw"></i></h2><div class=toc-content id=toc-content-auto></div></aside><aside class=aside-custom></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>Istio 中的 Sidecar 注入、透明流量劫持及流量路由过程详解</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><img class="lazyload avatar" src=/sre/svg/loading.min.svg data-src="https://gravatar.loli.net/avatar/598872715ec08296cf1e1806135cd518?s=32&amp;d=mp" data-srcset="https://gravatar.loli.net/avatar/598872715ec08296cf1e1806135cd518?s=32&amp;d=mp, https://gravatar.loli.net/avatar/598872715ec08296cf1e1806135cd518?s=32&amp;d=mp 1.5x, https://gravatar.loli.net/avatar/598872715ec08296cf1e1806135cd518?s=32&amp;d=mp 2x" data-sizes=auto alt=kbsonlong title=kbsonlong>&nbsp;kbsonlong</span></span>
<span class=post-category>收录于 <a href=/sre/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/><i class="fa-regular fa-folder fa-fw"></i>&nbsp;云原生</a></span></div><div class=post-meta-line><span title="2022-09-11 14:26:02"><i class="fa-regular fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2022-09-11>2022-09-11</time>
</span>&nbsp;<i class="fa-solid fa-pencil-alt fa-fw"></i>&nbsp;约 8634 字&nbsp;
<i class="fa-regular fa-clock fa-fw"></i>&nbsp;预计阅读 18 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#内容介绍>内容介绍</a></li><li><a href=#sidecar-模式>Sidecar 模式</a><ul><li><a href=#使用-sidecar-模式的优势>使用 Sidecar 模式的优势</a></li></ul></li><li><a href=#sidecar-注入示例分析>Sidecar 注入示例分析</a></li><li><a href=#iptables-规则注入解析>iptables 规则注入解析</a><ul><li><a href=#在-minikube-中查看容器中的-iptabes-规则>在 minikube 中查看容器中的 iptabes 规则</a></li><li><a href=#在-gke-中查看容器的-iptables-规则>在 GKE 中查看容器的 iptables 规则</a></li></ul></li><li><a href=#iptables-流量劫持过程详解>iptables 流量劫持过程详解</a></li><li><a href=#流量路由过程详解>流量路由过程详解</a><ul><li><a href=#理解-inbound-handler>理解 Inbound Handler</a></li><li><a href=#理解-outbound-handler>理解 Outbound Handler</a></li></ul></li><li><a href=#小结>小结</a><ul><li><a href=#使用-iptables-做流量劫持时存在的问题>使用 iptables 做流量劫持时存在的问题</a></li><li><a href=#透明劫持方案优化>透明劫持方案优化</a></li></ul></li><li><a href=#更新说明>更新说明</a></li><li><a href=#参考>参考</a></li></ul></nav></div></div><div class=content id=content><p>本文最早是基于 Istio 1.11 撰写，之后随着 Istio 的版本陆续更新，最新更新时间为 2022 年 5 月 12 日，关于本文历史版本的更新说明请见文章最后。本文记录了详细的实践过程，力图能够让读者复现，因此事无巨细，想要理解某个部分过程的读者可以使用目录跳转到对应的小节阅读。</p><p>为了理解本文希望你先阅读以下内容：</p><ul><li><a href=/posts/b7e1eb/>理解 iptables</a></li><li><a href=/posts/dc5625/>Istio 数据平面 Pod 启动过程详解</a></li></ul><h2 id=内容介绍>内容介绍</h2><p>本文基于 Istio 1.13 版本，将为大家介绍以下内容：</p><ul><li>什么是 sidecar 模式和它的优势在哪里。</li><li>Istio 中是如何做 sidecar 注入的。</li><li>Sidecar 代理是如何做透明流量劫持的。</li><li>iptables 的路由规则。</li><li>Envoy 代理是如何路由流量到上游的。</li></ul><p>请大家结合下图理解本文中的内容，本图基于 Istio 官方提供的 Bookinfo 示例绘制，展示的是 <code>reviews</code> Pod 的内部结构，包括 Linux Kernel 空间中的 iptables 规则、Sidecar 容器、应用容器。</p><p><img class=lazyload src=/sre/svg/loading.min.svg data-src=https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913144220.png data-srcset="https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913144220.png, https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913144220.png 1.5x, https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913144220.png 2x" data-sizes=auto alt=https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913144220.png title="Istio 流量劫持示意图"></p><p><code>productpage</code> 访问 <code>reviews</code> Pod，入站流量处理过程对应于图示上的步骤：1、2、3、4、Envoy Inbound Handler、5、6、7、8、应用容器。</p><p><code>reviews</code> Pod 访问 <code>rating</code> 服务的出站流量处理过程对应于图示上的步骤是：9、10、11、12、Envoy Outbound Handler、13、14、15。</p><p>注意：图中的路径 16 近用于路由规则说明，它不不出现在当前示例中。实际上仅当 Pod 内发出的对当前 Pod 内的服务访问的时候才会途径它。</p><p>上图中关于流量路由部分，包含：</p><ul><li><code>productpage</code> 服务请求访问 <code>http://reviews.default.svc.cluster.local:9080/</code>，当流量进入 <code>reviews</code> Pod 内部时，流量是如何被 iptables 劫持到 Envoy 代理被 Inbound Handler 处理的；</li><li><code>reviews</code> 请求访问 <code>ratings</code> 服务的 Pod，应用程序发出的出站流量被 iptables 劫持到 Envoy 代理的 Outbound Handler 的处理。</li></ul><p>在阅读下文时，请大家确立以下已知点：</p><ul><li>首先，<code>productpage</code> 发出的对 <code>reivews</code> 的访问流量，是在 Envoy 已经通过 EDS 选择出了要请求的 <code>reviews</code> 服务的某个 Pod，知晓了其 IP 地址，直接向该 IP 发送的 TCP 连接请求。</li><li><code>reviews</code> 服务有三个版本，每个版本有一个实例，三个版本中的 sidecar 工作步骤类似，下文只以其中一个 Pod 中的 sidecar 流量转发步骤来说明。</li><li>所有进入 <code>reviews</code> Pod 的 TCP 流量都根据 Pod 中的 iptables 规则转发到了 Envoy 代理的 15006 端口，然后经过 Envoy 的处理确定转发给 Pod 内的应用容器还是透传。</li></ul><h2 id=sidecar-模式>Sidecar 模式</h2><p>将应用程序的功能划分为单独的进程运行在同一个最小调度单元中（例如 Kubernetes 中的 Pod）可以被视为 <strong>sidecar 模式</strong>。如下图所示，sidecar 模式允许您在应用程序旁边添加更多功能，而无需额外第三方组件配置或修改应用程序代码。</p><p><img class=lazyload src=/sre/svg/loading.min.svg data-src=https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913144314.png data-srcset="https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913144314.png, https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913144314.png 1.5x, https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913144314.png 2x" data-sizes=auto alt=https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913144314.png title=https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913144314.png></p><p>就像连接了 Sidecar 的三轮摩托车一样，在软件架构中， Sidecar 连接到父应用并且为其添加扩展或者增强功能。Sidecar 应用与主应用程序松散耦合。它可以屏蔽不同编程语言的差异，统一实现微服务的可观察性、监控、日志记录、配置、断路器等功能。</p><h3 id=使用-sidecar-模式的优势>使用 Sidecar 模式的优势</h3><p>使用 sidecar 模式部署服务网格时，无需在节点上运行代理，但是集群中将运行多个相同的 sidecar 副本。在 sidecar 部署方式中，每个应用的容器旁都会部署一个伴生容器（如 Envoy 或 MOSN），这个容器称之为 sidecar 容器。Sidecar 接管进出应用容器的所有流量。在 Kubernetes 的 Pod 中，在原有的应用容器旁边注入一个 Sidecar 容器，两个容器共享存储、网络等资源，可以广义的将这个包含了 sidecar 容器的 Pod 理解为一台主机，两个容器共享主机资源。</p><p>因其独特的部署结构，使得 sidecar 模式具有以下优势：</p><ul><li>将与应用业务逻辑无关的功能抽象到共同基础设施，降低了微服务代码的复杂度。</li><li>因为不再需要编写相同的第三方组件配置文件和代码，所以能够降低微服务架构中的代码重复度。</li><li>Sidecar 可独立升级，降低应用程序代码和底层平台的耦合度。</li></ul><h2 id=sidecar-注入示例分析>Sidecar 注入示例分析</h2><p>以 Istio 官方提供的 <code>bookinfo</code> 中 <code>productpage</code> 的 YAML 为例，关于 <code>bookinfo</code> 应用的详细 YAML 配置请参考 <a href=https://github.com/istio/istio/blob/master/samples/bookinfo/platform/kube/bookinfo.yaml target=_blank rel="external nofollow noopener noreferrer">bookinfo.yaml</a>。</p><p>下文将从以下几个方面讲解：</p><ul><li>Sidecar 容器的注入</li><li>iptables 规则的创建</li><li>路由的详细过程</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>productpage-v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>productpage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>productpage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>productpage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>serviceAccountName</span><span class=p>:</span><span class=w> </span><span class=l>bookinfo-productpage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>productpage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>docker.io/istio/examples-bookinfo-productpage-v1:1.15.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>9080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>tmp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/tmp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>tmp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>emptyDir</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>再查看下 <code>productpage</code> 容器的 <a href=https://github.com/istio/istio/blob/master/samples/bookinfo/src/productpage/Dockerfile target=_blank rel="external nofollow noopener noreferrer">Dockerfile</a>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-docker data-lang=docker><span class=line><span class=cl><span class=k>FROM</span><span class=s> python:3.7.4-slim</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> requirements.txt ./<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> pip install --no-cache-dir -r requirements.txt<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> test-requirements.txt ./<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> pip install --no-cache-dir -r test-requirements.txt<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> productpage.py /opt/microservices/<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> tests/unit/* /opt/microservices/<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> templates /opt/microservices/templates<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> static /opt/microservices/static<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> requirements.txt /opt/microservices/<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> flood_factor<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENV</span> FLOOD_FACTOR <span class=si>${</span><span class=nv>flood_factor</span><span class=k>:-</span><span class=nv>0</span><span class=si>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>EXPOSE</span><span class=s> 9080</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /opt/microservices</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> python -m unittest discover<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>USER</span><span class=s> 1</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>CMD</span> <span class=p>[</span><span class=s2>&#34;python&#34;</span><span class=p>,</span> <span class=s2>&#34;productpage.py&#34;</span><span class=p>,</span> <span class=s2>&#34;9080&#34;</span><span class=p>]</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>我们看到 <code>Dockerfile</code> 中没有配置 <code>ENTRYPOINT</code>，所以 <code>CMD</code> 的配置 <code>python productpage.py 9080</code> 将作为默认的 <code>ENTRYPOINT</code>，记住这一点，再看下注入 sidecar 之后的配置。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ istioctl kube-inject -f samples/bookinfo/platform/kube/bookinfo.yaml
</span></span></code></pre></td></tr></table></div></div><p>我们只截取其中与 <code>productpage</code> 相关的 <code>Deployment</code> 配置中的部分 YAML 配置。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>docker.io/istio/examples-bookinfo-productpage-v1:1.15.0</span><span class=w> </span><span class=c># 应用镜像</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>productpage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>9080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>sidecar</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>domain</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>$(POD_NAMESPACE).svc.cluster.local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>configPath</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>/etc/istio/proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>binaryPath</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>/usr/local/bin/envoy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>serviceCluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>productpage.$(POD_NAMESPACE)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>drainDuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>45s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>parentShutdownDuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>1m0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>discoveryAddress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>istiod.istio-system.svc:15012</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>zipkinAddress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>zipkin.istio-system:9411</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>proxyLogLevel=warning</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>proxyComponentLogLevel=misc:error</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>connectTimeout</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>proxyAdminPort</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;15000&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>concurrency</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;2&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>controlPlaneAuthPolicy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>NONE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>dnsRefreshRate</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>300s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>statusPort</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;15020&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>trust-domain=cluster.local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>controlPlaneBootstrap=false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>docker.io/istio/proxyv2:1.5.1</span><span class=w> </span><span class=c># sidecar proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>istio-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>15090</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>http-envoy-prom</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>initContainers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>istio-iptables</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- -<span class=l>p</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;15001&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- -<span class=l>z</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;15006&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- -<span class=l>u</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;1337&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- -<span class=l>m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>REDIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- -<span class=l>i</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s1>&#39;*&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- -<span class=l>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- -<span class=l>b</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s1>&#39;*&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- -<span class=l>d</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=m>15090</span><span class=p>,</span><span class=m>15020</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>docker.io/istio/proxyv2:1.5.1</span><span class=w> </span><span class=c># init 容器</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>istio-init</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Istio 给应用 Pod 注入的配置主要包括：</p><ul><li>Init 容器 <code>istio-init</code>：用于 pod 中设置 iptables 端口转发</li><li>Sidecar 容器 <code>istio-proxy</code>：运行 sidecar 代理，如 Envoy 或 MOSN。</li></ul><h2 id=iptables-规则注入解析>iptables 规则注入解析</h2><p>为了查看 iptables 配置，我们需要登陆到 sidecar 容器中使用 root 用户来查看，因为 <code>kubectl</code> 无法使用特权模式来远程操作 docker 容器，所以我们需要登陆到 <code>productpage</code> pod 所在的主机上使用 <code>docker</code> 命令登陆容器中查看。</p><p>如果您使用 minikube 部署的 Kubernetes，可以直接登录到 minikube 的虚拟机中并切换为 root 用户。查看 iptables 配置，列出 NAT（网络地址转换）表的所有规则，因为在 Init 容器启动的时候选择给 <code>istio-iptables</code> 传递的参数中指定将入站流量重定向到 sidecar 的模式为 <code>REDIRECT</code>，因此在 iptables 中将只有 NAT 表的规格配置，如果选择 <code>TPROXY</code> 还会有 <code>mangle</code> 表配置。<code>iptables</code> 命令的详细用法请参考 <a href=https://wangchujiang.com/linux-command/c/iptables.html target=_blank rel="external nofollow noopener noreferrer">iptables</a> 命令。</p><p>我们仅查看与 <code>productpage</code> 有关的 iptables 规则如下，因为这些规则是运行在该容器特定的网络空间下，因此需要使用 <code>nsenter</code> 命令进入其网络空间。进入的时候需要指定进程 ID（PID），因此首先我们需要找到 <code>productpage</code> 容器的 PID。对于在不同平台上安装的 Kubernetes，查找容器的方式会略有不同，例如在 GKE 上，执行 <code>docker ps -a</code> 命令是查看不到任何容器进程的。下面已 minikube 和 GKE 两个典型的平台为例，指导你如何进入容器的网络空间。</p><h3 id=在-minikube-中查看容器中的-iptabes-规则>在 minikube 中查看容器中的 iptabes 规则</h3><p>对于 minikube，因为所有的进程都运行在单个节点上，因此你只需要登录到 minikube 虚拟机，切换为 root 用户然后查找 <code>productpage</code> 进程即可，参考下面的步骤。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 进入 minikube 并切换为 root 用户，minikube 默认用户为 docker</span>
</span></span><span class=line><span class=cl>$ minikube ssh
</span></span><span class=line><span class=cl>$ sudo -i
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看 productpage pod 的 istio-proxy 容器中的进程</span>
</span></span><span class=line><span class=cl>$ docker top <span class=sb>`</span>docker ps<span class=p>|</span>grep <span class=s2>&#34;istio-proxy_productpage&#34;</span><span class=p>|</span>cut -d <span class=s2>&#34; &#34;</span> -f1<span class=sb>`</span>
</span></span><span class=line><span class=cl>UID                 PID                 PPID                C                   STIME               TTY                 TIME                CMD
</span></span><span class=line><span class=cl><span class=m>1337</span>                <span class=m>10576</span>               <span class=m>10517</span>               <span class=m>0</span>                   08:09               ?                   00:00:07            /usr/local/bin/pilot-agent proxy sidecar --domain default.svc.cluster.local --configPath /etc/istio/proxy --binaryPath /usr/local/bin/envoy --serviceCluster productpage.default --drainDuration 45s --parentShutdownDuration 1m0s --discoveryAddress istiod.istio-system.svc:15012 --zipkinAddress zipkin.istio-system:9411 --proxyLogLevel<span class=o>=</span>warning --proxyComponentLogLevel<span class=o>=</span>misc:error --connectTimeout 10s --proxyAdminPort <span class=m>15000</span> --concurrency <span class=m>2</span> --controlPlaneAuthPolicy NONE --dnsRefreshRate 300s --statusPort <span class=m>15020</span> --trust-domain<span class=o>=</span>cluster.local --controlPlaneBootstrap<span class=o>=</span><span class=nb>false</span>
</span></span><span class=line><span class=cl><span class=m>1337</span>                <span class=m>10660</span>               <span class=m>10576</span>               <span class=m>0</span>                   08:09               ?                   00:00:33            /usr/local/bin/envoy -c /etc/istio/proxy/envoy-rev0.json --restart-epoch <span class=m>0</span> --drain-time-s <span class=m>45</span> --parent-shutdown-time-s <span class=m>60</span> --service-cluster productpage.default --service-node sidecar~172.17.0.16~productpage-v1-7f44c4d57c-ksf9b.default~default.svc.cluster.local --max-obj-name-len <span class=m>189</span> --local-address-ip-version v4 --log-format <span class=o>[</span>Envoy <span class=o>(</span>Epoch 0<span class=o>)]</span> <span class=o>[</span>%Y-%m-%d %T.%e<span class=o>][</span>%t<span class=o>][</span>%l<span class=o>][</span>%n<span class=o>]</span> %v -l warning --component-log-level misc:error --concurrency <span class=m>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用 nsenter 进入 sidecar 容器的命名空间（以上任何一个都可以）</span>
</span></span><span class=line><span class=cl>$ nsenter -n --target <span class=m>10660</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看 NAT 表中规则配置的详细信息。</span>
</span></span><span class=line><span class=cl>$ iptables -t nat -L
</span></span></code></pre></td></tr></table></div></div><h3 id=在-gke-中查看容器的-iptables-规则>在 GKE 中查看容器的 iptables 规则</h3><p>如果你在 GKE 中安装的多节点的 Kubernetes 集群，首先你需要确定这个 Pod 运行在哪个节点上，然后登陆到那台主机，使用下面的命令查找进程的 PID，你会得到类似下面的输出。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ ps aux<span class=p>|</span>grep <span class=s2>&#34;productpage&#34;</span>
</span></span><span class=line><span class=cl>chronos     <span class=m>4268</span>  0.0  0.6  <span class=m>43796</span> <span class=m>24856</span> ?        Ss   Apr22   0:00 python productpage.py <span class=m>9080</span>
</span></span><span class=line><span class=cl>chronos     <span class=m>4329</span>  0.9  0.6 <span class=m>117524</span> <span class=m>24616</span> ?        Sl   Apr22  13:43 /usr/local/bin/python /opt/microservices/productpage.py <span class=m>9080</span>
</span></span><span class=line><span class=cl>root      <span class=m>361903</span>  0.0  0.0   <span class=m>4536</span>   <span class=m>812</span> pts/0    S+   01:54   0:00 grep --colour<span class=o>=</span>auto productpage
</span></span></code></pre></td></tr></table></div></div><p>然后在终端中输出 <code>iptables -t nat -L</code> 即可查看 iptables 规则。</p><h2 id=iptables-流量劫持过程详解>iptables 流量劫持过程详解</h2><p>经过上面的步骤，你已经可以查看到 init 容器向 Pod 中注入的 iptables 规则，如下所示。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># PREROUTING 链：用于目标地址转换（DNAT），将所有入站 TCP 流量跳转到 ISTIO_INBOUND 链上。</span>
</span></span><span class=line><span class=cl>Chain PREROUTING <span class=o>(</span>policy ACCEPT <span class=m>2701</span> packets, 162K bytes<span class=o>)</span>
</span></span><span class=line><span class=cl> pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination
</span></span><span class=line><span class=cl> <span class=m>2701</span>  162K ISTIO_INBOUND  tcp  --  any    any     anywhere             anywhere
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># INPUT 链：处理输入数据包，非 TCP 流量将继续 OUTPUT 链。</span>
</span></span><span class=line><span class=cl>Chain INPUT <span class=o>(</span>policy ACCEPT <span class=m>2701</span> packets, 162K bytes<span class=o>)</span>
</span></span><span class=line><span class=cl> pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># OUTPUT 链：将所有出站数据包跳转到 ISTIO_OUTPUT 链上。</span>
</span></span><span class=line><span class=cl>Chain OUTPUT <span class=o>(</span>policy ACCEPT <span class=m>79</span> packets, <span class=m>6761</span> bytes<span class=o>)</span>
</span></span><span class=line><span class=cl> pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination
</span></span><span class=line><span class=cl>   <span class=m>15</span>   <span class=m>900</span> ISTIO_OUTPUT  tcp  --  any    any     anywhere             anywhere
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># POSTROUTING 链：所有数据包流出网卡时都要先进入 POSTROUTING 链，内核根据数据包目的地判断是否需要转发出去，我们看到此处未做任何处理。</span>
</span></span><span class=line><span class=cl>Chain POSTROUTING <span class=o>(</span>policy ACCEPT <span class=m>79</span> packets, <span class=m>6761</span> bytes<span class=o>)</span>
</span></span><span class=line><span class=cl> pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ISTIO_INBOUND 链：将所有入站流量重定向到 ISTIO_IN_REDIRECT 链上。目的地为 15090（Prometheus 使用）和 15020（Ingress gateway 使用，用于 Pilot 健康检查）端口的流量除外，发送到以上两个端口的流量将返回 iptables 规则链的调用点，即 PREROUTING 链的后继 POSTROUTING 后直接调用原始目的地。</span>
</span></span><span class=line><span class=cl>Chain ISTIO_INBOUND <span class=o>(</span><span class=m>1</span> references<span class=o>)</span>
</span></span><span class=line><span class=cl> pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination
</span></span><span class=line><span class=cl>    <span class=m>0</span>     <span class=m>0</span> RETURN     tcp  --  any    any     anywhere             anywhere             tcp dpt:ssh
</span></span><span class=line><span class=cl>    <span class=m>2</span>   <span class=m>120</span> RETURN     tcp  --  any    any     anywhere             anywhere             tcp dpt:15090
</span></span><span class=line><span class=cl> <span class=m>2699</span>  162K RETURN     tcp  --  any    any     anywhere             anywhere             tcp dpt:15020
</span></span><span class=line><span class=cl>    <span class=m>0</span>     <span class=m>0</span> ISTIO_IN_REDIRECT  tcp  --  any    any     anywhere             anywhere
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ISTIO_IN_REDIRECT 链：将所有的入站流量跳转到本地的 15006 端口，至此成功的拦截了流量到 sidecar 代理的 Inbound Handler 中。</span>
</span></span><span class=line><span class=cl>Chain ISTIO_IN_REDIRECT <span class=o>(</span><span class=m>3</span> references<span class=o>)</span>
</span></span><span class=line><span class=cl> pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination
</span></span><span class=line><span class=cl>    <span class=m>0</span>     <span class=m>0</span> REDIRECT   tcp  --  any    any     anywhere             anywhere             redir ports <span class=m>15006</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ISTIO_OUTPUT 链：规则比较复杂，将在下文解释</span>
</span></span><span class=line><span class=cl>Chain ISTIO_OUTPUT <span class=o>(</span><span class=m>1</span> references<span class=o>)</span>
</span></span><span class=line><span class=cl> pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination
</span></span><span class=line><span class=cl>    <span class=m>0</span>     <span class=m>0</span> RETURN     all  --  any    lo      127.0.0.6            anywhere <span class=c1>#规则1</span>
</span></span><span class=line><span class=cl>    <span class=m>0</span>     <span class=m>0</span> ISTIO_IN_REDIRECT  all  --  any    lo      anywhere            !localhost            owner UID match <span class=m>1337</span> <span class=c1>#规则2</span>
</span></span><span class=line><span class=cl>    <span class=m>0</span>     <span class=m>0</span> RETURN     all  --  any    lo      anywhere             anywhere             ! owner UID match <span class=m>1337</span> <span class=c1>#规则3</span>
</span></span><span class=line><span class=cl>   <span class=m>15</span>   <span class=m>900</span> RETURN     all  --  any    any     anywhere             anywhere             owner UID match <span class=m>1337</span> <span class=c1>#规则4</span>
</span></span><span class=line><span class=cl>    <span class=m>0</span>     <span class=m>0</span> ISTIO_IN_REDIRECT  all  --  any    lo      anywhere            !localhost            owner GID match <span class=m>1337</span> <span class=c1>#规则5</span>
</span></span><span class=line><span class=cl>    <span class=m>0</span>     <span class=m>0</span> RETURN     all  --  any    lo      anywhere             anywhere             ! owner GID match <span class=m>1337</span> <span class=c1>#规则6</span>
</span></span><span class=line><span class=cl>    <span class=m>0</span>     <span class=m>0</span> RETURN     all  --  any    any     anywhere             anywhere             owner GID match <span class=m>1337</span> <span class=c1>#规则7</span>
</span></span><span class=line><span class=cl>    <span class=m>0</span>     <span class=m>0</span> RETURN     all  --  any    any     anywhere             localhost <span class=c1>#规则8</span>
</span></span><span class=line><span class=cl>    <span class=m>0</span>     <span class=m>0</span> ISTIO_REDIRECT  all  --  any    any     anywhere             anywhere <span class=c1>#规则9</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ISTIO_REDIRECT 链：将所有流量重定向到 Envoy 代理的 15001 端口。</span>
</span></span><span class=line><span class=cl>Chain ISTIO_REDIRECT <span class=o>(</span><span class=m>1</span> references<span class=o>)</span>
</span></span><span class=line><span class=cl> pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination
</span></span><span class=line><span class=cl>    <span class=m>0</span>     <span class=m>0</span> REDIRECT   tcp  --  any    any     anywhere             anywhere             redir ports <span class=m>15001</span>
</span></span></code></pre></td></tr></table></div></div><p>这里着重需要解释的是 <code>ISTIO_OUTPUT</code> 链中的 9 条规则，为了便于阅读，我将以上规则中的部分内容使用表格的形式来展示如下：</p><table><thead><tr><th><strong>规则</strong></th><th><strong>target</strong></th><th><strong>in</strong></th><th><strong>out</strong></th><th><strong>source</strong></th><th><strong>destination</strong></th></tr></thead><tbody><tr><td>1</td><td>RETURN</td><td>any</td><td>lo</td><td>127.0.0.6</td><td>anywhere</td></tr><tr><td>2</td><td>ISTIO_IN_REDIRECT</td><td>any</td><td>lo</td><td>anywhere</td><td>!localhost owner UID match 1337</td></tr><tr><td>3</td><td>RETURN</td><td>any</td><td>lo</td><td>anywhere</td><td>anywhere !owner UID match 1337</td></tr><tr><td>4</td><td>RETURN</td><td>any</td><td>any</td><td>anywhere</td><td>anywhere owner UID match 1337</td></tr><tr><td>5</td><td>ISTIO_IN_REDIRECT</td><td>any</td><td>lo</td><td>anywhere</td><td>!localhost owner GID match 1337</td></tr><tr><td>6</td><td>RETURN</td><td>any</td><td>lo</td><td>anywhere</td><td>anywhere !owner GID match 1337</td></tr><tr><td>7</td><td>RETURN</td><td>any</td><td>any</td><td>anywhere</td><td>anywhere owner GID match 1337</td></tr><tr><td>8</td><td>RETURN</td><td>any</td><td>any</td><td>anywhere</td><td>localhost</td></tr><tr><td>9</td><td>ISTIO_REDIRECT</td><td>any</td><td>any</td><td>anywhere</td><td>anywhere</td></tr></tbody></table><p>下图展示了 <code>ISTIO_ROUTE</code> 规则的详细流程。</p><p><img class=lazyload src=/sre/svg/loading.min.svg data-src=https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913144557.png data-srcset="https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913144557.png, https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913144557.png 1.5x, https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913144557.png 2x" data-sizes=auto alt=https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913144557.png title=https://raw.githubusercontent.com/kbsonlong/notes_statics/master/images/20220913144557.png></p><p>我将按照规则的出现顺序来解释每条规则的目的、对应文章开头图示中的步骤及详情。其中规则 5、6、7 是分别对规则 2、3、4 的应用范围扩大（从 UID 扩大为 GID），作用是类似的，将合并解释。注意，其中的规则是按顺序执行的，也就是说排序越靠后的规则将作为默认值。出站网卡（out）为 <code>lo</code> （本地回环地址，loopback 接口）时，表示流量的目的地是本地 Pod，对于 Pod 向外部发送的流量就不会经过这个接口。所有 <code>review</code> Pod 的出站流量只适用于规则 4、7、8、9。</p><p><strong>规则 1</strong></p><ul><li>目的：<strong>透传</strong> Envoy 代理发送到本地应用容器的流量，使其绕过 Envoy 代理，直达应用容器。</li><li>对应图示中的步骤：6 到 7。</li><li>详情：该规则使得所有来自 <code>127.0.0.6</code>（该 IP 地址将在下文解释） 的请求，跳出该链，返回 iptables 的调用点（即 <code>OUTPUT</code>）后继续执行其余路由规则，即 <code>POSTROUTING</code> 规则，把流量发送到任意目的地址，如本地 Pod 内的应用容器。如果没有这条规则，由 Pod 内 Envoy 代理发出的对 Pod 内容器访问的流量将会执行下一条规则，即规则 2，流量将再次进入到了 Inbound Handler 中，从而形成了死循环。将这条规则放在第一位可以避免流量在 Inbound Handler 中死循环的问题。</li></ul><p><strong>规则 2、5</strong></p><ul><li>目的：处理 Envoy 代理发出的站内流量（Pod 内部的流量），但不是对 localhost 的请求，通过后续规则将其转发给 Envoy 代理的 Inbound Handler。该规则适用于 Pod 对自身 IP 地址调用的场景，即 Pod 内服务之间的访问。</li><li>详情：如果流量的目的地非 localhost，且数据包是由 1337 UID（即 <code>istio-proxy</code> 用户，Envoy 代理）发出的，流量将被经过 <code>ISTIO_IN_REDIRECT</code> 最终转发到 Envoy 的 Inbound Handler。</li></ul><p><strong>规则 3、6</strong></p><ul><li>目的：<strong>透传</strong> Pod 内的应用容器的站内流量。该规则适用于容器内部的流量。例如在 Pod 内对 Pod IP 或 localhost 的访问。</li><li>对应图示中的步骤：6 到 7。</li><li>详情：如果流量不是由 Envoy 用户发出的，那么就跳出该链，返回 <code>OUTPUT</code> 调用 <code>POSTROUTING</code>，直达目的地。</li></ul><p><strong>规则 4、7</strong></p><ul><li>目的：<strong>透传</strong> Envoy 代理发出的出站请求。</li><li>对应图示中的步骤：14 到 15。</li><li>详情：如果请求是由 Envoy 代理发出的，则返回 <code>OUTPUT</code> 继续调用 <code>POSTROUTING</code> 规则，最终直接访问目的地。</li></ul><p><strong>规则 8</strong></p><ul><li>目的：<strong>透传</strong> Pod 内部对 localhost 的请求。</li><li>详情：如果请求的目的地是 localhost，则返回 OUTPUT 调用 <code>POSTROUTING</code>，直接访问 localhost。</li></ul><p><strong>规则 9</strong></p><ul><li>目的：所有其他的流量将被转发到 <code>ISTIO_REDIRECT</code> 后，最终达到 Envoy 代理的 Outbound Handler。</li><li>对应图示中的步骤：10 到 11。</li></ul><p>以上规则避免了 Envoy 代理到应用程序的路由在 iptables 规则中的死循环，保障了流量可以被正确的路由到 Envoy 代理上，也可以发出真正的出站请求。</p><p><strong>关于 RETURN target</strong></p><p>你可能留意到上述规则中有很多 RETURN target，它的意思是，指定到这条规则时，跳出该规则链，返回 iptables 的调用点（在我们的例子中即 <code>OUTPUT</code>）后继续执行其余路由规则，在我们的例子中即 <code>POSTROUTING</code> 规则，把流量发送到任意目的地址，你可以把它直观的理解为<strong>透传</strong>。</p><p><strong>关于 127.0.0.6 IP 地址</strong></p><p>127.0.0.6 这个 IP 是 Istio 中默认的 <code>InboundPassthroughClusterIpv4</code>，在 Istio 的代码中指定。即流量在进入 Envoy 代理后被绑定的 IP 地址，作用是让 Outbound 流量重新发送到 Pod 中的应用容器，即 <strong>Passthought（透传），绕过 Outbound Handler</strong>。该流量是对 Pod 自身的访问，而不是真正的对外流量。至于为什么选择这个 IP 作为流量透传，请参考 <a href=https://github.com/istio/istio/issues/29603 target=_blank rel="external nofollow noopener noreferrer">Istio Issue-29603</a>。</p><h2 id=流量路由过程详解>流量路由过程详解</h2><p>通过上文，你已经了解了 Istio 是如何在 Pod 中做透明流量劫持的，那么流量被劫持到 Envoy 代理中之后是如何被处理的呢？流量路由分为 Inbound 和 Outbound 两个过程，下面将根据上文中的示例及 sidecar 的配置为读者详细分析此过程。</p><h3 id=理解-inbound-handler>理解 Inbound Handler</h3><p>Inbound Handler 的作用是将 iptables 拦截到的 downstream 的流量转发给 Pod 内的应用程序容器。在我们的实例中，假设其中一个 Pod 的名字是 <code>reviews-v1-545db77b95-jkgv2</code>，运行 <code>istioctl proxy-config listener reviews-v1-545db77b95-jkgv2 --port 15006</code> 查看该 Pod 中 15006 端口上的监听器情况 ，你将看到下面的输出。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=na>ADDRESS PORT  MATCH                                                                                           DESTINATION</span>
</span></span><span class=line><span class=cl><span class=na>0.0.0.0 15006 Addr: *:15006                                                                                   Non-HTTP/Non-TCP</span>
</span></span><span class=line><span class=cl><span class=na>0.0.0.0 15006 Trans: tls; App: istio-http/1.0,istio-http/1.1,istio-h2; Addr: 0.0.0.0/0                        InboundPassthroughClusterIpv4</span>
</span></span><span class=line><span class=cl><span class=na>0.0.0.0 15006 Trans: raw_buffer; App: http/1.1,h2c; Addr: 0.0.0.0/0                                           InboundPassthroughClusterIpv4</span>
</span></span><span class=line><span class=cl><span class=na>0.0.0.0 15006 Trans: tls; App: TCP TLS; Addr: 0.0.0.0/0                                                       InboundPassthroughClusterIpv4</span>
</span></span><span class=line><span class=cl><span class=na>0.0.0.0 15006 Trans: raw_buffer; Addr: 0.0.0.0/0                                                              InboundPassthroughClusterIpv4</span>
</span></span><span class=line><span class=cl><span class=na>0.0.0.0 15006 Trans: tls; Addr: 0.0.0.0/0                                                                     InboundPassthroughClusterIpv4</span>
</span></span><span class=line><span class=cl><span class=na>0.0.0.0 15006 Trans: tls; App: istio,istio-peer-exchange,istio-http/1.0,istio-http/1.1,istio-h2; Addr: *:9080 Cluster: inbound|9080||</span>
</span></span><span class=line><span class=cl><span class=na>0.0.0.0 15006 Trans: raw_buffer; Addr: *:9080                                                                 Cluster: inbound|9080||</span>
</span></span></code></pre></td></tr></table></div></div><p>下面列出了以上输出中各字段的含义：</p><ul><li>ADDRESS：下游地址</li><li>PORT：Envoy 监听器监听的端口</li><li>MATCH：请求使用的传输协议或匹配的下游地址</li><li>DESTINATION：路由目的地</li></ul><p><code>reviews</code> Pod 中的 Iptables 将入站流量劫持到 15006 端口上，从上面的输出我们可以看到 Envoy 的 Inbound Handler 在 15006 端口上监听，对目的地为任何 IP 的 9080 端口的请求将路由到 <code>inbound|9080||</code> Cluster 上。</p><p>从该 Pod 的 Listener 列表的最后两行中可以看到，<code>0.0.0.0:15006/TCP</code> 的 Listener（其实际名字是 <code>virtualInbound</code>）监听所有的 Inbound 流量，其中包含了匹配规则，来自任意 IP 的对 <code>9080</code> 端口的访问流量，将会路由到 <code>inbound|9080||</code> Cluster，如果你想以 Json 格式查看该 Listener 的详细配置，可以执行 <code>istioctl proxy-config listeners reviews-v1-545db77b95-jkgv2 --port 15006 -o json</code> 命令，你将获得类似下面的输出。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=err>/*省略部分内容*/</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;virtualInbound&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;address&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;socketAddress&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;address&#34;</span><span class=p>:</span> <span class=s2>&#34;0.0.0.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;portValue&#34;</span><span class=p>:</span> <span class=mi>15006</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;filterChains&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=err>/*省略部分内容*/</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;filterChainMatch&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;destinationPort&#34;</span><span class=p>:</span> <span class=mi>9080</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;transportProtocol&#34;</span><span class=p>:</span> <span class=s2>&#34;tls&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;applicationProtocols&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;istio&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;istio-peer-exchange&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;istio-http/1.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;istio-http/1.1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;istio-h2&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=p>},</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;filters&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                    <span class=err>/*省略部分内容*/</span>
</span></span><span class=line><span class=cl>                    <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;envoy.filters.network.http_connection_manager&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=nt>&#34;typedConfig&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=nt>&#34;@type&#34;</span><span class=p>:</span> <span class=s2>&#34;type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                            <span class=nt>&#34;statPrefix&#34;</span><span class=p>:</span> <span class=s2>&#34;inbound_0.0.0.0_9080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                            <span class=nt>&#34;routeConfig&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;inbound|9080||&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                <span class=nt>&#34;virtualHosts&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                                    <span class=p>{</span>
</span></span><span class=line><span class=cl>                                        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;inbound|http|9080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                        <span class=nt>&#34;domains&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                                            <span class=s2>&#34;*&#34;</span>
</span></span><span class=line><span class=cl>                                        <span class=p>],</span>
</span></span><span class=line><span class=cl>                                        <span class=nt>&#34;routes&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                                            <span class=p>{</span>
</span></span><span class=line><span class=cl>                                                <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;default&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                <span class=nt>&#34;match&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                                    <span class=nt>&#34;prefix&#34;</span><span class=p>:</span> <span class=s2>&#34;/&#34;</span>
</span></span><span class=line><span class=cl>                                                <span class=p>},</span>
</span></span><span class=line><span class=cl>                                                <span class=nt>&#34;route&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                                    <span class=nt>&#34;cluster&#34;</span><span class=p>:</span> <span class=s2>&#34;inbound|9080||&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                    <span class=nt>&#34;timeout&#34;</span><span class=p>:</span> <span class=s2>&#34;0s&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                    <span class=nt>&#34;maxStreamDuration&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                                        <span class=nt>&#34;maxStreamDuration&#34;</span><span class=p>:</span> <span class=s2>&#34;0s&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                        <span class=nt>&#34;grpcTimeoutHeaderMax&#34;</span><span class=p>:</span> <span class=s2>&#34;0s&#34;</span>
</span></span><span class=line><span class=cl>                                                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                                                <span class=p>},</span>
</span></span><span class=line><span class=cl>                                                <span class=nt>&#34;decorator&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                                    <span class=nt>&#34;operation&#34;</span><span class=p>:</span> <span class=s2>&#34;reviews.default.svc.cluster.local:9080/*&#34;</span>
</span></span><span class=line><span class=cl>                                                <span class=p>}</span>
</span></span><span class=line><span class=cl>                                            <span class=p>}</span>
</span></span><span class=line><span class=cl>                                        <span class=p>]</span>
</span></span><span class=line><span class=cl>                                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                                <span class=p>],</span>
</span></span><span class=line><span class=cl>                                <span class=nt>&#34;validateClusters&#34;</span><span class=p>:</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>                            <span class=p>},</span>
</span></span><span class=line><span class=cl>                            <span class=err>/*省略部分内容*/</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=err>/*省略部分内容*/</span>
</span></span><span class=line><span class=cl>        <span class=err>],</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;listenerFilters&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=err>/*省略部分内容*/</span>
</span></span><span class=line><span class=cl>        <span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;listenerFiltersTimeout&#34;</span><span class=p>:</span> <span class=s2>&#34;0s&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;continueOnListenerFiltersTimeout&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;trafficDirection&#34;</span><span class=p>:</span> <span class=s2>&#34;INBOUND&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><p>既然 Inbound Handler 的流量中将来自任意地址的对该 Pod <code>9080</code> 端口的流量路由到 <code>inbound|9080||</code> Cluster，那么我们运行 <code>istioctl pc cluster reviews-v1-545db77b95-jkgv2 --port 9080 --direction inbound -o json</code> 查看下该 Cluster 配置，你将获得类似下面的输出。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;inbound|9080||&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;ORIGINAL_DST&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;connectTimeout&#34;</span><span class=p>:</span> <span class=s2>&#34;10s&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;lbPolicy&#34;</span><span class=p>:</span> <span class=s2>&#34;CLUSTER_PROVIDED&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;circuitBreakers&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;thresholds&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;maxConnections&#34;</span><span class=p>:</span> <span class=mi>4294967295</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;maxPendingRequests&#34;</span><span class=p>:</span> <span class=mi>4294967295</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;maxRequests&#34;</span><span class=p>:</span> <span class=mi>4294967295</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;maxRetries&#34;</span><span class=p>:</span> <span class=mi>4294967295</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;trackRemaining&#34;</span><span class=p>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;cleanupInterval&#34;</span><span class=p>:</span> <span class=s2>&#34;60s&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;upstreamBindConfig&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;sourceAddress&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;address&#34;</span><span class=p>:</span> <span class=s2>&#34;127.0.0.6&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;portValue&#34;</span><span class=p>:</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;metadata&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;filterMetadata&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;istio&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;services&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                        <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=nt>&#34;host&#34;</span><span class=p>:</span> <span class=s2>&#34;reviews.default.svc.cluster.local&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                            <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;reviews&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                            <span class=nt>&#34;namespace&#34;</span><span class=p>:</span> <span class=s2>&#34;default&#34;</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span>
</span></span><span class=line><span class=cl>                    <span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><p>我们看其中的 <code>TYPE</code> 为 <code>ORIGINAL_DST</code>，将流量发送到原始目标地址（Pod IP），因为原始目标地址即当前 Pod，你还应该注意到 <code>upstreamBindConfig.sourceAddress.address</code> 的值被改写为了 <code>127.0.0.6</code>，而且对于 Pod 内流量是通过 <code>lo</code> 网卡发送的，这刚好呼应了上文中的 iptables <code>ISTIO_OUTPUT</code> 链中的第一条规则，根据该规则，流量将被透传到 Pod 内的应用容器。</p><h3 id=理解-outbound-handler>理解 Outbound Handler</h3><p>在本示例中 <code>reviews</code> 会向 <code>ratings</code> 服务发送 HTTP 请求，请求的地址是：<code>http://ratings.default.svc.cluster.local:9080/</code>，Outbound Handler 的作用是将 iptables 拦截到的本地应用程序向外发出的流量，经由 Envoy 代理路由到上游。</p><p>Envoy 监听在 15001 端口上监听所有 Outbound 流量，Outbound Handler 处理，然后经过 <code>virtualOutbound</code> Listener、<code>0.0.0.0_9080</code> Listener，然后通过 Route 9080 找到上游的 cluster，进而通过 EDS 找到 Endpoint 执行路由动作。</p><p><strong><code>ratings.default.svc.cluster.local:9080</code> 路由</strong></p><p>运行 <code>istioctl proxy-config routes reviews-v1-545db77b95-jkgv2 --name 9080 -o json</code> 查看 route 配置，因为 sidecar 会根据 HTTP header 中的 domains 来匹配 VirtualHost，所以下面只列举了 <code>ratings.default.svc.cluster.local:9080</code> 这一个 VirtualHost。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>[</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;9080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;virtualHosts&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>       <span class=p>{</span>
</span></span><span class=line><span class=cl>           <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;ratings.default.svc.cluster.local:9080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>           <span class=nt>&#34;domains&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>               <span class=s2>&#34;ratings.default.svc.cluster.local&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>               <span class=s2>&#34;ratings.default.svc.cluster.local:9080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>               <span class=s2>&#34;ratings&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>               <span class=s2>&#34;ratings:9080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>               <span class=s2>&#34;ratings.default.svc&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>               <span class=s2>&#34;ratings.default.svc:9080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>               <span class=s2>&#34;ratings.default&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>               <span class=s2>&#34;ratings.default:9080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>               <span class=s2>&#34;10.8.8.106&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>               <span class=s2>&#34;10.8.8.106:9080&#34;</span>
</span></span><span class=line><span class=cl>           <span class=p>],</span>
</span></span><span class=line><span class=cl>           <span class=nt>&#34;routes&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>               <span class=p>{</span>
</span></span><span class=line><span class=cl>                   <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;default&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                   <span class=nt>&#34;match&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                       <span class=nt>&#34;prefix&#34;</span><span class=p>:</span> <span class=s2>&#34;/&#34;</span>
</span></span><span class=line><span class=cl>                   <span class=p>},</span>
</span></span><span class=line><span class=cl>                   <span class=nt>&#34;route&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                       <span class=nt>&#34;cluster&#34;</span><span class=p>:</span> <span class=s2>&#34;outbound|9080||ratings.default.svc.cluster.local&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                       <span class=nt>&#34;timeout&#34;</span><span class=p>:</span> <span class=s2>&#34;0s&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                       <span class=nt>&#34;retryPolicy&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                           <span class=nt>&#34;retryOn&#34;</span><span class=p>:</span> <span class=s2>&#34;connect-failure,refused-stream,unavailable,cancelled,retriable-status-codes&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                           <span class=nt>&#34;numRetries&#34;</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                           <span class=nt>&#34;retryHostPredicate&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                               <span class=p>{</span>
</span></span><span class=line><span class=cl>                                   <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;envoy.retry_host_predicates.previous_hosts&#34;</span>
</span></span><span class=line><span class=cl>                               <span class=p>}</span>
</span></span><span class=line><span class=cl>                           <span class=p>],</span>
</span></span><span class=line><span class=cl>                           <span class=nt>&#34;hostSelectionRetryMaxAttempts&#34;</span><span class=p>:</span> <span class=s2>&#34;5&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                           <span class=nt>&#34;retriableStatusCodes&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                               <span class=mi>503</span>
</span></span><span class=line><span class=cl>                           <span class=p>]</span>
</span></span><span class=line><span class=cl>                       <span class=p>},</span>
</span></span><span class=line><span class=cl>                       <span class=nt>&#34;maxStreamDuration&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                           <span class=nt>&#34;maxStreamDuration&#34;</span><span class=p>:</span> <span class=s2>&#34;0s&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                           <span class=nt>&#34;grpcTimeoutHeaderMax&#34;</span><span class=p>:</span> <span class=s2>&#34;0s&#34;</span>
</span></span><span class=line><span class=cl>                       <span class=p>}</span>
</span></span><span class=line><span class=cl>                   <span class=p>},</span>
</span></span><span class=line><span class=cl>                   <span class=nt>&#34;decorator&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                       <span class=nt>&#34;operation&#34;</span><span class=p>:</span> <span class=s2>&#34;ratings.default.svc.cluster.local:9080/*&#34;</span>
</span></span><span class=line><span class=cl>                   <span class=p>}</span>
</span></span><span class=line><span class=cl>               <span class=p>}</span>
</span></span><span class=line><span class=cl>           <span class=p>],</span>
</span></span><span class=line><span class=cl>           <span class=nt>&#34;includeRequestAttemptCount&#34;</span><span class=p>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>       <span class=p>},</span>
</span></span><span class=line><span class=cl>       <span class=err>/*省略部分内容*/</span>
</span></span><span class=line><span class=cl>     <span class=p>],</span>
</span></span><span class=line><span class=cl>     <span class=nt>&#34;validateClusters&#34;</span><span class=p>:</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><p>从该 Virtual Host 配置中可以看到将流量路由到<code>outbound|9080||ratings.default.svc.cluster.local</code> 集群。</p><p><strong><code>outbound|9080||ratings.default.svc.cluster.local</code> 集群的端点</strong></p><p>运行 <code>istioctl proxy-config endpoint reviews-v1-545db77b95-jkgv2 --port 9080 -o json --cluster "outbound|9080||ratings.default.svc.cluster.local"</code> 查看集群的 Endpoint 配置，结果如下。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;outbound|9080||ratings.default.svc.cluster.local&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;addedViaApi&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;hostStatuses&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;address&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;socketAddress&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=nt>&#34;address&#34;</span><span class=p>:</span> <span class=s2>&#34;10.4.1.12&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=nt>&#34;portValue&#34;</span><span class=p>:</span> <span class=mi>9080</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>},</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;stats&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                    <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;cx_connect_fail&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=p>},</span>
</span></span><span class=line><span class=cl>                    <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;cx_total&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=p>},</span>
</span></span><span class=line><span class=cl>                    <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;rq_error&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=p>},</span>
</span></span><span class=line><span class=cl>                    <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;rq_success&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=p>},</span>
</span></span><span class=line><span class=cl>                    <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;rq_timeout&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=p>},</span>
</span></span><span class=line><span class=cl>                    <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;rq_total&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=p>},</span>
</span></span><span class=line><span class=cl>                    <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;GAUGE&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;cx_active&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=p>},</span>
</span></span><span class=line><span class=cl>                    <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;GAUGE&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;rq_active&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;healthStatus&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;edsHealthStatus&#34;</span><span class=p>:</span> <span class=s2>&#34;HEALTHY&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>},</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;weight&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;locality&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;region&#34;</span><span class=p>:</span> <span class=s2>&#34;us-west2&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;zone&#34;</span><span class=p>:</span> <span class=s2>&#34;us-west2-a&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;circuitBreakers&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;thresholds&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;maxConnections&#34;</span><span class=p>:</span> <span class=mi>4294967295</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;maxPendingRequests&#34;</span><span class=p>:</span> <span class=mi>4294967295</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;maxRequests&#34;</span><span class=p>:</span> <span class=mi>4294967295</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;maxRetries&#34;</span><span class=p>:</span> <span class=mi>4294967295</span>
</span></span><span class=line><span class=cl>                <span class=p>},</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;priority&#34;</span><span class=p>:</span> <span class=s2>&#34;HIGH&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;maxConnections&#34;</span><span class=p>:</span> <span class=mi>1024</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;maxPendingRequests&#34;</span><span class=p>:</span> <span class=mi>1024</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;maxRequests&#34;</span><span class=p>:</span> <span class=mi>1024</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;maxRetries&#34;</span><span class=p>:</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;observabilityName&#34;</span><span class=p>:</span> <span class=s2>&#34;outbound|9080||ratings.default.svc.cluster.local&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><p>我们看到端点的地址是 <code>10.4.1.12</code>。实际上，Endpoint 可以是一个或多个，sidecar 将根据一定规则选择适当的 Endpoint 来路由。至此 <code>review</code> Pod找到了它上游服务 <code>rating</code> 的 Endpoint。</p><h2 id=小结>小结</h2><p>本文使用了 Istio 官方提供的 bookinfo 示例，按图索骥得带领读者了解了 sidecar 注入、iptables 透明流量劫持及 sidecar 中流量路由背后的实现细节。Sidecar 模式和流量透明劫持是 Istio 服务网格的特色和基础功能，理解该功能的背后过程及实现细节，将有助于大家理解 Service Mesh 的原理和 <a href=https://www.servicemesher.com/istio-handbook/ target=_blank rel="external nofollow noopener noreferrer">Istio Handbook</a> 后面章节中的内容，因此希望读者可以在自己的环境中从头来试验一遍以加深理解。</p><p>使用 iptables 做流量劫持只是 service mesh 的数据平面中做流量劫持的方式之一，还有更多的流量劫持方案，下面引用自 <a href=https://mosn.io/docs/products/structure/traffic-hijack/ target=_blank rel="external nofollow noopener noreferrer">云原生网络代理 MOSN 官网中给出的流量劫持</a>部分的描述。</p><h3 id=使用-iptables-做流量劫持时存在的问题>使用 iptables 做流量劫持时存在的问题</h3><p>目前 Istio 使用 iptables 实现透明劫持，主要存在以下三个问题：</p><ol><li>需要借助于 conntrack 模块实现连接跟踪，在连接数较多的情况下，会造成较大的消耗，同时可能会造成 track 表满的情况，为了避免这个问题，业内有关闭 conntrack 的做法。</li><li>iptables 属于常用模块，全局生效，不能显式的禁止相关联的修改，可管控性比较差。</li><li>iptables 重定向流量本质上是通过 loopback 交换数据，outbond 流量将两次穿越协议栈，在大并发场景下会损失转发性能。</li></ol><p>上述几个问题并非在所有场景中都存在，比方说某些场景下，连接数并不多，且 NAT 表未被使用到的情况下，iptables 是一个满足要求的简单方案。为了适配更加广泛的场景，透明劫持需要解决上述三个问题。</p><h3 id=透明劫持方案优化>透明劫持方案优化</h3><p>为了优化 Istio 中的透明流量劫持的性能，业界提出了以下方案。</p><p><strong>使用 Merbridge 开源项目利用 eBPF 劫持流量</strong></p><p><a href=https://github.com/merbridge/merbridge target=_blank rel="external nofollow noopener noreferrer">Merbridge</a> 是由 DaoCloud 在 2022 年初开源的的一款利用 eBPF 加速 Istio 服务网格的插件。使用 Merbridge 可以在一定程度上优化数据平面的网络性能。</p><p>Merbridge 利用 eBPF 的 <code>sockops</code> 和 <code>redir</code> 能力，可以直接将数据包从 inbound socket 传输到 outbound socket。eBPF 提供了 <code>bpf_msg_redirect_hash</code> 函数可以直接转发应用程序的数据包。</p><p>详见 <a href=https://jimmysong.io/istio-handbook/ecosystem/merbridge.html target=_blank rel="external nofollow noopener noreferrer">Istio 服务网格 —— 云原生应用网络构建指南</a>。</p><p><strong>使用 tproxy 处理 inbound 流量</strong></p><p>tproxy 可以用于 inbound 流量的重定向，且无需改变报文中的目的 IP/端口，不需要执行连接跟踪，不会出现 conntrack 模块创建大量连接的问题。受限于内核版本，tproxy 应用于 outbound 存在一定缺陷。目前 Istio 支持通过 tproxy 处理 inbound 流量。</p><p><strong>使用 hook connect 处理 outbound 流量</strong></p><p>为了适配更多应用场景，outbound 方向通过 hook connect 来实现，实现原理如下：</p><figure><img src=hook-connect.svg alt="hook-connect 原理示意图" width=50%><figcaption><h4>hook-connect 原理示意图</h4></figcaption></figure><p>无论采用哪种透明劫持方案，均需要解决获取真实目的 IP/端口的问题，使用 iptables 方案通过 getsockopt 方式获取，tproxy 可以直接读取目的地址，通过修改调用接口，hook connect 方案读取方式类似于 tproxy。</p><p>实现透明劫持后，在内核版本满足要求（4.16以上）的前提下，通过 sockmap 可以缩短报文穿越路径，进而改善 outbound 方向的转发性能。</p><h2 id=更新说明>更新说明</h2><p>下面是本文的几次更新说明。</p><p><strong>2020 年 4 月 27 日，第一版，基于 Istio 1.5</strong></p><p>本文的第一版，基于 Istio 1.5 创作，在此之前，我曾写过基于 Istio 1.1 版本的<a href=/blog/envoy-sidecar-injection-in-istio-service-mesh-deep-dive/>理解 Istio Service Mesh 中 Envoy 代理 Sidecar 注入及流量劫持</a>，为了更细致的理解 Istio 中透明流量劫持的全过程，专门创作本文。</p><p><strong>2022 年 1 月 17 日，第二版，基于 Istio 1.11</strong></p><p>本文第一版发布后，在社区里获得了比较大的反响，收到了很多读者的评论和留言。基于这些评论，我也发现了第一版中的很多错误，在加上 Istio 版本发布频繁，在近两年的时间内，Istio 已经作出了众多更新，其中不乏重大更新。因此笔者撰写了本文的第二版，修改了之前版本中的纰漏并根据时下 Istio 的最新版本更新了本文。</p><p>Istio 1.11 与 Istio 1.1 中的 sidecar 注入和流量劫持环节最大的变化是：</p><ul><li>iptables 改用命令行工具，不再使用 shell 脚本。</li><li>sidecar inbound 和 outbound 分别指定了端口，而之前是使用同一个端口（15001）。</li></ul><p><strong>2022 年 4 月 24，第三版，基于 Istio 1.13</strong></p><p>这个版本的文章主要是根据当时 Istio 的最新版本更新了文章的部分内容，并重新排版，增加更新说明。</p><p>Istio 1.13 相比 Istio 1.11 的变化是 <code>istioctl proxy-config</code> 命令的输出有了较大变化。</p><p><strong>2022 年 5 月 6 日，第四版，基于 Istio 1.13</strong></p><ul><li>修改了对 <code>ISTIO_ROUTE</code> iptables 规则 2、5 的解释</li><li>在示意图中增加了路径 16</li></ul><p><strong>2022 年 5 月 12 日，第五版，基于 Istio 1.13</strong></p><ul><li>将 iptables 说明和 sidecar 注入、init 容器部分独立成了两篇单独的博客，以缩减博客的篇幅，见 <a href=/blog/istio-pod-process-lifecycle/>Istio 数据平面 Pod 启动过程详解</a>和<a href=/blog/understanding-iptables/>理解 iptables</a>。</li></ul><h2 id=参考>参考</h2><ul><li><a href=https://jimmysong.io/blog/sidecar-injection-iptables-and-traffic-routing/ target=_blank rel="external nofollow noopener noreferrer">阅读原文</a></li><li><a href=https://istio.io/latest/docs/ops/diagnostic-tools/proxy-cmd/ target=_blank rel="external nofollow noopener noreferrer">Debugging Envoy and Istiod - istio.io</a></li><li><a href=https://istio.io/latest/zh/blog/2019/data-plane-setup/ target=_blank rel="external nofollow noopener noreferrer">揭开 Istio Sidecar 注入模型的神秘面纱 - istio.io</a></li><li><a href=https://mosn.io/docs/products/structure/traffic-hijack/ target=_blank rel="external nofollow noopener noreferrer">MOSN 作为 Sidecar 使用时的流量劫持方案 - mosn.io</a></li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="2022-09-11 14:26:02">更新于 2022-09-11</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a href=/sre/posts/detailed-explanation-of-sidecar-injection-transparent-flow-hijacking-and-traffic-route-in-istio/index.md title=阅读原始文档 class=link-to-markdown>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://www.kbsonlong.com/sre/posts/detailed-explanation-of-sidecar-injection-transparent-flow-hijacking-and-traffic-route-in-istio/ data-title="Istio 中的 Sidecar 注入、透明流量劫持及流量路由过程详解" data-hashtags=istio,转载><i class="fa-brands fa-twitter fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://www.kbsonlong.com/sre/posts/detailed-explanation-of-sidecar-injection-transparent-flow-hijacking-and-traffic-route-in-istio/ data-hashtag=istio><i class="fa-brands fa-facebook-square fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 WhatsApp" data-sharer=whatsapp data-url=https://www.kbsonlong.com/sre/posts/detailed-explanation-of-sidecar-injection-transparent-flow-hijacking-and-traffic-route-in-istio/ data-title="Istio 中的 Sidecar 注入、透明流量劫持及流量路由过程详解" data-web><i class="fa-brands fa-whatsapp fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=https://www.kbsonlong.com/sre/posts/detailed-explanation-of-sidecar-injection-transparent-flow-hijacking-and-traffic-route-in-istio/ data-title="Istio 中的 Sidecar 注入、透明流量劫持及流量路由过程详解"><i data-svg-src=/sre/lib/simple-icons/icons/line.min.svg></i></a>
<a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://www.kbsonlong.com/sre/posts/detailed-explanation-of-sidecar-injection-transparent-flow-hijacking-and-traffic-route-in-istio/ data-title="Istio 中的 Sidecar 注入、透明流量劫持及流量路由过程详解"><i class="fa-brands fa-weibo fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 Myspace" data-sharer=myspace data-url=https://www.kbsonlong.com/sre/posts/detailed-explanation-of-sidecar-injection-transparent-flow-hijacking-and-traffic-route-in-istio/ data-title="Istio 中的 Sidecar 注入、透明流量劫持及流量路由过程详解" data-description><i data-svg-src=/sre/lib/simple-icons/icons/myspace.min.svg></i></a>
<a href=javascript:void(0); title="分享到 Blogger" data-sharer=blogger data-url=https://www.kbsonlong.com/sre/posts/detailed-explanation-of-sidecar-injection-transparent-flow-hijacking-and-traffic-route-in-istio/ data-title="Istio 中的 Sidecar 注入、透明流量劫持及流量路由过程详解" data-description><i class="fa-brands fa-blogger fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 Evernote" data-sharer=evernote data-url=https://www.kbsonlong.com/sre/posts/detailed-explanation-of-sidecar-injection-transparent-flow-hijacking-and-traffic-route-in-istio/ data-title="Istio 中的 Sidecar 注入、透明流量劫持及流量路由过程详解"><i class="fa-brands fa-evernote fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw"></i>&nbsp;<a href=/sre/tags/istio/>Istio</a>,&nbsp;<a href=/sre/tags/%E8%BD%AC%E8%BD%BD/>转载</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/sre/>主页</a></span></section></div><div class=post-nav><a href=/sre/posts/vscode-configuration-markdown-template/ class=prev rel=prev title="VSCode 配置Markdown模板"><i class="fa-solid fa-angle-left fa-fw"></i>VSCode 配置Markdown模板</a>
<a href=/sre/posts/detailed-explanation-of-traffic-types-in-sidecar-and-iptables/ class=next rel=next title="Sidecar 中的流量类型及 iptables 规则详解">Sidecar 中的流量类型及 iptables 规则详解<i class="fa-solid fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=giscus><script src=https://giscus.app/client.js data-repo=kbsonlong/devops.alongparty.cn data-repo-id=R_kgDOHE7F-Q data-category=Announcements data-category-id=DIC_kwDOHE7F-c4CPP5J data-mapping=title data-theme=preferred_color_scheme data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-lang=zh-CN data-loading=lazy crossorigin=anonymous async defer></script><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app/ rel="external nofollow noopener noreferrer">giscus</a>.</noscript></div></div></article></main><footer class=footer><div class=footer-container><div class="footer-line copyright"><i class="fa-regular fa-copyright fa-fw"></i>
<span itemprop=copyrightYear>2018 - 2024</span><span class=author itemprop=copyrightHolder>
<a href=/sre/>kbsonlong</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class="footer-line statistics"></div><div class="footer-line ibruce"><span id=busuanzi_container_site_uv title=总访客数><i class="fa-regular fa-user fa-fw"></i>&nbsp;<span id=busuanzi_value_site_uv><i class="fa fa-spinner fa-spin fa-fw"></i></span></span><span id=busuanzi_container_site_pv class=footer-divider title=总访问量><i class="fa-regular fa-eye fa-fw"></i>&nbsp;<span id=busuanzi_value_site_pv><i class="fa fa-spinner fa-spin fa-fw"></i></span></span></div><div class="footer-line beian"><span class="icp footer-divider"><a target=_blank href=https://beian.miit.gov.cn/>粤ICP备18122209号</a></span></div></div></footer></div><div class=widgets><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fa-solid fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fa-solid fa-comment fa-fw"></i></a></div><a href=https://github.com/kbsonlong title="在 GitHub 上查看源代码" target=_blank rel="external nofollow noopener noreferrer" class="github-corner right d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div id=mask></div></div><link rel=stylesheet href=/sre/lib/katex/katex.min.css><link rel=stylesheet href=/sre/lib/katex/copy-tex.min.css><link rel=stylesheet href=/sre/lib/cookieconsent/cookieconsent.min.css><script type=text/javascript src=/sre/lib/autocomplete/autocomplete.min.js defer></script><script type=text/javascript src=/sre/lib/algoliasearch/algoliasearch-lite.umd.min.js defer></script><script type=text/javascript src=/sre/lib/lazysizes/lazysizes.min.js async defer></script><script type=text/javascript src=/sre/lib/sharer/sharer.min.js async defer></script><script type=text/javascript src=/sre/lib/katex/katex.min.js defer></script><script type=text/javascript src=/sre/lib/katex/auto-render.min.js defer></script><script type=text/javascript src=/sre/lib/katex/copy-tex.min.js defer></script><script type=text/javascript src=/sre/lib/katex/mhchem.min.js defer></script><script type=text/javascript src=/sre/lib/cookieconsent/cookieconsent.min.js defer></script><script type=text/javascript src=/sre/lib/pangu/pangu.min.js defer></script><script type=text/javascript src=/sre/lib/cell-watermark/watermark.min.js defer></script><script type=text/javascript src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async defer></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:10},comment:{giscus:{darkTheme:"dark",lightTheme:"light"}},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},enablePWA:!0,enablePangu:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"WFOR67TML1",algoliaIndex:"along",algoliaSearchKey:"ea1fe535f9a7ae353f3922489c829cc1",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"},watermark:{appendto:".wrapper>main",colspacing:30,content:'<img class="fixit-icon" src="/favicon-16x16.png" alt="FixIt logo" /> FixIt 主题',enable:!0,fontfamily:"inherit",fontsize:.85,height:21,opacity:.0125,rotate:15,rowspacing:60,width:150}}</script><script type=text/javascript src=/sre/js/theme.min.js defer></script><script type=text/javascript src=/sre/js/_custom.min.js defer></script></body></html>