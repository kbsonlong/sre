<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><meta http-equiv=X-UA-Compatible content="IE=edge, chrome=1"><title>kubebuilder2.0学习笔记——进阶使用 - 蜷缩的蜗牛</title><meta name=author content="kbsonlong">
<meta name=author-link content><meta name=description content="概述 本篇将继续深入学习kubebuilder开发，并介绍一些深入使用时遇到的问题。包括：finalizer、控制器对CRD的update st"><meta name=keywords content='kubebuilder'><meta itemprop=name content="kubebuilder2.0学习笔记——进阶使用"><meta itemprop=description content="概述 本篇将继续深入学习kubebuilder开发，并介绍一些深入使用时遇到的问题。包括：finalizer、控制器对CRD的update st"><meta itemprop=datePublished content="2023-10-24T14:41:48+08:00"><meta itemprop=dateModified content="2023-10-24T14:41:48+08:00"><meta itemprop=wordCount content="7802"><meta itemprop=image content="https://www.kbsonlong.com/sre/logo_transparent.png"><meta itemprop=keywords content="kubebuilder,"><meta property="og:title" content="kubebuilder2.0学习笔记——进阶使用"><meta property="og:description" content="概述 本篇将继续深入学习kubebuilder开发，并介绍一些深入使用时遇到的问题。包括：finalizer、控制器对CRD的update st"><meta property="og:type" content="article"><meta property="og:url" content="https://www.kbsonlong.com/sre/posts/4fe3f9/"><meta property="og:image" content="https://www.kbsonlong.com/sre/logo_transparent.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-10-24T14:41:48+08:00"><meta property="article:modified_time" content="2023-10-24T14:41:48+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.kbsonlong.com/sre/logo_transparent.png"><meta name=twitter:title content="kubebuilder2.0学习笔记——进阶使用"><meta name=twitter:description content="概述 本篇将继续深入学习kubebuilder开发，并介绍一些深入使用时遇到的问题。包括：finalizer、控制器对CRD的update st"><meta name=application-name content="FixIt"><meta name=apple-mobile-web-app-title content="FixIt"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#252627"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://www.kbsonlong.com/sre/posts/4fe3f9/><link rel=prev href=https://www.kbsonlong.com/sre/posts/f269d7/><link rel=next href=https://www.kbsonlong.com/sre/posts/169f99/><link rel=stylesheet href=/sre/lib/normalize/normalize.min.css><link rel=stylesheet href=/sre/css/style.min.css><link rel=stylesheet href=/sre/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/sre/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"kubebuilder2.0学习笔记——进阶使用","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/www.kbsonlong.com\/sre\/posts\/4fe3f9\/"},"genre":"posts","keywords":"kubebuilder","wordcount":7802,"url":"https:\/\/www.kbsonlong.com\/sre\/posts\/4fe3f9\/","datePublished":"2023-10-24T14:41:48+08:00","dateModified":"2023-10-24T14:41:48+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"kbsonlong"},"description":""}</script></head><body header-desktop=sticky header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper github-corner=right><div class=header-title><a href=/sre/ title=蜷缩的蜗牛><img class="lazyload logo" src=/sre/svg/loading.min.svg data-src=/sre/logo_transparent.png data-srcset="/sre/logo_transparent.png, /sre/logo_transparent.png 1.5x, /sre/logo_transparent.png 2x" data-sizes=auto alt=蜷缩的蜗牛 title=蜷缩的蜗牛><span class=header-title-text>蜷缩的蜗牛</span></a><span class=header-subtitle></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/sre/posts/><i class='fa-solid fa-archive fa-fw fa-sm'></i> 文章</a></li><li class=menu-item><a class=menu-link href=/sre/categories/><i class='fa-solid fa-th fa-fw fa-sm'></i> 分类</a></li><li class=menu-item><a class=menu-link href=/sre/tags/><i class='fa-solid fa-tags fa-fw fa-sm'></i> 标签</a></li><li class=menu-item><a class=menu-link href=/sre/friends/ title=友情链接><i class='fa-solid fa-users fa-fw fa-sm'></i> 友链</a></li><li class=menu-item><a class=menu-link href=/sre/about/><i class='fa-solid fa-info-circle fa-fw fa-sm'></i> 关于</a></li><li class="menu-item d-none-desktop text-center"><a class=menu-link href=https://github.com/kbsonlong/ title=GitHub rel="noopener noreferrer" target=_blank><i class='fa-brands fa-github fa-fw'></i></a></li><li class="menu-item d-none-desktop text-center"><a class=menu-link href=/sre/messages/><i class='fa-solid fa-messages'></i> 留言板</a></li><li class=menu-item><a class=menu-link href=/sre/messages/ title=留言板>留言板</a></li><li class="menu-item delimiter"></li><li class="menu-item language"><span title=选择语言>简体中文<i class="dropdown-icon fa-solid fa-chevron-down"></i></span><ul class=sub-menu><li class=menu-item>没有更多翻译</li></ul></li><li class="menu-item search" id=search-desktop><input type=text placeholder="搜索文章标题或内容 ..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw"></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw"></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin"></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw"></i></li></ul></nav></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/sre/ title=蜷缩的蜗牛><img class="lazyload logo" src=/sre/svg/loading.min.svg data-src=/sre/logo_transparent.png data-srcset="/sre/logo_transparent.png, /sre/logo_transparent.png 1.5x, /sre/logo_transparent.png 2x" data-sizes=auto alt=/sre/logo_transparent.png title=/sre/logo_transparent.png><span class=header-title-text>蜷缩的蜗牛</span></a><span class=header-subtitle></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="搜索文章标题或内容 ..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw"></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw"></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><a class=menu-link href=/sre/posts/><i class='fa-solid fa-archive fa-fw fa-sm'></i> 文章</a></li><li class=menu-item><a class=menu-link href=/sre/categories/><i class='fa-solid fa-th fa-fw fa-sm'></i> 分类</a></li><li class=menu-item><a class=menu-link href=/sre/tags/><i class='fa-solid fa-tags fa-fw fa-sm'></i> 标签</a></li><li class=menu-item><a class=menu-link href=/sre/friends/ title=友情链接><i class='fa-solid fa-users fa-fw fa-sm'></i> 友链</a></li><li class=menu-item><a class=menu-link href=/sre/about/><i class='fa-solid fa-info-circle fa-fw fa-sm'></i> 关于</a></li><li class="menu-item d-none-desktop text-center"><a class=menu-link href=https://github.com/kbsonlong/ title=GitHub rel="noopener noreferrer" target=_blank><i class='fa-brands fa-github fa-fw'></i></a></li><li class="menu-item d-none-desktop text-center"><a class=menu-link href=/sre/messages/><i class='fa-solid fa-messages'></i> 留言板</a></li><li class=menu-item><a class=menu-link href=/sre/messages/ title=留言板>留言板</a></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw"></i></li><li class="menu-item language"><span title=选择语言>简体中文<i class="dropdown-icon fa-solid fa-chevron-down"></i>
</span><select class=language-select onchange="location=this.value"><option disabled>没有更多翻译</option></select></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=container page-style=normal><aside class=toc id=toc-auto><h2 class=toc-title>目录 <i class="toc-icon fa-solid fa-angle-down fa-fw"></i></h2><div class=toc-content id=toc-content-auto></div></aside><aside class=aside-custom></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>kubebuilder2.0学习笔记——进阶使用</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><img class="lazyload avatar" src=/sre/svg/loading.min.svg data-src="https://gravatar.loli.net/avatar/598872715ec08296cf1e1806135cd518?s=32&amp;d=mp" data-srcset="https://gravatar.loli.net/avatar/598872715ec08296cf1e1806135cd518?s=32&amp;d=mp, https://gravatar.loli.net/avatar/598872715ec08296cf1e1806135cd518?s=32&amp;d=mp 1.5x, https://gravatar.loli.net/avatar/598872715ec08296cf1e1806135cd518?s=32&amp;d=mp 2x" data-sizes=auto alt=kbsonlong title=kbsonlong>&nbsp;kbsonlong</span></span>
<span class=post-category>收录于 <a href=/sre/categories/operator/><i class="fa-regular fa-folder fa-fw"></i>&nbsp;Operator</a>&ensp;<a href=/sre/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/><i class="fa-regular fa-folder fa-fw"></i>&nbsp;云原生</a></span></div><div class=post-meta-line><span title="2023-10-24 14:41:48"><i class="fa-regular fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2023-10-24>2023-10-24</time>
</span>&nbsp;<i class="fa-solid fa-pencil-alt fa-fw"></i>&nbsp;约 7802 字&nbsp;
<i class="fa-regular fa-clock fa-fw"></i>&nbsp;预计阅读 16 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#概述>概述</a></li><li><a href=#status>status</a><ul><li><a href=#设计subresource风格的status>设计subresource风格的status</a></li></ul></li><li><a href=#finalizer>finalizer</a><ul><li><a href=#范例>范例</a></li></ul></li><li><a href=#cluster-scope>cluster-scope</a></li><li><a href=#kubebuilder-注释标记>kubebuilder 注释标记</a></li><li><a href=#kubebuilder-的log>kubebuilder 的log</a></li><li><a href=#给reconciler做扩展>给Reconciler做扩展</a><ul><li><a href=#增加eventer>增加eventer</a></li><li><a href=#reconciler监控多个资源变化>reconciler监控多个资源变化</a></li><li><a href=#监听指定字段的变更>监听指定字段的变更</a><ul><li><a href=#方法1添加自定义的入队predicate>方法1：添加自定义的入队predicate</a></li><li><a href=#方法2自定义一个入队器>方法2：自定义一个入队器</a></li><li><a href=#best-way-to-watch>best way to watch</a></li></ul></li><li><a href=#使用非缓存的client>使用非缓存的client</a></li></ul></li><li><a href=#多版本切换>多版本切换</a></li><li><a href=#在webhook中使用client>在webhook中使用client</a></li><li><a href=#添加自定义的webhook>添加自定义的webhook</a></li><li><a href=#使用索引>使用索引</a><ul><li><a href=#参考资料>参考资料</a></li></ul></li></ul></nav></div></div><div class=content id=content><h2 id=概述>概述</h2><p>本篇将继续深入学习kubebuilder开发，并介绍一些深入使用时遇到的问题。包括：finalizer、控制器对CRD的update status、kubebuilder注释等。并且会分享一些在开发过程中使用的小技巧</p><h2 id=status>status</h2><p>我们先看一个新建的crd的结构体：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>// BucketStatus defines the observed state of Bucket
</span></span><span class=line><span class=cl>type BucketStatus struct {
</span></span><span class=line><span class=cl>    // INSERT ADDITIONAL STATUS FIELD - define observed state of cluster
</span></span><span class=line><span class=cl>    // Important: Run &#34;make&#34; to regenerate code after modifying this file
</span></span><span class=line><span class=cl>    Progress int32 `json:&#34;progress&#34;`
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// +kubebuilder:object:root=true
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// Bucket is the Schema for the buckets API
</span></span><span class=line><span class=cl>type Bucket struct {
</span></span><span class=line><span class=cl>    metav1.TypeMeta   `json:&#34;,inline&#34;`
</span></span><span class=line><span class=cl>    metav1.ObjectMeta `json:&#34;metadata,omitempty&#34;`
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    Spec   BucketSpec   `json:&#34;spec,omitempty&#34;`
</span></span><span class=line><span class=cl>    Status BucketStatus `json:&#34;status,omitempty&#34;`
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>这里，Spec和Status均是Bucket的成员变量，Status并不像<code>Pod.Status</code>一样，是<code>Pod</code>的<code>subResource</code>.因此，如果我们在controller的代码中调用到<code>Status().Update()</code>,会触发panic，并报错：<code>the server could not find the requested resource</code></p><p>如果我们想像k8s中的设计那样，那么就要遵循k8s中<code>status subresource</code>的使用规范：</p><ul><li>用户只能指定一个CRD实例的spec部分；</li><li>CRD实例的status部分由控制器进行变更。</li></ul><h3 id=设计subresource风格的status>设计subresource风格的status</h3><ul><li><p>需要在Bucket的注释中添加一行<code>// +kubebuilder:subresource:status</code>，变成如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>// +kubebuilder:subresource:status
</span></span><span class=line><span class=cl>// +kubebuilder:object:root=true
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// Bucket is the Schema for the buckets API
</span></span><span class=line><span class=cl>type Bucket struct {
</span></span><span class=line><span class=cl>    metav1.TypeMeta   `json:&#34;,inline&#34;`
</span></span><span class=line><span class=cl>    metav1.ObjectMeta `json:&#34;metadata,omitempty&#34;`
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    Spec   BucketSpec   `json:&#34;spec,omitempty&#34;`
</span></span><span class=line><span class=cl>    Status BucketStatus `json:&#34;status,omitempty&#34;`
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div></li><li><p>创建Bucket资源时，即便我们填入了非空的<code>status</code>结构，也不会更新到apiserver中。Status只能通过对应的client进行更新。比如在controller中：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-stylus data-lang=stylus><span class=line><span class=cl><span class=k>if</span> <span class=err>bucket</span><span class=p>.</span><span class=nc>Status</span><span class=p>.</span><span class=nc>Progress</span> <span class=o>==</span> <span class=err>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=err>bucket</span><span class=p>.</span><span class=nc>Status</span><span class=p>.</span><span class=nc>Progress</span> <span class=o>=</span> <span class=err>1</span>
</span></span><span class=line><span class=cl>      <span class=err>err</span> <span class=p>:</span><span class=o>=</span> <span class=err>r</span><span class=p>.</span><span class=nc>Status</span><span class=p>().</span><span class=nc>Update</span><span class=p>(</span><span class=err>ctx</span><span class=p>,</span> <span class=k>&amp;</span><span class=err>bucket</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=err>err</span> <span class=o>!=</span> <span class=err>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=err>ctrl</span><span class=p>.</span><span class=nc>Result</span><span class=p>{},</span> <span class=err>err</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这样，只要bucket实例的<code>status.Progress</code>为0时（比如我们创建一个bucket实例时，由于<code>status.Progress</code>无法配置，故初始化为默认值，即0），controller就会帮我们将它变更为1.</p></li></ul><p>注意：<br>kubebuilder 2.0开发生成的crd模板，无法通过apiserver的crd校验。社区有相关的记录和修复<a href=https://github.com/kubernetes target=_blank rel="external nofollow noopener noreferrer">https://github.com/kubernetes</a>&mldr;<br>所以1.11.*版本的k8s，要使用kubebuilder 2.0 必须给apiserver配置一个featuregate： - &ndash;feature-gates=CustomResourceValidation=false，关闭对crd的校验。</p><h2 id=finalizer>finalizer</h2><p><code>finalizer</code>即终结器，存在于每一个k8s内的资源实例中，即<code>**.metadata.finalizers</code>,它是一个字符串数组，每一个成员表示一个<code>finalizer</code>。控制器在删除某个资源时，会根据该资源的<code>finalizers</code>配置，进行异步预删除处理，所有的<code>finalizer</code>都执行完毕后，该资源会被真正删除。</p><p>这里的预删除处理，一般指对该资源的关联资源进行增删改操作。比如：一个A资源被删除时，其finalizer规定必须将A资源的Selector指向的所有service都删除。</p><p>当我们需要设计这类finalizer时，就可以自定义一个controller来实现。</p><p>因为<code>finalizer</code>的存在，资源的Delete操作，会变成一个Update操作：给资源加入一个<code>deletiontimestamp</code>。 也就是说：不使用<code>finalizer</code>时，我们手动删除一个对象，kubebuilder会在缓存中找不到该对象时触发该对象的<code>OnDelete</code>； 使用<code>finalizer</code>时，我们手动删除一个对象，kubebuilder会先触发一次该对象的<code>OnUpdate</code>，此次update是给资源加入一个<code>deletiontimestamp</code>，然后在缓存中找不到该对象时再触发该对象的<code>OnDelete</code>。</p><p>需要注意的关键一点是，终结器会导致对象上的delete变成设置删除时间戳的更新。对象上的删除时间戳表示该对象正在被删除。否则，在没有终结器的情况下，当缓存中缺少对象时，将显示一个delete。</p><h3 id=范例>范例</h3><p>我们设计一个Bucket类和一个Playbook类，Playbook.Spec.Selector是一个选择器，可以通过该选择器找到对应的Bucket。Playbook控制器需要做以下事情：</p><ul><li>如果一个Playbook对象没有删除时间戳（被创建或更新），我们检查并配置一个finalizer：<code>testdelete</code>给它</li><li>如果一个Playbook有删除时间戳（被删除），我们检查是否该对象的finalizer包含<code>testdelete</code>.</li><li>如果包含，我们检查该Playbook对象的spec.Selector是否不为空</li><li>如果不为空，我们根据spec.Selector List相同namespace下所有的bucket，并将它们一一删除</li></ul><p>Reconcile函数中增加如下代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-stylus data-lang=stylus><span class=line><span class=cl>    <span class=err>myplaybookFinalizerName</span> <span class=p>:</span><span class=o>=</span> <span class=err>&#34;testdelete&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=err>book</span><span class=p>.</span><span class=nc>ObjectMeta</span><span class=p>.</span><span class=nc>DeletionTimestamp</span><span class=p>.</span><span class=nc>IsZero</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nv>!containsString</span><span class=p>(</span><span class=err>book</span><span class=p>.</span><span class=nc>ObjectMeta</span><span class=p>.</span><span class=nc>Finalizers</span><span class=p>,</span> <span class=err>myplaybookFinalizerName</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=err>book</span><span class=p>.</span><span class=nc>ObjectMeta</span><span class=p>.</span><span class=nc>Finalizers</span> <span class=o>=</span> <span class=nd>append</span><span class=p>(</span><span class=err>book</span><span class=p>.</span><span class=nc>ObjectMeta</span><span class=p>.</span><span class=nc>Finalizers</span><span class=p>,</span> <span class=err>myplaybookFinalizerName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=err>err</span> <span class=p>:</span><span class=o>=</span> <span class=err>r</span><span class=p>.</span><span class=nc>Update</span><span class=p>(</span><span class=err>ctx</span><span class=p>,</span> <span class=k>&amp;</span><span class=err>book</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=err>err</span> <span class=o>!=</span> <span class=err>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=err>ctrl</span><span class=p>.</span><span class=nc>Result</span><span class=p>{},</span> <span class=err>err</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nd>containsString</span><span class=p>(</span><span class=err>book</span><span class=p>.</span><span class=nc>ObjectMeta</span><span class=p>.</span><span class=nc>Finalizers</span><span class=p>,</span> <span class=err>myplaybookFinalizerName</span><span class=p>)</span> <span class=k>&amp;&amp;</span> <span class=err>book</span><span class=p>.</span><span class=nc>Spec</span><span class=p>.</span><span class=nc>Selector</span> <span class=o>!=</span> <span class=err>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=err>bList</span> <span class=p>:</span><span class=o>=</span> <span class=k>&amp;</span><span class=err>opsv1</span><span class=p>.</span><span class=nc>BucketList</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>            <span class=err>err</span> <span class=p>:</span><span class=o>=</span> <span class=err>r</span><span class=p>.</span><span class=nc>List</span><span class=p>(</span><span class=err>ctx</span><span class=p>,</span> <span class=err>bList</span><span class=p>,</span> <span class=err>client</span><span class=p>.</span><span class=nc>InNamespace</span><span class=p>(</span><span class=err>book</span><span class=p>.</span><span class=nc>Namespace</span><span class=p>),</span> <span class=err>client</span><span class=p>.</span><span class=nc>MatchingLabels</span><span class=p>(</span><span class=err>book</span><span class=p>.</span><span class=nc>Spec</span><span class=p>.</span><span class=nc>Selector</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=err>err</span> <span class=o>!=</span> <span class=err>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=err>ctrl</span><span class=p>.</span><span class=nc>Result</span><span class=p>{},</span> <span class=err>fmt</span><span class=p>.</span><span class=nc>Errorf</span><span class=p>(</span><span class=err>&#34;can&#39;t</span> <span class=err>find</span> <span class=err>buckets</span> <span class=err>match</span> <span class=err>playbook</span><span class=p>,</span> <span class=o>%</span><span class=nt>s</span><span class=err>&#34;</span><span class=p>,</span> <span class=err>err</span><span class=p>.</span><span class=nc>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=err>_</span><span class=p>,</span> <span class=nt>b</span> <span class=p>:</span><span class=o>=</span> <span class=err>range</span> <span class=err>bList</span><span class=p>.</span><span class=nc>Items</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=err>err</span> <span class=o>=</span> <span class=err>r</span><span class=p>.</span><span class=nc>Delete</span><span class=p>(</span><span class=err>ctx</span><span class=p>,</span> <span class=k>&amp;</span><span class=nt>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=err>err</span> <span class=o>!=</span> <span class=err>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=err>ctrl</span><span class=p>.</span><span class=nc>Result</span><span class=p>{},</span> <span class=err>fmt</span><span class=p>.</span><span class=nc>Errorf</span><span class=p>(</span><span class=err>&#34;can&#39;t</span> <span class=err>delete</span> <span class=err>buckets</span> <span class=o>%</span><span class=nt>s</span><span class=o>/%</span><span class=nt>s</span><span class=p>,</span> <span class=o>%</span><span class=nt>s</span><span class=err>&#34;</span><span class=p>,</span><span class=nt>b</span><span class=p>.</span><span class=nc>Namespace</span><span class=p>,</span> <span class=nt>b</span><span class=p>.</span><span class=nc>Name</span><span class=p>,</span> <span class=err>err</span><span class=p>.</span><span class=nc>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=err>book</span><span class=p>.</span><span class=nc>ObjectMeta</span><span class=p>.</span><span class=nc>Finalizers</span> <span class=o>=</span> <span class=nd>removeString</span><span class=p>(</span><span class=err>book</span><span class=p>.</span><span class=nc>ObjectMeta</span><span class=p>.</span><span class=nc>Finalizers</span><span class=p>,</span> <span class=err>myplaybookFinalizerName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=err>err</span> <span class=o>=</span> <span class=err>r</span><span class=p>.</span><span class=nc>Update</span><span class=p>(</span><span class=err>ctx</span><span class=p>,</span> <span class=k>&amp;</span><span class=err>book</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=err>ctrl</span><span class=p>.</span><span class=nc>Result</span><span class=p>{},</span> <span class=err>err</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=cluster-scope>cluster-scope</h2><p>k8s中node、pv等资源是集群级别的，它们没有namespace字段，因此查询node资源时也无需规定要从哪个namespace查。</p><p>我们在进行k8s operator时经常也需要设计这样的字段，但是默认情况下，kubebuilder会给我们创建namespace scope的crd资源，可以通过如下方式修改:</p><p>在执行<code>kubebuilder create api ****</code> 后，我们在生成的资源的<code>*_types.go</code>文件中，找到资源的主结构体，增加一条注释<code>kubebuilder:resource:scope=Cluster</code>，比如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>// +kubebuilder:object:root=true
</span></span><span class=line><span class=cl>// +kubebuilder:resource:scope=Cluster
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// Bookbox is the Schema for the bookboxes API
</span></span><span class=line><span class=cl>type Bookbox struct {
</span></span><span class=line><span class=cl>    metav1.TypeMeta   `json:&#34;,inline&#34;`
</span></span><span class=line><span class=cl>    metav1.ObjectMeta `json:&#34;metadata,omitempty&#34;`
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    Spec   BookboxSpec   `json:&#34;spec,omitempty&#34;`
</span></span><span class=line><span class=cl>    Status BookboxStatus `json:&#34;status,omitempty&#34;`
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>这样执行<code>make install</code>，会在<code>config/crd/bases/</code>目录下生成对应的crd的yaml文件，里面就申明了该crd的scope：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apiextensions.k8s.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>CustomResourceDefinition</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>bookboxes.ops.netease.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>group</span><span class=p>:</span><span class=w> </span><span class=l>ops.netease.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>names</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Bookbox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>plural</span><span class=p>:</span><span class=w> </span><span class=l>bookboxes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>scope</span><span class=p>:</span><span class=w> </span><span class=l>Cluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=cp>**</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>需要注意的是，<code>// +kubebuilder:resource:scope=Cluster</code>这句注释，必须放在结构体的上方、且必须是最靠近该结构体的一条kubebuilder注释，否则会失效。</p><h2 id=kubebuilder-注释标记>kubebuilder 注释标记</h2><p>我们注意到，在<a href=#%E8%AE%BE%E8%AE%A1subresource%E9%A3%8E%E6%A0%BC%E7%9A%84status>设计subresource风格的status</a>和<a href=#cluster-scope>cluster-scope</a>中我们都是用kubebuilder的注释标记，实现我们想要的资源形态，这里有更多关于注释标记的说明，比如：令crd支持<code>kubectl scale</code>，对crd实例进行基础的值校验，允许在<code>kubectl get</code>命令中显示crd的更多字段，等等.此处举两例：</p><p>kubectl get 时显示crd的status.replicas：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-awk data-lang=awk><span class=line><span class=cl><span class=err>// +kubebuilder:printcolumn:JSONPath=&#34;.status.replicas&#34;,name=Replicas,type=string</span>
</span></span></code></pre></td></tr></table></div></div><p>限定字段的值为固定的几个：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-elm data-lang=elm><span class=line><span class=cl><span class=kr>type</span> <span class=kt>Host</span> <span class=nv>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>..</span>
</span></span><span class=line><span class=cl>    <span class=kt>Spec</span> <span class=kt>HostSpec</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>type</span> <span class=kt>HostSpec</span> <span class=nv>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nf>//</span> <span class=nf>+</span><span class=nv>kubebuilder</span><span class=nf>:</span><span class=nv>validation</span><span class=nf>:</span><span class=kt>Enum</span><span class=nf>=</span><span class=kt>Wallace</span><span class=err>;</span><span class=kt>Gromit</span><span class=err>;</span><span class=kt>Chicken</span>
</span></span><span class=line><span class=cl>    <span class=kt>HostName</span> <span class=nv>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=kubebuilder-的log>kubebuilder 的log</h2><p>kubebuilder的log使用了第三方包<code>"github.com/go-logr/logr"</code>。当我们在开发reconciler时，如果需要在某处打日志，我们需要在<code>Reconcile</code>方法中将</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=na>_</span> <span class=o>=</span> <span class=s>r.Log.WithValues(&#34;playbook&#34;, req.NamespacedName)</span>
</span></span></code></pre></td></tr></table></div></div><p>改为</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>log := r.Log.WithValues(&#34;playbook&#34;, req.NamespacedName)
</span></span></code></pre></td></tr></table></div></div><p>从而获得一个logger实例。之后的逻辑中，我们可以执行：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>log.Info(&#34;this is the message&#34;, $KEY, $VALUE)
</span></span></code></pre></td></tr></table></div></div><p>注意，这里KEY和VALUE都是interface{}结构，可以是字符串或整型等，他们表示在上下文中记录的键值对，反映到程序日志中，会是这个样子：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>// code:
</span></span><span class=line><span class=cl>  log.Info(&#34;will try get bucket from changed&#34;,&#34;bucket-name&#34;, req.NamespacedName)
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>// output:
</span></span><span class=line><span class=cl>  2019-09-11T11:53:58.017+0800    INFO    controllers.Playbook    will try get bucket from changed    {&#34;playbook&#34;: &#34;default/playbook-sample&#34;, &#34;bucket-name&#34;: {&#34;namespace&#34;: &#34;default&#34;, &#34;name&#34;: &#34;playbook-sample&#34;}}
</span></span></code></pre></td></tr></table></div></div><p>logr包提供的logger只有Info和Error两种类型，但可以通过<code>V(int)</code>配置日志级别。不管是Info还是Error，都采用上面例子的格式，即：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-reasonml data-lang=reasonml><span class=line><span class=cl><span class=n>log</span><span class=ow>.</span><span class=nc>Info</span><span class=ow>(</span><span class=kt>string</span><span class=ow>,</span> <span class=ow>{</span><span class=n>key</span><span class=ow>,</span> <span class=n>value</span><span class=ow>}</span> <span class=ow>*</span> <span class=n>n</span> <span class=ow>)</span>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=ow>.</span><span class=nc>Error</span><span class=ow>(</span><span class=kt>string</span><span class=ow>,</span> <span class=ow>{</span><span class=n>key</span><span class=ow>,</span> <span class=n>value</span><span class=ow>}</span> <span class=ow>*</span> <span class=n>n</span> <span class=ow>)</span>
</span></span><span class=line><span class=cl><span class=n>n</span><span class=ow>&gt;=</span><span class=n>0</span>
</span></span></code></pre></td></tr></table></div></div><p>如果不遵循这种格式，运行期间会抛出panic。</p><h2 id=给reconciler做扩展>给Reconciler做扩展</h2><h3 id=增加eventer>增加eventer</h3><p>我们需要在某些时候创建k8s event进行事件记录，但Reconciler默认是只有一个Client接口和一个Logger的：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-elm data-lang=elm><span class=line><span class=cl><span class=kr>type</span> <span class=kt>PlaybookReconciler</span> <span class=nv>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>client</span><span class=nf>.</span><span class=kt>Client</span>
</span></span><span class=line><span class=cl>    <span class=kt>Log</span> <span class=nv>logr</span><span class=nf>.</span><span class=kt>Logger</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>我们可以往struct中添油加醋：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-elm data-lang=elm><span class=line><span class=cl><span class=kr>type</span> <span class=kt>PlaybookReconciler</span> <span class=nv>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>client</span><span class=nf>.</span><span class=kt>Client</span>
</span></span><span class=line><span class=cl>    <span class=kt>Eventer</span> <span class=nv>record</span><span class=nf>.</span><span class=kt>EventRecorder</span>
</span></span><span class=line><span class=cl>    <span class=kt>Log</span> <span class=nv>logr</span><span class=nf>.</span><span class=kt>Logger</span>
</span></span><span class=line><span class=cl><span class=p>}</span> 
</span></span></code></pre></td></tr></table></div></div><p><code>PlaybookReconciler</code>的初始化在<code>main.go</code>中，kubebuilder设计的manager自带了事件广播的生成方法，直接使用即可：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-reasonml data-lang=reasonml><span class=line><span class=cl><span class=k>if</span> <span class=n>err</span> <span class=ow>=</span> <span class=ow>(&amp;</span><span class=n>controllers</span><span class=ow>.</span><span class=nc>PlaybookReconciler</span><span class=ow>{</span>
</span></span><span class=line><span class=cl>        <span class=nc>Client</span><span class=ow>:</span> <span class=n>mgr</span><span class=ow>.</span><span class=nc>GetClient</span><span class=bp>()</span><span class=ow>,</span>
</span></span><span class=line><span class=cl>        <span class=nc>Eventer</span><span class=ow>:</span> <span class=n>mgr</span><span class=ow>.</span><span class=nc>GetEventRecorderFor</span><span class=ow>(</span><span class=s2>&#34;playbook-controller&#34;</span><span class=ow>),</span>
</span></span><span class=line><span class=cl>        <span class=nc>Log</span><span class=ow>:</span>    <span class=n>ctrl</span><span class=ow>.</span><span class=nn>Log</span><span class=p>.</span><span class=nc>WithName</span><span class=ow>(</span><span class=s2>&#34;controllers&#34;</span><span class=ow>).</span><span class=nc>WithName</span><span class=ow>(</span><span class=s2>&#34;Playbook&#34;</span><span class=ow>),</span>
</span></span><span class=line><span class=cl>    <span class=ow>}).</span><span class=nc>SetupWithManager</span><span class=ow>(</span><span class=n>mgr</span><span class=ow>);</span> <span class=n>err</span> <span class=ow>!=</span> <span class=n>nil</span> <span class=ow>{</span>
</span></span><span class=line><span class=cl>        <span class=n>setupLog</span><span class=ow>.</span><span class=nc>Error</span><span class=ow>(</span><span class=n>err</span><span class=ow>,</span> <span class=s2>&#34;unable to create controller&#34;</span><span class=ow>,</span> <span class=s2>&#34;controller&#34;</span><span class=ow>,</span> <span class=s2>&#34;Playbook&#34;</span><span class=ow>)</span>
</span></span><span class=line><span class=cl>        <span class=n>os</span><span class=ow>.</span><span class=nc>Exit</span><span class=ow>(</span><span class=n>1</span><span class=ow>)</span>
</span></span><span class=line><span class=cl>    <span class=ow>}</span>
</span></span></code></pre></td></tr></table></div></div><p>注意这里要给我们的控制器配置好rbac，在kubebuilder 2.3.0中，可以在控制器代码文件的注释中添加：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=o>//</span><span class=w> </span><span class=o>+</span><span class=n>kubebuilder</span><span class=p>:</span><span class=n>rbac</span><span class=p>:</span><span class=n>groups</span><span class=o>=</span><span class=s2>&#34;&#34;</span><span class=p>,</span><span class=n>resources</span><span class=o>=</span><span class=n>events</span><span class=p>,</span><span class=n>verbs</span><span class=o>=</span><span class=k>get</span><span class=p>;</span><span class=n>list</span><span class=p>;</span><span class=n>watch</span><span class=p>;</span><span class=k>create</span><span class=p>;</span><span class=k>update</span><span class=p>;</span><span class=n>patch</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=reconciler监控多个资源变化>reconciler监控多个资源变化</h3><p>我们在开发过程中，可能需要开发一个类似<code>service-->selector-->pods</code>的资源逻辑，那么，在service的reconciler里，我们关注service的seletor的配置，并且检查匹配的pods是否有所变更（增加或减少），并更新到同名的endpoints里；同时，我们还要关注pod的更新，如果pod的label发生变化，那么要找出所有&rsquo;之前匹配了这些pod&rsquo;的service，检查service的selector是否仍然匹配pod的label，如有变动，也要更新endpoints。</p><p>这就意味着，我们需要能让reconciler能观察到service和pod两种资源的变更。我们在serviceReconciler的SetupWithManager方法中，可以看到：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-reasonml data-lang=reasonml><span class=line><span class=cl><span class=n>func</span> <span class=ow>(</span><span class=n>r</span> <span class=ow>*</span><span class=nc>ServiceReconciler</span><span class=ow>)</span> <span class=nc>SetupWithManager</span><span class=ow>(</span><span class=n>mgr</span> <span class=n>ctrl</span><span class=ow>.</span><span class=nc>Manager</span><span class=ow>)</span> <span class=n>error</span> <span class=ow>{</span>
</span></span><span class=line><span class=cl>    <span class=n>return</span> <span class=n>ctrl</span><span class=ow>.</span><span class=nc>NewControllerManagedBy</span><span class=ow>(</span><span class=n>mgr</span><span class=ow>).</span>
</span></span><span class=line><span class=cl>        <span class=nc>For</span><span class=ow>(&amp;</span><span class=n>opsv1</span><span class=ow>.</span><span class=nc>Service</span><span class=ow>{}).</span>
</span></span><span class=line><span class=cl>        <span class=nc>Complete</span><span class=ow>(</span><span class=n>r</span><span class=ow>)</span>
</span></span><span class=line><span class=cl><span class=ow>}</span>
</span></span></code></pre></td></tr></table></div></div><p>只需要在<code>For</code>方法调用后再调用<code>Watches</code>方法即可:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-reasonml data-lang=reasonml><span class=line><span class=cl><span class=n>func</span> <span class=ow>(</span><span class=n>r</span> <span class=ow>*</span><span class=nc>ServiceReconciler</span><span class=ow>)</span> <span class=nc>SetupWithManager</span><span class=ow>(</span><span class=n>mgr</span> <span class=n>ctrl</span><span class=ow>.</span><span class=nc>Manager</span><span class=ow>)</span> <span class=n>error</span> <span class=ow>{</span>
</span></span><span class=line><span class=cl>    <span class=n>return</span> <span class=n>ctrl</span><span class=ow>.</span><span class=nc>NewControllerManagedBy</span><span class=ow>(</span><span class=n>mgr</span><span class=ow>).</span>
</span></span><span class=line><span class=cl>        <span class=nc>For</span><span class=ow>(&amp;</span><span class=n>opsv1</span><span class=ow>.</span><span class=nc>Service</span><span class=ow>{}).</span><span class=nc>Watches</span><span class=ow>(&amp;</span><span class=n>source</span><span class=ow>.</span><span class=nc>Kind</span><span class=ow>{</span><span class=nc>Type</span><span class=ow>:</span> <span class=ow>&amp;</span><span class=n>opsv1</span><span class=ow>.</span><span class=nc>Pod</span><span class=ow>{}},</span> <span class=ow>&amp;</span><span class=n>handler</span><span class=ow>.</span><span class=nc>EnqueueRequestForObject</span><span class=ow>{}).</span>
</span></span><span class=line><span class=cl>        <span class=nc>Complete</span><span class=ow>(</span><span class=n>r</span><span class=ow>)</span>
</span></span><span class=line><span class=cl><span class=ow>}</span>
</span></span></code></pre></td></tr></table></div></div><p>此外，我们可以将service设计为pod的owner，然后在podController的<code>For</code>方法后在调用<code>Owns</code>方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-reasonml data-lang=reasonml><span class=line><span class=cl><span class=n>func</span> <span class=ow>(</span><span class=n>r</span> <span class=ow>*</span><span class=nc>ServiceReconciler</span><span class=ow>)</span> <span class=nc>SetupWithManager</span><span class=ow>(</span><span class=n>mgr</span> <span class=n>ctrl</span><span class=ow>.</span><span class=nc>Manager</span><span class=ow>)</span> <span class=n>error</span> <span class=ow>{</span>
</span></span><span class=line><span class=cl>    <span class=n>return</span> <span class=n>ctrl</span><span class=ow>.</span><span class=nc>NewControllerManagedBy</span><span class=ow>(</span><span class=n>mgr</span><span class=ow>).</span>
</span></span><span class=line><span class=cl>        <span class=nc>For</span><span class=ow>(&amp;</span><span class=n>opsv1</span><span class=ow>.</span><span class=nc>Service</span><span class=ow>{}).</span><span class=nc>Owns</span><span class=ow>(&amp;</span><span class=n>opsv1</span><span class=ow>.</span><span class=nc>Pod</span><span class=ow>{}).</span>
</span></span><span class=line><span class=cl>        <span class=nc>Complete</span><span class=ow>(</span><span class=n>r</span><span class=ow>)</span>
</span></span><span class=line><span class=cl><span class=ow>}</span>
</span></span></code></pre></td></tr></table></div></div><p>我们在<code>Owns</code>方法的定义注释中可以看到它与Watch方法其实是类似的：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>//</span> <span class=n>Owns</span> <span class=n>defines</span> <span class=n>types</span> <span class=n>of</span> <span class=n>Objects</span> <span class=n>being</span> <span class=o>*</span><span class=n>generated</span><span class=o>*</span> <span class=n>by</span> <span class=n>the</span> <span class=n>ControllerManagedBy</span><span class=p>,</span> <span class=ow>and</span> <span class=n>configures</span> <span class=n>the</span> <span class=n>ControllerManagedBy</span> <span class=n>to</span> <span class=n>respond</span> <span class=n>to</span>
</span></span><span class=line><span class=cl><span class=o>//</span> <span class=n>create</span> <span class=o>/</span> <span class=n>delete</span> <span class=o>/</span> <span class=n>update</span> <span class=n>events</span> <span class=n>by</span> <span class=o>*</span><span class=n>reconciling</span> <span class=n>the</span> <span class=n>owner</span> <span class=n>object</span><span class=o>*.</span>  <span class=n>This</span> <span class=n>is</span> <span class=n>the</span> <span class=n>equivalent</span> <span class=n>of</span> <span class=n>calling</span>
</span></span><span class=line><span class=cl><span class=o>//</span> <span class=n>Watches</span><span class=p>(</span><span class=o>&amp;</span><span class=n>handler</span><span class=o>.</span><span class=n>EnqueueRequestForOwner</span><span class=p>{</span><span class=o>&amp;</span><span class=n>source</span><span class=o>.</span><span class=n>Kind</span><span class=p>{</span><span class=n>Type</span><span class=p>:</span> <span class=o>&lt;</span><span class=n>ForType</span><span class=o>-</span><span class=n>apiType</span><span class=o>&gt;</span><span class=p>},</span> <span class=o>&amp;</span><span class=n>handler</span><span class=o>.</span><span class=n>EnqueueRequestForOwner</span><span class=p>{</span><span class=n>OwnerType</span><span class=p>:</span> <span class=n>apiType</span><span class=p>,</span> <span class=n>IsController</span><span class=p>:</span> <span class=bp>true</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=p>(</span><span class=n>blder</span> <span class=o>*</span><span class=n>Builder</span><span class=p>)</span> <span class=n>Owns</span><span class=p>(</span><span class=n>apiType</span> <span class=n>runtime</span><span class=o>.</span><span class=n>Object</span><span class=p>)</span> <span class=o>*</span><span class=n>Builder</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>blder</span><span class=o>.</span><span class=n>managedObjects</span> <span class=o>=</span> <span class=n>append</span><span class=p>(</span><span class=n>blder</span><span class=o>.</span><span class=n>managedObjects</span><span class=p>,</span> <span class=n>apiType</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>blder</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>不论是<code>For</code>,<code>Own</code>,<code>Watch</code>,都是kubebuilder中的<code>Builder</code>提供的，<code>Builder</code>是kubebuilder开放给用户构建控制器的唯一合法入口（你还可以用更hack的手段去构建，可能对源码造成入侵），它还提供了许多有用的方法，可以让我们更灵活自由地初始化一个controller。</p><p><strong>注意：kubebuilder 2.0中，构建一个reconciler时，可以用<code>Own</code>,<code>Watch</code>方法来额外监听一些资源，但是<code>For</code>方法必须要有，如果没有<code>For</code>方法，编译出来的程序运行时会报错，类似于"kind.Type should not be empty"</strong></p><h3 id=监听指定字段的变更>监听指定字段的变更</h3><p>有时候我们想让自己的代码更加清晰，让控制器的工作更有针对性。比如上文中举了一个service通过selector绑定bod的设想：我们在service的controller中list一遍service实例的selector指向的pod，并与status中的pods记录进行对比，这意味着，所有对service和pod的操作，都会触发这个操作。</p><p>我们想要在控制器watch pod资源变更时，检查pod是否变更了label，如果label没有变更，就不去执行reconcile，以此省去反复的list pod操作带来的开销。要如何实现呢？</p><h4 id=方法1添加自定义的入队predicate>方法1：添加自定义的入队predicate</h4><p><code>Builder</code>为我们提供了另一个方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-autoit data-lang=autoit><span class=line><span class=cl><span class=nb>func</span> <span class=p>(</span><span class=n>blder</span> <span class=o>*</span><span class=n>Builder</span><span class=p>)</span> <span class=n>WithEventFilter</span><span class=p>(</span><span class=n>p</span> <span class=n>predicate</span><span class=o>.</span><span class=n>Predicate</span><span class=p>)</span> <span class=o>*</span><span class=n>Builder</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>这个方法，是为Builder中<strong>每个</strong><code>Watch</code>的对象设计一个变更过滤器：<code>Predicate</code>。<code>Predicate</code>实现了几个方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-reasonml data-lang=reasonml><span class=line><span class=cl><span class=k>type</span> <span class=nc>Predicate</span> <span class=n>interface</span> <span class=ow>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Create returns true if the Create event should be processed
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nc>Create</span><span class=ow>(</span><span class=n>event</span><span class=ow>.</span><span class=nc>CreateEvent</span><span class=ow>)</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Delete returns true if the Delete event should be processed
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nc>Delete</span><span class=ow>(</span><span class=n>event</span><span class=ow>.</span><span class=nc>DeleteEvent</span><span class=ow>)</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Update returns true if the Update event should be processed
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nc>Update</span><span class=ow>(</span><span class=n>event</span><span class=ow>.</span><span class=nc>UpdateEvent</span><span class=ow>)</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Generic returns true if the Generic event should be processed
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nc>Generic</span><span class=ow>(</span><span class=n>event</span><span class=ow>.</span><span class=nc>GenericEvent</span><span class=ow>)</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl><span class=ow>}</span>
</span></span></code></pre></td></tr></table></div></div><p>我们以此设计一个自己的predicate：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>controllers</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;sigs.k8s.io/controller-runtime/pkg/predicate&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;sigs.k8s.io/controller-runtime/pkg/event&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>ResourceLabelChangedPredicate</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>predicate</span><span class=p>.</span><span class=nx>Funcs</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>rl</span> <span class=o>*</span><span class=nx>ResourceLabelChangedPredicate</span><span class=p>)</span> <span class=nf>Update</span> <span class=p>(</span><span class=nx>e</span> <span class=nx>event</span><span class=p>.</span><span class=nx>UpdateEvent</span><span class=p>)</span> <span class=kt>bool</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>!</span><span class=nf>compareMaps</span><span class=p>(</span><span class=nx>e</span><span class=p>.</span><span class=nx>MetaOld</span><span class=p>.</span><span class=nf>GetLabels</span><span class=p>(),</span> <span class=nx>e</span><span class=p>.</span><span class=nx>MetaNew</span><span class=p>.</span><span class=nf>GetLabels</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>然后修改注册控制器的方式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-reasonml data-lang=reasonml><span class=line><span class=cl><span class=n>func</span> <span class=ow>(</span><span class=n>r</span> <span class=ow>*</span><span class=nc>ServiceReconciler</span><span class=ow>)</span> <span class=nc>SetupWithManager</span><span class=ow>(</span><span class=n>mgr</span> <span class=n>ctrl</span><span class=ow>.</span><span class=nc>Manager</span><span class=ow>)</span> <span class=n>error</span> <span class=ow>{</span>
</span></span><span class=line><span class=cl>    <span class=n>return</span> <span class=n>ctrl</span><span class=ow>.</span><span class=nc>NewControllerManagedBy</span><span class=ow>(</span><span class=n>mgr</span><span class=ow>).</span>
</span></span><span class=line><span class=cl>        <span class=nc>For</span><span class=ow>(&amp;</span><span class=n>opsv1</span><span class=ow>.</span><span class=nc>Service</span><span class=ow>{}).</span><span class=nc>Watches</span><span class=ow>(&amp;</span><span class=n>source</span><span class=ow>.</span><span class=nc>Kind</span><span class=ow>{</span><span class=nc>Type</span><span class=ow>:</span> <span class=ow>&amp;</span><span class=n>opsv1</span><span class=ow>.</span><span class=nc>Pod</span><span class=ow>{}},</span> <span class=ow>&amp;</span><span class=n>handler</span><span class=ow>.</span><span class=nc>EnqueueRequestForObject</span><span class=ow>{}).</span><span class=nc>WithEventFilter</span><span class=ow>(&amp;</span><span class=nc>ResourceLabelChangedPredicate</span><span class=ow>{}).</span>
</span></span><span class=line><span class=cl>        <span class=nc>Complete</span><span class=ow>(</span><span class=n>r</span><span class=ow>)</span>
</span></span><span class=line><span class=cl><span class=ow>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这样，<code>ServiceReconciler</code>在监听其关注的对象时，只会关注对象的label是否发生变更，只有当label发生变更时，才会入队并进入<code>reconcile</code>逻辑。</p><p>这个方法目前看应该是kubebuilder团队推荐使用的方法，但是有个问题是，<strong>加入了predicate后，会在<code>Reconciler</code>关注的所有的对象上生效</strong>。也就是说即使Service实例的label发生变更，也会触发<code>reconcile</code>。这不是我们想看到的,我们想看到的是Service的selector变更时会进行reconcile。这时候我们可能就需要在predicate中增加对象类型的判断，比如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=k>func</span> <span class=p>(</span><span class=n>rl</span> <span class=o>*</span><span class=n>ResourceLabelChangedPredicate</span><span class=p>)</span> <span class=n>Update</span> <span class=p>(</span><span class=n>e</span> <span class=n>event</span><span class=o>.</span><span class=n>UpdateEvent</span><span class=p>)</span> <span class=ne>bool</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>oldobj</span><span class=p>,</span> <span class=n>ok1</span> <span class=p>:</span><span class=o>=</span> <span class=n>e</span><span class=o>.</span><span class=n>ObjectOld</span><span class=o>.</span><span class=p>(</span><span class=o>*</span><span class=n>opsv1</span><span class=o>.</span><span class=n>Service</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>newobj</span><span class=p>,</span> <span class=n>ok2</span> <span class=p>:</span><span class=o>=</span> <span class=n>e</span><span class=o>.</span><span class=n>ObjectNew</span><span class=o>.</span><span class=p>(</span><span class=o>*</span><span class=n>opsv1</span><span class=o>.</span><span class=n>Service</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>ok1</span> <span class=o>&amp;&amp;</span> <span class=n>ok2</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>!</span><span class=n>compareMaps</span><span class=p>(</span><span class=n>oldobj</span><span class=o>.</span><span class=n>Spec</span><span class=o>.</span><span class=n>Selector</span><span class=p>,</span> <span class=n>newobj</span><span class=o>.</span><span class=n>Spec</span><span class=o>.</span><span class=n>Selector</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>true</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>false</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>_</span><span class=p>,</span> <span class=n>ok1</span> <span class=o>=</span> <span class=n>e</span><span class=o>.</span><span class=n>ObjectOld</span><span class=o>.</span><span class=p>(</span><span class=o>*</span><span class=n>opsv1</span><span class=o>.</span><span class=n>Pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>_</span><span class=p>,</span> <span class=n>ok2</span> <span class=o>=</span> <span class=n>e</span><span class=o>.</span><span class=n>ObjectNew</span><span class=o>.</span><span class=p>(</span><span class=o>*</span><span class=n>opsv1</span><span class=o>.</span><span class=n>Pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>ok1</span> <span class=o>&amp;&amp;</span> <span class=n>ok2</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>!</span><span class=n>compareMaps</span><span class=p>(</span><span class=n>e</span><span class=o>.</span><span class=n>MetaOld</span><span class=o>.</span><span class=n>GetLabels</span><span class=p>(),</span> <span class=n>e</span><span class=o>.</span><span class=n>MetaNew</span><span class=o>.</span><span class=n>GetLabels</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>true</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=bp>false</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>记得通过注释添加rbac：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=o>//</span><span class=w> </span><span class=o>+</span><span class=n>kubebuilder</span><span class=p>:</span><span class=n>rbac</span><span class=p>:</span><span class=n>groups</span><span class=o>=</span><span class=s2>&#34;&#34;</span><span class=p>,</span><span class=n>resources</span><span class=o>=</span><span class=n>pods</span><span class=p>,</span><span class=n>verbs</span><span class=o>=</span><span class=k>get</span><span class=p>;</span><span class=n>list</span><span class=p>;</span><span class=n>watch</span><span class=p>;</span><span class=k>create</span><span class=p>;</span><span class=k>update</span><span class=p>;</span><span class=n>patch</span><span class=p>;</span><span class=k>delete</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=方法2自定义一个入队器>方法2：自定义一个入队器</h4><p>我们先看上面提到的<code>Watch</code>方法，这个方法允许用户自己设计<code>handler.EventHandler</code>接口，这个接口实现了<code>Create</code>,<code>Update</code>,<code>Delete</code>,<code>Generic</code>方法，用来在资源实例的不同生命阶段，进行判断与入队。</p><p>在<code>sigs.k8s.io/controller-runtime/pkg/handler/enqueue.go</code>中就有一个默认的实现:<code>EnqueueRequestForObject</code>。我们可以参考它设计一个自己的接口实现——名为<code>EnqueueRequestForLabelChanged</code>的入队器.</p><p>重写该入队器的<code>Update</code>方法，改为判断新旧两个实例的label是否一致，不一致则进行入队：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-stylus data-lang=stylus><span class=line><span class=cl><span class=err>func</span> <span class=p>(</span><span class=err>e</span> <span class=o>*</span><span class=err>EnqueueRequest</span><span class=k>For</span><span class=err>LabelChanged</span><span class=p>)</span> <span class=nd>Update</span><span class=p>(</span><span class=err>evt</span> <span class=err>event</span><span class=p>.</span><span class=nc>UpdateEvent</span><span class=p>,</span> <span class=nt>q</span> <span class=err>workqueue</span><span class=p>.</span><span class=nc>RateLimitingInterface</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nv>!compareMaps</span><span class=p>(</span><span class=err>evt</span><span class=p>.</span><span class=nc>MetaOld</span><span class=p>.</span><span class=nc>GetLabels</span><span class=p>(),</span> <span class=err>evt</span><span class=p>.</span><span class=nc>MetaNew</span><span class=p>.</span><span class=nc>GetLabels</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>q</span><span class=p>.</span><span class=nc>Add</span><span class=p>(</span><span class=err>reconcile</span><span class=p>.</span><span class=nc>Request</span><span class=p>{</span><span class=err>NamespacedName</span><span class=p>:</span> <span class=err>types</span><span class=p>.</span><span class=nc>NamespacedName</span><span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=err>Name</span><span class=p>:</span> <span class=err>evt</span><span class=p>.</span><span class=nc>MetaNew</span><span class=p>.</span><span class=nc>GetName</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=err>Namespace</span><span class=p>:</span> <span class=err>evt</span><span class=p>.</span><span class=nc>MetaNew</span><span class=p>.</span><span class=nc>GetNamespace</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=p>}})</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>注册reconciler时，watches的eventhandler参数使用自定义的enqueue：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-reasonml data-lang=reasonml><span class=line><span class=cl><span class=n>func</span> <span class=ow>(</span><span class=n>r</span> <span class=ow>*</span><span class=nc>PlaybookReconciler</span><span class=ow>)</span> <span class=nc>SetupWithManager</span><span class=ow>(</span><span class=n>mgr</span> <span class=n>ctrl</span><span class=ow>.</span><span class=nc>Manager</span><span class=ow>)</span> <span class=n>error</span> <span class=ow>{</span>
</span></span><span class=line><span class=cl>    <span class=n>return</span> <span class=n>ctrl</span><span class=ow>.</span><span class=nc>NewControllerManagedBy</span><span class=ow>(</span><span class=n>mgr</span><span class=ow>).</span>
</span></span><span class=line><span class=cl>        <span class=nc>For</span><span class=ow>(&amp;</span><span class=n>opsv1</span><span class=ow>.</span><span class=nc>Playbook</span><span class=ow>{}).</span><span class=nc>Watches</span><span class=ow>(&amp;</span><span class=n>source</span><span class=ow>.</span><span class=nc>Kind</span><span class=ow>{</span><span class=nc>Type</span><span class=ow>:</span> <span class=ow>&amp;</span><span class=n>opsv1</span><span class=ow>.</span><span class=nc>Bucket</span><span class=ow>{}},</span> <span class=ow>&amp;</span><span class=nc>EnqueueRequestForLabelChanged</span><span class=ow>{}).</span>
</span></span><span class=line><span class=cl>        <span class=nc>Complete</span><span class=ow>(</span><span class=n>r</span><span class=ow>)</span>
</span></span><span class=line><span class=cl><span class=ow>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这样，ServiceReconciler将会监听service资源的所有变更，以及pod资源的label变更。</p><p>记得通过注释添加rbac：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=o>//</span><span class=w> </span><span class=o>+</span><span class=n>kubebuilder</span><span class=p>:</span><span class=n>rbac</span><span class=p>:</span><span class=n>groups</span><span class=o>=</span><span class=s2>&#34;&#34;</span><span class=p>,</span><span class=n>resources</span><span class=o>=</span><span class=n>pods</span><span class=p>,</span><span class=n>verbs</span><span class=o>=</span><span class=k>get</span><span class=p>;</span><span class=n>list</span><span class=p>;</span><span class=n>watch</span><span class=p>;</span><span class=k>create</span><span class=p>;</span><span class=k>update</span><span class=p>;</span><span class=n>patch</span><span class=p>;</span><span class=k>delete</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=best-way-to-watch>best way to watch</h4><p>通过前文我们了解到：</p><ol><li>使用<code>WithEventFilter</code>配置变更过滤器，可以针对<code>reconciler</code>watch的所有资源，统一地设置事件监听规则；</li><li>使用自己实现的<code>EventHandler</code>,可以在<code>reconciler</code>watch特定资源时，设置该资源的事件监听规则。</li></ol><p>阅读controller-runtime的代码我们会发现，官方允许用户调用<code>WithEventFilter</code>配置变更过滤器，但没有提供一个公开的方法让用户配置入队器，用户只能自己主动实现。其实在1.X的kubebuilder中，<code>Watch</code>方法允许用户配置predicate，用户可以给不同资源配置不同的变更过滤器。但在2.0中，这个函数被重新封装，不再直接开放给用户。取而代之的是用<code>WithEventFilter</code>方法配置应用到所有资源的变更过滤器。</p><p>可能设计者认为，一个<code>reconciler</code>要负责的应该是一个/多个资源对象的一种/同种变化。</p><p>事实上，在开发operator的过程中，最好也是将一个reconciler的工作内容细粒度化。特别是：<strong>不应该在一个reconciler逻辑中进行两次资源的update（update status除外），否则会引发版本不一致的报错</strong>。</p><h3 id=使用非缓存的client>使用非缓存的client</h3><p>Reconciler中的<code>client.Client</code>是一个结构，提供了Get，List，Update，Delete等一系列k8s client的操作，但是其Get，List方法均是从cache中获取数据，如果Reconciler同步数据不及时（需要注意，实际上同步数据的是manager中的成员对象：cache，Reconciler直接引用了该对象），获取到的就是脏数据。</p><p>与EventRecorder类似地， manger中其实也初始化好了一个即时的client：apiReader，供我们使用，只需要调用<code>mgr.GetAPIReader()</code>即可获取。</p><p>注意到apiReader是一个只读client，，其使用方法与Reconciler的Client类似（Get方法，List方法）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-reasonml data-lang=reasonml><span class=line><span class=cl><span class=n>r</span><span class=ow>.</span><span class=nn>ApiReader</span><span class=p>.</span><span class=nc>Get</span><span class=ow>(</span><span class=n>ctx</span><span class=ow>,</span> <span class=n>req</span><span class=ow>.</span><span class=nc>NamespacedName</span><span class=ow>,</span> <span class=n>bucket</span><span class=ow>)</span>
</span></span></code></pre></td></tr></table></div></div><p>官方建议我们直接使用带cache的client即可，该client是一个分离的client，其读方法（get，list）均从一个cache中获取数据。写方法则直接更新到apiserver。</p><h2 id=多版本切换>多版本切换</h2><p>在crd的开发和演进过程中，必然会存在一个crd的不同版本。 kubebuilder支持以一个<code>conversion webhook</code>的方式，支持对一个crd资源以不同版本进行读取。简单地描述就是：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-awk data-lang=awk><span class=line><span class=cl><span class=nx>kubectl</span> <span class=nx>apply</span> <span class=o>-</span><span class=nx>f</span> <span class=nx>config</span><span class=o>/</span><span class=nx>samples</span><span class=o>/</span><span class=nx>batch_v2_cronjob</span><span class=p>.</span><span class=nx>yaml</span>
</span></span></code></pre></td></tr></table></div></div><p>创建一个v2的cronjob后，可以通过v1和v2两种版本进行读取：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-stylus data-lang=stylus><span class=line><span class=cl><span class=err>kubectl</span> <span class=err>get</span> <span class=err>cronjobs</span><span class=p>.</span><span class=nc>v2</span><span class=p>.</span><span class=nc>batch</span><span class=p>.</span><span class=nc>tutorial</span><span class=p>.</span><span class=nc>kubebuilder</span><span class=p>.</span><span class=nc>io</span> <span class=o>-</span><span class=err>o</span> <span class=err>yaml</span>
</span></span><span class=line><span class=cl><span class=err>kubectl</span> <span class=err>get</span> <span class=err>cronjobs</span><span class=p>.</span><span class=nc>v1</span><span class=p>.</span><span class=nc>batch</span><span class=p>.</span><span class=nc>tutorial</span><span class=p>.</span><span class=nc>kubebuilder</span><span class=p>.</span><span class=nc>io</span> <span class=o>-</span><span class=err>o</span> <span class=err>yaml</span>
</span></span></code></pre></td></tr></table></div></div><p>显然，get命令得到的v1和v2版本的cronjob会存在一些字段上的不同，<code>conversion webhook</code>会负责进行不同版本的cronjob之间的数据转换。</p><p>贴下学习资料：</p><p><a href=https://book.kubebuilder.io/m target=_blank rel="external nofollow noopener noreferrer">https://book.kubebuilder.io/m</a>&mldr;</p><h2 id=在webhook中使用client>在webhook中使用client</h2><p>有时候我们需要在某个对象的webhook中查询集群中的其他资源，比如某个operator规定了一个<code>PodBox</code>,规定每个PodBox中只能有一个Pod，那么在validatecreate的webhook中就要ListPod By PodBox并计数。</p><p>kubebuilder 2.X 将webhook封装得太过简介，所以我们需要搞个新法子：</p><p>我们在types和webhook的目录下新建一个文件， 在里面构建一个全局client：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-stylus data-lang=stylus><span class=line><span class=cl><span class=err>package</span> <span class=err>v1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=err>ctrl</span> <span class=err>&#34;sigs</span><span class=p>.</span><span class=nc>k8s</span><span class=p>.</span><span class=nc>io</span><span class=o>/</span><span class=err>controller</span><span class=o>-</span><span class=err>runtime&#34;</span>
</span></span><span class=line><span class=cl>    <span class=err>&#34;sigs</span><span class=p>.</span><span class=nc>k8s</span><span class=p>.</span><span class=nc>io</span><span class=o>/</span><span class=err>controller</span><span class=o>-</span><span class=err>runtime</span><span class=o>/</span><span class=err>pkg</span><span class=o>/</span><span class=err>client&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>var</span> <span class=err>globalClient</span> <span class=err>client</span><span class=p>.</span><span class=nc>Client</span>
</span></span><span class=line><span class=cl><span class=nt>var</span> <span class=err>globalReader</span> <span class=err>client</span><span class=p>.</span><span class=nc>Reader</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>func</span> <span class=nd>InitClient</span><span class=p>(</span><span class=err>mgr</span> <span class=err>ctrl</span><span class=p>.</span><span class=nc>Manager</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=err>globalClient</span> <span class=o>=</span> <span class=err>mgr</span><span class=p>.</span><span class=nc>GetClient</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=err>globalReader</span> <span class=o>=</span> <span class=err>mgr</span><span class=p>.</span><span class=nc>GetAPIReader</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在 main.go中， 各种<code>SetupWithManager</code>之前，先执行InitClient，初始化这些client， validateCreate方法中可以直接使用这些client。</p><h2 id=添加自定义的webhook>添加自定义的webhook</h2><p>我们开发的operator可能会需要对用户新建的pod进行注入，比如注入一些信息到annotations中， 也有可能要对原生对象的更新/删除操作进行判断，那么如何在我们的项目中添加这些对象的webhook？</p><p>社区提供了一个案例：<a href=https://github.com/kubernetes target=_blank rel="external nofollow noopener noreferrer">https://github.com/kubernetes</a>&mldr;</p><p>但是在该案例下，每次执行<code>make generate</code>时 会报错：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gradle data-lang=gradle><span class=line><span class=cl><span class=n>invalid</span> <span class=n>field</span> <span class=n>type</span> <span class=n>interface</span><span class=o>{</span><span class=n>sigs</span><span class=o>.</span><span class=na>k8s</span><span class=o>.</span><span class=na>io</span><span class=s>/controller-runtime/</span><span class=n>pkg</span><span class=s>/client.Reader; sigs.k8s.io/</span><span class=n>controller</span><span class=o>-</span><span class=n>runtime</span><span class=s>/pkg/</span><span class=n>client</span><span class=o>.</span><span class=na>StatusClient</span><span class=o>;</span> <span class=n>sigs</span><span class=o>.</span><span class=na>k8s</span><span class=o>.</span><span class=na>io</span><span class=s>/controller-runtime/</span><span class=n>pkg</span><span class=o>/</span><span class=n>client</span><span class=o>.</span><span class=na>Writer</span><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>不过测试了一下 只要不执行generate，其他步骤都可以正常执行， 比如 <code>make docker-build</code></p><h2 id=使用索引>使用索引</h2><p>client-go支持构建带索引的缓存，并且允许用户自定义索引函数的名称和内容。当缓存的数据带有索引时，我们可以更快地通过索引List到想要的数据，既可以提高性能又可以减少代码量。</p><p>kubebuilder 2.0 提供了很简单的索引构建方式。 比如我们要以pod中的spec.NodeName为索引， 方便我们快速List查询某个节点上的pod：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-stylus data-lang=stylus><span class=line><span class=cl><span class=o>//</span> <span class=err>要先构建好manager</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>mgr</span><span class=p>.</span><span class=nc>GetFieldIndexer</span><span class=p>().</span><span class=nc>IndexField</span><span class=p>(</span><span class=k>&amp;</span><span class=err>v1</span><span class=p>.</span><span class=nc>Pod</span><span class=p>{},</span> <span class=err>&#34;indexNodeNameOfPod&#34;</span><span class=p>,</span> <span class=nd>func</span><span class=p>(</span><span class=err>o</span> <span class=err>runtime</span><span class=p>.</span><span class=nc>Object</span><span class=p>)</span> <span class=p>[]</span><span class=err>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=err>v</span> <span class=p>:</span><span class=o>=</span> <span class=err>o</span><span class=o>.</span><span class=p>(</span><span class=o>*</span><span class=err>v1</span><span class=p>.</span><span class=nc>Pod</span><span class=p>).</span><span class=nc>Spec</span><span class=p>.</span><span class=nc>NodeName</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[]</span><span class=err>string</span><span class=p>{</span><span class=err>v</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=o>//</span> <span class=err>使用manager的client进行List</span>
</span></span><span class=line><span class=cl><span class=err>podList</span> <span class=p>:</span><span class=o>=</span> <span class=k>&amp;</span><span class=err>v1</span><span class=p>.</span><span class=nc>PodList</span><span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=err>err</span> <span class=p>:</span><span class=o>=</span> <span class=err>mgr</span><span class=p>.</span><span class=nc>GetClient</span><span class=p>().</span><span class=nc>List</span><span class=p>(</span><span class=err>context</span><span class=p>.</span><span class=nc>TODO</span><span class=p>(),</span> <span class=err>podList</span><span class=p>,</span> <span class=k>&amp;</span><span class=err>client</span><span class=p>.</span><span class=nc>MatchingFields</span><span class=p>{</span><span class=err>&#34;indexNodeNameOfPod&#34;</span><span class=p>:</span> <span class=err>node</span><span class=p>.</span><span class=nc>Name</span><span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=参考资料>参考资料</h3><p><a href=https://segmentfault.com/a/1190000020359577 target=_blank rel="external nofollow noopener noreferrer">kubebuilder2.0学习笔记——进阶使用</a></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="2023-10-24 14:41:48">更新于 2023-10-24</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a href=/sre/posts/4fe3f9/index.md title=阅读原始文档 class=link-to-markdown>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://www.kbsonlong.com/sre/posts/4fe3f9/ data-title=kubebuilder2.0学习笔记——进阶使用 data-hashtags=kubebuilder><i class="fa-brands fa-twitter fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://www.kbsonlong.com/sre/posts/4fe3f9/ data-hashtag=kubebuilder><i class="fa-brands fa-facebook-square fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 WhatsApp" data-sharer=whatsapp data-url=https://www.kbsonlong.com/sre/posts/4fe3f9/ data-title=kubebuilder2.0学习笔记——进阶使用 data-web><i class="fa-brands fa-whatsapp fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=https://www.kbsonlong.com/sre/posts/4fe3f9/ data-title=kubebuilder2.0学习笔记——进阶使用><i data-svg-src=/sre/lib/simple-icons/icons/line.min.svg></i></a>
<a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://www.kbsonlong.com/sre/posts/4fe3f9/ data-title=kubebuilder2.0学习笔记——进阶使用><i class="fa-brands fa-weibo fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 Myspace" data-sharer=myspace data-url=https://www.kbsonlong.com/sre/posts/4fe3f9/ data-title=kubebuilder2.0学习笔记——进阶使用 data-description><i data-svg-src=/sre/lib/simple-icons/icons/myspace.min.svg></i></a>
<a href=javascript:void(0); title="分享到 Blogger" data-sharer=blogger data-url=https://www.kbsonlong.com/sre/posts/4fe3f9/ data-title=kubebuilder2.0学习笔记——进阶使用 data-description><i class="fa-brands fa-blogger fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 Evernote" data-sharer=evernote data-url=https://www.kbsonlong.com/sre/posts/4fe3f9/ data-title=kubebuilder2.0学习笔记——进阶使用><i class="fa-brands fa-evernote fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw"></i>&nbsp;<a href=/sre/tags/kubebuilder/>Kubebuilder</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/sre/>主页</a></span></section></div><div class=post-nav><a href=/sre/posts/f269d7/ class=prev rel=prev title="Docker 运行 Android 云手机"><i class="fa-solid fa-angle-left fa-fw"></i>Docker 运行 Android 云手机</a>
<a href=/sre/posts/169f99/ class=next rel=next title=Karmada多集群部署>Karmada多集群部署<i class="fa-solid fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=giscus><script src=https://giscus.app/client.js data-repo=kbsonlong/devops.alongparty.cn data-repo-id=R_kgDOHE7F-Q data-category=Announcements data-category-id=DIC_kwDOHE7F-c4CPP5J data-mapping=title data-theme=preferred_color_scheme data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-lang=zh-CN data-loading=lazy crossorigin=anonymous async defer></script><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app/ rel="external nofollow noopener noreferrer">giscus</a>.</noscript></div></div></article></main><footer class=footer><div class=footer-container><div class="footer-line copyright"><i class="fa-regular fa-copyright fa-fw"></i>
<span itemprop=copyrightYear>2018 - 2024</span><span class=author itemprop=copyrightHolder>
<a href=/sre/>kbsonlong</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class="footer-line statistics"></div><div class="footer-line ibruce"><span id=busuanzi_container_site_uv title=总访客数><i class="fa-regular fa-user fa-fw"></i>&nbsp;<span id=busuanzi_value_site_uv><i class="fa fa-spinner fa-spin fa-fw"></i></span></span><span id=busuanzi_container_site_pv class=footer-divider title=总访问量><i class="fa-regular fa-eye fa-fw"></i>&nbsp;<span id=busuanzi_value_site_pv><i class="fa fa-spinner fa-spin fa-fw"></i></span></span></div><div class="footer-line beian"><span class="icp footer-divider"><a target=_blank href=https://beian.miit.gov.cn/>粤ICP备18122209号</a></span></div></div></footer></div><div class=widgets><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fa-solid fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fa-solid fa-comment fa-fw"></i></a></div><a href=https://github.com/kbsonlong title="在 GitHub 上查看源代码" target=_blank rel="external nofollow noopener noreferrer" class="github-corner right d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div id=mask></div></div><link rel=stylesheet href=/sre/lib/katex/katex.min.css><link rel=stylesheet href=/sre/lib/katex/copy-tex.min.css><link rel=stylesheet href=/sre/lib/cookieconsent/cookieconsent.min.css><script type=text/javascript src=/sre/lib/autocomplete/autocomplete.min.js defer></script><script type=text/javascript src=/sre/lib/algoliasearch/algoliasearch-lite.umd.min.js defer></script><script type=text/javascript src=/sre/lib/lazysizes/lazysizes.min.js async defer></script><script type=text/javascript src=/sre/lib/sharer/sharer.min.js async defer></script><script type=text/javascript src=/sre/lib/katex/katex.min.js defer></script><script type=text/javascript src=/sre/lib/katex/auto-render.min.js defer></script><script type=text/javascript src=/sre/lib/katex/copy-tex.min.js defer></script><script type=text/javascript src=/sre/lib/katex/mhchem.min.js defer></script><script type=text/javascript src=/sre/lib/cookieconsent/cookieconsent.min.js defer></script><script type=text/javascript src=/sre/lib/pangu/pangu.min.js defer></script><script type=text/javascript src=/sre/lib/cell-watermark/watermark.min.js defer></script><script type=text/javascript src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async defer></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:10},comment:{giscus:{darkTheme:"dark",lightTheme:"light"}},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},enablePWA:!0,enablePangu:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"WFOR67TML1",algoliaIndex:"along",algoliaSearchKey:"ea1fe535f9a7ae353f3922489c829cc1",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"},watermark:{appendto:".wrapper>main",colspacing:30,content:'<img class="fixit-icon" src="/favicon-16x16.png" alt="FixIt logo" /> FixIt 主题',enable:!0,fontfamily:"inherit",fontsize:.85,height:21,opacity:.0125,rotate:15,rowspacing:60,width:150}}</script><script type=text/javascript src=/sre/js/theme.min.js defer></script><script type=text/javascript src=/sre/js/_custom.min.js defer></script></body></html>