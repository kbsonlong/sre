<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><meta http-equiv=X-UA-Compatible content="IE=edge, chrome=1"><title>Prometheus Operator 常用指标 - 蜷缩的蜗牛</title><meta name=author content="kbsonlong">
<meta name=author-link content><meta name=description content='Prometheus Operator 安装完成后会有很多默认的监控指标，一不注意就大量的报警产生，所以我们非常有必要了解下这些常用的监控指标，有部分指标很有可能对于我们自己的业务可有可无，所以可以适当的进行修改，这里我们就来对常用的几个指标进行简单的说明。
1. Kubernetes 资源相关
1.1 CPUThrottlingHigh
关于 CPU 的 limit 合理性指标。查出最近5分钟，超过25%的 CPU 执行周期受到限制的容器。表达式：


1
2
3
4


sum(increase(container_cpu_cfs_throttled_periods_total{container!="", }[5m])) by (container, pod, namespace)
          /
sum(increase(container_cpu_cfs_periods_total{}[5m])) by (container, pod, namespace)
          > ( 25 / 100 )


相关指标：



container_cpu_cfs_periods_total：容器生命周期中度过的 cpu 周期总数


container_cpu_cfs_throttled_periods_total：容器生命周期中度过的受限的 cpu 周期总数
'><meta name=keywords content='prometheus,monitor'><meta itemprop=name content="Prometheus Operator 常用指标"><meta itemprop=description content='Prometheus Operator 安装完成后会有很多默认的监控指标，一不注意就大量的报警产生，所以我们非常有必要了解下这些常用的监控指标，有部分指标很有可能对于我们自己的业务可有可无，所以可以适当的进行修改，这里我们就来对常用的几个指标进行简单的说明。
1. Kubernetes 资源相关
1.1 CPUThrottlingHigh
关于 CPU 的 limit 合理性指标。查出最近5分钟，超过25%的 CPU 执行周期受到限制的容器。表达式：


1
2
3
4


sum(increase(container_cpu_cfs_throttled_periods_total{container!="", }[5m])) by (container, pod, namespace)
          /
sum(increase(container_cpu_cfs_periods_total{}[5m])) by (container, pod, namespace)
          > ( 25 / 100 )


相关指标：



container_cpu_cfs_periods_total：容器生命周期中度过的 cpu 周期总数


container_cpu_cfs_throttled_periods_total：容器生命周期中度过的受限的 cpu 周期总数
'><meta itemprop=datePublished content="2022-09-13T17:53:07+08:00"><meta itemprop=dateModified content="2022-09-13T17:53:07+08:00"><meta itemprop=wordCount content="5699"><meta itemprop=image content="https://www.kbsonlong.com/sre/logo_transparent.png"><meta itemprop=keywords content="prometheus,monitor,"><meta property="og:title" content="Prometheus Operator 常用指标"><meta property="og:description" content='Prometheus Operator 安装完成后会有很多默认的监控指标，一不注意就大量的报警产生，所以我们非常有必要了解下这些常用的监控指标，有部分指标很有可能对于我们自己的业务可有可无，所以可以适当的进行修改，这里我们就来对常用的几个指标进行简单的说明。
1. Kubernetes 资源相关
1.1 CPUThrottlingHigh
关于 CPU 的 limit 合理性指标。查出最近5分钟，超过25%的 CPU 执行周期受到限制的容器。表达式：


1
2
3
4


sum(increase(container_cpu_cfs_throttled_periods_total{container!="", }[5m])) by (container, pod, namespace)
          /
sum(increase(container_cpu_cfs_periods_total{}[5m])) by (container, pod, namespace)
          > ( 25 / 100 )


相关指标：



container_cpu_cfs_periods_total：容器生命周期中度过的 cpu 周期总数


container_cpu_cfs_throttled_periods_total：容器生命周期中度过的受限的 cpu 周期总数
'><meta property="og:type" content="article"><meta property="og:url" content="https://www.kbsonlong.com/sre/posts/prometheus-operator-commonly-used-indicators/"><meta property="og:image" content="https://www.kbsonlong.com/sre/logo_transparent.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-09-13T17:53:07+08:00"><meta property="article:modified_time" content="2022-09-13T17:53:07+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.kbsonlong.com/sre/logo_transparent.png"><meta name=twitter:title content="Prometheus Operator 常用指标"><meta name=twitter:description content='Prometheus Operator 安装完成后会有很多默认的监控指标，一不注意就大量的报警产生，所以我们非常有必要了解下这些常用的监控指标，有部分指标很有可能对于我们自己的业务可有可无，所以可以适当的进行修改，这里我们就来对常用的几个指标进行简单的说明。
1. Kubernetes 资源相关
1.1 CPUThrottlingHigh
关于 CPU 的 limit 合理性指标。查出最近5分钟，超过25%的 CPU 执行周期受到限制的容器。表达式：


1
2
3
4


sum(increase(container_cpu_cfs_throttled_periods_total{container!="", }[5m])) by (container, pod, namespace)
          /
sum(increase(container_cpu_cfs_periods_total{}[5m])) by (container, pod, namespace)
          > ( 25 / 100 )


相关指标：



container_cpu_cfs_periods_total：容器生命周期中度过的 cpu 周期总数


container_cpu_cfs_throttled_periods_total：容器生命周期中度过的受限的 cpu 周期总数
'><meta name=application-name content="FixIt"><meta name=apple-mobile-web-app-title content="FixIt"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#252627"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://www.kbsonlong.com/sre/posts/prometheus-operator-commonly-used-indicators/><link rel=prev href=https://www.kbsonlong.com/sre/posts/istio-performance-index/><link rel=next href=https://www.kbsonlong.com/sre/posts/iptable-concept/><link rel=stylesheet href=/sre/lib/normalize/normalize.min.css><link rel=stylesheet href=/sre/css/style.min.css><link rel=stylesheet href=/sre/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/sre/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Prometheus Operator 常用指标","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/www.kbsonlong.com\/sre\/posts\/prometheus-operator-commonly-used-indicators\/"},"genre":"posts","keywords":"prometheus, monitor","wordcount":5699,"url":"https:\/\/www.kbsonlong.com\/sre\/posts\/prometheus-operator-commonly-used-indicators\/","datePublished":"2022-09-13T17:53:07+08:00","dateModified":"2022-09-13T17:53:07+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"kbsonlong"},"description":""}</script></head><body header-desktop=sticky header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper github-corner=right><div class=header-title><a href=/sre/ title=蜷缩的蜗牛><img class="lazyload logo" src=/sre/svg/loading.min.svg data-src=/sre/logo_transparent.png data-srcset="/sre/logo_transparent.png, /sre/logo_transparent.png 1.5x, /sre/logo_transparent.png 2x" data-sizes=auto alt=蜷缩的蜗牛 title=蜷缩的蜗牛><span class=header-title-text>蜷缩的蜗牛</span></a><span class=header-subtitle></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/sre/posts/><i class='fa-solid fa-archive fa-fw fa-sm'></i> 文章</a></li><li class=menu-item><a class=menu-link href=/sre/categories/><i class='fa-solid fa-th fa-fw fa-sm'></i> 分类</a></li><li class=menu-item><a class=menu-link href=/sre/tags/><i class='fa-solid fa-tags fa-fw fa-sm'></i> 标签</a></li><li class=menu-item><a class=menu-link href=/sre/friends/ title=友情链接><i class='fa-solid fa-users fa-fw fa-sm'></i> 友链</a></li><li class=menu-item><a class=menu-link href=/sre/about/><i class='fa-solid fa-info-circle fa-fw fa-sm'></i> 关于</a></li><li class="menu-item d-none-desktop text-center"><a class=menu-link href=https://github.com/kbsonlong/ title=GitHub rel="noopener noreferrer" target=_blank><i class='fa-brands fa-github fa-fw'></i></a></li><li class="menu-item d-none-desktop text-center"><a class=menu-link href=/sre/messages/><i class='fa-solid fa-messages'></i> 留言板</a></li><li class=menu-item><a class=menu-link href=/sre/messages/ title=留言板>留言板</a></li><li class="menu-item delimiter"></li><li class="menu-item language"><span title=选择语言>简体中文<i class="dropdown-icon fa-solid fa-chevron-down"></i></span><ul class=sub-menu><li class=menu-item>没有更多翻译</li></ul></li><li class="menu-item search" id=search-desktop><input type=text placeholder="搜索文章标题或内容 ..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw"></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw"></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin"></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw"></i></li></ul></nav></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/sre/ title=蜷缩的蜗牛><img class="lazyload logo" src=/sre/svg/loading.min.svg data-src=/sre/logo_transparent.png data-srcset="/sre/logo_transparent.png, /sre/logo_transparent.png 1.5x, /sre/logo_transparent.png 2x" data-sizes=auto alt=/sre/logo_transparent.png title=/sre/logo_transparent.png><span class=header-title-text>蜷缩的蜗牛</span></a><span class=header-subtitle></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="搜索文章标题或内容 ..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw"></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw"></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><a class=menu-link href=/sre/posts/><i class='fa-solid fa-archive fa-fw fa-sm'></i> 文章</a></li><li class=menu-item><a class=menu-link href=/sre/categories/><i class='fa-solid fa-th fa-fw fa-sm'></i> 分类</a></li><li class=menu-item><a class=menu-link href=/sre/tags/><i class='fa-solid fa-tags fa-fw fa-sm'></i> 标签</a></li><li class=menu-item><a class=menu-link href=/sre/friends/ title=友情链接><i class='fa-solid fa-users fa-fw fa-sm'></i> 友链</a></li><li class=menu-item><a class=menu-link href=/sre/about/><i class='fa-solid fa-info-circle fa-fw fa-sm'></i> 关于</a></li><li class="menu-item d-none-desktop text-center"><a class=menu-link href=https://github.com/kbsonlong/ title=GitHub rel="noopener noreferrer" target=_blank><i class='fa-brands fa-github fa-fw'></i></a></li><li class="menu-item d-none-desktop text-center"><a class=menu-link href=/sre/messages/><i class='fa-solid fa-messages'></i> 留言板</a></li><li class=menu-item><a class=menu-link href=/sre/messages/ title=留言板>留言板</a></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw"></i></li><li class="menu-item language"><span title=选择语言>简体中文<i class="dropdown-icon fa-solid fa-chevron-down"></i>
</span><select class=language-select onchange="location=this.value"><option disabled>没有更多翻译</option></select></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=container page-style=normal><aside class=toc id=toc-auto><h2 class=toc-title>目录 <i class="toc-icon fa-solid fa-angle-down fa-fw"></i></h2><div class=toc-content id=toc-content-auto></div></aside><aside class=aside-custom></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>Prometheus Operator 常用指标</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><img class="lazyload avatar" src=/sre/svg/loading.min.svg data-src="https://gravatar.loli.net/avatar/598872715ec08296cf1e1806135cd518?s=32&amp;d=mp" data-srcset="https://gravatar.loli.net/avatar/598872715ec08296cf1e1806135cd518?s=32&amp;d=mp, https://gravatar.loli.net/avatar/598872715ec08296cf1e1806135cd518?s=32&amp;d=mp 1.5x, https://gravatar.loli.net/avatar/598872715ec08296cf1e1806135cd518?s=32&amp;d=mp 2x" data-sizes=auto alt=kbsonlong title=kbsonlong>&nbsp;kbsonlong</span></span>
<span class=post-category>收录于 <a href=/sre/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/><i class="fa-regular fa-folder fa-fw"></i>&nbsp;云原生</a></span></div><div class=post-meta-line><span title="2022-09-13 17:53:07"><i class="fa-regular fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2022-09-13>2022-09-13</time>
</span>&nbsp;<i class="fa-solid fa-pencil-alt fa-fw"></i>&nbsp;约 5699 字&nbsp;
<i class="fa-regular fa-clock fa-fw"></i>&nbsp;预计阅读 12 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#1-kubernetes-资源相关>1. Kubernetes 资源相关</a><ul><li><a href=#11-cputhrottlinghigh>1.1 CPUThrottlingHigh</a></li><li><a href=#12-kubecpuovercommit>1.2 KubeCPUOvercommit</a></li><li><a href=#13-kubememoryovercommit>1.3 KubeMemoryOvercommit</a></li><li><a href=#14-kubecpuquotaovercommit>1.4 KubeCPUQuotaOvercommit</a></li><li><a href=#15-kubememoryquotaovercommit>1.5 KubeMemoryQuotaOvercommit</a></li><li><a href=#16-kubememquotaexceeded>1.6 KubeMEMQuotaExceeded</a></li><li><a href=#17-kubecpuquotaexceeded>1.7 KubeCPUQuotaExceeded</a></li></ul></li><li><a href=#2-kubernetes-存储相关>2. Kubernetes 存储相关</a><ul><li><a href=#21-kubepersistentvolumefillingup>2.1 KubePersistentVolumeFillingUp</a></li><li><a href=#22-kubepersistentvolumefillingup>2.2 KubePersistentVolumeFillingUp</a></li><li><a href=#23-kubepersistentvolumeerrors>2.3 KubePersistentVolumeErrors</a></li></ul></li><li><a href=#3-kubernetes-system-相关>3. kubernetes system 相关</a><ul><li><a href=#31-kubeversionmismatch>3.1 KubeVersionMismatch</a></li><li><a href=#32-kubeclienterrors>3.2 KubeClientErrors</a></li></ul></li><li><a href=#4-apiserver-相关>4. APIServer 相关</a><ul><li><a href=#41-kubeapierrorshigh>4.1 KubeAPIErrorsHigh</a></li><li><a href=#42-kubeclientcertificateexpiration>4.2 KubeClientCertificateExpiration</a></li><li><a href=#43-aggregatedapierrors>4.3 AggregatedAPIErrors</a></li><li><a href=#44-kubeapidown>4.4 KubeAPIDown</a></li></ul></li><li><a href=#5-kubelet-相关>5. kubelet 相关</a><ul><li><a href=#51-kubenodenotready>5.1 KubeNodeNotReady</a></li><li><a href=#52-kubenodeunreachable>5.2 KubeNodeUnreachable</a></li><li><a href=#53-kubelettoomanypods>5.3 KubeletTooManyPods</a></li><li><a href=#54-kubenodereadinessflapping>5.4 KubeNodeReadinessFlapping</a></li><li><a href=#55-kubeletdown>5.5 KubeletDown</a></li></ul></li><li><a href=#6-集群组件>6. 集群组件</a><ul><li><a href=#61-kubeschedulerdown>6.1 KubeSchedulerDown</a></li><li><a href=#62-kubecontrollermanagerdown>6.2 KubeControllerManagerDown</a></li></ul></li><li><a href=#7-应用相关>7. 应用相关</a><ul><li><a href=#71-kubepodcrashlooping>7.1 KubePodCrashLooping</a></li><li><a href=#72-kubepodnotready>7.2 KubePodNotReady</a></li><li><a href=#73-kubedeploymentgenerationmismatch>7.3 KubeDeploymentGenerationMismatch</a></li><li><a href=#74-kubedeploymentreplicasmismatch>7.4 KubeDeploymentReplicasMismatch</a></li><li><a href=#75-kubestatefulsetreplicasmismatch>7.5 KubeStatefulSetReplicasMismatch</a></li><li><a href=#76-kubestatefulsetupdatenotrolledout>7.6 KubeStatefulSetUpdateNotRolledOut</a></li><li><a href=#77-kubedaemonsetrolloutstuck>7.7 KubeDaemonSetRolloutStuck</a></li><li><a href=#78-kubedaemonsetmisscheduled>7.8 KubeDaemonSetMisScheduled</a></li><li><a href=#79-kubecontainerwaiting>7.9 KubeContainerWaiting</a></li></ul></li><li><a href=#8-节点相关>8. 节点相关</a><ul><li><a href=#81-nodeclocknotsynchronising>8.1 NodeClockNotSynchronising</a></li><li><a href=#82-nodeclockskewdetected>8.2 NodeClockSkewDetected</a></li><li><a href=#83-nodehighnumberconntrackentriesused>8.3 NodeHighNumberConntrackEntriesUsed</a></li><li><a href=#84-nodenetworkreceiveerrs>8.4 NodeNetworkReceiveErrs</a></li><li><a href=#85-nodenetworktransmiterrs>8.5 NodeNetworkTransmitErrs</a></li><li><a href=#86-nodefilesystemalmostoutoffiles>8.6 NodeFilesystemAlmostOutOfFiles</a></li><li><a href=#87-nodefilesystemfilesfillingup>8.7 NodeFilesystemFilesFillingUp</a></li><li><a href=#88-nodefilesystemalmostoutofspace>8.8 NodeFilesystemAlmostOutOfSpace</a></li><li><a href=#89-nodefilesystemspacefillingup>8.9 NodeFilesystemSpaceFillingUp</a></li></ul></li><li><a href=#9-etcd-相关>9. Etcd 相关</a><ul><li><a href=#91-etcdlived>9.1 Etcdlived</a></li><li><a href=#92-etcdcluseterunavailable>9.2 EtcdCluseterUnavailable</a></li><li><a href=#93-etcdleadercheck>9.3 EtcdLeaderCheck</a></li><li><a href=#94-etcdbackendfsync>9.4 EtcdBackendFsync</a></li><li><a href=#95-etcdwalfsync>9.5 EtcdWalFsync</a></li><li><a href=#96-etcddbsize>9.6 EtcdDbSize</a></li><li><a href=#97-etcdgrpc>9.7 EtcdGrpc</a></li></ul></li><li><a href=#10-coredns-相关>10. CoreDNS 相关</a><ul><li><a href=#101-dnsrequest>10.1 DnsRequest</a></li><li><a href=#102-dnsrequestfaild>10.2 DnsRequestFaild</a></li><li><a href=#103-dnspanic>10.3 DnsPanic</a></li></ul></li><li><a href=#参考链接>参考链接</a></li></ul></nav></div></div><div class=content id=content><p>Prometheus Operator 安装完成后会有很多默认的监控指标，一不注意就大量的报警产生，所以我们非常有必要了解下这些常用的监控指标，有部分指标很有可能对于我们自己的业务可有可无，所以可以适当的进行修改，这里我们就来对常用的几个指标进行简单的说明。</p><h2 id=1-kubernetes-资源相关>1. Kubernetes 资源相关</h2><h3 id=11-cputhrottlinghigh>1.1 CPUThrottlingHigh</h3><p>关于 CPU 的 limit 合理性指标。查出最近5分钟，超过25%的 CPU 执行周期受到限制的容器。表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>sum</span><span class=p>(</span><span class=n>increase</span><span class=p>(</span><span class=n>container_cpu_cfs_throttled_periods_total</span><span class=err>{</span><span class=n>container</span><span class=o>!=</span><span class=s2>&#34;&#34;</span><span class=p>,</span><span class=w> </span><span class=err>}</span><span class=p>[</span><span class=mi>5</span><span class=n>m</span><span class=p>]))</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=p>(</span><span class=n>container</span><span class=p>,</span><span class=w> </span><span class=n>pod</span><span class=p>,</span><span class=w> </span><span class=n>namespace</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=o>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>sum</span><span class=p>(</span><span class=n>increase</span><span class=p>(</span><span class=n>container_cpu_cfs_periods_total</span><span class=err>{}</span><span class=p>[</span><span class=mi>5</span><span class=n>m</span><span class=p>]))</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=p>(</span><span class=n>container</span><span class=p>,</span><span class=w> </span><span class=n>pod</span><span class=p>,</span><span class=w> </span><span class=n>namespace</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=o>&gt;</span><span class=w> </span><span class=p>(</span><span class=w> </span><span class=mi>25</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=mi>100</span><span class=w> </span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>相关指标：</p><ul><li><ul><li>container_cpu_cfs_periods_total：容器生命周期中度过的 cpu 周期总数</li></ul></li><li>container_cpu_cfs_throttled_periods_total：容器生命周期中度过的受限的 cpu 周期总数</li></ul><h3 id=12-kubecpuovercommit>1.2 KubeCPUOvercommit</h3><p>集群 CPU 过度使用。CPU 已经过度使用无法容忍节点故障，节点资源使用的总量超过节点的 CPU 总量，所以如果有节点故障将影响集群资源运行因为所需资源将无法被分配。</p><p>表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>sum</span><span class=p>(</span><span class=n>namespace</span><span class=p>:</span><span class=n>kube_pod_container_resource_requests_cpu_cores</span><span class=p>:</span><span class=k>sum</span><span class=err>{}</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=o>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>sum</span><span class=p>(</span><span class=n>kube_node_status_allocatable_cpu_cores</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=k>count</span><span class=p>(</span><span class=n>kube_node_status_allocatable_cpu_cores</span><span class=p>)</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=k>count</span><span class=p>(</span><span class=n>kube_node_status_allocatable_cpu_cores</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>相关指标：</p><ul><li>kube_pod_container_resource_requests_cpu_cores：资源 CPU 使用的 cores 数量</li><li>kube_node_status_allocatable_cpu_cores：节点 CPU cores 数量</li></ul><h3 id=13-kubememoryovercommit>1.3 KubeMemoryOvercommit</h3><p>集群内存过度使用。内存已经过度使用无法容忍节点故障，节点资源使用的总量超过节点的内存总量，所以如果有节点故障将影响集群资源运行因为所需资源将无法被分配。表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>sum</span><span class=p>(</span><span class=n>namespace</span><span class=p>:</span><span class=n>kube_pod_container_resource_requests_memory_bytes</span><span class=p>:</span><span class=k>sum</span><span class=err>{}</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=o>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>sum</span><span class=p>(</span><span class=n>kube_node_status_allocatable_memory_bytes</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>(</span><span class=k>count</span><span class=p>(</span><span class=n>kube_node_status_allocatable_memory_bytes</span><span class=p>)</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=o>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>count</span><span class=p>(</span><span class=n>kube_node_status_allocatable_memory_bytes</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>相关指标：</p><ul><li>kube_pod_container_resource_requests_memory_bytes：资源内存使用的量</li><li>kube_node_status_allocatable_memory_bytes：节点内存量</li></ul><h3 id=14-kubecpuquotaovercommit>1.4 KubeCPUQuotaOvercommit</h3><p>集群CPU是否超分。查看 CPU 资源分配的额度是否超过进群总额度 表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>sum</span><span class=p>(</span><span class=n>kube_pod_container_resource_limits_cpu_cores</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;kube-state-metrics&#34;</span><span class=err>}</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=o>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>sum</span><span class=p>(</span><span class=n>kube_node_status_allocatable_cpu_cores</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=o>&gt;</span><span class=w> </span><span class=mi>1</span><span class=p>.</span><span class=mi>1</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>相关指标：</p><ul><li>kube_pod_container_resource_limits_cpu_cores：资源分配的 CPU 资源额度</li><li>kube_node_status_allocatable_cpu_cores：节点 CPU 总量</li></ul><h3 id=15-kubememoryquotaovercommit>1.5 KubeMemoryQuotaOvercommit</h3><p>集群超分内存，查看内存资源分配的额度是否超过进群总额度 表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>sum</span><span class=p>(</span><span class=n>kube_pod_container_resource_limits_memory_bytes</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;kube-state-metrics&#34;</span><span class=err>}</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=o>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>sum</span><span class=p>(</span><span class=n>kube_node_status_allocatable_memory_bytes</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;kube-state-metrics&#34;</span><span class=err>}</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=o>&gt;</span><span class=w> </span><span class=mi>1</span><span class=p>.</span><span class=mi>1</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>相关指标:</p><ul><li>kube_pod_container_resource_limits_memory_bytes：资源配额内存量</li><li>kube_node_status_allocatable_memory_bytes：节点内存量</li></ul><h3 id=16-kubememquotaexceeded>1.6 KubeMEMQuotaExceeded</h3><p>命名空间级内存资源使用的比例，关乎资源配额。当使用 request 和 limit 限制资源时，使用值和最大值还是有一点区别，当有 request 时说明最低分配了这么多资源。需要注意当 request 等于 limit 时那么说明资源已经是100%已经分配使用当监控告警发出的时候需要区分。表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>sum</span><span class=w> </span><span class=p>(</span><span class=n>kube_pod_container_resource_requests_memory_bytes</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;kube-state-metrics&#34;</span><span class=err>}</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=p>(</span><span class=n>namespace</span><span class=p>)</span><span class=o>/</span><span class=w> </span><span class=p>(</span><span class=k>sum</span><span class=p>(</span><span class=n>kube_pod_container_resource_limits_memory_bytes</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;kube-state-metrics&#34;</span><span class=err>}</span><span class=p>)</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=p>(</span><span class=n>namespace</span><span class=p>))</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>8</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>相关指标:</p><ul><li>kube_pod_container_resource_requests_memory_bytes：内存资源使用量</li><li>kube_pod_container_resource_limits_memory_bytes：内存资源最大值</li></ul><h3 id=17-kubecpuquotaexceeded>1.7 KubeCPUQuotaExceeded</h3><p>命名空间级 CPU 资源使用的比例，关乎资源配额。当使用 request 和 limit 限制资源时，使用值和最大值还是有一点区别，当有 request 时说明最低分配了这么多资源。需要注意当 request 等于 limit 时那么说明资源已经是100%已经分配使用当监控告警发出的时候需要区分。</p><p>表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>sum</span><span class=w> </span><span class=p>(</span><span class=n>kube_pod_container_resource_requests_cpu_cores</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;kube-state-metrics&#34;</span><span class=err>}</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=p>(</span><span class=n>namespace</span><span class=p>)</span><span class=o>/</span><span class=w> </span><span class=p>(</span><span class=k>sum</span><span class=p>(</span><span class=n>kube_pod_container_resource_limits_cpu_cores</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;kube-state-metrics&#34;</span><span class=err>}</span><span class=p>)</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=p>(</span><span class=n>namespace</span><span class=p>))</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>8</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>相关指标:</p><ul><li>kube_pod_container_resource_requests_cpu_cores：CPU 使用量</li><li>kube_pod_container_resource_limits_cpu_cores：CPU 限额最大值</li></ul><h2 id=2-kubernetes-存储相关>2. Kubernetes 存储相关</h2><h3 id=21-kubepersistentvolumefillingup>2.1 KubePersistentVolumeFillingUp</h3><p>PVC 容量监控</p><p>表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>kubelet_volume_stats_available_bytes</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;kubelet&#34;</span><span class=p>,</span><span class=w> </span><span class=n>metrics_path</span><span class=o>=</span><span class=s2>&#34;/metrics&#34;</span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=o>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>kubelet_volume_stats_capacity_bytes</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;kubelet&#34;</span><span class=p>,</span><span class=w> </span><span class=n>metrics_path</span><span class=o>=</span><span class=s2>&#34;/metrics&#34;</span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>3</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>相关指标：</p><ul><li>kubelet_volume_stats_available_bytes：剩余空间</li><li>kubelet_volume_stats_capacity_bytes：空间总量</li></ul><h3 id=22-kubepersistentvolumefillingup>2.2 KubePersistentVolumeFillingUp</h3><p>磁盘空间耗尽预测：通过PVC资源使用6小时变化率预测 接下来4天的磁盘使用率</p><p>表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=p>(</span><span class=n>kubelet_volume_stats_available_bytes</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;kubelet&#34;</span><span class=p>,</span><span class=w> </span><span class=n>metrics_path</span><span class=o>=</span><span class=s2>&#34;/metrics&#34;</span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>kubelet_volume_stats_capacity_bytes</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;kubelet&#34;</span><span class=p>,</span><span class=w> </span><span class=n>metrics_path</span><span class=o>=</span><span class=s2>&#34;/metrics&#34;</span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>and</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>predict_linear</span><span class=p>(</span><span class=n>kubelet_volume_stats_available_bytes</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;kubelet&#34;</span><span class=p>,</span><span class=w> </span><span class=n>metrics_path</span><span class=o>=</span><span class=s2>&#34;/metrics&#34;</span><span class=err>}</span><span class=p>[</span><span class=mi>6</span><span class=n>h</span><span class=p>],</span><span class=w> </span><span class=mi>4</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>24</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>3600</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>相关指标:</p><ul><li>kubelet_volume_stats_available_bytes：剩余空间</li><li>kubelet_volume_stats_capacity_bytes：空间总量</li></ul><h3 id=23-kubepersistentvolumeerrors>2.3 KubePersistentVolumeErrors</h3><p>PV 使用状态监控。</p><p>表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>kube_persistentvolume_status_phase</span><span class=err>{</span><span class=n>phase</span><span class=o>=~</span><span class=s2>&#34;Failed|Pending&#34;</span><span class=p>,</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;kube-state-metrics&#34;</span><span class=err>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>相关指标：</p><ul><li>kube_persistentvolume_status_phase：PV 使用状态</li></ul><h2 id=3-kubernetes-system-相关>3. kubernetes system 相关</h2><h3 id=31-kubeversionmismatch>3.1 KubeVersionMismatch</h3><p>组件版本与当前集群版本是否有差异。对比组件版本是否有差异，默认为1 。</p><p>表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>count</span><span class=p>(</span><span class=k>count</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=p>(</span><span class=n>gitVersion</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=n>label_replace</span><span class=p>(</span><span class=n>kubernetes_build_info</span><span class=err>{</span><span class=n>job</span><span class=o>!~</span><span class=s2>&#34;kube-dns|coredns&#34;</span><span class=err>}</span><span class=p>,</span><span class=s2>&#34;gitVersion&#34;</span><span class=p>,</span><span class=s2>&#34;$1&#34;</span><span class=p>,</span><span class=s2>&#34;gitVersion&#34;</span><span class=p>,</span><span class=s2>&#34;(v[0-9]*.[0-9]*.[0-9]*).*&#34;</span><span class=p>)))</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>相关指标：</p><ul><li>kubernetes_build_info：获取组件信息</li></ul><h3 id=32-kubeclienterrors>3.2 KubeClientErrors</h3><p>客户端访问某些接口的错误率。</p><p>表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=k>sum</span><span class=p>(</span><span class=n>rate</span><span class=p>(</span><span class=n>rest_client_requests_total</span><span class=err>{</span><span class=n>code</span><span class=o>=~</span><span class=s2>&#34;5..&#34;</span><span class=err>}</span><span class=p>[</span><span class=mi>5</span><span class=n>m</span><span class=p>]))</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=p>(</span><span class=n>instance</span><span class=p>,</span><span class=w> </span><span class=n>job</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=o>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>sum</span><span class=p>(</span><span class=n>rate</span><span class=p>(</span><span class=n>rest_client_requests_total</span><span class=p>[</span><span class=mi>5</span><span class=n>m</span><span class=p>]))</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=p>(</span><span class=n>instance</span><span class=p>,</span><span class=w> </span><span class=n>job</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>01</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>相关指标：</p><ul><li>rest_client_requests_total：状态码</li></ul><h2 id=4-apiserver-相关>4. APIServer 相关</h2><h3 id=41-kubeapierrorshigh>4.1 KubeAPIErrorsHigh</h3><p>APIServer 请求错误率。5分钟内 APIServer 请求错误率。</p><p>表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>sum</span><span class=p>(</span><span class=n>rate</span><span class=p>(</span><span class=n>apiserver_request_total</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;apiserver&#34;</span><span class=p>,</span><span class=n>code</span><span class=o>=~</span><span class=s2>&#34;5..&#34;</span><span class=err>}</span><span class=p>[</span><span class=mi>5</span><span class=n>m</span><span class=p>]))</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=p>(</span><span class=n>resource</span><span class=p>,</span><span class=n>subresource</span><span class=p>,</span><span class=n>verb</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=o>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>sum</span><span class=p>(</span><span class=n>rate</span><span class=p>(</span><span class=n>apiserver_request_total</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;apiserver&#34;</span><span class=err>}</span><span class=p>[</span><span class=mi>5</span><span class=n>m</span><span class=p>]))</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=p>(</span><span class=n>resource</span><span class=p>,</span><span class=n>subresource</span><span class=p>,</span><span class=n>verb</span><span class=p>)</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>05</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>相关指标：</p><ul><li><ul><li>apiserver_request_total：APIServer 请求数</li></ul></li></ul><h3 id=42-kubeclientcertificateexpiration>4.2 KubeClientCertificateExpiration</h3><p>kubelet 客户端证书过期。监测证书状态30天告警和7天告警。</p><p>表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>apiserver_client_certificate_expiration_seconds_count</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;apiserver&#34;</span><span class=err>}</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>and</span><span class=w> </span><span class=k>on</span><span class=p>(</span><span class=n>job</span><span class=p>)</span><span class=w> </span><span class=n>histogram_quantile</span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>01</span><span class=p>,</span><span class=w> </span><span class=k>sum</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=p>(</span><span class=n>job</span><span class=p>,</span><span class=w> </span><span class=n>le</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=n>rate</span><span class=p>(</span><span class=n>apiserver_client_certificate_expiration_seconds_bucket</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;apiserver&#34;</span><span class=err>}</span><span class=p>[</span><span class=mi>5</span><span class=n>m</span><span class=p>])))</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>2592000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>apiserver_client_certificate_expiration_seconds_count</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;apiserver&#34;</span><span class=err>}</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>and</span><span class=w> </span><span class=k>on</span><span class=p>(</span><span class=n>job</span><span class=p>)</span><span class=w> </span><span class=n>histogram_quantile</span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>01</span><span class=p>,</span><span class=w> </span><span class=k>sum</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=p>(</span><span class=n>job</span><span class=p>,</span><span class=w> </span><span class=n>le</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=n>rate</span><span class=p>(</span><span class=n>apiserver_client_certificate_expiration_seconds_bucket</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;apiserver&#34;</span><span class=err>}</span><span class=p>[</span><span class=mi>5</span><span class=n>m</span><span class=p>])))</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>604800</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>相关指标：</p><ul><li>apiserver_client_certificate_expiration_seconds_count：证书有效剩余时间</li></ul><h3 id=43-aggregatedapierrors>4.3 AggregatedAPIErrors</h3><p>自定义注册的 APIServer 服务可用性监控，当检测到自定义注册的 APIServer 五分钟不用次数达到2次。</p><p>表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>sum</span><span class=w> </span><span class=k>by</span><span class=p>(</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>namespace</span><span class=p>)(</span><span class=n>increase</span><span class=p>(</span><span class=n>aggregator_unavailable_apiservice_count</span><span class=p>[</span><span class=mi>5</span><span class=n>m</span><span class=p>]))</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>2</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>相关指标:</p><ul><li>aggregator_unavailable_apiservice_count：监测自定义注册的 APIService 不可用次数。</li></ul><h3 id=44-kubeapidown>4.4 KubeAPIDown</h3><p>APIserver 失联，监控 APIServer 服务，失联原因可能是服务 down 还可能是网络出现状况。</p><p>表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>absent</span><span class=p>(</span><span class=n>up</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;apiserver&#34;</span><span class=err>}</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=5-kubelet-相关>5. kubelet 相关</h2><h3 id=51-kubenodenotready>5.1 KubeNodeNotReady</h3><p>节点是否处于就绪状态。检测节点是否为就绪状态，或者可能是 kubelet 服务down 了。</p><p>表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=o>-</span><span class=w> </span><span class=n>kube_node_status_condition</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;kube-state-metrics&#34;</span><span class=p>,</span><span class=n>condition</span><span class=o>=</span><span class=s2>&#34;Ready&#34;</span><span class=p>,</span><span class=n>status</span><span class=o>=</span><span class=s2>&#34;true&#34;</span><span class=err>}</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>相关指标：</p><ul><li>kube_node_status_condition：节点状态监测</li></ul><h3 id=52-kubenodeunreachable>5.2 KubeNodeUnreachable</h3><p>节点状态为 Unreachable。</p><p>表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>kube_node_spec_unschedulable</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;kube-state-metrics&#34;</span><span class=err>}</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=53-kubelettoomanypods>5.3 KubeletTooManyPods</h3><p>节点运行过多的 Pod，监测节点上运行的 Pods 数量。</p><p>表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>max</span><span class=p>(</span><span class=k>max</span><span class=p>(</span><span class=n>kubelet_running_pod_count</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;kubelet&#34;</span><span class=p>,</span><span class=w> </span><span class=n>metrics_path</span><span class=o>=</span><span class=s2>&#34;/metrics&#34;</span><span class=err>}</span><span class=p>)</span><span class=w> </span><span class=k>by</span><span class=p>(</span><span class=n>instance</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>on</span><span class=p>(</span><span class=n>instance</span><span class=p>)</span><span class=w> </span><span class=n>group_left</span><span class=p>(</span><span class=n>node</span><span class=p>)</span><span class=w> </span><span class=n>kubelet_node_name</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;kubelet&#34;</span><span class=p>,</span><span class=w> </span><span class=n>metrics_path</span><span class=o>=</span><span class=s2>&#34;/metrics&#34;</span><span class=err>}</span><span class=p>)</span><span class=w> </span><span class=k>by</span><span class=p>(</span><span class=n>node</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=k>max</span><span class=p>(</span><span class=n>kube_node_status_capacity_pods</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;kube-state-metrics&#34;</span><span class=err>}</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=k>by</span><span class=p>(</span><span class=n>node</span><span class=p>)</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>95</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>相关指标：</p><ul><li>kubelet_running_pod_count：节点运行的 Pods 数量</li><li>kubelet_node_name：节点名称</li><li>kube_node_status_capacity_pods：节点可运行的最大 Pod 数量</li></ul><h3 id=54-kubenodereadinessflapping>5.4 KubeNodeReadinessFlapping</h3><p>监测集群状态，查看集群内节点状态改变的频率。</p><p>表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>sum</span><span class=p>(</span><span class=n>changes</span><span class=p>(</span><span class=n>kube_node_status_condition</span><span class=err>{</span><span class=n>status</span><span class=o>=</span><span class=s2>&#34;true&#34;</span><span class=p>,</span><span class=n>condition</span><span class=o>=</span><span class=s2>&#34;Ready&#34;</span><span class=err>}</span><span class=p>[</span><span class=mi>15</span><span class=n>m</span><span class=p>]))</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=p>(</span><span class=n>node</span><span class=p>)</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>2</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=55-kubeletdown>5.5 KubeletDown</h3><p>监控 kubelet 服务，down 或者网络出现问题。</p><p>表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>absent</span><span class=p>(</span><span class=n>up</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;kubelet&#34;</span><span class=p>,</span><span class=w> </span><span class=n>metrics_path</span><span class=o>=</span><span class=s2>&#34;/metrics&#34;</span><span class=err>}</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=6-集群组件>6. 集群组件</h2><h3 id=61-kubeschedulerdown>6.1 KubeSchedulerDown</h3><p>KubeScheduler 失联，监测 KubeScheduler 是否正常。</p><p>表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>absent</span><span class=p>(</span><span class=n>up</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;kube-scheduler&#34;</span><span class=err>}</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=62-kubecontrollermanagerdown>6.2 KubeControllerManagerDown</h3><p>监测 KubeControllerManager 服务，Down 或者网络不通。</p><p>表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>absent</span><span class=p>(</span><span class=n>up</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;kube-controller-manager&#34;</span><span class=err>}</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=7-应用相关>7. 应用相关</h2><h3 id=71-kubepodcrashlooping>7.1 KubePodCrashLooping</h3><p>Pod 重启时间，重启时间超过3m告警。</p><p>表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>rate</span><span class=p>(</span><span class=n>kube_pod_container_status_restarts_total</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;kube-state-metrics&#34;</span><span class=err>}</span><span class=p>[</span><span class=mi>5</span><span class=n>m</span><span class=p>])</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>60</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>3</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>相关指标:</p><ul><li>kube_pod_container_status_restarts_total：重启状态0为正常</li></ul><h3 id=72-kubepodnotready>7.2 KubePodNotReady</h3><p>Pods 没有就绪，检测 Pod 是否就绪。</p><p>表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=w> </span><span class=k>sum</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=p>(</span><span class=n>namespace</span><span class=p>,</span><span class=w> </span><span class=n>pod</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=k>max</span><span class=w> </span><span class=k>by</span><span class=p>(</span><span class=n>namespace</span><span class=p>,</span><span class=w> </span><span class=n>pod</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=n>kube_pod_status_phase</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;kube-state-metrics&#34;</span><span class=p>,</span><span class=w> </span><span class=n>phase</span><span class=o>=~</span><span class=s2>&#34;Pending|Unknown&#34;</span><span class=err>}</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>on</span><span class=p>(</span><span class=n>namespace</span><span class=p>,</span><span class=w> </span><span class=n>pod</span><span class=p>)</span><span class=w> </span><span class=n>group_left</span><span class=p>(</span><span class=n>owner_kind</span><span class=p>)</span><span class=w> </span><span class=k>max</span><span class=w> </span><span class=k>by</span><span class=p>(</span><span class=n>namespace</span><span class=p>,</span><span class=w> </span><span class=n>pod</span><span class=p>,</span><span class=w> </span><span class=n>owner_kind</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=n>kube_pod_owner</span><span class=err>{</span><span class=n>owner_kind</span><span class=o>!=</span><span class=s2>&#34;Job&#34;</span><span class=err>}</span><span class=p>))</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>相关指标：</p><ul><li>kube_pod_status_phase：Pod 状态</li></ul><h3 id=73-kubedeploymentgenerationmismatch>7.3 KubeDeploymentGenerationMismatch</h3><p>Deployment 部署失败，Deployment 生成的资源与定义的资源不匹配。</p><p>表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>kube_deployment_status_observed_generation</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;kube-state-metrics&#34;</span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=o>!=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>kube_deployment_metadata_generation</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;kube-state-metrics&#34;</span><span class=err>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>相关指标：</p><ul><li>kube_deployment_status_observed_generation：Deployment 生成资源数</li><li>kube_deployment_metadata_generation：Deployment 定义资源数</li></ul><h3 id=74-kubedeploymentreplicasmismatch>7.4 KubeDeploymentReplicasMismatch</h3><p>查看 Deplyment 副本是否达到预期。</p><p>表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>kube_deployment_spec_replicas</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;kube-state-metrics&#34;</span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>!=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>kube_deployment_status_replicas_available</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;kube-state-metrics&#34;</span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w> </span><span class=k>and</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>changes</span><span class=p>(</span><span class=n>kube_deployment_status_replicas_updated</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;kube-state-metrics&#34;</span><span class=err>}</span><span class=p>[</span><span class=mi>3</span><span class=n>m</span><span class=p>])</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>==</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>相关指标：</p><ul><li>kube_deployment_spec_replicas 资源定义副本数</li><li>kube_deployment_status_replicas_available 正在运行副本数</li><li>kube_deployment_status_replicas_updated 更新的副本数</li></ul><h3 id=75-kubestatefulsetreplicasmismatch>7.5 KubeStatefulSetReplicasMismatch</h3><p>监测 StatefulSet 副本是否达到预期。</p><p>表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>kube_statefulset_status_replicas_ready</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;kube-state-metrics&#34;</span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>!=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>kube_statefulset_status_replicas</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;kube-state-metrics&#34;</span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w> </span><span class=k>and</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>changes</span><span class=p>(</span><span class=n>kube_statefulset_status_replicas_updated</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;kube-state-metrics&#34;</span><span class=err>}</span><span class=p>[</span><span class=mi>5</span><span class=n>m</span><span class=p>])</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>==</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>相关指标：</p><ul><li>kube_statefulset_status_replicas_ready：就绪副本数</li><li>kube_statefulset_status_replicas：当前副本数</li><li>kube_statefulset_status_replicas_updated：更新的副本数</li></ul><h3 id=76-kubestatefulsetupdatenotrolledout>7.6 KubeStatefulSetUpdateNotRolledOut</h3><p>StatefulSet 更新失败且未回滚，对比版本号和副本数。</p><p>表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>max</span><span class=w> </span><span class=k>without</span><span class=w> </span><span class=p>(</span><span class=n>revision</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>kube_statefulset_status_current_revision</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;kube-state-metrics&#34;</span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>unless</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>kube_statefulset_status_update_revision</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;kube-state-metrics&#34;</span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=o>*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>kube_statefulset_replicas</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;kube-state-metrics&#34;</span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>!=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>kube_statefulset_status_replicas_updated</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;kube-state-metrics&#34;</span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>相关指标：</p><ul><li>kube_statefulset_status_replicas：每个 StatefulSet 的副本数。</li><li>kube_statefulset_status_replicas_current：每个 StatefulSet 的当前副本数。</li><li>kube_statefulset_status_replicas_ready：每个StatefulSet 的就绪副本数。</li><li>kube_statefulset_status_replicas_updated：每个StatefulSet 的更新副本数。</li><li>kube_statefulset_status_observed_generation：StatefulSet 控制器观察到的生成。</li><li>kube_statefulset_replicas：StatefulSet 所需的副本数。</li><li>kube_statefulset_metadata_generation：表示 StatefulSet 所需状态的特定生成的序列号。</li><li>kube_statefulset_created：创建时间戳。</li><li>kube_statefulset_labels：Kubernetes 标签转换为 Prometheus 标签。</li><li>kube_statefulset_status_current_revision：指示用于按顺序(0，currentReplicas)生成 Pod 的StatefulSet 的版本。</li><li>kube_statefulset_status_update_revision：指示用于按顺序 [replicas-updatedReplicas，replicas] 生成 Pod 的 StatefulSet 的版本。</li></ul><h3 id=77-kubedaemonsetrolloutstuck>7.7 KubeDaemonSetRolloutStuck</h3><p>监测 DaemonSet 是否处于就绪状态。</p><p>表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>kube_daemonset_status_number_ready</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;kube-state-metrics&#34;</span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=o>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>kube_daemonset_status_desired_number_scheduled</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;kube-state-metrics&#34;</span><span class=err>}</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>1</span><span class=p>.</span><span class=mi>00</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>相关指标：</p><ul><li>kube_daemonset_status_number_ready：就绪的 DaemonSet</li><li>kube_daemonset_status_desired_number_scheduled：应该调度的 DaemonSet 数量</li></ul><h3 id=78-kubedaemonsetmisscheduled>7.8 KubeDaemonSetMisScheduled</h3><p>DaemonSet 运行在不该运行的节点上面。</p><p>表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>kube_daemonset_status_number_misscheduled</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;kube-state-metrics&#34;</span><span class=err>}</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>相关指标：</p><ul><li>kube_daemonset_status_number_misscheduled：运行在不该运行的节点状态</li></ul><h3 id=79-kubecontainerwaiting>7.9 KubeContainerWaiting</h3><p>监测哪些容器是在等待状态的。</p><p>表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>sum</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=p>(</span><span class=n>namespace</span><span class=p>,</span><span class=w> </span><span class=n>pod</span><span class=p>,</span><span class=w> </span><span class=n>container</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=n>kube_pod_container_status_waiting_reason</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;kube-state-metrics&#34;</span><span class=err>}</span><span class=p>)</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>相关指标：</p><ul><li>kube_pod_container_status_waiting_reason：容器声明周期过程中的状态，无论是创建成功还是失败都应该是0。</li></ul><h2 id=8-节点相关>8. 节点相关</h2><h3 id=81-nodeclocknotsynchronising>8.1 NodeClockNotSynchronising</h3><p>主机与时间服务器失联。</p><p>表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>min_over_time</span><span class=p>(</span><span class=n>node_timex_sync_status</span><span class=p>[</span><span class=mi>5</span><span class=n>m</span><span class=p>])</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>相关指标：</p><ul><li>node_timex_sync_status：同步状态。</li></ul><h3 id=82-nodeclockskewdetected>8.2 NodeClockSkewDetected</h3><p>本地时间偏移量。</p><p>表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=p>(</span><span class=n>node_timex_offset_seconds</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>05</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>and</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>deriv</span><span class=p>(</span><span class=n>node_timex_offset_seconds</span><span class=p>[</span><span class=mi>5</span><span class=n>m</span><span class=p>])</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>or</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>node_timex_offset_seconds</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=o>-</span><span class=mi>0</span><span class=p>.</span><span class=mi>05</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>and</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>deriv</span><span class=p>(</span><span class=n>node_timex_offset_seconds</span><span class=p>[</span><span class=mi>5</span><span class=n>m</span><span class=p>])</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>相关指标：</p><ul><li>node_timex_offset_seconds：误差</li></ul><h3 id=83-nodehighnumberconntrackentriesused>8.3 NodeHighNumberConntrackEntriesUsed</h3><p>链接状态跟踪。</p><p>表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=p>(</span><span class=n>node_nf_conntrack_entries</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>node_nf_conntrack_entries_limit</span><span class=p>)</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>75</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>相关指标：</p><ul><li>node_nf_conntrack_entries：链接状态跟踪表分配的数量</li><li>node_nf_conntrack_entries_limit：表总量</li></ul><h3 id=84-nodenetworkreceiveerrs>8.4 NodeNetworkReceiveErrs</h3><p>网卡接收错误量。</p><p>表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>increase</span><span class=p>(</span><span class=n>node_network_receive_errs_total</span><span class=p>[</span><span class=mi>2</span><span class=n>m</span><span class=p>])</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>10</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>相关指标：</p><ul><li>node_network_receive_errs_total：接收错误总量</li></ul><h3 id=85-nodenetworktransmiterrs>8.5 NodeNetworkTransmitErrs</h3><p>网卡传输错误量。</p><p>表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>increase</span><span class=p>(</span><span class=n>node_network_transmit_errs_total</span><span class=p>[</span><span class=mi>2</span><span class=n>m</span><span class=p>])</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>10</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>相关指标：</p><ul><li>node_network_transmit_errs_total：传输错误总量</li></ul><h3 id=86-nodefilesystemalmostoutoffiles>8.6 NodeFilesystemAlmostOutOfFiles</h3><p>inode 数量监测 表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>node_filesystem_files_free</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;node-exporter&#34;</span><span class=p>,</span><span class=n>fstype</span><span class=o>!=</span><span class=s2>&#34;&#34;</span><span class=err>}</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>node_filesystem_files</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;node-exporter&#34;</span><span class=p>,</span><span class=n>fstype</span><span class=o>!=</span><span class=s2>&#34;&#34;</span><span class=err>}</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>100</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>and</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>node_filesystem_readonly</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;node-exporter&#34;</span><span class=p>,</span><span class=n>fstype</span><span class=o>!=</span><span class=s2>&#34;&#34;</span><span class=err>}</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>相关指标：</p><ul><li>node_filesystem_files_free：空闲的 inode</li><li>node_filesystem_files：inodes 总量</li></ul><h3 id=87-nodefilesystemfilesfillingup>8.7 NodeFilesystemFilesFillingUp</h3><p>inode 耗尽预测，以6小时曲线变化预测接下来24小时和4小时可能使用的 inodes。</p><p>表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=p>(</span><span class=n>node_filesystem_files_free</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;node-exporter&#34;</span><span class=p>,</span><span class=n>fstype</span><span class=o>!=</span><span class=s2>&#34;&#34;</span><span class=err>}</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>node_filesystem_files</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;node-exporter&#34;</span><span class=p>,</span><span class=n>fstype</span><span class=o>!=</span><span class=s2>&#34;&#34;</span><span class=err>}</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>100</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>20</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>and</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>predict_linear</span><span class=p>(</span><span class=n>node_filesystem_files_free</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;node-exporter&#34;</span><span class=p>,</span><span class=n>fstype</span><span class=o>!=</span><span class=s2>&#34;&#34;</span><span class=err>}</span><span class=p>[</span><span class=mi>6</span><span class=n>h</span><span class=p>],</span><span class=w> </span><span class=mi>4</span><span class=o>*</span><span class=mi>60</span><span class=o>*</span><span class=mi>60</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>and</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>node_filesystem_readonly</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;node-exporter&#34;</span><span class=p>,</span><span class=n>fstype</span><span class=o>!=</span><span class=s2>&#34;&#34;</span><span class=err>}</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>相关指标：</p><ul><li>node_filesystem_files_free：空闲的 inode</li><li>node_filesystem_files：inodes 总量</li></ul><h3 id=88-nodefilesystemalmostoutofspace>8.8 NodeFilesystemAlmostOutOfSpace</h3><p>分区容量使用率。</p><p>表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=p>(</span><span class=n>node_filesystem_avail_bytes</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;node-exporter&#34;</span><span class=p>,</span><span class=n>fstype</span><span class=o>!=</span><span class=s2>&#34;&#34;</span><span class=err>}</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>node_filesystem_size_bytes</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;node-exporter&#34;</span><span class=p>,</span><span class=n>fstype</span><span class=o>!=</span><span class=s2>&#34;&#34;</span><span class=err>}</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>100</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>and</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>node_filesystem_readonly</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;node-exporter&#34;</span><span class=p>,</span><span class=n>fstype</span><span class=o>!=</span><span class=s2>&#34;&#34;</span><span class=err>}</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>相关指标：</p><ul><li>node_filesystem_avail_bytes：空闲容量</li><li>node_filesystem_size_bytes：总容量</li></ul><h3 id=89-nodefilesystemspacefillingup>8.9 NodeFilesystemSpaceFillingUp</h3><p>分区容量耗尽预测，以6小时曲线变化预测接下来24小时和4小时可能使用的容量。</p><p>表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=p>(</span><span class=n>node_filesystem_avail_bytes</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;node-exporter&#34;</span><span class=p>,</span><span class=n>fstype</span><span class=o>!=</span><span class=s2>&#34;&#34;</span><span class=err>}</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>node_filesystem_size_bytes</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;node-exporter&#34;</span><span class=p>,</span><span class=n>fstype</span><span class=o>!=</span><span class=s2>&#34;&#34;</span><span class=err>}</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>100</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>15</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>and</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>predict_linear</span><span class=p>(</span><span class=n>node_filesystem_avail_bytes</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;node-exporter&#34;</span><span class=p>,</span><span class=n>fstype</span><span class=o>!=</span><span class=s2>&#34;&#34;</span><span class=err>}</span><span class=p>[</span><span class=mi>6</span><span class=n>h</span><span class=p>],</span><span class=w> </span><span class=mi>4</span><span class=o>*</span><span class=mi>60</span><span class=o>*</span><span class=mi>60</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>and</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>node_filesystem_readonly</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;node-exporter&#34;</span><span class=p>,</span><span class=n>fstype</span><span class=o>!=</span><span class=s2>&#34;&#34;</span><span class=err>}</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>相关指标：</p><ul><li>node_filesystem_avail_bytes：空闲容量</li><li>node_filesystem_size_bytes：总容量</li></ul><h2 id=9-etcd-相关>9. Etcd 相关</h2><h3 id=91-etcdlived>9.1 Etcdlived</h3><p>etcd 存活检测。</p><p>表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>up</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;etcd&#34;</span><span class=err>}</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=92-etcdcluseterunavailable>9.2 EtcdCluseterUnavailable</h3><p>etcd 集群健康检查，down 数量大于集群可允许故障数量。</p><p>表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>count</span><span class=p>(</span><span class=n>up</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;etcd&#34;</span><span class=err>}</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=p>(</span><span class=k>count</span><span class=p>(</span><span class=n>up</span><span class=err>{</span><span class=n>job</span><span class=o>=</span><span class=s2>&#34;etcd&#34;</span><span class=err>}</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=93-etcdleadercheck>9.3 EtcdLeaderCheck</h3><p>检查 leader。</p><p>表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>max</span><span class=p>(</span><span class=n>etcd_server_has_leader</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=94-etcdbackendfsync>9.4 EtcdBackendFsync</h3><p>etcd io 监测，后端提交 延时。</p><p>表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>histogram_quantile</span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>99</span><span class=p>,</span><span class=w> </span><span class=k>sum</span><span class=p>(</span><span class=n>rate</span><span class=p>(</span><span class=n>etcd_disk_backend_commit_duration_seconds_bucket</span><span class=p>[</span><span class=mi>5</span><span class=n>m</span><span class=p>]))</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=p>(</span><span class=n>instance</span><span class=p>,</span><span class=w> </span><span class=n>le</span><span class=p>))</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>100</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=95-etcdwalfsync>9.5 EtcdWalFsync</h3><p>etcd io 监测，文件同步到磁盘延时。</p><p>表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>histogram_quantile</span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>99</span><span class=p>,</span><span class=w> </span><span class=k>sum</span><span class=p>(</span><span class=n>rate</span><span class=p>(</span><span class=n>etcd_disk_wal_fsync_duration_seconds_bucket</span><span class=p>[</span><span class=mi>5</span><span class=n>m</span><span class=p>]))</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=p>(</span><span class=n>instance</span><span class=p>,</span><span class=w> </span><span class=n>le</span><span class=p>))</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>100</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=96-etcddbsize>9.6 EtcdDbSize</h3><p>检测数据库大小。</p><p>表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>etcd_debugging_mvcc_db_total_size_in_bytes</span><span class=o>/</span><span class=mi>1024</span><span class=o>/</span><span class=mi>1024</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>1024</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=97-etcdgrpc>9.7 EtcdGrpc</h3><p>Grpc 调用速率。表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>sum</span><span class=p>(</span><span class=n>rate</span><span class=p>(</span><span class=n>grpc_server_handled_total</span><span class=err>{</span><span class=n>grpc_type</span><span class=o>=</span><span class=s2>&#34;unary&#34;</span><span class=err>}</span><span class=p>[</span><span class=mi>1</span><span class=n>m</span><span class=p>]))</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>100</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=10-coredns-相关>10. CoreDNS 相关</h2><h3 id=101-dnsrequest>10.1 DnsRequest</h3><p>DNS 查询速率，每分钟查询超过100告警。</p><p>表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>sum</span><span class=p>(</span><span class=n>irate</span><span class=p>(</span><span class=n>coredns_dns_request_count_total</span><span class=err>{</span><span class=k>zone</span><span class=w> </span><span class=o>!=</span><span class=s2>&#34;dropped&#34;</span><span class=err>}</span><span class=p>[</span><span class=mi>1</span><span class=n>m</span><span class=p>]))</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>100</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>相关指标：</p><ul><li>coredns_dns_request_count_total：总查询数</li></ul><h3 id=102-dnsrequestfaild>10.2 DnsRequestFaild</h3><p>异常查询，异常状态码，不是 NOERROR。</p><p>表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>irate</span><span class=p>(</span><span class=n>coredns_dns_response_rcode_count_total</span><span class=err>{</span><span class=n>rcode</span><span class=o>!=</span><span class=s2>&#34;NOERROR&#34;</span><span class=err>}</span><span class=w> </span><span class=p>[</span><span class=mi>1</span><span class=n>m</span><span class=p>])</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>相关指标：</p><ul><li>coredns_dns_response_rcode_count_total：查询返回状态码
DNS-Rcode：</li></ul><p>DNS-Rcode 作为 DNS 应答报文中有效的字段，主要用来说明 DNS 应答状态，是排查域名解析失败的重要指标。通常常见的 Rcode 值如下：</p><p>Rcode 值为0，对应的 DNS 应答状态为 NOERROR，意思是成功的响应，即这个域名解析是成功
Rcode 值为2，对应的 DNS 应答状态为 SERVFAIL，意思是服务器失败，也就是这个域名的权威服务器拒绝响应或者响应 REFUSE，递归服务器返回 Rcode 值为 2 给 CLIENT
Rcode 值为3，对应的 DNS 应答状态为 NXDOMAIN，意思是不存在的记录，也就是这个具体的域名在权威服务器中并不存在
Rcode 值为5，对应的 DNS 应答状态为 REFUSE，意思是拒绝，也就是这个请求源IP不在服务的范围内</p><h3 id=103-dnspanic>10.3 DnsPanic</h3><p>DNS 恐慌值，可能收到攻击。</p><p>表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>irate</span><span class=p>(</span><span class=n>coredns_panic_count_total</span><span class=p>[</span><span class=mi>1</span><span class=n>m</span><span class=p>])</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>100</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=参考链接>参考链接</h2><p><a href=https://my.oschina.net/54188zz/blog/4305978 target=_blank rel="external nofollow noopener noreferrer">https://my.oschina.net/54188zz/blog/4305978</a>
<a href=https://github.com/coreos/kube-prometheus target=_blank rel="external nofollow noopener noreferrer">https://github.com/coreos/kube-prometheus</a>
<a href=https://github.com/kubernetes-monitoring/kubernetes-mixin target=_blank rel="external nofollow noopener noreferrer">https://github.com/kubernetes-monitoring/kubernetes-mixin</a></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="2022-09-13 17:53:07">更新于 2022-09-13</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a href=/sre/posts/prometheus-operator-commonly-used-indicators/index.md title=阅读原始文档 class=link-to-markdown>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://www.kbsonlong.com/sre/posts/prometheus-operator-commonly-used-indicators/ data-title="Prometheus Operator 常用指标" data-hashtags=prometheus,monitor><i class="fa-brands fa-twitter fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://www.kbsonlong.com/sre/posts/prometheus-operator-commonly-used-indicators/ data-hashtag=prometheus><i class="fa-brands fa-facebook-square fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 WhatsApp" data-sharer=whatsapp data-url=https://www.kbsonlong.com/sre/posts/prometheus-operator-commonly-used-indicators/ data-title="Prometheus Operator 常用指标" data-web><i class="fa-brands fa-whatsapp fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=https://www.kbsonlong.com/sre/posts/prometheus-operator-commonly-used-indicators/ data-title="Prometheus Operator 常用指标"><i data-svg-src=/sre/lib/simple-icons/icons/line.min.svg></i></a>
<a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://www.kbsonlong.com/sre/posts/prometheus-operator-commonly-used-indicators/ data-title="Prometheus Operator 常用指标"><i class="fa-brands fa-weibo fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 Myspace" data-sharer=myspace data-url=https://www.kbsonlong.com/sre/posts/prometheus-operator-commonly-used-indicators/ data-title="Prometheus Operator 常用指标" data-description><i data-svg-src=/sre/lib/simple-icons/icons/myspace.min.svg></i></a>
<a href=javascript:void(0); title="分享到 Blogger" data-sharer=blogger data-url=https://www.kbsonlong.com/sre/posts/prometheus-operator-commonly-used-indicators/ data-title="Prometheus Operator 常用指标" data-description><i class="fa-brands fa-blogger fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 Evernote" data-sharer=evernote data-url=https://www.kbsonlong.com/sre/posts/prometheus-operator-commonly-used-indicators/ data-title="Prometheus Operator 常用指标"><i class="fa-brands fa-evernote fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw"></i>&nbsp;<a href=/sre/tags/prometheus/>Prometheus</a>,&nbsp;<a href=/sre/tags/monitor/>Monitor</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/sre/>主页</a></span></section></div><div class=post-nav><a href=/sre/posts/istio-performance-index/ class=prev rel=prev title=Istio性能指标><i class="fa-solid fa-angle-left fa-fw"></i>Istio性能指标</a>
<a href=/sre/posts/iptable-concept/ class=next rel=next title=Iptable的概念>Iptable的概念<i class="fa-solid fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=giscus><script src=https://giscus.app/client.js data-repo=kbsonlong/devops.alongparty.cn data-repo-id=R_kgDOHE7F-Q data-category=Announcements data-category-id=DIC_kwDOHE7F-c4CPP5J data-mapping=title data-theme=preferred_color_scheme data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-lang=zh-CN data-loading=lazy crossorigin=anonymous async defer></script><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app/ rel="external nofollow noopener noreferrer">giscus</a>.</noscript></div></div></article></main><footer class=footer><div class=footer-container><div class="footer-line copyright"><i class="fa-regular fa-copyright fa-fw"></i>
<span itemprop=copyrightYear>2018 - 2024</span><span class=author itemprop=copyrightHolder>
<a href=/sre/>kbsonlong</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class="footer-line statistics"></div><div class="footer-line ibruce"><span id=busuanzi_container_site_uv title=总访客数><i class="fa-regular fa-user fa-fw"></i>&nbsp;<span id=busuanzi_value_site_uv><i class="fa fa-spinner fa-spin fa-fw"></i></span></span><span id=busuanzi_container_site_pv class=footer-divider title=总访问量><i class="fa-regular fa-eye fa-fw"></i>&nbsp;<span id=busuanzi_value_site_pv><i class="fa fa-spinner fa-spin fa-fw"></i></span></span></div><div class="footer-line beian"><span class="icp footer-divider"><a target=_blank href=https://beian.miit.gov.cn/>粤ICP备18122209号</a></span></div></div></footer></div><div class=widgets><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fa-solid fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fa-solid fa-comment fa-fw"></i></a></div><a href=https://github.com/kbsonlong title="在 GitHub 上查看源代码" target=_blank rel="external nofollow noopener noreferrer" class="github-corner right d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div id=mask></div></div><link rel=stylesheet href=/sre/lib/katex/katex.min.css><link rel=stylesheet href=/sre/lib/katex/copy-tex.min.css><link rel=stylesheet href=/sre/lib/cookieconsent/cookieconsent.min.css><script type=text/javascript src=/sre/lib/autocomplete/autocomplete.min.js defer></script><script type=text/javascript src=/sre/lib/algoliasearch/algoliasearch-lite.umd.min.js defer></script><script type=text/javascript src=/sre/lib/lazysizes/lazysizes.min.js async defer></script><script type=text/javascript src=/sre/lib/sharer/sharer.min.js async defer></script><script type=text/javascript src=/sre/lib/katex/katex.min.js defer></script><script type=text/javascript src=/sre/lib/katex/auto-render.min.js defer></script><script type=text/javascript src=/sre/lib/katex/copy-tex.min.js defer></script><script type=text/javascript src=/sre/lib/katex/mhchem.min.js defer></script><script type=text/javascript src=/sre/lib/cookieconsent/cookieconsent.min.js defer></script><script type=text/javascript src=/sre/lib/pangu/pangu.min.js defer></script><script type=text/javascript src=/sre/lib/cell-watermark/watermark.min.js defer></script><script type=text/javascript src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async defer></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:10},comment:{giscus:{darkTheme:"dark",lightTheme:"light"}},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},enablePWA:!0,enablePangu:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"WFOR67TML1",algoliaIndex:"along",algoliaSearchKey:"ea1fe535f9a7ae353f3922489c829cc1",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"},watermark:{appendto:".wrapper>main",colspacing:30,content:'<img class="fixit-icon" src="/favicon-16x16.png" alt="FixIt logo" /> FixIt 主题',enable:!0,fontfamily:"inherit",fontsize:.85,height:21,opacity:.0125,rotate:15,rowspacing:60,width:150}}</script><script type=text/javascript src=/sre/js/theme.min.js defer></script><script type=text/javascript src=/sre/js/_custom.min.js defer></script></body></html>