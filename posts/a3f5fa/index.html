<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>源码分析 kubernetes scheduler 核心调度器的实现原理 - 蜷缩的蜗牛</title><meta name=author content="kbsonlong"><meta name=author-link content><meta name=description content="基于 kubernetes v1.27.0 源码分析 scheduler 调度器 k8s scheduler 的主要职责是为新创建的 pod 寻找一个最合适的 node 节点, 然后进行 bind node 绑定, 后面 kubelet 才会监听到并创建真正的 pod. 那么问题来了, 如"><meta name=keywords content="kubernetes,源码,转载"><meta itemprop=name content="源码分析 kubernetes scheduler 核心调度器的实现原理"><meta itemprop=description content="基于 kubernetes v1.27.0 源码分析 scheduler 调度器 k8s scheduler 的主要职责是为新创建的 pod 寻找一个最合适的 node 节点, 然后进行 bind node 绑定, 后面 kubelet 才会监听到并创建真正的 pod. 那么问题来了, 如"><meta itemprop=datePublished content="2023-04-18T21:53:59+08:00"><meta itemprop=dateModified content="2023-04-18T21:53:59+08:00"><meta itemprop=wordCount content="10296"><meta itemprop=image content="https://www.alongparty.cn/logo_transparent.png"><meta itemprop=keywords content="kubernetes,源码,转载,"><meta property="og:title" content="源码分析 kubernetes scheduler 核心调度器的实现原理"><meta property="og:description" content="基于 kubernetes v1.27.0 源码分析 scheduler 调度器 k8s scheduler 的主要职责是为新创建的 pod 寻找一个最合适的 node 节点, 然后进行 bind node 绑定, 后面 kubelet 才会监听到并创建真正的 pod. 那么问题来了, 如"><meta property="og:type" content="article"><meta property="og:url" content="https://www.alongparty.cn/posts/a3f5fa/"><meta property="og:image" content="https://www.alongparty.cn/logo_transparent.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-04-18T21:53:59+08:00"><meta property="article:modified_time" content="2023-04-18T21:53:59+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.alongparty.cn/logo_transparent.png"><meta name=twitter:title content="源码分析 kubernetes scheduler 核心调度器的实现原理"><meta name=twitter:description content="基于 kubernetes v1.27.0 源码分析 scheduler 调度器 k8s scheduler 的主要职责是为新创建的 pod 寻找一个最合适的 node 节点, 然后进行 bind node 绑定, 后面 kubelet 才会监听到并创建真正的 pod. 那么问题来了, 如"><meta name=application-name content="FixIt"><meta name=apple-mobile-web-app-title content="FixIt"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#252627"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://www.alongparty.cn/posts/a3f5fa/><link rel=prev href=https://www.alongparty.cn/posts/ba614f/><link rel=next href=https://www.alongparty.cn/posts/32dd44/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"源码分析 kubernetes scheduler 核心调度器的实现原理","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/www.alongparty.cn\/posts\/a3f5fa\/"},"genre":"posts","keywords":"kubernetes, 源码, 转载","wordcount":10296,"url":"https:\/\/www.alongparty.cn\/posts\/a3f5fa\/","datePublished":"2023-04-18T21:53:59+08:00","dateModified":"2023-04-18T21:53:59+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"kbsonlong"},"description":""}</script></head><body header-desktop=sticky header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper github-corner=right><div class=header-title><a href=/ title=蜷缩的蜗牛><img class="lazyload logo" src=/svg/loading.min.svg data-src=/logo_transparent.png data-srcset="/logo_transparent.png, /logo_transparent.png 1.5x, /logo_transparent.png 2x" data-sizes=auto alt=蜷缩的蜗牛 title=蜷缩的蜗牛><span class=header-title-text>蜷缩的蜗牛</span></a><span class=header-subtitle></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/posts/><i class='fa-solid fa-archive fa-fw fa-sm'></i> 文章</a></li><li class=menu-item><a class=menu-link href=/categories/><i class='fa-solid fa-th fa-fw fa-sm'></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class='fa-solid fa-tags fa-fw fa-sm'></i> 标签</a></li><li class=menu-item><a class=menu-link href=/friends/ title=友情链接><i class='fa-solid fa-users fa-fw fa-sm'></i> 友链</a></li><li class=menu-item><a class=menu-link href=/about/><i class='fa-solid fa-info-circle fa-fw fa-sm'></i> 关于</a></li><li class="menu-item d-none-desktop text-center"><a class=menu-link href=https://github.com/kbsonlong/ title=GitHub rel="noopener noreferrer" target=_blank><i class='fa-brands fa-github fa-fw'></i></a></li><li class="menu-item d-none-desktop text-center"><a class=menu-link href=/messages/><i class='fa-solid fa-messages'></i> 留言板</a></li><li class=menu-item><a class=menu-link href=/messages/ title=留言板>留言板</a></li><li class="menu-item delimiter"></li><li class="menu-item language"><span title=选择语言>简体中文<i class="dropdown-icon fa-solid fa-chevron-down"></i></span><ul class=sub-menu><li class=menu-item>没有更多翻译</li></ul></li><li class="menu-item search" id=search-desktop><input type=text placeholder="搜索文章标题或内容 ..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin"></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw"></i></li></ul></nav></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=蜷缩的蜗牛><img class="lazyload logo" src=/svg/loading.min.svg data-src=/logo_transparent.png data-srcset="/logo_transparent.png, /logo_transparent.png 1.5x, /logo_transparent.png 2x" data-sizes=auto alt=/logo_transparent.png title=/logo_transparent.png><span class=header-title-text>蜷缩的蜗牛</span></a><span class=header-subtitle></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="搜索文章标题或内容 ..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><a class=menu-link href=/posts/><i class='fa-solid fa-archive fa-fw fa-sm'></i> 文章</a></li><li class=menu-item><a class=menu-link href=/categories/><i class='fa-solid fa-th fa-fw fa-sm'></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class='fa-solid fa-tags fa-fw fa-sm'></i> 标签</a></li><li class=menu-item><a class=menu-link href=/friends/ title=友情链接><i class='fa-solid fa-users fa-fw fa-sm'></i> 友链</a></li><li class=menu-item><a class=menu-link href=/about/><i class='fa-solid fa-info-circle fa-fw fa-sm'></i> 关于</a></li><li class="menu-item d-none-desktop text-center"><a class=menu-link href=https://github.com/kbsonlong/ title=GitHub rel="noopener noreferrer" target=_blank><i class='fa-brands fa-github fa-fw'></i></a></li><li class="menu-item d-none-desktop text-center"><a class=menu-link href=/messages/><i class='fa-solid fa-messages'></i> 留言板</a></li><li class=menu-item><a class=menu-link href=/messages/ title=留言板>留言板</a></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw"></i></li><li class="menu-item language"><span title=选择语言>简体中文<i class="dropdown-icon fa-solid fa-chevron-down"></i></span>
<select class=language-select onchange="location=this.value"><option disabled>没有更多翻译</option></select></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=container page-style=normal><aside class=toc id=toc-auto><h2 class=toc-title>目录 <i class="toc-icon fa-solid fa-angle-down fa-fw"></i></h2><div class=toc-content id=toc-content-auto></div></aside><aside class=aside-custom></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>源码分析 kubernetes scheduler 核心调度器的实现原理</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><img class="lazyload avatar" src=/svg/loading.min.svg data-src="https://gravatar.loli.net/avatar/598872715ec08296cf1e1806135cd518?s=32&amp;d=mp" data-srcset="https://gravatar.loli.net/avatar/598872715ec08296cf1e1806135cd518?s=32&amp;d=mp, https://gravatar.loli.net/avatar/598872715ec08296cf1e1806135cd518?s=32&amp;d=mp 1.5x, https://gravatar.loli.net/avatar/598872715ec08296cf1e1806135cd518?s=32&amp;d=mp 2x" data-sizes=auto alt=kbsonlong title=kbsonlong>&nbsp;kbsonlong</span></span>
<span class=post-category>收录于 <a href=/categories/kubernetes/><i class="fa-regular fa-folder fa-fw"></i>&nbsp;kubernetes</a></span></div><div class=post-meta-line><span title="2023-04-18 21:53:59"><i class="fa-regular fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2023-04-18>2023-04-18</time>
</span>&nbsp;<i class="fa-solid fa-pencil-alt fa-fw"></i>&nbsp;约 10296 字&nbsp;
<i class="fa-regular fa-clock fa-fw"></i>&nbsp;预计阅读 21 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#k8s-scheduler-启动入口>k8s scheduler 启动入口</a></li><li><a href=#注册在-scheduler-informer-的回调方法>注册在 scheduler informer 的回调方法</a></li><li><a href=#scheduler-的选举实现>scheduler 的选举实现</a></li><li><a href=#scheudler-启动入口>scheudler 启动入口</a></li><li><a href=#单实例单协程模型的-schduler-调度器>单实例单协程模型的 schduler 调度器</a><ul><li><a href=#为什么-scheduler-不支持并发->为什么 scheduler 不支持并发 ?</a></li><li><a href=#使用自定义调度器进行并发调度->使用自定义调度器进行并发调度 ?</a></li></ul></li><li><a href=#schedulingcycle-核心调度周期的实现>schedulingCycle 核心调度周期的实现</a><ul><li><a href=#findnodesthatfitpod>findNodesThatFitPod</a><ul><li><a href=#findnodesthatpassfilters-并发执行-filter-插件方法>findNodesThatPassFilters 并发执行 Filter 插件方法</a></li><li><a href=#numfeasiblenodestofind-计算多少节点参与预选>numFeasibleNodesToFind 计算多少节点参与预选</a></li></ul></li><li><a href=#prioritizenodes>prioritizeNodes</a></li><li><a href=#selecthost>selectHost</a></li><li><a href=#priorityqueue-的实现>PriorityQueue 的实现</a></li><li><a href=#如何处理调度失败的-pod>如何处理调度失败的 pod</a></li></ul></li><li><a href=#bindingcycle-实现-pod-和-node-绑定>bindingCycle 实现 pod 和 node 绑定</a></li><li><a href=#framework-的实现原理>framework 的实现原理</a><ul><li><a href=#framework-关键挂载点分析>framework 关键挂载点分析</a></li></ul></li><li><a href=#scheduler-内置插件的实现原理>scheduler 内置插件的实现原理</a><ul><li><a href=#nodename-插件的实现原理>NodeName 插件的实现原理</a></li><li><a href=#imagelocality-插件的实现原理>ImageLocality 插件的实现原理</a></li><li><a href=#noderesourcesfit-插件的实现原理>NodeResourcesFit 插件的实现原理</a></li><li><a href=#nodeaffinity-节点亲和性插件原理>NodeAffinity 节点亲和性插件原理</a></li></ul></li><li><a href=#总结>总结</a></li></ul></nav></div></div><div class=content id=content><p><img class=lazyload src=/svg/loading.min.svg data-src=https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301251502086.png data-srcset="https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301251502086.png, https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301251502086.png 1.5x, https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301251502086.png 2x" data-sizes=auto alt=https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301251502086.png title=https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301251502086.png></p><blockquote><p>基于 kubernetes <code>v1.27.0</code> 源码分析 scheduler 调度器</p></blockquote><p>k8s scheduler 的主要职责是为新创建的 pod 寻找一个最合适的 node 节点, 然后进行 bind node 绑定, 后面 kubelet 才会监听到并创建真正的 pod.</p><p>那么问题来了, 如何为 pod 寻找最合适的 node ? 调度器需要经过 predicates 预选和 priority 优选.</p><ul><li>预选就是从集群的所有节点中根据调度算法筛选出所有可以运行该 pod 的节点集合</li><li>优选则是按照算法对预选出来的节点进行打分，找到分值最高的节点作为调度节点.</li></ul><p>选出最优节点后, 对 apiserver 发起 pod 节点 bind 操作, 其实就是对 pod 的 spec.NodeName 赋值最优节点.</p><p><strong>源码基本调用关系</strong></p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202212/k8s-scheduler.jpg data-srcset="https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202212/k8s-scheduler.jpg, https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202212/k8s-scheduler.jpg 1.5x, https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202212/k8s-scheduler.jpg 2x" data-sizes=auto alt=https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202212/k8s-scheduler.jpg title=https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202212/k8s-scheduler.jpg></p><h2 id=k8s-scheduler-启动入口>k8s scheduler 启动入口</h2><p>k8s scheduler 在启动时会调用在 cobra 注册的 <code>setup</code> 来初始化 scheduler 调度器对象.</p><p>代码位置: <code>cmd/kube-scheduler/app/server.go</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Setup</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>opts</span> <span class=o>*</span><span class=nx>options</span><span class=p>.</span><span class=nx>Options</span><span class=p>,</span> <span class=nx>outOfTreeRegistryOptions</span> <span class=o>...</span><span class=nx>Option</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>schedulerserverconfig</span><span class=p>.</span><span class=nx>CompletedConfig</span><span class=p>,</span> <span class=o>*</span><span class=nx>scheduler</span><span class=p>.</span><span class=nx>Scheduler</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 获取默认配置
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>cfg</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>latest</span><span class=p>.</span><span class=nf>Default</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>opts</span><span class=p>.</span><span class=nx>ComponentConfig</span> <span class=p>=</span> <span class=nx>cfg</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 验证 scheduler 的配置参数
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>errs</span> <span class=o>:=</span> <span class=nx>opts</span><span class=p>.</span><span class=nf>Validate</span><span class=p>();</span> <span class=nb>len</span><span class=p>(</span><span class=nx>errs</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>utilerrors</span><span class=p>.</span><span class=nf>NewAggregate</span><span class=p>(</span><span class=nx>errs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>c</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>opts</span><span class=p>.</span><span class=nf>Config</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 配置中填充和调整
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>cc</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Complete</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 构建 scheduler 对象
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>sched</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>scheduler</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>cc</span><span class=p>.</span><span class=nx>Client</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>cc</span><span class=p>.</span><span class=nx>InformerFactory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>cc</span><span class=p>.</span><span class=nx>DynInformerFactory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>recorderFactory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>		<span class=o>...</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>cc</span><span class=p>,</span> <span class=nx>sched</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>实例化 kubernetes scheduler 对象, 初始化流程直接看下面代码.</p><p>代码位置: <code>pkg/scheduler/scheduler.go</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// New returns a Scheduler
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>New</span><span class=p>(</span><span class=nx>client</span> <span class=nx>clientset</span><span class=p>.</span><span class=nx>Interface</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>informerFactory</span> <span class=nx>informers</span><span class=p>.</span><span class=nx>SharedInformerFactory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>dynInformerFactory</span> <span class=nx>dynamicinformer</span><span class=p>.</span><span class=nx>DynamicSharedInformerFactory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>recorderFactory</span> <span class=nx>profile</span><span class=p>.</span><span class=nx>RecorderFactory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>stopCh</span> <span class=o>&lt;-</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{},</span>
</span></span><span class=line><span class=cl>	<span class=nx>opts</span> <span class=o>...</span><span class=nx>Option</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>Scheduler</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 构建 registry 对象, 默认集成了一堆的插件
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>registry</span> <span class=o>:=</span> <span class=nx>frameworkplugins</span><span class=p>.</span><span class=nf>NewInTreeRegistry</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>registry</span><span class=p>.</span><span class=nf>Merge</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>frameworkOutOfTreeRegistry</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// profiles 用来保存不同调度器的 framework 框架, framework 则用来存放 plugin.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>profiles</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>profile</span><span class=p>.</span><span class=nf>NewMap</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>profiles</span><span class=p>,</span> <span class=nx>registry</span><span class=p>,</span> <span class=nx>recorderFactory</span><span class=p>,</span> <span class=nx>stopCh</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>WithComponentConfigVersion</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>componentConfigVersion</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>WithClientSet</span><span class=p>(</span><span class=nx>client</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>WithKubeConfig</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>kubeConfig</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>WithInformerFactory</span><span class=p>(</span><span class=nx>informerFactory</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=o>...</span>
</span></span><span class=line><span class=cl>		<span class=o>...</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 实例化快照
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>snapshot</span> <span class=o>:=</span> <span class=nx>internalcache</span><span class=p>.</span><span class=nf>NewEmptySnapshot</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 实例化 queue, 该 queue 为 PriorityQueue.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>podQueue</span> <span class=o>:=</span> <span class=nx>internalqueue</span><span class=p>.</span><span class=nf>NewSchedulingQueue</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=nx>profiles</span><span class=p>[</span><span class=nx>options</span><span class=p>.</span><span class=nx>profiles</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>SchedulerName</span><span class=p>].</span><span class=nf>QueueSortFunc</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>		<span class=nx>informerFactory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=o>...</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 实例化 cache 缓存
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>schedulerCache</span> <span class=o>:=</span> <span class=nx>internalcache</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>durationToExpireAssumedPod</span><span class=p>,</span> <span class=nx>stopEverything</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 实例化 scheduler 对象
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>sched</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>Scheduler</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Cache</span><span class=p>:</span>                    <span class=nx>schedulerCache</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>client</span><span class=p>:</span>                   <span class=nx>client</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>nodeInfoSnapshot</span><span class=p>:</span>         <span class=nx>snapshot</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>NextPod</span><span class=p>:</span>                  <span class=nx>internalqueue</span><span class=p>.</span><span class=nf>MakeNextPodFunc</span><span class=p>(</span><span class=nx>podQueue</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>StopEverything</span><span class=p>:</span>           <span class=nx>stopEverything</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>SchedulingQueue</span><span class=p>:</span>          <span class=nx>podQueue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>sched</span><span class=p>.</span><span class=nf>applyDefaultHandlers</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 在 informer 里注册自定义的事件处理方法
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>addAllEventHandlers</span><span class=p>(</span><span class=nx>sched</span><span class=p>,</span> <span class=nx>informerFactory</span><span class=p>,</span> <span class=nx>dynInformerFactory</span><span class=p>,</span> <span class=nf>unionedGVKs</span><span class=p>(</span><span class=nx>clusterEventMap</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>sched</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>Scheduler</span><span class=p>)</span> <span class=nf>applyDefaultHandlers</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>s</span><span class=p>.</span><span class=nx>SchedulePod</span> <span class=p>=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>schedulePod</span>
</span></span><span class=line><span class=cl>	<span class=nx>s</span><span class=p>.</span><span class=nx>FailureHandler</span> <span class=p>=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>handleSchedulingFailure</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=注册在-scheduler-informer-的回调方法>注册在 scheduler informer 的回调方法</h2><p>在 informer 里注册 pod 和 node 资源的回调方法，监听 pod 事件对 queue 和 cache 做回调处理. 监听 node 事件对 cache 做处理.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>addAllEventHandlers</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>sched</span> <span class=o>*</span><span class=nx>Scheduler</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>informerFactory</span> <span class=nx>informers</span><span class=p>.</span><span class=nx>SharedInformerFactory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>dynInformerFactory</span> <span class=nx>dynamicinformer</span><span class=p>.</span><span class=nx>DynamicSharedInformerFactory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>gvkMap</span> <span class=kd>map</span><span class=p>[</span><span class=nx>framework</span><span class=p>.</span><span class=nx>GVK</span><span class=p>]</span><span class=nx>framework</span><span class=p>.</span><span class=nx>ActionType</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 监听 pod 事件，并注册增删改回调方法, 其操作是对 cache 的增删改
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>informerFactory</span><span class=p>.</span><span class=nf>Core</span><span class=p>().</span><span class=nf>V1</span><span class=p>().</span><span class=nf>Pods</span><span class=p>().</span><span class=nf>Informer</span><span class=p>().</span><span class=nf>AddEventHandler</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=nx>cache</span><span class=p>.</span><span class=nx>FilteringResourceEventHandler</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>FilterFunc</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=o>...</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>			<span class=nx>Handler</span><span class=p>:</span> <span class=nx>cache</span><span class=p>.</span><span class=nx>ResourceEventHandlerFuncs</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>AddFunc</span><span class=p>:</span>    <span class=nx>sched</span><span class=p>.</span><span class=nx>addPodToCache</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>UpdateFunc</span><span class=p>:</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>updatePodInCache</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>DeleteFunc</span><span class=p>:</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>deletePodFromCache</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 监听 pod 事件，并注册增删改方法, 对 queue 插入增删改事件.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>informerFactory</span><span class=p>.</span><span class=nf>Core</span><span class=p>().</span><span class=nf>V1</span><span class=p>().</span><span class=nf>Pods</span><span class=p>().</span><span class=nf>Informer</span><span class=p>().</span><span class=nf>AddEventHandler</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=nx>cache</span><span class=p>.</span><span class=nx>FilteringResourceEventHandler</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>FilterFunc</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=o>...</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>			<span class=nx>Handler</span><span class=p>:</span> <span class=nx>cache</span><span class=p>.</span><span class=nx>ResourceEventHandlerFuncs</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>AddFunc</span><span class=p>:</span>    <span class=nx>sched</span><span class=p>.</span><span class=nx>addPodToSchedulingQueue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>UpdateFunc</span><span class=p>:</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>updatePodInSchedulingQueue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>DeleteFunc</span><span class=p>:</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>deletePodFromSchedulingQueue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 监听 node 事件，注册回调方法，该方法在 cache 里对 node 的增删改查.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>informerFactory</span><span class=p>.</span><span class=nf>Core</span><span class=p>().</span><span class=nf>V1</span><span class=p>().</span><span class=nf>Nodes</span><span class=p>().</span><span class=nf>Informer</span><span class=p>().</span><span class=nf>AddEventHandler</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=nx>cache</span><span class=p>.</span><span class=nx>ResourceEventHandlerFuncs</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>AddFunc</span><span class=p>:</span>    <span class=nx>sched</span><span class=p>.</span><span class=nx>addNodeToCache</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>UpdateFunc</span><span class=p>:</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>updateNodeInCache</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>DeleteFunc</span><span class=p>:</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>deleteNodeFromCache</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=scheduler-的选举实现>scheduler 的选举实现</h2><p><code>kube-scheduler</code> 跟 k8s 的其他主控组件一样, 也会通过选举 <code>leaderelection</code> 机制保证集群只有一个 leader 实例运行调度器, 其他 follower 实例则尝试轮询抢锁直到成功.</p><p>源码位置: <code>cmd/kube-scheduler/app/server.go</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Run</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>cc</span> <span class=o>*</span><span class=nx>schedulerserverconfig</span><span class=p>.</span><span class=nx>CompletedConfig</span><span class=p>,</span> <span class=nx>sched</span> <span class=o>*</span><span class=nx>scheduler</span><span class=p>.</span><span class=nx>Scheduler</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>waitingForLeader</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>	<span class=nx>isLeader</span> <span class=o>:=</span> <span class=kd>func</span><span class=p>()</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>waitingForLeader</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=c1>// if channel is closed, we are leading
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>return</span> <span class=p>!</span><span class=nx>ok</span>
</span></span><span class=line><span class=cl>		<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=c1>// channel is open, we are waiting for a leader
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>return</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 启动 informers, 这里只有 pod 和 node.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>cc</span><span class=p>.</span><span class=nx>InformerFactory</span><span class=p>.</span><span class=nf>Start</span><span class=p>(</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 同步 informer 的数据到本地缓存
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>cc</span><span class=p>.</span><span class=nx>InformerFactory</span><span class=p>.</span><span class=nf>WaitForCacheSync</span><span class=p>(</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 如果在配置中启动了选举, 创建选举对象, 注册事件方法, 并启用选举.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>cc</span><span class=p>.</span><span class=nx>LeaderElection</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>cc</span><span class=p>.</span><span class=nx>LeaderElection</span><span class=p>.</span><span class=nx>Callbacks</span> <span class=p>=</span> <span class=nx>leaderelection</span><span class=p>.</span><span class=nx>LeaderCallbacks</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>OnStartedLeading</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// 当选举拿到 leader 时, 启动 scheduler 调度器
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nb>close</span><span class=p>(</span><span class=nx>waitingForLeader</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=nx>sched</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>			<span class=nx>OnStoppedLeading</span><span class=p>:</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// 当选举成功但后面又丢失 leader 后, 则退出进程.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// 进程退出后, 会被 docker 或 systemd 重新拉起, 尝试拿锁.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>case</span> <span class=o>&lt;-</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>():</span>
</span></span><span class=line><span class=cl>					<span class=c1>// We were asked to terminate. Exit 0.
</span></span></span><span class=line><span class=cl><span class=c1></span>					<span class=nx>os</span><span class=p>.</span><span class=nf>Exit</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>					<span class=c1>// We lost the lock.
</span></span></span><span class=line><span class=cl><span class=c1></span>					<span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=kc>nil</span><span class=p>,</span> <span class=s>&#34;Leaderelection lost&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=nx>klog</span><span class=p>.</span><span class=nf>FlushAndExit</span><span class=p>(</span><span class=nx>klog</span><span class=p>.</span><span class=nx>ExitFlushTimeout</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// 构建 leaderelection 对象
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>leaderElector</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>leaderelection</span><span class=p>.</span><span class=nf>NewLeaderElector</span><span class=p>(</span><span class=o>*</span><span class=nx>cc</span><span class=p>.</span><span class=nx>LeaderElection</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;couldn&#39;t create leader elector: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// 启动选举
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>leaderElector</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;lost lease&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 如果没有开启选举, 则直接启动 scheduler 调度器.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nb>close</span><span class=p>(</span><span class=nx>waitingForLeader</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>sched</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;finished without leader elect&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>关于 client-go LeaderElection 选举的实现原理, 请点击下面连接.</p><p><a href=https://github.com/rfyiamcool/notes/blob/main/kubernetes_leader_election_code.md target=_blank rel="external nofollow noopener noreferrer">https://github.com/rfyiamcool/notes/blob/main/kubernetes_leader_election_code.md</a></p><h2 id=scheudler-启动入口>scheudler 启动入口</h2><p><code>Run()</code> 方法是 k8s scheduler 的启动运行入口, 其流程是先启动 queue 队列的 Run 方法, 再异步启动一个协程处理核心调度方法 <code>scheduleOne</code>.</p><p><code>schedulingQueue</code> 的 <code>Run()</code> 方法用来监听内部的延迟任务, 把到期的任务放到 activeQ 中.</p><p>而 <code>scheduleOne</code> 方法用来从优先级队列里获取由 informer 插入的 pod 对象, 调用 <code>schedulingCycle</code> 为 pod 选择最优的 node 节点. 如果找到了合适的 node 节点, 则调用 <code>bindingCycle</code> 方法来发起 pod 和 node 绑定.</p><p>源码位置: <code>pkg/scheduler/scheduler.go</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>sched</span> <span class=o>*</span><span class=nx>Scheduler</span><span class=p>)</span> <span class=nf>Run</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>sched</span><span class=p>.</span><span class=nx>SchedulingQueue</span><span class=p>.</span><span class=nf>Run</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>go</span> <span class=nx>wait</span><span class=p>.</span><span class=nf>UntilWithContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>scheduleOne</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>&lt;-</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>sched</span><span class=p>.</span><span class=nx>SchedulingQueue</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>sched</span> <span class=o>*</span><span class=nx>Scheduler</span><span class=p>)</span> <span class=nf>scheduleOne</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 从 activeQ 中获取需要调度的 pod 数据
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>podInfo</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nf>NextPod</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>pod</span> <span class=o>:=</span> <span class=nx>podInfo</span><span class=p>.</span><span class=nx>Pod</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 为 pod 选择最优的 node 节点
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>scheduleResult</span><span class=p>,</span> <span class=nx>assumedPodInfo</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nf>schedulingCycle</span><span class=p>(</span><span class=nx>schedulingCycleCtx</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>fwk</span><span class=p>,</span> <span class=nx>podInfo</span><span class=p>,</span> <span class=nx>start</span><span class=p>,</span> <span class=nx>podsToActivate</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 如何没有找到节点，则执行失败方法.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>sched</span><span class=p>.</span><span class=nf>FailureHandler</span><span class=p>(</span><span class=nx>schedulingCycleCtx</span><span class=p>,</span> <span class=nx>fwk</span><span class=p>,</span> <span class=nx>assumedPodInfo</span><span class=p>,</span> <span class=nx>err</span><span class=p>,</span> <span class=nx>scheduleResult</span><span class=p>.</span><span class=nx>reason</span><span class=p>,</span> <span class=nx>scheduleResult</span><span class=p>.</span><span class=nx>nominatingInfo</span><span class=p>,</span> <span class=nx>start</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 像 apiserver 发起 pod -&gt; node 绑定
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>status</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nf>bindingCycle</span><span class=p>(</span><span class=nx>bindingCycleCtx</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>fwk</span><span class=p>,</span> <span class=nx>scheduleResult</span><span class=p>,</span> <span class=nx>assumedPodInfo</span><span class=p>,</span> <span class=nx>start</span><span class=p>,</span> <span class=nx>podsToActivate</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>!</span><span class=nx>status</span><span class=p>.</span><span class=nf>IsSuccess</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>sched</span><span class=p>.</span><span class=nf>handleBindingCycleError</span><span class=p>(</span><span class=nx>bindingCycleCtx</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>fwk</span><span class=p>,</span> <span class=nx>assumedPodInfo</span><span class=p>,</span> <span class=nx>start</span><span class=p>,</span> <span class=nx>scheduleResult</span><span class=p>,</span> <span class=nx>status</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>NextPod</code> 底层引用了 <code>MakeNextPodFunc</code> 方法, 其内部从 <code>PriorityQueue</code> 队列中获取 pod 对象.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>MakeNextPodFunc</span><span class=p>(</span><span class=nx>queue</span> <span class=nx>SchedulingQueue</span><span class=p>)</span> <span class=kd>func</span><span class=p>()</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kd>func</span><span class=p>()</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>podInfo</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>queue</span><span class=p>.</span><span class=nf>Pop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>podInfo</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>PriorityQueue</span><span class=p>)</span> <span class=nf>Pop</span><span class=p>()</span> <span class=p>(</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>p</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>p</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>p</span><span class=p>.</span><span class=nx>activeQ</span><span class=p>.</span><span class=nf>Len</span><span class=p>()</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 没有数据则陷入条件变量的等待接口
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>p</span><span class=p>.</span><span class=nx>cond</span><span class=p>.</span><span class=nf>Wait</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>obj</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nx>activeQ</span><span class=p>.</span><span class=nf>Pop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>pInfo</span> <span class=o>:=</span> <span class=nx>obj</span><span class=p>.(</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>pInfo</span><span class=p>.</span><span class=nx>Attempts</span><span class=o>++</span>  <span class=c1>// 每次 pop 后都增加下 attempts 次数.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>return</span> <span class=nx>pInfo</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=单实例单协程模型的-schduler-调度器>单实例单协程模型的 schduler 调度器</h2><p><img class=lazyload src=/svg/loading.min.svg data-src=https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301261858892.png data-srcset="https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301261858892.png, https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301261858892.png 1.5x, https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301261858892.png 2x" data-sizes=auto alt=https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301261858892.png title=https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301261858892.png></p><p>需要关注的是整个 kubernetes scheduler 调度器只有一个协程处理主调度循环 <code>scheduleOne</code>, 虽然 kubernetes scheduler 可以启动多个实例, 但启动时需要 leaderelection 选举, 只有 leader 才可以处理调度, 其他节点作为 follower 等待 leader 失效. 也就是说整个 k8s 集群调度核心的并发度为 1 个.</p><p>云原生社区中有人使用 kubemark 模拟 2000 个节点的规模来压测 kube-scheduler 处理性能及时延, 测试结果是 30s 内完成 15000 个 pod 调度任务. 虽然 kube-scheduler 是单并发模型, 但由于预选和优选都属于计算型任务非阻塞IO, 又有 <code>percentageOfNodesToScore</code> 参数优化, 最重要的是创建 pod 的操作通常不会太高并发. 这几点下来单并发模型的 scheduler 也还可以接受的.</p><h3 id=为什么-scheduler-不支持并发->为什么 scheduler 不支持并发 ?</h3><p>按照当前 scheudler 调度器的设计原理, 使用预选和优选算法选出最合适的节点, 并发场景下无法保证安全, 比如, 选出的最优节点在并发下会被多个 pod 绑定.</p><h3 id=使用自定义调度器进行并发调度->使用自定义调度器进行并发调度 ?</h3><p>k8s 默认的调度器为 <code>default-scheduler</code>, 而使用相同调度器只能单并发处理调度. 但是可以使用自定义实现调度器的方案, 在创建 pod 时指定不同的调度器算法 <code>pod.Spec.schedulerName = xiaorui.cc</code>, 这样可以使不同调度器的 kube-schedueler 并行调度起来, 各自按照调度算法来调度, 运行互不影响.</p><p>当然大多数公司没这个必要.</p><h2 id=schedulingcycle-核心调度周期的实现>schedulingCycle 核心调度周期的实现</h2><p><code>schedulingCycle()</code> 该方法主要为 pod 选出最优的 node 节点. 先通过预选过程过滤出符合 pod 要求的节点集合, 再通过插件对这些节点进行打分, 使用分值最高的 node 为 pod 调度节点.</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301251629071.png data-srcset="https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301251629071.png, https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301251629071.png 1.5x, https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301251629071.png 2x" data-sizes=auto alt=https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301251629071.png title=https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301251629071.png></p><p>scheduler 内置各个阶段的各种插件, 预选和优选阶段就是遍历回调插件求出结果.</p><p>调度周期 <code>schedulingCycle</code> 内关键方法是 <code>schedulePod</code>, 其简化流程如下.</p><ol><li>先调用 <code>findNodesThatFitPod</code> 过滤出符合要求的预选节点.</li><li>调用 <code>prioritizeNodes</code> 为预选出来的节点进行打分 score.</li><li>最后调用 <code>selectHost</code> 选择最合适的 node 节点.</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>sched</span> <span class=o>*</span><span class=nx>Scheduler</span><span class=p>)</span> <span class=nf>schedulingCycle</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>(</span><span class=nx>ScheduleResult</span><span class=p>,</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>pod</span> <span class=o>:=</span> <span class=nx>podInfo</span><span class=p>.</span><span class=nx>Pod</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 选择节点
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>scheduleResult</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nf>SchedulePod</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>fwk</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 在缓存 cache 中更新状态
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>err</span> <span class=p>=</span> <span class=nx>sched</span><span class=p>.</span><span class=nf>assume</span><span class=p>(</span><span class=nx>assumedPod</span><span class=p>,</span> <span class=nx>scheduleResult</span><span class=p>.</span><span class=nx>SuggestedHost</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>sched</span> <span class=o>*</span><span class=nx>Scheduler</span><span class=p>)</span> <span class=nf>schedulePod</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>fwk</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>Framework</span><span class=p>,</span> <span class=nx>state</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>CycleState</span><span class=p>,</span> <span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=p>(</span><span class=nx>result</span> <span class=nx>ScheduleResult</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 更新快照
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>Cache</span><span class=p>.</span><span class=nf>UpdateSnapshot</span><span class=p>(</span><span class=nx>sched</span><span class=p>.</span><span class=nx>nodeInfoSnapshot</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>result</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 进行预选筛选
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>feasibleNodes</span><span class=p>,</span> <span class=nx>diagnosis</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nf>findNodesThatFitPod</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>fwk</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>result</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 预选下来，无节点可以用, 返回错误
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>feasibleNodes</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>result</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>framework</span><span class=p>.</span><span class=nx>FitError</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>Pod</span><span class=p>:</span>         <span class=nx>pod</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>NumAllNodes</span><span class=p>:</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>nodeInfoSnapshot</span><span class=p>.</span><span class=nf>NumNodes</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>			<span class=nx>Diagnosis</span><span class=p>:</span>   <span class=nx>diagnosis</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 经过预选就只有一个节点，那么直接返回
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>feasibleNodes</span><span class=p>)</span> <span class=o>==</span> <span class=mi>1</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>ScheduleResult</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>SuggestedHost</span><span class=p>:</span>  <span class=nx>feasibleNodes</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>Name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>EvaluatedNodes</span><span class=p>:</span> <span class=mi>1</span> <span class=o>+</span> <span class=nb>len</span><span class=p>(</span><span class=nx>diagnosis</span><span class=p>.</span><span class=nx>NodeToStatusMap</span><span class=p>),</span>
</span></span><span class=line><span class=cl>			<span class=nx>FeasibleNodes</span><span class=p>:</span>  <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 进行优选过程, 对预选出来的节点进行打分
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>priorityList</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>prioritizeNodes</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>Extenders</span><span class=p>,</span> <span class=nx>fwk</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>pod</span><span class=p>,</span> <span class=nx>feasibleNodes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>result</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 从优选中选出最高分的节点
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>host</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>selectHost</span><span class=p>(</span><span class=nx>priorityList</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>ScheduleResult</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>SuggestedHost</span><span class=p>:</span>  <span class=nx>host</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>EvaluatedNodes</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=nx>feasibleNodes</span><span class=p>)</span> <span class=o>+</span> <span class=nb>len</span><span class=p>(</span><span class=nx>diagnosis</span><span class=p>.</span><span class=nx>NodeToStatusMap</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>FeasibleNodes</span><span class=p>:</span>  <span class=nb>len</span><span class=p>(</span><span class=nx>feasibleNodes</span><span class=p>),</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=findnodesthatfitpod>findNodesThatFitPod</h3><p><code>findNodesThatFitPod</code> 方法用来实现调度器的预选过程, 其内部调用插件的 PreFilter 和 Filter 方法来筛选出符合 pod 要求的 node 节点集合.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>sched</span> <span class=o>*</span><span class=nx>Scheduler</span><span class=p>)</span> <span class=nf>findNodesThatFitPod</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>fwk</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>Framework</span><span class=p>,</span> <span class=nx>state</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>CycleState</span><span class=p>,</span> <span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=p>([]</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Node</span><span class=p>,</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>Diagnosis</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>diagnosis</span> <span class=o>:=</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>Diagnosis</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>NodeToStatusMap</span><span class=p>:</span>      <span class=nb>make</span><span class=p>(</span><span class=nx>framework</span><span class=p>.</span><span class=nx>NodeToStatusMap</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>UnschedulablePlugins</span><span class=p>:</span> <span class=nx>sets</span><span class=p>.</span><span class=nf>NewString</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 获取所有的 nodes
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>allNodes</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>nodeInfoSnapshot</span><span class=p>.</span><span class=nf>NodeInfos</span><span class=p>().</span><span class=nf>List</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>diagnosis</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 调用 framework 的 PreFilter 集合里的插件
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>preRes</span><span class=p>,</span> <span class=nx>s</span> <span class=o>:=</span> <span class=nx>fwk</span><span class=p>.</span><span class=nf>RunPreFilterPlugins</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>s</span><span class=p>.</span><span class=nf>IsSuccess</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 如果在 prefilter 有异常, 则直接跳出.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=p>!</span><span class=nx>s</span><span class=p>.</span><span class=nf>IsUnschedulable</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>diagnosis</span><span class=p>,</span> <span class=nx>s</span><span class=p>.</span><span class=nf>AsError</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>msg</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nf>Message</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=nx>diagnosis</span><span class=p>.</span><span class=nx>PreFilterMsg</span> <span class=p>=</span> <span class=nx>msg</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>diagnosis</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 根据 prefilter 拿到的 node names 获取 node info 对象.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>nodes</span> <span class=o>:=</span> <span class=nx>allNodes</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>preRes</span><span class=p>.</span><span class=nf>AllNodes</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>nodes</span> <span class=p>=</span> <span class=nb>make</span><span class=p>([]</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>NodeInfo</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>preRes</span><span class=p>.</span><span class=nx>NodeNames</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>n</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>preRes</span><span class=p>.</span><span class=nx>NodeNames</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>nInfo</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>nodeInfoSnapshot</span><span class=p>.</span><span class=nf>NodeInfos</span><span class=p>().</span><span class=nf>Get</span><span class=p>(</span><span class=nx>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>diagnosis</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>nodes</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>nodes</span><span class=p>,</span> <span class=nx>nInfo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 运行 framework 的 filter 插件判断 node 是否可以运行新 pod.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>feasibleNodes</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nf>findNodesThatPassFilters</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>fwk</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>pod</span><span class=p>,</span> <span class=nx>diagnosis</span><span class=p>,</span> <span class=nx>nodes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 调用额外的 extender 调度器来进行预选
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>feasibleNodes</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nf>findNodesThatPassExtenders</span><span class=p>(</span><span class=nx>sched</span><span class=p>.</span><span class=nx>Extenders</span><span class=p>,</span> <span class=nx>pod</span><span class=p>,</span> <span class=nx>feasibleNodes</span><span class=p>,</span> <span class=nx>diagnosis</span><span class=p>.</span><span class=nx>NodeToStatusMap</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>diagnosis</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>feasibleNodes</span><span class=p>,</span> <span class=nx>diagnosis</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=findnodesthatpassfilters-并发执行-filter-插件方法>findNodesThatPassFilters 并发执行 Filter 插件方法</h4><p><img class=lazyload src=/svg/loading.min.svg data-src=https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301252324752.png data-srcset="https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301252324752.png, https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301252324752.png 1.5x, https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301252324752.png 2x" data-sizes=auto alt=https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301252324752.png title=https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301252324752.png></p><p><code>findNodesThatPassFilters</code> 方法用来遍历执行 framework 里 Filter 插件集合的 Filter 方法.</p><p>为了加快执行效率, 减少预选阶段的时延, framework 内部有个 Parallelizer 并发控制器, 启用 16 个协程并发调用插件的 Filter 方法. 在大集群下 nodes 节点会很多, 为了避免遍历全量的 nodes 执行 Filter 和后续的插件逻辑, 这里通过 <code>numFeasibleNodesToFind</code> 方法来减少扫描计算的 nodes 数量.</p><p>当成功执行 filter 插件方法的数量超过 numNodesToFind 时, 则执行 context cancel(). 这样 framework 并发协程池监听到 ctx 被关闭后, 则不会继续执行后续的任务.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>sched</span> <span class=o>*</span><span class=nx>Scheduler</span><span class=p>)</span> <span class=nf>findNodesThatPassFilters</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>fwk</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>Framework</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>nodes</span> <span class=p>[]</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>NodeInfo</span><span class=p>)</span> <span class=p>([]</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Node</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>numAllNodes</span> <span class=o>:=</span> <span class=nb>len</span><span class=p>(</span><span class=nx>nodes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 计算需要扫描的 nodes 数, 避免了超大集群下 nodes 的计算数量.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// 当集群的节点数小于 100 时, 则直接使用集群的节点数作为扫描数据量
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// 当大于 100 时, 则使用公式计算 `numAllNodes * (50 - numAllNodes/125) / 100`
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>numNodesToFind</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nf>numFeasibleNodesToFind</span><span class=p>(</span><span class=nx>fwk</span><span class=p>.</span><span class=nf>PercentageOfNodesToScore</span><span class=p>(),</span> <span class=nb>int32</span><span class=p>(</span><span class=nx>numAllNodes</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>feasibleNodes</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Node</span><span class=p>,</span> <span class=nx>numNodesToFind</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 如果 framework 未注册 Filter 插件, 则退出.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=p>!</span><span class=nx>fwk</span><span class=p>.</span><span class=nf>HasFilterPlugins</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>feasibleNodes</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>feasibleNodes</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=p>=</span> <span class=nx>nodes</span><span class=p>[(</span><span class=nx>sched</span><span class=p>.</span><span class=nx>nextStartNodeIndex</span><span class=o>+</span><span class=nx>i</span><span class=p>)</span><span class=o>%</span><span class=nx>numAllNodes</span><span class=p>].</span><span class=nf>Node</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>feasibleNodes</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// framework 内置并发控制器, 并发 16 个协程去请求插件的 Filter 方法.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>errCh</span> <span class=o>:=</span> <span class=nx>parallelize</span><span class=p>.</span><span class=nf>NewErrorChannel</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>statusesLock</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>checkNode</span> <span class=o>:=</span> <span class=kd>func</span><span class=p>(</span><span class=nx>i</span> <span class=kt>int</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 获取 node info 对象
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>nodeInfo</span> <span class=o>:=</span> <span class=nx>nodes</span><span class=p>[(</span><span class=nx>sched</span><span class=p>.</span><span class=nx>nextStartNodeIndex</span><span class=o>+</span><span class=nx>i</span><span class=p>)</span><span class=o>%</span><span class=nx>numAllNodes</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// 遍历执行 framework 的 Filter 插件的 Filter 方法.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>status</span> <span class=o>:=</span> <span class=nx>fwk</span><span class=p>.</span><span class=nf>RunFilterPluginsWithNominatedPods</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>pod</span><span class=p>,</span> <span class=nx>nodeInfo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>status</span><span class=p>.</span><span class=nf>Code</span><span class=p>()</span> <span class=o>==</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>Error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// 如果有错误, 直接把错误传到 errCh 管道里.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>errCh</span><span class=p>.</span><span class=nf>SendErrorWithCancel</span><span class=p>(</span><span class=nx>status</span><span class=p>.</span><span class=nf>AsError</span><span class=p>(),</span> <span class=nx>cancel</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>status</span><span class=p>.</span><span class=nf>IsSuccess</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// 如果成功执行 Filter 插件的数量超过 numNodesToFind, 则执行 cancel().
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// 当 ctx 被 cancel(), framework 的并发协程池不会继续执行后续的任务.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>length</span> <span class=o>:=</span> <span class=nx>atomic</span><span class=p>.</span><span class=nf>AddInt32</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>feasibleNodesLen</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>length</span> <span class=p>&gt;</span> <span class=nx>numNodesToFind</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nf>cancel</span><span class=p>()</span>
</span></span><span class=line><span class=cl>				<span class=nx>atomic</span><span class=p>.</span><span class=nf>AddInt32</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>feasibleNodesLen</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>feasibleNodes</span><span class=p>[</span><span class=nx>length</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=p>=</span> <span class=nx>nodeInfo</span><span class=p>.</span><span class=nf>Node</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=o>...</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 并发调用 framework 的 Filter 插件的 Filter 方法.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>fwk</span><span class=p>.</span><span class=nf>Parallelizer</span><span class=p>().</span><span class=nf>Until</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>numAllNodes</span><span class=p>,</span> <span class=nx>checkNode</span><span class=p>,</span> <span class=nx>frameworkruntime</span><span class=p>.</span><span class=nx>Filter</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>feasibleNodes</span> <span class=p>=</span> <span class=nx>feasibleNodes</span><span class=p>[:</span><span class=nx>feasibleNodesLen</span><span class=p>]</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>errCh</span><span class=p>.</span><span class=nf>ReceiveError</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 当有错误时, 直接返回.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>statusCode</span> <span class=p>=</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>Error</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>feasibleNodes</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 返回可用的 nodes 列表.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>return</span> <span class=nx>feasibleNodes</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>framework 的并发库也是通过封装 <code>workqueue.ParallelizeUntil</code> 来实现的, 关于 <code>parallelizer</code> 的实现原理这里就不做分析了.</p><p><code>k8s.io/client-go/util/workqueue/parallelizer.go</code></p><h4 id=numfeasiblenodestofind-计算多少节点参与预选>numFeasibleNodesToFind 计算多少节点参与预选</h4><p><img class=lazyload src=/svg/loading.min.svg data-src=https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301261120469.png data-srcset="https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301261120469.png, https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301261120469.png 1.5x, https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301261120469.png 2x" data-sizes=auto alt=https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301261120469.png title=https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301261120469.png></p><p>🤔 考虑一个问题, 当 k8s 的 node 节点特别多时, 这些节点都要参与预先的调度过程么 ? 比如大集群有 2500 个节点, 注册的插件有 10 个, 那么 筛选 Filter 和 打分 Score 过程需要进行 2500 * 10 * 2 = 50000 次计算, 最后选定一个最高分值的节点来绑定 pod. k8s scheduler 考虑到了这样的性能开销, 所以加入了百分比参数控制参与预选的节点数.</p><p><code>numFeasibleNodesToFind</code> 方法根据当前集群的节点数计算出参与预选的节点数量, 把参与 Filter 的节点范围缩小, 无需全面扫描所有的节点, 这样避免 k8s 集群 nodes 太多时, 造成无效的计算资源开销.</p><p><code>numFeasibleNodesToFind</code> 策略是这样的, 当集群节点小于 100 时, 集群中的所有节点都参与预选. 而当大于 100 时, 则使用下面的公式计算扫描数. scheudler 的 <code>percentageOfNodesToScore</code> 参数默认为 0, 源码中会赋值为 50 %.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>numAllNodes * (50 - numAllNodes/125) / 100
</span></span></code></pre></td></tr></table></div></div><p>假设当前集群有 <code>500</code> 个 nodes 节点, 那么需要执行 Filter 插件方法的 nodee 节点有 <code>500 * (50 - 500/125) / 100 = 230</code> 个.</p><p><code>numFeasibleNodesToFind</code> 只是表明扫到这个节点数后就结束了, 但如果前面执行插件发生失败时, 自然会加大扫描数.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>sched</span> <span class=o>*</span><span class=nx>Scheduler</span><span class=p>)</span> <span class=nf>numFeasibleNodesToFind</span><span class=p>(</span><span class=nx>percentageOfNodesToScore</span> <span class=o>*</span><span class=kt>int32</span><span class=p>,</span> <span class=nx>numAllNodes</span> <span class=kt>int32</span><span class=p>)</span> <span class=p>(</span><span class=nx>numNodes</span> <span class=kt>int32</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 当前的集群小于 100 时, 则直接使用集群节点数作为扫描数
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>numAllNodes</span> <span class=p>&lt;</span> <span class=nx>minFeasibleNodesToFind</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>numAllNodes</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// k8s scheduler 的 nodes 百分比默认为 0
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kd>var</span> <span class=nx>percentage</span> <span class=kt>int32</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>percentageOfNodesToScore</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>percentage</span> <span class=p>=</span> <span class=o>*</span><span class=nx>percentageOfNodesToScore</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>percentage</span> <span class=p>=</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>percentageOfNodesToScore</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>percentage</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>percentage</span> <span class=p>=</span> <span class=nb>int32</span><span class=p>(</span><span class=mi>50</span><span class=p>)</span> <span class=o>-</span> <span class=nx>numAllNodes</span><span class=o>/</span><span class=mi>125</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 不能小于 5
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>percentage</span> <span class=p>&lt;</span> <span class=nx>minFeasibleNodesPercentageToFind</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>percentage</span> <span class=p>=</span> <span class=nx>minFeasibleNodesPercentageToFind</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 需要扫描的节点数
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>numNodes</span> <span class=p>=</span> <span class=nx>numAllNodes</span> <span class=o>*</span> <span class=nx>percentage</span> <span class=o>/</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 如果小于 100, 则使用 100 作为扫描数. 
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>numNodes</span> <span class=p>&lt;</span> <span class=nx>minFeasibleNodesToFind</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>minFeasibleNodesToFind</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>numNodes</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=prioritizenodes>prioritizeNodes</h3><p><code>prioritizeNodes</code> 方法为调度器的优选阶段的实现. 其内部会遍历调用 framework 的 PreScore 插件集合里 <code>PeScore</code> 方法, 然后再遍历调用 framework 的 Score 插件集合的 <code>Score</code> 方法. 经过 Score 打分计算后可以拿到各个 node 的分值.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>prioritizeNodes</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>extenders</span> <span class=p>[]</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Extender</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>fwk</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>Framework</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>state</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>CycleState</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>nodes</span> <span class=p>[]</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Node</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>([]</span><span class=nx>framework</span><span class=p>.</span><span class=nx>NodePluginScores</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 如果 extenders 为空和score 插件为空, 则跳出
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>extenders</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=p>!</span><span class=nx>fwk</span><span class=p>.</span><span class=nf>HasScorePlugins</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>result</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=nx>framework</span><span class=p>.</span><span class=nx>NodePluginScores</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>nodes</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>nodes</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>result</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>result</span><span class=p>,</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>NodePluginScores</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>Name</span><span class=p>:</span>       <span class=nx>nodes</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>Name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>TotalScore</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>})</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>result</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 在 framework 的 PreScore 插件集合里, 遍历执行插件的 PreSocre 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>preScoreStatus</span> <span class=o>:=</span> <span class=nx>fwk</span><span class=p>.</span><span class=nf>RunPreScorePlugins</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>pod</span><span class=p>,</span> <span class=nx>nodes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>preScoreStatus</span><span class=p>.</span><span class=nf>IsSuccess</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 只有有异常直接退出
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>preScoreStatus</span><span class=p>.</span><span class=nf>AsError</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 在 framework 的 Score 插件集合里, 遍历执行插件的 Socre 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>nodesScores</span><span class=p>,</span> <span class=nx>scoreStatus</span> <span class=o>:=</span> <span class=nx>fwk</span><span class=p>.</span><span class=nf>RunScorePlugins</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>pod</span><span class=p>,</span> <span class=nx>nodes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>scoreStatus</span><span class=p>.</span><span class=nf>IsSuccess</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>scoreStatus</span><span class=p>.</span><span class=nf>AsError</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>klogV</span> <span class=o>:=</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>klogV</span><span class=p>.</span><span class=nf>Enabled</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>nodeScore</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>nodesScores</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// 打印插件名字和分值 score
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>pluginScore</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>nodeScore</span><span class=p>.</span><span class=nx>Scores</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>klogV</span><span class=p>.</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;Plugin scored node for pod&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>),</span> <span class=s>&#34;plugin&#34;</span><span class=p>,</span> <span class=nx>pluginScore</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=s>&#34;node&#34;</span><span class=p>,</span> <span class=nx>nodeScore</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=s>&#34;score&#34;</span><span class=p>,</span> <span class=nx>pluginScore</span><span class=p>.</span><span class=nx>Score</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>extenders</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=nx>nodes</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 当额外 extenders 调度器不为空时, 则需要计算分值.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=o>...</span>
</span></span><span class=line><span class=cl>		<span class=o>...</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>nodesScores</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=selecthost>selectHost</h3><p><code>selectHost</code> 是从优选的 nodes 集合里获取分值 socre 最高的 node. 内部还做了一个小优化, 当相近的两个 node 分值相同时, 则通过随机来选择 node, 目的使 k8s node 的负载更趋于均衡.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>selectHost</span><span class=p>(</span><span class=nx>nodeScores</span> <span class=p>[]</span><span class=nx>framework</span><span class=p>.</span><span class=nx>NodePluginScores</span><span class=p>)</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 如果 nodes 为空, 则返回错误
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>nodeScores</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;empty priorityList&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 直接从头到位遍历 nodeScores 数组, 拿到分值 score 最后的 nodeName.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>maxScore</span> <span class=o>:=</span> <span class=nx>nodeScores</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>TotalScore</span>
</span></span><span class=line><span class=cl>	<span class=nx>selected</span> <span class=o>:=</span> <span class=nx>nodeScores</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>Name</span>
</span></span><span class=line><span class=cl>	<span class=nx>cntOfMaxScore</span> <span class=o>:=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>ns</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>nodeScores</span><span class=p>[</span><span class=mi>1</span><span class=p>:]</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>ns</span><span class=p>.</span><span class=nx>TotalScore</span> <span class=p>&gt;</span> <span class=nx>maxScore</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// 当前的分值更大, 则进行赋值.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>maxScore</span> <span class=p>=</span> <span class=nx>ns</span><span class=p>.</span><span class=nx>TotalScore</span>
</span></span><span class=line><span class=cl>			<span class=nx>selected</span> <span class=p>=</span> <span class=nx>ns</span><span class=p>.</span><span class=nx>Name</span>
</span></span><span class=line><span class=cl>			<span class=nx>cntOfMaxScore</span> <span class=p>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>ns</span><span class=p>.</span><span class=nx>TotalScore</span> <span class=o>==</span> <span class=nx>maxScore</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// 当两个 node 的 分值相同时, 
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// 使用随机算法来选择当前和上一个 node.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>cntOfMaxScore</span><span class=o>++</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>rand</span><span class=p>.</span><span class=nf>Intn</span><span class=p>(</span><span class=nx>cntOfMaxScore</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>selected</span> <span class=p>=</span> <span class=nx>ns</span><span class=p>.</span><span class=nx>Name</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 返回分值最高的 node
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>return</span> <span class=nx>selected</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=priorityqueue-的实现>PriorityQueue 的实现</h3><p><code>PriorityQueue</code> 用来实现优先级队列, informer 会条件 pod 到 priorityQueue 队列中, <code>scheduleOne</code> 会从该队列中 pop 对象. 在创建延迟队列时传入一个 <code>less</code> 比较方法, 时间最小的 podInfo 放在 heap 的最顶端.</p><p><code>flushBackoffQCompleted</code> 会不断的检查 backoff heap 堆顶的元素是否满足条件, 当满足条件把 pod 对象扔到 activeQ 队里, 并激活条件变量. 这里没有采用监听等待堆顶到期时间的方法，而是每隔一秒去检查堆顶的 podInfo 是否已到期 <code>isPodBackingoff</code>.</p><p>backoff 时长是依赖 podInfo.Attempts 重试次数的，默认情况下重试 5次 是 5s, 最大不能超过 10s. 主调度方法 <code>scheduleOne</code> 每次从队列获取 podInfo 时, 它的 Attempts 字段都会加一.</p><p>代码位置: <code>pkg/scheduler/internal/queue/scheduling_queue.go</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>const</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>DefaultPodMaxBackoffDuration</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span> <span class=p>=</span> <span class=mi>10</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 实例化优先级队列，该队列中含有 activeQ, podBackoffQ, unschedulablePods集合.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>NewPriorityQueue</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>pq</span><span class=p>.</span><span class=nx>podBackoffQ</span> <span class=p>=</span> <span class=nx>heap</span><span class=p>.</span><span class=nf>NewWithRecorder</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=nx>podInfoKeyFunc</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>		<span class=nx>pq</span><span class=p>.</span><span class=nx>podsCompareBackoffCompleted</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>		<span class=o>...</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 添加 pod 对象
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>PriorityQueue</span><span class=p>)</span> <span class=nf>Add</span><span class=p>(</span><span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>p</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>p</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>pInfo</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nf>newQueuedPodInfo</span><span class=p>(</span><span class=nx>pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>gated</span> <span class=o>:=</span> <span class=nx>pInfo</span><span class=p>.</span><span class=nx>Gated</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 把对象加到 activeQ 队列里.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>added</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nf>addToActiveQ</span><span class=p>(</span><span class=nx>pInfo</span><span class=p>);</span> <span class=p>!</span><span class=nx>added</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 如果该对象在不可调度集合中存在, 则需要在里面删除.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>p</span><span class=p>.</span><span class=nx>unschedulablePods</span><span class=p>.</span><span class=nf>get</span><span class=p>(</span><span class=nx>pod</span><span class=p>)</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>p</span><span class=p>.</span><span class=nx>unschedulablePods</span><span class=p>.</span><span class=nb>delete</span><span class=p>(</span><span class=nx>pod</span><span class=p>,</span> <span class=nx>gated</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 从 backoffQ 删除 pod 对象
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nx>podBackoffQ</span><span class=p>.</span><span class=nf>Delete</span><span class=p>(</span><span class=nx>pInfo</span><span class=p>);</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=kc>nil</span><span class=p>,</span> <span class=s>&#34;Error: pod is already in the podBackoff queue&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 条件变量通知
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>p</span><span class=p>.</span><span class=nx>cond</span><span class=p>.</span><span class=nf>Broadcast</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 获取 pod info 对象
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>PriorityQueue</span><span class=p>)</span> <span class=nf>Pop</span><span class=p>()</span> <span class=p>(</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>p</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>p</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 如果 activeQ 为空, 陷入等待
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>for</span> <span class=nx>p</span><span class=p>.</span><span class=nx>activeQ</span><span class=p>.</span><span class=nf>Len</span><span class=p>()</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>p</span><span class=p>.</span><span class=nx>closed</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=nx>queueClosed</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>p</span><span class=p>.</span><span class=nx>cond</span><span class=p>.</span><span class=nf>Wait</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 从 activeQ 堆顶 pop 对象
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>obj</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nx>activeQ</span><span class=p>.</span><span class=nf>Pop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>pInfo</span> <span class=o>:=</span> <span class=nx>obj</span><span class=p>.(</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 加一
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>pInfo</span><span class=p>.</span><span class=nx>Attempts</span><span class=o>++</span>
</span></span><span class=line><span class=cl>	<span class=nx>p</span><span class=p>.</span><span class=nx>schedulingCycle</span><span class=o>++</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>pInfo</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// heap 的比较方法，确保 deadline 最低的在 heap 顶部.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>PriorityQueue</span><span class=p>)</span> <span class=nf>podsCompareBackoffCompleted</span><span class=p>(</span><span class=nx>podInfo1</span><span class=p>,</span> <span class=nx>podInfo2</span> <span class=kd>interface</span><span class=p>{})</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>bo1</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nf>getBackoffTime</span><span class=p>(</span><span class=nx>pInfo1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>bo2</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nf>getBackoffTime</span><span class=p>(</span><span class=nx>pInfo2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>bo1</span><span class=p>.</span><span class=nf>Before</span><span class=p>(</span><span class=nx>bo2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>PriorityQueue</span><span class=p>)</span> <span class=nf>getBackoffTime</span><span class=p>(</span><span class=nx>podInfo</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span><span class=p>)</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>duration</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nf>calculateBackoffDuration</span><span class=p>(</span><span class=nx>podInfo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>backoffTime</span> <span class=o>:=</span> <span class=nx>podInfo</span><span class=p>.</span><span class=nx>Timestamp</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>duration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>backoffTime</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// backoff duration 随着重试次数不断叠加，但最大不能超过 maxBackoffDuration.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>PriorityQueue</span><span class=p>)</span> <span class=nf>calculateBackoffDuration</span><span class=p>(</span><span class=nx>podInfo</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span><span class=p>)</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>duration</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nx>podInitialBackoffDuration</span> <span class=c1>// 1s
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>1</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nx>podInfo</span><span class=p>.</span><span class=nx>Attempts</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>duration</span> <span class=p>&gt;</span> <span class=nx>p</span><span class=p>.</span><span class=nx>podMaxBackoffDuration</span><span class=o>-</span><span class=nx>duration</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>p</span><span class=p>.</span><span class=nx>podMaxBackoffDuration</span> <span class=c1>// 10s
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>duration</span> <span class=o>+=</span> <span class=nx>duration</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>duration</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=如何处理调度失败的-pod>如何处理调度失败的 pod</h3><p>前面有说 kubernetes scheduler 的 <code>scheduleOne</code> 作为主循环处理函数，当没有为 pod 找到合适 node 时，会调用 <code>FailureHandler</code> 方法.</p><p><code>FailureHandler()</code> 是由 <code>handleSchedulingFailure()</code> 方法实现. 该逻辑的实现简单说就是把失败的 pod 扔到 podBackoffQ 队列或者 unschedulablePods 集合里.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>sched</span> <span class=o>*</span><span class=nx>Scheduler</span><span class=p>)</span> <span class=nf>handleSchedulingFailure</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>fwk</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>Framework</span><span class=p>,</span> <span class=nx>podInfo</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>,</span> <span class=nx>reason</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>nominatingInfo</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>NominatingInfo</span><span class=p>,</span> <span class=nx>start</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>podLister</span> <span class=o>:=</span> <span class=nx>fwk</span><span class=p>.</span><span class=nf>SharedInformerFactory</span><span class=p>().</span><span class=nf>Core</span><span class=p>().</span><span class=nf>V1</span><span class=p>().</span><span class=nf>Pods</span><span class=p>().</span><span class=nf>Lister</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>cachedPod</span><span class=p>,</span> <span class=nx>e</span> <span class=o>:=</span> <span class=nx>podLister</span><span class=p>.</span><span class=nf>Pods</span><span class=p>(</span><span class=nx>pod</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>).</span><span class=nf>Get</span><span class=p>(</span><span class=nx>pod</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>e</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>cachedPod</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>NodeName</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;Pod has been assigned to node. Abort adding it back to queue.&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>),</span> <span class=s>&#34;node&#34;</span><span class=p>,</span> <span class=nx>cachedPod</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>NodeName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>podInfo</span><span class=p>.</span><span class=nx>PodInfo</span><span class=p>,</span> <span class=nx>_</span> <span class=p>=</span> <span class=nx>framework</span><span class=p>.</span><span class=nf>NewPodInfo</span><span class=p>(</span><span class=nx>cachedPod</span><span class=p>.</span><span class=nf>DeepCopy</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=c1>// 重新入队列
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>SchedulingQueue</span><span class=p>.</span><span class=nf>AddUnschedulableIfNotPresent</span><span class=p>(</span><span class=nx>podInfo</span><span class=p>,</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>SchedulingQueue</span><span class=p>.</span><span class=nf>SchedulingCycle</span><span class=p>());</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;Error occurred&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>PriorityQueue</span><span class=p>)</span> <span class=nf>AddUnschedulableIfNotPresent</span><span class=p>(</span><span class=nx>pInfo</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span><span class=p>,</span> <span class=nx>podSchedulingCycle</span> <span class=kt>int64</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>pod</span> <span class=o>:=</span> <span class=nx>pInfo</span><span class=p>.</span><span class=nx>Pod</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 去重判断
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>exists</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nx>activeQ</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=nx>pInfo</span><span class=p>);</span> <span class=nx>exists</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Pod %v is already present in the active queue&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 去重判断
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>exists</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nx>podBackoffQ</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=nx>pInfo</span><span class=p>);</span> <span class=nx>exists</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Pod %v is already present in the backoff queue&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 把没有调度成功的 podInfo 扔到 backoffQ 队列或者 unschedulablePods 集合中.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>p</span><span class=p>.</span><span class=nx>moveRequestCycle</span> <span class=o>&gt;=</span> <span class=nx>podSchedulingCycle</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nx>podBackoffQ</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>pInfo</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;error adding pod %v to the backoff queue: %v&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>),</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>p</span><span class=p>.</span><span class=nx>unschedulablePods</span><span class=p>.</span><span class=nf>addOrUpdate</span><span class=p>(</span><span class=nx>pInfo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>scheduler queue 在启动时会开启两个常驻的协程. 一个协程来管理 <code>flushBackoffQCompleted()</code>，每隔一秒来调用一次. 另一个协程来管理 <code>flushUnschedulablePodsLeftover</code>, 每隔三十秒来调用一次.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Run starts the goroutine to pump from podBackoffQ to activeQ
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>PriorityQueue</span><span class=p>)</span> <span class=nf>Run</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>go</span> <span class=nx>wait</span><span class=p>.</span><span class=nf>Until</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>flushBackoffQCompleted</span><span class=p>,</span> <span class=mf>1.0</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>,</span> <span class=nx>p</span><span class=p>.</span><span class=nx>stop</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>go</span> <span class=nx>wait</span><span class=p>.</span><span class=nf>Until</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>flushUnschedulablePodsLeftover</span><span class=p>,</span> <span class=mi>30</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>,</span> <span class=nx>p</span><span class=p>.</span><span class=nx>stop</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>flushBackoffQCompleted</code> 从 podBackoffQ 获取 podInfo, 然后扔到 activeQ 里，等待 scheduleOne 来调度处理.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>PriorityQueue</span><span class=p>)</span> <span class=nf>flushBackoffQCompleted</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>activated</span> <span class=o>:=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>rawPodInfo</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nx>podBackoffQ</span><span class=p>.</span><span class=nf>Peek</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=nx>pInfo</span> <span class=o>:=</span> <span class=nx>rawPodInfo</span><span class=p>.(</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>pod</span> <span class=o>:=</span> <span class=nx>pInfo</span><span class=p>.</span><span class=nx>Pod</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>		<span class=c1>// 从 podBackoffQ 中获取上次调度失败的 podInfo.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nx>podBackoffQ</span><span class=p>.</span><span class=nf>Pop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;Unable to pop pod from backoff queue despite backoff completion&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=k>break</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>		<span class=c1>// 然后把这 podInfo 再扔到 activeQ 里，让 scheduleOne 主循环来处理.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>added</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nf>addToActiveQ</span><span class=p>(</span><span class=nx>pInfo</span><span class=p>);</span> <span class=nx>added</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>5</span><span class=p>).</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;Pod moved to an internal scheduling queue&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>),</span> <span class=s>&#34;event&#34;</span><span class=p>,</span> <span class=nx>BackoffComplete</span><span class=p>,</span> <span class=s>&#34;queue&#34;</span><span class=p>,</span> <span class=nx>activeQName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>activated</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 如果有添加成功的，则激活条件变量.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>activated</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>p</span><span class=p>.</span><span class=nx>cond</span><span class=p>.</span><span class=nf>Broadcast</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>flushUnschedulablePodsLeftover</code> 加锁遍历 PodInfoMap, 如果某个 pod 的距离上次的调度时间大于60s, 则扔到两个队列中的一个，否则等待下个 30s 再来处理.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>PriorityQueue</span><span class=p>)</span> <span class=nf>flushUnschedulablePodsLeftover</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>p</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>p</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>podsToMove</span> <span class=p>[]</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>pInfo</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>p</span><span class=p>.</span><span class=nx>unschedulablePods</span><span class=p>.</span><span class=nx>podInfoMap</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>lastScheduleTime</span> <span class=o>:=</span> <span class=nx>pInfo</span><span class=p>.</span><span class=nx>Timestamp</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>currentTime</span><span class=p>.</span><span class=nf>Sub</span><span class=p>(</span><span class=nx>lastScheduleTime</span><span class=p>)</span> <span class=p>&gt;</span> <span class=nx>p</span><span class=p>.</span><span class=nx>podMaxInUnschedulablePodsDuration</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>podsToMove</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>podsToMove</span><span class=p>,</span> <span class=nx>pInfo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>podsToMove</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 把 podInfo 扔到 activeQ 和 backoffQ 队列中.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>p</span><span class=p>.</span><span class=nf>movePodsToActiveOrBackoffQueue</span><span class=p>(</span><span class=nx>podsToMove</span><span class=p>,</span> <span class=nx>UnschedulableTimeout</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>PriorityQueue</span><span class=p>)</span> <span class=nf>movePodsToActiveOrBackoffQueue</span><span class=p>(</span><span class=nx>podInfoList</span> <span class=p>[]</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span><span class=p>,</span> <span class=nx>event</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>ClusterEvent</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>activated</span> <span class=o>:=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>pInfo</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>podInfoList</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>pod</span> <span class=o>:=</span> <span class=nx>pInfo</span><span class=p>.</span><span class=nx>Pod</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>p</span><span class=p>.</span><span class=nf>isPodBackingoff</span><span class=p>(</span><span class=nx>pInfo</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// 如果还需要 backoff 退避, 则扔到 podBackoffQ 队列中进行延迟, 后面由 flushBackoffQCompleted 处理.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nx>podBackoffQ</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>pInfo</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>p</span><span class=p>.</span><span class=nx>unschedulablePods</span><span class=p>.</span><span class=nb>delete</span><span class=p>(</span><span class=nx>pod</span><span class=p>,</span> <span class=nx>pInfo</span><span class=p>.</span><span class=nx>Gated</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// 把 podInfo 扔到 activeQ 里, 等待 scheduleOne 调度处理.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>if</span> <span class=nx>added</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nf>addToActiveQ</span><span class=p>(</span><span class=nx>pInfo</span><span class=p>);</span> <span class=nx>added</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>activated</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>				<span class=nx>p</span><span class=p>.</span><span class=nx>unschedulablePods</span><span class=p>.</span><span class=nb>delete</span><span class=p>(</span><span class=nx>pod</span><span class=p>,</span> <span class=nx>gated</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=bindingcycle-实现-pod-和-node-绑定>bindingCycle 实现 pod 和 node 绑定</h2><p><code>bindingCycle</code> 用来实现 pod 和 node 绑定, 其过程为 <code>prebind -> bind -> postbind</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>sched</span> <span class=o>*</span><span class=nx>Scheduler</span><span class=p>)</span> <span class=nf>bindingCycle</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=o>...</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>assumedPod</span> <span class=o>:=</span> <span class=nx>assumedPodInfo</span><span class=p>.</span><span class=nx>Pod</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 执行插件的 prebind 逻辑
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>status</span> <span class=o>:=</span> <span class=nx>fwk</span><span class=p>.</span><span class=nf>RunPreBindPlugins</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>assumedPod</span><span class=p>,</span> <span class=nx>scheduleResult</span><span class=p>.</span><span class=nx>SuggestedHost</span><span class=p>);</span> <span class=p>!</span><span class=nx>status</span><span class=p>.</span><span class=nf>IsSuccess</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>status</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 执行 bind 插件逻辑
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>status</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nf>bind</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>fwk</span><span class=p>,</span> <span class=nx>assumedPod</span><span class=p>,</span> <span class=nx>scheduleResult</span><span class=p>.</span><span class=nx>SuggestedHost</span><span class=p>,</span> <span class=nx>state</span><span class=p>);</span> <span class=p>!</span><span class=nx>status</span><span class=p>.</span><span class=nf>IsSuccess</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>status</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 在 bind 绑定后执行收尾操作
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>fwk</span><span class=p>.</span><span class=nf>RunPostBindPlugins</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>assumedPod</span><span class=p>,</span> <span class=nx>scheduleResult</span><span class=p>.</span><span class=nx>SuggestedHost</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>sched</span> <span class=o>*</span><span class=nx>Scheduler</span><span class=p>)</span> <span class=nf>bind</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>fwk</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>Framework</span><span class=p>,</span> <span class=nx>assumed</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span> <span class=nx>targetNode</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>state</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>CycleState</span><span class=p>)</span> <span class=p>(</span><span class=nx>status</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Status</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>sched</span><span class=p>.</span><span class=nf>finishBinding</span><span class=p>(</span><span class=nx>fwk</span><span class=p>,</span> <span class=nx>assumed</span><span class=p>,</span> <span class=nx>targetNode</span><span class=p>,</span> <span class=nx>status</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>bound</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nf>extendersBinding</span><span class=p>(</span><span class=nx>assumed</span><span class=p>,</span> <span class=nx>targetNode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>bound</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>framework</span><span class=p>.</span><span class=nf>AsStatus</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>fwk</span><span class=p>.</span><span class=nf>RunBindPlugins</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>assumed</span><span class=p>,</span> <span class=nx>targetNode</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>sched</span> <span class=o>*</span><span class=nx>Scheduler</span><span class=p>)</span> <span class=nf>extendersBinding</span><span class=p>(</span><span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span> <span class=nx>node</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=kt>bool</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>extender</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>Extenders</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>!</span><span class=nx>extender</span><span class=p>.</span><span class=nf>IsBinder</span><span class=p>()</span> <span class=o>||</span> <span class=p>!</span><span class=nx>extender</span><span class=p>.</span><span class=nf>IsInterested</span><span class=p>(</span><span class=nx>pod</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>continue</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>true</span><span class=p>,</span> <span class=nx>extender</span><span class=p>.</span><span class=nf>Bind</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Binding</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>ObjectMeta</span><span class=p>:</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>ObjectMeta</span><span class=p>{</span><span class=nx>Namespace</span><span class=p>:</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span> <span class=nx>Name</span><span class=p>:</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>UID</span><span class=p>:</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>UID</span><span class=p>},</span>
</span></span><span class=line><span class=cl>			<span class=nx>Target</span><span class=p>:</span>     <span class=nx>v1</span><span class=p>.</span><span class=nx>ObjectReference</span><span class=p>{</span><span class=nx>Kind</span><span class=p>:</span> <span class=s>&#34;Node&#34;</span><span class=p>,</span> <span class=nx>Name</span><span class=p>:</span> <span class=nx>node</span><span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>false</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>extender 默认就只有 <code>DefaultBinder</code> 插件, 该插件的 bind 逻辑是通过 clientset 对 pod 进行 node 绑定..</p><p>代码位置: <code>pkg/scheduler/framework/plugins/defaultbinder/default_binder.go</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>b</span> <span class=nx>DefaultBinder</span><span class=p>)</span> <span class=nf>Bind</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>state</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>CycleState</span><span class=p>,</span> <span class=nx>p</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span> <span class=nx>nodeName</span> <span class=kt>string</span><span class=p>)</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Status</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>binding</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Binding</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>ObjectMeta</span><span class=p>:</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>ObjectMeta</span><span class=p>{</span><span class=nx>Namespace</span><span class=p>:</span> <span class=nx>p</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span> <span class=nx>Name</span><span class=p>:</span> <span class=nx>p</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>UID</span><span class=p>:</span> <span class=nx>p</span><span class=p>.</span><span class=nx>UID</span><span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=nx>Target</span><span class=p>:</span>     <span class=nx>v1</span><span class=p>.</span><span class=nx>ObjectReference</span><span class=p>{</span><span class=nx>Kind</span><span class=p>:</span> <span class=s>&#34;Node&#34;</span><span class=p>,</span> <span class=nx>Name</span><span class=p>:</span> <span class=nx>nodeName</span><span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>err</span> <span class=o>:=</span> <span class=nx>b</span><span class=p>.</span><span class=nx>handle</span><span class=p>.</span><span class=nf>ClientSet</span><span class=p>().</span><span class=nf>CoreV1</span><span class=p>().</span><span class=nf>Pods</span><span class=p>(</span><span class=nx>binding</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>).</span><span class=nf>Bind</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>binding</span><span class=p>,</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>CreateOptions</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>framework</span><span class=p>.</span><span class=nf>AsStatus</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=framework-的实现原理>framework 的实现原理</h2><p>k8s scheduler 设计了一套 framework 作为调度器的插件系统. 另外在 k8s 中内置了一波插件, 插件是可以在多个扩展点处进行注册. 当调度器在启动时会加载注册插件到 registry, 当 pod 需要创建时, scheduler 通过插件系统过滤出适合的节点集合, 然后在通过实现 socre 打分的插件选出分值最高的节点.</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301242208191.png data-srcset="https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301242208191.png, https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301242208191.png 1.5x, https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301242208191.png 2x" data-sizes=auto alt=https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301242208191.png title=https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301242208191.png></p><h3 id=framework-关键挂载点分析>framework 关键挂载点分析</h3><p><strong>PreFilter</strong></p><p>在调用 <code>Filter</code> 方法前, 执行 <code>PreFilter</code> 预筛选逻辑. 插件会检测集群和 pod 是否满足定义的条件. 当不满足时返回错误, 则停止调度周期.</p><p><strong>Filter</strong></p><p>这些插件用于过滤出不能运行该 Pod 的节点.</p><p><strong>PostFilter</strong></p><p>这些插件在 Filter 阶段后调用, 但仅在该 Pod 没有可行的节点时调用.</p><p><strong>PreScore</strong></p><p>插件在执行 <code>Score</code> 打分前, 可以先进行 <code>PreScore</code> 前置评分工作.</p><p><strong>Score</strong></p><p>对通过预选阶段的节点集合进行打分.</p><h2 id=scheduler-内置插件的实现原理>scheduler 内置插件的实现原理</h2><p>k8s scheduler 内置了不少插件, 下面是内置的插件.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>getDefaultPlugins</span><span class=p>()</span> <span class=o>*</span><span class=nx>v1beta3</span><span class=p>.</span><span class=nx>Plugins</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>plugins</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>v1beta3</span><span class=p>.</span><span class=nx>Plugins</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>MultiPoint</span><span class=p>:</span> <span class=nx>v1beta3</span><span class=p>.</span><span class=nx>PluginSet</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>Enabled</span><span class=p>:</span> <span class=p>[]</span><span class=nx>v1beta3</span><span class=p>.</span><span class=nx>Plugin</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>names</span><span class=p>.</span><span class=nx>PrioritySort</span><span class=p>},</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>names</span><span class=p>.</span><span class=nx>NodeUnschedulable</span><span class=p>},</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>names</span><span class=p>.</span><span class=nx>NodeName</span><span class=p>},</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>names</span><span class=p>.</span><span class=nx>TaintToleration</span><span class=p>,</span> <span class=nx>Weight</span><span class=p>:</span> <span class=nx>pointer</span><span class=p>.</span><span class=nf>Int32</span><span class=p>(</span><span class=mi>3</span><span class=p>)},</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>names</span><span class=p>.</span><span class=nx>NodeAffinity</span><span class=p>,</span> <span class=nx>Weight</span><span class=p>:</span> <span class=nx>pointer</span><span class=p>.</span><span class=nf>Int32</span><span class=p>(</span><span class=mi>2</span><span class=p>)},</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>names</span><span class=p>.</span><span class=nx>NodePorts</span><span class=p>},</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>names</span><span class=p>.</span><span class=nx>NodeResourcesFit</span><span class=p>,</span> <span class=nx>Weight</span><span class=p>:</span> <span class=nx>pointer</span><span class=p>.</span><span class=nf>Int32</span><span class=p>(</span><span class=mi>1</span><span class=p>)},</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>names</span><span class=p>.</span><span class=nx>VolumeRestrictions</span><span class=p>},</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>names</span><span class=p>.</span><span class=nx>EBSLimits</span><span class=p>},</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>names</span><span class=p>.</span><span class=nx>GCEPDLimits</span><span class=p>},</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>names</span><span class=p>.</span><span class=nx>NodeVolumeLimits</span><span class=p>},</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>names</span><span class=p>.</span><span class=nx>AzureDiskLimits</span><span class=p>},</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>names</span><span class=p>.</span><span class=nx>VolumeBinding</span><span class=p>},</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>names</span><span class=p>.</span><span class=nx>VolumeZone</span><span class=p>},</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>names</span><span class=p>.</span><span class=nx>PodTopologySpread</span><span class=p>,</span> <span class=nx>Weight</span><span class=p>:</span> <span class=nx>pointer</span><span class=p>.</span><span class=nf>Int32</span><span class=p>(</span><span class=mi>2</span><span class=p>)},</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>names</span><span class=p>.</span><span class=nx>InterPodAffinity</span><span class=p>,</span> <span class=nx>Weight</span><span class=p>:</span> <span class=nx>pointer</span><span class=p>.</span><span class=nf>Int32</span><span class=p>(</span><span class=mi>2</span><span class=p>)},</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>names</span><span class=p>.</span><span class=nx>DefaultPreemption</span><span class=p>},</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>names</span><span class=p>.</span><span class=nx>NodeResourcesBalancedAllocation</span><span class=p>,</span> <span class=nx>Weight</span><span class=p>:</span> <span class=nx>pointer</span><span class=p>.</span><span class=nf>Int32</span><span class=p>(</span><span class=mi>1</span><span class=p>)},</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>names</span><span class=p>.</span><span class=nx>ImageLocality</span><span class=p>,</span> <span class=nx>Weight</span><span class=p>:</span> <span class=nx>pointer</span><span class=p>.</span><span class=nf>Int32</span><span class=p>(</span><span class=mi>1</span><span class=p>)},</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>names</span><span class=p>.</span><span class=nx>DefaultBinder</span><span class=p>},</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=o>...</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>plugins</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里选择 <code>NodeName</code>, <code>ImageLocality</code>, <code>NodeResourcesFit</code> 和 <code>NodeAffinity</code> 插件来分析的插件实现原理.</p><h3 id=nodename-插件的实现原理>NodeName 插件的实现原理</h3><p><code>NodeName</code> 插件是一个预选插件, 插件实现了 <code>Filter</code> 方法, 筛选出跟 pod 相同 nodeName 的 node 节点对象.</p><p>源码位置: <code>pkg/scheduler/framework/plugins/nodename/node_name.go</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>NodeName</span> <span class=kd>struct</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>_</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>FilterPlugin</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>NodeName</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>const</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>Name</span> <span class=p>=</span> <span class=nx>names</span><span class=p>.</span><span class=nx>NodeName</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>ErrReason</span> <span class=p>=</span> <span class=s>&#34;node(s) didn&#39;t match the requested node name&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>pl</span> <span class=o>*</span><span class=nx>NodeName</span><span class=p>)</span> <span class=nf>Name</span><span class=p>()</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>Name</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>pl</span> <span class=o>*</span><span class=nx>NodeName</span><span class=p>)</span> <span class=nf>Filter</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>_</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>CycleState</span><span class=p>,</span> <span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span> <span class=nx>nodeInfo</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>NodeInfo</span><span class=p>)</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Status</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>nodeInfo</span><span class=p>.</span><span class=nf>Node</span><span class=p>()</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>framework</span><span class=p>.</span><span class=nf>NewStatus</span><span class=p>(</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Error</span><span class=p>,</span> <span class=s>&#34;node not found&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nf>Fits</span><span class=p>(</span><span class=nx>pod</span><span class=p>,</span> <span class=nx>nodeInfo</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>framework</span><span class=p>.</span><span class=nf>NewStatus</span><span class=p>(</span><span class=nx>framework</span><span class=p>.</span><span class=nx>UnschedulableAndUnresolvable</span><span class=p>,</span> <span class=nx>ErrReason</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Fits</span><span class=p>(</span><span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span> <span class=nx>nodeInfo</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>NodeInfo</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 过滤节点, 当返回 true, 该节点通过了初选.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// 当 pod 没有指定 nodeName 或者 pod 指定的 nodeName 跟传入的 node 名字一致则返回 true.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>return</span> <span class=nb>len</span><span class=p>(</span><span class=nx>pod</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>NodeName</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>||</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>NodeName</span> <span class=o>==</span> <span class=nx>nodeInfo</span><span class=p>.</span><span class=nf>Node</span><span class=p>().</span><span class=nx>Name</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=imagelocality-插件的实现原理>ImageLocality 插件的实现原理</h3><p><code>ImageLocality</code> 插件实现了 <code>Score</code> 分支计算接口, 该插件会计算 pod 关联的容器的镜像在 node 上的状态, 经过各种校验和公式计算后得出一个 score 分值.</p><p>至于 <code>ImageLocality</code> 插件如何计算 score 分值代码里写清楚了, 但至于为什么要这么计算就看不明白了.</p><p>源码位置: <code>pkg/scheduler/framework/plugins/imagelocality/image_locality.go</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>ImageLocality</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>handle</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>Handle</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>_</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>ScorePlugin</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>ImageLocality</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>const</span> <span class=nx>Name</span> <span class=p>=</span> <span class=nx>names</span><span class=p>.</span><span class=nx>ImageLocality</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>pl</span> <span class=o>*</span><span class=nx>ImageLocality</span><span class=p>)</span> <span class=nf>Score</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>state</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>CycleState</span><span class=p>,</span> <span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span> <span class=nx>nodeName</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=kt>int64</span><span class=p>,</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Status</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 通过 nodeName 获取 nodeInfo 对象
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>nodeInfo</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>pl</span><span class=p>.</span><span class=nx>handle</span><span class=p>.</span><span class=nf>SnapshotSharedLister</span><span class=p>().</span><span class=nf>NodeInfos</span><span class=p>().</span><span class=nf>Get</span><span class=p>(</span><span class=nx>nodeName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>framework</span><span class=p>.</span><span class=nf>AsStatus</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;getting node %q from Snapshot: %w&#34;</span><span class=p>,</span> <span class=nx>nodeName</span><span class=p>,</span> <span class=nx>err</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 获取主机列表
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>nodeInfos</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>pl</span><span class=p>.</span><span class=nx>handle</span><span class=p>.</span><span class=nf>SnapshotSharedLister</span><span class=p>().</span><span class=nf>NodeInfos</span><span class=p>().</span><span class=nf>List</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>framework</span><span class=p>.</span><span class=nf>AsStatus</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 当前有多少 node
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>totalNumNodes</span> <span class=o>:=</span> <span class=nb>len</span><span class=p>(</span><span class=nx>nodeInfos</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 经过一堆表达式计算出 node 对应的 score 分支
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>score</span> <span class=o>:=</span> <span class=nf>calculatePriority</span><span class=p>(</span><span class=nf>sumImageScores</span><span class=p>(</span><span class=nx>nodeInfo</span><span class=p>,</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Containers</span><span class=p>,</span> <span class=nx>totalNumNodes</span><span class=p>),</span> <span class=nb>len</span><span class=p>(</span><span class=nx>pod</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Containers</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>score</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 根据 node 当前镜像的状态计算分值.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>calculatePriority</span><span class=p>(</span><span class=nx>sumScores</span> <span class=kt>int64</span><span class=p>,</span> <span class=nx>numContainers</span> <span class=kt>int</span><span class=p>)</span> <span class=kt>int64</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>maxThreshold</span> <span class=o>:=</span> <span class=nx>maxContainerThreshold</span> <span class=o>*</span> <span class=nb>int64</span><span class=p>(</span><span class=nx>numContainers</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>sumScores</span> <span class=p>&lt;</span> <span class=nx>minThreshold</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>sumScores</span> <span class=p>=</span> <span class=nx>minThreshold</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>sumScores</span> <span class=p>&gt;</span> <span class=nx>maxThreshold</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>sumScores</span> <span class=p>=</span> <span class=nx>maxThreshold</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nb>int64</span><span class=p>(</span><span class=nx>framework</span><span class=p>.</span><span class=nx>MaxNodeScore</span><span class=p>)</span> <span class=o>*</span> <span class=p>(</span><span class=nx>sumScores</span> <span class=o>-</span> <span class=nx>minThreshold</span><span class=p>)</span> <span class=o>/</span> <span class=p>(</span><span class=nx>maxThreshold</span> <span class=o>-</span> <span class=nx>minThreshold</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 遍历 pod 里的所有容器, 当容器对应的镜像在 node 中, 则累加计算分值 score.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>sumImageScores</span><span class=p>(</span><span class=nx>nodeInfo</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>NodeInfo</span><span class=p>,</span> <span class=nx>containers</span> <span class=p>[]</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Container</span><span class=p>,</span> <span class=nx>totalNumNodes</span> <span class=kt>int</span><span class=p>)</span> <span class=kt>int64</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>sum</span> <span class=kt>int64</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>container</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>containers</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 获取容器的景象在 node 的状态
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>nodeInfo</span><span class=p>.</span><span class=nx>ImageStates</span><span class=p>[</span><span class=nf>normalizedImageName</span><span class=p>(</span><span class=nx>container</span><span class=p>.</span><span class=nx>Image</span><span class=p>)];</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>sum</span> <span class=o>+=</span> <span class=nf>scaledImageScore</span><span class=p>(</span><span class=nx>state</span><span class=p>,</span> <span class=nx>totalNumNodes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>sum</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=noderesourcesfit-插件的实现原理>NodeResourcesFit 插件的实现原理</h3><p><code>NodeResourcesFit</code> 插件实现了三个 framework 插件接口, 分别是 PreFilterPlugin, FilterPlugin, ScorePlugin 接口.</p><ul><li><code>PreFilterPlugin</code> 只是在 state 缓存里记录 pod 要求的 request 资源.</li><li><code>FilterPlugin</code> 主要用来过滤掉不符合资源要求的 node 节点, 如果当前 node 可申请的 cpu 和 mem 不满足 pod 需求, 则 node 节点会被过滤掉.</li><li><code>ScorePlugin</code> 主要对符合要求通过预选的 node 集合进行打分, 用以得到最优的 node 节点, 其实就是 cpu/mem 资源最充足最空闲的 node 节点.</li></ul><p>代码位置: <code>pkg/scheduler/framework/plugins/noderesources/fit.go</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>_</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>PreFilterPlugin</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>Fit</span><span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>_</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>FilterPlugin</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>Fit</span><span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>_</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>ScorePlugin</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>Fit</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 用来在 cycleState 里记录 pod 所需的 request 资源
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>f</span> <span class=o>*</span><span class=nx>Fit</span><span class=p>)</span> <span class=nf>PreFilter</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>cycleState</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>CycleState</span><span class=p>,</span> <span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>PreFilterResult</span><span class=p>,</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Status</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>cycleState</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=nx>preFilterStateKey</span><span class=p>,</span> <span class=nf>computePodResourceRequest</span><span class=p>(</span><span class=nx>pod</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 过滤掉不符合 resource request 资源的 node.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>f</span> <span class=o>*</span><span class=nx>Fit</span><span class=p>)</span> <span class=nf>Filter</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>cycleState</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>CycleState</span><span class=p>,</span> <span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span> <span class=nx>nodeInfo</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>NodeInfo</span><span class=p>)</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Status</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 获取在 preFilter 阶段写入的 preFilterState
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>s</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>getPreFilterState</span><span class=p>(</span><span class=nx>cycleState</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>framework</span><span class=p>.</span><span class=nf>AsStatus</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 判断当前的 node 是否满足 pod 的资源请求需求
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>insufficientResources</span> <span class=o>:=</span> <span class=nf>fitsRequest</span><span class=p>(</span><span class=nx>s</span><span class=p>,</span> <span class=nx>nodeInfo</span><span class=p>,</span> <span class=nx>f</span><span class=p>.</span><span class=nx>ignoredResources</span><span class=p>,</span> <span class=nx>f</span><span class=p>.</span><span class=nx>ignoredResourceGroups</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 如果不为空则有异常, 把所有的异常合并在一起, 构建 framework status 对象再返回.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>insufficientResources</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// We will keep all failure reasons.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>failureReasons</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>string</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>insufficientResources</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>insufficientResources</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>failureReasons</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>failureReasons</span><span class=p>,</span> <span class=nx>insufficientResources</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>Reason</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>framework</span><span class=p>.</span><span class=nf>NewStatus</span><span class=p>(</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Unschedulable</span><span class=p>,</span> <span class=nx>failureReasons</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 返回 nil, 说明该节点符合资源要求
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 判断当前 node 是否满足 pod 的资源要求
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>fitsRequest</span><span class=p>(</span><span class=nx>podRequest</span> <span class=o>*</span><span class=nx>preFilterState</span><span class=p>,</span> <span class=nx>nodeInfo</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>NodeInfo</span><span class=p>,</span> <span class=nx>ignoredExtendedResources</span><span class=p>,</span> <span class=nx>ignoredResourceGroups</span> <span class=nx>sets</span><span class=p>.</span><span class=nx>String</span><span class=p>)</span> <span class=p>[]</span><span class=nx>InsufficientResource</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>insufficientResources</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=nx>InsufficientResource</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>allowedPodNumber</span> <span class=o>:=</span> <span class=nx>nodeInfo</span><span class=p>.</span><span class=nx>Allocatable</span><span class=p>.</span><span class=nx>AllowedPodNumber</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 如果当前 node pods 数超过了最大 pods 数, 则 append.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>nodeInfo</span><span class=p>.</span><span class=nx>Pods</span><span class=p>)</span><span class=o>+</span><span class=mi>1</span> <span class=p>&gt;</span> <span class=nx>allowedPodNumber</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>insufficientResources</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>insufficientResources</span><span class=p>,</span> <span class=nx>InsufficientResource</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>ResourceName</span><span class=p>:</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>ResourcePods</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Reason</span><span class=p>:</span>       <span class=s>&#34;Too many pods&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Requested</span><span class=p>:</span>    <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Used</span><span class=p>:</span>         <span class=nb>int64</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>nodeInfo</span><span class=p>.</span><span class=nx>Pods</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>			<span class=nx>Capacity</span><span class=p>:</span>     <span class=nb>int64</span><span class=p>(</span><span class=nx>allowedPodNumber</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 如果没有 pod 没有 resource request 配置, 可直接返回
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>podRequest</span><span class=p>.</span><span class=nx>MilliCPU</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>		<span class=nx>podRequest</span><span class=p>.</span><span class=nx>Memory</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>		<span class=nx>podRequest</span><span class=p>.</span><span class=nx>EphemeralStorage</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>		<span class=nb>len</span><span class=p>(</span><span class=nx>podRequest</span><span class=p>.</span><span class=nx>ScalarResources</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>insufficientResources</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 如果当前 node 空闲 cpu 资源不足以运行 pod, 则 append 异常.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// 当前的 cpu 资源是按照 request 来计算的, 而不是 metrics 实时的.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>podRequest</span><span class=p>.</span><span class=nx>MilliCPU</span> <span class=p>&gt;</span> <span class=p>(</span><span class=nx>nodeInfo</span><span class=p>.</span><span class=nx>Allocatable</span><span class=p>.</span><span class=nx>MilliCPU</span> <span class=o>-</span> <span class=nx>nodeInfo</span><span class=p>.</span><span class=nx>Requested</span><span class=p>.</span><span class=nx>MilliCPU</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>insufficientResources</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>insufficientResources</span><span class=p>,</span> <span class=nx>InsufficientResource</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>ResourceName</span><span class=p>:</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>ResourceCPU</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Reason</span><span class=p>:</span>       <span class=s>&#34;Insufficient cpu&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Requested</span><span class=p>:</span>    <span class=nx>podRequest</span><span class=p>.</span><span class=nx>MilliCPU</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Used</span><span class=p>:</span>         <span class=nx>nodeInfo</span><span class=p>.</span><span class=nx>Requested</span><span class=p>.</span><span class=nx>MilliCPU</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Capacity</span><span class=p>:</span>     <span class=nx>nodeInfo</span><span class=p>.</span><span class=nx>Allocatable</span><span class=p>.</span><span class=nx>MilliCPU</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 如果当前 node 空闲的内存不满足 pod 的要求, 则 append 异常
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>podRequest</span><span class=p>.</span><span class=nx>Memory</span> <span class=p>&gt;</span> <span class=p>(</span><span class=nx>nodeInfo</span><span class=p>.</span><span class=nx>Allocatable</span><span class=p>.</span><span class=nx>Memory</span> <span class=o>-</span> <span class=nx>nodeInfo</span><span class=p>.</span><span class=nx>Requested</span><span class=p>.</span><span class=nx>Memory</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>insufficientResources</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>insufficientResources</span><span class=p>,</span> <span class=nx>InsufficientResource</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>ResourceName</span><span class=p>:</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>ResourceMemory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Reason</span><span class=p>:</span>       <span class=s>&#34;Insufficient memory&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Requested</span><span class=p>:</span>    <span class=nx>podRequest</span><span class=p>.</span><span class=nx>Memory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Used</span><span class=p>:</span>         <span class=nx>nodeInfo</span><span class=p>.</span><span class=nx>Requested</span><span class=p>.</span><span class=nx>Memory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Capacity</span><span class=p>:</span>     <span class=nx>nodeInfo</span><span class=p>.</span><span class=nx>Allocatable</span><span class=p>.</span><span class=nx>Memory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 如果当前 node 的存储空间不够 pod 的要求, 则返回错误.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>podRequest</span><span class=p>.</span><span class=nx>EphemeralStorage</span> <span class=p>&gt;</span> <span class=p>(</span><span class=nx>nodeInfo</span><span class=p>.</span><span class=nx>Allocatable</span><span class=p>.</span><span class=nx>EphemeralStorage</span> <span class=o>-</span> <span class=nx>nodeInfo</span><span class=p>.</span><span class=nx>Requested</span><span class=p>.</span><span class=nx>EphemeralStorage</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>insufficientResources</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>insufficientResources</span><span class=p>,</span> <span class=nx>InsufficientResource</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>ResourceName</span><span class=p>:</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>ResourceEphemeralStorage</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Reason</span><span class=p>:</span>       <span class=s>&#34;Insufficient ephemeral-storage&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Requested</span><span class=p>:</span>    <span class=nx>podRequest</span><span class=p>.</span><span class=nx>EphemeralStorage</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Used</span><span class=p>:</span>         <span class=nx>nodeInfo</span><span class=p>.</span><span class=nx>Requested</span><span class=p>.</span><span class=nx>EphemeralStorage</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Capacity</span><span class=p>:</span>     <span class=nx>nodeInfo</span><span class=p>.</span><span class=nx>Allocatable</span><span class=p>.</span><span class=nx>EphemeralStorage</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 这个是 pod 对扩展资源的要求, 当节点不满足其要求时, append 追加异常.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>for</span> <span class=nx>rName</span><span class=p>,</span> <span class=nx>rQuant</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>podRequest</span><span class=p>.</span><span class=nx>ScalarResources</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>v1helper</span><span class=p>.</span><span class=nf>IsExtendedResourceName</span><span class=p>(</span><span class=nx>rName</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=kd>var</span> <span class=nx>rNamePrefix</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>ignoredResourceGroups</span><span class=p>.</span><span class=nf>Len</span><span class=p>()</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>rNamePrefix</span> <span class=p>=</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Split</span><span class=p>(</span><span class=nb>string</span><span class=p>(</span><span class=nx>rName</span><span class=p>),</span> <span class=s>&#34;/&#34;</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>ignoredExtendedResources</span><span class=p>.</span><span class=nf>Has</span><span class=p>(</span><span class=nb>string</span><span class=p>(</span><span class=nx>rName</span><span class=p>))</span> <span class=o>||</span> <span class=nx>ignoredResourceGroups</span><span class=p>.</span><span class=nf>Has</span><span class=p>(</span><span class=nx>rNamePrefix</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>rQuant</span> <span class=p>&gt;</span> <span class=p>(</span><span class=nx>nodeInfo</span><span class=p>.</span><span class=nx>Allocatable</span><span class=p>.</span><span class=nx>ScalarResources</span><span class=p>[</span><span class=nx>rName</span><span class=p>]</span> <span class=o>-</span> <span class=nx>nodeInfo</span><span class=p>.</span><span class=nx>Requested</span><span class=p>.</span><span class=nx>ScalarResources</span><span class=p>[</span><span class=nx>rName</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>insufficientResources</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>insufficientResources</span><span class=p>,</span> <span class=nx>InsufficientResource</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>ResourceName</span><span class=p>:</span> <span class=nx>rName</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>Reason</span><span class=p>:</span>       <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;Insufficient %v&#34;</span><span class=p>,</span> <span class=nx>rName</span><span class=p>),</span>
</span></span><span class=line><span class=cl>				<span class=nx>Requested</span><span class=p>:</span>    <span class=nx>podRequest</span><span class=p>.</span><span class=nx>ScalarResources</span><span class=p>[</span><span class=nx>rName</span><span class=p>],</span>
</span></span><span class=line><span class=cl>				<span class=nx>Used</span><span class=p>:</span>         <span class=nx>nodeInfo</span><span class=p>.</span><span class=nx>Requested</span><span class=p>.</span><span class=nx>ScalarResources</span><span class=p>[</span><span class=nx>rName</span><span class=p>],</span>
</span></span><span class=line><span class=cl>				<span class=nx>Capacity</span><span class=p>:</span>     <span class=nx>nodeInfo</span><span class=p>.</span><span class=nx>Allocatable</span><span class=p>.</span><span class=nx>ScalarResources</span><span class=p>[</span><span class=nx>rName</span><span class=p>],</span>
</span></span><span class=line><span class=cl>			<span class=p>})</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 返回所有的资源分配的异常
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>return</span> <span class=nx>insufficientResources</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>Score</code> 会根据当前 node 的 cpu/mem/ephemeral-storage 资源空闲情况进行打分, 可分配的资源越多, 那么分值自然就越高.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>f</span> <span class=o>*</span><span class=nx>Fit</span><span class=p>)</span> <span class=nf>Score</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>state</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>CycleState</span><span class=p>,</span> <span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span> <span class=nx>nodeName</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=kt>int64</span><span class=p>,</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Status</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 获取 nodeInfo 对象
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>nodeInfo</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>f</span><span class=p>.</span><span class=nx>handle</span><span class=p>.</span><span class=nf>SnapshotSharedLister</span><span class=p>().</span><span class=nf>NodeInfos</span><span class=p>().</span><span class=nf>Get</span><span class=p>(</span><span class=nx>nodeName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>framework</span><span class=p>.</span><span class=nf>AsStatus</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;getting node %q from Snapshot: %w&#34;</span><span class=p>,</span> <span class=nx>nodeName</span><span class=p>,</span> <span class=nx>err</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 计算分值 score
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>return</span> <span class=nx>f</span><span class=p>.</span><span class=nf>score</span><span class=p>(</span><span class=nx>pod</span><span class=p>,</span> <span class=nx>nodeInfo</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>resourceAllocationScorer</span><span class=p>)</span> <span class=nf>score</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>nodeInfo</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>NodeInfo</span><span class=p>)</span> <span class=p>(</span><span class=kt>int64</span><span class=p>,</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Status</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>...</span>
</span></span><span class=line><span class=cl>	<span class=nx>requested</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>int64</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>resources</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=nx>allocatable</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>int64</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>resources</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 遍历 resouces 累加计算 allocatable 和 requested.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>r</span><span class=p>.</span><span class=nx>resources</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// allocatable 是 node 还可以分配的资源
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// req 是 pod 所需要的资源
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>alloc</span><span class=p>,</span> <span class=nx>req</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>calculateResourceAllocatableRequest</span><span class=p>(</span><span class=nx>nodeInfo</span><span class=p>,</span> <span class=nx>pod</span><span class=p>,</span> <span class=nx>v1</span><span class=p>.</span><span class=nf>ResourceName</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>resources</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>Name</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// 如果为 0, 通常为扩展资源, 跳过分值计算.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>alloc</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>continue</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>allocatable</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=p>=</span> <span class=nx>alloc</span>
</span></span><span class=line><span class=cl>		<span class=nx>requested</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=p>=</span> <span class=nx>req</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 通过一波公式来计算该 node 分值
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>score</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>scorer</span><span class=p>(</span><span class=nx>requested</span><span class=p>,</span> <span class=nx>allocatable</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>...</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>score</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>NodeResourcesFit</code> 的 scorer 是具体用来打分的方法, 其内部根据 requested 和 allocatable 两个参数进行打分.</p><p>scheduler 对 resource 打分内置三种不同策略, 分别是 LeastAllocated / MostAllocated / RequestedToCapacityRatio.</p><ul><li>LeastAllocated 默认策略, 空闲资源多的分高, 优先调度到空闲资源多的节点上, 各个 node 节点负载均衡.</li><li>MostAllocated 空闲资源少的分高, 优先调度到空闲资源较少的 node 上, 这样 pod 尽量集中起来方便后面资源回收.</li><li>RequestedToCapacityRatio 请求 request 和 node 资源总量的比率低的分高.</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>const</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 默认策略, 空闲资源多的分高, 优先调度到空闲资源多的节点上.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>LeastAllocated</span> <span class=nx>ScoringStrategyType</span> <span class=p>=</span> <span class=s>&#34;LeastAllocated&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 空闲资源少的分高, 优先调度到空闲资源少的 node 上
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>MostAllocated</span> <span class=nx>ScoringStrategyType</span> <span class=p>=</span> <span class=s>&#34;MostAllocated&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// request 和 node 总量的比率低的分高
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>RequestedToCapacityRatio</span> <span class=nx>ScoringStrategyType</span> <span class=p>=</span> <span class=s>&#34;RequestedToCapacityRatio&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 下面是 NodeResourcesFit 的工厂方法, 根据 strategy 策略使用不同的 scorer 打分策略.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>NewFit</span><span class=p>(</span><span class=nx>plArgs</span> <span class=nx>runtime</span><span class=p>.</span><span class=nx>Object</span><span class=p>,</span> <span class=nx>h</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>Handle</span><span class=p>,</span> <span class=nx>fts</span> <span class=nx>feature</span><span class=p>.</span><span class=nx>Features</span><span class=p>)</span> <span class=p>(</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Plugin</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 获取传入参数
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>args</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>plArgs</span><span class=p>.(</span><span class=o>*</span><span class=nx>config</span><span class=p>.</span><span class=nx>NodeResourcesFitArgs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>strategy</span> <span class=o>:=</span> <span class=nx>args</span><span class=p>.</span><span class=nx>ScoringStrategy</span><span class=p>.</span><span class=nx>Type</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 根据策略选择 score 插件
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>scorePlugin</span><span class=p>,</span> <span class=nx>exists</span> <span class=o>:=</span> <span class=nx>nodeResourceStrategyTypeMap</span><span class=p>[</span><span class=nx>strategy</span><span class=p>]</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>exists</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;scoring strategy %s is not supported&#34;</span><span class=p>,</span> <span class=nx>strategy</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>Fit</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>ignoredResources</span><span class=p>:</span>         <span class=nx>sets</span><span class=p>.</span><span class=nf>NewString</span><span class=p>(</span><span class=nx>args</span><span class=p>.</span><span class=nx>IgnoredResources</span><span class=o>...</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>ignoredResourceGroups</span><span class=p>:</span>    <span class=nx>sets</span><span class=p>.</span><span class=nf>NewString</span><span class=p>(</span><span class=nx>args</span><span class=p>.</span><span class=nx>IgnoredResourceGroups</span><span class=o>...</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>handle</span><span class=p>:</span>                   <span class=nx>h</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>resourceAllocationScorer</span><span class=p>:</span> <span class=o>*</span><span class=nf>scorePlugin</span><span class=p>(</span><span class=nx>args</span><span class=p>),</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 下面定义了三个 scorer 打分策略.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>nodeResourceStrategyTypeMap</span> <span class=p>=</span> <span class=kd>map</span><span class=p>[</span><span class=nx>config</span><span class=p>.</span><span class=nx>ScoringStrategyType</span><span class=p>]</span><span class=nx>scorer</span><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>config</span><span class=p>.</span><span class=nx>LeastAllocated</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>args</span> <span class=o>*</span><span class=nx>config</span><span class=p>.</span><span class=nx>NodeResourcesFitArgs</span><span class=p>)</span> <span class=o>*</span><span class=nx>resourceAllocationScorer</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>resources</span> <span class=o>:=</span> <span class=nx>args</span><span class=p>.</span><span class=nx>ScoringStrategy</span><span class=p>.</span><span class=nx>Resources</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=o>&amp;</span><span class=nx>resourceAllocationScorer</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>Name</span><span class=p>:</span>      <span class=nb>string</span><span class=p>(</span><span class=nx>config</span><span class=p>.</span><span class=nx>LeastAllocated</span><span class=p>),</span>
</span></span><span class=line><span class=cl>			<span class=nx>scorer</span><span class=p>:</span>    <span class=nf>leastResourceScorer</span><span class=p>(</span><span class=nx>resources</span><span class=p>),</span>
</span></span><span class=line><span class=cl>			<span class=nx>resources</span><span class=p>:</span> <span class=nx>resources</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=nx>config</span><span class=p>.</span><span class=nx>MostAllocated</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>args</span> <span class=o>*</span><span class=nx>config</span><span class=p>.</span><span class=nx>NodeResourcesFitArgs</span><span class=p>)</span> <span class=o>*</span><span class=nx>resourceAllocationScorer</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>resources</span> <span class=o>:=</span> <span class=nx>args</span><span class=p>.</span><span class=nx>ScoringStrategy</span><span class=p>.</span><span class=nx>Resources</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=o>&amp;</span><span class=nx>resourceAllocationScorer</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>Name</span><span class=p>:</span>      <span class=nb>string</span><span class=p>(</span><span class=nx>config</span><span class=p>.</span><span class=nx>MostAllocated</span><span class=p>),</span>
</span></span><span class=line><span class=cl>			<span class=nx>scorer</span><span class=p>:</span>    <span class=nf>mostResourceScorer</span><span class=p>(</span><span class=nx>resources</span><span class=p>),</span>
</span></span><span class=line><span class=cl>			<span class=nx>resources</span><span class=p>:</span> <span class=nx>resources</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=nx>config</span><span class=p>.</span><span class=nx>RequestedToCapacityRatio</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>args</span> <span class=o>*</span><span class=nx>config</span><span class=p>.</span><span class=nx>NodeResourcesFitArgs</span><span class=p>)</span> <span class=o>*</span><span class=nx>resourceAllocationScorer</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>resources</span> <span class=o>:=</span> <span class=nx>args</span><span class=p>.</span><span class=nx>ScoringStrategy</span><span class=p>.</span><span class=nx>Resources</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=o>&amp;</span><span class=nx>resourceAllocationScorer</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>Name</span><span class=p>:</span>      <span class=nb>string</span><span class=p>(</span><span class=nx>config</span><span class=p>.</span><span class=nx>RequestedToCapacityRatio</span><span class=p>),</span>
</span></span><span class=line><span class=cl>			<span class=nx>scorer</span><span class=p>:</span>    <span class=nf>requestedToCapacityRatioScorer</span><span class=p>(</span><span class=nx>resources</span><span class=p>,</span> <span class=nx>args</span><span class=p>.</span><span class=nx>ScoringStrategy</span><span class=p>.</span><span class=nx>RequestedToCapacityRatio</span><span class=p>.</span><span class=nx>Shape</span><span class=p>),</span>
</span></span><span class=line><span class=cl>			<span class=nx>resources</span><span class=p>:</span> <span class=nx>resources</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>k8s scheduler 内置插件的 Filter 过滤方法很好理解, 决定节点是否通过预选. 而 Score 打分方法则不好理解, 但通过源码不好反推打分的计算公式是怎么来的.</p><h3 id=nodeaffinity-节点亲和性插件原理>NodeAffinity 节点亲和性插件原理</h3><p>NodeAffinity 是实现节点亲和性的插件, 主要实现了 PreFilter, Filter 和 PreScore, Score 四个方法. PreFilter 和 PreScore 在 NodeAffinity 插件里做 state 传递, 这里重点分析 Filter 和 Score 方法实现.</p><ul><li><p><code>Filter</code> 用来判断传入的 node 是否匹配 pod 的 <code>RequiredDuringSchedulingIgnoredDuringExecution</code> 硬亲和配置, 不适配则返回异常.</p></li><li><p><code>Score</code> 用来给 node 打分, 如果节点 labels 适配 pod 的 <code>preferredDuringSchedulingIgnoredDuringExecution</code>, 则把 spec.nodeAffinity.weight 累加到 score.</p></li></ul><p>首先看下 pod nodeAffinity 节点亲和性的两个参数.</p><ul><li><p><code>RequiredDuringSchedulingIgnoredDuringExecution</code> 参数表示调度器只会调度到符合 pod 要求的节点上, 没有符合要求的节点则不进行调度.</p></li><li><p><code>preferredDuringSchedulingIgnoredDuringExecution</code> 参数表示调度器会优先尝试寻找满足亲和性规则的节点. 如果实在找不到匹配亲和性的节点, 调度器会选择一个分值高但不满足 pod 亲和性要求的节点.</p></li></ul><p>下面是包含 pod 的亲和性的 pod 配置文件, 可对照该配置来理解 nodeAffinity 插件的 Filter 和 Score 的实现.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-xiaorui-cc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>affinity</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>nodeAffinity</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>requiredDuringSchedulingIgnoredDuringExecution</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>nodeSelectorTerms</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes.io/os</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>linux</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>preferredDuringSchedulingIgnoredDuringExecution</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>weight</span><span class=p>:</span><span class=w> </span><span class=m>50</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>preference</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>nodenames</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>xiaorui.cc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>with-node-affinity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>registry.k8s.io/pause:2.0</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>源码位置: <code>pkg/scheduler/framework/plugins/nodeaffinity/node_affinity.go</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>NodeAffinity</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>handle</span>              <span class=nx>framework</span><span class=p>.</span><span class=nx>Handle</span>
</span></span><span class=line><span class=cl>	<span class=nx>addedNodeSelector</span>   <span class=o>*</span><span class=nx>nodeaffinity</span><span class=p>.</span><span class=nx>NodeSelector</span>
</span></span><span class=line><span class=cl>	<span class=nx>addedPrefSchedTerms</span> <span class=o>*</span><span class=nx>nodeaffinity</span><span class=p>.</span><span class=nx>PreferredSchedulingTerms</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>_</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>FilterPlugin</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>NodeAffinity</span><span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>_</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>ScorePlugin</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>NodeAffinity</span><span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 检查传入的 node 是否匹配该 pod 的 nodeAffinity
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>pl</span> <span class=o>*</span><span class=nx>NodeAffinity</span><span class=p>)</span> <span class=nf>Filter</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>state</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>CycleState</span><span class=p>,</span> <span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span> <span class=nx>nodeInfo</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>NodeInfo</span><span class=p>)</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Status</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>node</span> <span class=o>:=</span> <span class=nx>nodeInfo</span><span class=p>.</span><span class=nf>Node</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=c1>// node 对象为空则跳出
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>node</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>framework</span><span class=p>.</span><span class=nf>NewStatus</span><span class=p>(</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Error</span><span class=p>,</span> <span class=s>&#34;node not found&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 获取 prefilter 阶段写入的状态, 其实就是 pod 的 required 配置.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>s</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>getPreFilterState</span><span class=p>(</span><span class=nx>state</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>s</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>preFilterState</span><span class=p>{</span><span class=nx>requiredNodeSelectorAndAffinity</span><span class=p>:</span> <span class=nx>nodeaffinity</span><span class=p>.</span><span class=nf>GetRequiredNodeAffinity</span><span class=p>(</span><span class=nx>pod</span><span class=p>)}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 判断 pod 的 required 跟 node 是否适配
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>match</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>requiredNodeSelectorAndAffinity</span><span class=p>.</span><span class=nf>Match</span><span class=p>(</span><span class=nx>node</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>match</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 如不适配直接退出
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>return</span> <span class=nx>framework</span><span class=p>.</span><span class=nf>NewStatus</span><span class=p>(</span><span class=nx>framework</span><span class=p>.</span><span class=nx>UnschedulableAndUnresolvable</span><span class=p>,</span> <span class=nx>ErrReasonPod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 跟 pod 和 node 亲和情况进行打分 score
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>pl</span> <span class=o>*</span><span class=nx>NodeAffinity</span><span class=p>)</span> <span class=nf>Score</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>state</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>CycleState</span><span class=p>,</span> <span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span> <span class=nx>nodeName</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=kt>int64</span><span class=p>,</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Status</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=o>...</span>
</span></span><span class=line><span class=cl>	<span class=nx>node</span> <span class=o>:=</span> <span class=nx>nodeInfo</span><span class=p>.</span><span class=nf>Node</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>count</span> <span class=kt>int64</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>pl</span><span class=p>.</span><span class=nx>addedPrefSchedTerms</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>count</span> <span class=o>+=</span> <span class=nx>pl</span><span class=p>.</span><span class=nx>addedPrefSchedTerms</span><span class=p>.</span><span class=nf>Score</span><span class=p>(</span><span class=nx>node</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 获取 prescore 阶段写入的 state
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>s</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>getPreScoreState</span><span class=p>(</span><span class=nx>state</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Fallback to calculate preferredNodeAffinity here when PreScore is disabled.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>preferredNodeAffinity</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>getPodPreferredNodeAffinity</span><span class=p>(</span><span class=nx>pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>framework</span><span class=p>.</span><span class=nf>AsStatus</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>s</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>preScoreState</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>preferredNodeAffinity</span><span class=p>:</span> <span class=nx>preferredNodeAffinity</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 根据 pod 的 preferred 和 node labels 的适配情况, 增加 weight 到 score 分值.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>s</span><span class=p>.</span><span class=nx>preferredNodeAffinity</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>count</span> <span class=o>+=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>preferredNodeAffinity</span><span class=p>.</span><span class=nf>Score</span><span class=p>(</span><span class=nx>node</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>count</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>PreferredSchedulingTerms</span><span class=p>)</span> <span class=nf>Score</span><span class=p>(</span><span class=nx>node</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Node</span><span class=p>)</span> <span class=kt>int64</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>score</span> <span class=kt>int64</span>
</span></span><span class=line><span class=cl>	<span class=nx>nodeLabels</span> <span class=o>:=</span> <span class=nx>labels</span><span class=p>.</span><span class=nf>Set</span><span class=p>(</span><span class=nx>node</span><span class=p>.</span><span class=nx>Labels</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>nodeFields</span> <span class=o>:=</span> <span class=nf>extractNodeFields</span><span class=p>(</span><span class=nx>node</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>term</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>t</span><span class=p>.</span><span class=nx>terms</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 如果 node 匹配 pod preferred, 则增加定义的权重.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>ok</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>term</span><span class=p>.</span><span class=nf>match</span><span class=p>(</span><span class=nx>nodeLabels</span><span class=p>,</span> <span class=nx>nodeFields</span><span class=p>);</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>score</span> <span class=o>+=</span> <span class=nb>int64</span><span class=p>(</span><span class=nx>term</span><span class=p>.</span><span class=nx>weight</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>score</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=总结>总结</h2><p>kubernetes scheduler 从 informer 监听新资源变动, 当有新 pod 创建时, scheduler 需要为其分配绑定一个 node 节点. 在调度 Pod 时要经过两个阶段, 即 调度周期 和 绑定周期.</p><p>调度周期分为预选阶段和优选阶段.</p><ul><li>预选 (Predicates) 是通过插件的 Filter 方法过滤出符合要求的 node 节点</li><li>优选 (Priorities) 则对预选出来的 node 节点进行打分排序</li></ul><p>绑定周期默认只有一个默认插件, 仅给 apiserver 发起 node 跟 pod 绑定的请求.</p><p>出处: <a href=https://github.com/rfyiamcool/notes#kubernetes target=_blank rel="external nofollow noopener noreferrer">https://github.com/rfyiamcool/notes#kubernetes</a></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="2023-04-18 21:53:59">更新于 2023-04-18</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a href=/posts/a3f5fa/index.md title=阅读原始文档 class=link-to-markdown>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://www.alongparty.cn/posts/a3f5fa/ data-title="源码分析 kubernetes scheduler 核心调度器的实现原理" data-hashtags=kubernetes,源码,转载><i class="fa-brands fa-twitter fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://www.alongparty.cn/posts/a3f5fa/ data-hashtag=kubernetes><i class="fa-brands fa-facebook-square fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 WhatsApp" data-sharer=whatsapp data-url=https://www.alongparty.cn/posts/a3f5fa/ data-title="源码分析 kubernetes scheduler 核心调度器的实现原理" data-web><i class="fa-brands fa-whatsapp fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=https://www.alongparty.cn/posts/a3f5fa/ data-title="源码分析 kubernetes scheduler 核心调度器的实现原理"><i data-svg-src=/lib/simple-icons/icons/line.min.svg></i></a>
<a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://www.alongparty.cn/posts/a3f5fa/ data-title="源码分析 kubernetes scheduler 核心调度器的实现原理"><i class="fa-brands fa-weibo fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 Myspace" data-sharer=myspace data-url=https://www.alongparty.cn/posts/a3f5fa/ data-title="源码分析 kubernetes scheduler 核心调度器的实现原理" data-description><i data-svg-src=/lib/simple-icons/icons/myspace.min.svg></i></a>
<a href=javascript:void(0); title="分享到 Blogger" data-sharer=blogger data-url=https://www.alongparty.cn/posts/a3f5fa/ data-title="源码分析 kubernetes scheduler 核心调度器的实现原理" data-description><i class="fa-brands fa-blogger fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 Evernote" data-sharer=evernote data-url=https://www.alongparty.cn/posts/a3f5fa/ data-title="源码分析 kubernetes scheduler 核心调度器的实现原理"><i class="fa-brands fa-evernote fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw"></i>&nbsp;<a href=/tags/kubernetes/>kubernetes</a>,&nbsp;<a href=/tags/%E6%BA%90%E7%A0%81/>源码</a>,&nbsp;<a href=/tags/%E8%BD%AC%E8%BD%BD/>转载</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/ba614f/ class=prev rel=prev title=Istio故障排除常用指令><i class="fa-solid fa-angle-left fa-fw"></i>Istio故障排除常用指令</a>
<a href=/posts/32dd44/ class=next rel=next title="源码分析 kubernetes hpa controller 水平自动扩缩容的实现原理">源码分析 kubernetes hpa controller 水平自动扩缩容的实现原理<i class="fa-solid fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=giscus><script src=https://giscus.app/client.js data-repo=kbsonlong/devops.alongparty.cn data-repo-id=R_kgDOHE7F-Q data-category=Announcements data-category-id=DIC_kwDOHE7F-c4CPP5J data-mapping=title data-theme=preferred_color_scheme data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-lang=zh-CN data-loading=lazy crossorigin=anonymous async defer></script><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app/ rel="external nofollow noopener noreferrer">giscus</a>.</noscript></div></div></article></main><footer class=footer><div class=footer-container><div class="footer-line copyright"><i class="fa-regular fa-copyright fa-fw"></i>
<span itemprop=copyrightYear>2018 - 2023</span><span class=author itemprop=copyrightHolder>
<a href=/>kbsonlong</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class="footer-line statistics"></div><div class="footer-line ibruce"><span id=busuanzi_container_site_uv title=总访客数><i class="fa-regular fa-user fa-fw"></i>&nbsp;<span id=busuanzi_value_site_uv><i class="fa fa-spinner fa-spin fa-fw"></i></span></span><span id=busuanzi_container_site_pv class=footer-divider title=总访问量><i class="fa-regular fa-eye fa-fw"></i>&nbsp;<span id=busuanzi_value_site_pv><i class="fa fa-spinner fa-spin fa-fw"></i></span></span></div><div class="footer-line beian"><span class="icp footer-divider"><a target=_blank href=https://beian.miit.gov.cn/>粤ICP备18122209号</a></span></div></div></footer></div><div class=widgets><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fa-solid fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fa-solid fa-comment fa-fw"></i></a></div><a href=https://github.com/kbsonlong title="在 GitHub 上查看源代码" target=_blank rel="external nofollow noopener noreferrer" class="github-corner right d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div id=mask></div></div><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/katex/copy-tex.min.css><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js defer></script><script type=text/javascript src=/lib/algoliasearch/algoliasearch-lite.umd.min.js defer></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js async defer></script><script type=text/javascript src=/lib/sharer/sharer.min.js async defer></script><script type=text/javascript src=/lib/katex/katex.min.js defer></script><script type=text/javascript src=/lib/katex/auto-render.min.js defer></script><script type=text/javascript src=/lib/katex/copy-tex.min.js defer></script><script type=text/javascript src=/lib/katex/mhchem.min.js defer></script><script type=text/javascript src=/lib/cookieconsent/cookieconsent.min.js defer></script><script type=text/javascript src=/lib/pangu/pangu.min.js defer></script><script type=text/javascript src=/lib/cell-watermark/watermark.min.js defer></script><script type=text/javascript src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async defer></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:10},comment:{giscus:{darkTheme:"dark",lightTheme:"light"}},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},enablePWA:!0,enablePangu:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"WFOR67TML1",algoliaIndex:"along",algoliaSearchKey:"ea1fe535f9a7ae353f3922489c829cc1",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"},watermark:{appendto:".wrapper>main",colspacing:30,content:'<img class="fixit-icon" src="/favicon-16x16.png" alt="FixIt logo" /> FixIt 主题',enable:!0,fontfamily:"inherit",fontsize:.85,height:21,opacity:.0125,rotate:15,rowspacing:60,width:150}}</script><script type=text/javascript src=/js/theme.min.js defer></script><script type=text/javascript src=/js/_custom.min.js defer></script></body></html>