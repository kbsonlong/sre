<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>源码分析 kubernetes hpa controller 水平自动扩缩容的实现原理 - 蜷缩的蜗牛</title><meta name=author content="kbsonlong"><meta name=author-link content><meta name=description content="源码分析 kubernetes hpa controller 水平自动扩缩容的实现原理 基于 kubernetes v1.27.0 版本进行 hpa 源码分析. Kubernetes 的 HorizontalPodAutoscaler (hpa) 组件可以根据目标的资源使用率 (cpu, mem 等等), 动态的资源对象进行的合理扩"><meta name=keywords content="源码,hpa,转载"><meta itemprop=name content="源码分析 kubernetes hpa controller 水平自动扩缩容的实现原理"><meta itemprop=description content="源码分析 kubernetes hpa controller 水平自动扩缩容的实现原理 基于 kubernetes v1.27.0 版本进行 hpa 源码分析. Kubernetes 的 HorizontalPodAutoscaler (hpa) 组件可以根据目标的资源使用率 (cpu, mem 等等), 动态的资源对象进行的合理扩"><meta itemprop=datePublished content="2023-04-18T23:05:14+08:00"><meta itemprop=dateModified content="2023-04-18T23:05:14+08:00"><meta itemprop=wordCount content="4756"><meta itemprop=image content="https://www.alongparty.cn/logo_transparent.png"><meta itemprop=keywords content="源码,hpa,转载,"><meta property="og:title" content="源码分析 kubernetes hpa controller 水平自动扩缩容的实现原理"><meta property="og:description" content="源码分析 kubernetes hpa controller 水平自动扩缩容的实现原理 基于 kubernetes v1.27.0 版本进行 hpa 源码分析. Kubernetes 的 HorizontalPodAutoscaler (hpa) 组件可以根据目标的资源使用率 (cpu, mem 等等), 动态的资源对象进行的合理扩"><meta property="og:type" content="article"><meta property="og:url" content="https://www.alongparty.cn/posts/32dd44/"><meta property="og:image" content="https://www.alongparty.cn/logo_transparent.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-04-18T23:05:14+08:00"><meta property="article:modified_time" content="2023-04-18T23:05:14+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.alongparty.cn/logo_transparent.png"><meta name=twitter:title content="源码分析 kubernetes hpa controller 水平自动扩缩容的实现原理"><meta name=twitter:description content="源码分析 kubernetes hpa controller 水平自动扩缩容的实现原理 基于 kubernetes v1.27.0 版本进行 hpa 源码分析. Kubernetes 的 HorizontalPodAutoscaler (hpa) 组件可以根据目标的资源使用率 (cpu, mem 等等), 动态的资源对象进行的合理扩"><meta name=application-name content="FixIt"><meta name=apple-mobile-web-app-title content="FixIt"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#252627"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://www.alongparty.cn/posts/32dd44/><link rel=prev href=https://www.alongparty.cn/posts/a3f5fa/><link rel=next href=https://www.alongparty.cn/posts/c7c7b8/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"源码分析 kubernetes hpa controller 水平自动扩缩容的实现原理","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/www.alongparty.cn\/posts\/32dd44\/"},"genre":"posts","keywords":"源码, hpa, 转载","wordcount":4756,"url":"https:\/\/www.alongparty.cn\/posts\/32dd44\/","datePublished":"2023-04-18T23:05:14+08:00","dateModified":"2023-04-18T23:05:14+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"kbsonlong"},"description":""}</script></head><body header-desktop=sticky header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper github-corner=right><div class=header-title><a href=/ title=蜷缩的蜗牛><img class="lazyload logo" src=/svg/loading.min.svg data-src=/logo_transparent.png data-srcset="/logo_transparent.png, /logo_transparent.png 1.5x, /logo_transparent.png 2x" data-sizes=auto alt=蜷缩的蜗牛 title=蜷缩的蜗牛><span class=header-title-text>蜷缩的蜗牛</span></a><span class=header-subtitle></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/posts/><i class='fa-solid fa-archive fa-fw fa-sm'></i> 文章</a></li><li class=menu-item><a class=menu-link href=/categories/><i class='fa-solid fa-th fa-fw fa-sm'></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class='fa-solid fa-tags fa-fw fa-sm'></i> 标签</a></li><li class=menu-item><a class=menu-link href=/friends/ title=友情链接><i class='fa-solid fa-users fa-fw fa-sm'></i> 友链</a></li><li class=menu-item><a class=menu-link href=/about/><i class='fa-solid fa-info-circle fa-fw fa-sm'></i> 关于</a></li><li class="menu-item d-none-desktop text-center"><a class=menu-link href=https://github.com/kbsonlong/ title=GitHub rel="noopener noreferrer" target=_blank><i class='fa-brands fa-github fa-fw'></i></a></li><li class="menu-item d-none-desktop text-center"><a class=menu-link href=/messages/><i class='fa-solid fa-messages'></i> 留言板</a></li><li class=menu-item><a class=menu-link href=/messages/ title=留言板>留言板</a></li><li class="menu-item delimiter"></li><li class="menu-item language"><span title=选择语言>简体中文<i class="dropdown-icon fa-solid fa-chevron-down"></i></span><ul class=sub-menu><li class=menu-item>没有更多翻译</li></ul></li><li class="menu-item search" id=search-desktop><input type=text placeholder="搜索文章标题或内容 ..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin"></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw"></i></li></ul></nav></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=蜷缩的蜗牛><img class="lazyload logo" src=/svg/loading.min.svg data-src=/logo_transparent.png data-srcset="/logo_transparent.png, /logo_transparent.png 1.5x, /logo_transparent.png 2x" data-sizes=auto alt=/logo_transparent.png title=/logo_transparent.png><span class=header-title-text>蜷缩的蜗牛</span></a><span class=header-subtitle></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="搜索文章标题或内容 ..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><a class=menu-link href=/posts/><i class='fa-solid fa-archive fa-fw fa-sm'></i> 文章</a></li><li class=menu-item><a class=menu-link href=/categories/><i class='fa-solid fa-th fa-fw fa-sm'></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class='fa-solid fa-tags fa-fw fa-sm'></i> 标签</a></li><li class=menu-item><a class=menu-link href=/friends/ title=友情链接><i class='fa-solid fa-users fa-fw fa-sm'></i> 友链</a></li><li class=menu-item><a class=menu-link href=/about/><i class='fa-solid fa-info-circle fa-fw fa-sm'></i> 关于</a></li><li class="menu-item d-none-desktop text-center"><a class=menu-link href=https://github.com/kbsonlong/ title=GitHub rel="noopener noreferrer" target=_blank><i class='fa-brands fa-github fa-fw'></i></a></li><li class="menu-item d-none-desktop text-center"><a class=menu-link href=/messages/><i class='fa-solid fa-messages'></i> 留言板</a></li><li class=menu-item><a class=menu-link href=/messages/ title=留言板>留言板</a></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw"></i></li><li class="menu-item language"><span title=选择语言>简体中文<i class="dropdown-icon fa-solid fa-chevron-down"></i></span>
<select class=language-select onchange="location=this.value"><option disabled>没有更多翻译</option></select></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=container page-style=normal><aside class=toc id=toc-auto><h2 class=toc-title>目录 <i class="toc-icon fa-solid fa-angle-down fa-fw"></i></h2><div class=toc-content id=toc-content-auto></div></aside><aside class=aside-custom></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>源码分析 kubernetes hpa controller 水平自动扩缩容的实现原理</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><img class="lazyload avatar" src=/svg/loading.min.svg data-src="https://gravatar.loli.net/avatar/598872715ec08296cf1e1806135cd518?s=32&amp;d=mp" data-srcset="https://gravatar.loli.net/avatar/598872715ec08296cf1e1806135cd518?s=32&amp;d=mp, https://gravatar.loli.net/avatar/598872715ec08296cf1e1806135cd518?s=32&amp;d=mp 1.5x, https://gravatar.loli.net/avatar/598872715ec08296cf1e1806135cd518?s=32&amp;d=mp 2x" data-sizes=auto alt=kbsonlong title=kbsonlong>&nbsp;kbsonlong</span></span>
<span class=post-category>收录于 <a href=/categories/kubernetes/><i class="fa-regular fa-folder fa-fw"></i>&nbsp;kubernetes</a></span></div><div class=post-meta-line><span title="2023-04-18 23:05:14"><i class="fa-regular fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2023-04-18>2023-04-18</time>
</span>&nbsp;<i class="fa-solid fa-pencil-alt fa-fw"></i>&nbsp;约 4756 字&nbsp;
<i class="fa-regular fa-clock fa-fw"></i>&nbsp;预计阅读 10 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#源码分析-kubernetes-hpa-controller-水平自动扩缩容的实现原理>源码分析 kubernetes hpa controller 水平自动扩缩容的实现原理</a><ul><li><a href=#hpa-的配置例子>hpa 的配置例子</a></li><li><a href=#实例化-hpa-控制器>实例化 hpa 控制器</a><ul><li><a href=#注册的-resourceeventhandler>注册的 ResourceEventHandler</a></li><li><a href=#默认启动参数>默认启动参数</a></li></ul></li><li><a href=#启动-hpa-控制器>启动 hpa 控制器</a></li><li><a href=#核心方法-reconcileautoscaler>核心方法 reconcileAutoscaler</a></li><li><a href=#计算预期的副本数>计算预期的副本数</a><ul><li><a href=#usageratio-使用率是如何计算的->UsageRatio 使用率是如何计算的 ?</a></li><li><a href=#副本数的计算>副本数的计算</a></li></ul></li><li><a href=#向-apiserver-请求-scales-操作>向 apiserver 请求 Scales 操作</a></li><li><a href=#apiserver-对-scale-请求的处理>apiserver 对 scale 请求的处理</a></li><li><a href=#总结>总结</a></li></ul></li></ul></nav></div></div><div class=content id=content><h2 id=源码分析-kubernetes-hpa-controller-水平自动扩缩容的实现原理>源码分析 kubernetes hpa controller 水平自动扩缩容的实现原理</h2><p>基于 kubernetes <code>v1.27.0</code> 版本进行 hpa 源码分析.</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301081419964.png data-srcset="https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301081419964.png, https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301081419964.png 1.5x, https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301081419964.png 2x" data-sizes=auto alt=https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301081419964.png title=https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301081419964.png></p><p>Kubernetes 的 HorizontalPodAutoscaler (hpa) 组件可以根据目标的资源使用率 (cpu, mem 等等), 动态的资源对象进行的合理扩缩容. hpa 通常是对 deployment 和 replicaset 资源进行自动伸缩.</p><p>比如, 当 deployment 关联的 pods 负载超过阈值时, hpa 对其进行动态扩容, 但扩容的副本数不能超过 <code>maxReplicas</code>. 反之, 如果 pods 负载减少, 则进行动态缩容.</p><h3 id=hpa-的配置例子>hpa 的配置例子</h3><p>分析 hpa 源码之前, 需要先理解 hpa 的配置选项, 不然不好理解后面的代码分析.</p><p>下面的 hpa 的配置中定义了最大和最小的副本数, 无论怎么超过定义的资源负载阈值, 不会超过 hpa 中定义的最大的副本数 10. 一样的逻辑, 不管 pods 再怎么空闲, 副本数也不能低于 5 个.</p><p>尽量确保 pods 的平均 cpu 使用率不超过 70%, 超过使用率时则需要立即执行扩容. 而进行 scale 缩容时, 则需要等待 <code>300s</code> 后再判断是否进行, 该等待操作是避免业务抖动引发的频繁的 scale pods 自动伸缩.</p><p>另外 behavior 的 policies 用来控制动态伸缩的速度, 避免一次性操作太多 pods 实例造成服务抖动, 通常 behavior 配置的原则是快速扩容, 低速缩容回收.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>HorizontalPodAutoscaler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>autoscaling/v2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-xiaorui-cc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>scaleTargetRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-xiaorui-cc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>minReplicas</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>maxReplicas</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>behavior</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>scaleDown</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>stabilizationWindowSeconds</span><span class=p>:</span><span class=w> </span><span class=m>300</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>policies</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Percent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=m>100</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>15</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>scaleUp</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>stabilizationWindowSeconds</span><span class=p>:</span><span class=w> </span><span class=m>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>policies</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Percent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=m>50</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>15</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Pods</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>15</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>metrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Resource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>resource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cpu</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>target</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Utilization</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>averageUtilization</span><span class=p>:</span><span class=w> </span><span class=m>70</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=实例化-hpa-控制器>实例化 hpa 控制器</h3><p>实例化 HorizontalController 控制器, 内部使用 hpaInformer 注册自定义的 eventHandler 事件处理方法.</p><p>另外 HorizontalController 还定义了两个 lister 实例.</p><ul><li>hpaLister 主要用来判断 hpa 是否重新入队, 如果已经不存在, 则无需重新入队.</li><li>podLister 在计算预期副本数时, 需要考虑到有些 pod 未就绪或者正被清理掉.</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewHorizontalController</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>*</span><span class=nx>HorizontalController</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>hpaController</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>HorizontalController</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>queue</span><span class=p>:</span> <span class=nx>workqueue</span><span class=p>.</span><span class=nf>NewNamedRateLimitingQueue</span><span class=p>(</span><span class=nf>NewDefaultHPARateLimiter</span><span class=p>(</span><span class=nx>resyncPeriod</span><span class=p>),</span> <span class=s>&#34;horizontalpodautoscaler&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=o>...</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 为 hpaInformer 增加 eventHandler 事件
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>hpaInformer</span><span class=p>.</span><span class=nf>Informer</span><span class=p>().</span><span class=nf>AddEventHandlerWithResyncPeriod</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=nx>cache</span><span class=p>.</span><span class=nx>ResourceEventHandlerFuncs</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>AddFunc</span><span class=p>:</span>    <span class=nx>hpaController</span><span class=p>.</span><span class=nx>enqueueHPA</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>UpdateFunc</span><span class=p>:</span> <span class=nx>hpaController</span><span class=p>.</span><span class=nx>updateHPA</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>DeleteFunc</span><span class=p>:</span> <span class=nx>hpaController</span><span class=p>.</span><span class=nx>deleteHPA</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=nx>resyncPeriod</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// hpaLister
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>hpaController</span><span class=p>.</span><span class=nx>hpaLister</span> <span class=p>=</span> <span class=nx>hpaInformer</span><span class=p>.</span><span class=nf>Lister</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>hpaController</span><span class=p>.</span><span class=nx>hpaListerSynced</span> <span class=p>=</span> <span class=nx>hpaInformer</span><span class=p>.</span><span class=nf>Informer</span><span class=p>().</span><span class=nx>HasSynced</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// podLister
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>hpaController</span><span class=p>.</span><span class=nx>podLister</span> <span class=p>=</span> <span class=nx>podInformer</span><span class=p>.</span><span class=nf>Lister</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>hpaController</span><span class=p>.</span><span class=nx>podListerSynced</span> <span class=p>=</span> <span class=nx>podInformer</span><span class=p>.</span><span class=nf>Informer</span><span class=p>().</span><span class=nx>HasSynced</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 实例化副本计算器
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>replicaCalc</span> <span class=o>:=</span> <span class=nf>NewReplicaCalculator</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=nx>metricsClient</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>hpaController</span><span class=p>.</span><span class=nx>podLister</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>tolerance</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=o>...</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>hpaController</span><span class=p>.</span><span class=nx>replicaCalc</span> <span class=p>=</span> <span class=nx>replicaCalc</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>hpaController</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=注册的-resourceeventhandler>注册的 ResourceEventHandler</h4><p>当 podInformer 有事件变更, 如果是触发增加 <code>AddFunc</code> 和更新 <code>UpdateFunc</code> 方法, 直接往 workqueue 里推入 <code>namespace/name</code> 格式的 key 即可, 而当触发删除 <code>DeleteFunc</code> 操作时, 则需要调用 <code>queue.Forget</code> 删除.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>a</span> <span class=o>*</span><span class=nx>HorizontalController</span><span class=p>)</span> <span class=nf>updateHPA</span><span class=p>(</span><span class=nx>old</span><span class=p>,</span> <span class=nx>cur</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>a</span><span class=p>.</span><span class=nf>enqueueHPA</span><span class=p>(</span><span class=nx>cur</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>a</span> <span class=o>*</span><span class=nx>HorizontalController</span><span class=p>)</span> <span class=nf>enqueueHPA</span><span class=p>(</span><span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>key</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>controller</span><span class=p>.</span><span class=nf>KeyFunc</span><span class=p>(</span><span class=nx>obj</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>a</span><span class=p>.</span><span class=nx>queue</span><span class=p>.</span><span class=nf>AddRateLimited</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>a</span> <span class=o>*</span><span class=nx>HorizontalController</span><span class=p>)</span> <span class=nf>deleteHPA</span><span class=p>(</span><span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>key</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>controller</span><span class=p>.</span><span class=nf>KeyFunc</span><span class=p>(</span><span class=nx>obj</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 从队列中剔除
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>a</span><span class=p>.</span><span class=nx>queue</span><span class=p>.</span><span class=nf>Forget</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=默认启动参数>默认启动参数</h4><p>需要注意的是, 启动的 worker 协程数量默认为 <code>5</code> 个, queue 延迟入队时间为 <code>15s</code>.</p><p>代码位置: <code>pkg/controller/podautoscaler/config/v1alpha1/defaults.go</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>RecommendedDefaultHPAControllerConfiguration</span><span class=p>(</span><span class=nx>obj</span> <span class=o>*</span><span class=nx>kubectrlmgrconfigv1alpha1</span><span class=p>.</span><span class=nx>HPAControllerConfiguration</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>zero</span> <span class=o>:=</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>Duration</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>obj</span><span class=p>.</span><span class=nx>ConcurrentHorizontalPodAutoscalerSyncs</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>obj</span><span class=p>.</span><span class=nx>ConcurrentHorizontalPodAutoscalerSyncs</span> <span class=p>=</span> <span class=mi>5</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>obj</span><span class=p>.</span><span class=nx>HorizontalPodAutoscalerSyncPeriod</span> <span class=o>==</span> <span class=nx>zero</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>obj</span><span class=p>.</span><span class=nx>HorizontalPodAutoscalerSyncPeriod</span> <span class=p>=</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>Duration</span><span class=p>{</span><span class=nx>Duration</span><span class=p>:</span> <span class=mi>15</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=启动-hpa-控制器>启动 hpa 控制器</h3><p>跟其他 k8s controller 的启动逻辑一样, 调用 <code>Run()</code> 方法启动 HorizontalController 控制器, 内部完成 hpa 和 pod 的 informer 同步完成, 启动多个 worker 协程处理 scale 逻辑, 默认为 5 个.</p><p>源码位置: <code>pkg/controller/podautoscaler/horizontal.go</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>a</span> <span class=o>*</span><span class=nx>HorizontalController</span><span class=p>)</span> <span class=nf>Run</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>workers</span> <span class=kt>int</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>klog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;Starting HPA controller&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;Shutting down HPA controller&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 等待 informer 数据同步完成
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=p>!</span><span class=nx>cache</span><span class=p>.</span><span class=nf>WaitForNamedCacheSync</span><span class=p>(</span><span class=s>&#34;HPA&#34;</span><span class=p>,</span> <span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>(),</span> <span class=nx>a</span><span class=p>.</span><span class=nx>hpaListerSynced</span><span class=p>,</span> <span class=nx>a</span><span class=p>.</span><span class=nx>podListerSynced</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 启动 worker
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nx>workers</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>go</span> <span class=nx>wait</span><span class=p>.</span><span class=nf>UntilWithContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>a</span><span class=p>.</span><span class=nx>worker</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>&lt;-</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>processNextWorkItem</code> 从 workqueue 获取由 informer 的插入的 hpa 对象的 key. 其 key 格式为 <code>namespace/name</code>. 调用核心入口函数 reconcileKey 处理 hpa 逻辑.</p><p>当 hpa 资源已不存在时则需要删除, 反之需要再次插入到 workqueue 的 delayQueue 里, 用来实现延迟再入队的逻辑, 默认 <code>15s</code> 后再次入队.</p><p>hpa 控制器需要不停的周期性对所有 hpa 的资源检测资源使用率, 才可根据阈值条件进行动态扩缩容. 所以 hpa 需要一个定时器的逻辑, 这里的定时器是放在 workqueue 实现的.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>a</span> <span class=o>*</span><span class=nx>HorizontalController</span><span class=p>)</span> <span class=nf>worker</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>a</span><span class=p>.</span><span class=nf>processNextWorkItem</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>a</span> <span class=o>*</span><span class=nx>HorizontalController</span><span class=p>)</span> <span class=nf>processNextWorkItem</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 获取由 informer eventHandler 发到 queue 里的 key, 格式为 `namespace/name`
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>key</span><span class=p>,</span> <span class=nx>quit</span> <span class=o>:=</span> <span class=nx>a</span><span class=p>.</span><span class=nx>queue</span><span class=p>.</span><span class=nf>Get</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>quit</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>a</span><span class=p>.</span><span class=nx>queue</span><span class=p>.</span><span class=nf>Done</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// hpa 核心方法, 由该方法来实现扩缩容
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>deleted</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>a</span><span class=p>.</span><span class=nf>reconcileKey</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>key</span><span class=p>.(</span><span class=kt>string</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>utilruntime</span><span class=p>.</span><span class=nf>HandleError</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 如果无异常且没有被删除, 则重新入队, 等待一段时间后又可消费此 hpa.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=p>!</span><span class=nx>deleted</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>a</span><span class=p>.</span><span class=nx>queue</span><span class=p>.</span><span class=nf>AddRateLimited</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>如果从 workqueue 拿到的 hpa 对象已经被清理掉, 则返回 deleted 标记, 表明该对象无需入队. 反之则调用 <code>reconcileAutoscaler</code> 主逻辑.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>a</span> <span class=o>*</span><span class=nx>HorizontalController</span><span class=p>)</span> <span class=nf>reconcileKey</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>key</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=nx>deleted</span> <span class=kt>bool</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>namespace</span><span class=p>,</span> <span class=nx>name</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>cache</span><span class=p>.</span><span class=nf>SplitMetaNamespaceKey</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>true</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>hpa</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>a</span><span class=p>.</span><span class=nx>hpaLister</span><span class=p>.</span><span class=nf>HorizontalPodAutoscalers</span><span class=p>(</span><span class=nx>namespace</span><span class=p>).</span><span class=nf>Get</span><span class=p>(</span><span class=nx>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 如果从 workqueue 拿到的 hpa 已经被清理掉, 则返回 deleted 标记, 该对象不再入队.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>IsNotFound</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=o>...</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>true</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>false</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 调用该方法处理 scale 逻辑
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>return</span> <span class=kc>false</span><span class=p>,</span> <span class=nx>a</span><span class=p>.</span><span class=nf>reconcileAutoscaler</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>hpa</span><span class=p>,</span> <span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>简单看下 workqueue 的实例化类型, 以及 <code>AddRateLimited()</code> 延迟插入的实现原理.</p><p>简单说, 其内部把延迟入队对象放到 delay 队列里, 本质 delay queue 数据结构为小顶堆, 使用到期时间进行 heap 排序. 另外内部启动一个协程去监听是否到期, 到期则插入对 queue 里.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>queue</span> <span class=o>:=</span> <span class=nx>workqueue</span><span class=p>.</span><span class=nf>NewNamedRateLimitingQueue</span><span class=p>(</span><span class=nf>NewDefaultHPARateLimiter</span><span class=p>(</span><span class=nx>resyncPeriod</span><span class=p>),</span> <span class=s>&#34;horizontalpodautoscaler&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>q</span> <span class=o>*</span><span class=nx>rateLimitingType</span><span class=p>)</span> <span class=nf>AddRateLimited</span><span class=p>(</span><span class=nx>item</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>q</span><span class=p>.</span><span class=nx>DelayingInterface</span><span class=p>.</span><span class=nf>AddAfter</span><span class=p>(</span><span class=nx>item</span><span class=p>,</span> <span class=nx>q</span><span class=p>.</span><span class=nx>rateLimiter</span><span class=p>.</span><span class=nf>When</span><span class=p>(</span><span class=nx>item</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=核心方法-reconcileautoscaler>核心方法 reconcileAutoscaler</h3><p><code>reconcileAutoscaler</code> 是 hpa 控制器的核心处理方法. 流程是这样, 先对一些参数做了调整修正, 而后调用 <code>computeReplicasForMetrics</code> 进行复杂的预期副本计算, 如果副本数跟当前不一致, 说明需要 scale 扩缩容.</p><p>接着使用 k8s client 对 hpa 关联对象执行 scale 副本调节请求, 最后更新 hpa 对象的状态.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>a</span> <span class=o>*</span><span class=nx>HorizontalController</span><span class=p>)</span> <span class=nf>reconcileAutoscaler</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>hpaShared</span> <span class=o>*</span><span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>HorizontalPodAutoscaler</span><span class=p>,</span> <span class=nx>key</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>hpa</span> <span class=o>:=</span> <span class=nx>hpaShared</span><span class=p>.</span><span class=nf>DeepCopy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 当前 scale 里副本数
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>currentReplicas</span> <span class=o>:=</span> <span class=nx>scale</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Replicas</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 预期的副本数
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>desiredReplicas</span> <span class=o>:=</span> <span class=nb>int32</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 调整预期的最小副本数
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kd>var</span> <span class=nx>minReplicas</span> <span class=kt>int32</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>hpa</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>MinReplicas</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>minReplicas</span> <span class=p>=</span> <span class=o>*</span><span class=nx>hpa</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>MinReplicas</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>minReplicas</span> <span class=p>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>rescale</span> <span class=o>:=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>scale</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Replicas</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=nx>minReplicas</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 副本数为0, 不启动自动扩缩容
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>desiredReplicas</span> <span class=p>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>		<span class=nx>rescale</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>currentReplicas</span> <span class=p>&gt;</span> <span class=nx>hpa</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>MaxReplicas</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 如果当前副本数大于最大期望副本数, 那么设置期望副本数为最大副本数
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>desiredReplicas</span> <span class=p>=</span> <span class=nx>hpa</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>MaxReplicas</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>currentReplicas</span> <span class=p>&lt;</span> <span class=nx>minReplicas</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 如果当前副本数小于最小期望副本数, 那么设为最小副本数
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>desiredReplicas</span> <span class=p>=</span> <span class=nx>minReplicas</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=kd>var</span> <span class=nx>metricTimestamp</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// 通过 metrics 指标数据计算预期的的副本数
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>metricDesiredReplicas</span><span class=p>,</span> <span class=nx>metricName</span><span class=p>,</span> <span class=nx>metricStatuses</span><span class=p>,</span> <span class=nx>metricTimestamp</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>a</span><span class=p>.</span><span class=nf>computeReplicasForMetrics</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>hpa</span><span class=p>,</span> <span class=nx>scale</span><span class=p>,</span> <span class=nx>hpa</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Metrics</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// 更新状态
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>a</span><span class=p>.</span><span class=nf>updateStatusIfNeeded</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>hpaStatusOriginal</span><span class=p>,</span> <span class=nx>hpa</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to compute desired number of replicas based on listed metrics for %s: %v&#34;</span><span class=p>,</span> <span class=nx>reference</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// 如果指标预期副本比预期副本大, 则使用指标预期副本
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>metricDesiredReplicas</span> <span class=p>&gt;</span> <span class=nx>desiredReplicas</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>desiredReplicas</span> <span class=p>=</span> <span class=nx>metricDesiredReplicas</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// 如果配置中存在 behavior 策略, 那么
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>hpa</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Behavior</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>desiredReplicas</span> <span class=p>=</span> <span class=nx>a</span><span class=p>.</span><span class=nf>normalizeDesiredReplicas</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>currentReplicas</span><span class=p>,</span> <span class=nx>desiredReplicas</span><span class=p>,</span> <span class=nx>minReplicas</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>desiredReplicas</span> <span class=p>=</span> <span class=nx>a</span><span class=p>.</span><span class=nf>normalizeDesiredReplicasWithBehaviors</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>currentReplicas</span><span class=p>,</span> <span class=nx>desiredReplicas</span><span class=p>,</span> <span class=nx>minReplicas</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// 如果预期副本跟当前副本数不一致则进行扩缩容操作
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>rescale</span> <span class=p>=</span> <span class=nx>desiredReplicas</span> <span class=o>!=</span> <span class=nx>currentReplicas</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>rescale</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 配置副本数
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>scale</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Replicas</span> <span class=p>=</span> <span class=nx>desiredReplicas</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// 进行扩缩容
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>a</span><span class=p>.</span><span class=nx>scaleNamespacer</span><span class=p>.</span><span class=nf>Scales</span><span class=p>(</span><span class=nx>hpa</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>).</span><span class=nf>Update</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>targetGR</span><span class=p>,</span> <span class=nx>scale</span><span class=p>,</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>UpdateOptions</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>		<span class=o>...</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>desiredReplicas</span> <span class=p>=</span> <span class=nx>currentReplicas</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 配置 hpa.status
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>a</span><span class=p>.</span><span class=nf>setStatus</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=nx>currentReplicas</span><span class=p>,</span> <span class=nx>desiredReplicas</span><span class=p>,</span> <span class=nx>metricStatuses</span><span class=p>,</span> <span class=nx>rescale</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 更新状态
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>return</span> <span class=nx>a</span><span class=p>.</span><span class=nf>updateStatusIfNeeded</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>hpaStatusOriginal</span><span class=p>,</span> <span class=nx>hpa</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=计算预期的副本数>计算预期的副本数</h3><p><img class=lazyload src=/svg/loading.min.svg data-src=https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301081456043.png data-srcset="https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301081456043.png, https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301081456043.png 1.5x, https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301081456043.png 2x" data-sizes=auto alt=https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301081456043.png title=https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301081456043.png></p><p><code>computeReplicasForMetrics</code> 用来根据 metris 指标计算新副本数的方法.</p><p>其内部逻辑是这样, 先遍历 <code>hpa.Spec.Metrics</code> 列表依次调用 <code>computeReplicasForMetric()</code> 计算出最后预期副本数. <code>computeReplicasForMetric</code> 方法通过不同的指标类型获取需要扩缩副本的数量.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>a</span> <span class=o>*</span><span class=nx>HorizontalController</span><span class=p>)</span> <span class=nf>computeReplicasForMetrics</span><span class=p>(</span><span class=nx>hpa</span> <span class=o>*</span><span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>HorizontalPodAutoscaler</span><span class=p>,</span> <span class=nx>scale</span> <span class=o>*</span><span class=nx>autoscalingv1</span><span class=p>.</span><span class=nx>Scale</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>metricSpecs</span> <span class=p>[]</span><span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>MetricSpec</span><span class=p>)</span> <span class=p>(</span><span class=nx>replicas</span> <span class=kt>int32</span><span class=p>,</span> <span class=nx>metric</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>statuses</span> <span class=p>[]</span><span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>MetricStatus</span><span class=p>,</span> <span class=nx>timestamp</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 遍历 `hpa.Spec.Metrics` 列表.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>for</span> <span class=nx>i</span><span class=p>,</span> <span class=nx>metricSpec</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>metricSpecs</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 通过不同的指标类型进一步获取需要扩缩副本的数量, 每次调用使用上一波预期的 replicas 进行传参调用
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>replicaCountProposal</span><span class=p>,</span> <span class=nx>metricNameProposal</span><span class=p>,</span> <span class=nx>timestampProposal</span><span class=p>,</span> <span class=nx>condition</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>a</span><span class=p>.</span><span class=nf>computeReplicasForMetric</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=nx>metricSpec</span><span class=p>,</span> <span class=nx>specReplicas</span><span class=p>,</span> <span class=nx>statusReplicas</span><span class=p>,</span> <span class=nx>selector</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>statuses</span><span class=p>[</span><span class=nx>i</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// 重新赋值副本数
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=nx>replicas</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>||</span> <span class=nx>replicaCountProposal</span> <span class=p>&gt;</span> <span class=nx>replicas</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>timestamp</span> <span class=p>=</span> <span class=nx>timestampProposal</span>
</span></span><span class=line><span class=cl>			<span class=nx>replicas</span> <span class=p>=</span> <span class=nx>replicaCountProposal</span>
</span></span><span class=line><span class=cl>			<span class=nx>metric</span> <span class=p>=</span> <span class=nx>metricNameProposal</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=o>...</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>replicas</span><span class=p>,</span> <span class=nx>metric</span><span class=p>,</span> <span class=nx>statuses</span><span class=p>,</span> <span class=nx>timestamp</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>按照不同的指标类型计算预期出预期的副本数. 拿一个 hpa 的 yaml 举例说明 metrics 指标的使用.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>autoscaling/v2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>HorizontalPodAutoscaler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>php-apache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>scaleTargetRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>php-apache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>minReplicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>maxReplicas</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>metrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Object</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>object</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>metric</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>requests-per-second</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>describedObject</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Ingress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>main-route</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>target</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Value</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>10k</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Pods</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>pods</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>metric</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>packets-per-second</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>target</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>AverageValue</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>averageValue</span><span class=p>:</span><span class=w> </span><span class=l>1k</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Resource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cpu</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>target</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Utilization</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>averageUtilization</span><span class=p>:</span><span class=w> </span><span class=m>50</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>hpa 尝试确保每个 Pod 的 CPU 利用率在 50% 以内, 每秒处理 1000 个数据包请求, 还确保 Ingress 后的 Pod 每秒能够服务的请求总数达到 10000 个.</p><p>这些指标不是 and 并且关系, 而是 or 或的关系, 只要超过一个指标也会触发扩缩容操作. hpa 会尝试遍历所有的指标条件, 计算出合理的副本数.</p><p>hpa 可以根据不同的 metrics 进行 scale 扩缩容操作, 常用的是 <code>resource</code> 指标, 这里拿 <code>resource</code> 为例分析其计算过程.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>a</span> <span class=o>*</span><span class=nx>HorizontalController</span><span class=p>)</span> <span class=nf>computeReplicasForMetric</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>hpa</span> <span class=o>*</span><span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>HorizontalPodAutoscaler</span><span class=p>,</span> <span class=nx>spec</span> <span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>MetricSpec</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>specReplicas</span><span class=p>,</span> <span class=nx>statusReplicas</span> <span class=kt>int32</span><span class=p>,</span> <span class=nx>selector</span> <span class=nx>labels</span><span class=p>.</span><span class=nx>Selector</span><span class=p>,</span> <span class=nx>status</span> <span class=o>*</span><span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>MetricStatus</span><span class=p>)</span> <span class=p>(</span><span class=nx>replicaCountProposal</span> <span class=kt>int32</span><span class=p>,</span> <span class=nx>metricNameProposal</span> <span class=kt>string</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>timestampProposal</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>,</span> <span class=nx>condition</span> <span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>HorizontalPodAutoscalerCondition</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>switch</span> <span class=nx>spec</span><span class=p>.</span><span class=nx>Type</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>ObjectMetricSourceType</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 根据 k8s 内置对象的指标进行计算
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>PodsMetricSourceType</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 通过 pods 的 metrics 进行计算
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>ResourceMetricSourceType</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 描述 pod 的 cpu, mem 等资源指标进行计算
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>replicaCountProposal</span><span class=p>,</span> <span class=nx>timestampProposal</span><span class=p>,</span> <span class=nx>metricNameProposal</span><span class=p>,</span> <span class=nx>condition</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>a</span><span class=p>.</span><span class=nf>computeStatusForResourceMetric</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>specReplicas</span><span class=p>,</span> <span class=nx>spec</span><span class=p>,</span> <span class=nx>hpa</span><span class=p>,</span> <span class=nx>selector</span><span class=p>,</span> <span class=nx>status</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>{},</span> <span class=nx>condition</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to get %s resource metric value: %v&#34;</span><span class=p>,</span> <span class=nx>spec</span><span class=p>.</span><span class=nx>Resource</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>ContainerResourceMetricSourceType</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 根据每个 pod 内 container 的 resource 指标进行计算, 比如容器内的 cpu, mem 等.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>ExternalMetricSourceType</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 根据外部 external 指标进行计算
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=o>...</span>
</span></span><span class=line><span class=cl>	<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nx>condition</span> <span class=o>:=</span> <span class=nx>a</span><span class=p>.</span><span class=nf>getUnableComputeReplicaCountCondition</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=s>&#34;InvalidMetricSourceType&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>{},</span> <span class=nx>condition</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>replicaCountProposal</span><span class=p>,</span> <span class=nx>metricNameProposal</span><span class=p>,</span> <span class=nx>timestampProposal</span><span class=p>,</span> <span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>HorizontalPodAutoscalerCondition</span><span class=p>{},</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>依赖资源指标计算副本数的逻辑调用链略长, 最后其实是调用 <code>GetResourceReplicas()</code> 计算副本数.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>ReplicaCalculator</span><span class=p>)</span> <span class=nf>GetResourceReplicas</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>currentReplicas</span> <span class=kt>int32</span><span class=p>,</span> <span class=nx>targetUtilization</span> <span class=kt>int32</span><span class=p>,</span> <span class=nx>resource</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>ResourceName</span><span class=p>,</span> <span class=nx>namespace</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>selector</span> <span class=nx>labels</span><span class=p>.</span><span class=nx>Selector</span><span class=p>,</span> <span class=nx>container</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=nx>replicaCount</span> <span class=kt>int32</span><span class=p>,</span> <span class=nx>utilization</span> <span class=kt>int32</span><span class=p>,</span> <span class=nx>rawUtilization</span> <span class=kt>int64</span><span class=p>,</span> <span class=nx>timestamp</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 获取符合条件 pods 的 metrics 指标
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>metrics</span><span class=p>,</span> <span class=nx>timestamp</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>metricsClient</span><span class=p>.</span><span class=nf>GetResourceMetric</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>resource</span><span class=p>,</span> <span class=nx>namespace</span><span class=p>,</span> <span class=nx>selector</span><span class=p>,</span> <span class=nx>container</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>{},</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;unable to get metrics for resource %s: %v&#34;</span><span class=p>,</span> <span class=nx>resource</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 获取 pods 对象集合
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>podList</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>podLister</span><span class=p>.</span><span class=nf>Pods</span><span class=p>(</span><span class=nx>namespace</span><span class=p>).</span><span class=nf>List</span><span class=p>(</span><span class=nx>selector</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>{},</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;unable to get pods while calculating replica count: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 对 pods 的status进行分组为 就绪 pods, 未就绪 pods, 未找到 metrics 的 pods, 已经被标记删除的 pods
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>readyPodCount</span><span class=p>,</span> <span class=nx>unreadyPods</span><span class=p>,</span> <span class=nx>missingPods</span><span class=p>,</span> <span class=nx>ignoredPods</span> <span class=o>:=</span> <span class=nf>groupPods</span><span class=p>(</span><span class=nx>podList</span><span class=p>,</span> <span class=nx>metrics</span><span class=p>,</span> <span class=nx>resource</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>cpuInitializationPeriod</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>delayOfInitialReadinessStatus</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 在 metrics 字典中清理, 未就绪和标记删除的 pods
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>removeMetricsForPods</span><span class=p>(</span><span class=nx>metrics</span><span class=p>,</span> <span class=nx>ignoredPods</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nf>removeMetricsForPods</span><span class=p>(</span><span class=nx>metrics</span><span class=p>,</span> <span class=nx>unreadyPods</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 获取各个 pod 的 resource request 资源配置
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>requests</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>calculatePodRequests</span><span class=p>(</span><span class=nx>podList</span><span class=p>,</span> <span class=nx>container</span><span class=p>,</span> <span class=nx>resource</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>{},</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 计算资源的使用率
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>usageRatio</span><span class=p>,</span> <span class=nx>utilization</span><span class=p>,</span> <span class=nx>rawUtilization</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>metricsclient</span><span class=p>.</span><span class=nf>GetResourceUtilizationRatio</span><span class=p>(</span><span class=nx>metrics</span><span class=p>,</span> <span class=nx>requests</span><span class=p>,</span> <span class=nx>targetUtilization</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>{},</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>scaleUpWithUnready</span> <span class=o>:=</span> <span class=nb>len</span><span class=p>(</span><span class=nx>unreadyPods</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=nx>usageRatio</span> <span class=p>&gt;</span> <span class=mf>1.0</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 如果不满足使用率大于 1.0 和 未就绪的 pods 大于 0的条件, 且没有收不到 metrics pods.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// 那么副本数为 usageRatio * readyPodCount 向上取整.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=p>!</span><span class=nx>scaleUpWithUnready</span> <span class=o>&amp;&amp;</span> <span class=nb>len</span><span class=p>(</span><span class=nx>missingPods</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nb>int32</span><span class=p>(</span><span class=nx>math</span><span class=p>.</span><span class=nf>Ceil</span><span class=p>(</span><span class=nx>usageRatio</span> <span class=o>*</span> <span class=nb>float64</span><span class=p>(</span><span class=nx>readyPodCount</span><span class=p>))),</span> <span class=nx>utilization</span><span class=p>,</span> <span class=nx>rawUtilization</span><span class=p>,</span> <span class=nx>timestamp</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>missingPods</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>usageRatio</span> <span class=p>&lt;</span> <span class=mf>1.0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// 为 missingPods 预设资源使用率.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>fallbackUtilization</span> <span class=o>:=</span> <span class=nb>int64</span><span class=p>(</span><span class=nf>max</span><span class=p>(</span><span class=mi>100</span><span class=p>,</span> <span class=nx>targetUtilization</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=nx>podName</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>missingPods</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>metrics</span><span class=p>[</span><span class=nx>podName</span><span class=p>]</span> <span class=p>=</span> <span class=nx>metricsclient</span><span class=p>.</span><span class=nx>PodMetric</span><span class=p>{</span><span class=nx>Value</span><span class=p>:</span> <span class=nx>requests</span><span class=p>[</span><span class=nx>podName</span><span class=p>]</span> <span class=o>*</span> <span class=nx>fallbackUtilization</span> <span class=o>/</span> <span class=mi>100</span><span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>usageRatio</span> <span class=p>&gt;</span> <span class=mf>1.0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=nx>podName</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>missingPods</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>metrics</span><span class=p>[</span><span class=nx>podName</span><span class=p>]</span> <span class=p>=</span> <span class=nx>metricsclient</span><span class=p>.</span><span class=nx>PodMetric</span><span class=p>{</span><span class=nx>Value</span><span class=p>:</span> <span class=mi>0</span><span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>scaleUpWithUnready</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>podName</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>unreadyPods</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>metrics</span><span class=p>[</span><span class=nx>podName</span><span class=p>]</span> <span class=p>=</span> <span class=nx>metricsclient</span><span class=p>.</span><span class=nx>PodMetric</span><span class=p>{</span><span class=nx>Value</span><span class=p>:</span> <span class=mi>0</span><span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 上面填充一些 pod 的 metrics, 重新计算资源使用率
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>newUsageRatio</span><span class=p>,</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>metricsclient</span><span class=p>.</span><span class=nf>GetResourceUtilizationRatio</span><span class=p>(</span><span class=nx>metrics</span><span class=p>,</span> <span class=nx>requests</span><span class=p>,</span> <span class=nx>targetUtilization</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>utilization</span><span class=p>,</span> <span class=nx>rawUtilization</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>{},</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 计算副本数, 公式为 `使用率 * metrics 个数` 向上取整.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>newReplicas</span> <span class=o>:=</span> <span class=nb>int32</span><span class=p>(</span><span class=nx>math</span><span class=p>.</span><span class=nf>Ceil</span><span class=p>(</span><span class=nx>newUsageRatio</span> <span class=o>*</span> <span class=nb>float64</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>metrics</span><span class=p>))))</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=nx>newUsageRatio</span> <span class=p>&lt;</span> <span class=mf>1.0</span> <span class=o>&amp;&amp;</span> <span class=nx>newReplicas</span> <span class=p>&gt;</span> <span class=nx>currentReplicas</span><span class=p>)</span> <span class=o>||</span> <span class=p>(</span><span class=nx>newUsageRatio</span> <span class=p>&gt;</span> <span class=mf>1.0</span> <span class=o>&amp;&amp;</span> <span class=nx>newReplicas</span> <span class=p>&lt;</span> <span class=nx>currentReplicas</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 低负载条件下, 使用当前的副本数
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>return</span> <span class=nx>currentReplicas</span><span class=p>,</span> <span class=nx>utilization</span><span class=p>,</span> <span class=nx>rawUtilization</span><span class=p>,</span> <span class=nx>timestamp</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>newReplicas</span><span class=p>,</span> <span class=nx>utilization</span><span class=p>,</span> <span class=nx>rawUtilization</span><span class=p>,</span> <span class=nx>timestamp</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=usageratio-使用率是如何计算的->UsageRatio 使用率是如何计算的 ?</h4><p>首先把累加所有 pods 的 metrics 和 request 值, 然后相除后再跟 spec 中目标百分比进行相除, 最后求出所有 pods 的平均使用率.</p><p>代码位置: <code>pkg/controller/podautoscaler/metrics/utilization.go</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>GetResourceUtilizationRatio</span><span class=p>(</span><span class=nx>metrics</span> <span class=nx>PodMetricsInfo</span><span class=p>,</span> <span class=nx>requests</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>int64</span><span class=p>,</span> <span class=nx>targetUtilization</span> <span class=kt>int32</span><span class=p>)</span> <span class=p>(</span><span class=nx>utilizationRatio</span> <span class=kt>float64</span><span class=p>,</span> <span class=nx>currentUtilization</span> <span class=kt>int32</span><span class=p>,</span> <span class=nx>rawAverageValue</span> <span class=kt>int64</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>metricsTotal</span> <span class=o>:=</span> <span class=nb>int64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>requestsTotal</span> <span class=o>:=</span> <span class=nb>int64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>numEntries</span> <span class=o>:=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>podName</span><span class=p>,</span> <span class=nx>metric</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>metrics</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>request</span><span class=p>,</span> <span class=nx>hasRequest</span> <span class=o>:=</span> <span class=nx>requests</span><span class=p>[</span><span class=nx>podName</span><span class=p>]</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>!</span><span class=nx>hasRequest</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>continue</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>metricsTotal</span> <span class=o>+=</span> <span class=nx>metric</span><span class=p>.</span><span class=nx>Value</span>
</span></span><span class=line><span class=cl>		<span class=nx>requestsTotal</span> <span class=o>+=</span> <span class=nx>request</span>
</span></span><span class=line><span class=cl>		<span class=nx>numEntries</span><span class=o>++</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>currentUtilization</span> <span class=p>=</span> <span class=nb>int32</span><span class=p>((</span><span class=nx>metricsTotal</span> <span class=o>*</span> <span class=mi>100</span><span class=p>)</span> <span class=o>/</span> <span class=nx>requestsTotal</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nb>float64</span><span class=p>(</span><span class=nx>currentUtilization</span><span class=p>)</span> <span class=o>/</span> <span class=nb>float64</span><span class=p>(</span><span class=nx>targetUtilization</span><span class=p>),</span> <span class=nx>currentUtilization</span><span class=p>,</span> <span class=nx>metricsTotal</span> <span class=o>/</span> <span class=nb>int64</span><span class=p>(</span><span class=nx>numEntries</span><span class=p>),</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=副本数的计算>副本数的计算</h4><p>最后如何根据计算出副本数, 其公式为 <code>使用率</code> 乘以 <code>metrics 的个数</code>. 由于使用率存在小数, 则使用 <code>match.Ceil</code> 向上取整数, 毕竟最后得出的副本数不能有小数点.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>newReplicas</span> <span class=o>:=</span> <span class=nb>int32</span><span class=p>(</span><span class=nx>math</span><span class=p>.</span><span class=nf>Ceil</span><span class=p>(</span><span class=nx>newUsageRatio</span> <span class=o>*</span> <span class=nb>float64</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>metrics</span><span class=p>))))</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=向-apiserver-请求-scales-操作>向 apiserver 请求 Scales 操作</h3><p><code>client-go</code> 里的 <code>Scales()</code> 实现了对 apiserver 的请求方法. 其本质上是对 deployment/replicaset/&mldr; 的资源配置进行更新, 后面依赖各资源的 controller 控制器来实现具体的 scale 操作.</p><p>比如 hpa 控制器向 apiserver 发起 deployment 对象的 scale 操作, 最后由 deployment controller 通过 informer 感知 scale 变更, 而后触发 对 replicaset 操作, 后面再由 replicaset controller 完成最后的 scale 操作.</p><p>代码位置: <code>vendor/k8s.io/client-go/scale/client.go</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>scaleClient</span><span class=p>)</span> <span class=nf>Scales</span><span class=p>(</span><span class=nx>namespace</span> <span class=kt>string</span><span class=p>)</span> <span class=nx>ScaleInterface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>namespacedScaleClient</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>client</span><span class=p>:</span>    <span class=nx>c</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>namespace</span><span class=p>:</span> <span class=nx>namespace</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>namespacedScaleClient</span><span class=p>)</span> <span class=nf>Update</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>resource</span> <span class=nx>schema</span><span class=p>.</span><span class=nx>GroupResource</span><span class=p>,</span> <span class=nx>scale</span> <span class=o>*</span><span class=nx>autoscaling</span><span class=p>.</span><span class=nx>Scale</span><span class=p>,</span> <span class=nx>opts</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>UpdateOptions</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>autoscaling</span><span class=p>.</span><span class=nx>Scale</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 获取 path 和 gvr
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>path</span><span class=p>,</span> <span class=nx>gvr</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>client</span><span class=p>.</span><span class=nf>pathAndVersionFor</span><span class=p>(</span><span class=nx>resource</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 获取 gvk
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>desiredGVK</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>client</span><span class=p>.</span><span class=nx>scaleKindResolver</span><span class=p>.</span><span class=nf>ScaleForResource</span><span class=p>(</span><span class=nx>gvr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;could not find proper group-version for scale subresource of %s: %v&#34;</span><span class=p>,</span> <span class=nx>gvr</span><span class=p>.</span><span class=nf>String</span><span class=p>(),</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 更换版本
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>scaleUpdate</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>scaleConverter</span><span class=p>.</span><span class=nf>ConvertToVersion</span><span class=p>(</span><span class=nx>scale</span><span class=p>,</span> <span class=nx>desiredGVK</span><span class=p>.</span><span class=nf>GroupVersion</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;could not convert scale update to external Scale: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 向 apiserver 发起请求.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// resource 可以是 deployments 等资源类型
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// name 为 hpa.Spec.ScaleTargetRef.Name, 通常为 hpa 关联对象的 name
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// subresource 子路径为 scale
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>result</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>client</span><span class=p>.</span><span class=nx>clientBase</span><span class=p>.</span><span class=nf>Put</span><span class=p>().</span>
</span></span><span class=line><span class=cl>		<span class=nf>AbsPath</span><span class=p>(</span><span class=nx>path</span><span class=p>).</span>
</span></span><span class=line><span class=cl>		<span class=nf>NamespaceIfScoped</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>namespace</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>namespace</span> <span class=o>!=</span> <span class=s>&#34;&#34;</span><span class=p>).</span>
</span></span><span class=line><span class=cl>		<span class=nf>Resource</span><span class=p>(</span><span class=nx>gvr</span><span class=p>.</span><span class=nx>Resource</span><span class=p>).</span>
</span></span><span class=line><span class=cl>		<span class=nf>Name</span><span class=p>(</span><span class=nx>scale</span><span class=p>.</span><span class=nx>Name</span><span class=p>).</span>
</span></span><span class=line><span class=cl>		<span class=nf>SubResource</span><span class=p>(</span><span class=s>&#34;scale&#34;</span><span class=p>).</span>
</span></span><span class=line><span class=cl>		<span class=nf>SpecificallyVersionedParams</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>opts</span><span class=p>,</span> <span class=nx>dynamicParameterCodec</span><span class=p>,</span> <span class=nx>versionV1</span><span class=p>).</span>
</span></span><span class=line><span class=cl>		<span class=nf>Body</span><span class=p>(</span><span class=nx>scaleUpdateBytes</span><span class=p>).</span>
</span></span><span class=line><span class=cl>		<span class=nf>Do</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>result</span><span class=p>.</span><span class=nf>Error</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nf>convertToScale</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=apiserver-对-scale-请求的处理>apiserver 对 scale 请求的处理</h3><p>apiserver 启动时对 deployment, replicaset 和 statefulsets 资源进行 <code>resource/scale</code> 路由和 rest 方法注册. 另外, 看代码的意思 k8s 应该只实现了这三个资源类型的 scale 接口.</p><p>代码位置: <code>pkg/registry/apps/rest/storage_apps.go</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=nx>StorageProvider</span><span class=p>)</span> <span class=nf>v1Storage</span><span class=p>(</span><span class=nx>apiResourceConfigSource</span> <span class=nx>serverstorage</span><span class=p>.</span><span class=nx>APIResourceConfigSource</span><span class=p>,</span> <span class=nx>restOptionsGetter</span> <span class=nx>generic</span><span class=p>.</span><span class=nx>RESTOptionsGetter</span><span class=p>)</span> <span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>rest</span><span class=p>.</span><span class=nx>Storage</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>storage</span> <span class=o>:=</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>rest</span><span class=p>.</span><span class=nx>Storage</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// deployments
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>resource</span> <span class=o>:=</span> <span class=s>&#34;deployments&#34;</span><span class=p>;</span> <span class=nx>apiResourceConfigSource</span><span class=p>.</span><span class=nf>ResourceEnabled</span><span class=p>(</span><span class=nx>appsapiv1</span><span class=p>.</span><span class=nx>SchemeGroupVersion</span><span class=p>.</span><span class=nf>WithResource</span><span class=p>(</span><span class=nx>resource</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>deploymentStorage</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>deploymentstore</span><span class=p>.</span><span class=nf>NewStorage</span><span class=p>(</span><span class=nx>restOptionsGetter</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>storage</span><span class=p>[</span><span class=nx>resource</span><span class=p>]</span> <span class=p>=</span> <span class=nx>deploymentStorage</span><span class=p>.</span><span class=nx>Deployment</span>
</span></span><span class=line><span class=cl>		<span class=nx>storage</span><span class=p>[</span><span class=nx>resource</span><span class=o>+</span><span class=s>&#34;/scale&#34;</span><span class=p>]</span> <span class=p>=</span> <span class=nx>deploymentStorage</span><span class=p>.</span><span class=nx>Scale</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// statefulsets
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>resource</span> <span class=o>:=</span> <span class=s>&#34;statefulsets&#34;</span><span class=p>;</span> <span class=nx>apiResourceConfigSource</span><span class=p>.</span><span class=nf>ResourceEnabled</span><span class=p>(</span><span class=nx>appsapiv1</span><span class=p>.</span><span class=nx>SchemeGroupVersion</span><span class=p>.</span><span class=nf>WithResource</span><span class=p>(</span><span class=nx>resource</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>statefulSetStorage</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>statefulsetstore</span><span class=p>.</span><span class=nf>NewStorage</span><span class=p>(</span><span class=nx>restOptionsGetter</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>storage</span><span class=p>[</span><span class=nx>resource</span><span class=p>]</span> <span class=p>=</span> <span class=nx>statefulSetStorage</span><span class=p>.</span><span class=nx>StatefulSet</span>
</span></span><span class=line><span class=cl>		<span class=nx>storage</span><span class=p>[</span><span class=nx>resource</span><span class=o>+</span><span class=s>&#34;/scale&#34;</span><span class=p>]</span> <span class=p>=</span> <span class=nx>statefulSetStorage</span><span class=p>.</span><span class=nx>Scale</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// replicasets
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>resource</span> <span class=o>:=</span> <span class=s>&#34;replicasets&#34;</span><span class=p>;</span> <span class=nx>apiResourceConfigSource</span><span class=p>.</span><span class=nf>ResourceEnabled</span><span class=p>(</span><span class=nx>appsapiv1</span><span class=p>.</span><span class=nx>SchemeGroupVersion</span><span class=p>.</span><span class=nf>WithResource</span><span class=p>(</span><span class=nx>resource</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>replicaSetStorage</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>replicasetstore</span><span class=p>.</span><span class=nf>NewStorage</span><span class=p>(</span><span class=nx>restOptionsGetter</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>storage</span><span class=p>[</span><span class=nx>resource</span><span class=p>]</span> <span class=p>=</span> <span class=nx>replicaSetStorage</span><span class=p>.</span><span class=nx>ReplicaSet</span>
</span></span><span class=line><span class=cl>		<span class=nx>storage</span><span class=p>[</span><span class=nx>resource</span><span class=o>+</span><span class=s>&#34;/status&#34;</span><span class=p>]</span> <span class=p>=</span> <span class=nx>replicaSetStorage</span><span class=p>.</span><span class=nx>Status</span>
</span></span><span class=line><span class=cl>		<span class=nx>storage</span><span class=p>[</span><span class=nx>resource</span><span class=o>+</span><span class=s>&#34;/scale&#34;</span><span class=p>]</span> <span class=p>=</span> <span class=nx>replicaSetStorage</span><span class=p>.</span><span class=nx>Scale</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>...</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>storage</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>下面是 apiserver 里 deployment scale 的具体实现. 简单说就是对 deployments 对象调整副本数, 让其配套的控制器去做具体 scale 落地操作.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// ScaleREST implements a Scale for Deployment.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>ScaleREST</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>store</span> <span class=o>*</span><span class=nx>genericregistry</span><span class=p>.</span><span class=nx>Store</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Update alters scale subset of Deployment object.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>ScaleREST</span><span class=p>)</span> <span class=nf>Update</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>name</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>objInfo</span> <span class=nx>rest</span><span class=p>.</span><span class=nx>UpdatedObjectInfo</span><span class=p>,</span> <span class=nx>createValidation</span> <span class=nx>rest</span><span class=p>.</span><span class=nx>ValidateObjectFunc</span><span class=p>,</span> <span class=nx>updateValidation</span> <span class=nx>rest</span><span class=p>.</span><span class=nx>ValidateObjectUpdateFunc</span><span class=p>,</span> <span class=nx>forceAllowCreate</span> <span class=kt>bool</span><span class=p>,</span> <span class=nx>options</span> <span class=o>*</span><span class=nx>metav1</span><span class=p>.</span><span class=nx>UpdateOptions</span><span class=p>)</span> <span class=p>(</span><span class=nx>runtime</span><span class=p>.</span><span class=nx>Object</span><span class=p>,</span> <span class=kt>bool</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>obj</span><span class=p>,</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nx>store</span><span class=p>.</span><span class=nf>Update</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=nx>ctx</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=o>&amp;</span><span class=nx>scaleUpdatedObjectInfo</span><span class=p>{</span><span class=nx>name</span><span class=p>,</span> <span class=nx>objInfo</span><span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=nf>toScaleCreateValidation</span><span class=p>(</span><span class=nx>createValidation</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nf>toScaleUpdateValidation</span><span class=p>(</span><span class=nx>updateValidation</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>options</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>deployment</span> <span class=o>:=</span> <span class=nx>obj</span><span class=p>.(</span><span class=o>*</span><span class=nx>apps</span><span class=p>.</span><span class=nx>Deployment</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>newScale</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>scaleFromDeployment</span><span class=p>(</span><span class=nx>deployment</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>false</span><span class=p>,</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>NewBadRequest</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>newScale</span><span class=p>,</span> <span class=kc>false</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>关于 apiserver 就点到为止, 它的实现原理在其他章节有分析, 这里就不再复述了.</p><h3 id=总结>总结</h3><p>hpa 控制器相比其他控制器来说, 其实现原理还是相对好理解的.</p><p>hpa 控制器启动时监听 hpaInformer, 当有 hpa 资源对象发生变更时, 通过 hpa 控制器注册的 eventHandler 把 hpa 的变动推到 workqueue 里. 而后就是计算该 hpa 的副本预期值, 需要通过设定的 metrics 阈值进行一系列的计算. 每个 metrics 都对应一套计算方法, 最后的预期副本数往往是经过计算后累加的. 最后通过调用 client-go 的 scales 接口, 向 apiserver 请求以实现对 deployment/replicase 的副本数调整.</p><p>hpa 肯定不是检测一次就完事了, 往往需要不断周期性去检测 hpa 是否满足 scale 条件. 这个周期性的轮询操作是通过 workqueue delayInteface 实现的.</p><p>hpa 难点在于如何根据 metrics 指标和目标阈值, 计算出合理的预期副本数.</p><p>下面是计算副本数的调用关系图.</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301081456043.png data-srcset="https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301081456043.png, https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301081456043.png 1.5x, https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301081456043.png 2x" data-sizes=auto alt=https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301081456043.png title=https://xiaorui-cc.oss-cn-hangzhou.aliyuncs.com/images/202301/202301081456043.png></p><p>出处: <a href=https://github.com/rfyiamcool/notes#kubernetes target=_blank rel="external nofollow noopener noreferrer">https://github.com/rfyiamcool/notes#kubernetes</a></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="2023-04-18 23:05:14">更新于 2023-04-18</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a href=/posts/32dd44/index.md title=阅读原始文档 class=link-to-markdown>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://www.alongparty.cn/posts/32dd44/ data-title="源码分析 kubernetes hpa controller 水平自动扩缩容的实现原理" data-hashtags=源码,hpa,转载><i class="fa-brands fa-twitter fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://www.alongparty.cn/posts/32dd44/ data-hashtag=源码><i class="fa-brands fa-facebook-square fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 WhatsApp" data-sharer=whatsapp data-url=https://www.alongparty.cn/posts/32dd44/ data-title="源码分析 kubernetes hpa controller 水平自动扩缩容的实现原理" data-web><i class="fa-brands fa-whatsapp fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=https://www.alongparty.cn/posts/32dd44/ data-title="源码分析 kubernetes hpa controller 水平自动扩缩容的实现原理"><i data-svg-src=/lib/simple-icons/icons/line.min.svg></i></a>
<a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://www.alongparty.cn/posts/32dd44/ data-title="源码分析 kubernetes hpa controller 水平自动扩缩容的实现原理"><i class="fa-brands fa-weibo fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 Myspace" data-sharer=myspace data-url=https://www.alongparty.cn/posts/32dd44/ data-title="源码分析 kubernetes hpa controller 水平自动扩缩容的实现原理" data-description><i data-svg-src=/lib/simple-icons/icons/myspace.min.svg></i></a>
<a href=javascript:void(0); title="分享到 Blogger" data-sharer=blogger data-url=https://www.alongparty.cn/posts/32dd44/ data-title="源码分析 kubernetes hpa controller 水平自动扩缩容的实现原理" data-description><i class="fa-brands fa-blogger fa-fw"></i></a>
<a href=javascript:void(0); title="分享到 Evernote" data-sharer=evernote data-url=https://www.alongparty.cn/posts/32dd44/ data-title="源码分析 kubernetes hpa controller 水平自动扩缩容的实现原理"><i class="fa-brands fa-evernote fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw"></i>&nbsp;<a href=/tags/%E6%BA%90%E7%A0%81/>源码</a>,&nbsp;<a href=/tags/hpa/>hpa</a>,&nbsp;<a href=/tags/%E8%BD%AC%E8%BD%BD/>转载</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/a3f5fa/ class=prev rel=prev title="源码分析 kubernetes scheduler 核心调度器的实现原理"><i class="fa-solid fa-angle-left fa-fw"></i>源码分析 kubernetes scheduler 核心调度器的实现原理</a>
<a href=/posts/c7c7b8/ class=next rel=next title=Loki系统架构>Loki系统架构<i class="fa-solid fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=giscus><script src=https://giscus.app/client.js data-repo=kbsonlong/devops.alongparty.cn data-repo-id=R_kgDOHE7F-Q data-category=Announcements data-category-id=DIC_kwDOHE7F-c4CPP5J data-mapping=title data-theme=preferred_color_scheme data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-lang=zh-CN data-loading=lazy crossorigin=anonymous async defer></script><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app/ rel="external nofollow noopener noreferrer">giscus</a>.</noscript></div></div></article></main><footer class=footer><div class=footer-container><div class="footer-line copyright"><i class="fa-regular fa-copyright fa-fw"></i>
<span itemprop=copyrightYear>2018 - 2023</span><span class=author itemprop=copyrightHolder>
<a href=/>kbsonlong</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class="footer-line statistics"></div><div class="footer-line ibruce"><span id=busuanzi_container_site_uv title=总访客数><i class="fa-regular fa-user fa-fw"></i>&nbsp;<span id=busuanzi_value_site_uv><i class="fa fa-spinner fa-spin fa-fw"></i></span></span><span id=busuanzi_container_site_pv class=footer-divider title=总访问量><i class="fa-regular fa-eye fa-fw"></i>&nbsp;<span id=busuanzi_value_site_pv><i class="fa fa-spinner fa-spin fa-fw"></i></span></span></div><div class="footer-line beian"><span class="icp footer-divider"><a target=_blank href=https://beian.miit.gov.cn/>粤ICP备18122209号</a></span></div></div></footer></div><div class=widgets><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fa-solid fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fa-solid fa-comment fa-fw"></i></a></div><a href=https://github.com/kbsonlong title="在 GitHub 上查看源代码" target=_blank rel="external nofollow noopener noreferrer" class="github-corner right d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div id=mask></div></div><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/katex/copy-tex.min.css><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js defer></script><script type=text/javascript src=/lib/algoliasearch/algoliasearch-lite.umd.min.js defer></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js async defer></script><script type=text/javascript src=/lib/sharer/sharer.min.js async defer></script><script type=text/javascript src=/lib/katex/katex.min.js defer></script><script type=text/javascript src=/lib/katex/auto-render.min.js defer></script><script type=text/javascript src=/lib/katex/copy-tex.min.js defer></script><script type=text/javascript src=/lib/katex/mhchem.min.js defer></script><script type=text/javascript src=/lib/cookieconsent/cookieconsent.min.js defer></script><script type=text/javascript src=/lib/pangu/pangu.min.js defer></script><script type=text/javascript src=/lib/cell-watermark/watermark.min.js defer></script><script type=text/javascript src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async defer></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:10},comment:{giscus:{darkTheme:"dark",lightTheme:"light"}},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},enablePWA:!0,enablePangu:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"WFOR67TML1",algoliaIndex:"along",algoliaSearchKey:"ea1fe535f9a7ae353f3922489c829cc1",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"},watermark:{appendto:".wrapper>main",colspacing:30,content:'<img class="fixit-icon" src="/favicon-16x16.png" alt="FixIt logo" /> FixIt 主题',enable:!0,fontfamily:"inherit",fontsize:.85,height:21,opacity:.0125,rotate:15,rowspacing:60,width:150}}</script><script type=text/javascript src=/js/theme.min.js defer></script><script type=text/javascript src=/js/_custom.min.js defer></script></body></html>